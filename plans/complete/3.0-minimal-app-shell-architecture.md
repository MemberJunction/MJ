# MemberJunction 3.0 Phase 1: Minimal App Shell Architecture - Package Development & CLI

## Executive Summary

This document defines **Phase 1** of MemberJunction 3.0's **Minimal App Shell Pattern** implementation - a fundamental restructuring that makes MJAPI and MJExplorer nearly empty bootstrapping applications that import all functionality from NPM packages.

**Phase 1 Scope**: Package development and CLI tooling for project scaffolding.

**Phase 2**: See [3.0-phase-2-codegen-migration.md](3.0-phase-2-codegen-migration.md) for CodeGen updates, migration tooling, and documentation.

**Key Decision**: Generated code (entities, actions, forms, resolvers) will be output as **separate publishable packages** rather than files inside the app folders. Apps become pure configuration with ~10-25 lines of code.

**Breaking Change**: This is a 3.0 breaking change. Existing 2.x projects will need migration (Phase 2).

**Customer Environment**: All customer installations will be **monorepo setups by default**.

---

## Problem Statement

### Current State (2.x)

```
customer-project/
├── MJAPI/
│   ├── src/
│   │   ├── index.ts              # ~34 lines of bootstrap code
│   │   └── generated/
│   │       └── generated.ts      # CodeGen writes here
│   └── package.json
├── MJExplorer/
│   ├── src/
│   │   ├── app/
│   │   │   ├── app.component.ts  # ~245 lines of auth/bootstrap
│   │   │   ├── app.module.ts     # ~107 lines of imports
│   │   │   └── generated/
│   │   │       └── generated-forms.module.ts  # CodeGen writes here
│   └── package.json
├── GeneratedEntities/            # Local package, not published
└── GeneratedActions/             # Local package, not published
```

**Problems:**
1. **Code inside apps gets stale** - When MJ updates, bootstrap logic in apps doesn't update
2. **Generated code is trapped** - Can't be versioned/published independently
3. **Duplicate bootstrap logic** - Every customer has same auth setup copied
4. **Mixed concerns** - Demo components, styling, config all in app folders
5. **Manual updates required** - Changes to bootstrap patterns require manual intervention

### Desired State (3.0)

```
customer-project/
├── packages/
│   ├── api/                      # ~6 lines
│   ├── explorer/                 # ~20 lines
│   ├── generated-entities/       # Publishable package
│   ├── generated-actions/        # Publishable package
│   ├── generated-forms/          # Publishable package
│   └── generated-resolvers/      # Publishable package
├── mj.config.cjs
├── package.json                  # Workspace root
└── turbo.json
```

**Benefits:**
- Zero-copy NPM updates for all MJ functionality
- Generated code as proper packages (versionable, publishable)
- Apps are pure configuration - nothing to get stale
- Standard monorepo tooling (Turbo, npm workspaces)
- CI/CD friendly with standard npm workflows

---

## Architecture Overview

### Core Principle

**Apps import everything, contain nothing.**

```
┌─────────────────────────────────────────────────────────────────┐
│                        Customer Monorepo                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐    │
│  │  packages/   │     │  packages/   │     │  packages/   │    │
│  │    api/      │     │  explorer/   │     │  generated-  │    │
│  │  (~6 lines)  │     │  (~20 lines) │     │   entities/  │    │
│  └──────┬───────┘     └──────┬───────┘     └──────────────┘    │
│         │                    │                                   │
│         │ imports            │ imports                           │
│         ▼                    ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   NPM Packages                           │   │
│  │  @memberjunction/server-bootstrap                        │   │
│  │  @memberjunction/ng-explorer-core                        │   │
│  │  @memberjunction/ng-bootstrap                            │   │
│  │  @memberjunction/core, etc.                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### New NPM Packages Required

| Package | Purpose | Extracted From |
|---------|---------|----------------|
| `@memberjunction/server-bootstrap` | Server initialization, config loading | MJAPI/src/index.ts |
| `@memberjunction/ng-bootstrap` | Auth flow, GraphQL setup, metadata loading | MJExplorer/src/app/app.component.ts |

---

## Detailed Design

### 1. New Package: `@memberjunction/server-bootstrap`

**Location**: `packages/ServerBootstrap/`

**Purpose**: Encapsulate all server initialization logic so MJAPI becomes a one-liner.

```typescript
// packages/ServerBootstrap/src/index.ts
import { serve } from '@memberjunction/server';
import { cosmiconfigSync } from 'cosmiconfig';

export interface MJServerConfig {
  configPath?: string;
  resolverPaths?: string[];
  beforeStart?: () => Promise<void>;
  afterStart?: () => Promise<void>;
}

export async function createMJServer(options: MJServerConfig = {}): Promise<void> {
  // Load configuration
  const explorer = cosmiconfigSync('mj');
  const config = explorer.search(process.cwd());

  // Discover and load generated packages automatically
  // Uses package.json "mj" field or mj.config.cjs settings
  await discoverAndLoadGeneratedPackages(config);

  // Build resolver paths
  const resolverPaths = options.resolverPaths || [];

  // Optional pre-start hook
  if (options.beforeStart) {
    await options.beforeStart();
  }

  // Start server
  await serve(resolverPaths);

  // Optional post-start hook
  if (options.afterStart) {
    await options.afterStart();
  }
}

async function discoverAndLoadGeneratedPackages(config: any): Promise<void> {
  // Auto-import generated packages based on config
  // This triggers their registration via side effects
}
```

**Resulting MJAPI 3.0** (`packages/api/src/index.ts`):

```typescript
import { createMJServer } from '@memberjunction/server-bootstrap';

// Import generated packages to trigger registration
import '@mycompany/generated-entities';
import '@mycompany/generated-actions';
import '@mycompany/generated-resolvers';

createMJServer().catch(console.error);
```

**That's it. 6 lines.**

---

### 2. New Package: `@memberjunction/ng-bootstrap`

**Location**: `packages/Angular/Bootstrap/`

**Purpose**: Encapsulate all Angular authentication and initialization logic.

```typescript
// packages/Angular/Bootstrap/src/lib/bootstrap.module.ts
import { NgModule, ModuleWithProviders } from '@angular/core';
import { MJBootstrapComponent } from './bootstrap.component';
import { MJBootstrapService } from './bootstrap.service';

export interface MJEnvironmentConfig {
  production: boolean;
  GRAPHQL_URI: string;
  GRAPHQL_WS_URI: string;
  AUTH_TYPE: 'msal' | 'auth0';
  MJ_CORE_SCHEMA_NAME: string;
  // Auth provider specific
  CLIENT_ID?: string;
  TENANT_ID?: string;
  AUTH0_DOMAIN?: string;
  AUTH0_CLIENTID?: string;
}

@NgModule({
  declarations: [MJBootstrapComponent],
  exports: [MJBootstrapComponent]
})
export class MJBootstrapModule {
  static forRoot(environment: MJEnvironmentConfig): ModuleWithProviders<MJBootstrapModule> {
    return {
      ngModule: MJBootstrapModule,
      providers: [
        { provide: 'MJ_ENVIRONMENT', useValue: environment },
        MJBootstrapService
      ]
    };
  }
}
```

```typescript
// packages/Angular/Bootstrap/src/lib/bootstrap.component.ts
@Component({
  selector: 'mj-bootstrap',
  template: `
    <ng-container *ngIf="!hasError && isAuthenticated">
      <mj-shell></mj-shell>
    </ng-container>
    <mj-login *ngIf="!isAuthenticated" (onLogin)="handleLogin($event)"></mj-login>
    <mj-error *ngIf="hasError" [message]="errorMessage"></mj-error>
    <mj-validation-banner *ngIf="showValidation"></mj-validation-banner>
  `
})
export class MJBootstrapComponent implements OnInit {
  // All the auth logic currently in app.component.ts moves here
}
```

**Resulting MJExplorer 3.0** (`packages/explorer/src/app/app.module.ts`):

```typescript
import { NgModule } from '@angular/core';
import { MJBootstrapModule, MJBootstrapComponent } from '@memberjunction/ng-bootstrap';
import { MJExplorerModule } from '@memberjunction/ng-explorer-core';
import { GeneratedFormsModule } from '@mycompany/generated-forms';
import { environment } from '../environments/environment';

@NgModule({
  imports: [
    MJBootstrapModule.forRoot(environment),
    MJExplorerModule,
    GeneratedFormsModule
  ],
  bootstrap: [MJBootstrapComponent]
})
export class AppModule {}
```

**That's it. ~15 lines.**

---

## Phase 1 Implementation Tasks

### 1. Bootstrap Package Development

| Task | Package | Description |
|------|---------|-------------|
| 1.1 | `@memberjunction/server-bootstrap` | Extract server init from MJAPI |
| 1.2 | `@memberjunction/ng-bootstrap` | Extract auth/init from MJExplorer |
| 1.3 | Unit tests | Tests for both bootstrap packages |
| 1.4 | Documentation | API docs and usage examples |

**Note**: Scaffold-lib and MJCLI commands moved to Phase 2 (see [3.0-phase-2-codegen-migration.md](3.0-phase-2-codegen-migration.md))

---

## Template Examples

### API index.ts Template

```handlebars
/**
 * {{projectName}} API Server
 * Generated by MemberJunction CLI v3.0
 */
import { createMJServer } from '@memberjunction/server-bootstrap';

// Import generated packages to trigger class registration
import '{{packageScope}}/generated-entities';
import '{{packageScope}}/generated-actions';
import '{{packageScope}}/generated-resolvers';

{{#if customResolvers}}
// Import custom resolvers
import './resolvers';
{{/if}}

createMJServer({
  configPath: '../../mj.config.cjs'
}).catch((error) => {
  console.error('Failed to start server:', error);
  process.exit(1);
});
```

### Explorer app.module.ts Template

```handlebars
/**
 * {{projectName}} Explorer
 * Generated by MemberJunction CLI v3.0
 */
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { BrowserAnimationsModule } from '@angular/platform-browser/animations';

import { MJBootstrapModule, MJBootstrapComponent } from '@memberjunction/ng-bootstrap';
import { MJExplorerModule } from '@memberjunction/ng-explorer-core';
import { CoreGeneratedFormsModule } from '@memberjunction/ng-core-entity-forms';
import { GeneratedFormsModule } from '{{packageScope}}/generated-forms';

import { environment } from '../environments/environment';

@NgModule({
  imports: [
    BrowserModule,
    BrowserAnimationsModule,
    MJBootstrapModule.forRoot(environment),
    MJExplorerModule,
    CoreGeneratedFormsModule,
    GeneratedFormsModule
  ],
  bootstrap: [MJBootstrapComponent]
})
export class AppModule {}
```

### mj.config.cjs Template

```handlebars
/**
 * MemberJunction Configuration
 * Generated by MemberJunction CLI v3.0
 */
module.exports = {
  // Database Configuration
  dbHost: process.env.DB_HOST || '{{database.host}}',
  dbPort: process.env.DB_PORT || {{database.port}},
  dbDatabase: process.env.DB_DATABASE || '{{database.database}}',
  dbTrustServerCertificate: {{database.trustCert}},

  // CodeGen Credentials
  codeGenLogin: process.env.CODEGEN_DB_USERNAME,
  codeGenPassword: process.env.CODEGEN_DB_PASSWORD,

  // API Credentials
  dbUsername: process.env.DB_USERNAME,
  dbPassword: process.env.DB_PASSWORD,

  // MJ Core Schema
  coreSchema: process.env.MJ_CORE_SCHEMA || '__mj',

  // 3.0 Code Generation Configuration
  codeGeneration: {
    outputMode: 'packages',
    packageScope: '{{packageScope}}',

    packages: {
      entities: {
        path: './packages/generated-entities',
        name: '{{packageScope}}/generated-entities'
      },
      actions: {
        path: './packages/generated-actions',
        name: '{{packageScope}}/generated-actions'
      },
      angularForms: {
        path: './packages/generated-forms',
        name: '{{packageScope}}/generated-forms'
      },
      graphqlResolvers: {
        path: './packages/generated-resolvers',
        name: '{{packageScope}}/generated-resolvers'
      }
    }
  },

  // Server Configuration
  graphqlPort: process.env.PORT || 4000,

  // Authentication
  authentication: {
{{#if (eq authProvider 'msal')}}
    providers: ['msal'],
    msal: {
      clientId: process.env.WEB_CLIENT_ID,
      tenantId: process.env.TENANT_ID
    }
{{else if (eq authProvider 'auth0')}}
    providers: ['auth0'],
    auth0: {
      clientId: process.env.AUTH0_CLIENT_ID,
      clientSecret: process.env.AUTH0_CLIENT_SECRET,
      domain: process.env.AUTH0_DOMAIN
    }
{{else}}
    providers: ['msal', 'auth0'],
    msal: {
      clientId: process.env.WEB_CLIENT_ID,
      tenantId: process.env.TENANT_ID
    },
    auth0: {
      clientId: process.env.AUTH0_CLIENT_ID,
      clientSecret: process.env.AUTH0_CLIENT_SECRET,
      domain: process.env.AUTH0_DOMAIN
    }
{{/if}}
  }
};
```

---

## Phase 1 Success Criteria

### Bootstrap Package Development
- [ ] `@memberjunction/server-bootstrap` package created
  - [ ] `createMJServer()` function working
  - [ ] Configuration loading from mj.config.cjs
  - [ ] Proper error handling and validation
  - [ ] Backward compatible with existing MJAPI
- [ ] `@memberjunction/ng-bootstrap` package created
  - [ ] `MJBootstrapModule` with `.forRoot()` config
  - [ ] `MJBootstrapComponent` handling auth flows
  - [ ] MSAL and Auth0 support
  - [ ] Backward compatible with existing MJExplorer
- [ ] Unit tests for all packages
  - [ ] Server bootstrap tests (80%+ coverage)
  - [ ] Angular bootstrap tests (80%+ coverage)
- [ ] Documentation complete
  - [ ] API documentation for both packages
  - [ ] Usage examples
  - [ ] Migration guide for existing apps

### Quality Gates
- [ ] All existing MJ tests still pass
- [ ] New packages have no circular dependencies
- [ ] TypeScript compiles without errors
- [ ] Packages can be published to npm
- [ ] Example apps demonstrate usage

---

## Phase 1 Open Questions

1. **Bootstrap Package APIs**: Should `createMJServer` be synchronous or async? How do we handle configuration errors?
   - **Recommendation**: Async with proper error handling and validation. Return Promise<void>.
   - **Rationale**: Async allows for config validation, database connection testing, etc.

2. **Angular Bootstrap Component**: Should it be a standalone component or NgModule-based?
   - **Recommendation**: NgModule-based for consistency with current MJ patterns (see CLAUDE.md rule #4).
   - **Rationale**: Standalone components cause style encapsulation issues per MJ standards.

3. **Package Versioning**: How should bootstrap packages be versioned?
   - **Recommendation**: Follow MJ core package versions (e.g., 3.0.0).
   - **Rationale**: Bootstrap packages are core infrastructure, not optional add-ons.

4. **Backward Compatibility**: Can existing MJAPI/MJExplorer use these packages?
   - **Decision**: Yes, but optional. Existing apps continue to work as-is.
   - **Approach**: Provide migration guide but no forced upgrade until 4.0.

---

*Document Created: 2025-12-01*
*Last Updated: 2026-01-13*
*Status: Planning*
*Version: 3.0 Phase 1*
*Next Phase: See [3.0-phase-2-codegen-migration.md](3.0-phase-2-codegen-migration.md)*
