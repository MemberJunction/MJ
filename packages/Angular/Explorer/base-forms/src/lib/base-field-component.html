<!--
Using a blend of *ngIf and the new @switch control flow because of a bug in early Angular 17 where
the @if wrapping the @switch didn't fully remove elements when swtiching back and forth. In the future if Angular fixes the bug
we can get rid of the *ngIf outer div blocks and instead use @if and contain the @switch within the same div block.
-->
@if (record.IsSaved || !IsFieldReadOnly) {
  <!-- We only render a field if the record is either saved, or the field is editable. Meaning, for NEW records, we only show editable fields -->
  @if ((!EditMode || IsFieldReadOnly) && !shouldHideField) {
    <div class="record-form-row">
      @if (ShowLabel) {
        <label [innerHTML]="HighlightedDisplayName"></label>
      }
      @if (IsEncryptedField) {
        <!-- Encrypted field in read-only mode -->
        @if (CanRevealEncryptedValue) {
          <!-- AllowDecryptInAPI=true: Show masked by default with reveal button -->
          <span class="encrypted-value-container">
            @if (isEncryptedValueRevealed) {
              <span class="encrypted-revealed-value">{{Value}}</span>
            }
            @else {
            <span class="encrypted-value">
              <i class="fa-solid fa-lock encrypted-icon"></i>
              {{EncryptedDisplayMask}}
            </span>
          }
          <button type="button"
            class="encrypted-toggle-btn"
            (click)="toggleEncryptedValueVisibility()"
            [title]="isEncryptedValueRevealed ? 'Hide value' : 'Show value'">
            <i class="fa-solid" [class.fa-eye]="!isEncryptedValueRevealed" [class.fa-eye-slash]="isEncryptedValueRevealed"></i>
          </button>
        </span>
      }
      @else if (IsValueProtected) {
      <!-- AllowDecryptInAPI=false or sentinel: Always show masked, no reveal option -->
      <span class="encrypted-value" title="This value is encrypted and protected">
        <i class="fa-solid fa-lock encrypted-icon"></i>
        {{EncryptedDisplayMask}}
      </span>
    }
    @else {
    <!-- Encrypted field with no value -->
    <span></span>
  }
}
@else {
@switch (LinkType) {
  @case ('None') {
    @if (ExtendedType === 'Code') {
      <mj-code-editor [value]="record.Get(FieldName)" [readonly]="true" [languages]="languages" [language]="'JavaScript'"></mj-code-editor>
    }
    @else if (Type === 'checkbox') {
    <!-- Render checkboxes as disabled checkbox controls in read mode -->
    <input type="checkbox" [checked]="Value" kendoCheckBox disabled />
  }
  @else if (FieldInfo.Length === -1) {
  <!-- this is a varchar(max) type of field -->
  <mj-markdown #markdown [data]="record.Get(FieldName)"></mj-markdown>
  <!-- <span [innerHTML]="record.Get(FieldName) | formatText"></span> -->
}
@else {
<span>{{FormatValue(FieldName, 0)}}</span>
}
}
@case ('Email') {
  <span mjEmailLink [field]="record.GetFieldByName(FieldName)!" >{{FormatValue(FieldName, 0)}}</span>
}
@case ('URL') {
  <span mjWebLink [field]="record.GetFieldByName(FieldName)!" >{{FormatValue(FieldName, 0)}}</span>
}
@case ('Record') {
  <span mjFieldLink [record]="record" [fieldName]="FieldName" >{{FormatValue(FieldName, 0)}}</span>
}
}
}
</div>
}
@if (EditMode && !IsFieldReadOnly) {
  <div class="record-form-row">
    @if (ShowLabel) {
      <label [innerHTML]="HighlightedDisplayName"></label>
    }
    @if (IsBlindEncryptedEdit) {
      <!-- Encrypted field where user cannot see existing value (AllowDecryptInAPI=false) -->
      <div class="encrypted-field-edit">
        <span class="encrypted-current-value" title="Current value is encrypted and cannot be viewed">
          <i class="fa-solid fa-lock encrypted-icon"></i>
          {{EncryptedDisplayMask}}
        </span>
        <div class="encrypted-input-container">
          <kendo-textbox
            [(ngModel)]="EncryptedEditValue"
            [placeholder]="'Enter new value to replace encrypted data'"
            class="encrypted-input"
            [type]="isNewValueRevealed ? 'text' : 'password'">
          </kendo-textbox>
          <button type="button"
            class="encrypted-toggle-btn"
            (click)="toggleNewValueVisibility()"
            [title]="isNewValueRevealed ? 'Hide value' : 'Show value'">
            <i class="fa-solid" [class.fa-eye]="!isNewValueRevealed" [class.fa-eye-slash]="isNewValueRevealed"></i>
          </button>
        </div>
        <span class="encrypted-hint">Enter a new value to overwrite the existing encrypted data (current value cannot be displayed)</span>
      </div>
    }
    @else if (IsEncryptedField) {
    <!-- Encrypted field where user CAN see existing value (AllowDecryptInAPI=true) -->
    <div class="encrypted-field-edit-visible">
      <div class="encrypted-input-container">
        <kendo-textbox
          [(ngModel)]="Value"
          class="encrypted-input"
          [type]="isEncryptedValueRevealed ? 'text' : 'password'">
        </kendo-textbox>
        <button type="button"
          class="encrypted-toggle-btn"
          (click)="toggleEncryptedValueVisibility()"
          [title]="isEncryptedValueRevealed ? 'Hide value' : 'Show value'">
          <i class="fa-solid" [class.fa-eye]="!isEncryptedValueRevealed" [class.fa-eye-slash]="isEncryptedValueRevealed"></i>
        </button>
      </div>
    </div>
  }
  @else if (FieldInfo && FieldInfo.RelatedEntity && FieldInfo.RelatedEntity.length > 0) {
  <!-- Foreign Key Link here -->
  <mj-link-field [record]="record" [FieldName]="FieldName" [LinkComponentType]="LinkComponentType"></mj-link-field>
}
@else {
<!-- Not a foreign key -->
@switch (Type) {
  @case ('code') {
    <mj-code-editor [(ngModel)]="Value" [languages]="languages" [language]="'JavaScript'"></mj-code-editor>
  }
  @case ('textbox') {
    <kendo-textbox [(ngModel)]="Value" />
  }
  @case ('textarea') {
    <kendo-textarea [(ngModel)]="Value"></kendo-textarea>
  }
  @case ('numerictextbox') {
    <kendo-numerictextbox [(value)]="Value" class="narrower-component" />
  }
  @case ('datepicker') {
    <kendo-datepicker [(value)]="Value" class="narrower-component"></kendo-datepicker>
  }
  @case ('checkbox') {
    <input type="checkbox" [(ngModel)]="Value" kendoCheckBox />
  }
  @case ('dropdownlist') {
    <kendo-dropdownlist [data]="PossibleValues" [(ngModel)]="Value"></kendo-dropdownlist>
  }
  @case ('combobox') {
    <kendo-combobox [data]="PossibleValues" [allowCustom]="true" [(ngModel)]="Value"></kendo-combobox>
  }
}
}
</div>
}
}
