<kendo-dialog
    *ngIf="visible"
    [title]="DialogTitle"
    (close)="cancel()"
    [width]="600"
    [minWidth]="400">

    <form [formGroup]="connectionForm" class="connection-form">
        <!-- Error Message -->
        @if (ErrorMessage) {
            <div class="error-banner">
                <i class="fa-solid fa-exclamation-triangle"></i>
                {{ ErrorMessage }}
            </div>
        }

        <!-- Basic Info Section -->
        <div class="form-section">
            <h3><i class="fa-solid fa-info-circle"></i> Basic Information</h3>

            <div class="form-group">
                <label for="server">MCP Server <span class="required">*</span></label>
                <kendo-dropdownlist
                    id="server"
                    formControlName="MCPServerID"
                    [data]="ActiveServers"
                    textField="Name"
                    valueField="ID"
                    [valuePrimitive]="true"
                    [defaultItem]="{ Name: 'Select a server...', ID: '' }"
                    (valueChange)="onServerChange()">
                    <ng-template kendoDropDownListItemTemplate let-dataItem>
                        <div class="server-option">
                            <span class="server-name">{{ dataItem.Name }}</span>
                            @if (dataItem.TransportType) {
                                <span class="server-transport">{{ dataItem.TransportType }}</span>
                            }
                        </div>
                    </ng-template>
                </kendo-dropdownlist>
                @if (hasError('MCPServerID', 'required')) {
                    <span class="error-text">Server selection is required</span>
                }
            </div>

            <div class="form-group">
                <label for="name">Connection Name <span class="required">*</span></label>
                <input kendoTextBox
                       id="name"
                       formControlName="Name"
                       placeholder="e.g., Production GitHub Connection" />
                @if (hasError('Name', 'required')) {
                    <span class="error-text">Name is required</span>
                }
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea kendoTextArea
                          id="description"
                          formControlName="Description"
                          placeholder="Optional description of this connection"
                          [rows]="3"></textarea>
            </div>

            <div class="form-group">
                <label for="status">Status</label>
                <kendo-dropdownlist
                    id="status"
                    formControlName="Status"
                    [data]="['Active', 'Inactive']"
                    [valuePrimitive]="true">
                </kendo-dropdownlist>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="form-section">
            <h3><i class="fa-solid fa-key"></i> Authentication</h3>

            <div class="form-group">
                <label for="credential">Credential</label>
                @if (IsLoadingCredentials) {
                    <div class="loading-credentials">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        Loading credentials...
                    </div>
                } @else {
                    <kendo-dropdownlist
                        id="credential"
                        formControlName="CredentialID"
                        [data]="credentials"
                        textField="Name"
                        valueField="ID"
                        [valuePrimitive]="true"
                        [defaultItem]="{ Name: 'No credential (anonymous)', ID: '' }">
                    </kendo-dropdownlist>
                    <span class="hint">Select a stored credential for authentication</span>
                }
            </div>

            <div class="form-group">
                <label for="customHeader">Custom Header Name</label>
                <input kendoTextBox
                       id="customHeader"
                       formControlName="CustomHeaderName"
                       placeholder="e.g., X-Custom-API-Key" />
                <span class="hint">Override the default header name for API key authentication</span>
            </div>
        </div>

        <!-- Behavior Section -->
        <div class="form-section">
            <h3><i class="fa-solid fa-sliders"></i> Behavior</h3>

            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" kendoCheckBox formControlName="AutoSyncTools" />
                    <span>Auto-sync tools on connect</span>
                </label>
                <span class="hint">Automatically discover and sync available tools when connecting</span>
            </div>
        </div>

        <!-- Logging Section -->
        <div class="form-section">
            <h3><i class="fa-solid fa-file-lines"></i> Logging</h3>

            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" kendoCheckBox formControlName="LogToolCalls" />
                    <span>Enable tool call logging</span>
                </label>
                <span class="hint">Log all tool executions to the database</span>
            </div>

            <div class="logging-options" [class.disabled]="!connectionForm.get('LogToolCalls')?.value">
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" kendoCheckBox formControlName="LogInputParameters" />
                        <span>Log input parameters</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" kendoCheckBox formControlName="LogOutputContent" />
                        <span>Log output content</span>
                    </label>
                </div>

                <div class="form-group">
                    <label for="maxOutputSize">Max Output Log Size (bytes)</label>
                    <kendo-numerictextbox
                        id="maxOutputSize"
                        formControlName="MaxOutputLogSize"
                        [min]="0"
                        [max]="10485760"
                        [step]="10240"
                        [format]="'n0'">
                    </kendo-numerictextbox>
                    <span class="hint">Maximum size of output content to log (0 = unlimited, max 10MB)</span>
                </div>
            </div>
        </div>

        <!-- Advanced Section -->
        <div class="form-section">
            <h3><i class="fa-solid fa-gear"></i> Advanced</h3>

            <div class="form-group">
                <label for="envVars">Environment Variables (JSON)</label>
                <textarea kendoTextArea
                          id="envVars"
                          formControlName="EnvironmentVars"
                          placeholder='{"VAR_NAME": "value"}'
                          [rows]="3"></textarea>
                <span class="hint">Additional environment variables for Stdio transport (JSON object)</span>
            </div>
        </div>
    </form>

    <kendo-dialog-actions>
        <button kendoButton (click)="save()" themeColor="primary" [disabled]="IsSaving">
            @if (IsSaving) {
                <i class="fa-solid fa-spinner fa-spin"></i>
            }
            {{ IsEditMode ? 'Update' : 'Create' }}
        </button>
        <button kendoButton (click)="cancel()">Cancel</button>
    </kendo-dialog-actions>
</kendo-dialog>
