<div class="categories-container">
    <mj-loading *ngIf="isLoading" text="Loading categories..."></mj-loading>

    <ng-container *ngIf="!isLoading">
        <!-- Header -->
        <div class="categories-header">
            <div class="header-info">
                <h2 class="categories-title">Categories</h2>
                <div class="header-stats">
                    <span class="stat-item">
                        <i class="fa-solid fa-folder-tree"></i>
                        {{categories.length}} categories
                    </span>
                    <span class="stat-item">
                        <i class="fa-solid fa-shapes"></i>
                        {{getTotalTypeCount()}} types
                    </span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-primary" *ngIf="UserCanCreate" (click)="createNewCategory()">
                    <i class="fa-solid fa-plus"></i>
                    <span>New Category</span>
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-container">
                    <i class="fa-solid fa-search"></i>
                    <input
                        type="text"
                        placeholder="Search categories..."
                        [value]="searchText"
                        (input)="onSearchChange($any($event.target).value)"
                    />
                    <button class="search-clear" *ngIf="searchText" (click)="clearSearch()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="toolbar-right">
                <button class="btn-text" (click)="expandAll()" title="Expand All">
                    <i class="fa-solid fa-expand"></i>
                </button>
                <button class="btn-text" (click)="collapseAll()" title="Collapse All">
                    <i class="fa-solid fa-compress"></i>
                </button>
                <button class="btn-icon" (click)="refresh()" title="Refresh">
                    <i class="fa-solid fa-refresh"></i>
                </button>
            </div>
        </div>

        <div class="categories-layout">
            <!-- Tree Container -->
            <div class="tree-panel">
                <div class="tree-container" *ngIf="categoryTree.length > 0">
                    <div
                        class="tree-node"
                        *ngFor="let node of getFlattenedNodes(); let i = index"
                        [class.selected]="selectedNode?.category?.ID === node.category.ID"
                        [style.padding-left.px]="12 + (node.level * 20)"
                        (click)="selectNode(node)"
                    >
                        <div class="node-content">
                            <button
                                class="expand-btn"
                                *ngIf="node.children.length > 0"
                                (click)="toggleExpand(node, $event)"
                            >
                                <i [class]="node.expanded ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right'"></i>
                            </button>
                            <span class="expand-placeholder" *ngIf="node.children.length === 0"></span>

                            <div class="node-icon" [style.backgroundColor]="getCategoryColor(i) + '15'" [style.color]="getCategoryColor(i)">
                                <i [class]="node.category.IconClass || 'fa-solid fa-folder'"></i>
                            </div>

                            <div class="node-info">
                                <div class="node-name">{{node.category.Name}}</div>
                                <div class="node-description" *ngIf="node.category.Description">
                                    {{node.category.Description | slice:0:50}}{{node.category.Description.length > 50 ? '...' : ''}}
                                </div>
                            </div>

                            <div class="node-badges">
                                <span class="badge types" *ngIf="node.typeCount > 0">
                                    <i class="fa-solid fa-shapes"></i>
                                    {{node.typeCount}}
                                </span>
                                <span class="badge children" *ngIf="node.children.length > 0">
                                    <i class="fa-solid fa-folder"></i>
                                    {{node.children.length}}
                                </span>
                            </div>

                            <div class="node-actions">
                                <button
                                    class="action-btn"
                                    *ngIf="UserCanUpdate"
                                    (click)="editCategory(node, $event)"
                                    title="Edit"
                                >
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button
                                    class="action-btn danger"
                                    *ngIf="UserCanDelete && node.children.length === 0 && node.typeCount === 0"
                                    (click)="deleteCategory(node, $event)"
                                    title="Delete"
                                >
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="empty-state" *ngIf="categoryTree.length === 0">
                    <div class="empty-icon">
                        <i class="fa-solid fa-folder-open"></i>
                    </div>
                    <h3>No Categories</h3>
                    <p *ngIf="searchText">
                        No categories match your search.
                        <button class="btn-link" (click)="clearSearch()">Clear search</button>
                    </p>
                    <p *ngIf="!searchText">
                        Get started by creating your first category.
                    </p>
                    <button class="btn-primary" *ngIf="UserCanCreate && !searchText" (click)="createNewCategory()">
                        <i class="fa-solid fa-plus"></i>
                        Create Category
                    </button>
                </div>
            </div>

            <!-- Detail Panel -->
            <div class="detail-panel" *ngIf="selectedNode">
                <div class="detail-header">
                    <div class="detail-icon" [style.backgroundColor]="getCategoryColor(0) + '15'" [style.color]="getCategoryColor(0)">
                        <i [class]="selectedNode.category.IconClass || 'fa-solid fa-folder'"></i>
                    </div>
                    <div class="detail-title">
                        <h2>{{selectedNode.category.Name}}</h2>
                        <span class="level-badge" *ngIf="selectedNode.level > 0">
                            Level {{selectedNode.level + 1}}
                        </span>
                    </div>
                    <div class="detail-actions">
                        <button class="action-btn" *ngIf="UserCanUpdate" (click)="editCategory(selectedNode)" title="Edit">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="close-btn" (click)="selectedNode = null">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>

                <div class="detail-body">
                    <!-- Stats -->
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <div class="stat-value">{{selectedNode.typeCount}}</div>
                            <div class="stat-label">Credential Types</div>
                        </div>
                        <div class="detail-stat">
                            <div class="stat-value">{{selectedNode.children.length}}</div>
                            <div class="stat-label">Subcategories</div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="description-section" *ngIf="selectedNode.category.Description">
                        <h3>
                            <i class="fa-solid fa-align-left"></i>
                            Description
                        </h3>
                        <p class="description">{{selectedNode.category.Description}}</p>
                    </div>

                    <!-- Types in Category -->
                    <div class="types-section" *ngIf="selectedNode.typeCount > 0">
                        <h3>
                            <i class="fa-solid fa-shapes"></i>
                            Credential Types
                        </h3>
                        <div class="type-list">
                            <div class="type-item" *ngFor="let type of getTypesForCategory(selectedNode.category.Name)">
                                <div class="type-icon">
                                    <i [class]="type.IconClass || 'fa-solid fa-key'"></i>
                                </div>
                                <div class="type-info">
                                    <div class="type-name">{{type.Name}}</div>
                                    <div class="type-desc" *ngIf="type.Description">{{type.Description | slice:0:60}}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subcategories -->
                    <div class="subcategories-section" *ngIf="selectedNode.children.length > 0">
                        <h3>
                            <i class="fa-solid fa-folder-tree"></i>
                            Subcategories
                        </h3>
                        <div class="subcategory-list">
                            <div class="subcategory-item" *ngFor="let child of selectedNode.children" (click)="selectNode(child)">
                                <i [class]="child.category.IconClass || 'fa-solid fa-folder'"></i>
                                <span>{{child.category.Name}}</span>
                                <span class="sub-type-count" *ngIf="child.typeCount > 0">{{child.typeCount}} types</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="detail-quick-actions">
                        <button
                            class="btn-secondary"
                            *ngIf="selectedNode.typeCount > 0"
                            (click)="viewTypesForCategory(selectedNode.category.Name)"
                        >
                            <i class="fa-solid fa-shapes"></i>
                            View Types
                        </button>
                        <button
                            class="btn-primary"
                            (click)="createCredentialWithCategory(selectedNode.category.ID)"
                        >
                            <i class="fa-solid fa-plus"></i>
                            Create Credential
                        </button>
                    </div>

                </div>
            </div>

            <!-- No Selection -->
            <div class="no-selection" *ngIf="!selectedNode && categoryTree.length > 0">
                <div class="no-selection-icon">
                    <i class="fa-solid fa-hand-pointer"></i>
                </div>
                <h3>Select a Category</h3>
                <p>Click on a category to view its details and credential types</p>
            </div>
        </div>
    </ng-container>
</div>

<!-- Category Edit Panel -->
<mj-credential-category-edit-panel
    #categoryEditPanel
    (saved)="onCategorySaved($any($event))"
    (deleted)="onCategoryDeleted($any($event))"
></mj-credential-category-edit-panel>
