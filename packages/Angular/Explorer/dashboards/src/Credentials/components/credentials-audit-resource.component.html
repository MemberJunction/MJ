<div class="audit-container">
  @if (isLoading) {
    <mj-loading text="Loading audit logs..."></mj-loading>
  }

  @if (!isLoading) {
    <!-- Header -->
    <div class="audit-header">
      <div class="header-info">
        <h2 class="audit-title">Audit Trail</h2>
        <p class="audit-subtitle">Credential access and modification history</p>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" (click)="exportToCSV()" title="Export to CSV">
          <i class="fa-solid fa-download"></i>
          <span>Export</span>
        </button>
        <button class="btn-icon" (click)="refresh()" title="Refresh">
          <i class="fa-solid fa-refresh"></i>
        </button>
      </div>
    </div>
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon total">
          <i class="fa-solid fa-clipboard-list"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{auditLogs.length}}</div>
          <div class="stat-label">Total Events</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon success">
          <i class="fa-solid fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value success">{{getSuccessCount()}}</div>
          <div class="stat-label">Successful</div>
        </div>
        <div class="stat-rate">{{getSuccessRate()}}%</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon failed">
          <i class="fa-solid fa-times-circle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value failed">{{getFailedCount()}}</div>
          <div class="stat-label">Failed</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon users">
          <i class="fa-solid fa-users"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{getUniqueUserCount()}}</div>
          <div class="stat-label">Unique Users</div>
        </div>
      </div>
    </div>
    <!-- Activity Chart -->
    @if (hourlyData.length > 0) {
      <div class="activity-chart">
        <div class="chart-header">
          <h3>
            <i class="fa-solid fa-chart-bar"></i>
            Today's Activity
          </h3>
        </div>
        <div class="chart-container">
          <div class="chart-bars">
            @for (data of hourlyData; track data) {
              <div
                class="chart-bar-wrapper"
                [title]="data.hour + ': ' + (data.success + data.failed) + ' events'"
                >
                <div class="chart-bar">
                  <div
                    class="bar-segment success"
                    [style.height.%]="(data.success / getMaxHourlyCount()) * 100"
                  ></div>
                  <div
                    class="bar-segment failed"
                    [style.height.%]="(data.failed / getMaxHourlyCount()) * 100"
                  ></div>
                </div>
                <span class="chart-label">{{data.hour.split(':')[0]}}</span>
              </div>
            }
          </div>
        </div>
        <div class="chart-legend">
          <span class="legend-item">
            <span class="legend-color success"></span>
            Success
          </span>
          <span class="legend-item">
            <span class="legend-color failed"></span>
            Failed
          </span>
        </div>
      </div>
    }
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-container">
          <i class="fa-solid fa-search"></i>
          <input
            type="text"
            placeholder="Search logs..."
            [value]="searchText"
            (input)="onSearchChange($any($event.target).value)"
            />
          @if (searchText) {
            <button class="search-clear" (click)="clearSearch()">
              <i class="fa-solid fa-times"></i>
            </button>
          }
        </div>
        <select
          class="filter-select"
          [value]="selectedStatus"
          (change)="onStatusFilterChange($any($event.target).value)"
          >
          <option value="">All Statuses</option>
          <option value="Success">Success</option>
          <option value="Failed">Failed</option>
        </select>
        <select
          class="filter-select"
          [value]="selectedOperation"
          (change)="onOperationFilterChange($any($event.target).value)"
          >
          <option value="">All Operations</option>
          @for (op of getOperationList(); track op) {
            <option [value]="op">{{op}}</option>
          }
        </select>
        <select
          class="filter-select"
          [value]="dateRange"
          (change)="onDateRangeChange($any($event.target).value)"
          >
          <option value="1">Last 24 hours</option>
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
      </div>
      <div class="toolbar-right">
        <div class="results-info">
          {{filteredLogs.length}} of {{auditLogs.length}} events
        </div>
        <div class="view-toggle">
          <button
            class="toggle-btn"
            [class.active]="viewMode === 'timeline'"
            (click)="setViewMode('timeline')"
            title="Timeline View"
            >
            <i class="fa-solid fa-timeline"></i>
          </button>
          <button
            class="toggle-btn"
            [class.active]="viewMode === 'table'"
            (click)="setViewMode('table')"
            title="Table View"
            >
            <i class="fa-solid fa-table"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- Timeline View -->
    @if (viewMode === 'timeline' && timelineGroups.length > 0) {
      <div class="timeline-container">
        @for (group of timelineGroups; track group) {
          <div class="timeline-group">
            <div class="timeline-date">
              <span class="date-label">{{group.displayDate}}</span>
              <span class="date-count">{{group.logs.length}} events</span>
            </div>
            <div class="timeline-items">
              @for (log of group.logs; track log) {
                <div
                  class="timeline-item"
                  [class.expanded]="expandedLogId === log.ID"
                  [class.failed]="log.Status === 'Failed'"
                  >
                  <div class="timeline-line">
                    <div
                      class="timeline-dot"
                      [style.backgroundColor]="getOperationColor(getOperationType(log))"
                    ></div>
                  </div>
                  <div class="timeline-content" (click)="toggleLogExpand(log.ID)">
                    <div class="timeline-header">
                      <div class="timeline-operation">
                        <i [class]="getOperationIcon(getOperationType(log))" [style.color]="getOperationColor(getOperationType(log))"></i>
                        <span class="operation-name">{{getOperationType(log)}}</span>
                      </div>
                      <div class="timeline-time">{{formatTime(log.__mj_CreatedAt)}}</div>
                    </div>
                    <div class="timeline-body">
                      <div class="timeline-user">
                        <i class="fa-solid fa-user"></i>
                        {{log.User || 'Unknown'}}
                      </div>
                      @if (log.Description) {
                        <div class="timeline-description">
                          {{log.Description}}
                        </div>
                      }
                      <div class="timeline-badges">
                        <span class="status-badge" [ngClass]="getStatusClass(log.Status)">
                          <i [class]="log.Status === 'Success' ? 'fa-solid fa-check' : 'fa-solid fa-times'"></i>
                          {{log.Status}}
                        </span>
                        @if (getSubsystem(log)) {
                          <span class="subsystem-badge">
                            {{getSubsystem(log)}}
                          </span>
                        }
                        @if (log.parsedDetails?.credentialType) {
                          <span class="type-badge">
                            <i class="fa-solid fa-key"></i>
                            {{log.parsedDetails?.credentialType}}
                          </span>
                        }
                      </div>
                    </div>
                    @if (expandedLogId === log.ID) {
                      <div class="timeline-details">
                        <div class="detail-grid">
                          @if (log.parsedDetails?.ipAddress) {
                            <div class="detail-item">
                              <span class="detail-label">IP Address</span>
                              <span class="detail-value">{{log.parsedDetails?.ipAddress}}</span>
                            </div>
                          }
                          @if (log.parsedDetails?.duration) {
                            <div class="detail-item">
                              <span class="detail-label">Duration</span>
                              <span class="detail-value">{{formatDuration(log.parsedDetails?.duration)}}</span>
                            </div>
                          }
                          @if (log.parsedDetails?.credentialId) {
                            <div class="detail-item">
                              <span class="detail-label">Credential ID</span>
                              <span class="detail-value mono">{{log.parsedDetails?.credentialId}}</span>
                            </div>
                          }
                          @if (log.parsedDetails?.errorMessage) {
                            <div class="detail-item full-width">
                              <span class="detail-label">Error Message</span>
                              <span class="detail-value error">{{log.parsedDetails?.errorMessage}}</span>
                            </div>
                          }
                          @if (log.parsedDetails?.userAgent) {
                            <div class="detail-item full-width">
                              <span class="detail-label">User Agent</span>
                              <span class="detail-value mono small">{{log.parsedDetails?.userAgent}}</span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                    <button class="expand-btn">
                      <i [class]="expandedLogId === log.ID ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'"></i>
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
    <!-- Table View -->
    @if (viewMode === 'table' && filteredLogs.length > 0) {
      <div class="audit-table-container">
        <table class="audit-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Operation</th>
              <th>Description</th>
              <th>Subsystem</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @for (log of filteredLogs; track log) {
              <tr [class.failed-row]="log.Status === 'Failed'">
                <td class="timestamp">{{formatDate(log.__mj_CreatedAt)}}</td>
                <td class="user">{{log.User || 'Unknown'}}</td>
                <td class="operation">
                  <span class="operation-badge" [style.backgroundColor]="getOperationColor(getOperationType(log)) + '20'" [style.color]="getOperationColor(getOperationType(log))">
                    <i [class]="getOperationIcon(getOperationType(log))"></i>
                    {{getOperationType(log)}}
                  </span>
                </td>
                <td class="description">{{log.Description || '-'}}</td>
                <td class="subsystem">{{getSubsystem(log) || '-'}}</td>
                <td class="status">
                  <span class="status-badge" [ngClass]="getStatusClass(log.Status)">
                    <i [class]="log.Status === 'Success' ? 'fa-solid fa-check' : 'fa-solid fa-times'"></i>
                    {{log.Status}}
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
    <!-- Empty State -->
    @if (filteredLogs.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fa-solid fa-clipboard-list"></i>
        </div>
        <h3>No Audit Logs</h3>
        @if (searchText || selectedStatus || selectedOperation) {
          <p>
            No events match your current filters.
            <button class="btn-link" (click)="searchText = ''; selectedStatus = ''; selectedOperation = ''; applyFilters()">Clear filters</button>
          </p>
        }
        @if (!searchText && !selectedStatus && !selectedOperation) {
          <p>
            No credential access events in the selected time range.
          </p>
        }
      </div>
    }
  }
</div>
