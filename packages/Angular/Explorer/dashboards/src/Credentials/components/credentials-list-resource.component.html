<div class="list-container">
    <mj-loading *ngIf="isLoading" text="Loading credentials..."></mj-loading>

    <ng-container *ngIf="!isLoading">
        <!-- Header with Stats -->
        <div class="list-header">
            <div class="header-info">
                <h2 class="list-title">Credentials</h2>
                <div class="header-stats">
                    <span class="stat-item">
                        <i class="fa-solid fa-key"></i>
                        {{credentials.length}} total
                    </span>
                    <span class="stat-item active">
                        <i class="fa-solid fa-check-circle"></i>
                        {{getActiveCount()}} active
                    </span>
                    <span class="stat-item warning" *ngIf="getExpiringSoonCount() > 0">
                        <i class="fa-solid fa-clock"></i>
                        {{getExpiringSoonCount()}} expiring
                    </span>
                    <span class="stat-item danger" *ngIf="getExpiredCount() > 0">
                        <i class="fa-solid fa-exclamation-circle"></i>
                        {{getExpiredCount()}} expired
                    </span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-primary" *ngIf="UserCanCreate" (click)="createNewCredential()">
                    <i class="fa-solid fa-plus"></i>
                    <span>New Credential</span>
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-container">
                    <i class="fa-solid fa-search"></i>
                    <input
                        type="text"
                        placeholder="Search credentials..."
                        [value]="searchText"
                        (input)="onSearchChange($any($event.target).value)"
                    />
                    <button class="search-clear" *ngIf="searchText" (click)="onSearchChange('')">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>

                <select
                    class="filter-select"
                    [value]="selectedTypeFilter"
                    (change)="onTypeFilterChange($any($event.target).value)"
                >
                    <option value="">All Types</option>
                    <option *ngFor="let type of types" [value]="type.ID">{{type.Name}}</option>
                </select>

                <select
                    class="filter-select"
                    [value]="selectedStatusFilter"
                    (change)="onStatusFilterChange($any($event.target).value)"
                >
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="expiring">Expiring Soon</option>
                    <option value="expired">Expired</option>
                </select>
            </div>

            <div class="toolbar-right">
                <div class="results-info">
                    {{filteredCredentials.length}} of {{credentials.length}}
                </div>

                <div class="view-toggle">
                    <button
                        class="view-btn"
                        [class.active]="viewMode === 'grid'"
                        (click)="setViewMode('grid')"
                        title="Grid View"
                    >
                        <i class="fa-solid fa-grid-2"></i>
                    </button>
                    <button
                        class="view-btn"
                        [class.active]="viewMode === 'list'"
                        (click)="setViewMode('list')"
                        title="List View"
                    >
                        <i class="fa-solid fa-list"></i>
                    </button>
                </div>

                <button class="btn-icon" (click)="refresh()" title="Refresh">
                    <i class="fa-solid fa-refresh"></i>
                </button>
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="bulk-actions" *ngIf="selectedCredentials.size > 0">
            <div class="bulk-info">
                <span class="bulk-count">{{selectedCredentials.size}} selected</span>
                <button class="btn-link" (click)="clearSelection()">Clear selection</button>
            </div>
            <div class="bulk-buttons">
                <button class="btn-bulk" *ngIf="UserCanUpdate" (click)="bulkToggleActive(true)">
                    <i class="fa-solid fa-toggle-on"></i>
                    Activate
                </button>
                <button class="btn-bulk" *ngIf="UserCanUpdate" (click)="bulkToggleActive(false)">
                    <i class="fa-solid fa-toggle-off"></i>
                    Deactivate
                </button>
                <button class="btn-bulk danger" *ngIf="UserCanDelete" (click)="bulkDelete()">
                    <i class="fa-solid fa-trash"></i>
                    Delete
                </button>
            </div>
        </div>

        <!-- Grid View -->
        <div class="credentials-grid" *ngIf="viewMode === 'grid' && filteredCredentials.length > 0">
            <div
                class="credential-card"
                *ngFor="let credential of filteredCredentials"
                [class.selected]="selectedCredentials.has(credential.ID)"
                [class.expired]="isExpired(credential)"
                [class.expiring]="isExpiringSoon(credential)"
            >
                <!-- Selection Checkbox -->
                <div class="card-select" *ngIf="UserCanUpdate || UserCanDelete">
                    <input
                        type="checkbox"
                        [checked]="selectedCredentials.has(credential.ID)"
                        (change)="toggleSelection(credential)"
                    />
                </div>

                <div class="card-header">
                    <div class="card-icon" [ngClass]="getStatusClass(credential)">
                        <i [class]="credential.IconClass || 'fa-solid fa-key'"></i>
                    </div>
                    <div class="card-title">
                        <div class="credential-name">{{credential.Name}}</div>
                        <div class="credential-type">{{credential.CredentialType || 'Unknown Type'}}</div>
                    </div>
                    <div class="card-actions">
                        <button
                            class="action-btn"
                            *ngIf="UserCanUpdate"
                            (click)="toggleCredentialActive(credential, $event)"
                            [title]="credential.IsActive ? 'Deactivate' : 'Activate'"
                        >
                            <i [class]="credential.IsActive ? 'fa-solid fa-toggle-on' : 'fa-solid fa-toggle-off'"></i>
                        </button>
                        <button
                            class="action-btn"
                            *ngIf="UserCanUpdate"
                            (click)="editCredential(credential, $event)"
                            title="Edit"
                        >
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button
                            class="action-btn danger"
                            *ngIf="UserCanDelete"
                            (click)="deleteCredential(credential, $event)"
                            title="Delete"
                        >
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="card-body" (click)="editCredential(credential)">
                    <div class="status-badge" [ngClass]="getStatusClass(credential)">
                        <i [class]="getStatusIcon(credential)"></i>
                        {{getStatusLabel(credential)}}
                    </div>

                    <p class="credential-description" *ngIf="credential.Description">
                        {{credential.Description}}
                    </p>

                    <div class="credential-meta">
                        <div class="meta-item" *ngIf="credential.IsDefault">
                            <i class="fa-solid fa-star"></i>
                            <span>Default</span>
                        </div>
                        <div class="meta-item" *ngIf="credential.ExpiresAt" [class.warning]="isExpiringSoon(credential)" [class.danger]="isExpired(credential)">
                            <i class="fa-solid fa-calendar"></i>
                            <span>{{isExpired(credential) ? 'Expired' : 'Expires'}}: {{formatDate(credential.ExpiresAt)}}</span>
                        </div>
                        <div class="meta-item" *ngIf="credential.LastUsedAt">
                            <i class="fa-solid fa-clock"></i>
                            <span>Last used: {{formatDate(credential.LastUsedAt)}}</span>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="category-tag" *ngIf="credential.Category">
                        <i class="fa-solid fa-folder"></i>
                        {{credential.Category}}
                    </div>
                    <div class="created-info">
                        Created {{formatDate(credential.__mj_CreatedAt)}}
                    </div>
                </div>
            </div>
        </div>

        <!-- List View -->
        <div class="credentials-table-container" *ngIf="viewMode === 'list' && filteredCredentials.length > 0">
            <table class="credentials-table">
                <thead>
                    <tr>
                        <th class="col-select" *ngIf="UserCanUpdate || UserCanDelete">
                            <input
                                type="checkbox"
                                [checked]="isAllSelected()"
                                (change)="toggleSelectAll()"
                            />
                        </th>
                        <th class="col-name">Name</th>
                        <th class="col-type">Type</th>
                        <th class="col-category">Category</th>
                        <th class="col-status">Status</th>
                        <th class="col-expires">Expires</th>
                        <th class="col-used">Last Used</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr
                        *ngFor="let credential of filteredCredentials"
                        [class.selected]="selectedCredentials.has(credential.ID)"
                        [class.expired]="isExpired(credential)"
                    >
                        <td class="col-select" *ngIf="UserCanUpdate || UserCanDelete">
                            <input
                                type="checkbox"
                                [checked]="selectedCredentials.has(credential.ID)"
                                (change)="toggleSelection(credential)"
                            />
                        </td>
                        <td class="col-name" (click)="editCredential(credential)">
                            <div class="name-cell">
                                <i [class]="credential.IconClass || 'fa-solid fa-key'" [ngClass]="getStatusClass(credential)"></i>
                                <div class="name-info">
                                    <span class="credential-name">{{credential.Name}}</span>
                                    <span class="credential-desc" *ngIf="credential.Description">{{credential.Description}}</span>
                                </div>
                                <span class="default-badge" *ngIf="credential.IsDefault">Default</span>
                            </div>
                        </td>
                        <td class="col-type">{{credential.CredentialType || '-'}}</td>
                        <td class="col-category">
                            <span class="category-pill" *ngIf="credential.Category">{{credential.Category}}</span>
                            <span *ngIf="!credential.Category">-</span>
                        </td>
                        <td class="col-status">
                            <span class="status-pill" [ngClass]="getStatusClass(credential)">
                                {{getStatusLabel(credential)}}
                            </span>
                        </td>
                        <td class="col-expires" [class.warning]="isExpiringSoon(credential)" [class.danger]="isExpired(credential)">
                            {{credential.ExpiresAt ? formatDate(credential.ExpiresAt) : 'Never'}}
                        </td>
                        <td class="col-used">
                            {{credential.LastUsedAt ? formatDate(credential.LastUsedAt) : 'Never'}}
                        </td>
                        <td class="col-actions">
                            <div class="table-actions">
                                <button
                                    class="table-action-btn"
                                    *ngIf="UserCanUpdate"
                                    (click)="toggleCredentialActive(credential, $event)"
                                    [title]="credential.IsActive ? 'Deactivate' : 'Activate'"
                                >
                                    <i [class]="credential.IsActive ? 'fa-solid fa-toggle-on' : 'fa-solid fa-toggle-off'"></i>
                                </button>
                                <button
                                    class="table-action-btn"
                                    *ngIf="UserCanUpdate"
                                    (click)="editCredential(credential, $event)"
                                    title="Edit"
                                >
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button
                                    class="table-action-btn danger"
                                    *ngIf="UserCanDelete"
                                    (click)="deleteCredential(credential, $event)"
                                    title="Delete"
                                >
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredCredentials.length === 0">
            <div class="empty-icon">
                <i class="fa-solid fa-key"></i>
            </div>
            <h3>No Credentials Found</h3>
            <p *ngIf="searchText || selectedTypeFilter || selectedStatusFilter">
                No credentials match your current filters.
                <button class="btn-link" (click)="clearFilters()">Clear filters</button>
            </p>
            <p *ngIf="!searchText && !selectedTypeFilter && !selectedStatusFilter">
                Get started by creating your first credential.
            </p>
            <button class="btn-primary" *ngIf="UserCanCreate && !searchText && !selectedTypeFilter && !selectedStatusFilter" (click)="createNewCredential()">
                <i class="fa-solid fa-plus"></i>
                Create Credential
            </button>
        </div>
    </ng-container>

    <!-- Edit Panel -->
    <mj-credential-edit-panel
        #editPanel
        [credentialTypes]="types"
        (saved)="onCredentialSaved($event)"
        (deleted)="onCredentialDeleted($event)"
    ></mj-credential-edit-panel>
</div>
