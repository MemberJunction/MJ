<div class="list-container">
  @if (isLoading) {
    <mj-loading text="Loading credentials..."></mj-loading>
  }

  @if (!isLoading) {
    <!-- Header with Stats -->
    <div class="list-header">
      <div class="header-info">
        <h2 class="list-title">Credentials</h2>
        <div class="header-stats">
          <span class="stat-item">
            <i class="fa-solid fa-key"></i>
            {{credentials.length}} total
          </span>
          <span class="stat-item active">
            <i class="fa-solid fa-check-circle"></i>
            {{getActiveCount()}} active
          </span>
          @if (getExpiringSoonCount() > 0) {
            <span class="stat-item warning">
              <i class="fa-solid fa-clock"></i>
              {{getExpiringSoonCount()}} expiring
            </span>
          }
          @if (getExpiredCount() > 0) {
            <span class="stat-item danger">
              <i class="fa-solid fa-exclamation-circle"></i>
              {{getExpiredCount()}} expired
            </span>
          }
        </div>
      </div>
      <div class="header-actions">
        @if (UserCanCreate) {
          <button class="btn-primary" (click)="createNewCredential()">
            <i class="fa-solid fa-plus"></i>
            <span>New Credential</span>
          </button>
        }
      </div>
    </div>
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-container">
          <i class="fa-solid fa-search"></i>
          <input
            type="text"
            placeholder="Search credentials..."
            [value]="searchText"
            (input)="onSearchChange($any($event.target).value)"
            />
          @if (searchText) {
            <button class="search-clear" (click)="onSearchChange('')">
              <i class="fa-solid fa-times"></i>
            </button>
          }
        </div>
        <select
          class="filter-select"
          [value]="selectedTypeFilter"
          (change)="onTypeFilterChange($any($event.target).value)"
          >
          <option value="">All Types</option>
          @for (type of types; track type) {
            <option [value]="type.ID">{{type.Name}}</option>
          }
        </select>
        <select
          class="filter-select"
          [value]="selectedStatusFilter"
          (change)="onStatusFilterChange($any($event.target).value)"
          >
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="expiring">Expiring Soon</option>
          <option value="expired">Expired</option>
        </select>
      </div>
      <div class="toolbar-right">
        <div class="results-info">
          {{filteredCredentials.length}} of {{credentials.length}}
        </div>
        <div class="view-toggle">
          <button
            class="view-btn"
            [class.active]="viewMode === 'grid'"
            (click)="setViewMode('grid')"
            title="Grid View"
            >
            <i class="fa-solid fa-grid-2"></i>
          </button>
          <button
            class="view-btn"
            [class.active]="viewMode === 'list'"
            (click)="setViewMode('list')"
            title="List View"
            >
            <i class="fa-solid fa-list"></i>
          </button>
        </div>
        <button class="btn-icon" (click)="refresh()" title="Refresh">
          <i class="fa-solid fa-refresh"></i>
        </button>
      </div>
    </div>
    <!-- Bulk Actions Bar -->
    @if (selectedCredentials.size > 0) {
      <div class="bulk-actions">
        <div class="bulk-info">
          <span class="bulk-count">{{selectedCredentials.size}} selected</span>
          <button class="btn-link" (click)="clearSelection()">Clear selection</button>
        </div>
        <div class="bulk-buttons">
          @if (UserCanUpdate) {
            <button class="btn-bulk" (click)="bulkToggleActive(true)">
              <i class="fa-solid fa-toggle-on"></i>
              Activate
            </button>
          }
          @if (UserCanUpdate) {
            <button class="btn-bulk" (click)="bulkToggleActive(false)">
              <i class="fa-solid fa-toggle-off"></i>
              Deactivate
            </button>
          }
          @if (UserCanDelete) {
            <button class="btn-bulk danger" (click)="bulkDelete()">
              <i class="fa-solid fa-trash"></i>
              Delete
            </button>
          }
        </div>
      </div>
    }
    <!-- Grid View -->
    @if (viewMode === 'grid' && filteredCredentials.length > 0) {
      <div class="credentials-grid">
        @for (credential of filteredCredentials; track credential) {
          <div
            class="credential-card"
            [class.selected]="selectedCredentials.has(credential.ID)"
            [class.expired]="isExpired(credential)"
            [class.expiring]="isExpiringSoon(credential)"
            >
            <!-- Selection Checkbox -->
            @if (UserCanUpdate || UserCanDelete) {
              <div class="card-select">
                <input
                  type="checkbox"
                  [checked]="selectedCredentials.has(credential.ID)"
                  (change)="toggleSelection(credential)"
                  />
              </div>
            }
            <div class="card-header">
              <div class="card-icon" [ngClass]="getStatusClass(credential)">
                <i [class]="credential.IconClass || 'fa-solid fa-key'"></i>
              </div>
              <div class="card-title">
                <div class="credential-name">{{credential.Name}}</div>
                <div class="credential-type">{{credential.CredentialType || 'Unknown Type'}}</div>
              </div>
              <div class="card-actions">
                @if (UserCanUpdate) {
                  <button
                    class="action-btn"
                    (click)="toggleCredentialActive(credential, $event)"
                    [title]="credential.IsActive ? 'Deactivate' : 'Activate'"
                    >
                    <i [class]="credential.IsActive ? 'fa-solid fa-toggle-on' : 'fa-solid fa-toggle-off'"></i>
                  </button>
                }
                @if (UserCanUpdate) {
                  <button
                    class="action-btn"
                    (click)="editCredential(credential, $event)"
                    title="Edit"
                    >
                    <i class="fa-solid fa-pen"></i>
                  </button>
                }
                @if (UserCanDelete) {
                  <button
                    class="action-btn danger"
                    (click)="deleteCredential(credential, $event)"
                    title="Delete"
                    >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                }
              </div>
            </div>
            <div class="card-body" (click)="editCredential(credential)">
              <div class="status-badge" [ngClass]="getStatusClass(credential)">
                <i [class]="getStatusIcon(credential)"></i>
                {{getStatusLabel(credential)}}
              </div>
              @if (credential.Description) {
                <p class="credential-description">
                  {{credential.Description}}
                </p>
              }
              <div class="credential-meta">
                @if (credential.IsDefault) {
                  <div class="meta-item">
                    <i class="fa-solid fa-star"></i>
                    <span>Default</span>
                  </div>
                }
                @if (credential.ExpiresAt) {
                  <div class="meta-item" [class.warning]="isExpiringSoon(credential)" [class.danger]="isExpired(credential)">
                    <i class="fa-solid fa-calendar"></i>
                    <span>{{isExpired(credential) ? 'Expired' : 'Expires'}}: {{formatDate(credential.ExpiresAt)}}</span>
                  </div>
                }
                @if (credential.LastUsedAt) {
                  <div class="meta-item">
                    <i class="fa-solid fa-clock"></i>
                    <span>Last used: {{formatDate(credential.LastUsedAt)}}</span>
                  </div>
                }
              </div>
            </div>
            <div class="card-footer">
              @if (credential.Category) {
                <div class="category-tag">
                  <i class="fa-solid fa-folder"></i>
                  {{credential.Category}}
                </div>
              }
              <div class="created-info">
                Created {{formatDate(credential.__mj_CreatedAt)}}
              </div>
            </div>
          </div>
        }
      </div>
    }
    <!-- List View -->
    @if (viewMode === 'list' && filteredCredentials.length > 0) {
      <div class="credentials-table-container">
        <table class="credentials-table">
          <thead>
            <tr>
              @if (UserCanUpdate || UserCanDelete) {
                <th class="col-select">
                  <input
                    type="checkbox"
                    [checked]="isAllSelected()"
                    (change)="toggleSelectAll()"
                    />
                </th>
              }
              <th class="col-name">Name</th>
              <th class="col-type">Type</th>
              <th class="col-category">Category</th>
              <th class="col-status">Status</th>
              <th class="col-expires">Expires</th>
              <th class="col-used">Last Used</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (credential of filteredCredentials; track credential) {
              <tr
                [class.selected]="selectedCredentials.has(credential.ID)"
                [class.expired]="isExpired(credential)"
                >
                @if (UserCanUpdate || UserCanDelete) {
                  <td class="col-select">
                    <input
                      type="checkbox"
                      [checked]="selectedCredentials.has(credential.ID)"
                      (change)="toggleSelection(credential)"
                      />
                  </td>
                }
                <td class="col-name" (click)="editCredential(credential)">
                  <div class="name-cell">
                    <i [class]="credential.IconClass || 'fa-solid fa-key'" [ngClass]="getStatusClass(credential)"></i>
                    <div class="name-info">
                      <span class="credential-name">{{credential.Name}}</span>
                      @if (credential.Description) {
                        <span class="credential-desc">{{credential.Description}}</span>
                      }
                    </div>
                    @if (credential.IsDefault) {
                      <span class="default-badge">Default</span>
                    }
                  </div>
                </td>
                <td class="col-type">{{credential.CredentialType || '-'}}</td>
                <td class="col-category">
                  @if (credential.Category) {
                    <span class="category-pill">{{credential.Category}}</span>
                  }
                  @if (!credential.Category) {
                    <span>-</span>
                  }
                </td>
                <td class="col-status">
                  <span class="status-pill" [ngClass]="getStatusClass(credential)">
                    {{getStatusLabel(credential)}}
                  </span>
                </td>
                <td class="col-expires" [class.warning]="isExpiringSoon(credential)" [class.danger]="isExpired(credential)">
                  {{credential.ExpiresAt ? formatDate(credential.ExpiresAt) : 'Never'}}
                </td>
                <td class="col-used">
                  {{credential.LastUsedAt ? formatDate(credential.LastUsedAt) : 'Never'}}
                </td>
                <td class="col-actions">
                  <div class="table-actions">
                    @if (UserCanUpdate) {
                      <button
                        class="table-action-btn"
                        (click)="toggleCredentialActive(credential, $event)"
                        [title]="credential.IsActive ? 'Deactivate' : 'Activate'"
                        >
                        <i [class]="credential.IsActive ? 'fa-solid fa-toggle-on' : 'fa-solid fa-toggle-off'"></i>
                      </button>
                    }
                    @if (UserCanUpdate) {
                      <button
                        class="table-action-btn"
                        (click)="editCredential(credential, $event)"
                        title="Edit"
                        >
                        <i class="fa-solid fa-pen"></i>
                      </button>
                    }
                    @if (UserCanDelete) {
                      <button
                        class="table-action-btn danger"
                        (click)="deleteCredential(credential, $event)"
                        title="Delete"
                        >
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
    <!-- Empty State -->
    @if (filteredCredentials.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fa-solid fa-key"></i>
        </div>
        <h3>No Credentials Found</h3>
        @if (searchText || selectedTypeFilter || selectedStatusFilter) {
          <p>
            No credentials match your current filters.
            <button class="btn-link" (click)="clearFilters()">Clear filters</button>
          </p>
        }
        @if (!searchText && !selectedTypeFilter && !selectedStatusFilter) {
          <p>
            Get started by creating your first credential.
          </p>
        }
        @if (UserCanCreate && !searchText && !selectedTypeFilter && !selectedStatusFilter) {
          <button class="btn-primary" (click)="createNewCredential()">
            <i class="fa-solid fa-plus"></i>
            Create Credential
          </button>
        }
      </div>
    }
  }

  <!-- Edit Panel -->
  <mj-credential-edit-panel
    #editPanel
    [credentialTypes]="types"
    (saved)="onCredentialSaved($event)"
    (deleted)="onCredentialDeleted($event)"
  ></mj-credential-edit-panel>
</div>
