<div class="types-container">
  @if (isLoading) {
    <mj-loading text="Loading credential types..."></mj-loading>
  }

  @if (!isLoading) {
    <!-- Header -->
    <div class="types-header">
      <div class="header-info">
        <h2 class="types-title">Credential Types</h2>
        <div class="header-stats">
          <span class="stat-item">
            <i class="fa-solid fa-shapes"></i>
            {{types.length}} types
          </span>
          <span class="stat-item">
            <i class="fa-solid fa-folder"></i>
            {{categories.length}} categories
          </span>
          <span class="stat-item">
            <i class="fa-solid fa-key"></i>
            {{getTotalCredentialCount()}} credentials
          </span>
        </div>
      </div>
      <div class="header-actions">
        @if (UserCanCreate) {
          <button class="btn-primary" (click)="createNewType()">
            <i class="fa-solid fa-plus"></i>
            <span>New Type</span>
          </button>
        }
      </div>
    </div>
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-container">
          <i class="fa-solid fa-search"></i>
          <input
            type="text"
            placeholder="Search types..."
            [value]="searchText"
            (input)="onSearchChange($any($event.target).value)"
            />
          @if (searchText) {
            <button class="search-clear" (click)="onSearchChange('')">
              <i class="fa-solid fa-times"></i>
            </button>
          }
        </div>
        <select
          class="filter-select"
          [value]="selectedCategoryFilter"
          (change)="onCategoryFilterChange($any($event.target).value)"
          >
          <option value="">All Categories</option>
          @for (cat of categories; track cat) {
            <option [value]="cat">{{cat}}</option>
          }
        </select>
      </div>
      <div class="toolbar-right">
        <div class="results-info">
          {{filteredTypes.length}} of {{types.length}} types
        </div>
        <button class="btn-icon" (click)="refresh()" title="Refresh">
          <i class="fa-solid fa-refresh"></i>
        </button>
      </div>
    </div>
    <div class="types-layout">
      <!-- Types List -->
      <div class="types-list">
        @for (entry of getTypesByCategory() | keyvalue; track entry) {
          <div class="category-section">
            <div class="category-header" [style.borderLeftColor]="getCategoryColor(entry.key)">
              <i [class]="getCategoryIcon(entry.key)" [style.color]="getCategoryColor(entry.key)"></i>
              <span class="category-name">{{entry.key}}</span>
              <span class="count">{{entry.value.length}}</span>
            </div>
            <div class="type-items">
              @for (type of entry.value; track type) {
                <div
                  class="type-item"
                  [class.selected]="IsTypeSelected(type)"
                  (click)="selectType(type)"
                  >
                  <div class="type-icon" [style.backgroundColor]="getCategoryColor(type.Category) + '15'" [style.color]="getCategoryColor(type.Category)">
                    <i [class]="type.IconClass || 'fa-solid fa-key'"></i>
                  </div>
                  <div class="type-info">
                    <div class="type-name">{{type.Name}}</div>
                    @if (type.Description) {
                      <div class="type-description">
                        {{type.Description | slice:0:60}}{{type.Description.length > 60 ? '...' : ''}}
                      </div>
                    }
                    <div class="type-meta">
                      @if (type.credentialCount > 0) {
                        <span class="meta-badge">
                          <i class="fa-solid fa-key"></i>
                          {{type.credentialCount}}
                        </span>
                      }
                      @if (type.activeCount > 0) {
                        <span class="meta-badge active">
                          <i class="fa-solid fa-check"></i>
                          {{type.activeCount}} active
                        </span>
                      }
                      @if (type.expiringCount > 0) {
                        <span class="meta-badge warning">
                          <i class="fa-solid fa-clock"></i>
                          {{type.expiringCount}} expiring
                        </span>
                      }
                    </div>
                  </div>
                  <div class="type-actions">
                    @if (UserCanCreateCredential) {
                      <button
                        class="action-btn"
                        (click)="createCredentialForType(type, $event)"
                        title="Add Credential"
                        >
                        <i class="fa-solid fa-plus"></i>
                      </button>
                    }
                    @if (UserCanUpdate) {
                      <button
                        class="action-btn"
                        (click)="editType(type, $event)"
                        title="Edit Type"
                        >
                        <i class="fa-solid fa-pen"></i>
                      </button>
                    }
                    @if (UserCanDelete && type.credentialCount === 0) {
                      <button
                        class="action-btn danger"
                        (click)="deleteType(type, $event)"
                        title="Delete Type"
                        >
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    }
                  </div>
                  <i class="fa-solid fa-chevron-right arrow"></i>
                </div>
              }
            </div>
          </div>
        }
        @if (filteredTypes.length === 0) {
          <div class="empty-state">
            <div class="empty-icon">
              <i class="fa-solid fa-cubes"></i>
            </div>
            <h3>No Credential Types Found</h3>
            @if (searchText || selectedCategoryFilter) {
              <p>
                No types match your current filters.
                <button class="btn-link" (click)="clearFilters()">Clear filters</button>
              </p>
            }
            @if (!searchText && !selectedCategoryFilter) {
              <p>
                Get started by creating your first credential type.
              </p>
            }
            @if (UserCanCreate && !searchText && !selectedCategoryFilter) {
              <button class="btn-primary" (click)="createNewType()">
                <i class="fa-solid fa-plus"></i>
                Create Type
              </button>
            }
          </div>
        }
      </div>
      <!-- Type Detail -->
      @if (selectedType) {
        <div class="type-detail">
          <div class="detail-header">
            <div class="detail-icon" [style.backgroundColor]="getCategoryColor(selectedType.Category) + '15'" [style.color]="getCategoryColor(selectedType.Category)">
              <i [class]="selectedType.IconClass || 'fa-solid fa-key'"></i>
            </div>
            <div class="detail-title">
              <h2>{{selectedType.Name}}</h2>
              <span class="category-badge" [style.backgroundColor]="getCategoryColor(selectedType.Category) + '20'" [style.color]="getCategoryColor(selectedType.Category)">
                <i [class]="getCategoryIcon(selectedType.Category)"></i>
                {{selectedType.Category}}
              </span>
            </div>
            <div class="detail-actions">
              @if (UserCanUpdate) {
                <button class="action-btn" (click)="editType(selectedType)" title="Edit">
                  <i class="fa-solid fa-pen"></i>
                </button>
              }
              <button class="close-btn" (click)="closeDetail()">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
          <div class="detail-body">
            <!-- Stats Row -->
            <div class="detail-stats">
              <div class="detail-stat">
                <div class="stat-value">{{selectedType.credentialCount}}</div>
                <div class="stat-label">Credentials</div>
              </div>
              <div class="detail-stat active">
                <div class="stat-value">{{selectedType.activeCount}}</div>
                <div class="stat-label">Active</div>
              </div>
              @if (selectedType.expiringCount > 0) {
                <div class="detail-stat warning">
                  <div class="stat-value">{{selectedType.expiringCount}}</div>
                  <div class="stat-label">Expiring</div>
                </div>
              }
            </div>
            @if (selectedType.Description) {
              <p class="description">
                {{selectedType.Description}}
              </p>
            }
            <div class="schema-section">
              <h3>
                <i class="fa-solid fa-list-check"></i>
                Field Schema
              </h3>
              @if (schemaProperties.length > 0) {
                <div class="field-list">
                  @for (prop of schemaProperties; track prop) {
                    <div class="field-item">
                      <div class="field-header">
                        <span class="field-name">{{prop.title}}</span>
                        <span class="field-badges">
                          <span class="badge type">{{prop.type}}</span>
                          @if (prop.isSecret) {
                            <span class="badge secret">
                              <i class="fa-solid fa-lock"></i> Secret
                            </span>
                          }
                          @if (prop.required) {
                            <span class="badge required">Required</span>
                          }
                        </span>
                      </div>
                      @if (prop.description) {
                        <p class="field-description">
                          {{prop.description}}
                        </p>
                      }
                    </div>
                  }
                </div>
              }
              @if (schemaProperties.length === 0) {
                <div class="no-fields">
                  <i class="fa-solid fa-info-circle"></i>
                  <span>No fields defined in schema</span>
                </div>
              }
            </div>
            @if (selectedType.ValidationEndpoint) {
              <div class="validation-section">
                <h3>
                  <i class="fa-solid fa-check-circle"></i>
                  Validation
                </h3>
                <div class="validation-endpoint">
                  <i class="fa-solid fa-link"></i>
                  <span>{{selectedType.ValidationEndpoint}}</span>
                </div>
              </div>
            }
            <!-- Quick Actions -->
            @if (UserCanCreateCredential) {
              <div class="detail-quick-actions">
                <button class="btn-primary" (click)="createCredentialForType(selectedType)">
                  <i class="fa-solid fa-plus"></i>
                  Create Credential
                </button>
              </div>
            }
          </div>
        </div>
      }
      <!-- No Selection -->
      @if (!selectedType && filteredTypes.length > 0) {
        <div class="no-selection">
          <div class="no-selection-icon">
            <i class="fa-solid fa-hand-pointer"></i>
          </div>
          <h3>Select a Credential Type</h3>
          <p>Click on a credential type to view its details and field schema</p>
        </div>
      }
    </div>
  }
</div>

<!-- Type Edit Panel -->
<mj-credential-type-edit-panel
  #typeEditPanel
  (saved)="onTypeSaved($any($event))"
  (deleted)="onTypeDeleted($any($event))"
></mj-credential-type-edit-panel>
