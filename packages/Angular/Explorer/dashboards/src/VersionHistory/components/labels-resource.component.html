<div class="labels-container">
    <mj-loading *ngIf="IsLoading" text="Loading version labels..."></mj-loading>

    <ng-container *ngIf="!IsLoading">
        <!-- Header -->
        <div class="page-header">
            <div class="header-left">
                <h2 class="page-title">Version Labels</h2>
                <p class="page-subtitle">Manage versioning snapshots across your system</p>
            </div>
            <div class="header-actions">
                <div class="view-toggle">
                    <button class="toggle-btn" [class.active]="ViewMode === 'card'" (click)="SetViewMode('card')" title="Card view">
                        <i class="fa-solid fa-grip"></i>
                    </button>
                    <button class="toggle-btn" [class.active]="ViewMode === 'list'" (click)="SetViewMode('list')" title="List view">
                        <i class="fa-solid fa-list"></i>
                    </button>
                </div>
                <button class="btn-primary" (click)="OpenCreateDialog()">
                    <i class="fa-solid fa-plus"></i>
                    <span>Create Label</span>
                </button>
                <button class="btn-icon" (click)="Refresh()" title="Refresh">
                    <i class="fa-solid fa-refresh"></i>
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-row">
            <div class="kpi-card">
                <div class="kpi-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                    <i class="fa-solid fa-tags"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{{FormatNumber(TotalLabels)}}</div>
                    <div class="kpi-label">Total Labels</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                    <i class="fa-solid fa-circle-check"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{{FormatNumber(ActiveLabels)}}</div>
                    <div class="kpi-label">Active</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon" style="background: rgba(107, 114, 128, 0.1); color: #6b7280;">
                    <i class="fa-solid fa-box-archive"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{{FormatNumber(ArchivedLabels)}}</div>
                    <div class="kpi-label">Archived</div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </div>
                <div class="kpi-content">
                    <div class="kpi-value">{{FormatNumber(RestoredLabels)}}</div>
                    <div class="kpi-label">Restored</div>
                </div>
            </div>
        </div>

        <!-- Scope breakdown -->
        <div class="scope-chips">
            <button class="scope-chip"
                    *ngFor="let stat of ScopeStats"
                    [class.active]="ScopeFilter === stat.Scope"
                    (click)="OnScopeFilterChange(stat.Scope)">
                <i [class]="stat.Icon"></i>
                <span>{{stat.Scope}}</span>
                <span class="chip-count">{{stat.Count}}</span>
            </button>
            <button class="scope-chip"
                    *ngFor="let stat of StatusStats"
                    [class.active]="StatusFilter === stat.Status"
                    [ngClass]="GetStatusClass(stat.Status)"
                    (click)="OnStatusFilterChange(stat.Status)">
                <span>{{stat.Status}}</span>
                <span class="chip-count">{{stat.Count}}</span>
            </button>
        </div>

        <!-- Search -->
        <div class="search-bar">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text"
                   class="search-input"
                   placeholder="Search labels by name, description, or entity..."
                   [ngModel]="SearchText"
                   (ngModelChange)="OnSearchChange($event)" />
            <button class="btn-clear" *ngIf="SearchText" (click)="OnSearchChange('')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <!-- Labels Card View -->
        <div class="labels-list" *ngIf="FilteredLabels.length > 0 && ViewMode === 'card'">
            <div class="label-card clickable" *ngFor="let label of FilteredLabels"
                 [class.group-parent]="IsGroupParent(label)"
                 (click)="OnLabelClick(label)">
                <div class="label-header">
                    <div class="label-title-row">
                        <i [class]="GetScopeIcon(label.Scope)" class="label-scope-icon"></i>
                        <h3 class="label-name">{{label.Name}}</h3>
                        <span class="group-badge" *ngIf="IsGroupParent(label)">
                            <i class="fa-solid fa-layer-group"></i>
                            {{GetChildLabels(label.ID).length}} records
                        </span>
                        <span class="label-status" [ngClass]="GetStatusClass(label.Status)">
                            {{label.Status}}
                        </span>
                    </div>
                    <div class="label-meta">
                        <span class="meta-item" title="Scope">
                            <i class="fa-solid fa-layer-group"></i> {{label.Scope}}
                        </span>
                        <span class="meta-item" *ngIf="label.Entity || label.EntityID" title="Entity">
                            <i class="fa-solid fa-table"></i> {{label.Entity ?? ResolveEntityName(label.EntityID)}}
                        </span>
                        <span class="meta-item" *ngIf="label.RecordID" title="Record ID">
                            <i class="fa-solid fa-fingerprint"></i> {{label.RecordID | slice:0:12}}...
                        </span>
                        <span class="meta-item" *ngIf="label.ItemCount" title="Items captured">
                            <i class="fa-solid fa-camera"></i> {{label.ItemCount}} items
                        </span>
                        <span class="meta-item" *ngIf="!label.ItemCount" title="Items captured">
                            <i class="fa-solid fa-camera"></i> {{GetItemCount(label.ID)}} items
                        </span>
                        <span class="meta-item" *ngIf="label.CreationDurationMS" title="Creation time">
                            <i class="fa-solid fa-stopwatch"></i> {{FormatDuration(label.CreationDurationMS)}}
                        </span>
                        <span class="meta-item" *ngIf="label.CreatedByUser" title="Created by">
                            <i class="fa-solid fa-user"></i> {{label.CreatedByUser}}
                        </span>
                        <span class="meta-item" title="Created">
                            <i class="fa-regular fa-clock"></i> {{FormatDate(label.__mj_CreatedAt)}}
                        </span>
                    </div>
                </div>
                <p class="label-description" *ngIf="label.Description">{{label.Description}}</p>

                <!-- Child labels for group parents -->
                <div class="child-labels" *ngIf="IsGroupParent(label) && GetChildLabels(label.ID).length > 0">
                    <div class="child-label" *ngFor="let child of GetChildLabels(label.ID)">
                        <i class="fa-solid fa-tag child-icon"></i>
                        <span class="child-name">{{child.Name}}</span>
                        <span class="child-record" *ngIf="child.RecordID">{{child.RecordID | slice:0:12}}...</span>
                        <span class="child-items" *ngIf="child.ItemCount">{{child.ItemCount}} items</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Labels List View -->
        <div class="labels-table" *ngIf="FilteredLabels.length > 0 && ViewMode === 'list'">
            <div class="list-header-row">
                <span class="list-col-icon"></span>
                <span class="list-col-name sortable-header" (click)="OnSortChange('Name')">
                    Name <i [class]="GetSortIcon('Name')" class="sort-icon"></i>
                </span>
                <span class="list-col-entity">Entity</span>
                <span class="list-col-status sortable-header" (click)="OnSortChange('Status')">
                    Status <i [class]="GetSortIcon('Status')" class="sort-icon"></i>
                </span>
                <span class="list-col-items sortable-header" (click)="OnSortChange('Items')">
                    Items <i [class]="GetSortIcon('Items')" class="sort-icon"></i>
                </span>
                <span class="list-col-date sortable-header" (click)="OnSortChange('Date')">
                    Created <i [class]="GetSortIcon('Date')" class="sort-icon"></i>
                </span>
                <span class="list-col-arrow"></span>
            </div>
            <div class="list-row clickable" *ngFor="let label of FilteredLabels"
                 (click)="OnLabelClick(label)">
                <span class="list-col-icon">
                    <i [class]="GetScopeIcon(label.Scope)" class="list-scope-icon"></i>
                </span>
                <span class="list-col-name">
                    <span class="list-label-name">{{label.Name}}</span>
                    <span class="list-group-badge" *ngIf="IsGroupParent(label)">
                        <i class="fa-solid fa-layer-group"></i> {{GetChildLabels(label.ID).length}}
                    </span>
                </span>
                <span class="list-col-entity">{{label.Entity ?? ResolveEntityName(label.EntityID)}}</span>
                <span class="list-col-status">
                    <span class="label-status small" [ngClass]="GetStatusClass(label.Status)">{{label.Status}}</span>
                </span>
                <span class="list-col-items">{{label.ItemCount || GetItemCount(label.ID)}}</span>
                <span class="list-col-date">{{FormatDate(label.__mj_CreatedAt)}}</span>
                <span class="list-col-arrow">
                    <i class="fa-solid fa-chevron-right list-arrow"></i>
                </span>
            </div>
        </div>

        <!-- Empty state -->
        <div class="empty-state" *ngIf="FilteredLabels.length === 0 && !IsLoading">
            <i class="fa-solid fa-tags empty-icon"></i>
            <h3>No labels found</h3>
            <p *ngIf="SearchText || ScopeFilter || StatusFilter">
                Try adjusting your filters or search criteria.
            </p>
            <p *ngIf="!SearchText && !ScopeFilter && !StatusFilter">
                No version labels have been created yet.
            </p>
            <button class="btn-primary empty-cta"
                    *ngIf="!SearchText && !ScopeFilter && !StatusFilter"
                    (click)="OpenCreateDialog()">
                <i class="fa-solid fa-plus"></i>
                <span>Create Your First Label</span>
            </button>
        </div>
    </ng-container>

    <!-- ================================================================= -->
    <!-- Create Label Dialog -->
    <!-- ================================================================= -->
    <kendo-dialog *ngIf="ShowCreateDialog"
                  [title]="'Create Version Label'"
                  [width]="640"
                  [minHeight]="480"
                  (close)="CloseCreateDialog()">

        <!-- Step indicator -->
        <div class="step-indicator" *ngIf="CreateStep !== 'creating' && CreateStep !== 'done'">
            <div class="step" [class.active]="CreateStep === 'entity'" [class.completed]="CreateStep !== 'entity'">
                <span class="step-number">1</span>
                <span class="step-label">Entity</span>
            </div>
            <div class="step-connector" [class.active]="CreateStep !== 'entity'"></div>
            <div class="step" [class.active]="CreateStep === 'records'" [class.completed]="CreateStep === 'details'">
                <span class="step-number">2</span>
                <span class="step-label">Records</span>
            </div>
            <div class="step-connector" [class.active]="CreateStep === 'details'"></div>
            <div class="step" [class.active]="CreateStep === 'details'">
                <span class="step-number">3</span>
                <span class="step-label">Details</span>
            </div>
        </div>

        <!-- Step 1: Pick Entity -->
        <div class="dialog-step" *ngIf="CreateStep === 'entity'">
            <p class="step-description">Choose an entity type to label records from.</p>
            <div class="dialog-search">
                <i class="fa-solid fa-search dialog-search-icon"></i>
                <input type="text"
                       class="dialog-search-input"
                       placeholder="Search entities..."
                       [ngModel]="EntitySearchText"
                       (ngModelChange)="OnEntitySearchChange($event)" />
            </div>
            <div class="entity-list">
                <div class="entity-option" *ngFor="let entity of FilteredEntities"
                     (click)="SelectEntity(entity)">
                    <div class="entity-option-info">
                        <span class="entity-option-name">{{entity.Name}}</span>
                        <span class="entity-option-desc" *ngIf="entity.Description">{{entity.Description | slice:0:80}}</span>
                    </div>
                    <i class="fa-solid fa-chevron-right entity-option-arrow"></i>
                </div>
                <div class="entity-list-empty" *ngIf="FilteredEntities.length === 0">
                    No entities match your search.
                </div>
            </div>
        </div>

        <!-- Step 2: Select Records -->
        <div class="dialog-step" *ngIf="CreateStep === 'records'">
            <div class="step-header-row">
                <button class="btn-back" (click)="GoBackToEntity()">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div>
                    <p class="step-description">
                        Select records from <strong>{{SelectedEntity?.Name}}</strong> to label.
                    </p>
                </div>
            </div>

            <mj-loading *ngIf="IsLoadingRecords" text="Loading records..."></mj-loading>

            <ng-container *ngIf="!IsLoadingRecords">
                <div class="records-toolbar">
                    <div class="dialog-search" style="flex: 1;">
                        <i class="fa-solid fa-search dialog-search-icon"></i>
                        <input type="text"
                               class="dialog-search-input"
                               placeholder="Search records..."
                               [ngModel]="RecordSearchText"
                               (ngModelChange)="OnRecordSearchChange($event)" />
                    </div>
                    <div class="selection-actions">
                        <button class="btn-text" (click)="SelectAllRecords()">Select All</button>
                        <button class="btn-text" (click)="DeselectAllRecords()">Clear</button>
                    </div>
                </div>

                <div class="record-list">
                    <div class="record-option" *ngFor="let record of FilteredRecords"
                         [class.selected]="record.Selected"
                         (click)="ToggleRecordSelection(record)">
                        <div class="record-checkbox">
                            <i class="fa-solid fa-check" *ngIf="record.Selected"></i>
                        </div>
                        <span class="record-name">{{record.DisplayName}}</span>
                    </div>
                    <div class="entity-list-empty" *ngIf="FilteredRecords.length === 0 && !IsLoadingRecords">
                        No records found for this entity.
                    </div>
                </div>

                <div class="records-footer">
                    <span class="selection-count">{{SelectedRecordCount}} selected</span>
                    <button class="btn-primary"
                            [disabled]="SelectedRecordCount === 0"
                            (click)="GoToDetailsStep()">
                        Continue
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </ng-container>
        </div>

        <!-- Step 3: Label Details -->
        <div class="dialog-step" *ngIf="CreateStep === 'details'">
            <div class="step-header-row">
                <button class="btn-back" (click)="GoBackToRecords()">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <p class="step-description">Name your version label.</p>
            </div>

            <div class="details-summary">
                <div class="summary-item">
                    <i class="fa-solid fa-table"></i>
                    <span>{{SelectedEntity?.Name}}</span>
                </div>
                <div class="summary-item">
                    <i class="fa-solid fa-check-double"></i>
                    <span>{{SelectedRecordCount}} record{{SelectedRecordCount > 1 ? 's' : ''}} selected</span>
                </div>
                <div class="summary-item" *ngIf="SelectedRecordCount > 1">
                    <i class="fa-solid fa-layer-group"></i>
                    <span>Will create 1 group + {{SelectedRecordCount}} child labels</span>
                </div>
            </div>

            <div class="form-field">
                <label class="form-label">Label Name</label>
                <input type="text"
                       class="form-input"
                       placeholder="e.g. Customer Support Agent v2.0"
                       [(ngModel)]="LabelName" />
            </div>

            <div class="form-field">
                <label class="form-label">Description (optional)</label>
                <textarea class="form-textarea"
                          rows="3"
                          placeholder="What does this version represent?"
                          [(ngModel)]="LabelDescription"></textarea>
            </div>

            <div class="details-footer">
                <button class="btn-primary"
                        [disabled]="!LabelName.trim()"
                        (click)="CreateLabels()">
                    <i class="fa-solid fa-tag"></i>
                    Create Label{{SelectedRecordCount > 1 ? 's' : ''}}
                </button>
                <button class="btn-secondary" (click)="CloseCreateDialog()">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Creating state -->
        <div class="dialog-step creating-step" *ngIf="CreateStep === 'creating'">
            <div class="creating-animation">
                <i class="fa-solid fa-tag fa-spin creating-icon"></i>
            </div>
            <h3 class="creating-title">Creating Labels...</h3>
            <p class="creating-progress">
                {{CreatedLabelCount}} label{{CreatedLabelCount !== 1 ? 's' : ''}} created
                <span *ngIf="CreatedItemCount > 0"> &middot; {{CreatedItemCount}} items captured</span>
            </p>
        </div>

        <!-- Done state -->
        <div class="dialog-step done-step" *ngIf="CreateStep === 'done'">
            <ng-container *ngIf="!CreateError">
                <div class="done-icon-wrap success">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h3 class="done-title">Labels Created</h3>
                <p class="done-message">
                    Successfully created {{CreatedLabelCount}} label{{CreatedLabelCount !== 1 ? 's' : ''}}
                    <span *ngIf="CreatedItemCount > 0"> with {{CreatedItemCount}} items captured</span>.
                </p>
            </ng-container>
            <ng-container *ngIf="CreateError">
                <div class="done-icon-wrap error">
                    <i class="fa-solid fa-xmark"></i>
                </div>
                <h3 class="done-title">Error</h3>
                <p class="done-message error-text">{{CreateError}}</p>
            </ng-container>
            <button class="btn-primary" (click)="FinishCreate()">Done</button>
        </div>
    </kendo-dialog>

    <!-- Detail panel -->
    <mj-label-detail-panel
        *ngIf="ShowDetailPanel && SelectedLabel"
        [Label]="SelectedLabel"
        [AllLabels]="Labels"
        [ItemCountMap]="ItemCountMap"
        (Close)="OnDetailPanelClose()"
        (LabelUpdated)="OnLabelUpdated()">
    </mj-label-detail-panel>
</div>
