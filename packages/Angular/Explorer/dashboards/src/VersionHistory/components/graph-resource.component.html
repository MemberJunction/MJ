<div class="graph-container">
    <mj-loading *ngIf="IsLoading" text="Loading dependency graph..."></mj-loading>

    <ng-container *ngIf="!IsLoading">
        <!-- Header -->
        <div class="page-header">
            <div class="header-left">
                <h2 class="page-title">Entity Dependency Graph</h2>
                <p class="page-subtitle">Explore entity relationships used by the version history system</p>
            </div>
            <div class="header-actions">
                <button class="btn-icon" (click)="Refresh()" title="Refresh">
                    <i class="fa-solid fa-refresh"></i>
                </button>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-badge">
                <i class="fa-solid fa-table"></i>
                <span>{{TotalEntities}} Entities</span>
            </div>
            <div class="stat-badge">
                <i class="fa-solid fa-diagram-project"></i>
                <span>{{EntitiesWithDependents}} with Dependents</span>
            </div>
            <div class="stat-badge">
                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                <span>{{TotalRelationships}} Relationships</span>
            </div>
        </div>

        <!-- Main Layout: Entity List + Detail -->
        <div class="graph-layout">
            <!-- Entity List -->
            <div class="entity-list-panel">
                <div class="panel-header">
                    <h3 class="panel-title">Entities</h3>
                </div>

                <div class="search-bar">
                    <i class="fa-solid fa-search search-icon"></i>
                    <input type="text"
                           class="search-input"
                           placeholder="Filter entities..."
                           [ngModel]="SearchText"
                           (ngModelChange)="OnSearchChange($event)" />
                </div>

                <div class="entity-scroll-list">
                    <div class="entity-list-item"
                         *ngFor="let entity of FilteredEntities"
                         [class.selected]="entity.IsSelected"
                         (click)="SelectEntity(entity)">
                        <div class="entity-list-name">{{entity.Name}}</div>
                        <div class="entity-list-badges">
                            <span class="dep-badge"
                                  [ngClass]="GetDependencyLevel(entity.DependentCount)"
                                  *ngIf="entity.DependentCount > 0"
                                  title="Dependent entities">
                                {{entity.DependentCount}} <i class="fa-solid fa-arrow-down"></i>
                            </span>
                            <span class="dep-badge level-parent"
                                  *ngIf="entity.ParentCount > 0"
                                  title="Parent entities">
                                {{entity.ParentCount}} <i class="fa-solid fa-arrow-up"></i>
                            </span>
                        </div>
                    </div>

                    <div class="empty-list" *ngIf="FilteredEntities.length === 0">
                        <p>No entities match your search.</p>
                    </div>
                </div>
            </div>

            <!-- Detail Panel -->
            <div class="entity-detail-panel">
                <ng-container *ngIf="SelectedEntity; else noSelection">
                    <div class="detail-header">
                        <i class="fa-solid fa-table detail-icon"></i>
                        <h3 class="detail-title">{{SelectedEntity.Name}}</h3>
                    </div>

                    <!-- Dependents (Children) -->
                    <div class="relationship-section">
                        <div class="section-header">
                            <i class="fa-solid fa-arrow-down section-icon dependents-icon"></i>
                            <h4>Dependent Entities (Children)</h4>
                            <span class="section-count">{{DependentEntities.length}}</span>
                        </div>

                        <div class="relationship-list" *ngIf="DependentEntities.length > 0">
                            <div class="relationship-item" *ngFor="let rel of DependentEntities">
                                <div class="rel-entity-name"
                                     (click)="NavigateToEntity(rel.ToEntity)">
                                    <i class="fa-solid fa-table rel-icon"></i>
                                    {{rel.ToEntity}}
                                </div>
                                <div class="rel-join-field">
                                    <i class="fa-solid fa-link"></i>
                                    {{rel.RelatedEntityJoinField}}
                                </div>
                            </div>
                        </div>

                        <div class="empty-relationships" *ngIf="DependentEntities.length === 0">
                            <p>No dependent entities.</p>
                        </div>
                    </div>

                    <!-- Parents -->
                    <div class="relationship-section">
                        <div class="section-header">
                            <i class="fa-solid fa-arrow-up section-icon parents-icon"></i>
                            <h4>Parent Entities</h4>
                            <span class="section-count">{{ParentEntities.length}}</span>
                        </div>

                        <div class="relationship-list" *ngIf="ParentEntities.length > 0">
                            <div class="relationship-item" *ngFor="let rel of ParentEntities">
                                <div class="rel-entity-name"
                                     (click)="NavigateToEntity(rel.ToEntity)">
                                    <i class="fa-solid fa-table rel-icon"></i>
                                    {{rel.ToEntity}}
                                </div>
                                <div class="rel-join-field">
                                    <i class="fa-solid fa-link"></i>
                                    {{rel.RelatedEntityJoinField}}
                                </div>
                            </div>
                        </div>

                        <div class="empty-relationships" *ngIf="ParentEntities.length === 0">
                            <p>No parent entities.</p>
                        </div>
                    </div>
                </ng-container>

                <ng-template #noSelection>
                    <div class="no-selection">
                        <i class="fa-solid fa-diagram-project no-selection-icon"></i>
                        <h3>Select an Entity</h3>
                        <p>Choose an entity from the list to explore its dependency relationships.</p>
                    </div>
                </ng-template>
            </div>
        </div>
    </ng-container>
</div>
