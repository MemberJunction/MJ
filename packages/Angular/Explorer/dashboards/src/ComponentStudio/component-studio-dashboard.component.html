<div class="component-studio">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div>
        <h1><i class="fa-solid fa-puzzle-piece"></i> Component Studio</h1>
        <p class="header-subtitle">Testing components without required custom properties</p>
      </div>
      <div class="header-buttons">
        @if (selectedComponent && isRunning) {
          <button kendoButton (click)="toggleDetailsPane()" [themeColor]="'base'">
            @if (isDetailsPaneCollapsed) {
              <span class="fa-solid fa-eye"></span> Show Details
            } @else {
              <span class="fa-solid fa-eye-slash"></span> Hide Details
            }
          </button>
        }
        <div class="import-dropdown" [class.open]="importDropdownOpen">
          <button kendoButton (click)="toggleImportDropdown()" [themeColor]="'info'">
            <span class="fa-solid fa-file-import"></span> Import
            <span class="fa-solid fa-chevron-down" style="margin-left: 5px; font-size: 10px;"></span>
          </button>
          @if (importDropdownOpen) {
            <div class="dropdown-menu">
              <button class="dropdown-item" (click)="importFromFile()">
                <i class="fa-solid fa-file"></i> Import from File
              </button>
              <button class="dropdown-item" (click)="importFromText()">
                <i class="fa-solid fa-keyboard"></i> Import from Text
              </button>
            </div>
          }
        </div>
        <button kendoButton (click)="refreshData()" [disabled]="isLoading">
          <span class="fa-solid fa-sync"></span> Refresh
        </button>
      </div>
      <!-- Hidden file input -->
      <input #fileInput type="file" accept=".json" (change)="handleFileSelect($event)" style="display: none;" />
    </div>
  </div>

  <!-- Main Content with Splitter -->
  <kendo-splitter orientation="horizontal" style="flex: 1; height: auto;">
    <!-- Left Panel - Component List -->
    <kendo-splitter-pane [min]="'350px'" [max]="'600px'" [size]="'400px'">
      <div class="components-panel">
        <div class="panel-header">
          <div class="panel-header-top">
            <h3>Components</h3>
            <span class="component-count">{{ filteredComponents.length }} of {{ allComponents.length }}</span>
          </div>
          
          <!-- Modern Category Filter Pills -->
          <div class="category-filters">
            @if (availableCategories.length > 0) {
              <div class="filter-pills">
                @for (category of getVisibleCategories(); track category.name) {
                  <button 
                    class="category-pill"
                    [class.active]="isCategorySelected(category.name)"
                    [style.--pill-color]="category.color"
                    (click)="toggleCategory(category.name)">
                    <span class="pill-name">{{ category.name }}</span>
                    <span class="pill-count">{{ category.count }}</span>
                  </button>
                }
                @if (availableCategories.length > 5) {
                  <button 
                    class="more-button"
                    (click)="toggleShowAllCategories()">
                    @if (showAllCategories) {
                      <i class="fa-solid fa-chevron-up"></i> Less
                    } @else {
                      <i class="fa-solid fa-chevron-down"></i> +{{ availableCategories.length - 5 }} more
                    }
                  </button>
                }
                @if (selectedCategories.size > 0) {
                  <button 
                    class="clear-filters-button"
                    (click)="clearCategoryFilters()">
                    <i class="fa-solid fa-times"></i> Clear
                  </button>
                }
              </div>
            }
          </div>
          
          <div class="search-box">
            <kendo-textbox 
              [value]="searchQuery"
              (valueChange)="onSearchChange($event)"
              placeholder="Search components..."
              [clearButton]="true">
              <ng-template kendoTextBoxPrefixTemplate>
                <i class="fa-solid fa-search"></i>
              </ng-template>
            </kendo-textbox>
          </div>
        </div>
        
        <div class="components-list">
          @if (isLoading) {
            <div class="loading-message">
              <i class="fa-solid fa-spinner fa-spin"></i> Loading components...
            </div>
          } @else if (filteredComponents.length === 0) {
            <div class="empty-message">
              <i class="fa-solid fa-info-circle"></i> No components found without required custom properties.
              <br>
              <small>Components with optional custom props can be tested, but not those with required props.</small>
            </div>
          } @else {
            <!-- Component Cards -->
            @for (component of filteredComponents; track getComponentId(component)) {
              <div class="component-card" 
                [class.expanded]="expandedComponent && getComponentId(expandedComponent) === getComponentId(component)"
                [class.running]="selectedComponent && getComponentId(selectedComponent) === getComponentId(component) && isRunning"
                [class.file-loaded]="isFileLoadedComponent(component)">
                
                <!-- Card Header - Always visible -->
                <div class="card-header" (click)="toggleComponentExpansion(component)">
                  <div class="card-icon" [style.color]="getComponentTypeColor(getComponentType(component))">
                    <i class="fa-solid" [ngClass]="getComponentTypeIcon(getComponentType(component))"></i>
                  </div>
                  <div class="card-info">
                    <div class="card-name">
                      {{ getComponentName(component) }}
                      @if (isFileLoadedComponent(component)) {
                        <span class="file-badge" [title]="getComponentStatus(component) === 'Text' ? 'Imported from text input' : 'Loaded from ' + getComponentFilename(component)">
                          @if (getComponentStatus(component) === 'Text') {
                            <i class="fa-solid fa-keyboard"></i> Text Import
                          } @else {
                            <i class="fa-solid fa-file"></i> {{ getComponentFilename(component) }}
                          }
                        </span>
                      }
                    </div>
                    <div class="card-meta">
                      <span class="card-type">{{ getComponentType(component) || 'Component' }}</span>
                      <span class="card-version">v{{ getComponentVersion(component) }}</span>
                      @if (isFileLoadedComponent(component)) {
                        @if (getComponentStatus(component) === 'Text') {
                          <span class="status-badge text">Text</span>
                        } @else {
                          <span class="status-badge file">File</span>
                        }
                      } @else if (getComponentStatus(component) === 'Published') {
                        <span class="status-badge published">Published</span>
                      } @else {
                        <span class="status-badge draft">Draft</span>
                      }
                    </div>
                    <!-- Namespace chip with color coding -->
                    <div class="card-namespace">
                      <span class="namespace-chip" 
                        [style.background-color]="getNamespaceColor(getComponentNamespace(component))"
                        [title]="getComponentNamespace(component) || 'Uncategorized'">
                        <i class="fa-solid fa-folder-tree"></i>
                        {{ formatNamespace(getComponentNamespace(component)) }}
                      </span>
                    </div>
                  </div>
                  <div class="card-chevron">
                    @if (expandedComponent && getComponentId(expandedComponent) === getComponentId(component)) {
                      <i class="fa-solid fa-chevron-up"></i>
                    } @else {
                      <i class="fa-solid fa-chevron-down"></i>
                    }
                  </div>
                </div>
                
                <!-- Card Details - Only visible when expanded -->
                @if (expandedComponent && getComponentId(expandedComponent) === getComponentId(component)) {
                  <div class="card-details">
                    @if (getComponentDescription(component)) {
                      <div class="detail-section">
                        <label>Description</label>
                        <p>{{ getComponentDescription(component) }}</p>
                      </div>
                    }
                    
                    <div class="detail-section">
                      <label>Component Info</label>
                      <div class="info-grid">
                        <div class="info-item">
                          <span class="info-label">Type:</span>
                          <span class="info-value">{{ getComponentType(component) || 'Unknown' }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Version:</span>
                          <span class="info-value">{{ getComponentVersion(component) }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Status:</span>
                          <span class="info-value">{{ getComponentStatus(component) || 'Draft' }}</span>
                        </div>
                        @if (isFileLoadedComponent(component)) {
                          <div class="info-item">
                            <span class="info-label">Loaded:</span>
                            <span class="info-value">{{ getComponentLoadedAt(component) | date:'short' }}</span>
                          </div>
                        } @else if (!isFileLoadedComponent(component) && getComponentUpdatedAt(component)) {
                          <div class="info-item">
                            <span class="info-label">Updated:</span>
                            <span class="info-value">{{ getComponentUpdatedAt(component) | date:'short' }}</span>
                          </div>
                        }
                      </div>
                    </div>
                    
                    <div class="card-actions">
                      @if (selectedComponent && getComponentId(selectedComponent) === getComponentId(component) && isRunning) {
                        <button kendoButton 
                          [themeColor]="'error'"
                          (click)="stopComponent(); $event.stopPropagation()">
                          <span class="fa-solid fa-stop"></span> Stop Component
                        </button>
                      } @else if (isRunning && selectedComponent && getComponentId(selectedComponent) !== getComponentId(component)) {
                        <button kendoButton 
                          [themeColor]="'base'"
                          title="Stop current component and run this one"
                          (click)="runComponent(component); $event.stopPropagation()">
                          <span class="fa-solid fa-play"></span> Switch to This Component
                        </button>
                      } @else {
                        <button kendoButton 
                          [themeColor]="'primary'"
                          (click)="runComponent(component); $event.stopPropagation()">
                          <span class="fa-solid fa-play"></span> Run Component
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    </kendo-splitter-pane>

    <!-- Right Panel - Component Display with Editor Splitter -->
    <kendo-splitter-pane [min]="'400px'">
      <div class="component-display">
        @if (selectedComponent) {
          <!-- Splitter for component and editors -->
          <kendo-splitter orientation="horizontal" class="component-editor-splitter">
            <!-- Left side - Running Component -->
            <kendo-splitter-pane [min]="'300px'" [collapsible]="false" [size]="isDetailsPaneCollapsed ? '100%' : '50%'">
              <div class="component-runtime">
                @if (isRunning && componentSpec) {
                    @if (currentError) {
                      <!-- Error Display -->
                      <div class="error-display">
                        <div class="error-container">
                          <div class="error-header">
                            <i class="fa-solid fa-exclamation-triangle"></i>
                            <h3>Component Error</h3>
                            <button class="copy-button" (click)="copyErrorToClipboard()" title="Copy error details">
                              <i class="fa-solid fa-copy"></i>
                            </button>
                          </div>
                          
                          <p class="error-intro">
                            The component could not be rendered due to the following error:
                          </p>
                          
                          <div class="error-details">
                            <strong>Error Type:</strong> {{ currentError.type }}<br>
                            <strong>Message:</strong> {{ currentError.message }}
                            @if (currentError.technicalDetails) {
                              <details class="technical-details">
                                <summary>Technical Details (click to expand)</summary>
                                <pre>{{ formatTechnicalDetails(currentError.technicalDetails) }}</pre>
                              </details>
                            }
                          </div>
                          
                          <div class="error-help">
                            <strong>What to do:</strong>
                            <ol>
                              <li>Check that the component code is valid JavaScript/React</li>
                              <li>Ensure all required dependencies are available</li>
                              <li>Review the technical details for specific error information</li>
                              <li>Contact your system administrator if the issue persists</li>
                            </ol>
                          </div>
                          
                          <div class="error-actions">
                            <button kendoButton (click)="retryComponent()">
                              <span class="fa-solid fa-rotate"></span> Retry
                            </button>
                            <button kendoButton (click)="stopComponent()" [themeColor]="'error'">
                              <span class="fa-solid fa-stop"></span> Stop
                            </button>
                          </div>
                        </div>
                      </div>
                    } @else {
                      <!-- React Component -->
                      <mj-react-component 
                        [component]="componentSpec"
                        (componentEvent)="onComponentEvent($event)"
                        (openEntityRecord)="onOpenEntityRecord($event)">
                      </mj-react-component>
                    }
                } @else {
                  <!-- Component Not Running State -->
                  <div class="run-empty-state">
                    <i class="fa-solid fa-play-circle fa-3x"></i>
                    <h3>Component: {{ getComponentName(selectedComponent) }}</h3>
                    <p>{{ getComponentDescription(selectedComponent) || 'No description available' }}</p>
                    <button kendoButton [themeColor]="'primary'" [size]="'large'" (click)="runComponent(selectedComponent)">
                      <span class="fa-solid fa-play"></span> Run Component
                    </button>
                  </div>
                }
              </div>
            </kendo-splitter-pane>
            
            <!-- Right side - Spec and Code Editors -->
            <kendo-splitter-pane [min]="'400px'" [collapsible]="true" [collapsed]="isDetailsPaneCollapsed">
              <kendo-tabstrip (tabSelect)="onTabSelect($event)" class="editor-tabs">
                <!-- Spec Tab -->
                <kendo-tabstrip-tab [title]="'Spec'" [selected]="activeTab === 0">
                  <ng-template kendoTabContent>
                    <div class="tab-content spec-tab">
                      <div class="editor-header">
                        <h4><i class="fa-solid fa-code"></i> Component Specification (JSON)</h4>
                        <div class="editor-actions">
                          @if (isEditingSpec) {
                            <button kendoButton [themeColor]="'primary'" (click)="applySpecChanges()">
                              <span class="fa-solid fa-check"></span> Apply Changes
                            </button>
                            <button kendoButton (click)="initializeEditors()">
                              <span class="fa-solid fa-times"></span> Cancel
                            </button>
                          }
                          @if (isRunning) {
                            <button kendoButton (click)="refreshComponent()" [themeColor]="'info'">
                              <span class="fa-solid fa-sync"></span> Refresh Component
                            </button>
                          }
                        </div>
                      </div>
                      <div class="editor-wrapper">
                        <mj-code-editor
                          [(ngModel)]="editableSpec"
                          (ngModelChange)="onSpecChange($event)"
                          [language]="'json'"
                          [readonly]="false"
                          style="height: 100%; width: 100%;">
                        </mj-code-editor>
                      </div>
                    </div>
                  </ng-template>
                </kendo-tabstrip-tab>
              
                <!-- Code Tab -->
                <kendo-tabstrip-tab [title]="'Code'" [selected]="activeTab === 1">
                  <ng-template kendoTabContent>
                    <div class="tab-content code-tab">
                      <div class="editor-header">
                        <h4><i class="fa-solid fa-file-code"></i> Component Code (JavaScript/React)</h4>
                        <div class="editor-actions">
                          @if (isEditingCode) {
                            <button kendoButton [themeColor]="'primary'" (click)="applyCodeChanges()">
                              <span class="fa-solid fa-check"></span> Apply Changes
                            </button>
                            <button kendoButton (click)="initializeEditors()">
                              <span class="fa-solid fa-times"></span> Cancel
                            </button>
                          }
                          @if (isRunning) {
                            <button kendoButton (click)="refreshComponent()" [themeColor]="'info'">
                              <span class="fa-solid fa-sync"></span> Refresh Component
                            </button>
                          }
                        </div>
                      </div>
                      
                      <!-- Always use panel bar for consistency and to show all components -->
                      <div class="editor-wrapper">
                        <kendo-panelbar class="code-sections">
                          @for (section of getComponentCodeSections(); track section.title; let i = $index) {
                            <kendo-panelbar-item [title]="section.title" [expanded]="section.expanded">
                              <ng-template kendoPanelBarContent>
                                <mj-code-editor
                                  [ngModel]="section.code"
                                  (ngModelChange)="onCodeSectionChange($event, i)"
                                  [language]="'javascript'"
                                  [readonly]="false"
                                  style="height: 400px; width: 100%;">
                                </mj-code-editor>
                              </ng-template>
                            </kendo-panelbar-item>
                          }
                        </kendo-panelbar>
                      </div>
                    </div>
                  </ng-template>
                </kendo-tabstrip-tab>
              </kendo-tabstrip>
            </kendo-splitter-pane>
          </kendo-splitter>
        } @else {
          <!-- Empty State when no component selected -->
          <div class="empty-state">
            <i class="fa-solid fa-rocket fa-3x"></i>
            <h2>Ready to Test Components</h2>
            <p>Select a component from the list to view its details and run it</p>
          </div>
        }
      </div>
    </kendo-splitter-pane>
  </kendo-splitter>
</div>