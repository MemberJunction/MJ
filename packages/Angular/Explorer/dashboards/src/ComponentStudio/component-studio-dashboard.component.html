<div class="component-studio">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div>
        <h1><i class="fa-solid fa-puzzle-piece"></i> Component Studio</h1>
        <p class="header-subtitle">Testing components without custom properties</p>
      </div>
      <div class="header-buttons">
        <button kendoButton (click)="triggerFileInput()" [themeColor]="'info'">
          <span class="fa-solid fa-file-import"></span> Import from File
        </button>
        <button kendoButton (click)="refreshData()" [disabled]="isLoading">
          <span class="fa-solid fa-sync"></span> Refresh
        </button>
      </div>
      <!-- Hidden file input -->
      <input #fileInput type="file" accept=".json" (change)="handleFileSelect($event)" style="display: none;" />
    </div>
  </div>

  <!-- Main Content with Splitter -->
  <kendo-splitter orientation="horizontal" style="flex: 1; height: auto;">
    <!-- Left Panel - Component List -->
    <kendo-splitter-pane [min]="'350px'" [max]="'600px'" [size]="'400px'">
      <div class="components-panel">
        <div class="panel-header">
          <h3>Components</h3>
          <div class="search-box">
            <kendo-textbox 
              [value]="searchQuery"
              (valueChange)="onSearchChange($event)"
              placeholder="Search components..."
              [clearButton]="true">
              <ng-template kendoTextBoxPrefixTemplate>
                <i class="fa-solid fa-search"></i>
              </ng-template>
            </kendo-textbox>
          </div>
        </div>
        
        <div class="components-list">
          @if (isLoading) {
            <div class="loading-message">
              <i class="fa-solid fa-spinner fa-spin"></i> Loading components...
            </div>
          } @else if (filteredComponents.length === 0) {
            <div class="empty-message">
              <i class="fa-solid fa-info-circle"></i> No components found without custom properties.
              <br>
              <small>Only components that don't require custom props can be tested here.</small>
            </div>
          } @else {
            @for (component of filteredComponents; track getComponentId(component)) {
              <div class="component-card" 
                [class.expanded]="expandedComponent && getComponentId(expandedComponent) === getComponentId(component)"
                [class.running]="selectedComponent && getComponentId(selectedComponent) === getComponentId(component) && isRunning"
                [class.file-loaded]="isFileLoadedComponent(component)">
                
                <!-- Card Header - Always visible -->
                <div class="card-header" (click)="toggleComponentExpansion(component)">
                  <div class="card-icon" [style.color]="getComponentTypeColor(getComponentType(component))">
                    <i class="fa-solid" [ngClass]="getComponentTypeIcon(getComponentType(component))"></i>
                  </div>
                  <div class="card-info">
                    <div class="card-name">
                      {{ getComponentName(component) }}
                      @if (isFileLoadedComponent(component)) {
                        <span class="file-badge" title="Loaded from {{ getComponentFilename(component) }}">
                          <i class="fa-solid fa-file"></i> {{ getComponentFilename(component) }}
                        </span>
                      }
                    </div>
                    <div class="card-meta">
                      <span class="card-type">{{ getComponentType(component) || 'Component' }}</span>
                      <span class="card-version">v{{ getComponentVersion(component) }}</span>
                      @if (isFileLoadedComponent(component)) {
                        <span class="status-badge file">File</span>
                      } @else if (getComponentStatus(component) === 'Published') {
                        <span class="status-badge published">Published</span>
                      } @else {
                        <span class="status-badge draft">Draft</span>
                      }
                    </div>
                  </div>
                  <div class="card-chevron">
                    @if (expandedComponent && getComponentId(expandedComponent) === getComponentId(component)) {
                      <i class="fa-solid fa-chevron-up"></i>
                    } @else {
                      <i class="fa-solid fa-chevron-down"></i>
                    }
                  </div>
                </div>
                
                <!-- Card Details - Only visible when expanded -->
                @if (expandedComponent && getComponentId(expandedComponent) === getComponentId(component)) {
                  <div class="card-details">
                    @if (getComponentDescription(component)) {
                      <div class="detail-section">
                        <label>Description</label>
                        <p>{{ getComponentDescription(component) }}</p>
                      </div>
                    }
                    
                    <div class="detail-section">
                      <label>Component Info</label>
                      <div class="info-grid">
                        <div class="info-item">
                          <span class="info-label">Type:</span>
                          <span class="info-value">{{ getComponentType(component) || 'Unknown' }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Version:</span>
                          <span class="info-value">{{ getComponentVersion(component) }}</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Status:</span>
                          <span class="info-value">{{ getComponentStatus(component) || 'Draft' }}</span>
                        </div>
                        @if (isFileLoadedComponent(component)) {
                          <div class="info-item">
                            <span class="info-label">Loaded:</span>
                            <span class="info-value">{{ getComponentLoadedAt(component) | date:'short' }}</span>
                          </div>
                        } @else if (!isFileLoadedComponent(component) && getComponentUpdatedAt(component)) {
                          <div class="info-item">
                            <span class="info-label">Updated:</span>
                            <span class="info-value">{{ getComponentUpdatedAt(component) | date:'short' }}</span>
                          </div>
                        }
                      </div>
                    </div>
                    
                    <div class="card-actions">
                      @if (selectedComponent && getComponentId(selectedComponent) === getComponentId(component) && isRunning) {
                        <button kendoButton 
                          [themeColor]="'error'"
                          (click)="stopComponent(); $event.stopPropagation()">
                          <span class="fa-solid fa-stop"></span> Stop Component
                        </button>
                      } @else if (isRunning && selectedComponent && getComponentId(selectedComponent) !== getComponentId(component)) {
                        <button kendoButton 
                          [themeColor]="'base'"
                          title="Stop current component and run this one"
                          (click)="runComponent(component); $event.stopPropagation()">
                          <span class="fa-solid fa-play"></span> Switch to This Component
                        </button>
                      } @else {
                        <button kendoButton 
                          [themeColor]="'primary'"
                          (click)="runComponent(component); $event.stopPropagation()">
                          <span class="fa-solid fa-play"></span> Run Component
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>
    </kendo-splitter-pane>

    <!-- Right Panel - Component Display -->
    <kendo-splitter-pane [min]="'400px'">
      <div class="component-display">
        @if (isRunning && selectedComponent && componentSpec) {
          @if (currentError) {
            <!-- Error Display -->
            <div class="error-display">
              <div class="error-container">
                <div class="error-header">
                  <i class="fa-solid fa-exclamation-triangle"></i>
                  <h3>Component Error</h3>
                  <button class="copy-button" (click)="copyErrorToClipboard()" title="Copy error details">
                    <i class="fa-solid fa-copy"></i>
                  </button>
                </div>
                
                <p class="error-intro">
                  The component could not be rendered due to the following error:
                </p>
                
                <div class="error-details">
                  <strong>Error Type:</strong> {{ currentError.type }}<br>
                  <strong>Message:</strong> {{ currentError.message }}
                  @if (currentError.technicalDetails) {
                    <details class="technical-details">
                      <summary>Technical Details (click to expand)</summary>
                      <pre>{{ formatTechnicalDetails(currentError.technicalDetails) }}</pre>
                    </details>
                  }
                </div>
                
                <div class="error-help">
                  <strong>What to do:</strong>
                  <ol>
                    <li>Check that the component code is valid JavaScript/React</li>
                    <li>Ensure all required dependencies are available</li>
                    <li>Review the technical details for specific error information</li>
                    <li>Contact your system administrator if the issue persists</li>
                  </ol>
                </div>
                
                <div class="error-actions">
                  <button kendoButton (click)="retryComponent()">
                    <span class="fa-solid fa-rotate"></span> Retry
                  </button>
                  <button kendoButton (click)="stopComponent()" [themeColor]="'error'">
                    <span class="fa-solid fa-stop"></span> Stop
                  </button>
                </div>
              </div>
            </div>
          } @else {
            <!-- React Component -->
            <mj-react-component 
              [component]="componentSpec"
              (componentEvent)="onComponentEvent($event)"
              (openEntityRecord)="onOpenEntityRecord($event)">
            </mj-react-component>
          }
        } @else {
          <!-- Empty State -->
          <div class="empty-state">
            <i class="fa-solid fa-rocket fa-3x"></i>
            <h2>Ready to Test Components</h2>
            <p>Select a component from the list and click "Run Component" to see it in action</p>
          </div>
        }
      </div>
    </kendo-splitter-pane>
  </kendo-splitter>
</div>