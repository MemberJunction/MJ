<div class="component-studio" kendoDialogContainer>
  <!-- Compact Toolbar (no redundant title - the nav tab already says "Component Studio") -->
  <div class="studio-toolbar">
    <div class="toolbar-left">
      @if (state.SelectedComponent && state.IsRunning) {
        <span class="component-name">
          <i class="fa-solid fa-circle running-dot"></i>
          {{ state.GetComponentName(state.SelectedComponent) }}
        </span>
      }
      @if (state.SelectedComponent && state.HasUnsavedChanges) {
        <span class="unsaved-indicator" title="Unsaved changes">
          <i class="fa-solid fa-circle"></i>
        </span>
      }
    </div>
    <div class="toolbar-actions">
      <!-- Save Version -->
      @if (state.SelectedComponent) {
        <button kendoButton (click)="SaveVersion()" [themeColor]="'primary'"
                [title]="'Save version (Ctrl+S)'" class="save-btn">
          <span class="fa-solid fa-save"></span> Save Version
          @if (state.HasUnsavedChanges) {
            <span class="unsaved-dot"></span>
          }
        </button>
      }

      <!-- Export (only when running) -->
      @if (state.SelectedComponent && state.IsRunning) {
        <div class="header-dropdown" [class.open]="exportDropdownOpen">
          <button kendoButton (click)="ToggleExportDropdown()" [themeColor]="'base'">
            <span class="fa-solid fa-file-export"></span> Export
            <span class="fa-solid fa-chevron-down dropdown-chevron"></span>
          </button>
          @if (exportDropdownOpen) {
            <div class="dropdown-menu">
              <button class="dropdown-item" (click)="ExportToArtifact()">
                <i class="fa-solid fa-save"></i> To Artifact
              </button>
              <button class="dropdown-item" (click)="ExportToFile()">
                <i class="fa-solid fa-file"></i> To File
              </button>
              <button class="dropdown-item" (click)="ExportToClipboard()">
                <i class="fa-solid fa-clipboard"></i> To Clipboard
              </button>
            </div>
          }
        </div>
      }

      <!-- AI Panel Toggle -->
      <button kendoButton (click)="ToggleAIPanel()" [themeColor]="'base'"
              [title]="state.IsAIPanelCollapsed ? 'Show AI Assistant' : 'Hide AI Assistant'">
        <span class="fa-solid fa-robot"></span>
        @if (state.IsAIPanelCollapsed) {
          <span>AI</span>
        }
      </button>

      <!-- Refresh -->
      <button kendoButton (click)="RefreshData()" [disabled]="state.IsLoading" [themeColor]="'base'">
        <span class="fa-solid fa-sync"></span>
      </button>
    </div>
    <!-- Hidden file input -->
    <input #fileInput type="file" accept=".json" (change)="HandleFileSelect($event)" style="display: none;" />
  </div>

  <!-- Three-Panel Layout -->
  <div class="studio-body">
    <!-- Left Panel: Component Browser -->
    <div class="panel panel-left" [style.width.px]="leftPanelWidth">
      <mj-component-browser
        (NewComponent)="OnNewComponent()"
        (ImportFile)="ImportFromFile()"
        (ImportText)="ImportFromText()"
        (ImportArtifact)="ImportFromArtifact()">
      </mj-component-browser>
    </div>

    <!-- Resize Handle: Left ↔ Center -->
    <div class="resize-handle" (mousedown)="OnLeftResizeStart($event)">
      <div class="handle-grip"></div>
    </div>

    <!-- Center Panel: Workspace -->
    <div class="panel panel-center">
      @if (state.SelectedComponent) {
        <!-- Preview (top) -->
        <div class="workspace-preview" [style.flex]="previewFlex">
          <mj-component-preview
            (AskAIToFix)="OnAskAIToFix($event)">
          </mj-component-preview>
        </div>

        <!-- Resize Handle: Preview ↔ Editors -->
        <div class="resize-handle horizontal" (mousedown)="OnVerticalResizeStart($event)">
          <div class="handle-grip horizontal"></div>
        </div>

        <!-- Editor Tabs (bottom) -->
        <div class="workspace-editors" [style.flex]="editorFlex">
          <mj-editor-tabs></mj-editor-tabs>
        </div>
      } @else {
        <!-- Empty State -->
        <div class="empty-state">
          <div class="empty-state-content">
            <i class="fa-solid fa-rocket fa-4x"></i>
            <h2>Ready to Build</h2>
            <p>Select a component from the browser or create a new one to get started</p>
            <div class="empty-state-actions">
              <button kendoButton [themeColor]="'primary'" (click)="OnNewComponent()">
                <span class="fa-solid fa-plus"></span> New Component
              </button>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Resize Handle: Center ↔ Right -->
    @if (!state.IsAIPanelCollapsed) {
      <div class="resize-handle" (mousedown)="OnRightResizeStart($event)">
        <div class="handle-grip"></div>
      </div>
    }

    <!-- Right Panel: AI Assistant -->
    @if (!state.IsAIPanelCollapsed) {
      <div class="panel panel-right" [style.width.px]="rightPanelWidth">
        <mj-ai-assistant-panel></mj-ai-assistant-panel>
      </div>
    }
  </div>
</div>
