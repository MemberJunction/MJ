<!-- Dashboard Browser Resource -->
<div class="dashboard-browser">
    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="isLoading">
        <mj-loading text="Loading dashboards..."></mj-loading>
    </div>

    <!-- List Mode -->
    <ng-container *ngIf="mode === 'list'">
        <!-- Header -->
        <div class="browser-header">
            <div class="header-left">
                <h2>
                    <i class="fa-solid fa-gauge-high"></i>
                    Dashboards
                </h2>
                <span class="dashboard-count">{{ filteredDashboards.length }} dashboards</span>
            </div>
            <div class="header-right">
                <button class="btn-primary" (click)="createDashboard()">
                    <i class="fa-solid fa-plus"></i>
                    New Dashboard
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="browser-filters">
            <div class="search-box">
                <i class="fa-solid fa-search"></i>
                <input
                    type="text"
                    [(ngModel)]="searchText"
                    (input)="onSearchChange()"
                    placeholder="Search dashboards...">
                <button
                    class="clear-btn"
                    *ngIf="searchText"
                    (click)="searchText = ''; onSearchChange()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="category-filter" *ngIf="categories.length > 0">
                <select [(ngModel)]="selectedCategoryId" (change)="onCategoryChange(selectedCategoryId)">
                    <option [ngValue]="null">All Categories</option>
                    <option *ngFor="let cat of categories" [ngValue]="cat.ID">
                        {{ cat.Name }}
                    </option>
                </select>
            </div>

            <button
                class="clear-filters-btn"
                *ngIf="searchText || selectedCategoryId"
                (click)="clearFilters()">
                <i class="fa-solid fa-filter-circle-xmark"></i>
                Clear Filters
            </button>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid" *ngIf="filteredDashboards.length > 0">
            <div
                *ngFor="let dashboard of filteredDashboards"
                class="dashboard-card"
                (click)="openDashboard(dashboard)">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <div class="card-actions">
                        <button
                            class="action-btn"
                            title="Edit"
                            (click)="editDashboard(dashboard); $event.stopPropagation()">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button
                            class="action-btn danger"
                            title="Delete"
                            (click)="deleteDashboard(dashboard, $event)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <h3 class="card-title">{{ dashboard.Name }}</h3>
                    <p class="card-description" *ngIf="dashboard.Description">
                        {{ dashboard.Description }}
                    </p>
                    <div class="card-meta">
                        <span class="meta-item">
                            <i class="fa-solid fa-folder"></i>
                            {{ getCategoryName(dashboard.CategoryID) }}
                        </span>
                        <span class="meta-item">
                            <i class="fa-solid fa-clock"></i>
                            {{ formatDate(dashboard.__mj_UpdatedAt) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredDashboards.length === 0 && !isLoading">
            <div class="empty-icon">
                <i class="fa-solid fa-chart-pie"></i>
            </div>
            <h3 *ngIf="dashboards.length === 0">No dashboards yet</h3>
            <h3 *ngIf="dashboards.length > 0">No matching dashboards</h3>
            <p *ngIf="dashboards.length === 0">
                Create your first dashboard to visualize and monitor your data.
            </p>
            <p *ngIf="dashboards.length > 0">
                Try adjusting your search or filters.
            </p>
            <button
                class="btn-primary"
                *ngIf="dashboards.length === 0"
                (click)="createDashboard()">
                <i class="fa-solid fa-plus"></i>
                Create Dashboard
            </button>
            <button
                class="btn-secondary"
                *ngIf="dashboards.length > 0"
                (click)="clearFilters()">
                <i class="fa-solid fa-filter-circle-xmark"></i>
                Clear Filters
            </button>
        </div>
    </ng-container>

    <!-- View/Edit Mode -->
    <ng-container *ngIf="mode === 'view' || mode === 'edit'">
        <!-- Viewer Header -->
        <div class="viewer-header" [class.editing]="mode === 'edit'">
            <div class="header-left">
                <!-- Back button only in view mode -->
                <button class="back-btn" *ngIf="mode === 'view'" (click)="backToList()">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>

                <!-- Edit mode: Add Part button on the left -->
                <button
                    class="btn-add-part"
                    *ngIf="mode === 'edit'"
                    (click)="openAddPartDialog()">
                    <i class="fa-solid fa-plus"></i>
                    Add Part
                </button>

                <!-- Separator in edit mode -->
                <div class="header-separator" *ngIf="mode === 'edit'"></div>

                <!-- View mode: static title -->
                <h2 *ngIf="mode === 'view'">{{ selectedDashboard?.Name }}</h2>

                <!-- Edit mode: editable name/description (compact inline style) -->
                <div class="dashboard-info-edit" *ngIf="mode === 'edit'">
                    <input
                        type="text"
                        class="dashboard-name-input"
                        [(ngModel)]="editingName"
                        placeholder="Dashboard name"
                        (blur)="onNameBlur()">
                    <input
                        type="text"
                        class="dashboard-description-input"
                        [(ngModel)]="editingDescription"
                        placeholder="Add a description...">
                </div>
            </div>
            <div class="header-right">
                <!-- View mode: Edit button -->
                <button
                    class="btn-icon"
                    *ngIf="mode === 'view'"
                    title="Edit Dashboard"
                    (click)="toggleEditMode()">
                    <i class="fa-solid fa-edit"></i>
                </button>

                <!-- Edit mode: Save, Cancel buttons -->
                <ng-container *ngIf="mode === 'edit'">
                    <button
                        class="btn-primary"
                        (click)="saveDashboard()">
                        <i class="fa-solid fa-save"></i>
                        Save
                    </button>
                    <button
                        class="btn-cancel"
                        (click)="cancelEdit()">
                        Cancel
                    </button>
                </ng-container>
            </div>
        </div>

        <!-- Dashboard Viewer -->
        <div class="viewer-content">
            <mj-dashboard-viewer
                #dashboardViewer
                [dashboard]="selectedDashboard"
                [isEditing]="mode === 'edit'"
                [showToolbar]="false"
                (panelInteraction)="onPanelInteraction($event)"
                (navigationRequested)="onNavigationRequested($event)">
            </mj-dashboard-viewer>
        </div>

        <!-- Add Panel Dialog -->
        <mj-add-panel-dialog
            *ngIf="dashboardViewer"
            [visible]="showAddPanelDialog"
            [partTypes]="dashboardViewer.getPartTypes()"
            (panelAdded)="onPanelAdded($event)"
            (cancelled)="onAddPanelCancelled()">
        </mj-add-panel-dialog>

        <!-- Generic Edit Part Dialog - dynamically loads config panels via ClassFactory -->
        <mj-edit-part-dialog
            [Visible]="showConfigDialog"
            [PartType]="configDialogPartType"
            [Panel]="configDialogPanel"
            [Config]="configDialogPanel?.config || null"
            (Saved)="onConfigDialogSaved($event)"
            (Cancelled)="onConfigDialogCancelled()">
        </mj-edit-part-dialog>

        <!-- Remove Part Confirmation Dialog -->
        <mj-confirm-dialog
            [visible]="showConfirmDialog"
            type="danger"
            title="Remove Part"
            [message]="'Are you sure you want to remove \'' + confirmPanelTitle + '\' from this dashboard?'"
            confirmText="Remove"
            cancelText="Cancel"
            (confirmed)="onRemoveConfirmed()"
            (cancelled)="onRemoveCancelled()">
        </mj-confirm-dialog>
    </ng-container>

    <!-- Delete Dashboard Confirmation Dialog -->
    <mj-confirm-dialog
        [visible]="showDeleteDashboardConfirm"
        type="danger"
        title="Delete Dashboard"
        [message]="'Are you sure you want to delete \'' + (dashboardToDelete?.Name || '') + '\'? This action cannot be undone.'"
        confirmText="Delete"
        cancelText="Cancel"
        (confirmed)="confirmDeleteDashboard()"
        (cancelled)="cancelDeleteDashboard()">
    </mj-confirm-dialog>
</div>
