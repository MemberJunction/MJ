<!-- Slide-out Backdrop -->
@if (Visible) {
  <div class="slideout-backdrop" (click)="close()"></div>
}

<!-- Slide-out Panel -->
<div class="slideout-panel" [class.open]="Visible">
  <!-- Header -->
  <div class="slideout-header">
    <div class="slideout-title">
      <i class="fa-solid fa-key"></i>
      <span>API Key Details</span>
      <span class="key-status" [class.active]="APIKey?.Status === 'Active'"
        [class.revoked]="APIKey?.Status === 'Revoked'">
        {{APIKey?.Status}}
      </span>
    </div>
    <button class="slideout-close" (click)="close()" title="Close (Esc)">
      <i class="fa-solid fa-times"></i>
    </button>
  </div>

  @if (IsLoading) {
    <mj-loading text="Loading key details..."></mj-loading>
  }

  @if (!IsLoading && APIKey) {
    <!-- Success/Error Messages -->
    @if (SuccessMessage) {
      <div class="message success">
        <i class="fa-solid fa-check-circle"></i>
        {{SuccessMessage}}
      </div>
    }
    @if (ErrorMessage) {
      <div class="message error">
        <i class="fa-solid fa-circle-exclamation"></i>
        {{ErrorMessage}}
      </div>
    }
    <!-- Tabs -->
    <div class="slideout-tabs">
      <button class="slideout-tab" [class.active]="ActiveTab === 'details'"
        (click)="ActiveTab = 'details'">
        <i class="fa-solid fa-info-circle"></i>
        Details
      </button>
      <button class="slideout-tab" [class.active]="ActiveTab === 'scopes'"
        (click)="ActiveTab = 'scopes'">
        <i class="fa-solid fa-shield-halved"></i>
        Permissions
        @if (HasScopeChanges) {
          <span class="tab-badge unsaved">!</span>
        }
      </button>
      <button class="slideout-tab" [class.active]="ActiveTab === 'usage'"
        (click)="ActiveTab = 'usage'">
        <i class="fa-solid fa-chart-line"></i>
        Usage
      </button>
    </div>
    <div class="slideout-content">
      <!-- Details Tab -->
      @if (ActiveTab === 'details') {
        <div class="tab-panel">
          <div class="key-info-card">
            <div class="info-header">
              <div class="info-row">
                <span class="info-label">Key Hash</span>
                <code class="hash-value">{{APIKey.Hash}}</code>
              </div>
            </div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Created</span>
                <span class="info-value">{{formatDate(APIKey.__mj_CreatedAt)}}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Created By</span>
                <span class="info-value">{{APIKey.CreatedByUser}}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Owner</span>
                <span class="info-value">{{APIKey.User}}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Last Used</span>
                <span class="info-value" [class.never-used]="!APIKey.LastUsedAt">
                  {{APIKey.LastUsedAt ? formatDate(APIKey.LastUsedAt) : 'Never'}}
                </span>
              </div>
            </div>
          </div>
          <!-- Editable Fields -->
          <div class="edit-section">
            <div class="section-header">
              <h4>Key Configuration</h4>
              @if (APIKey.Status === 'Active') {
                <button class="edit-toggle"
                  (click)="toggleEdit()">
                  <i class="fa-solid" [class.fa-pencil]="!IsEditing" [class.fa-times]="IsEditing"></i>
                  {{IsEditing ? 'Cancel' : 'Edit'}}
                </button>
              }
            </div>
            <div class="form-field">
              <label>Label</label>
              <input kendoTextBox [(ngModel)]="EditLabel"
                [disabled]="!IsEditing"
                class="form-input" />
            </div>
            <div class="form-field">
              <label>Description</label>
              <textarea kendoTextArea [(ngModel)]="EditDescription"
                [disabled]="!IsEditing"
                [rows]="3"
              class="form-textarea"></textarea>
            </div>
            <div class="form-field">
              <label>Expiration</label>
              <div class="expiration-field">
                <kendo-datepicker [(ngModel)]="EditExpiresAt"
                  [disabled]="!IsEditing"
                  [min]="getMinDate()"
                  format="MMM d, yyyy"
                  placeholder="Never expires">
                </kendo-datepicker>
                @if (IsEditing && EditExpiresAt) {
                  <button class="clear-btn"
                    (click)="EditExpiresAt = null">
                    <i class="fa-solid fa-times"></i>
                    Never expires
                  </button>
                }
              </div>
            </div>
            @if (IsEditing) {
              <div class="edit-actions">
                <button kendoButton [themeColor]="'primary'"
                  [disabled]="IsSaving"
                  (click)="saveChanges()">
                  @if (IsSaving) {
                    <mj-loading [showText]="false" size="small"></mj-loading>
                  }
                  @if (!IsSaving) {
                    <span>
                      <i class="fa-solid fa-save"></i>
                      Save Changes
                    </span>
                  }
                </button>
              </div>
            }
          </div>
          <!-- Revoke Section -->
          @if (APIKey.Status === 'Active') {
            <div class="danger-zone">
              <h4>Danger Zone</h4>
              @if (!ShowRevokeConfirm) {
                <div class="revoke-section">
                  <div class="revoke-info">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <div>
                      <strong>Revoke this API key</strong>
                      <p>Once revoked, this key will immediately stop working. This action cannot be undone.</p>
                    </div>
                  </div>
                  <button class="revoke-btn" (click)="startRevoke()">
                    <i class="fa-solid fa-ban"></i>
                    Revoke Key
                  </button>
                </div>
              }
              @if (ShowRevokeConfirm) {
                <div class="revoke-confirm">
                  <div class="confirm-warning">
                    <i class="fa-solid fa-skull-crossbones"></i>
                    <div>
                      <strong>Are you absolutely sure?</strong>
                      <p>This will permanently revoke the API key. Any applications using this key will immediately lose access.</p>
                    </div>
                  </div>
                  <div class="confirm-input">
                    <label>Type <code>REVOKE</code> to confirm:</label>
                    <input kendoTextBox [(ngModel)]="RevokeConfirmText"
                      placeholder="REVOKE" />
                  </div>
                  <div class="confirm-actions">
                    <button kendoButton (click)="cancelRevoke()">Cancel</button>
                    <button class="confirm-revoke-btn"
                      [disabled]="RevokeConfirmText !== 'REVOKE' || IsRevoking"
                      (click)="confirmRevoke()">
                      @if (IsRevoking) {
                        <mj-loading [showText]="false" size="small"></mj-loading>
                      }
                      @if (!IsRevoking) {
                        <span>
                          <i class="fa-solid fa-ban"></i>
                          Revoke Key
                        </span>
                      }
                    </button>
                  </div>
                </div>
              }
            </div>
          }
          <!-- Revoked Notice -->
          @if (APIKey.Status === 'Revoked') {
            <div class="revoked-notice">
              <i class="fa-solid fa-ban"></i>
              <div>
                <strong>This API key has been revoked</strong>
                <p>It can no longer be used for authentication. Consider deleting this record if no longer needed.</p>
              </div>
            </div>
          }
        </div>
      }
      <!-- Scopes Tab -->
      @if (ActiveTab === 'scopes') {
        <div class="tab-panel scopes-panel">
          <div class="scopes-header">
            <div class="scopes-info">
              <span class="scope-count">{{getAssignedScopeCount()}} permissions assigned</span>
            </div>
            @if (HasScopeChanges && APIKey.Status === 'Active') {
              <button kendoButton [themeColor]="'primary'"
                [disabled]="IsSaving"
                (click)="saveScopeChanges()">
                @if (IsSaving) {
                  <mj-loading [showText]="false" size="small"></mj-loading>
                }
                @if (!IsSaving) {
                  <span>
                    <i class="fa-solid fa-save"></i>
                    Save Changes
                  </span>
                }
              </button>
            }
          </div>
          <!-- No Scopes Warning -->
          @if (!IsLoadingScopes && getAssignedScopeCount() === 0 && APIKey.Status === 'Active') {
            <div class="no-scopes-warning">
              <i class="fa-solid fa-triangle-exclamation"></i>
              <div>
                <strong>Warning: No permissions assigned</strong>
                <p>This API key has no assigned scopes and cannot perform any operations. All API requests using this key will be rejected until scopes are assigned.</p>
              </div>
            </div>
          }
          @if (IsLoadingScopes) {
            <mj-loading text="Loading permissions..."></mj-loading>
          }
          @if (!IsLoadingScopes) {
            <div class="scope-categories">
              @for (category of ScopeCategories; track category) {
                <div class="scope-category">
                  <div class="category-header" (click)="toggleCategory(category)">
                    <div class="category-left">
                      <i [class]="category.icon" [style.color]="category.color"></i>
                      <span class="category-name">{{category.name}}</span>
                      <span class="category-count">
                        {{getSelectedCount(category)}}/{{category.scopes.length}}
                      </span>
                    </div>
                    <div class="category-right">
                      @if (APIKey.Status === 'Active') {
                        <label class="category-all-toggle"
                          (click)="$event.stopPropagation()"
                          >
                          <input type="checkbox" kendoCheckBox
                            [checked]="category.allSelected"
                            (change)="toggleCategoryAll(category)" />
                          <span>All</span>
                        </label>
                      }
                      <i class="fa-solid expand-icon" [class.fa-chevron-down]="!category.expanded"
                      [class.fa-chevron-up]="category.expanded"></i>
                    </div>
                  </div>
                  @if (category.expanded) {
                    <div class="category-scopes">
                      @for (item of category.scopes; track item) {
                        <div class="scope-item">
                          <label class="scope-label">
                            <input type="checkbox" kendoCheckBox
                              [(ngModel)]="item.selected"
                              [disabled]="APIKey.Status === 'Revoked'"
                              (change)="onScopeChange()" />
                            <div class="scope-info">
                              <span class="scope-name">{{item.scope.Name}}</span>
                              @if (item.scope.Description) {
                                <span class="scope-desc">
                                  {{item.scope.Description}}
                                </span>
                              }
                            </div>
                          </label>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
      <!-- Usage Tab -->
      @if (ActiveTab === 'usage') {
        <div class="tab-panel usage-panel">
          @if (IsLoadingLogs) {
            <mj-loading text="Loading usage logs..."></mj-loading>
          }
          @if (!IsLoadingLogs) {
            <div class="usage-content">
              <div class="usage-stats">
                <div class="stat-card">
                  <i class="fa-solid fa-chart-line"></i>
                  <div class="stat-value">{{UsageLogs.length}}</div>
                  <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                  <i class="fa-solid fa-clock"></i>
                  <div class="stat-value">
                    {{UsageLogs.length > 0 ? formatRelativeTime(UsageLogs[0].timestamp) : 'Never'}}
                  </div>
                  <div class="stat-label">Last Used</div>
                </div>
              </div>
              @if (UsageLogs.length > 0) {
                <div class="usage-logs">
                  <div class="log-header">
                    <span class="col-time">Time</span>
                    <span class="col-endpoint">Endpoint</span>
                    <span class="col-status">Status</span>
                    <span class="col-duration">Duration</span>
                  </div>
                  @for (log of UsageLogs; track log) {
                    <div class="log-item">
                      <span class="col-time">{{formatRelativeTime(log.timestamp)}}</span>
                      <span class="col-endpoint">
                        <span class="method-badge">{{log.method}}</span>
                        {{log.endpoint}}
                      </span>
                      <span class="col-status" [ngClass]="getStatusClass(log.statusCode)">
                        {{log.statusCode}}
                      </span>
                      <span class="col-duration">{{log.responseTime}}ms</span>
                    </div>
                  }
                </div>
              }
              @if (UsageLogs.length === 0) {
                <div class="empty-state">
                  <i class="fa-solid fa-chart-area"></i>
                  <span>No usage logs yet</span>
                  <p>Usage will be recorded when this API key is used for authentication</p>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
    <!-- Footer -->
    <div class="slideout-footer">
      <button kendoButton (click)="close()">Close</button>
    </div>
  }
</div>
