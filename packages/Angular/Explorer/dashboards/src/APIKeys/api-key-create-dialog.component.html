<!-- Slide-out Backdrop -->
@if (Visible) {
  <div class="slideout-backdrop" (click)="Step !== 'success' ? close() : null"></div>
}

<!-- Slide-out Panel -->
<div class="slideout-panel" [class.open]="Visible">
  <!-- Header -->
  <div class="slideout-header">
    <div class="slideout-title">
      <i class="fa-solid fa-key"></i>
      <span>Generate New API Key</span>
    </div>
    @if (Step !== 'success') {
      <button class="slideout-close" (click)="close()" title="Close (Esc)">
        <i class="fa-solid fa-times"></i>
      </button>
    }
  </div>

  <!-- Step Indicator -->
  @if (Step !== 'success') {
    <div class="step-indicator">
      <div class="step" [class.active]="Step === 'configure'" [class.completed]="Step === 'scopes'">
        <div class="step-number">1</div>
        <div class="step-label">Configure</div>
      </div>
      <div class="step-connector" [class.active]="Step === 'scopes'"></div>
      <div class="step" [class.active]="Step === 'scopes'">
        <div class="step-number">2</div>
        <div class="step-label">Permissions</div>
      </div>
    </div>
  }

  <div class="slideout-content">
    <!-- Configure Step -->
    @if (Step === 'configure') {
      <div class="step-panel">
        <div class="form-section">
          <label class="form-label required">Key Label</label>
          <input kendoTextBox [(ngModel)]="Label"
            placeholder="e.g., ElevenLabs Integration, CI/CD Pipeline"
            class="form-input" />
          <div class="form-hint">A memorable name to identify this key's purpose</div>
        </div>
        <div class="form-section">
          <label class="form-label">Description</label>
          <textarea kendoTextArea [(ngModel)]="Description"
            placeholder="Optional notes about how this key will be used..."
            [rows]="3"
          class="form-textarea"></textarea>
        </div>
        <div class="form-section">
          <label class="form-label">Expiration</label>
          <div class="expiration-options">
            <label class="checkbox-label">
              <input type="checkbox" kendoCheckBox
                [(ngModel)]="NeverExpires"
                (change)="onNeverExpiresChange()" />
              <span>Never expires</span>
            </label>
            @if (!NeverExpires) {
              <div class="preset-buttons">
                @for (preset of ExpirationPresets; track preset) {
                  <button
                    class="preset-btn"
                    [class.active]="SelectedPreset === preset"
                    (click)="onPresetSelect(preset)">
                    {{preset.label}}
                  </button>
                }
              </div>
            }
            @if (!NeverExpires && SelectedPreset?.days === -1) {
              <div class="custom-date">
                <kendo-datepicker [(ngModel)]="ExpiresAt"
                  [min]="getMinDate()"
                  format="MMM d, yyyy"
                  placeholder="Select expiration date">
                </kendo-datepicker>
              </div>
            }
            @if (!NeverExpires && ExpiresAt) {
              <div class="expiration-preview">
                <i class="fa-solid fa-calendar-check"></i>
                <span>Key will expire on {{ExpiresAt | date:'MMMM d, yyyy'}}</span>
              </div>
            }
          </div>
        </div>
        @if (Error) {
          <div class="error-message">
            <i class="fa-solid fa-circle-exclamation"></i>
            {{Error}}
          </div>
        }
      </div>
    }

    <!-- Scopes Step -->
    @if (Step === 'scopes') {
      <div class="step-panel scopes-step">
        <div class="scopes-header">
          <div class="scopes-info">
            <h4>Select Permission Scopes</h4>
            <p>Choose what this API key can access. You can always modify this later.</p>
          </div>
          @if (getSelectedScopeCount() > 0) {
            <div class="scopes-count">
              <span class="count">{{getSelectedScopeCount()}}</span> selected
            </div>
          }
        </div>
        @if (IsLoadingScopes) {
          <mj-loading text="Loading scopes..."></mj-loading>
        }
        @if (!IsLoadingScopes) {
          <div class="scope-categories">
            @for (category of ScopeCategories; track category) {
              <div class="scope-category">
                <div class="category-header" (click)="toggleCategory(category)">
                  <div class="category-left">
                    <i [class]="category.icon" [style.color]="category.color"></i>
                    <span class="category-name">{{category.name}}</span>
                    <span class="category-badge">{{category.scopes.length}}</span>
                  </div>
                  <div class="category-right">
                    <label class="select-all-label" (click)="$event.stopPropagation()">
                      <input type="checkbox" kendoCheckBox
                        [checked]="category.allSelected"
                        (change)="toggleCategoryAll(category)" />
                      <span>All</span>
                    </label>
                    <i class="fa-solid" [class.fa-chevron-down]="!category.expanded"
                    [class.fa-chevron-up]="category.expanded"></i>
                  </div>
                </div>
                @if (category.expanded) {
                  <div class="category-scopes">
                    @for (item of category.scopes; track item) {
                      <div class="scope-item">
                        <label class="scope-label">
                          <input type="checkbox" kendoCheckBox
                            [(ngModel)]="item.selected"
                            (change)="updateCategoryState(category)" />
                          <div class="scope-info">
                            <span class="scope-name">{{item.scope.Name}}</span>
                            @if (item.scope.Description) {
                              <span class="scope-desc">
                                {{item.scope.Description}}
                              </span>
                            }
                          </div>
                        </label>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
        <div class="scope-tip">
          <i class="fa-solid fa-lightbulb"></i>
          <span>Tip: Use wildcards like <code>entities:*</code> for broad access within a category</span>
        </div>
        <!-- No Scopes Warning -->
        @if (!IsLoadingScopes && getSelectedScopeCount() === 0) {
          <div class="no-scopes-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <div>
              <strong>Warning: No permissions selected</strong>
              <p>API keys without any assigned scopes will have <strong>no permissions</strong> and cannot perform any operations. This key will be rejected by all API endpoints until scopes are assigned.</p>
            </div>
          </div>
        }
      </div>
    }

    <!-- Success Step -->
    @if (Step === 'success') {
      <div class="step-panel success-step">
        <div class="success-icon">
          <i class="fa-solid fa-check-circle"></i>
        </div>
        <h3 class="success-title">API Key Created Successfully!</h3>
        <div class="key-display">
          <div class="key-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>Copy this key now. It won't be shown again!</span>
          </div>
          <div class="key-value">
            <code>{{RawApiKey}}</code>
            <button class="copy-btn" (click)="copyKey()" [class.copied]="KeyCopied">
              <i class="fa-solid" [class.fa-copy]="!KeyCopied" [class.fa-check]="KeyCopied"></i>
              <span>{{KeyCopied ? 'Copied!' : 'Copy'}}</span>
            </button>
          </div>
        </div>
        <div class="key-details">
          <div class="detail-row">
            <span class="detail-label">Label:</span>
            <span class="detail-value">{{Label}}</span>
          </div>
          @if (Description) {
            <div class="detail-row">
              <span class="detail-label">Description:</span>
              <span class="detail-value">{{Description}}</span>
            </div>
          }
          <div class="detail-row">
            <span class="detail-label">Expires:</span>
            <span class="detail-value">
              {{NeverExpires ? 'Never' : (ExpiresAt | date:'MMMM d, yyyy')}}
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Scopes:</span>
            <span class="detail-value">{{getSelectedScopeCount()}} permissions</span>
          </div>
        </div>
        <div class="security-note">
          <i class="fa-solid fa-shield-check"></i>
          <div>
            <strong>Security Note:</strong>
            Store this key securely. We only store a hash - the original key cannot be recovered.
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Footer -->
  <div class="slideout-footer">
    @if (Step === 'configure') {
      <button kendoButton [themeColor]="'primary'" (click)="goToScopes()">
        Next: Permissions
        <i class="fa-solid fa-arrow-right"></i>
      </button>
      <button kendoButton (click)="close()">Cancel</button>
    }

    @if (Step === 'scopes') {
      <button kendoButton [themeColor]="'primary'"
        [disabled]="IsCreating"
        (click)="createKey()">
        @if (IsCreating) {
          <mj-loading [showText]="false" size="small"></mj-loading>
        }
        @if (!IsCreating) {
          <span>
            <i class="fa-solid fa-key"></i>
            Generate Key
          </span>
        }
      </button>
      <button kendoButton (click)="goBack()">
        <i class="fa-solid fa-arrow-left"></i>
        Back
      </button>
    }

    @if (Step === 'success') {
      <button kendoButton [themeColor]="'primary'" (click)="close()">
        <i class="fa-solid fa-check"></i>
        Done
      </button>
    }
  </div>
</div>
