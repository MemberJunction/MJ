<div class="system-configuration-container">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-info">
      <h2 class="dashboard-title">
        <i class="fa-solid fa-sliders"></i>
        AI Configuration
      </h2>
      <button
        type="button"
        class="filter-toggle-btn"
        (click)="toggleFilterPanel()"
        title="Toggle Filters">
        <i class="fa-solid fa-filter"></i>
        @if (filterPanelVisible) {
          Hide Filters
        } @else {
          Show Filters
        }
      </button>
      <span class="config-count">
        {{ filteredConfigurations.length }} of {{ configurations.length }} configurations
      </span>
    </div>

    <div class="header-controls">
      <!-- View Toggle -->
      <div class="view-toggle">
        <button
          type="button"
          class="view-btn"
          [class.active]="viewMode === 'grid'"
          (click)="setViewMode('grid')"
          title="Grid View">
          <i class="fa-solid fa-grid-2"></i>
        </button>
        <button
          type="button"
          class="view-btn"
          [class.active]="viewMode === 'list'"
          (click)="setViewMode('list')"
          title="List View">
          <i class="fa-solid fa-list"></i>
        </button>
      </div>

      <button
        type="button"
        class="control-btn"
        (click)="loadData()"
        [disabled]="isLoading"
        title="Refresh">
        <i class="fa-solid fa-refresh" [class.fa-spin]="isLoading"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Main Content with Splitter -->
  <div class="main-content">
    <kendo-splitter
      class="main-splitter"
      orientation="horizontal">

      <!-- Filter Panel (Left) -->
      <kendo-splitter-pane
        [size]="filterPanelVisible ? '320px' : '0px'"
        [collapsible]="false"
        [resizable]="filterPanelVisible"
        [scrollable]="false"
        [hidden]="!filterPanelVisible">
        <mj-system-config-filter-panel
          [configurations]="configurations"
          [filteredConfigurations]="filteredConfigurations"
          [filters]="currentFilters"
          (filtersChange)="onFiltersChange($event)"
          (filterChange)="onFilterChange()"
          (resetFilters)="onResetFilters()"
          (closePanel)="toggleFilterPanel()">
        </mj-system-config-filter-panel>
      </kendo-splitter-pane>

      <!-- Configurations List Panel -->
      <kendo-splitter-pane
        [resizable]="true"
        [scrollable]="false">
        <div class="configurations-content">
          <!-- Loading State -->
          @if (isLoading) {
            <div class="loading-container">
              <mj-loading text="Loading AI configurations..." size="large"></mj-loading>
            </div>
          }

          <!-- Error State -->
          @if (error && !isLoading) {
            <div class="error-container">
              <p class="error-message">
                <i class="fa-solid fa-exclamation-triangle"></i>
                {{ error }}
              </p>
            </div>
          }

          <!-- Configurations Content -->
          @if (!isLoading && !error) {
            @if (filteredConfigurations.length === 0) {
              <div class="empty-state">
                <i class="fa-solid fa-sliders"></i>
                <h3>No configurations found</h3>
                <p>No AI configurations match your current filters. Try adjusting your search criteria or create a new configuration.</p>
              </div>
            } @else {
              <!-- Grid View -->
              @if (viewMode === 'grid') {
                <div class="configurations-grid">
                  @for (config of filteredConfigurations; track config.ID) {
                    <div class="config-card" [class.expanded]="config.isExpanded">
                      <!-- Card Header -->
                      <div class="card-header" (click)="toggleExpanded(config)">
                        <div class="config-info">
                          <div class="config-icon">
                            <i class="fa-solid fa-sliders"></i>
                          </div>
                          <div class="config-details">
                            <h4 class="config-name">{{ config.Name }}</h4>
                            <div class="config-meta">
                              @if (config.IsDefault) {
                                <span class="default-badge">
                                  <i class="fa-solid fa-star"></i>
                                  Default
                                </span>
                              }
                              <span class="status-badge" [ngClass]="getStatusClass(config.Status)">
                                <i [class]="getStatusIcon(config.Status)"></i>
                                {{ config.Status }}
                              </span>
                            </div>
                          </div>
                        </div>

                        <i class="fa-solid fa-chevron-down expand-icon"
                           [class.rotated]="config.isExpanded"></i>
                      </div>

                      <!-- Card Body -->
                      <div class="card-body">
                        @if (config.Description) {
                          <p class="config-description">{{ config.Description }}</p>
                        } @else {
                          <p class="config-description text-muted">No description provided</p>
                        }

                        <!-- Expanded Content -->
                        @if (config.isExpanded) {
                          <div class="expanded-content">
                            <!-- Stats Grid -->
                            <div class="config-stats">
                              <div class="stat-item">
                                <span class="stat-label">Parameters</span>
                                <span class="stat-value">{{ config.params?.length || 0 }}</span>
                              </div>
                              <div class="stat-item">
                                <span class="stat-label">Created</span>
                                <span class="stat-value">{{ formatDate(config.__mj_CreatedAt) }}</span>
                              </div>
                              <div class="stat-item">
                                <span class="stat-label">Updated</span>
                                <span class="stat-value">{{ formatDate(config.__mj_UpdatedAt) }}</span>
                              </div>
                            </div>

                            <!-- Linked Prompts -->
                            <div class="prompts-section">
                              <h5 class="section-title">
                                <i class="fa-solid fa-message-lines"></i>
                                Linked Prompts
                              </h5>
                              <div class="prompt-links">
                                @if (config.compressionPrompt) {
                                  <div class="prompt-link" (click)="onOpenPrompt(config.DefaultPromptForContextCompressionID!); $event.stopPropagation()">
                                    <div class="prompt-link-info">
                                      <div class="prompt-link-icon">
                                        <i class="fa-solid fa-compress"></i>
                                      </div>
                                      <div class="prompt-link-details">
                                        <span class="prompt-link-label">Context Compression</span>
                                        <span class="prompt-link-name">{{ config.compressionPrompt.Name }}</span>
                                      </div>
                                    </div>
                                    <i class="fa-solid fa-arrow-right prompt-link-arrow"></i>
                                  </div>
                                } @else {
                                  <div class="no-prompt">No compression prompt configured</div>
                                }

                                @if (config.summarizationPrompt) {
                                  <div class="prompt-link" (click)="onOpenPrompt(config.DefaultPromptForContextSummarizationID!); $event.stopPropagation()">
                                    <div class="prompt-link-info">
                                      <div class="prompt-link-icon">
                                        <i class="fa-solid fa-file-lines"></i>
                                      </div>
                                      <div class="prompt-link-details">
                                        <span class="prompt-link-label">Context Summarization</span>
                                        <span class="prompt-link-name">{{ config.summarizationPrompt.Name }}</span>
                                      </div>
                                    </div>
                                    <i class="fa-solid fa-arrow-right prompt-link-arrow"></i>
                                  </div>
                                } @else {
                                  <div class="no-prompt">No summarization prompt configured</div>
                                }
                              </div>
                            </div>

                            <!-- Configuration Parameters -->
                            @if (config.params && config.params.length > 0) {
                              <div class="params-section">
                                <h5 class="section-title">
                                  <i class="fa-solid fa-gear"></i>
                                  Configuration Parameters
                                </h5>
                                <div class="params-grid">
                                  @for (param of config.params; track param.ID) {
                                    <div class="param-item" (click)="onOpenParam(param); $event.stopPropagation()">
                                      <div class="param-info">
                                        <div class="param-type-icon">
                                          <i [class]="getParamTypeIcon(param.Type)"></i>
                                        </div>
                                        <div class="param-details">
                                          <span class="param-name">{{ param.Name }}</span>
                                          <span class="param-type">{{ param.Type }}</span>
                                        </div>
                                      </div>
                                      <span class="param-value">{{ formatParamValue(param) }}</span>
                                    </div>
                                  }
                                </div>
                              </div>
                            } @else {
                              <div class="params-section">
                                <h5 class="section-title">
                                  <i class="fa-solid fa-gear"></i>
                                  Configuration Parameters
                                </h5>
                                <div class="no-params">No parameters configured</div>
                              </div>
                            }
                          </div>
                        }
                      </div>

                      <!-- Card Actions -->
                      <div class="card-actions" (click)="$event.stopPropagation()">
                        <button
                          type="button"
                          class="action-btn"
                          (click)="showConfigDetails(config, $event)"
                          title="View Details">
                          <i class="fa-solid fa-eye"></i>
                          Details
                        </button>

                        <button
                          type="button"
                          class="action-btn action-btn-primary"
                          (click)="onOpenConfiguration(config)">
                          <i class="fa-solid fa-edit"></i>
                          Configure
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }

              <!-- List View -->
              @if (viewMode === 'list') {
                <div class="configurations-list">
                  <table class="configurations-table">
                    <thead>
                      <tr>
                        <th (click)="sortBy('Name')"
                            [class.sorted]="sortColumn === 'Name'"
                            [class.desc]="sortColumn === 'Name' && sortDirection === 'desc'">
                          <span class="sort-header">
                            Configuration
                            <i class="fa-solid fa-chevron-up sort-icon"></i>
                          </span>
                        </th>
                        <th (click)="sortBy('Status')"
                            [class.sorted]="sortColumn === 'Status'"
                            [class.desc]="sortColumn === 'Status' && sortDirection === 'desc'">
                          <span class="sort-header">
                            Status
                            <i class="fa-solid fa-chevron-up sort-icon"></i>
                          </span>
                        </th>
                        <th (click)="sortBy('Parameters')"
                            [class.sorted]="sortColumn === 'Parameters'"
                            [class.desc]="sortColumn === 'Parameters' && sortDirection === 'desc'">
                          <span class="sort-header">
                            Parameters
                            <i class="fa-solid fa-chevron-up sort-icon"></i>
                          </span>
                        </th>
                        <th (click)="sortBy('Updated')"
                            [class.sorted]="sortColumn === 'Updated'"
                            [class.desc]="sortColumn === 'Updated' && sortDirection === 'desc'">
                          <span class="sort-header">
                            Updated
                            <i class="fa-solid fa-chevron-up sort-icon"></i>
                          </span>
                        </th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (config of filteredConfigurations; track config.ID) {
                        <tr>
                          <td>
                            <div class="config-name-cell">
                              <div class="config-icon-small">
                                <i class="fa-solid fa-sliders"></i>
                              </div>
                              <div>
                                <div class="config-name-text">
                                  {{ config.Name }}
                                  @if (config.IsDefault) {
                                    <span class="default-badge" style="margin-left: 8px;">
                                      <i class="fa-solid fa-star"></i>
                                      Default
                                    </span>
                                  }
                                </div>
                                @if (config.Description) {
                                  <div class="config-description-small">{{ config.Description }}</div>
                                }
                              </div>
                            </div>
                          </td>
                          <td>
                            <span class="status-badge" [ngClass]="getStatusClass(config.Status)">
                              <i [class]="getStatusIcon(config.Status)"></i>
                              {{ config.Status }}
                            </span>
                          </td>
                          <td>{{ config.params?.length || 0 }}</td>
                          <td>{{ formatDate(config.__mj_UpdatedAt) }}</td>
                          <td>
                            <div class="table-actions">
                              <button
                                type="button"
                                class="action-btn-small"
                                (click)="showConfigDetails(config)"
                                title="View Details">
                                <i class="fa-solid fa-eye"></i>
                              </button>
                              <button
                                type="button"
                                class="action-btn-small primary"
                                (click)="onOpenConfiguration(config)">
                                <i class="fa-solid fa-edit"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              }
            }
          }
        </div>
      </kendo-splitter-pane>
    </kendo-splitter>
  </div>

  <!-- Detail Panel Overlay -->
  @if (detailPanelVisible) {
    <div class="detail-panel-overlay" (click)="closeDetailPanel()"></div>
  }

  <!-- Detail Panel -->
  <div class="detail-panel" [class.visible]="detailPanelVisible">
    @if (selectedConfig) {
      <!-- Panel Header -->
      <div class="detail-panel-header">
        <div class="detail-panel-title">
          <div class="detail-icon">
            <i class="fa-solid fa-sliders"></i>
          </div>
          <div class="detail-title-info">
            <h3>{{ selectedConfig.Name }}</h3>
            <span class="detail-subtitle">AI Configuration</span>
          </div>
        </div>
        <button class="detail-panel-close" (click)="closeDetailPanel()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>

      <!-- Panel Content -->
      <div class="detail-panel-content">
        <!-- Status Section -->
        <div class="detail-section">
          <div class="detail-badges">
            <span class="status-badge" [ngClass]="getStatusClass(selectedConfig.Status)">
              <i [class]="getStatusIcon(selectedConfig.Status)"></i>
              {{ selectedConfig.Status }}
            </span>
            @if (selectedConfig.IsDefault) {
              <span class="feature-badge default">
                <i class="fa-solid fa-star"></i>
                Default Configuration
              </span>
            }
          </div>
        </div>

        <!-- Description -->
        @if (selectedConfig.Description) {
          <div class="detail-section">
            <h4 class="detail-section-title">
              <i class="fa-solid fa-align-left"></i>
              Description
            </h4>
            <p class="detail-description">{{ selectedConfig.Description }}</p>
          </div>
        }

        <!-- Configuration Stats -->
        <div class="detail-section">
          <h4 class="detail-section-title">
            <i class="fa-solid fa-chart-bar"></i>
            Overview
          </h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Parameters</span>
              <span class="detail-value">{{ selectedConfig.params?.length || 0 }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status</span>
              <span class="detail-value">{{ selectedConfig.Status }}</span>
            </div>
          </div>
        </div>

        <!-- Linked Prompts -->
        <div class="detail-section">
          <h4 class="detail-section-title">
            <i class="fa-solid fa-message-lines"></i>
            Linked Prompts
          </h4>
          <div class="detail-grid single-column">
            <div class="detail-item">
              <span class="detail-label">Context Compression</span>
              <span class="detail-value">
                @if (selectedConfig.compressionPrompt) {
                  {{ selectedConfig.compressionPrompt.Name }}
                } @else {
                  <span class="muted">Not configured</span>
                }
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Context Summarization</span>
              <span class="detail-value">
                @if (selectedConfig.summarizationPrompt) {
                  {{ selectedConfig.summarizationPrompt.Name }}
                } @else {
                  <span class="muted">Not configured</span>
                }
              </span>
            </div>
          </div>
        </div>

        <!-- Parameters Preview -->
        @if (selectedConfig.params && selectedConfig.params.length > 0) {
          <div class="detail-section">
            <h4 class="detail-section-title">
              <i class="fa-solid fa-gear"></i>
              Parameters ({{ selectedConfig.params.length }})
            </h4>
            <div class="detail-params-list">
              @for (param of selectedConfig.params.slice(0, 5); track param.ID) {
                <div class="detail-param-item">
                  <div class="param-info">
                    <i [class]="getParamTypeIcon(param.Type)"></i>
                    <span class="param-name">{{ param.Name }}</span>
                  </div>
                  <span class="param-value">{{ formatParamValue(param) }}</span>
                </div>
              }
              @if (selectedConfig.params.length > 5) {
                <div class="params-more">
                  +{{ selectedConfig.params.length - 5 }} more parameters
                </div>
              }
            </div>
          </div>
        }

        <!-- Timestamps -->
        <div class="detail-section">
          <h4 class="detail-section-title">
            <i class="fa-solid fa-clock"></i>
            Timestamps
          </h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Created</span>
              <span class="detail-value">{{ formatDate(selectedConfig.__mj_CreatedAt) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Updated</span>
              <span class="detail-value">{{ formatDate(selectedConfig.__mj_UpdatedAt) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel Actions -->
      <div class="detail-panel-actions">
        <button
          type="button"
          class="detail-action-btn primary"
          (click)="openConfigFromPanel()">
          <i class="fa-solid fa-edit"></i>
          Open Full Record
        </button>
      </div>
    }
  </div>
</div>
