<div class="vs-container">
  <!-- Backdrop for closing panel -->
  @if (isDropdownOpen) {
    <div class="vs-backdrop" (click)="closeDropdown()"></div>
  }

  <!-- Main View Selector Button -->
  <div class="vs-wrapper">
    <button
      class="vs-button"
      [class.modified]="viewModified"
      [class.open]="isDropdownOpen"
      (click)="toggleDropdown()"
      [disabled]="isLoading"
      title="Select a saved view">
      <i class="fa-solid fa-layer-group vs-btn-icon"></i>
      <span class="vs-btn-name">{{ displayName }}</span>
      @if (viewModified) {
        <span class="vs-modified-dot" title="View has unsaved changes">â€¢</span>
      }
      <i class="fa-solid fa-chevron-down vs-arrow" [class.rotated]="isDropdownOpen"></i>
    </button>

    <!-- Rich View Panel -->
    @if (isDropdownOpen) {
      <div class="vs-panel">
        <!-- Panel Header -->
        <div class="vs-panel-header">
          <i class="fa-solid fa-table-list vs-header-icon"></i>
          <span class="vs-panel-title">Views</span>
          @if (entity) {
            <span class="vs-entity-badge">{{ entity.DisplayNameOrName }}</span>
          }
          <button class="vs-close-btn" (click)="closeDropdown()" title="Close">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <!-- Search -->
        <div class="vs-panel-search">
          <input
            type="text"
            class="vs-search-input"
            placeholder="Search views..."
            [(ngModel)]="searchText"
            (keydown.escape)="searchText = ''"
          />
        </div>

        <!-- Panel Body -->
        <div class="vs-panel-body">
          <!-- Default Option -->
          <div class="vs-section">
            <div
              class="vs-card"
              [class.active]="!selectedViewId"
              (click)="selectDefault()">
              <div class="vs-card-icon" [class.active]="!selectedViewId">
                <i class="fa-solid fa-table"></i>
              </div>
              <div class="vs-card-content">
                <div class="vs-card-name">(Default)</div>
              </div>
              @if (!selectedViewId) {
                <i class="fa-solid fa-check vs-card-check"></i>
              }
            </div>
          </div>

          <!-- My Views Section -->
          @if (filteredMyViews.length > 0) {
            <div class="vs-section">
              <div class="vs-section-header">
                <i class="fa-solid fa-user"></i>
                <span>My Views</span>
                <span class="vs-section-count">{{ filteredMyViews.length }}</span>
              </div>
              @for (view of filteredMyViews; track view.id) {
                <div
                  class="vs-card"
                  [class.active]="selectedViewId === view.id"
                  (click)="selectView(view)">
                  <div class="vs-card-icon" [class.active]="selectedViewId === view.id">
                    <i class="fa-solid fa-table-list"></i>
                  </div>
                  <div class="vs-card-content">
                    <div class="vs-card-name">
                      {{ view.name }}
                      @if (view.isDefault) {
                        <span class="vs-default-badge">Default</span>
                      }
                    </div>
                    @if (view.entity.Description) {
                      <div class="vs-card-desc">{{ view.entity.Description }}</div>
                    }
                    @if (getViewFilterCount(view) > 0 || getViewColumnCount(view) > 0 || getViewSortInfo(view)) {
                      <div class="vs-card-meta">
                        @if (getViewFilterCount(view) > 0) {
                          <span><i class="fa-solid fa-filter"></i> {{ getViewFilterCount(view) }} filter{{ getViewFilterCount(view) !== 1 ? 's' : '' }}</span>
                        }
                        @if (getViewColumnCount(view) > 0) {
                          <span><i class="fa-solid fa-table-columns"></i> {{ getViewColumnCount(view) }} col{{ getViewColumnCount(view) !== 1 ? 's' : '' }}</span>
                        }
                        @if (getViewSortInfo(view)) {
                          <span><i class="fa-solid fa-arrow-down-short-wide"></i> {{ getViewSortInfo(view) }}</span>
                        }
                      </div>
                    }
                  </div>
                  <div class="vs-card-actions">
                    <button
                      class="vs-action-btn"
                      (click)="onDuplicateView(view.id, $event)"
                      title="Duplicate">
                      <i class="fa-regular fa-copy"></i>
                    </button>
                    <button
                      class="vs-action-btn"
                      (click)="onConfigureViewById(view.id, $event)"
                      title="Configure">
                      <i class="fa-solid fa-sliders"></i>
                    </button>
                    <button
                      class="vs-action-btn"
                      (click)="onOpenViewInTab(view.id, $event)"
                      title="Open in Tab">
                      <i class="fa-solid fa-up-right-from-square"></i>
                    </button>
                  </div>
                  @if (selectedViewId === view.id) {
                    <i class="fa-solid fa-check vs-card-check"></i>
                  }
                </div>
              }
            </div>
          }

          <!-- Shared Views Section -->
          @if (filteredSharedViews.length > 0) {
            <div class="vs-section">
              <div class="vs-section-header">
                <i class="fa-solid fa-share-nodes"></i>
                <span>Shared With Me</span>
                <span class="vs-section-count">{{ filteredSharedViews.length }}</span>
              </div>
              @for (view of filteredSharedViews; track view.id) {
                <div
                  class="vs-card"
                  [class.active]="selectedViewId === view.id"
                  (click)="selectView(view)">
                  <div class="vs-card-icon shared">
                    <i class="fa-solid fa-users"></i>
                  </div>
                  <div class="vs-card-content">
                    <div class="vs-card-name">
                      {{ view.name }}
                      @if (!view.userCanEdit) {
                        <span class="vs-shared-badge">View Only</span>
                      } @else {
                        <span class="vs-shared-badge editable">Can Edit</span>
                      }
                    </div>
                    @if (view.entity.Description) {
                      <div class="vs-card-desc">{{ view.entity.Description }}</div>
                    }
                    @if (getViewFilterCount(view) > 0 || getViewColumnCount(view) > 0) {
                      <div class="vs-card-meta">
                        @if (getViewFilterCount(view) > 0) {
                          <span><i class="fa-solid fa-filter"></i> {{ getViewFilterCount(view) }} filter{{ getViewFilterCount(view) !== 1 ? 's' : '' }}</span>
                        }
                        @if (getViewColumnCount(view) > 0) {
                          <span><i class="fa-solid fa-table-columns"></i> {{ getViewColumnCount(view) }} col{{ getViewColumnCount(view) !== 1 ? 's' : '' }}</span>
                        }
                      </div>
                    }
                  </div>
                  <div class="vs-card-actions">
                    <button
                      class="vs-action-btn"
                      (click)="onDuplicateView(view.id, $event)"
                      title="Duplicate as My View">
                      <i class="fa-regular fa-copy"></i>
                    </button>
                    @if (view.userCanEdit) {
                      <button
                        class="vs-action-btn"
                        (click)="onConfigureViewById(view.id, $event)"
                        title="Configure">
                        <i class="fa-solid fa-sliders"></i>
                      </button>
                    }
                  </div>
                  @if (selectedViewId === view.id) {
                    <i class="fa-solid fa-check vs-card-check"></i>
                  }
                </div>
              }
            </div>
          }

          <!-- No Views Message -->
          @if (!hasViews && !isLoading) {
            <div class="vs-empty-message">
              <i class="fa-solid fa-bookmark"></i>
              <div class="vs-empty-text">
                <strong>No saved views yet</strong>
                <span>Save your current configuration as a view</span>
              </div>
            </div>
          }

          <!-- No Search Results -->
          @if (hasViews && filteredMyViews.length === 0 && filteredSharedViews.length === 0 && searchText) {
            <div class="vs-empty-message">
              <i class="fa-solid fa-search"></i>
              <span>No views match "{{ searchText }}"</span>
            </div>
          }

          <!-- Loading Indicator -->
          @if (isLoading) {
            <div class="vs-loading">
              <i class="fa-solid fa-spinner fa-spin"></i>
              <span>Loading views...</span>
            </div>
          }
        </div>

        <!-- Panel Footer -->
        <div class="vs-panel-footer">
          <button
            class="vs-panel-btn primary"
            (click)="onQuickSave()"
            title="Save current view configuration">
            <i class="fa-solid fa-plus"></i>
            <span>New View</span>
          </button>
          <button
            class="vs-panel-btn"
            (click)="onResetToDefault()"
            title="Reset to default view">
            <i class="fa-solid fa-arrow-rotate-left"></i>
            <span>Reset to Default</span>
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Open in Tab Button (only visible when a view is selected) -->
  @if (selectedViewId) {
    <button
      class="vs-icon-btn"
      (click)="onOpenInTab()"
      title="Open this view in a new tab">
      <i class="fa-solid fa-external-link-alt"></i>
    </button>
  }

  <!-- Configure View Button -->
  <button
    class="vs-icon-btn"
    (click)="onConfigureView()"
    title="Configure view settings (columns, filters, sorting)">
    <i class="fa-solid fa-sliders-h"></i>
  </button>

  <!-- Create New Record Button -->
  <button
    class="vs-icon-btn"
    (click)="onCreateNewRecord()"
    title="Create new record">
    <i class="fa-solid fa-plus"></i>
  </button>

  <!-- Export Button -->
  <button
    class="vs-icon-btn vs-export-btn"
    (click)="onExport()"
    title="Export to Excel">
    <i class="fa-solid fa-file-excel"></i>
  </button>
</div>
