<div class="detail-panel-container">
  <!-- Header -->
  <div class="panel-header">
    <h3 class="panel-title">{{ recordTitle }}</h3>
    <button class="close-btn" (click)="onClose()" title="Close">
      <i class="fa-solid fa-times"></i>
    </button>
  </div>

  <!-- Content -->
  <div class="panel-content">
    <!-- Details Section -->
    <div class="section">
      <div class="section-header" (click)="toggleSection('details')">
        <i class="fa-solid fa-info-circle section-icon"></i>
        <span class="section-title">Details</span>
        <i class="fa-solid expand-icon" [class.fa-chevron-down]="detailsSectionExpanded" [class.fa-chevron-right]="!detailsSectionExpanded"></i>
      </div>

      @if (detailsSectionExpanded) {
        <div class="section-content">
          @for (field of displayFields; track field.name) {
            <div class="field-row">
              <span class="field-label">{{ field.label }}</span>
              <span class="field-value">{{ field.value }}</span>
            </div>
          }

          @if (displayFields.length === 0) {
            <div class="empty-section">No details available</div>
          }
        </div>
      }
    </div>

    <!-- Relationships Section -->
    <div class="section">
      <div class="section-header" (click)="toggleSection('relationships')">
        <i class="fa-solid fa-project-diagram section-icon"></i>
        <span class="section-title">Related Records</span>
        @if (isLoadingRelationships) {
          <i class="fa-solid fa-spinner fa-spin loading-icon"></i>
        }
        <i class="fa-solid expand-icon" [class.fa-chevron-down]="relationshipsSectionExpanded" [class.fa-chevron-right]="!relationshipsSectionExpanded"></i>
      </div>

      @if (relationshipsSectionExpanded) {
        <div class="section-content">
          @if (relatedEntitiesWithRecords.length === 0 && !isLoadingRelationships) {
            <div class="empty-section">No related records</div>
          } @else {
            @for (relEntity of relatedEntitiesWithRecords; track relEntity.relatedEntityName) {
              <div class="related-entity-group" [class.expanded]="relEntity.isExpanded">
                <!-- Header row - click to expand -->
                <div
                  class="related-entity-header"
                  [class.clickable]="relEntity.count > 0"
                  [class.loading]="relEntity.isLoading"
                  (click)="toggleRelatedEntityExpansion(relEntity, $event)">
                  <i class="fa-solid expand-chevron"
                     [class.fa-chevron-down]="relEntity.isExpanded"
                     [class.fa-chevron-right]="!relEntity.isExpanded"></i>
                  <i [class]="getRelatedEntityIcon(relEntity)"></i>
                  <span class="related-entity-name">{{ relEntity.relatedEntityName }}</span>
                  <span class="related-entity-count">
                    @if (relEntity.isLoading) {
                      <i class="fa-solid fa-spinner fa-spin"></i>
                    } @else {
                      {{ relEntity.count }}
                    }
                  </span>
                </div>

                <!-- Expanded records list -->
                @if (relEntity.isExpanded) {
                  <div class="related-records-list">
                    @if (relEntity.isLoadingRecords) {
                      <div class="records-loading">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Loading records...</span>
                      </div>
                    } @else {
                      @for (rec of relEntity.records; track rec.PrimaryKey.ToString()) {
                        <div class="related-record-item" (click)="onRelatedRecordClick(relEntity, rec, $event)">
                          <div class="record-info">
                            <span class="record-name">{{ getRelatedRecordDisplayName(relEntity, rec) }}</span>
                            @if (getRelatedRecordSubtitle(relEntity, rec); as subtitle) {
                              <span class="record-subtitle">{{ subtitle }}</span>
                            }
                          </div>
                          <i class="fa-solid fa-external-link-alt record-open-icon"></i>
                        </div>
                      }

                      <!-- View All link if there are more records -->
                      @if (relEntity.count > 10) {
                        <div class="view-all-link" (click)="onViewAllRelated(relEntity, $event)">
                          <span>View all {{ relEntity.count }} records</span>
                          <i class="fa-solid fa-arrow-right"></i>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            }
          }
        </div>
      }
    </div>
  </div>

  <!-- Footer -->
  <div class="panel-footer">
    <button class="open-record-btn" (click)="onOpenRecord()">
      <i class="fa-solid fa-external-link-alt"></i>
      Open Full Record
    </button>
  </div>
</div>
