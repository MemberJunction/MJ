<div class="data-explorer-container">
  <!-- Navigation Panel (Left) - Hidden at home level, animated -->
  @if (!isAtHomeLevel) {
    <div
      class="navigation-panel"
      [class.collapsed]="state.navigationPanelCollapsed"
      [style.width.px]="state.navigationPanelCollapsed ? 48 : state.navigationPanelWidth"
      [@slideInLeft]>

      <mj-explorer-navigation-panel
        [entities]="entities"
        [appEntityGroups]="appEntityGroups"
        [selectedEntityName]="state.selectedEntityName"
        [favorites]="state.favorites"
        [recentItems]="state.recentItems"
        [collapsed]="state.navigationPanelCollapsed"
        [allowedEntityNames]="allowedEntityNames"
        [favoritesSectionExpanded]="state.favoritesSectionExpanded"
        [recentSectionExpanded]="state.recentSectionExpanded"
        [entitiesSectionExpanded]="state.entitiesSectionExpanded"
        [viewsSectionExpanded]="state.viewsSectionExpanded"
        (entitySelected)="onEntitySelected($event)"
        (toggleCollapse)="toggleNavigationPanel()"
        (sectionToggled)="stateService.toggleSection($event)"
        (openRecord)="onOpenRecordFromNav($event)"
        (selectRecord)="onSelectRecordFromNav($event)"
        (expandAndFocus)="onExpandAndFocus($event)">
      </mj-explorer-navigation-panel>
    </div>
  }

  <!-- Main Content Area -->
  <div class="content-area">
    <!-- Breadcrumb Bar - Hidden at home level -->
    @if (!isAtHomeLevel && breadcrumbs.length > 0) {
      <div class="breadcrumb-bar">
        @for (crumb of breadcrumbs; track crumb.label; let i = $index; let last = $last) {
          <span
            class="breadcrumb-item"
            [class.clickable]="!last"
            [class.current]="last"
            (click)="onBreadcrumbClick(crumb, i)"
            [title]="crumb.label">
            @if (crumb.icon) {
              <i [class]="crumb.icon" class="breadcrumb-icon"></i>
            }
            <span class="breadcrumb-label">{{ crumb.label }}</span>
          </span>
          @if (!last) {
            <i class="fa-solid fa-chevron-right breadcrumb-separator"></i>
          }
        }
      </div>
    }

    <!-- Header -->
    <div class="content-header" [class.home-header]="isAtHomeLevel">
      <div class="header-left">
        @if (selectedEntity) {
          <i [class]="getEntityIcon(selectedEntity)" class="entity-icon"></i>
          <h2 class="entity-title">{{ selectedEntity.DisplayNameOrName }}</h2>
          @if (debouncedFilterText && filteredRecordCount !== totalRecordCount) {
            <span class="record-count">{{ filteredRecordCount | number }} of {{ totalRecordCount | number }} records</span>
          } @else {
            <span class="record-count">{{ totalRecordCount | number }} records</span>
          }

          <!-- View Selector -->
          <mj-view-selector
            [entity]="selectedEntity"
            [selectedViewId]="state.selectedViewId"
            [viewModified]="state.viewModified"
            (viewSelected)="onViewSelected($event)"
            (saveViewRequested)="onSaveViewRequested($event)"
            (manageViewsRequested)="onManageViewsRequested()"
            (openInTabRequested)="onOpenInTabRequested($event)"
            (configureViewRequested)="onConfigureViewRequested()"
            (createNewRecordRequested)="onCreateNewRecord()"
            (exportRequested)="onExport()"
            (duplicateViewRequested)="onDuplicateView($event)"
            (quickSaveRequested)="onQuickSaveRequested($event)"
            (revertRequested)="onRevertView()">
          </mj-view-selector>

          <!-- Add to List Button -->
          <button
            class="header-action-btn"
            [class.disabled]="!hasSelectedRecords"
            [disabled]="!hasSelectedRecords"
            (click)="onAddToListClick()"
            [title]="hasSelectedRecords ? 'Add ' + selectedRecords.length + ' selected record(s) to a list' : 'Select records to add to a list'">
            <i class="fa-solid fa-list-check"></i>
            @if (hasSelectedRecords) {
              <span class="selection-badge">{{ selectedRecords.length }}</span>
            }
          </button>
        } @else {
          @if (displayIcon) {
            <i [class]="displayIcon" class="entity-icon"></i>
          }
          <h2 class="entity-title">{{ displayTitle }}</h2>
          <span class="record-count">{{ entities.length }} entities available</span>
        }
      </div>

      <div class="header-center">
        @if (selectedEntity) {
          <div class="smart-filter-container">
            <i class="fa-solid fa-search filter-icon"></i>
            <input
              #filterInput
              type="text"
              class="smart-filter-input"
              placeholder="Filter records... (press / to focus)"
              [ngModel]="debouncedFilterText"
              (ngModelChange)="onFilterTextChanged($event)"
            />
            @if (debouncedFilterText) {
              <button class="clear-filter-btn" (click)="onFilterTextChanged('')">
                <i class="fa-solid fa-times"></i>
              </button>
            }
          </div>
        }
        <!-- Home-level search moved to search hero section -->
      </div>

      <div class="header-right">
        @if (selectedEntity) {
          <!-- View Mode Toggle -->
          <div class="view-mode-toggle">
            <button
              class="toggle-btn"
              [class.active]="state.viewMode === 'grid'"
              (click)="onViewModeChanged('grid')"
              title="Grid View">
              <i class="fa-solid fa-list"></i>
            </button>
            <button
              class="toggle-btn"
              [class.active]="state.viewMode === 'cards'"
              (click)="onViewModeChanged('cards')"
              title="Cards View">
              <i class="fa-solid fa-grip"></i>
            </button>
            @if (entityHasDateFields) {
              <button
                class="toggle-btn"
                [class.active]="state.viewMode === 'timeline'"
                (click)="onViewModeChanged('timeline')"
                title="Timeline View">
                <i class="fa-solid fa-timeline"></i>
              </button>
            }
          </div>

          <!-- Timeline Controls (only shown when timeline view is active) -->
          @if (state.viewMode === 'timeline' && entityHasDateFields) {
            <!-- Date Field Selector -->
            <div class="date-field-selector-container">
              <!-- Backdrop for closing dropdown -->
              @if (isDateFieldDropdownOpen) {
                <div class="date-field-backdrop" (click)="closeDateFieldDropdown()"></div>
              }

              <div class="date-field-selector-wrapper">
                <button
                  class="date-field-selector-button"
                  [class.open]="isDateFieldDropdownOpen"
                  [disabled]="availableDateFields.length <= 1"
                  (click)="toggleDateFieldDropdown()">
                  <i class="fa-solid fa-calendar-days date-field-icon"></i>
                  <span class="date-field-name">{{ effectiveTimelineDateFieldDisplayName }}</span>
                  @if (availableDateFields.length > 1) {
                    <i class="fa-solid fa-chevron-down date-field-arrow" [class.rotated]="isDateFieldDropdownOpen"></i>
                  }
                </button>

                @if (isDateFieldDropdownOpen && availableDateFields.length > 1) {
                  <div class="date-field-dropdown-panel">
                    @for (field of availableDateFields; track field.name) {
                      <div
                        class="date-field-dropdown-item"
                        [class.selected]="field.name === effectiveTimelineDateField"
                        (click)="setTimelineDateField(field.name)">
                        <i class="fa-regular fa-calendar item-icon"></i>
                        <span class="item-name">{{ field.displayName }}</span>
                        @if (field.name === effectiveTimelineDateField) {
                          <i class="fa-solid fa-check selected-check"></i>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Orientation Toggle -->
            <div class="timeline-orientation-toggle">
              <button
                class="toggle-btn"
                (click)="toggleTimelineOrientation()"
                [title]="state.timelineOrientation === 'vertical' ? 'Switch to Horizontal' : 'Switch to Vertical'">
                <i [class]="state.timelineOrientation === 'vertical' ? 'fa-solid fa-ellipsis-vertical' : 'fa-solid fa-ellipsis'"></i>
              </button>
            </div>

            <!-- Sort Order Toggle -->
            <div class="timeline-sort-toggle">
              <button
                class="toggle-btn"
                (click)="toggleTimelineSortOrder()"
                [title]="state.timelineSortOrder === 'desc' ? 'Showing Newest First (click for Oldest First)' : 'Showing Oldest First (click for Newest First)'">
                <i [class]="state.timelineSortOrder === 'desc' ? 'fa-solid fa-arrow-down-wide-short' : 'fa-solid fa-arrow-up-wide-short'"></i>
              </button>
            </div>
          }
        }
        @if (!selectedEntity) {
          <!-- Quick Access panel toggle -->
          <button
            class="header-action-btn"
            [class.active]="state.quickAccessPanelOpen"
            (click)="toggleQuickAccessPanel()"
            title="Recents & Favorites">
            <i class="fa-solid fa-clock-rotate-left"></i>
            @if (recentRecords.length + favoriteRecords.length > 0) {
              <span class="qa-badge">{{ recentRecords.length + favoriteRecords.length }}</span>
            }
          </button>
        }
      </div>
    </div>

    <!-- Content Body - Using mj-entity-viewer composite -->
    <div class="content-body" [class.home-content]="isAtHomeLevel">
      @if (!selectedEntity) {
        <!-- Concept D: Application Groups + Search-First Home View -->
        <div class="home-view-concept-d">
          @if (isLoadingEntities) {
            <div class="loading-state">
              <mj-loading text="Loading entities..." size="medium"></mj-loading>
            </div>
          } @else {
            <div class="home-main-area" [class.panel-open]="state.quickAccessPanelOpen">
              <!-- Search Hero -->
              <div class="search-hero">
                <div class="search-hero-container">
                  <i class="fa-solid fa-magnifying-glass search-hero-icon"></i>
                  <input
                    #filterInput
                    type="text"
                    class="search-hero-input"
                    placeholder="Search entities..."
                    [(ngModel)]="entityFilterText"
                  />
                  @if (entityFilterText) {
                    <button class="search-hero-clear" (click)="entityFilterText = ''">
                      <i class="fa-solid fa-times"></i>
                    </button>
                  } @else {
                    <span class="search-hero-shortcut">/</span>
                  }
                </div>

                <!-- Meta row: entity count + All/Favorites pills -->
                <div class="search-meta-row">
                  <span class="search-entity-count">
                    {{ filteredEntityCount }} entities
                    @if (applicationCount > 0) {
                      across {{ applicationCount }} applications
                    }
                  </span>
                  <div class="pill-toggle">
                    <button
                      class="pill-btn"
                      [class.active]="state.homeViewMode === 'all'"
                      (click)="setHomeViewMode('all')">
                      All Entities
                    </button>
                    <button
                      class="pill-btn"
                      [class.active]="state.homeViewMode === 'favorites'"
                      (click)="setHomeViewMode('favorites')">
                      <i class="fa-solid fa-star"></i> My Favorites
                    </button>
                  </div>
                </div>
              </div>

              <!-- Entity Groups Area -->
              <div class="entity-groups-area">
                @if (entityFilter?.applicationId) {
                  <!-- Single-app mode: flat entity grid (no grouping) -->
                  <div class="entity-item-grid">
                    @for (entity of flatFilteredEntities; track entity.ID) {
                      <div
                        class="entity-item"
                        (click)="onEntitySelected(entity)"
                        [title]="entity.Description || entity.DisplayNameOrName">
                        <div class="entity-item-icon">
                          <i [class]="getEntityIcon(entity)"></i>
                        </div>
                        <div class="entity-item-text">
                          <span class="entity-item-name">{{ entity.DisplayNameOrName }}</span>
                          @if (entity.Description) {
                            <span class="entity-item-desc">{{ entity.Description }}</span>
                          }
                        </div>
                        <button
                          class="entity-item-fav"
                          [class.favorited]="isEntityFavorited(entity)"
                          (click)="toggleEntityFavorite(entity, $event)"
                          [title]="isEntityFavorited(entity) ? 'Remove from favorites' : 'Add to favorites'">
                          <i [class]="isEntityFavorited(entity) ? 'fa-solid fa-star' : 'fa-regular fa-star'"></i>
                        </button>
                      </div>
                    }
                  </div>
                } @else {
                  <!-- Multi-app mode: grouped by application -->
                  @for (group of filteredAppEntityGroups; track group.applicationId) {
                    <div class="app-group">
                      <div class="app-group-header" (click)="toggleAppGroup(group.applicationId)">
                        <div
                          class="app-group-icon"
                          [style.background]="group.applicationColor ? group.applicationColor + '15' : null"
                          [style.color]="group.applicationColor || null">
                          <i [class]="group.applicationIcon || 'fa-solid fa-folder'"></i>
                        </div>
                        <span class="app-group-name">{{ group.applicationName }}</span>
                        <span class="app-group-count">{{ group.entities.length }}</span>
                        <i class="fa-solid fa-chevron-right app-group-chevron"
                           [class.expanded]="group.isExpanded"></i>
                      </div>
                      @if (group.isExpanded) {
                        <div class="app-group-entities">
                          <div class="entity-item-grid">
                            @for (entity of group.entities; track entity.ID) {
                              <div
                                class="entity-item"
                                (click)="onEntitySelected(entity)"
                                [title]="entity.Description || entity.DisplayNameOrName">
                                <div class="entity-item-icon">
                                  <i [class]="getEntityIcon(entity)"></i>
                                </div>
                                <div class="entity-item-text">
                                  <span class="entity-item-name">{{ entity.DisplayNameOrName }}</span>
                                  @if (entity.Description) {
                                    <span class="entity-item-desc">{{ entity.Description }}</span>
                                  }
                                </div>
                                <button
                                  class="entity-item-fav"
                                  [class.favorited]="isEntityFavorited(entity)"
                                  (click)="toggleEntityFavorite(entity, $event)"
                                  [title]="isEntityFavorited(entity) ? 'Remove from favorites' : 'Add to favorites'">
                                  <i [class]="isEntityFavorited(entity) ? 'fa-solid fa-star' : 'fa-regular fa-star'"></i>
                                </button>
                              </div>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  }
                }

                <!-- No results -->
                @if (filteredEntityCount === 0 && entities.length > 0) {
                  <div class="home-no-results">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <p>No entities match "{{ entityFilterText }}"</p>
                  </div>
                }
                @if (entities.length === 0) {
                  <div class="empty-state">
                    <i class="fa-solid fa-database empty-icon"></i>
                    <h3>No Entities Available</h3>
                    <p>There are no entities configured for this application.</p>
                  </div>
                }
              </div>
            </div>

            <!-- Quick Access Panel (right slide-in) -->
            <div class="quick-access-panel" [class.open]="state.quickAccessPanelOpen">
              <div class="qa-header">
                <h3>Quick Access</h3>
                <button class="qa-close-btn" (click)="toggleQuickAccessPanel()">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
              <div class="qa-body">
                <!-- Recent Records (max 3) -->
                <div class="qa-section" [class.collapsed]="!isQuickAccessSectionExpanded('recentRecords')">
                  <div class="qa-section-header" (click)="toggleQuickAccessSection('recentRecords')">
                    <i class="fa-solid fa-clock-rotate-left qa-section-icon"></i>
                    <span>Recent Records</span>
                    <span class="qa-section-count">{{ quickAccessRecentRecords.length }}</span>
                    <i class="fa-solid fa-chevron-down qa-section-chevron"></i>
                  </div>
                  <div class="qa-section-body">
                    @for (record of quickAccessRecentRecords; track record.entityId + '|' + record.recordId) {
                      <div class="qa-item" (click)="onRecentRecordClick(record)">
                        <div class="qa-item-icon">
                          <i [class]="getEntityIconById(record.entityId)"></i>
                        </div>
                        <div class="qa-item-info">
                          <div class="qa-item-name">{{ record.recordName || record.recordId }}</div>
                          <div class="qa-item-meta">{{ record.entityName }}</div>
                        </div>
                        <span class="qa-item-time">{{ formatRelativeTime(record.latestAt) }}</span>
                      </div>
                    }
                    @if (quickAccessRecentRecords.length === 0) {
                      <div class="qa-empty">No recent records</div>
                    }
                  </div>
                </div>

                <!-- Recent Entities (max 3) -->
                <div class="qa-section" [class.collapsed]="!isQuickAccessSectionExpanded('recentEntities')">
                  <div class="qa-section-header" (click)="toggleQuickAccessSection('recentEntities')">
                    <i class="fa-solid fa-table qa-section-icon"></i>
                    <span>Recent Entities</span>
                    <span class="qa-section-count">{{ quickAccessRecentEntities.length }}</span>
                    <i class="fa-solid fa-chevron-down qa-section-chevron"></i>
                  </div>
                  <div class="qa-section-body">
                    @for (entity of quickAccessRecentEntities; track entity.ID) {
                      <div class="qa-item" (click)="onEntitySelected(entity)">
                        <div class="qa-item-icon">
                          <i [class]="getEntityIcon(entity)"></i>
                        </div>
                        <div class="qa-item-info">
                          <div class="qa-item-name">{{ entity.DisplayNameOrName }}</div>
                        </div>
                      </div>
                    }
                    @if (quickAccessRecentEntities.length === 0) {
                      <div class="qa-empty">No recent entities</div>
                    }
                  </div>
                </div>

                <!-- Favorite Records (max 3) -->
                <div class="qa-section" [class.collapsed]="!isQuickAccessSectionExpanded('favoriteRecords')">
                  <div class="qa-section-header" (click)="toggleQuickAccessSection('favoriteRecords')">
                    <i class="fa-solid fa-star qa-section-icon" style="color: #f59e0b;"></i>
                    <span>Favorite Records</span>
                    <span class="qa-section-count">{{ quickAccessFavoriteRecords.length }}</span>
                    <i class="fa-solid fa-chevron-down qa-section-chevron"></i>
                  </div>
                  <div class="qa-section-body">
                    @for (record of quickAccessFavoriteRecords; track record.userFavoriteId) {
                      <div class="qa-item" (click)="onFavoriteRecordClick(record)">
                        <div class="qa-item-icon">
                          <i [class]="getEntityIconById(record.entityId)"></i>
                        </div>
                        <div class="qa-item-info">
                          <div class="qa-item-name">{{ record.recordName || record.recordId }}</div>
                          <div class="qa-item-meta">{{ record.entityName }}</div>
                        </div>
                      </div>
                    }
                    @if (quickAccessFavoriteRecords.length === 0) {
                      <div class="qa-empty">No favorite records</div>
                    }
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <mj-entity-viewer
          #entityViewer
          [entity]="selectedEntity"
          [viewEntity]="selectedViewEntity"
          [viewMode]="state.viewMode"
          [filterText]="debouncedFilterText"
          [selectedRecordId]="state.selectedRecordId"
          [config]="viewerConfig"
          [gridState]="currentGridState"
          [timelineConfig]="currentTimelineConfig"
          [gridSelectionMode]="'checkbox'"
          [showGridToolbar]="false"
          [showAddToListButton]="false"
          (viewModeChange)="onViewModeChanged($event)"
          (filterTextChange)="onFilterTextChanged($event)"
          (recordSelected)="onViewerRecordSelected($event)"
          (recordOpened)="onViewerRecordOpened($event)"
          (dataLoaded)="onDataLoaded($event)"
          (filteredCountChanged)="onFilteredCountChanged($event)"
          (gridStateChanged)="onGridStateChanged($event)"
          (selectionChanged)="onSelectionChanged($event)"
          (addToListRequested)="onAddToListRequested($event)">
        </mj-entity-viewer>
      }
    </div>
  </div>

  <!-- Detail Panel (Right - Slide In) -->
  @if (state.detailPanelOpen && selectedRecord) {
    <div class="detail-panel" [style.width.px]="state.detailPanelWidth">
      <!-- Detail Panel Actions Bar -->
      <div class="detail-panel-actions">
        <button
          class="detail-action-btn"
          (click)="openListManagementDialog()"
          title="Add to List">
          <i class="fa-solid fa-list-check"></i>
          <span>Add to List</span>
        </button>
      </div>
      <mj-entity-record-detail-panel
        [entity]="detailPanelEntity"
        [record]="selectedRecord"
        (close)="onDetailPanelClosed()"
        (openRecord)="onOpenRecord($event)"
        (navigateToRelated)="onNavigateToRelated($event)"
        (openRelatedRecord)="onOpenRelatedRecord($event)"
        (openForeignKeyRecord)="onOpenForeignKeyRecord($event)">
      </mj-entity-record-detail-panel>
    </div>
  }

  <!-- View Configuration Panel -->
  <mj-view-config-panel
    [entity]="selectedEntity"
    [viewEntity]="selectedViewEntity"
    [isOpen]="state.viewConfigPanelOpen"
    [currentGridState]="currentGridState"
    [externalFilterState]="filterDialogState"
    [isSaving]="isSavingView"
    [DefaultSaveAsNew]="defaultSaveAsNew"
    (close)="onCloseViewConfigPanel()"
    (save)="onSaveView($event)"
    (saveDefaults)="onSaveDefaultViewSettings($event)"
    (delete)="onDeleteView()"
    (duplicate)="onDuplicateFromPanel()"
    (openFilterDialogRequest)="onOpenFilterDialogRequest($event)">
  </mj-view-config-panel>

  <!-- Filter Dialog (rendered at dashboard level for full viewport width) -->
  <mj-filter-dialog
    [isOpen]="isFilterDialogOpen"
    [fields]="filterDialogFields"
    [filter]="filterDialogState"
    [disabled]="filterDialogDisabled"
    (close)="onCloseFilterDialog()"
    (apply)="onFilterApplied($event)">
  </mj-filter-dialog>

  <!-- Export Dialog -->
  <mj-export-dialog
    [visible]="showExportDialog"
    [config]="exportDialogConfig"
    (closed)="onExportDialogClosed($event)">
  </mj-export-dialog>

  <!-- List Management Dialog -->
  @if (showListManagementDialog && listManagementConfig) {
    <mj-list-management-dialog
      [config]="listManagementConfig"
      [visible]="showListManagementDialog"
      (complete)="onListManagementComplete($event)"
      (cancel)="onListManagementCancel()">
    </mj-list-management-dialog>
  }

  <!-- Quick Save Dialog (F-001) -->
  <mj-quick-save-dialog
    [IsOpen]="showQuickSaveDialog"
    [ViewEntity]="selectedViewEntity"
    [EntityName]="selectedEntity?.DisplayNameOrName ?? ''"
    [Summary]="quickSaveSummary"
    [IsSaving]="isSavingView"
    [DefaultSaveAsNew]="defaultSaveAsNew"
    (Save)="onQuickSave($event)"
    (Close)="onQuickSaveClose()"
    (OpenAdvanced)="onQuickSaveOpenAdvanced()">
  </mj-quick-save-dialog>

  <!-- Duplicate View Dialog (F-005) -->
  <mj-duplicate-view-dialog
    [IsOpen]="showDuplicateDialog"
    [SourceViewName]="duplicateSourceViewName"
    [Summary]="duplicateSummary"
    (Duplicate)="onDuplicateConfirmed($event)"
    (Cancel)="onDuplicateCancel()">
  </mj-duplicate-view-dialog>

  <!-- Shared View Warning Dialog (view-creation-flow Scenario 5) -->
  <mj-shared-view-warning-dialog
    [IsOpen]="showSharedViewWarning"
    [ViewName]="selectedViewEntity?.Name ?? ''"
    (Action)="onSharedViewAction($event)"
    (Cancel)="onSharedViewWarningCancel()">
  </mj-shared-view-warning-dialog>
</div>
