<div class="scheduling-monitoring">
  <div class="monitoring-header">
    <div class="header-actions">
      <button kendoButton (click)="onRefresh()" [disabled]="isLoading">
        <i class="fa-solid fa-refresh" [class.fa-spin]="isLoading"></i>
        Refresh
      </button>
      <button kendoButton (click)="toggleAutoRefresh()">
        <i class="fa-solid" [class.fa-pause]="autoRefreshEnabled" [class.fa-play]="!autoRefreshEnabled"></i>
        Auto-Refresh: {{ autoRefreshEnabled ? 'ON' : 'OFF' }}
      </button>
    </div>
  </div>

  @if (isLoading && !kpis) {
    <div class="loading-overlay">
      <i class="fa-solid fa-spinner fa-spin fa-3x"></i>
      <p>Loading monitoring data...</p>
    </div>
  }

  @if (kpis) {
    <div class="kpi-grid">
      <div class="kpi-card primary">
        <div class="kpi-icon">
          <i class="fa-solid fa-calendar-check"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ kpis.totalActiveJobs }}</div>
          <div class="kpi-label">Total Active Jobs</div>
        </div>
      </div>

      <div class="kpi-card warning">
        <div class="kpi-icon">
          <i class="fa-solid fa-clock"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ kpis.jobsDueInNextHour }}</div>
          <div class="kpi-label">Due in Next Hour</div>
        </div>
      </div>

      <div class="kpi-card info">
        <div class="kpi-icon">
          <i class="fa-solid fa-chart-bar"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ kpis.recentExecutions24h }}</div>
          <div class="kpi-label">Executions (24h)</div>
          <div class="kpi-breakdown">
            Success Rate: {{ formatPercentage(kpis.successRate24h) }}
          </div>
        </div>
      </div>

      <div class="kpi-card success">
        <div class="kpi-icon">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ kpis.currentlyRunning }}</div>
          <div class="kpi-label">Currently Running</div>
        </div>
      </div>

      <div class="kpi-card warning">
        <div class="kpi-icon">
          <i class="fa-solid fa-lock"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ kpis.lockedJobs }}</div>
          <div class="kpi-label">Locked Jobs</div>
        </div>
      </div>

      <div class="kpi-card primary">
        <div class="kpi-icon">
          <i class="fa-solid fa-dollar-sign"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ formatCost(kpis.totalCost24h) }}</div>
          <div class="kpi-label">Cost (24h)</div>
        </div>
      </div>

      <div class="kpi-card" [class.error]="kpis.failureRate7d > 0.1">
        <div class="kpi-icon">
          <i class="fa-solid fa-exclamation-triangle"></i>
        </div>
        <div class="kpi-content">
          <div class="kpi-value">{{ kpis.totalFailures7d }}</div>
          <div class="kpi-label">Failures (7d)</div>
          <div class="kpi-breakdown">
            Rate: {{ formatPercentage(kpis.failureRate7d) }}
          </div>
        </div>
      </div>
    </div>

    <div class="content-panels">
      <div class="panel live-executions">
        <div class="panel-header">
          <h3><i class="fa-solid fa-bolt"></i> Live Executions</h3>
          <span class="badge">{{ liveExecutions.length }}</span>
        </div>
        <div class="panel-content">
          @if (liveExecutions.length === 0) {
            <div class="empty-state">
              <i class="fa-solid fa-inbox"></i>
              <p>No recent executions</p>
            </div>
          } @else {
            <table class="execution-table">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Job Name</th>
                  <th>Type</th>
                  <th>Started</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody>
                @for (exec of liveExecutions.slice(0, 10); track exec.id) {
                  <tr>
                    <td>
                      <span class="status-badge" [ngClass]="getStatusClass(exec.status)">
                        <i class="fa-solid" [ngClass]="getStatusIcon(exec.status)"></i>
                        {{ exec.status }}
                      </span>
                    </td>
                    <td>{{ exec.jobName }}</td>
                    <td>{{ exec.jobType }}</td>
                    <td>{{ formatTimeAgo(exec.startedAt) }}</td>
                    <td>{{ formatDuration(exec.duration) }}</td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>

      <div class="panel upcoming-executions">
        <div class="panel-header">
          <h3><i class="fa-solid fa-calendar-alt"></i> Upcoming Executions (Next 24h)</h3>
          <span class="badge">{{ upcomingExecutions.length }}</span>
        </div>
        <div class="panel-content">
          @if (upcomingExecutions.length === 0) {
            <div class="empty-state">
              <i class="fa-solid fa-inbox"></i>
              <p>No upcoming executions in next 24 hours</p>
            </div>
          } @else {
            <table class="execution-table">
              <thead>
                <tr>
                  <th>Job Name</th>
                  <th>Type</th>
                  <th>Next Run</th>
                  <th>Time Until</th>
                  <th>Schedule</th>
                </tr>
              </thead>
              <tbody>
                @for (exec of upcomingExecutions.slice(0, 10); track exec.jobId) {
                  <tr>
                    <td>{{ exec.jobName }}</td>
                    <td>{{ exec.jobType }}</td>
                    <td>{{ exec.nextRunAt | date: 'short' }}</td>
                    <td>
                      <span class="time-until">{{ formatTimeUntil(exec.nextRunAt) }}</span>
                    </td>
                    <td>
                      <code>{{ exec.cronExpression }}</code>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          }
        </div>
      </div>
    </div>
  }
</div>
