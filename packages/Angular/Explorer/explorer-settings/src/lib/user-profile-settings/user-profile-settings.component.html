<div class="user-profile-settings">
  <div class="profile-header">
    <h3>Avatar Settings</h3>
    <p class="description">Customize your profile picture with an image, URL, or icon</p>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
    <div class="alert alert-error" role="alert">
      <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>
      <span>{{ errorMessage }}</span>
      <button class="close-btn" (click)="errorMessage = ''" aria-label="Dismiss error">
        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
      </button>
    </div>
  }

  <!-- Success Message -->
  @if (showSuccessMessage) {
    <div class="alert alert-success" role="status" aria-live="polite">
      <i class="fa-solid fa-check-circle" aria-hidden="true"></i>
      <span>Avatar updated successfully!</span>
    </div>
  }

  <!-- Preview Section -->
  <div class="avatar-preview-section">
    <div class="preview-label">Preview</div>
    <div class="preview-container">
      @if (previewUrl) {
        <img [src]="previewUrl" alt="Avatar preview" class="preview-image" />
      } @else if (previewIconClass) {
        <div class="preview-icon-wrapper">
          <i [class]="previewIconClass + ' preview-icon'" aria-hidden="true"></i>
        </div>
      } @else {
        <div class="preview-placeholder">
          <i class="fa-solid fa-user" aria-hidden="true"></i>
          <span>No avatar selected</span>
        </div>
      }
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation" role="tablist" aria-label="Avatar customization options">
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'upload'"
      (click)="selectTab('upload')"
      role="tab"
      [attr.aria-selected]="selectedTab === 'upload'"
      aria-controls="panel-upload"
    >
      <i class="fa-solid fa-upload" aria-hidden="true"></i>
      <span>Upload</span>
    </button>
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'url'"
      (click)="selectTab('url')"
      role="tab"
      [attr.aria-selected]="selectedTab === 'url'"
      aria-controls="panel-url"
    >
      <i class="fa-solid fa-link" aria-hidden="true"></i>
      <span>URL</span>
    </button>
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'icon'"
      (click)="selectTab('icon')"
      role="tab"
      [attr.aria-selected]="selectedTab === 'icon'"
      aria-controls="panel-icon"
    >
      <i class="fa-solid fa-icons" aria-hidden="true"></i>
      <span>Icon</span>
    </button>
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'provider'"
      (click)="selectTab('provider')"
      role="tab"
      [attr.aria-selected]="selectedTab === 'provider'"
      aria-controls="panel-provider"
    >
      <i class="fa-brands fa-microsoft" aria-hidden="true"></i>
      <span>Sync</span>
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Upload Tab -->
    @if (selectedTab === 'upload') {
      <div class="upload-section" id="panel-upload" role="tabpanel">
        <input
          type="file"
          #fileInput
          accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
          (change)="onFileSelected($event)"
          style="display: none"
        />

        <button class="upload-btn" (click)="fileInput.click()">
          <i class="fa-solid fa-upload" aria-hidden="true"></i>
          Choose Image
        </button>

        <div class="upload-info">
          <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
          Max 200KB - PNG, JPG, GIF, WEBP
        </div>

        @if (uploadedFileName) {
          <div class="selected-file">
            <i class="fa-solid fa-file-image" aria-hidden="true"></i>
            <span>{{ uploadedFileName }}</span>
            <button class="remove-btn" (click)="clearUpload()" aria-label="Remove selected file">
              <i class="fa-solid fa-xmark" aria-hidden="true"></i>
            </button>
          </div>
        }
      </div>
    }

    <!-- URL Tab -->
    @if (selectedTab === 'url') {
      <div class="url-section" id="panel-url" role="tabpanel">
        <label for="imageUrl">Image URL</label>
        <input
          type="text"
          id="imageUrl"
          class="url-input"
          placeholder="https://example.com/avatar.jpg"
          [(ngModel)]="imageUrlInput"
          (input)="onUrlChange()"
        />
        <div class="url-info">
          <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
          Enter a URL to an image hosted online
        </div>
      </div>
    }

    <!-- Icon Tab -->
    @if (selectedTab === 'icon') {
      <div class="icon-section" id="panel-icon" role="tabpanel">
        <!-- Icon Search -->
        <div class="icon-search-container">
          <div class="mj-search">
            <i class="fa-solid fa-search mj-search-icon" aria-hidden="true"></i>
            <input
              type="text"
              class="mj-search-input"
              placeholder="Search icons by name..."
              [value]="iconSearchTerm"
              (input)="onIconSearchChange($event)"
              aria-label="Search icons"
            />
            @if (iconSearchTerm) {
              <button
                class="mj-search-clear"
                (click)="clearIconSearch()"
                aria-label="Clear search"
              >
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
              </button>
            }
          </div>
          <div class="icon-filter-info">
            {{ totalFilteredIcons }} icon{{ totalFilteredIcons !== 1 ? 's' : '' }} found
          </div>
        </div>

        <!-- Icon Categories -->
        <div class="icon-categories-container">
          @if (filteredIconCategories.length > 0) {
            @for (category of filteredIconCategories; track category.name) {
              <div class="icon-category">
                <h4 class="category-title">{{ category.name }}</h4>
                <div class="icon-grid" role="radiogroup" [attr.aria-label]="category.name + ' icons'">
                  @for (icon of category.icons; track icon) {
                    <button
                      class="icon-option"
                      [class.selected]="isIconSelected(icon)"
                      (click)="selectIcon(icon)"
                      [title]="extractIconName(icon)"
                      role="radio"
                      [attr.aria-checked]="isIconSelected(icon)"
                      [attr.aria-label]="extractIconName(icon) + ' icon'"
                    >
                      <i [class]="icon" aria-hidden="true"></i>
                    </button>
                  }
                </div>
              </div>
            }
          } @else {
            <div class="empty-state">
              <i class="fa-solid fa-search empty-icon" aria-hidden="true"></i>
              <p class="empty-text">No icons found</p>
              <p class="empty-subtext">Try a different search term</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Provider Sync Tab -->
    @if (selectedTab === 'provider') {
      <div class="provider-section" id="panel-provider" role="tabpanel">
        <div class="provider-info">
          <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
          <p>Sync your avatar from your authentication provider account</p>
        </div>

        <button
          class="sync-btn"
          (click)="syncFromProvider()"
          [disabled]="isSaving"
        >
          <i class="fa-brands fa-microsoft" aria-hidden="true"></i>
          @if (isSaving) {
            <span>Syncing...</span>
          } @else {
            <span>Sync from Microsoft Account</span>
          }
        </button>

        <div class="provider-note">
          <i class="fa-solid fa-lightbulb" aria-hidden="true"></i>
          <small>This will download your profile photo from Microsoft and save it to your profile</small>
        </div>

        <hr class="provider-divider" />

        <button
          class="revert-btn"
          (click)="revertToDefault()"
          [disabled]="isSaving"
        >
          <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
          @if (isSaving) {
            <span>Reverting...</span>
          } @else {
            <span>Revert to Default</span>
          }
        </button>

        <div class="provider-note">
          <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
          <small>Clears your avatar settings and restores the automatic sync from your auth provider</small>
        </div>
      </div>
    }
  </div>

  <!-- Action Buttons - Primary (Save) on LEFT per MD3 design guide -->
  <div class="action-buttons">
    <button
      class="mj-btn mj-btn-primary"
      (click)="save()"
      [disabled]="isSaving || selectedTab === 'provider'"
    >
      @if (isSaving) {
        <i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i>
        <span>Saving...</span>
      } @else {
        <i class="fa-solid fa-save" aria-hidden="true"></i>
        <span>Save Changes</span>
      }
    </button>
    <button
      class="mj-btn mj-btn-secondary"
      (click)="cancel()"
      [disabled]="isSaving"
    >
      Cancel
    </button>
  </div>
</div>
