<div class="user-profile-settings">
  <div class="profile-header">
    <h3>Avatar Settings</h3>
    <p class="description">Customize your profile picture with an image, URL, or icon</p>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
    <div class="alert alert-error">
      <i class="fa-solid fa-exclamation-triangle"></i>
      <span>{{ errorMessage }}</span>
      <button class="close-btn" (click)="errorMessage = ''">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  }

  <!-- Success Message -->
  @if (showSuccessMessage) {
    <div class="alert alert-success">
      <i class="fa-solid fa-check-circle"></i>
      <span>Avatar updated successfully!</span>
    </div>
  }

  <!-- Preview Section -->
  <div class="avatar-preview-section">
    <div class="preview-label">Preview</div>
    <div class="preview-container">
      @if (previewUrl) {
        <img [src]="previewUrl" alt="Avatar preview" class="preview-image" />
      } @else if (previewIconClass) {
        <div class="preview-icon-wrapper">
          <i [class]="previewIconClass + ' preview-icon'"></i>
        </div>
      } @else {
        <div class="preview-placeholder">
          <i class="fa-solid fa-user"></i>
          <span>No avatar selected</span>
        </div>
      }
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'upload'"
      (click)="selectTab('upload')"
    >
      <i class="fa-solid fa-upload"></i>
      <span>Upload</span>
    </button>
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'url'"
      (click)="selectTab('url')"
    >
      <i class="fa-solid fa-link"></i>
      <span>URL</span>
    </button>
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'icon'"
      (click)="selectTab('icon')"
    >
      <i class="fa-solid fa-icons"></i>
      <span>Icon</span>
    </button>
    <button
      class="tab-btn"
      [class.active]="selectedTab === 'provider'"
      (click)="selectTab('provider')"
    >
      <i class="fa-brands fa-microsoft"></i>
      <span>Sync</span>
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Upload Tab -->
    @if (selectedTab === 'upload') {
      <div class="upload-section">
        <input
          type="file"
          #fileInput
          accept="image/png,image/jpeg,image/jpg,image/gif,image/webp"
          (change)="onFileSelected($event)"
          style="display: none"
        />

        <button class="upload-btn" (click)="fileInput.click()">
          <i class="fa-solid fa-upload"></i>
          Choose Image
        </button>

        <div class="upload-info">
          <i class="fa-solid fa-info-circle"></i>
          Max 200KB â€¢ PNG, JPG, GIF, WEBP
        </div>

        @if (uploadedFileName) {
          <div class="selected-file">
            <i class="fa-solid fa-file-image"></i>
            <span>{{ uploadedFileName }}</span>
            <button class="remove-btn" (click)="clearUpload()">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        }
      </div>
    }

    <!-- URL Tab -->
    @if (selectedTab === 'url') {
      <div class="url-section">
        <label for="imageUrl">Image URL</label>
        <input
          type="text"
          id="imageUrl"
          class="url-input"
          placeholder="https://example.com/avatar.jpg"
          [(ngModel)]="imageUrlInput"
          (input)="onUrlChange()"
        />
        <div class="url-info">
          <i class="fa-solid fa-info-circle"></i>
          Enter a URL to an image hosted online
        </div>
      </div>
    }

    <!-- Icon Tab -->
    @if (selectedTab === 'icon') {
      <div class="icon-section">
        @for (category of iconCategories; track category.name) {
          <div class="icon-category">
            <h4 class="category-title">{{ category.name }}</h4>
            <div class="icon-grid">
              @for (icon of category.icons; track icon) {
                <button
                  class="icon-option"
                  [class.selected]="isIconSelected(icon)"
                  (click)="selectIcon(icon)"
                  [title]="icon"
                >
                  <i [class]="icon"></i>
                </button>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Provider Sync Tab -->
    @if (selectedTab === 'provider') {
      <div class="provider-section">
        <div class="provider-info">
          <i class="fa-solid fa-info-circle"></i>
          <p>Sync your avatar from your authentication provider account</p>
        </div>

        <button
          class="sync-btn"
          (click)="syncFromProvider()"
          [disabled]="isSaving"
        >
          <i class="fa-brands fa-microsoft"></i>
          @if (isSaving) {
            <span>Syncing...</span>
          } @else {
            <span>Sync from Microsoft Account</span>
          }
        </button>

        <div class="provider-note">
          <i class="fa-solid fa-lightbulb"></i>
          <small>This will download your profile photo from Microsoft and save it to your profile</small>
        </div>

        <div style="border-top: 1px solid #ddd; width: 100%; max-width: 500px; margin: 1rem 0;"></div>

        <button
          class="revert-btn"
          (click)="revertToDefault()"
          [disabled]="isSaving"
        >
          <i class="fa-solid fa-rotate-left"></i>
          @if (isSaving) {
            <span>Reverting...</span>
          } @else {
            <span>Revert to Default</span>
          }
        </button>

        <div class="provider-note">
          <i class="fa-solid fa-info-circle"></i>
          <small>Clears your avatar settings and restores the automatic sync from your auth provider</small>
        </div>
      </div>
    }
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button
      class="btn btn-secondary"
      (click)="cancel()"
      [disabled]="isSaving"
    >
      Cancel
    </button>
    <button
      class="btn btn-primary"
      (click)="save()"
      [disabled]="isSaving || selectedTab === 'provider'"
    >
      @if (isSaving) {
        <i class="fa-solid fa-spinner fa-spin"></i>
        <span>Saving...</span>
      } @else {
        <i class="fa-solid fa-save"></i>
        <span>Save Changes</span>
      }
    </button>
  </div>
</div>
