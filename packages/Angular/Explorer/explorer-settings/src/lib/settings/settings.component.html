<div class="mj-page-container">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container" role="status" aria-live="polite">
      <mj-loading text="Loading settings..."></mj-loading>
    </div>
  }

  <!-- Error State -->
  @if (error && !isLoading) {
    <div class="error-container" role="alert">
      <div class="error-content">
        <i class="fa-solid fa-exclamation-triangle error-icon" aria-hidden="true"></i>
        <p class="error-message">{{ error }}</p>
        <button class="retry-button" (click)="loadInitialData()">
          <i class="fa-solid fa-refresh" aria-hidden="true"></i>
          Try Again
        </button>
      </div>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading && !error) {
    <div class="settings-content">
      <!-- Desktop Layout -->
      @if (!isMobile) {
        <div class="desktop-layout" style="display: flex;">
          <!-- Side Navigation -->
          <nav class="side-navigation" role="navigation" aria-label="Settings navigation">
            <!-- Search Bar -->
            <div class="nav-search">
              <i class="fa-solid fa-search nav-search-icon" aria-hidden="true"></i>
              <input
                type="text"
                class="nav-search-input"
                placeholder="Search settings..."
                (input)="onSearchChange($event)"
                [value]="searchTerm$.value"
                aria-label="Search settings"
              />
              @if (searchTerm$.value) {
                <button
                  class="nav-search-clear"
                  (click)="clearSearch()"
                  aria-label="Clear search"
                  tabindex="0"
                >
                  <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                </button>
              }
            </div>

            <ul class="nav-list" role="tablist" aria-orientation="vertical">
              @for (tab of filteredTabs; track tab.id) {
                <li
                  class="nav-item"
                  [class.active]="activeTab === tab.id"
                  [class.disabled]="tab.disabled"
                  (click)="onTabChange(tab.id)"
                  (keydown.enter)="onTabChange(tab.id)"
                  role="tab"
                  [attr.aria-selected]="activeTab === tab.id"
                  [attr.aria-controls]="'panel-' + tab.id"
                  [attr.aria-disabled]="tab.disabled"
                  tabindex="0"
                >
                  <i [class]="tab.icon" aria-hidden="true"></i>
                  <span class="nav-label">{{ tab.label }}</span>
                  @if (tab.disabled) {
                    <span class="coming-soon-badge">Soon</span>
                  }
                  @if (tab.badgeCount && tab.badgeCount > 0) {
                    <span class="nav-badge" [class]="'badge-' + (tab.badgeColor || 'primary')">
                      {{ tab.badgeCount }}
                    </span>
                  }
                </li>
              }
            </ul>
          </nav>

          <!-- Content Area -->
          <div class="content-area" role="tabpanel" [attr.id]="'panel-' + activeTab">
            <div class="tab-content">
              @switch (activeTab) {
                @case ('general') {
                  <mj-general-settings></mj-general-settings>
                }

                @case ('notifications') {
                  <div class="notifications-settings">
                    <h2 class="section-title">Notifications</h2>
                    <p class="section-description">Configure how and when you receive notifications</p>
                    <mj-notification-preferences></mj-notification-preferences>
                  </div>
                }

                @case ('applications') {
                  <mj-application-settings></mj-application-settings>
                }

                @case ('keyboard-shortcuts') {
                  <mj-keyboard-shortcuts-settings></mj-keyboard-shortcuts-settings>
                }

                @case ('appearance') {
                  <mj-appearance-settings></mj-appearance-settings>
                }
              }
            </div>
          </div>
        </div>
      }

      <!-- Mobile Layout -->
      @if (isMobile) {
        <div class="mobile-layout">
          <!-- Mobile Header -->
          @if (!isMobileNavOpen) {
            <header class="mobile-header">
              <button
                class="mobile-header-icon"
                (click)="toggleMobileNav()"
                aria-label="Toggle navigation menu"
                [attr.aria-expanded]="isMobileNavOpen"
              >
                <i class="fa-solid fa-bars" aria-hidden="true"></i>
              </button>
              <h1 class="mobile-header-title">Settings</h1>
              <div class="mobile-header-spacer"></div>
            </header>
          }

          <!-- Backdrop Overlay -->
          @if (isMobileNavOpen) {
            <div
              class="mobile-nav-backdrop"
              (click)="closeMobileNav()"
              aria-hidden="true"
            ></div>
          }

          <!-- Mobile Navigation Rail -->
          <nav
            class="mobile-nav-rail"
            [class.open]="isMobileNavOpen"
            role="navigation"
            aria-label="Settings navigation"
          >
            <div class="nav-rail-header">
              <span class="nav-rail-title">Settings</span>
            </div>

            <div class="nav-rail-items" role="tablist">
              @for (tab of filteredTabs; track tab.id) {
                <button
                  class="nav-rail-item"
                  [class.active]="activeTab === tab.id"
                  [class.disabled]="tab.disabled"
                  [disabled]="tab.disabled"
                  (click)="onMobileTabChange(tab.id)"
                  role="tab"
                  [attr.aria-selected]="activeTab === tab.id"
                  [attr.aria-label]="tab.label"
                >
                  <i [class]="tab.icon" aria-hidden="true"></i>
                  <span class="nav-rail-label">{{ tab.label }}</span>
                  @if (tab.disabled) {
                    <span class="coming-soon-badge">Soon</span>
                  }
                  @if (tab.badgeCount && tab.badgeCount > 0) {
                    <span class="rail-badge" [class]="'badge-' + (tab.badgeColor || 'primary')">
                      {{ tab.badgeCount }}
                    </span>
                  }
                </button>
              }

              <button
                class="nav-rail-item nav-rail-close-item"
                (click)="closeSettings()"
                aria-label="Close settings"
              >
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                <span class="nav-rail-label">Close</span>
              </button>
            </div>
          </nav>

          <!-- Mobile Content Area -->
          <div class="mobile-content">
            <div class="tab-content">
              @switch (activeTab) {
                @case ('general') {
                  <mj-general-settings></mj-general-settings>
                }

                @case ('notifications') {
                  <div class="notifications-settings">
                    <h2 class="section-title">Notifications</h2>
                    <p class="section-description">Configure how and when you receive notifications</p>
                    <mj-notification-preferences></mj-notification-preferences>
                  </div>
                }

                @case ('applications') {
                  <mj-application-settings></mj-application-settings>
                }

                @case ('keyboard-shortcuts') {
                  <mj-keyboard-shortcuts-settings></mj-keyboard-shortcuts-settings>
                }

                @case ('appearance') {
                  <mj-appearance-settings></mj-appearance-settings>
                }
              }
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>
