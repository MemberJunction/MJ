<div class="application-management-container">
  <!-- Sticky Header Section -->
  <div class="sticky-header">
    <!-- Action Buttons -->
    <div class="action-buttons" role="toolbar" aria-label="Application management actions">
      <button
        class="mj-btn mj-btn-secondary mj-btn-icon-mobile"
        (click)="refreshData()"
        [disabled]="isLoading"
        aria-label="Refresh applications"
      >
        <i class="fa-solid fa-refresh" [class.fa-spin]="isLoading" aria-hidden="true"></i>
        <span class="btn-text">Refresh</span>
      </button>
      <button class="mj-btn mj-btn-primary mj-btn-icon-mobile" (click)="createNewApplication()" aria-label="Add new application">
        <i class="fa-solid fa-plus" aria-hidden="true"></i>
        <span class="btn-text">Add Application</span>
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="mj-grid-4" role="region" aria-label="Application statistics">
      <div class="mj-card">
        <div class="stat-icon stat-icon-total" aria-hidden="true">
          <i class="fa-solid fa-cubes"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value" aria-label="Total applications count">{{ stats.totalApplications }}</div>
          <div class="stat-label">Total Applications</div>
        </div>
      </div>

      <div class="mj-card">
        <div class="stat-icon stat-icon-active" aria-hidden="true">
          <i class="fa-solid fa-check-circle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value" aria-label="Active applications count">{{ stats.activeApplications }}</div>
          <div class="stat-label">Active Applications</div>
        </div>
      </div>

      <div class="mj-card">
        <div class="stat-icon stat-icon-entities" aria-hidden="true">
          <i class="fa-solid fa-database"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value" aria-label="Total entities count">{{ stats.totalEntities }}</div>
          <div class="stat-label">Total Entities</div>
        </div>
      </div>

      <div class="mj-card">
        <div class="stat-icon stat-icon-public" aria-hidden="true">
          <i class="fa-solid fa-globe"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value" aria-label="Public entities count">{{ stats.publicEntities }}</div>
          <div class="stat-label">Public Entities</div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section" role="search" aria-label="Filter applications">
      <div class="filters-row">
        <!-- Search - Enhanced prominent search box -->
        <div class="mj-search">
          <i class="fa-solid fa-search mj-search-icon" aria-hidden="true"></i>
          <input
            type="text"
            class="mj-search-input"
            placeholder="Search applications by name or description..."
            (input)="onSearchChange($event)"
            [value]="filters$.value.search"
            aria-label="Search applications"
          />
        </div>

        <!-- Status Filter -->
        <div class="mj-filter-group">
          <label class="mj-filter-label" id="status-filter-label">Status</label>
          <div class="mj-filter-buttons" role="group" aria-labelledby="status-filter-label">
            <button
              class="mj-btn mj-btn-ghost"
              [class.mj-btn-primary]="filters$.value.status === 'all'"
              (click)="onStatusFilterChange('all')"
              [attr.aria-pressed]="filters$.value.status === 'all'"
            >
              All
            </button>
            <button
              class="mj-btn mj-btn-ghost"
              [class.mj-btn-primary]="filters$.value.status === 'active'"
              (click)="onStatusFilterChange('active')"
              [attr.aria-pressed]="filters$.value.status === 'active'"
            >
              Active
            </button>
            <button
              class="mj-btn mj-btn-ghost"
              [class.mj-btn-primary]="filters$.value.status === 'inactive'"
              (click)="onStatusFilterChange('inactive')"
              [attr.aria-pressed]="filters$.value.status === 'inactive'"
            >
              Inactive
            </button>
          </div>
        </div>
      </div>
    </div>
  </div><!-- End Sticky Header -->

  <!-- Scrollable Content Section -->
  <div class="scrollable-content">
    <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container" role="status" aria-live="polite">
      <mj-loading text="Loading applications..."></mj-loading>
    </div>
  }

  <!-- Error State -->
  @if (error && !isLoading) {
    <div class="error-container" role="alert">
      <div class="error-content">
        <i class="fa-solid fa-exclamation-triangle error-icon" aria-hidden="true"></i>
        <p class="error-message">{{ error }}</p>
        <button class="mj-btn mj-btn-primary" (click)="loadInitialData()">
          <i class="fa-solid fa-refresh"></i>
          Try Again
        </button>
      </div>
    </div>
  }

  <!-- Content Area -->
  @if (!isLoading && !error) {
    <div class="content-area">
      <div class="applications-list" role="list">
        @for (app of filteredApplications; track app.ID) {
          <div class="app-card" [class.expanded]="isAppExpanded(app.ID)" role="listitem">
            <div class="app-header" (click)="toggleAppExpansion(app.ID)" role="button" [attr.aria-expanded]="isAppExpanded(app.ID)">
              <div class="app-info">
                <div class="app-icon-wrapper">
                  <i [class]="'fa-solid ' + getAppIcon(app)" aria-hidden="true"></i>
                </div>
                <div class="app-details">
                  <h3 class="app-name">{{ app.Name }}</h3>
                  <p class="app-description">{{ app.Description || 'No description available' }}</p>
                </div>
              </div>

              <div class="app-meta">
                <span class="status-badge" [class]="getAppStatusClass(app)">
                  {{ getAppStatusLabel(app) }}
                </span>
                <div class="app-actions" (click)="$event.stopPropagation()">
                  <button
                    class="mj-btn mj-btn-ghost mj-btn-sm"
                    (click)="editApplication(app)"
                    title="Edit"
                    [attr.aria-label]="'Edit ' + app.Name"
                  >
                    <i class="fa-solid fa-edit"></i>
                  </button>
                  <button
                    class="mj-btn mj-btn-ghost mj-btn-sm mj-btn-danger"
                    (click)="confirmDeleteApplication(app)"
                    title="Delete"
                    [attr.aria-label]="'Delete ' + app.Name"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
                <button class="expand-btn" aria-label="Toggle details">
                  <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
                </button>
              </div>
            </div>

            @if (isAppExpanded(app.ID)) {
              <div class="app-content">
                <!-- Mobile-only actions bar -->
                <div class="mobile-actions-bar" (click)="$event.stopPropagation()">
                  <span class="status-badge" [class]="getAppStatusClass(app)">
                    {{ getAppStatusLabel(app) }}
                  </span>
                  <div class="mobile-action-buttons">
                    <button
                      class="mj-btn mj-btn-ghost mj-btn-sm"
                      (click)="editApplication(app)"
                      title="Edit"
                      [attr.aria-label]="'Edit ' + app.Name"
                    >
                      <i class="fa-solid fa-edit"></i>
                      <span class="btn-label">Edit</span>
                    </button>
                    <button
                      class="mj-btn mj-btn-ghost mj-btn-sm mj-btn-danger"
                      (click)="confirmDeleteApplication(app)"
                      title="Delete"
                      [attr.aria-label]="'Delete ' + app.Name"
                    >
                      <i class="fa-solid fa-trash"></i>
                      <span class="btn-label">Delete</span>
                    </button>
                  </div>
                </div>

                <div class="app-stats">
                  <div class="stat-item">
                    <i class="fa-solid fa-database" aria-hidden="true"></i>
                    <span class="stat-label">Entities:</span>
                    <span class="stat-value">{{ getAppEntities(app.ID).length }}</span>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-calendar" aria-hidden="true"></i>
                    <span class="stat-label">Created:</span>
                    <span class="stat-value">{{ app.__mj_CreatedAt | date:'short' }}</span>
                  </div>
                  <div class="stat-item">
                    <i class="fa-solid fa-clock" aria-hidden="true"></i>
                    <span class="stat-label">Updated:</span>
                    <span class="stat-value">{{ app.__mj_UpdatedAt | date:'short' }}</span>
                  </div>
                </div>

                <div class="entities-section">
                  <h4 class="section-title">
                    <i class="fa-solid fa-database" aria-hidden="true"></i>
                    Application Entities
                  </h4>

                  @if (getAppEntities(app.ID).length > 0) {
                    <div class="entities-grid">
                      @for (appEntity of getAppEntities(app.ID); track appEntity.ID) {
                        @if (getEntityInfo(appEntity.EntityID); as entity) {
                          <div class="entity-item">
                            <div class="entity-name">{{ entity.Name }}</div>
                            <div class="entity-meta">
                              @if (appEntity.DefaultForNewUser) {
                                <span class="entity-badge public">Public</span>
                              }
                              <span class="entity-sequence">Order: {{ appEntity.Sequence }}</span>
                            </div>
                          </div>
                        }
                      }
                    </div>
                  } @else {
                    <p class="no-entities">No entities configured for this application</p>
                  }
                </div>
              </div>
            }
          </div>
        }

        @if (filteredApplications.length === 0) {
          <div class="empty-state">
            <i class="fa-solid fa-cubes empty-icon" aria-hidden="true"></i>
            <p class="empty-text">No applications found</p>
            <p class="empty-subtext">Try adjusting your filters or create a new application</p>
          </div>
        }
      </div>
    </div>
  }
  </div><!-- End Scrollable Content -->

  <!-- Application Dialog -->
  <mj-application-dialog
    [visible]="showApplicationDialog"
    [data]="applicationDialogData"
    (result)="onApplicationDialogResult($event)"
  ></mj-application-dialog>

  <!-- Delete Confirmation Dialog -->
  @if (showDeleteConfirm && selectedApp) {
    <div class="modal-backdrop" (click)="showDeleteConfirm = false" role="presentation">
      <div
        class="modal-dialog"
        (click)="$event.stopPropagation()"
        role="dialog"
        aria-modal="true"
        aria-labelledby="delete-dialog-title"
        aria-describedby="delete-dialog-description"
      >
        <div class="modal-header">
          <h3 class="modal-title" id="delete-dialog-title">
            <i class="fa-solid fa-exclamation-triangle text-danger" aria-hidden="true"></i>
            Confirm Delete
          </h3>
          <button
            class="modal-close"
            (click)="showDeleteConfirm = false"
            aria-label="Close dialog"
          >
            <i class="fa-solid fa-times" aria-hidden="true"></i>
          </button>
        </div>
        <div class="modal-body" id="delete-dialog-description">
          <p>Are you sure you want to delete the application <strong>{{ selectedApp.Name }}</strong>?</p>
          <p class="text-warning">
            <i class="fa-solid fa-warning" aria-hidden="true"></i>
            This will remove all entity associations for this application.
          </p>
        </div>
        <div class="modal-footer">
          <!-- Primary action (Delete) on LEFT per MD3 design guide -->
          <button class="mj-btn mj-btn-danger" (click)="deleteApplication()" [disabled]="isLoading">
            @if (isLoading) {
              <i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i>
              Deleting...
            } @else {
              <i class="fa-solid fa-trash" aria-hidden="true"></i>
              Delete Application
            }
          </button>
          <button class="mj-btn mj-btn-secondary" (click)="showDeleteConfirm = false">
            Cancel
          </button>
        </div>
      </div>
    </div>
  }
</div>
