@if (visible) {
  <div class="modal-backdrop" (click)="onCancel()" role="presentation">
    <div
      class="modal-dialog"
      [class.fullscreen]="isFullscreen"
      (click)="$event.stopPropagation()"
      role="dialog"
      aria-modal="true"
      aria-labelledby="application-dialog-title"
      aria-describedby="application-dialog-description"
    >
      <!-- Modal Header -->
      <div class="modal-header" [class.create-mode]="!isEditMode" [class.edit-mode]="isEditMode">
        <div class="modal-header-content">
          <h2 class="modal-title" id="application-dialog-title">
            <i class="fa-solid" [class.fa-plus]="!isEditMode" [class.fa-layer-group]="isEditMode" aria-hidden="true"></i>
            {{ isEditMode ? 'Edit Application' : 'Create New Application' }}
          </h2>
          <p class="modal-subtitle" id="application-dialog-description">
            {{ isEditMode ? 'Update application information and settings' : 'Add a new application to the system' }}
          </p>
        </div>
        <div class="modal-header-actions">
          <button
            class="modal-action-btn"
            (click)="toggleFullscreen()"
            [attr.aria-label]="isFullscreen ? 'Exit fullscreen' : 'Enter fullscreen'"
            type="button"
          >
            <i class="fa-solid" [class.fa-compress]="isFullscreen" [class.fa-expand]="!isFullscreen" aria-hidden="true"></i>
          </button>
          <button
            class="modal-close"
            (click)="onCancel()"
            aria-label="Close dialog"
            type="button"
          >
            <i class="fa-solid fa-times" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form [formGroup]="applicationForm" (ngSubmit)="onSubmit()">
          <!-- Error Alert -->
          @if (error) {
            <div class="form-section">
              <div class="alert alert-error" role="alert">
                <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>
                <div>{{ error }}</div>
              </div>
            </div>
          }

          <!-- Basic Information Section -->
          <fieldset class="form-section collapsible-section">
            <legend class="section-header clickable" (click)="toggleSection('basicInfo')">
              <div class="section-title-row">
                <span class="section-title">
                  <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
                  Application Information
                </span>
                <i class="fa-solid chevron-icon"
                   [class.fa-chevron-up]="sectionExpanded.basicInfo"
                   [class.fa-chevron-down]="!sectionExpanded.basicInfo"
                   aria-hidden="true"></i>
              </div>
              <span class="section-description">Define the application's basic properties</span>
            </legend>

            @if (sectionExpanded.basicInfo) {
              <div class="section-content">
                <div class="form-grid">
              <div class="form-field">
                <label class="field-label required" for="app-name">Application Name</label>
                <input
                  id="app-name"
                  type="text"
                  class="field-input"
                  formControlName="name"
                  placeholder="My Application"
                  [class.error]="applicationForm.get('name')?.invalid && applicationForm.get('name')?.touched"
                  [attr.aria-invalid]="applicationForm.get('name')?.invalid && applicationForm.get('name')?.touched"
                  aria-describedby="app-name-error"
                />
                @if (applicationForm.get('name')?.invalid && applicationForm.get('name')?.touched) {
                  <div class="field-error" id="app-name-error" role="alert">
                    <i class="fa-solid fa-exclamation-circle" aria-hidden="true"></i>
                    @if (applicationForm.get('name')?.errors?.['required']) {
                      Application name is required
                    }
                    @if (applicationForm.get('name')?.errors?.['maxlength']) {
                      Application name cannot exceed 100 characters
                    }
                  </div>
                }
              </div>

              <div class="form-field">
                <label class="field-label" for="app-description">Description</label>
                <textarea
                  id="app-description"
                  class="field-textarea"
                  formControlName="description"
                  placeholder="Describe the application's purpose and functionality..."
                  rows="4"
                ></textarea>
                <div class="field-hint">
                  Provide a clear description of what this application does and its main features.
                </div>
              </div>
            </div>
              </div>
            }
          </fieldset>

          <!-- Entity Management Section -->
          <fieldset class="form-section collapsible-section">
            <legend class="section-header clickable" (click)="toggleSection('entities')">
              <div class="section-title-row">
                <span class="section-title">
                  <i class="fa-solid fa-database" aria-hidden="true"></i>
                  Application Entities
                </span>
                <i class="fa-solid chevron-icon"
                   [class.fa-chevron-up]="sectionExpanded.entities"
                   [class.fa-chevron-down]="!sectionExpanded.entities"
                   aria-hidden="true"></i>
              </div>
              <span class="section-description">Manage which entities are included in this application</span>
            </legend>

            @if (sectionExpanded.entities) {
              <div class="section-content">
                <div class="form-grid">
              <!-- Assigned Entities -->
              @if (applicationEntities.length > 0) {
                <div class="assigned-entities">
                  <h4 class="subsection-title">Assigned Entities ({{ applicationEntities.length }})</h4>
                  <div class="entities-list"
                       role="list"
                       cdkDropList
                       (cdkDropListDropped)="onEntityDrop($event)">
                    @for (config of applicationEntities; track config.entity.ID; let i = $index) {
                      <div
                        class="entity-item"
                        [class.is-new]="config.isNew"
                        [class.has-changes]="config.hasChanges"
                        role="listitem"
                        cdkDrag
                      >
                        <i class="fa-solid fa-grip-vertical drag-handle" aria-hidden="true"></i>
                        <div class="entity-info">
                          <div class="entity-icon">
                            <i class="fa-solid fa-table" aria-hidden="true"></i>
                          </div>
                          <div class="entity-details">
                            <div class="entity-name">
                              {{ config.entity.Name }}
                              @if (config.entity.Description) {
                                <i
                                  class="fa-solid fa-info-circle entity-info-icon"
                                  [title]="config.entity.Description"
                                  [attr.aria-label]="'Entity description: ' + config.entity.Description"
                                ></i>
                              }
                            </div>
                          </div>
                        </div>

                        <div class="entity-config">
                          <div class="config-item">
                            <label class="config-label">
                              <input
                                type="checkbox"
                                [(ngModel)]="config.defaultForNewUser"
                                [ngModelOptions]="{standalone: true}"
                                (change)="onDefaultForNewUserChange(config)"
                                class="config-checkbox"
                              />
                              <span class="checkbox-text">Default for new users</span>
                            </label>
                          </div>
                          <div class="sequence-badge" [attr.aria-label]="'Sequence ' + config.sequence">{{ config.sequence }}</div>
                        </div>

                        <div class="entity-actions">
                          <button
                            type="button"
                            class="btn-icon btn-danger"
                            (click)="removeEntity(config)"
                            title="Remove entity"
                            [attr.aria-label]="'Remove ' + config.entity.Name"
                          >
                            <i class="fa-solid fa-times" aria-hidden="true"></i>
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              } @else {
                <div class="no-entities">
                  <i class="fa-solid fa-database" aria-hidden="true"></i>
                  <p>No entities assigned to this application</p>
                  <p class="empty-subtext">Add entities from the available list below</p>
                </div>
              }

              <!-- Available Entities -->
              @if (availableEntities.length > 0) {
                <div class="available-entities">
                  <div class="available-entities-header">
                    <h4 class="subsection-title">Available Entities ({{ filteredAvailableEntities.length }} of {{ availableEntities.length }})</h4>
                    <div class="entity-search">
                      <i class="fa-solid fa-search entity-search-icon" aria-hidden="true"></i>
                      <input
                        type="text"
                        class="entity-search-input"
                        placeholder="Search entities..."
                        [value]="entitySearchTerm"
                        (input)="onEntitySearchChange($event)"
                        aria-label="Search available entities"
                      />
                      @if (entitySearchTerm) {
                        <button
                          type="button"
                          class="entity-search-clear"
                          (click)="clearEntitySearch()"
                          aria-label="Clear search"
                        >
                          <i class="fa-solid fa-times" aria-hidden="true"></i>
                        </button>
                      }
                    </div>
                  </div>
                  @if (filteredAvailableEntities.length > 0) {
                    <div class="entities-grid" role="list">
                      @for (entity of filteredAvailableEntities; track entity.ID) {
                        <button
                          type="button"
                          class="entity-chip"
                          (click)="addEntity(entity)"
                          role="listitem"
                          [attr.aria-label]="'Add ' + entity.Name"
                        >
                          <div class="chip-content">
                            <i class="fa-solid fa-plus" aria-hidden="true"></i>
                            <span class="chip-name">{{ entity.Name }}</span>
                          </div>
                        </button>
                      }
                    </div>
                  } @else {
                    <div class="no-search-results">
                      <i class="fa-solid fa-search" aria-hidden="true"></i>
                      <p>No entities match "{{ entitySearchTerm }}"</p>
                    </div>
                  }
                </div>
              } @else {
                <div class="all-assigned">
                  <i class="fa-solid fa-check-circle" aria-hidden="true"></i>
                  <p>All entities have been assigned to this application</p>
                </div>
              }
                </div>
              </div>
            }
          </fieldset>

          <!-- System Information Section (Edit Mode Only) -->
          @if (isEditMode) {
            <fieldset class="form-section collapsible-section">
              <legend class="section-header clickable" (click)="toggleSection('systemInfo')">
                <div class="section-title-row">
                  <span class="section-title">
                    <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
                    System Information
                  </span>
                  <i class="fa-solid chevron-icon"
                     [class.fa-chevron-up]="sectionExpanded.systemInfo"
                     [class.fa-chevron-down]="!sectionExpanded.systemInfo"
                     aria-hidden="true"></i>
                </div>
                <span class="section-description">Application metadata and audit information</span>
              </legend>

              @if (sectionExpanded.systemInfo) {
                <div class="section-content">
                  <div class="form-grid">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">Created</span>
                    <span class="info-value">{{ data?.application?.__mj_CreatedAt | date:'medium' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Last Updated</span>
                    <span class="info-value">{{ data?.application?.__mj_UpdatedAt | date:'medium' }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Application ID</span>
                    <span class="info-value">{{ data?.application?.ID }}</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">Total Entities</span>
                    <span class="info-value">{{ applicationEntities.length }}</span>
                  </div>
                </div>
                  </div>
                </div>
              }
            </fieldset>
          }
        </form>
      </div>

      <!-- Modal Footer - Primary and Cancel buttons on RIGHT -->
      <div class="modal-footer">
        <button
          type="submit"
          class="mj-btn mj-btn-primary"
          [disabled]="applicationForm.invalid || isLoading"
          (click)="onSubmit()"
          [attr.aria-busy]="isLoading"
        >
          @if (isLoading) {
            <i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i>
            Saving...
          } @else {
            <i class="fa-solid fa-save" aria-hidden="true"></i>
            {{ isEditMode ? 'Update Application' : 'Create Application' }}
          }
        </button>
        <button type="button" class="mj-btn mj-btn-secondary" (click)="onCancel()">
          Cancel
        </button>
      </div>
    </div>
  </div>
}
