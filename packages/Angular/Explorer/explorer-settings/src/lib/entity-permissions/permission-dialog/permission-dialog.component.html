@if (visible) {
  <div class="modal-overlay" (click)="onCancel()">
    <div
      class="modal-dialog"
      role="dialog"
      aria-labelledby="dialog-title"
      aria-modal="true"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="header-content">
          <h2 id="dialog-title" class="dialog-title">
            <i class="fa-solid fa-key" aria-hidden="true"></i>
            Edit Entity Permissions
          </h2>
          <p class="dialog-subtitle">
            Configure role-based permissions for {{ data?.entity?.Name }}
          </p>
        </div>
        <button
          type="button"
          class="modal-close"
          (click)="onCancel()"
          aria-label="Close dialog"
          title="Close"
        >
          <i class="fa-solid fa-times" aria-hidden="true"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <form [formGroup]="permissionForm" (ngSubmit)="onSubmit()">
          <!-- Loading State -->
          @if (isLoading) {
            <mj-loading text="Loading permission data..." size="small"></mj-loading>
          }

          <!-- Error Alert -->
          @if (error) {
            <div class="alert alert-error" role="alert">
              <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>
              <div>{{ error }}</div>
            </div>
          }

          @if (!isLoading) {
            <!-- Entity Information Section -->
            <section class="content-section" aria-labelledby="entity-info-heading">
              <div class="form-section">
                <div class="section-header">
                  <h3 id="entity-info-heading" class="section-title">
                    <i class="fa-solid fa-database" aria-hidden="true"></i>
                    Entity Information
                  </h3>
                  <p class="section-description">{{ data?.entity?.Description || 'Entity permissions configuration' }}</p>
                </div>

                <div class="entity-info-card">
                  <div class="entity-meta">
                    <div class="meta-item">
                      <i class="fa-solid fa-table" aria-hidden="true"></i>
                      <span class="meta-label">Entity:</span>
                      <span class="meta-value">{{ data?.entity?.Name }}</span>
                    </div>
                    <div class="meta-item">
                      <i class="fa-solid fa-key" aria-hidden="true"></i>
                      <span class="meta-label">Total Permissions:</span>
                      <span class="meta-value">{{ rolePermissions.length }}</span>
                    </div>
                    <div class="meta-item">
                      <i class="fa-solid fa-clock" aria-hidden="true"></i>
                      <span class="meta-label">Last Updated:</span>
                      <span class="meta-value">{{ data?.entity?.__mj_UpdatedAt | date:'medium' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- Permissions Configuration Section -->
            <section class="content-section" aria-labelledby="role-permissions-heading">
              <div class="form-section">
                <div class="section-header">
                  <h3 id="role-permissions-heading" class="section-title">
                    <i class="fa-solid fa-users-cog" aria-hidden="true"></i>
                    Role Permissions
                  </h3>
                  <p class="section-description">Configure CRUD permissions for each role</p>
                </div>

                <div class="permissions-table-container">
                  <table class="permissions-table" role="table" aria-label="Role permissions">
                    <thead role="rowgroup">
                      <tr role="row">
                        <th class="role-column" scope="col" role="columnheader">Role</th>
                        <th class="permission-column" scope="col" role="columnheader">
                          <i class="fa-solid fa-plus" aria-hidden="true"></i>
                          Create
                        </th>
                        <th class="permission-column" scope="col" role="columnheader">
                          <i class="fa-solid fa-eye" aria-hidden="true"></i>
                          Read
                        </th>
                        <th class="permission-column" scope="col" role="columnheader">
                          <i class="fa-solid fa-edit" aria-hidden="true"></i>
                          Update
                        </th>
                        <th class="permission-column" scope="col" role="columnheader">
                          <i class="fa-solid fa-trash" aria-hidden="true"></i>
                          Delete
                        </th>
                        <th class="actions-column" scope="col" role="columnheader">Actions</th>
                      </tr>
                    </thead>
                    <tbody role="rowgroup">
                      @for (rolePermission of rolePermissions; track rolePermission.roleId) {
                        <tr
                          class="permission-row"
                          [class.has-changes]="hasEntityChanges(rolePermission)"
                          [class.is-new]="rolePermission.isNew"
                          role="row"
                        >
                          <td class="role-name" role="cell">
                            <div class="role-info">
                              <i class="fa-solid fa-shield-halved" aria-hidden="true"></i>
                              <span>{{ rolePermission.roleName }}</span>
                              @if (rolePermission.isNew) {
                                <span class="new-badge" aria-label="New permission">New</span>
                              }
                              @if (hasEntityChanges(rolePermission) && !rolePermission.isNew) {
                                <span class="changed-badge" aria-label="Modified permission">Modified</span>
                              }
                            </div>
                          </td>
                          <td class="permission-cell" role="cell">
                            <div class="permission-toggle">
                              <input
                                type="checkbox"
                                [id]="'create-' + rolePermission.roleId"
                                [(ngModel)]="rolePermission.entityPermission.CanCreate"
                                [ngModelOptions]="{standalone: true}"
                                class="permission-checkbox"
                                [attr.aria-label]="'Allow ' + rolePermission.roleName + ' to create'"
                              />
                              <label [for]="'create-' + rolePermission.roleId" class="permission-label">
                                <div class="checkbox-indicator"></div>
                              </label>
                            </div>
                          </td>
                          <td class="permission-cell" role="cell">
                            <div class="permission-toggle">
                              <input
                                type="checkbox"
                                [id]="'read-' + rolePermission.roleId"
                                [(ngModel)]="rolePermission.entityPermission.CanRead"
                                [ngModelOptions]="{standalone: true}"
                                class="permission-checkbox"
                                [attr.aria-label]="'Allow ' + rolePermission.roleName + ' to read'"
                              />
                              <label [for]="'read-' + rolePermission.roleId" class="permission-label">
                                <div class="checkbox-indicator"></div>
                              </label>
                            </div>
                          </td>
                          <td class="permission-cell" role="cell">
                            <div class="permission-toggle">
                              <input
                                type="checkbox"
                                [id]="'update-' + rolePermission.roleId"
                                [(ngModel)]="rolePermission.entityPermission.CanUpdate"
                                [ngModelOptions]="{standalone: true}"
                                class="permission-checkbox"
                                [attr.aria-label]="'Allow ' + rolePermission.roleName + ' to update'"
                              />
                              <label [for]="'update-' + rolePermission.roleId" class="permission-label">
                                <div class="checkbox-indicator"></div>
                              </label>
                            </div>
                          </td>
                          <td class="permission-cell" role="cell">
                            <div class="permission-toggle">
                              <input
                                type="checkbox"
                                [id]="'delete-' + rolePermission.roleId"
                                [(ngModel)]="rolePermission.entityPermission.CanDelete"
                                [ngModelOptions]="{standalone: true}"
                                class="permission-checkbox"
                                [attr.aria-label]="'Allow ' + rolePermission.roleName + ' to delete'"
                              />
                              <label [for]="'delete-' + rolePermission.roleId" class="permission-label">
                                <div class="checkbox-indicator"></div>
                              </label>
                            </div>
                          </td>
                          <td class="actions-cell" role="cell">
                            <button
                              type="button"
                              class="btn-icon btn-danger"
                              (click)="removeRolePermission(rolePermission)"
                              [attr.aria-label]="'Remove permissions for ' + rolePermission.roleName"
                              title="Remove permissions for this role"
                            >
                              <i class="fa-solid fa-times" aria-hidden="true"></i>
                            </button>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>

                  @if (rolePermissions.length === 0) {
                    <div class="empty-permissions" role="status">
                      <i class="fa-solid fa-shield-halved empty-icon" aria-hidden="true"></i>
                      <p>No role permissions configured</p>
                      <p class="empty-subtext">Add permissions for specific roles to control access to this entity</p>
                    </div>
                  }
                </div>

                <!-- Add Role Permissions -->
                <div class="add-role-section">
                  <div class="add-role-header">
                    <h4>Add Role Permissions</h4>
                    <p>Select roles to configure permissions for this entity</p>
                  </div>
                  <div class="available-roles" role="group" aria-label="Available roles to add">
                    @for (role of availableRoles; track role.ID) {
                      <button
                        type="button"
                        class="role-chip"
                        (click)="addRolePermission(role)"
                        [attr.aria-label]="'Add permissions for ' + role.Name"
                        title="Add permissions for {{ role.Name }}"
                      >
                        <i class="fa-solid fa-plus" aria-hidden="true"></i>
                        {{ role.Name }}
                      </button>
                    }
                    @if (availableRoles.length === 0) {
                      <p class="no-available-roles" role="status">All roles have been configured</p>
                    }
                  </div>
                </div>
              </div>
            </section>
          }

          <!-- Modal Footer -->
          <div class="modal-footer">
            <div class="footer-info">
              @if (hasChanges) {
                <span class="changes-indicator" role="status">
                  <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>
                  You have unsaved changes
                </span>
              }
            </div>
            <div class="footer-actions">
              <button
                type="button"
                class="btn-secondary"
                (click)="onCancel()"
                aria-label="Cancel and close dialog"
              >
                <i class="fa-solid fa-times" aria-hidden="true"></i>
                Cancel
              </button>
              <button
                type="submit"
                class="btn-primary"
                [disabled]="!hasChanges || isSaving"
                [attr.aria-label]="isSaving ? 'Saving permissions' : 'Save permission changes'"
              >
                @if (isSaving) {
                  <i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i>
                  Saving...
                } @else {
                  <i class="fa-solid fa-save" aria-hidden="true"></i>
                  Save Permissions
                }
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
}
