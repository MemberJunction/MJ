<div class="mj-page-container">
  <div class="mj-content-container">
    
    <!-- Header Section -->
    <div class="mj-header">
      <div class="mj-header-title">
        @if(selectedFolderID){
          <span title="Back to Parent" class="mj-btn-icon-only" (click)="goToParent()">
            <span class="fa-solid fa-arrow-left"></span>
          </span>
          <div class="mj-header-icon">
            <span class="fa-regular fa-folder"></span>
          </div>
        }
        <div>
          <h1>{{title}}</h1>
          @if(selectedFolderID){
            <div class="mj-header-subtitle">
              <span class="fa-solid fa-folder-open"></span>
              Current Folder
            </div>
          }
        </div>
      </div>
      
      <div class="mj-header-actions">
        <kendo-dropdownbutton 
          class="mj-btn-primary" 
          (itemClick)="onDropdownItemClick($event)" 
          [data]="dropdownOptions" 
          themeColor="primary">
          <span class="fa-solid fa-plus mj-btn-icon"></span>
          <span class="mj-btn-text">Create New</span>
        </kendo-dropdownbutton>
      </div>
    </div>

    <!-- Toolbar Section -->
    <div class="mj-toolbar">
      <div class="mj-search">
        <kendo-textbox 
          class="mj-search-input"
          type="text" 
          #searchInput 
          placeholder="Search items..." 
          (keyup)="onKeyup(searchInput.value)"
          [clearButton]="true"
          size="large"
          rounded="large"
          fillMode="solid">
          <ng-template kendoTextBoxPrefixTemplate>
            <span class="fa-solid fa-magnifying-glass mj-search-icon"></span>
          </ng-template>
        </kendo-textbox>
      </div>
      
      <div class="mj-toolbar-actions">
        <button 
          class="mj-btn-icon-only" 
          [class.mj-btn-primary]="displayAsGrid"
          (click)="changeViewMode('grid')" 
          title="Grid View">
          <span class="fa-solid fa-bars mj-btn-icon"></span>
        </button>
        <button 
          class="mj-btn-icon-only"
          [class.mj-btn-primary]="!displayAsGrid" 
          (click)="changeViewMode('list')" 
          title="Card View">
          <span class="fa-solid fa-table-cells-large mj-btn-icon"></span>
        </button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-area">
      <!-- Loading State -->
      <div class="mj-loading" *ngIf="showLoader">
        <kendo-loader type="converging-spinner"></kendo-loader>
      </div>
      
      @if(!showLoader){
        <!-- Grid View -->
        @if(displayAsGrid){
          <kendo-grid 
            class="mj-grid-table"
            (cellClick)="onCellItemClicked($event)" 
            [kendoGridBinding]="items">
            <kendo-grid-column field="Name" title="Name"></kendo-grid-column>
            <kendo-grid-column field="Size" title="Size"></kendo-grid-column>
            <kendo-grid-column field="LastOpened" title="Last Opened"></kendo-grid-column>
            <kendo-grid-column field="ModifiedBy" title="Modified By"></kendo-grid-column>
            <kendo-grid-column title="Actions">
              <ng-template kendoGridCellTemplate let-dataItem>
                <div class="mj-toolbar-actions">
                  @if(!disableEditButton && (!dataItem.IsLink || dataItem.LinkPermissionLevel === 'Owner' || dataItem.LinkPermissionLevel === 'Edit')) {
                    <button class="mj-btn-icon-only mj-btn-sm" (click)="editItem(dataItem)" title="Edit Item">
                      <span class="fa-regular fa-pen-to-square"></span>
                    </button>
                  }
                  @if(!dataItem.IsLink || dataItem.LinkPermissionLevel === 'Owner') {
                    <button class="mj-btn-icon-only mj-btn-sm" (click)="deleteItem(dataItem)" title="Delete Item">
                      <span class="fa-regular fa-trash-can"></span>
                    </button>
                  }
                  @else if (dataItem.IsLink) {
                    <button class="mj-btn-icon-only mj-btn-sm" (click)="unlinkItem(dataItem)" title="Remove Link">
                      <span class="fa-solid fa-link-slash"></span>
                    </button>
                  }
                </div>
              </ng-template>
            </kendo-grid-column>
          </kendo-grid>
        }
        
        <!-- Card View -->
        @else{
          <!-- Empty State -->
          @if(items.length === 0){
            <div class="mj-empty-state">
              <div class="mj-empty-icon">
                <span class="fa-regular fa-folder-open"></span>
              </div>
              <h3>No items found</h3>
              <p>This folder is empty or no items match your search criteria.</p>
              <button class="mj-btn-primary" (click)="onDropdownItemClick({text: 'Folder'})">
                <span class="fa-solid fa-plus mj-btn-icon"></span>
                Create Your First Item
              </button>
            </div>
          }
          
          <!-- Cards Grid -->
          @else{
            <div class="mj-grid-responsive">
              @for(item of items; track item){
                <div class="mj-card mj-grid-item" (click)="itemClick(item)">
                  
                  <!-- Card Actions -->
                  <div class="mj-card-actions">
                    @if(!disableEditButton && (!item.IsLink || item.LinkPermissionLevel === 'Owner' || item.LinkPermissionLevel === 'Edit')) {
                      <button class="mj-btn-icon-only mj-btn-sm" (click)="editItem(item); $event.stopPropagation()" title="Edit Item">
                        <span class="fa-regular fa-pen-to-square"></span>
                      </button>
                    }
                    @if(!item.IsLink || item.LinkPermissionLevel === 'Owner') {
                      <button class="mj-btn-icon-only mj-btn-sm" (click)="deleteItem(item); $event.stopPropagation()" title="Delete Item">
                        <span class="fa-regular fa-trash-can"></span>
                      </button>
                    }
                    @else if (item.IsLink) {
                      <button class="mj-btn-icon-only mj-btn-sm" (click)="unlinkItem(item); $event.stopPropagation()" title="Remove Link">
                        <span class="fa-solid fa-link-slash"></span>
                      </button>
                    }
                  </div>
                  
                  <!-- Card Body -->
                  <div class="mj-card-body">
                    <div class="view-card-content">
                      @if(item.IsLink) {
                        <div class="icon" [title]="item.Name + ' (Shared)'">
                          <span [ngClass]="getIconForResourceType(item)" style="color: var(--mj-blue);"></span>
                          <span class="fa-solid fa-link" style="position: absolute; bottom: 0; right: 0; font-size: 0.8em;"></span>
                        </div>
                      }
                      @else {
                        <div class="icon" [title]="item.Name">
                          <span [ngClass]="getIconForResourceType(item)"></span>
                        </div>
                      }
                      
                      <h2>{{ item.Name }}</h2>
                      <p>{{ item.Description || 'No description available' }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        }
      }
    </div>
  </div>

  <!-- Delete Confirmation Dialog -->
  <kendo-dialog 
    [minWidth]="400"
    [width]="500"
    class="mj-dialog-confirm" 
    title="Confirm Action" 
    *ngIf="deleteDialogOpened" 
    (close)="onConfirmDeleteItem(false)">
    
    <div class="mj-dialog-content">
      <div class="mj-dialog-icon">
        <span class="fa-solid fa-triangle-exclamation"></span>
      </div>
      <p>
        Are you sure you want to 
        <strong>{{(selectedItem?.IsLink && selectedItem?.LinkPermissionLevel === 'Owner') || !selectedItem?.IsLink ? 'delete' : 'unlink'}}</strong> 
        <strong>{{selectedItem?.Name}}</strong>?
      </p>
      @if((selectedItem?.IsLink && selectedItem?.LinkPermissionLevel === 'Owner') || !selectedItem?.IsLink){
        <p class="mj-dialog-warning">This action cannot be undone.</p>
      }
    </div>
    
    <kendo-dialog-actions class="mj-dialog-actions">
      <button class="mj-btn-secondary" (click)="onConfirmDeleteItem(false)">
        Cancel
      </button>
      <button class="mj-btn-primary" (click)="onConfirmDeleteItem(true)">
        {{(selectedItem?.IsLink && selectedItem?.LinkPermissionLevel === 'Owner') || !selectedItem?.IsLink ? 'Delete' : 'Unlink'}}
      </button>
    </kendo-dialog-actions>
  </kendo-dialog>

  <!-- Create Folder Dialog -->
  <kendo-dialog 
    title="Create New Folder" 
    *ngIf="createFolderDialogOpened" 
    (close)="toggleCreateFolderView()"
    [minWidth]="350"
    [width]="450"
    class="mj-dialog-form">
    
    <div class="mj-dialog-content">
      <div class="mj-search">
        <kendo-textbox 
          class="mj-search-input"
          placeholder="Enter folder name..." 
          (valueChange)="onCreateFolderKeyup($event)">
          <ng-template kendoTextBoxPrefixTemplate>
            <span class="fa-solid fa-folder mj-search-icon"></span>
          </ng-template>
        </kendo-textbox>
      </div>
    </div>
    
    <kendo-dialog-actions class="mj-dialog-actions">
      <button class="mj-btn-secondary" (click)="toggleCreateFolderView()">
        Cancel
      </button>
      <button class="mj-btn-primary" (click)="createFolder()">
        <span class="fa-solid fa-plus mj-btn-icon"></span>
        Create Folder
      </button>
    </kendo-dialog-actions>
  </kendo-dialog>

  <!-- Entity Form Dialog -->
  <mj-entity-form-dialog
    #entityFormDialog
    Mode="complete">
  </mj-entity-form-dialog>
</div>