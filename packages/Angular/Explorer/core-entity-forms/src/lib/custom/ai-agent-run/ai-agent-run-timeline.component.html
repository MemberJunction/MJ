@if (!loading && (timelineItems$ | async); as items) {
  <div class="timeline-container">
    @if (items.length > 0) {
      <div class="timeline">
        @for (item of items; track trackByItemId($index, item)) {
          <!-- Main Timeline Item -->
          <mj-ai-agent-run-step-node
            [item]="item"
            [isSelected]="selectedItem?.id === item.id"
            (itemClick)="selectItem(item)"
            (expandToggle)="toggleItemExpansion(item, $event)"
            (navigateToEntity)="navigateToEntity.emit($event)">
          </mj-ai-agent-run-step-node>
          <!-- Children Container (for both Sub-Agent and ParentID relationships) -->
          @if (item.isExpanded) {
            <!-- Show loading indicator while loading Sub-Agent children -->
            @if (item.type === 'step' && item.data?.StepType === 'Sub-Agent' && !item.childrenLoaded) {
              <div class="loading-children">
                <i class="fas fa-spinner fa-spin"></i> Loading sub-agent steps...
              </div>
            }
            <!-- Show no children message for Sub-Agents -->
            @if (item.type === 'step' && item.data?.StepType === 'Sub-Agent' && item.childrenLoaded && item.hasNoChildren) {
              <div class="no-children">
                <i class="fas fa-info-circle"></i> No sub-agent steps found
              </div>
            }
            <!-- Render children recursively (works for both Sub-Agent and ParentID children) -->
            @if (item.children && item.children.length > 0) {
              <ng-container *ngTemplateOutlet="recursiveSteps; context: { $implicit: item.children }"></ng-container>
            }
            <!-- For actual sub-run items (from the initial load) - legacy support -->
            @if (item.type === 'subrun' && item.data?.ID) {
              <mj-ai-agent-run-timeline
                [aiAgentRunId]="item.data.ID"
                [dataHelper]="createSubRunDataHelper()"
                [autoRefresh]="false"
                (itemSelected)="selectItem($event)"
                (navigateToEntity)="navigateToEntity.emit($event)">
              </mj-ai-agent-run-timeline>
            }
          }
        }
      </div>
    }
    @if (items.length === 0) {
      <div class="empty-state">
        <i class="fas fa-stream fa-3x"></i>
        <p>No execution steps found</p>
      </div>
    }
  </div>
}

@if (loading) {
  <div class="loading-state">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading timeline...</p>
  </div>
}

@if (error) {
  <div class="error-state">
    <i class="fas fa-exclamation-triangle fa-2x"></i>
    <p>{{ error }}</p>
  </div>
}

<!-- Recursive template for rendering nested children (ParentID relationships) -->
<ng-template #recursiveSteps let-steps>
  @for (step of steps; track trackByItemId($index, step)) {
    <mj-ai-agent-run-step-node
      [item]="step"
      [isSelected]="selectedItem?.id === step.id"
      (itemClick)="selectItem(step)"
      (expandToggle)="toggleItemExpansion(step, $event)"
      (navigateToEntity)="navigateToEntity.emit($event)">
    </mj-ai-agent-run-step-node>
    <!-- Recursively render this step's children if expanded -->
    @if (step.isExpanded && step.children && step.children.length > 0) {
      <ng-container *ngTemplateOutlet="recursiveSteps; context: { $implicit: step.children }"></ng-container>
    }
  }
</ng-template>