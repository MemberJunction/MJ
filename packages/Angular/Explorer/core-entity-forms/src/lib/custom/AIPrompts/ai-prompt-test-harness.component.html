<kendo-dialog [width]="1200" [height]="800" *ngIf="isVisible" [title]="'AI Prompt Test Harness - ' + (aiPrompt?.Name || 'Untitled')" (close)="close()">
    <div class="test-harness-container">
        <!-- Main Layout -->
        <div class="harness-layout">
            <!-- Sidebar -->
            <div class="harness-sidebar" [class.collapsed]="!showVariablesPanel">
                <div class="sidebar-header">
                    <kendo-buttongroup>
                        <button kendoButton [selected]="activeTab === 'variables'" (click)="selectTab('variables')">
                            <i class="fa-solid fa-sliders"></i>
                            <span *ngIf="showVariablesPanel">Variables</span>
                        </button>
                        <button kendoButton [selected]="activeTab === 'savedConversations'" (click)="selectTab('savedConversations')">
                            <i class="fa-solid fa-save"></i>
                            <span *ngIf="showVariablesPanel">Saved</span>
                        </button>
                        <button kendoButton [selected]="activeTab === 'settings'" (click)="selectTab('settings')">
                            <i class="fa-solid fa-cog"></i>
                            <span *ngIf="showVariablesPanel">Settings</span>
                        </button>
                    </kendo-buttongroup>
                    
                    <button kendoButton [icon]="showVariablesPanel ? 'chevron-left' : 'chevron-right'" 
                            (click)="toggleVariablesPanel()" 
                            [title]="showVariablesPanel ? 'Hide Panel' : 'Show Panel'"
                            look="flat">
                    </button>
                </div>
                
                <div class="sidebar-content" *ngIf="showVariablesPanel">
                    <!-- Variables Tab -->
                    <div *ngIf="activeTab === 'variables'" class="tab-panel">
                        <div class="panel-header">
                            <h5>Template Variables</h5>
                            <button kendoButton size="small" themeColor="primary" (click)="addVariable()">
                                <i class="fa-solid fa-plus"></i> Add Variable
                            </button>
                        </div>
                        
                        <div class="variables-list">
                            <div class="info-message" *ngIf="templateVariables.length === 0">
                                <i class="fa-solid fa-info-circle"></i>
                                <p>No variables defined. Add variables to customize your prompt.</p>
                            </div>
                            
                            @for (variable of templateVariables; track $index) {
                                <div class="variable-item">
                                    <div class="variable-header">
                                        <kendo-textbox [(ngModel)]="variable.name" 
                                                      placeholder="Variable name"
                                                      [disabled]="isExecuting"
                                                      style="flex: 1;">
                                        </kendo-textbox>
                                        
                                        <kendo-dropdownlist [(ngModel)]="variable.type"
                                                           [data]="['string', 'number', 'boolean', 'object', 'array']"
                                                           [valuePrimitive]="true"
                                                           [disabled]="isExecuting"
                                                           style="width: 100px;">
                                        </kendo-dropdownlist>
                                        
                                        <button kendoButton icon="trash" look="flat" themeColor="error"
                                                (click)="removeVariable($index)"
                                                [disabled]="isExecuting"
                                                title="Remove variable">
                                        </button>
                                    </div>
                                    
                                    <div class="variable-value">
                                        @if (variable.type === 'boolean') {
                                            <kendo-switch [(ngModel)]="variable.value"
                                                         [disabled]="isExecuting">
                                            </kendo-switch>
                                        } @else if (variable.type === 'object' || variable.type === 'array') {
                                            <kendo-textarea [(ngModel)]="variable.value"
                                                           placeholder="Enter JSON..."
                                                           [disabled]="isExecuting"
                                                           style="width: 100%; min-height: 60px;">
                                            </kendo-textarea>
                                        } @else {
                                            <kendo-textbox [(ngModel)]="variable.value"
                                                          placeholder="Enter value..."
                                                          [disabled]="isExecuting"
                                                          style="width: 100%;">
                                            </kendo-textbox>
                                        }
                                    </div>
                                    
                                    @if (variable.description) {
                                        <div class="variable-description">
                                            {{ variable.description }}
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                        
                        <div class="panel-footer">
                            <button kendoButton themeColor="info" (click)="previewRenderedPrompt()"
                                    [disabled]="isExecuting"
                                    style="width: 100%;">
                                <i class="fa-solid fa-eye"></i> Preview Rendered Prompt
                            </button>
                        </div>
                    </div>
                    
                    <!-- Saved Conversations Tab -->
                    <div *ngIf="activeTab === 'savedConversations'" class="tab-panel">
                        <div class="panel-header">
                            <h5>Saved Conversations</h5>
                        </div>
                        
                        <div class="saved-list">
                            <div class="info-message" *ngIf="savedConversations.length === 0">
                                <i class="fa-solid fa-inbox"></i>
                                <p>No saved conversations yet.</p>
                            </div>
                            
                            @for (conversation of savedConversations; track conversation.id) {
                                <div class="saved-item" (click)="loadConversation(conversation)">
                                    <div class="saved-header">
                                        <span class="saved-name">{{ conversation.name }}</span>
                                        <button kendoButton icon="trash" look="flat" size="small"
                                                (click)="deleteConversation(conversation, $event)"
                                                title="Delete conversation">
                                        </button>
                                    </div>
                                    <div class="saved-meta">
                                        <span>{{ conversation.messages.length }} messages</span>
                                        <span>{{ formatTimestamp(conversation.updatedAt) }}</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div *ngIf="activeTab === 'settings'" class="tab-panel">
                        <div class="panel-header">
                            <h5>Execution Settings</h5>
                        </div>
                        
                        <div class="settings-content">
                            <div class="form-group">
                                <label>AI Model</label>
                                <kendo-dropdownlist [(ngModel)]="selectedModelId"
                                                   [data]="availableModels"
                                                   textField="Name"
                                                   valueField="ID"
                                                   [valuePrimitive]="true"
                                                   [disabled]="isExecuting"
                                                   style="width: 100%;">
                                </kendo-dropdownlist>
                            </div>
                            
                            <div class="form-group">
                                <label>Prompt Info</label>
                                <div class="info-box">
                                    <div class="info-item">
                                        <span class="info-label">Name:</span>
                                        <span class="info-value">{{ aiPrompt?.Name || 'N/A' }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Category:</span>
                                        <span class="info-value">{{ aiPrompt?.Category || 'N/A' }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Status:</span>
                                        <span class="info-value status-badge" [class]="'status-' + (aiPrompt?.Status || '').toLowerCase()">
                                            {{ aiPrompt?.Status || 'N/A' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="harness-main">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-info">
                        <h4>{{ aiPrompt?.Name || 'Untitled Prompt' }}</h4>
                        <span class="model-info" *ngIf="selectedModelId">
                            Using: {{ getModelName(selectedModelId) }}
                        </span>
                    </div>
                    
                    <div class="chat-actions">
                        <button kendoButton (click)="clearConversation()" 
                                [disabled]="conversationMessages.length === 0 || isExecuting"
                                title="Clear conversation">
                            <i class="fa-solid fa-broom"></i> Clear
                        </button>
                        
                        <button kendoButton (click)="saveConversation()"
                                [disabled]="conversationMessages.length === 0 || isExecuting"
                                title="Save conversation">
                            <i class="fa-solid fa-save"></i> Save
                        </button>
                        
                        <kendo-splitbutton [data]="[
                            { text: 'Export', icon: 'fa fa-download' },
                            { text: 'Import', icon: 'fa fa-upload' }
                        ]" (itemClick)="$event.text === 'Export' ? exportConversation() : importConversation()">
                            <i class="fa-solid fa-file-arrow-down"></i> Export/Import
                        </kendo-splitbutton>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="messages-container" #messagesContainer>
                    <div class="messages-list">
                        <div class="info-message welcome-message" *ngIf="conversationMessages.length === 0">
                            <i class="fa-solid fa-comment-dots"></i>
                            <h4>Welcome to the Prompt Test Harness</h4>
                            <p>Configure your template variables and send a message to test your prompt.</p>
                        </div>
                        
                        @for (message of conversationMessages; track message.id) {
                            <div [class]="getMessageClass(message)">
                                <div class="message-header">
                                    <span class="message-role">
                                        @if (message.role === 'user') {
                                            <i class="fa-solid fa-user"></i> You
                                        } @else if (message.role === 'assistant') {
                                            <i class="fa-solid fa-robot"></i> Assistant
                                        } @else {
                                            <i class="fa-solid fa-cog"></i> System
                                        }
                                    </span>
                                    <span class="message-time">{{ formatTimestamp(message.timestamp) }}</span>
                                    @if (message.isStreaming && message.elapsedTime !== undefined) {
                                        <span class="execution-time streaming">
                                            <i class="fa-solid fa-spinner fa-spin"></i> {{ formatElapsedTime(message.elapsedTime) }}
                                        </span>
                                    } @else if (message.executionTime) {
                                        <span class="execution-time">{{ formatExecutionTime(message.executionTime) }}</span>
                                    }
                                    @if (message.rawContent && !message.isStreaming) {
                                        <button class="raw-toggle" (click)="toggleRawView(message)" title="Toggle raw/formatted view">
                                            <i class="fa-solid" [class.fa-code]="!message.showRaw" [class.fa-eye]="message.showRaw"></i>
                                        </button>
                                    }
                                    @if (message.renderedPrompt) {
                                        <button kendoButton size="small" look="flat" 
                                                (click)="showRenderedPromptInMessage(message)"
                                                title="View rendered prompt">
                                            <i class="fa-solid fa-code"></i>
                                        </button>
                                    }
                                </div>
                                
                                <div class="message-content" [class.raw-view]="message.showRaw">
                                    @if (message.isStreaming) {
                                        <div class="streaming-wrapper">
                                            <span class="streaming-content">{{ message.streamingContent }}<span class="cursor">|</span></span>
                                        </div>
                                    } @else {
                                        <div [innerHTML]="getFormattedContent(message)"></div>
                                    }
                                    
                                    @if (message.error) {
                                        <div class="error-info">
                                            <i class="fa-solid fa-exclamation-triangle"></i>
                                            Error: {{ message.error }}
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <kendo-textarea [(ngModel)]="currentUserMessage"
                                       placeholder="Type your message here..."
                                       [disabled]="isExecuting || !selectedModelId"
                                       (keydown)="handleKeyPress($event)"
                                       [rows]="3"
                                       style="flex: 1;">
                        </kendo-textarea>
                        
                        <button kendoButton themeColor="primary" size="large"
                                (click)="sendMessage()"
                                [disabled]="isExecuting || !currentUserMessage.trim() || !selectedModelId">
                            @if (isExecuting) {
                                <i class="fa-solid fa-spinner fa-spin"></i> Sending...
                            } @else {
                                <i class="fa-solid fa-paper-plane"></i> Send
                            }
                        </button>
                    </div>
                    
                    <div class="input-hint" *ngIf="!selectedModelId">
                        <i class="fa-solid fa-info-circle"></i>
                        Please select an AI model in the settings tab before sending messages.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File input for import (hidden) -->
    <input type="file" #fileInput accept=".json" (change)="onFileSelected($event)" style="display: none;">
</kendo-dialog>

<!-- Rendered Prompt Dialog -->
<kendo-dialog *ngIf="showRenderedPrompt" [width]="800" [height]="600" title="Rendered Prompt" (close)="closeRenderedPromptDialog()">
    <div class="rendered-prompt-container">
        <pre>{{ renderedPromptContent }}</pre>
    </div>
    
    <kendo-dialog-actions>
        <button kendoButton (click)="closeRenderedPromptDialog()">Close</button>
    </kendo-dialog-actions>
</kendo-dialog>