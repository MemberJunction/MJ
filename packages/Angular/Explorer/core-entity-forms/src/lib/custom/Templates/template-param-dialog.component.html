<kendo-dialog *ngIf="_isVisible"
              [minWidth]="600"
              [width]="800"
              [height]="700"
              (close)="close()"
              [title]="'Test Template: ' + (template?.Name || 'Unknown')">
              
    <div class="dialog-content" style="display: flex; flex-direction: column; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        
        <!-- Header Section -->
        <div class="header-section" style="margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #e9ecef;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;" (click)="parametersExpanded = !parametersExpanded">
                <i class="fa-solid" [class.fa-chevron-down]="parametersExpanded" [class.fa-chevron-right]="!parametersExpanded" style="color: #6c757d; font-size: 0.8em;"></i>
                <i class="fa-solid fa-sliders" style="color: #6c757d;"></i>
                <h5 style="margin: 0; color: #495057; font-weight: 600;">Template Parameters</h5>
                @if (parameters.length > 0) {
                    <span class="badge" style="background: #17a2b8; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em;">
                        {{ parameters.length }}
                    </span>
                }
            </div>
            <p style="margin: 0; color: #6c757d; font-size: 0.9em;">
                Configure parameter values for testing. Parameters with <span style="color: #dc3545;">*</span> are required.
            </p>
        </div>

        <!-- Loading State -->
        @if (isLoading) {
            <div class="loading-state" style="display: flex; align-items: center; justify-content: center; padding: 40px;">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; color: #6c757d; margin-right: 12px;"></i>
                <span style="color: #6c757d;">Loading template parameters...</span>
            </div>
        } @else {
            <!-- Parameters Editor -->
            @if (parametersExpanded) {
                <div class="parameters-section" style="display: flex; flex-direction: column; margin-bottom: 20px; min-height: 200px; max-height: 400px;">
                    <div class="parameters-list" style="flex: 1; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: #f8f9fa;">
                        
                        @for (param of parameters; track $index; let i = $index) {
                            <div class="parameter-row" 
                                 style="display: grid; grid-template-columns: 200px 1fr 40px; gap: 12px; padding: 12px 16px; border-bottom: 1px solid #e9ecef; align-items: start; background: white; margin-bottom: 1px;">
                                
                                <!-- Parameter Name -->
                                <div class="param-name" style="display: flex; flex-direction: column;">
                                    <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                        @if (param.isFromTemplate) {
                                            <i class="fa-solid fa-database" style="color: #28a745; font-size: 0.75em;" title="From template definition"></i>
                                        } @else {
                                            <i class="fa-solid fa-edit" style="color: #fd7e14; font-size: 0.75em;" title="Custom parameter"></i>
                                        }
                                        @if (param.isRequired) {
                                            <span style="color: #dc3545; font-weight: bold;">*</span>
                                        }
                                    </div>
                                    
                                    @if (param.isFromTemplate) {
                                        <div style="font-family: 'Courier New', monospace; font-size: 0.9em; font-weight: 500; color: #495057; padding: 4px 0; word-break: break-word;">
                                            {{ param.key }}
                                        </div>
                                        @if (param.description) {
                                            <div style="font-size: 0.75em; color: #6c757d; margin-top: 2px; font-style: italic; word-break: break-word;">
                                                {{ param.description }}
                                            </div>
                                        }
                                        @if (param.type && param.type !== 'Scalar') {
                                            <div style="font-size: 0.7em; color: #17a2b8; margin-top: 2px;">
                                                Type: {{ param.type }}
                                            </div>
                                        }
                                    } @else {
                                        <kendo-textbox [(ngModel)]="param.key"
                                                      (ngModelChange)="onParameterChange()"
                                                      placeholder="Parameter name..."
                                                      style="font-family: 'Courier New', monospace; width: 100%;">
                                        </kendo-textbox>
                                    }
                                </div>
                                
                                <!-- Parameter Value -->
                                <div class="param-value">
                                    <kendo-textarea [(ngModel)]="param.value"
                                                   (ngModelChange)="onParameterChange()"
                                                   [rows]="2"
                                                   placeholder="Enter value (JSON strings, numbers, objects)..."
                                                   style="font-family: 'Courier New', monospace; font-size: 0.9em; width: 100%;">
                                    </kendo-textarea>
                                </div>
                                
                                <!-- Actions -->
                                <div class="param-actions" style="display: flex; align-items: start; justify-content: center; padding-top: 4px;">
                                    @if (!param.isFromTemplate && parameters.length > 1) {
                                        <kendo-button
                                                fillMode="flat"
                                                themeColor="error"
                                                size="small"
                                                (click)="removeParameter(i)"
                                                title="Remove parameter">
                                            <i class="fa-solid fa-times"></i>
                                        </kendo-button>
                                    }
                                </div>
                            </div>
                        }
                        
                        <!-- Add Parameter Button -->
                        <div class="add-parameter-row" style="padding: 12px 16px; text-align: center; background: #f8f9fa;">
                            <kendo-button
                                    fillMode="outline"
                                    themeColor="success"
                                    size="small"
                                    (click)="addParameter()">
                                <i class="fa-solid fa-plus"></i> Add Parameter
                            </kendo-button>
                        </div>
                    </div>
                </div>
            }

            <!-- JSON Preview -->
            <div class="json-preview-header" style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; cursor: pointer;" (click)="jsonPreviewExpanded = !jsonPreviewExpanded">
                    <i class="fa-solid" [class.fa-chevron-down]="jsonPreviewExpanded" [class.fa-chevron-right]="!jsonPreviewExpanded" style="color: #6c757d; font-size: 0.8em;"></i>
                    <i class="fa-solid fa-code" style="color: #6c757d;"></i>
                    <span style="font-weight: 600; color: #495057; font-size: 0.85em;">Context Data (JSON)</span>
                </div>
                @if (jsonPreviewExpanded) {
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; font-family: 'Courier New', monospace; font-size: 0.8em; color: #495057; max-height: 80px; overflow-y: auto;">
                        <pre style="margin: 0; white-space: pre-wrap;">{{ parametersAsJson }}</pre>
                    </div>
                }
            </div>

            <!-- Test Results -->
            @if (testResult) {
                <div class="test-results" style="flex: 1; display: flex; flex-direction: column; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden; margin-bottom: 16px; min-height: 150px;">
                    <div class="result-header" 
                         style="padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; cursor: pointer;"
                         [style.background]="testResult.success ? '#d4edda' : '#f8d7da'"
                         [style.border-bottom]="'1px solid ' + (testResult.success ? '#c3e6cb' : '#f5c6cb')"
                         (click)="resultsExpanded = !resultsExpanded">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fa-solid" [class.fa-chevron-down]="resultsExpanded" [class.fa-chevron-right]="!resultsExpanded" style="font-size: 0.8em;" [style.color]="testResult.success ? '#155724' : '#721c24'"></i>
                            @if (testResult.success) {
                                <i class="fa-solid fa-check-circle" style="color: #155724;"></i>
                                <span style="font-weight: 600; color: #155724; font-size: 0.9em;">Success</span>
                                @if (testResult.executionTimeMs) {
                                    <span style="color: #155724; font-size: 0.8em;">({{ testResult.executionTimeMs }}ms)</span>
                                }
                            } @else {
                                <i class="fa-solid fa-exclamation-triangle" style="color: #721c24;"></i>
                                <span style="font-weight: 600; color: #721c24; font-size: 0.9em;">Error</span>
                            }
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;" (click)="$event.stopPropagation()">
                            <kendo-button
                                    fillMode="flat"
                                    size="small"
                                    (click)="saveResults()"
                                    title="Save results to file"
                                    style="min-width: auto; padding: 4px 8px;">
                                <i class="fa-solid fa-download"></i>
                            </kendo-button>
                        </div>
                    </div>
                    
                    @if (resultsExpanded) {
                        <div class="result-content" style="flex: 1; padding: 12px; background: white; overflow-y: auto; overflow-x: auto;">
                            @if (testResult.success && testResult.output) {
                                <pre style="margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.8em; color: #495057; line-height: 1.4;">{{ testResult.output }}</pre>
                            } @else if (!testResult.success && testResult.error) {
                                <pre style="margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.8em; color: #721c24; line-height: 1.4;">{{ testResult.error }}</pre>
                            }
                        </div>
                    }
                </div>
            }
        }
    </div>

    <!-- Dialog Actions -->
    <kendo-dialog-actions>
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
                @if (hasUnsavedParameters) {
                    <kendo-button
                            fillMode="outline"
                            themeColor="info"
                            (click)="updateTemplateParams()">
                        <i class="fa-solid fa-save"></i> Update Template Params
                    </kendo-button>
                }
            </div>
            
            <div style="display: flex; gap: 8px;">
                <kendo-button
                        themeColor="primary"
                        [disabled]="isRunning || isLoading"
                        (click)="runTemplate()">
                    @if (isRunning) {
                        <i class="fa-solid fa-spinner fa-spin"></i> Running...
                    } @else {
                        <i class="fa-solid fa-play"></i> Run Template
                    }
                </kendo-button>
                
                <kendo-button
                        fillMode="outline"
                        (click)="close()">
                    Close
                </kendo-button>
            </div>
        </div>
    </kendo-dialog-actions>
</kendo-dialog>