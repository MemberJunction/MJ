<kendo-dialog *ngIf="isVisible" 
               [minWidth]="800" 
               [width]="1000"
               [height]="700"
               title="Execute AI Agent"
               (close)="close()"
               [actions]="[]">
    
    <div class="dialog-content" style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
        
        <!-- Agent Info Header -->
        @if (aiAgent) {
            <div class="agent-info" style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #17a2b8;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fa-solid fa-robot" style="color: #17a2b8; font-size: 1.3em;"></i>
                    <div>
                        <h5 style="margin: 0; color: #495057;">{{ aiAgent.Name }}</h5>
                        @if (aiAgent.Description) {
                            <p style="margin: 4px 0 0 0; color: #6c757d; font-size: 0.9em;">{{ aiAgent.Description }}</p>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Main Content Area -->
        <div class="main-content" style="flex: 1; display: flex; flex-direction: column; gap: 16px; overflow-y: auto;">
            
            <!-- User Message Section -->
            <div class="conversation-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: #495057;">
                        <i class="fa-solid fa-comment" style="margin-right: 6px; color: #6f42c1;"></i>
                        Message to Agent <span style="color: #dc3545;">*</span>
                    </label>
                    <button type="button" 
                            class="toggle-advanced-btn"
                            (click)="toggleAdvancedConversation()"
                            style="background: none; border: 1px solid #dee2e6; border-radius: 4px; padding: 4px 8px; font-size: 0.8em; color: #6c757d; cursor: pointer;">
                        @if (showAdvancedConversation) {
                            <i class="fa-solid fa-chevron-up"></i> Simple
                        } @else {
                            <i class="fa-solid fa-chevron-down"></i> Advanced
                        }
                    </button>
                </div>
                
                @if (!showAdvancedConversation) {
                    <!-- Simple Message Input -->
                    <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 0.85em;">
                        Enter your message to send to the agent.
                    </p>
                    <kendo-textarea [(ngModel)]="userMessage"
                                   (ngModelChange)="updateConversationFromMessage()"
                                   [rows]="4"
                                   style="width: 100%;"
                                   placeholder="Type your message to the agent here...">
                    </kendo-textarea>
                } @else {
                    <!-- Advanced JSON Editor -->
                    <p style="margin: 0 0 8px 0; color: #6c757d; font-size: 0.85em;">
                        JSON array of conversation messages to provide as context to the agent.
                    </p>
                    <kendo-textarea [(ngModel)]="conversationMessages"
                                   [rows]="6"
                                   style="width: 100%; font-family: 'Courier New', monospace; font-size: 0.9em;"
                                   placeholder='[{"role": "user", "content": "Your message here"}]'>
                    </kendo-textarea>
                }
            </div>

            <!-- Advanced Options Expandable Panel -->
            <kendo-expansionpanel [(expanded)]="showAdvancedOptions">
                <ng-template kendoExpansionPanelTitleDirective>
                    <span style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                        <i class="fa-solid fa-cogs" style="color: #6c757d;"></i>
                        Advanced Options
                    </span>
                </ng-template>

                <div style="padding: 16px 0;">
                    
                    <!-- Data Context Variables -->
                    <kendo-expansionpanel [(expanded)]="showDataContext" style="margin-bottom: 16px;">
                        <ng-template kendoExpansionPanelTitleDirective>
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <i class="fa-solid fa-database" style="color: #28a745;"></i>
                                Data Context Variables
                                @if (dataContextVariables.length > 0) {
                                    <span class="badge" style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">
                                        {{ dataContextVariables.length }}
                                    </span>
                                }
                            </span>
                        </ng-template>

                        <div style="padding: 12px 0;">
                            <p style="margin: 0 0 12px 0; color: #6c757d; font-size: 0.85em;">
                                Variables that will be available as data context during agent execution.
                            </p>
                            
                            @if (dataContextVariables.length === 0) {
                                <p style="text-align: center; color: #6c757d; font-style: italic; padding: 20px;">
                                    No data context variables defined.
                                </p>
                            }

                            @for (variable of dataContextVariables; track $index) {
                                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                    <kendo-textbox [(ngModel)]="variable.name" 
                                                  placeholder="Variable name"
                                                  style="width: 150px;">
                                    </kendo-textbox>
                                    
                                    <kendo-dropdownlist [(ngModel)]="variable.type"
                                                       [data]="[{text: 'String', value: 'string'}, {text: 'Number', value: 'number'}, {text: 'Boolean', value: 'boolean'}, {text: 'Object', value: 'object'}]"
                                                       textField="text"
                                                       valueField="value"
                                                       [valuePrimitive]="true"
                                                       style="width: 100px;">
                                    </kendo-dropdownlist>
                                    
                                    <kendo-textbox [(ngModel)]="variable.value" 
                                                  placeholder="Value"
                                                  style="flex: 1;">
                                    </kendo-textbox>
                                    
                                    <kendo-button fillMode="outline" 
                                                themeColor="error" 
                                                size="small"
                                                (click)="removeDataVariable($index)"
                                                title="Remove variable">
                                        <i class="fa-solid fa-trash"></i>
                                    </kendo-button>
                                </div>
                            }
                            
                            <kendo-button fillMode="outline" 
                                        themeColor="primary" 
                                        size="small"
                                        (click)="addDataVariable()"
                                        style="margin-top: 8px;">
                                <i class="fa-solid fa-plus"></i> Add Variable
                            </kendo-button>
                        </div>
                    </kendo-expansionpanel>

                    <!-- Template Data Variables -->
                    <kendo-expansionpanel [(expanded)]="showTemplateData">
                        <ng-template kendoExpansionPanelTitleDirective>
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <i class="fa-solid fa-file-code" style="color: #fd7e14;"></i>
                                Template Data Variables
                                @if (templateDataVariables.length > 0) {
                                    <span class="badge" style="background: #fd7e14; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">
                                        {{ templateDataVariables.length }}
                                    </span>
                                }
                            </span>
                        </ng-template>

                        <div style="padding: 12px 0;">
                            <p style="margin: 0 0 12px 0; color: #6c757d; font-size: 0.85em;">
                                Variables that will be available for template rendering during agent execution.
                            </p>
                            
                            @if (templateDataVariables.length === 0) {
                                <p style="text-align: center; color: #6c757d; font-style: italic; padding: 20px;">
                                    No template data variables defined.
                                </p>
                            }

                            @for (variable of templateDataVariables; track $index) {
                                <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                    <kendo-textbox [(ngModel)]="variable.name" 
                                                  placeholder="Variable name"
                                                  style="width: 150px;">
                                    </kendo-textbox>
                                    
                                    <kendo-dropdownlist [(ngModel)]="variable.type"
                                                       [data]="[{text: 'String', value: 'string'}, {text: 'Number', value: 'number'}, {text: 'Boolean', value: 'boolean'}, {text: 'Object', value: 'object'}]"
                                                       textField="text"
                                                       valueField="value"
                                                       [valuePrimitive]="true"
                                                       style="width: 100px;">
                                    </kendo-dropdownlist>
                                    
                                    <kendo-textbox [(ngModel)]="variable.value" 
                                                  placeholder="Value"
                                                  style="flex: 1;">
                                    </kendo-textbox>
                                    
                                    <kendo-button fillMode="outline" 
                                                themeColor="error" 
                                                size="small"
                                                (click)="removeTemplateVariable($index)"
                                                title="Remove variable">
                                        <i class="fa-solid fa-trash"></i>
                                    </kendo-button>
                                </div>
                            }
                            
                            <kendo-button fillMode="outline" 
                                        themeColor="primary" 
                                        size="small"
                                        (click)="addTemplateVariable()"
                                        style="margin-top: 8px;">
                                <i class="fa-solid fa-plus"></i> Add Variable
                            </kendo-button>
                        </div>
                    </kendo-expansionpanel>
                </div>
            </kendo-expansionpanel>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e9ecef;">
            <div>
                @if (isExecuting) {
                    <span style="color: #6c757d; font-style: italic;">
                        <i class="fa-solid fa-spinner fa-spin" style="margin-right: 6px;"></i>
                        Executing agent...
                    </span>
                }
            </div>
            
            <div style="display: flex; gap: 8px;">
                <kendo-button fillMode="outline" (click)="close()">
                    Cancel
                </kendo-button>
                <kendo-button themeColor="info" 
                            (click)="executeAgent()"
                            [disabled]="isExecuting || !aiAgent">
                    @if (isExecuting) {
                        <i class="fa-solid fa-spinner fa-spin"></i> Executing...
                    } @else {
                        <i class="fa-solid fa-play"></i> Execute Agent
                    }
                </kendo-button>
            </div>
        </div>

        <!-- Execution Results -->
        @if (hasResult) {
            <div class="execution-results" style="margin-top: 20px; padding: 16px; border: 1px solid #e9ecef; border-radius: 6px; max-height: 300px; overflow-y: auto;">
                <h6 style="margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                    @if (executionResult?.success) {
                        <i class="fa-solid fa-check-circle" style="color: #28a745;"></i>
                        <span style="color: #28a745;">Execution Successful</span>
                    } @else {
                        <i class="fa-solid fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <span style="color: #dc3545;">Execution Failed</span>
                    }
                    
                    @if (executionResult?.executionTimeMs) {
                        <span style="color: #6c757d; font-size: 0.8em; margin-left: auto;">
                            {{ executionResult?.executionTimeMs }}ms
                        </span>
                    }
                </h6>

                @if (executionResult?.success && resultOutput) {
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 4px solid #28a745;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9em; color: #495057;">Output:</label>
                        <pre style="margin: 0; white-space: pre-wrap; font-size: 0.85em; line-height: 1.4;">{{ resultOutput }}</pre>
                    </div>
                } @else if (!executionResult?.success && executionResult?.error) {
                    <div style="background: #f8d7da; padding: 12px; border-radius: 4px; border-left: 4px solid #dc3545;">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9em; color: #721c24;">Error:</label>
                        <pre style="margin: 0; white-space: pre-wrap; font-size: 0.85em; line-height: 1.4; color: #721c24;">{{ executionResult?.error }}</pre>
                    </div>
                }

                @if (executionResult?.nextStep) {
                    <div style="margin-top: 12px; padding: 8px; background: #e2f3ff; border-radius: 4px;">
                        <span style="font-weight: 600; color: #0c5460; font-size: 0.9em;">Next Step: </span>
                        <span style="color: #0c5460; font-size: 0.9em;">{{ executionResult?.nextStep }}</span>
                    </div>
                }
            </div>
        }
    </div>
</kendo-dialog>