<div class="record-form-container" mjFillContainer [bottomMargin]="20" [rightMargin]="5">
    <form *ngIf="record" class="record-form" #form="ngForm" mjFillContainer>
        <mj-form-toolbar [form]="this"></mj-form-toolbar>

        <!-- Enhanced Header Section -->
        <div class="agent-header">
            <div class="agent-header-content">
                <!-- Agent Information -->
                <div class="agent-info-section">
                    <div class="agent-title-row">
                        <div class="agent-icon-wrapper">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div class="agent-title-content">
                            @if (EditMode) {
                                <kendo-textbox [(ngModel)]="record.Name" 
                                              name="agentName"
                                              placeholder="Enter agent name..."
                                              class="agent-name-input">
                                </kendo-textbox>
                            } @else {
                                <h1 class="agent-name-display">{{ record.Name || 'Untitled AI Agent' }}</h1>
                            }
                            @if (!EditMode && record.Status) {
                                <span class="status-badge" [ngClass]="record.Status.toLowerCase()">
                                    <i class="fa-solid fa-circle" style="font-size: 8px;"></i>
                                    {{ record.Status }}
                                </span>
                            }
                        </div>
                    </div>
                    
                    <!-- Meta Information -->
                    <div class="agent-meta-info">
                        @if (EditMode) {
                            <div class="meta-item">
                                <span class="meta-label">Status</span>
                                <kendo-dropdownlist [(ngModel)]="record.Status"
                                                   name="agentStatus"
                                                   [data]="[{text: 'Active', value: 'Active'}, {text: 'Pending', value: 'Pending'}, {text: 'Disabled', value: 'Disabled'}]"
                                                   textField="text"
                                                   valueField="value"
                                                   [valuePrimitive]="true"
                                                   style="width: 150px;">
                                </kendo-dropdownlist>
                            </div>
                        }
                        @if (record.ID) {
                            <div class="meta-item">
                                <span class="meta-label">Agent ID</span>
                                <span class="meta-value">{{ record.ID }}</span>
                            </div>
                        }
                        @if (record.ExecutionMode) {
                            <div class="meta-item">
                                <span class="meta-label">Execution Mode</span>
                                <span class="meta-value">
                                    <i [class]="getExecutionModeIcon(record.ExecutionMode)"></i>
                                    {{ record.ExecutionMode }}
                                </span>
                            </div>
                        }
                        @if (record.Parent) {
                            <div class="meta-item">
                                <span class="meta-label">Parent Agent</span>
                                <span class="meta-value">{{ record.Parent }}</span>
                            </div>
                        }
                    </div>
                    
                    <!-- Description -->
                    @if (EditMode) {
                        <kendo-textarea [(ngModel)]="record.Description"
                                       name="agentDescription"
                                       placeholder="Enter agent description..."
                                       class="agent-description-input">
                        </kendo-textarea>
                    } @else if (record.Description) {
                        <p class="agent-description">{{ record.Description }}</p>
                    }
                </div>
                
                <!-- Action Buttons -->
                <div class="agent-actions">
                    <div class="action-buttons-row">
                        @if (record.ID) {
                            <kendo-button class="action-button primary"
                                        (click)="openTestHarness()"
                                        title="Open AI Agent Test Harness">
                                <i class="fa-solid fa-flask"></i>
                                Test Harness
                            </kendo-button>
                        }
                    </div>
                    
                    @if (record.ID && record.Status !== 'Active') {
                        <div class="action-warnings">
                            <i class="fa-solid fa-exclamation-triangle"></i>
                            Agent must be Active to use Test Harness
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Enhanced Tabbed Interface -->
        <div class="form-content">
            <kendo-tabstrip [keepTabContent]="true" animationDuration="300">
                
                <!-- Details Tab (formerly Overview) -->
                <kendo-tabstrip-tab [selected]="true">
                    <ng-template kendoTabTitle>
                        <i class="fa-solid fa-cog tab-icon"></i>
                        Details
                    </ng-template>
                    <ng-template kendoTabContent>
                        <div class="tab-content-wrapper">
                            <!-- Basic Information Section -->
                            <div class="tab-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fa-solid fa-info-circle"></i>
                                        Basic Information
                                    </h3>
                                </div>
                                <p class="section-description">
                                    Configure the basic settings and hierarchy for this AI Agent.
                                </p>
                                <div class="form-fields-grid">
                                    <ng-content select="[slot='basic-fields']"></ng-content>
                                </div>
                            </div>

                            <!-- Technical Configuration Section -->
                            <div class="tab-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fa-solid fa-code"></i>
                                        Technical Configuration
                                    </h3>
                                </div>
                                <p class="section-description">
                                    Advanced technical settings including driver class, base agent class, and response handling.
                                </p>
                                <div class="form-fields-grid">
                                    <ng-content select="[slot='technical-fields']"></ng-content>
                                </div>
                            </div>

                            <!-- Context & Performance Section -->
                            <div class="tab-section">
                                <div class="section-header">
                                    <h3 class="section-title">
                                        <i class="fa-solid fa-gauge-high"></i>
                                        Context & Performance
                                    </h3>
                                </div>
                                <p class="section-description">
                                    Manage context compression and performance optimization settings.
                                </p>
                                <div class="form-fields-grid">
                                    <ng-content select="[slot='performance-fields']"></ng-content>
                                </div>
                            </div>
                            
                            <!-- All other fields -->
                            <div class="generated-form-fields">
                                <ng-content></ng-content>
                            </div>
                        </div>
                    </ng-template>
                </kendo-tabstrip-tab>

                <!-- Sub-Agents Tab -->
                @if (record.ID) {
                    <kendo-tabstrip-tab>
                        <ng-template kendoTabTitle>
                            <i class="fa-solid fa-sitemap tab-icon"></i>
                            Sub-Agents
                            @if (subAgentCount > 0) {
                                <span class="tab-count">{{ subAgentCount }}</span>
                            }
                        </ng-template>
                        <ng-template kendoTabContent>
                            <div class="tab-content-wrapper">
                                <div class="tab-section">
                                    <div class="section-header">
                                        <h3 class="section-title">
                                            <i class="fa-solid fa-sitemap"></i>
                                            Sub-Agents Hierarchy
                                        </h3>
                                        <div class="header-actions">
                                            <kendo-button fillMode="outline" size="small" (click)="refreshRelatedData()" title="Refresh">
                                                <i class="fa-solid fa-refresh"></i>
                                            </kendo-button>
                                            @if (EditMode) {
                                                <kendo-button themeColor="primary" size="small" (click)="createSubAgent()">
                                                    <i class="fa-solid fa-plus"></i> Add Sub-Agent
                                                </kendo-button>
                                            }
                                        </div>
                                    </div>
                                    <p class="section-description">
                                        Manage the hierarchy of sub-agents that work together with this agent.
                                    </p>
                                    
                                    @if (subAgentCount === 0) {
                                        <div class="empty-state">
                                            <i class="fa-solid fa-sitemap"></i>
                                            <h4>No Sub-Agents</h4>
                                            <p>This agent doesn't have any sub-agents yet. Add sub-agents to create a hierarchical agent structure.</p>
                                            @if (EditMode) {
                                                <kendo-button themeColor="primary" (click)="createSubAgent()">
                                                    <i class="fa-solid fa-plus"></i> Create First Sub-Agent
                                                </kendo-button>
                                            }
                                        </div>
                                    } @else {
                                        <div class="cards-container">
                                            @for (subAgent of subAgents; track subAgent.ID) {
                                                <div class="entity-card sub-agent-card" (click)="navigateToEntity('AI Agents', subAgent.ID)">
                                                    <div class="card-header">
                                                        <div class="card-icon">
                                                            <i class="fa-solid fa-robot"></i>
                                                        </div>
                                                        <div class="card-title-section">
                                                            <h4 class="card-title">{{ subAgent.Name || 'Untitled Sub-Agent' }}</h4>
                                                            @if (subAgent.Status) {
                                                                <span class="status-badge" [style.background-color]="getStatusBadgeColor()">
                                                                    {{ subAgent.Status }}
                                                                </span>
                                                            }
                                                        </div>
                                                        <div class="card-actions">
                                                            <i class="fa-solid fa-external-link"></i>
                                                        </div>
                                                    </div>
                                                    @if (subAgent.Description) {
                                                        <p class="card-description">{{ subAgent.Description }}</p>
                                                    }
                                                    <div class="card-meta">
                                                        @if (subAgent.ExecutionMode) {
                                                            <span class="meta-item">
                                                                <i [class]="getExecutionModeIcon(subAgent.ExecutionMode)"></i>
                                                                {{ subAgent.ExecutionMode }}
                                                            </span>
                                                        }
                                                        @if (subAgent.__mj_CreatedAt) {
                                                            <span class="meta-item">
                                                                <i class="fa-solid fa-calendar"></i>
                                                                {{ subAgent.__mj_CreatedAt | date:'short' }}
                                                            </span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            @if (subAgentCount > subAgents.length) {
                                                <div class="view-all-card" (click)="navigateToEntity('AI Agents', '')">
                                                    <div class="view-all-content">
                                                        <i class="fa-solid fa-ellipsis"></i>
                                                        <span>View All {{ subAgentCount }} Sub-Agents</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </ng-template>
                    </kendo-tabstrip-tab>

                    <!-- Prompts Tab -->
                    <kendo-tabstrip-tab>
                        <ng-template kendoTabTitle>
                            <i class="fa-solid fa-comments tab-icon"></i>
                            Prompts
                            @if (promptCount > 0) {
                                <span class="tab-count">{{ promptCount }}</span>
                            }
                        </ng-template>
                        <ng-template kendoTabContent>
                            <div class="tab-content-wrapper">
                                <div class="tab-section">
                                    <div class="section-header">
                                        <h3 class="section-title">
                                            <i class="fa-solid fa-comments"></i>
                                            Agent Prompts
                                        </h3>
                                        <div class="header-actions">
                                            <kendo-button fillMode="outline" size="small" (click)="refreshRelatedData()" title="Refresh">
                                                <i class="fa-solid fa-refresh"></i>
                                            </kendo-button>
                                            @if (EditMode) {
                                                <kendo-button themeColor="primary" size="small" (click)="addPrompt()">
                                                    <i class="fa-solid fa-plus"></i> Add Prompt
                                                </kendo-button>
                                            }
                                        </div>
                                    </div>
                                    <p class="section-description">
                                        Configure the prompts that guide this agent's behavior and responses.
                                    </p>
                                    
                                    @if (promptCount === 0) {
                                        <div class="empty-state">
                                            <i class="fa-solid fa-comments"></i>
                                            <h4>No Prompts</h4>
                                            <p>This agent doesn't have any prompts configured. Add prompts to define the agent's behavior.</p>
                                            @if (EditMode) {
                                                <kendo-button themeColor="primary" (click)="addPrompt()">
                                                    <i class="fa-solid fa-plus"></i> Create First Prompt
                                                </kendo-button>
                                            }
                                        </div>
                                    } @else {
                                        <div class="cards-container">
                                            @for (prompt of agentPrompts; track prompt.ID) {
                                                <div class="entity-card prompt-card" (click)="navigateToEntity('AI Agent Prompts', prompt.ID)">
                                                    <div class="card-header">
                                                        <div class="card-icon">
                                                            <i class="fa-solid fa-comment-dots"></i>
                                                        </div>
                                                        <div class="card-title-section">
                                                            <h4 class="card-title">{{ prompt.PromptType || 'Prompt' }}</h4>
                                                            @if (prompt.Priority) {
                                                                <span class="priority-badge" [style.background-color]="getPriorityBadgeColor(prompt.Priority)">
                                                                    {{ getPriorityLabel(prompt.Priority) }}
                                                                </span>
                                                            }
                                                        </div>
                                                        <div class="card-actions">
                                                            <i class="fa-solid fa-external-link"></i>
                                                        </div>
                                                    </div>
                                                    @if (prompt.PromptText) {
                                                        <p class="card-description">{{ prompt.PromptText.substring(0, 150) }}{{ prompt.PromptText.length > 150 ? '...' : '' }}</p>
                                                    }
                                                    <div class="card-meta">
                                                        @if (prompt.PromptRole) {
                                                            <span class="meta-item">
                                                                <i class="fa-solid fa-user-tag"></i>
                                                                {{ prompt.PromptRole }}
                                                            </span>
                                                        }
                                                        @if (prompt.__mj_UpdatedAt) {
                                                            <span class="meta-item">
                                                                <i class="fa-solid fa-clock"></i>
                                                                {{ prompt.__mj_UpdatedAt | date:'short' }}
                                                            </span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            @if (promptCount > agentPrompts.length) {
                                                <div class="view-all-card" (click)="navigateToEntity('AI Agent Prompts', '')">
                                                    <div class="view-all-content">
                                                        <i class="fa-solid fa-ellipsis"></i>
                                                        <span>View All {{ promptCount }} Prompts</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </ng-template>
                    </kendo-tabstrip-tab>

                    <!-- Actions Tab -->
                    <kendo-tabstrip-tab>
                        <ng-template kendoTabTitle>
                            <i class="fa-solid fa-bolt tab-icon"></i>
                            Actions
                            @if (actionCount > 0) {
                                <span class="tab-count">{{ actionCount }}</span>
                            }
                        </ng-template>
                        <ng-template kendoTabContent>
                            <div class="tab-content-wrapper">
                                <div class="tab-section">
                                    <div class="section-header">
                                        <h3 class="section-title">
                                            <i class="fa-solid fa-bolt"></i>
                                            Agent Actions
                                        </h3>
                                        <div class="header-actions">
                                            <kendo-button fillMode="outline" size="small" (click)="refreshRelatedData()" title="Refresh">
                                                <i class="fa-solid fa-refresh"></i>
                                            </kendo-button>
                                            @if (EditMode) {
                                                <kendo-button themeColor="primary" size="small" (click)="configureActions()">
                                                    <i class="fa-solid fa-plus"></i> Add Action
                                                </kendo-button>
                                            }
                                        </div>
                                    </div>
                                    <p class="section-description">
                                        Define the actions that this agent can perform and their configurations.
                                    </p>
                                    
                                    @if (actionCount === 0) {
                                        <div class="empty-state">
                                            <i class="fa-solid fa-bolt"></i>
                                            <h4>No Actions</h4>
                                            <p>This agent doesn't have any actions configured. Add actions to enable the agent to perform tasks.</p>
                                            @if (EditMode) {
                                                <kendo-button themeColor="primary" (click)="configureActions()">
                                                    <i class="fa-solid fa-plus"></i> Create First Action
                                                </kendo-button>
                                            }
                                        </div>
                                    } @else {
                                        <div class="cards-container">
                                            @for (action of agentActions; track action.ID) {
                                                <div class="entity-card action-card" (click)="navigateToEntity('AI Agent Actions', action.ID)">
                                                    <div class="card-header">
                                                        <div class="card-icon">
                                                            <i class="fa-solid fa-bolt"></i>
                                                        </div>
                                                        <div class="card-title-section">
                                                            <h4 class="card-title">{{ action.Name || 'Untitled Action' }}</h4>
                                                            @if (action.ActionType) {
                                                                <span class="type-badge">
                                                                    {{ action.ActionType }}
                                                                </span>
                                                            }
                                                        </div>
                                                        <div class="card-actions">
                                                            <i class="fa-solid fa-external-link"></i>
                                                        </div>
                                                    </div>
                                                    @if (action.Description) {
                                                        <p class="card-description">{{ action.Description }}</p>
                                                    }
                                                    <div class="card-meta">
                                                        @if (action.IsActive !== undefined) {
                                                            <span class="meta-item" [class.active]="action.IsActive" [class.inactive]="!action.IsActive">
                                                                <i class="fa-solid" [class.fa-check-circle]="action.IsActive" [class.fa-times-circle]="!action.IsActive"></i>
                                                                {{ action.IsActive ? 'Active' : 'Inactive' }}
                                                            </span>
                                                        }
                                                        @if (action.__mj_UpdatedAt) {
                                                            <span class="meta-item">
                                                                <i class="fa-solid fa-clock"></i>
                                                                {{ action.__mj_UpdatedAt | date:'short' }}
                                                            </span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            @if (actionCount > agentActions.length) {
                                                <div class="view-all-card" (click)="navigateToEntity('AI Agent Actions', '')">
                                                    <div class="view-all-content">
                                                        <i class="fa-solid fa-ellipsis"></i>
                                                        <span>View All {{ actionCount }} Actions</span>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </ng-template>
                    </kendo-tabstrip-tab>

                    <!-- Execution History Tab -->
                    <kendo-tabstrip-tab>
                        <ng-template kendoTabTitle>
                            <i class="fa-solid fa-history tab-icon"></i>
                            History
                            @if (executionHistoryCount > 0) {
                                <span class="tab-count">{{ executionHistoryCount }}</span>
                            }
                        </ng-template>
                        <ng-template kendoTabContent>
                            <div class="tab-content-wrapper">
                                <div class="tab-section">
                                    <div class="section-header">
                                        <h3 class="section-title">
                                            <i class="fa-solid fa-history"></i>
                                            Execution History
                                        </h3>
                                        <div class="header-actions">
                                            <kendo-button fillMode="outline" size="small" (click)="refreshRelatedData()" title="Refresh">
                                                <i class="fa-solid fa-refresh"></i>
                                            </kendo-button>
                                        </div>
                                    </div>
                                    <p class="section-description">
                                        View the execution history and performance metrics for this agent.
                                    </p>
                                    
                                    @if (executionHistoryCount === 0) {
                                        <div class="empty-state">
                                            <i class="fa-solid fa-history"></i>
                                            <h4>No Execution History</h4>
                                            <p>This agent hasn't been executed yet. Use the Test Harness to run the agent and see execution history here.</p>
                                        </div>
                                    } @else {
                                        <div class="timeline-container">
                                            @for (execution of recentExecutions; track execution.ID) {
                                                <div class="timeline-item" (click)="navigateToEntity('AI Agent Runs', execution.ID)">
                                                    <div class="timeline-marker" [style.background-color]="getExecutionStatusColor(execution.Status)">
                                                        <i [class]="getExecutionStatusIcon(execution.Status)"></i>
                                                    </div>
                                                    <div class="timeline-content">
                                                        <div class="timeline-header">
                                                            <h4 class="timeline-title">
                                                                Execution #{{ execution.ID.substring(0, 8) }}
                                                            </h4>
                                                            <span class="timeline-date">
                                                                {{ execution.__mj_CreatedAt | date:'MMM d, y \u0027at\u0027 h:mm a' }}
                                                            </span>
                                                        </div>
                                                        <div class="timeline-status">
                                                            <span class="status-badge" [style.background-color]="getExecutionStatusColor(execution.Status)">
                                                                {{ execution.Status || 'Unknown' }}
                                                            </span>
                                                            @if (execution.ExecutionTimeMS) {
                                                                <span class="execution-time">
                                                                    <i class="fa-solid fa-stopwatch"></i>
                                                                    {{ formatExecutionTime(execution.ExecutionTimeMS) }}
                                                                </span>
                                                            }
                                                        </div>
                                                        @if (execution.ResultSummary) {
                                                            <p class="timeline-description">
                                                                {{ execution.ResultSummary.substring(0, 200) }}{{ execution.ResultSummary.length > 200 ? '...' : '' }}
                                                            </p>
                                                        }
                                                        @if (execution.ErrorMessage) {
                                                            <div class="timeline-error">
                                                                <i class="fa-solid fa-exclamation-triangle"></i>
                                                                {{ execution.ErrorMessage.substring(0, 150) }}{{ execution.ErrorMessage.length > 150 ? '...' : '' }}
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            @if (executionHistoryCount > recentExecutions.length) {
                                                <div class="timeline-item view-all" (click)="navigateToEntity('AI Agent Runs', '')">
                                                    <div class="timeline-marker view-all-marker">
                                                        <i class="fa-solid fa-ellipsis"></i>
                                                    </div>
                                                    <div class="timeline-content">
                                                        <div class="view-all-content">
                                                            <span>View All {{ executionHistoryCount }} Executions</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </ng-template>
                    </kendo-tabstrip-tab>
                }
            </kendo-tabstrip>
        </div>
    </form>

    <!-- AI Agent Test Harness -->
    @if (showTestHarness) {
        <mj-ai-agent-test-harness
            [aiAgent]="record"
            [isVisible]="showTestHarness"
            (visibilityChange)="onTestHarnessVisibilityChanged($event)">
        </mj-ai-agent-test-harness>
    }
</div>