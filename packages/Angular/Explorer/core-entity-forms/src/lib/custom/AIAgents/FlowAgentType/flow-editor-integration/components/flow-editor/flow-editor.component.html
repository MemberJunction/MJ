<div class="flow-editor">
  <div class="canvas-header">
    <div class="canvas-controls">
      <button 
        class="control-button" 
        (click)="onZoomIn()"
        title="Zoom In">
        <i class="fas fa-search-plus"></i>
        <span>Zoom In</span>
      </button>
      <button 
        class="control-button" 
        (click)="onZoomOut()"
        title="Zoom Out">
        <i class="fas fa-search-minus"></i>
        <span>Zoom Out</span>
      </button>
      <button 
        class="control-button" 
        (click)="onResetView()"
        title="Reset View">
        <i class="fas fa-sync-alt"></i>
        <span>Reset View</span>
      </button>
      <button 
        class="control-button" 
        (click)="onAutoArrange()"
        title="Auto Arrange Steps">
        <i class="fas fa-project-diagram"></i>
        <span>Auto Arrange</span>
      </button>
      <button 
        class="control-button" 
        (click)="toggleExecutionPanel()"
        title="Toggle Execution Panel">
        <i class="fas fa-play-circle"></i>
        <span>{{ showExecutionPanel ? 'Hide' : 'Show' }} Execution</span>
      </button>
      <button 
        class="control-button" 
        (click)="testConnection()"
        title="Test Connection">
        <i class="fas fa-link"></i>
        <span>Test Connection</span>
      </button>
    </div>
  </div>
  
  <div #reteEditor class="rete-container">
    <div class="canvas-wrapper">
      <svg class="connections-layer">
        <!-- Define arrow markers for backward connections -->
        <defs>
          <marker id="backward-arrow" markerWidth="10" markerHeight="10" 
                  refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L0,6 L9,3 z" fill="#EF4444" />
          </marker>
        </defs>
        <g *ngFor="let connection of connections">
          <path [attr.d]="getConnectionPath(connection)" 
                class="connection-path"
                fill="none"
                [attr.stroke]="getConnectionColor(connection)"
                [attr.stroke-dasharray]="getConnectionDashArray(connection)"
                [attr.marker-end]="getConnectionMarker(connection)"
                stroke-width="3"
                style="cursor: pointer; pointer-events: stroke"
                (click)="onConnectionClick($event, connection)"/>
          <path [attr.d]="getConnectionPath(connection)" 
                class="connection-hover"
                fill="none"
                stroke="transparent"
                stroke-width="20"
                style="cursor: pointer; pointer-events: stroke"
                (click)="onConnectionClick($event, connection)"/>
          
          <!-- Condition indicator -->
          <g *ngIf="connection.condition">
            <!-- Shadow for condition box -->
            <rect
              [attr.x]="getConnectionMidpoint(connection).x - getConditionBoxWidth(connection)/2"
              [attr.y]="getConnectionMidpoint(connection).y - 15"
              [attr.width]="getConditionBoxWidth(connection)"
              height="30"
              rx="15"
              fill="rgba(0,0,0,0.1)"
              [attr.transform]="'translate(2, 2)'"
              style="pointer-events: none"/>
            <rect
              [attr.x]="getConnectionMidpoint(connection).x - getConditionBoxWidth(connection)/2"
              [attr.y]="getConnectionMidpoint(connection).y - 15"
              [attr.width]="getConditionBoxWidth(connection)"
              height="30"
              rx="15"
              fill="#FFFFFF"
              stroke="#0076B6"
              stroke-width="2"
              style="cursor: pointer"
              (click)="onConnectionClick($event, connection)"/>
            <text 
              [attr.x]="getConnectionMidpoint(connection).x"
              [attr.y]="getConnectionMidpoint(connection).y + 4"
              text-anchor="middle"
              font-size="12"
              font-weight="600"
              fill="#0076B6"
              style="cursor: pointer; pointer-events: none;">
              {{ getConditionLabel(connection) }}
            </text>
          </g>
          
        </g>
        <path *ngIf="tempConnection" 
              [attr.d]="getTempConnectionPath()" 
              class="temp-connection-path"
              fill="none"
              stroke="#28a745"
              stroke-width="3"
              stroke-dasharray="5,5"/>
      </svg>
      
      <div class="steps-container">
        <app-step 
          *ngFor="let step of steps"
          [step]="step"
          [selected]="selectedStepId === step.id"
          [executing]="executingStepId === step.id"
          [style.left.px]="step.position[0]"
          [style.top.px]="step.position[1]"
          [style.position]="'absolute'"
          [attr.data-step-id]="step.id"
          (stepSelected)="selectStep($event)"
          (stepDeleted)="deleteStep($event)"
          (stepUpdated)="updateStep($event)"
          (socketMouseDown)="onSocketMouseDown($event)"
          (socketMouseEnter)="onSocketMouseEnter($event)"
          (socketMouseLeave)="onSocketMouseLeave($event)"
          (mousedown)="onStepDragStart($event, step)">
        </app-step>
      </div>
    </div>
  </div>
  
  <!-- Condition Editor Modal -->
  <div class="modal-backdrop" *ngIf="editingConnection" (click)="closeConditionEditor()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <app-simple-condition-editor
        [connection]="editingConnection"
        (save)="saveConnectionConditions($event)"
        (cancel)="closeConditionEditor()">
      </app-simple-condition-editor>
    </div>
  </div>
  
  <!-- Delete Step Confirmation Dialog -->
  <app-confirmation-dialog
    *ngIf="stepToDelete"
    [title]="'Delete Step'"
    [message]="'Are you sure you want to delete this ' + stepToDelete.config.name + ' step? This action cannot be undone.'"
    [confirmText]="'Delete'"
    (confirm)="confirmDeleteStep()"
    (cancel)="cancelDeleteStep()">
  </app-confirmation-dialog>
  
  <!-- Delete Connection Confirmation Dialog -->
  <app-confirmation-dialog
    *ngIf="connectionToDelete"
    [title]="'Delete Connection'"
    [message]="'Are you sure you want to delete this connection? This action cannot be undone.'"
    [confirmText]="'Delete'"
    (confirm)="confirmDeleteConnection()"
    (cancel)="cancelDeleteConnection()">
  </app-confirmation-dialog>
</div>