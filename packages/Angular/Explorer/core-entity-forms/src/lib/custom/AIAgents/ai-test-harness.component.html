<kendo-dialog *ngIf="isVisible" 
               [minWidth]="1200" 
               [width]="1400"
               [height]="800"
               [title]="mode === 'agent' ? 'AI Agent Test Harness' : 'AI Prompt Test Harness'"
               (close)="close()"
               [actions]="[]"
               class="ai-agent-test-harness">
    
    <div class="harness-container">
        <!-- Header -->
        <div class="harness-header">
            @if (entity) {
                <div class="agent-info">
                    <div class="agent-details">
                        <i class="fa-solid" [class.fa-robot]="mode === 'agent'" [class.fa-comment-dots]="mode === 'prompt'"></i>
                        <div>
                            <h3>{{ getEntityName() }}</h3>
                            @if (entity.Description) {
                                <p>{{ entity.Description }}</p>
                            }
                        </div>
                    </div>
                    <div class="header-actions">
                        <kendo-button 
                            fillMode="outline"
                            size="small"
                            (click)="clearConversation()"
                            [disabled]="isExecuting || conversationMessages.length === 0"
                            title="Clear conversation">
                            <i class="fa-solid fa-broom"></i>
                            Clear
                        </kendo-button>
                        <kendo-button 
                            fillMode="outline"
                            size="small"
                            (click)="saveConversation()"
                            [disabled]="conversationMessages.length === 0"
                            title="Save conversation">
                            <i class="fa-solid fa-save"></i>
                            Save
                        </kendo-button>
                        <kendo-button 
                            fillMode="outline"
                            size="small"
                            (click)="exportConversation()"
                            [disabled]="conversationMessages.length === 0"
                            title="Export conversation">
                            <i class="fa-solid fa-download"></i>
                            Export
                        </kendo-button>
                        <kendo-button 
                            fillMode="outline"
                            size="small"
                            (click)="importConversation()"
                            title="Import conversation">
                            <i class="fa-solid fa-upload"></i>
                            Import
                        </kendo-button>
                        <input 
                            #fileInput
                            type="file"
                            accept=".json"
                            style="display: none"
                            (change)="onFileSelected($event)">
                        <kendo-button 
                            fillMode="outline"
                            size="small"
                            (click)="toggleSidebar()"
                            title="Toggle sidebar">
                            <i class="fa-solid" [class.fa-chevron-right]="!showSidebar" [class.fa-chevron-left]="showSidebar"></i>
                        </kendo-button>
                    </div>
                </div>
            }
        </div>

        <!-- Main Content Area -->
        <div class="harness-body">
            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Messages Container -->
                <div class="messages-container" #messagesContainer>
                    @if (conversationMessages.length === 0) {
                        <div class="empty-state">
                            <i class="fa-solid fa-comments"></i>
                            <h4>Start a conversation</h4>
                            <p>Send a message to begin testing the AI agent</p>
                        </div>
                    }

                    @for (message of conversationMessages; track message.id) {
                        <div [ngClass]="getMessageClass(message)">
                            <div class="message-header">
                                <span class="message-role">
                                    @if (message.role === 'user') {
                                        <i class="fa-solid fa-user"></i> You
                                    } @else {
                                        <i class="fa-solid fa-robot"></i> {{ aiAgent?.Name || 'Assistant' }}
                                    }
                                </span>
                                <span class="message-time">{{ formatTimestamp(message.timestamp) }}</span>
                                @if (message.isStreaming && message.elapsedTime !== undefined) {
                                    <span class="execution-time streaming">
                                        <i class="fa-solid fa-spinner fa-spin"></i> {{ formatElapsedTime(message.elapsedTime) }}
                                    </span>
                                } @else if (message.executionTime) {
                                    <span class="execution-time">{{ formatExecutionTime(message.executionTime) }}</span>
                                }
                                @if (showRawToggle(message)) {
                                    <button class="raw-toggle" (click)="toggleRawView(message)" title="Toggle raw/formatted view">
                                        <i class="fa-solid" [class.fa-code]="!message.showRaw" [class.fa-eye]="message.showRaw"></i>
                                    </button>
                                }
                            </div>
                            <div class="message-content" [class.raw-view]="message.showRaw">
                                @if (message.isStreaming) {
                                    <div class="streaming-wrapper">
                                        <span class="streaming-content">{{ message.streamingContent }}<span class="cursor">|</span></span>
                                    </div>
                                } @else {
                                    <div [innerHTML]="getFormattedContent(message)"></div>
                                }
                                @if (message.error) {
                                    <div class="error-details">
                                        <i class="fa-solid fa-exclamation-triangle"></i>
                                        {{ message.error }}
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <kendo-textarea
                            [(ngModel)]="currentUserMessage"
                            [rows]="3"
                            placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)"
                            (keypress)="handleKeyPress($event)"
                            [disabled]="isExecuting"
                            class="message-input">
                        </kendo-textarea>
                        <kendo-button
                            themeColor="primary"
                            (click)="sendMessage()"
                            [disabled]="isExecuting || !currentUserMessage.trim()"
                            class="send-button">
                            @if (isExecuting) {
                                <i class="fa-solid fa-spinner fa-spin"></i>
                            } @else {
                                <i class="fa-solid fa-paper-plane"></i>
                            }
                        </kendo-button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            @if (showSidebar) {
                <div class="sidebar">
                    <!-- Tab Navigation -->
                    <div class="sidebar-tabs">
                        <button 
                            class="tab-button"
                            [class.active]="activeTab === 'dataContext'"
                            (click)="selectTab('dataContext')">
                            <i class="fa-solid fa-database"></i>
                            Data Context
                        </button>
                        <button 
                            class="tab-button"
                            [class.active]="activeTab === 'templateData'"
                            (click)="selectTab('templateData')">
                            <i class="fa-solid fa-file-code"></i>
                            Template Data
                        </button>
                        <button 
                            class="tab-button"
                            [class.active]="activeTab === 'savedConversations'"
                            (click)="selectTab('savedConversations')">
                            <i class="fa-solid fa-history"></i>
                            Saved
                            @if (savedConversations.length > 0) {
                                <span class="badge">{{ savedConversations.length }}</span>
                            }
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="sidebar-content">
                        <!-- Data Context Tab -->
                        @if (activeTab === 'dataContext') {
                            <div class="tab-content">
                                <div class="tab-header">
                                    <h4>Data Context Variables</h4>
                                    <p>Variables available during agent execution</p>
                                </div>
                                
                                <div class="variables-list">
                                    @for (variable of dataContextVariables; track $index) {
                                        <div class="variable-item">
                                            <kendo-textbox 
                                                [(ngModel)]="variable.name" 
                                                placeholder="Variable name"
                                                class="variable-name">
                                            </kendo-textbox>
                                            
                                            <kendo-dropdownlist 
                                                [(ngModel)]="variable.type"
                                                [data]="[
                                                    {text: 'String', value: 'string'}, 
                                                    {text: 'Number', value: 'number'}, 
                                                    {text: 'Boolean', value: 'boolean'}, 
                                                    {text: 'Object', value: 'object'}
                                                ]"
                                                textField="text"
                                                valueField="value"
                                                [valuePrimitive]="true"
                                                class="variable-type">
                                            </kendo-dropdownlist>
                                            
                                            <kendo-textbox 
                                                [(ngModel)]="variable.value" 
                                                [placeholder]="variable.type === 'object' ? 'JSON value' : 'Value'"
                                                class="variable-value">
                                            </kendo-textbox>
                                            
                                            <kendo-button 
                                                fillMode="flat" 
                                                themeColor="error" 
                                                size="small"
                                                (click)="removeDataVariable($index)"
                                                title="Remove variable"
                                                class="remove-button">
                                                <i class="fa-solid fa-times"></i>
                                            </kendo-button>
                                        </div>
                                    }
                                </div>
                                
                                <kendo-button 
                                    fillMode="outline" 
                                    themeColor="primary" 
                                    size="small"
                                    (click)="addDataVariable()"
                                    class="add-variable-button">
                                    <i class="fa-solid fa-plus"></i> Add Variable
                                </kendo-button>
                            </div>
                        }

                        <!-- Template Data Tab -->
                        @if (activeTab === 'templateData') {
                            <div class="tab-content">
                                <div class="tab-header">
                                    <h4>Template Data Variables</h4>
                                    <p>Variables for template rendering</p>
                                </div>
                                
                                <div class="variables-list">
                                    @if (templateDataVariables.length === 0) {
                                        <div class="empty-variables">
                                            <p>No template variables defined</p>
                                        </div>
                                    }
                                    
                                    @for (variable of templateDataVariables; track $index) {
                                        <div class="variable-item">
                                            <kendo-textbox 
                                                [(ngModel)]="variable.name" 
                                                placeholder="Variable name"
                                                class="variable-name">
                                            </kendo-textbox>
                                            
                                            <kendo-dropdownlist 
                                                [(ngModel)]="variable.type"
                                                [data]="[
                                                    {text: 'String', value: 'string'}, 
                                                    {text: 'Number', value: 'number'}, 
                                                    {text: 'Boolean', value: 'boolean'}, 
                                                    {text: 'Object', value: 'object'}
                                                ]"
                                                textField="text"
                                                valueField="value"
                                                [valuePrimitive]="true"
                                                class="variable-type">
                                            </kendo-dropdownlist>
                                            
                                            <kendo-textbox 
                                                [(ngModel)]="variable.value" 
                                                [placeholder]="variable.type === 'object' ? 'JSON value' : 'Value'"
                                                class="variable-value">
                                            </kendo-textbox>
                                            
                                            <kendo-button 
                                                fillMode="flat" 
                                                themeColor="error" 
                                                size="small"
                                                (click)="removeTemplateVariable($index)"
                                                title="Remove variable"
                                                class="remove-button">
                                                <i class="fa-solid fa-times"></i>
                                            </kendo-button>
                                        </div>
                                    }
                                </div>
                                
                                <kendo-button 
                                    fillMode="outline" 
                                    themeColor="primary" 
                                    size="small"
                                    (click)="addTemplateVariable()"
                                    class="add-variable-button">
                                    <i class="fa-solid fa-plus"></i> Add Variable
                                </kendo-button>
                            </div>
                        }

                        <!-- Saved Conversations Tab -->
                        @if (activeTab === 'savedConversations') {
                            <div class="tab-content">
                                <div class="tab-header">
                                    <h4>Saved Conversations</h4>
                                    <p>Previously saved test sessions</p>
                                </div>
                                
                                <div class="saved-list">
                                    @if (savedConversations.length === 0) {
                                        <div class="empty-saved">
                                            <i class="fa-solid fa-folder-open"></i>
                                            <p>No saved conversations</p>
                                        </div>
                                    }
                                    
                                    @for (conv of savedConversations; track conv.id) {
                                        <div class="saved-item" 
                                             [class.current]="conv.id === currentConversationId"
                                             (click)="loadConversation(conv)">
                                            <div class="saved-info">
                                                <h5>{{ conv.name }}</h5>
                                                <p>{{ conv.messages.length }} messages</p>
                                                <span class="saved-date">{{ conv.updatedAt | date:'short' }}</span>
                                            </div>
                                            <kendo-button 
                                                fillMode="flat" 
                                                themeColor="error" 
                                                size="small"
                                                (click)="deleteConversation(conv, $event)"
                                                title="Delete conversation">
                                                <i class="fa-solid fa-trash"></i>
                                            </kendo-button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</kendo-dialog>