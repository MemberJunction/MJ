<div class="test-run-form">
  <!-- Header Section -->
  <div class="test-run-header">
    <div class="breadcrumb">
      <a href="javascript:void(0)" (click)="openTest()" *ngIf="test">
        <i class="fas fa-flask"></i> {{ test.Name }}
      </a>
      <i class="fas fa-chevron-right" *ngIf="test"></i>
      <span>Run #{{ record.ID.substring(0, 8) }}</span>
    </div>

    <div class="header-content">
      <div class="header-left">
        <div class="test-run-icon" [style.background-color]="getStatusColor()">
          <i class="fas fa-flask"></i>
        </div>
        <div class="test-run-info">
          <h1>Test Run</h1>
          <div class="test-run-meta">
            <span class="status-badge" [style.background-color]="getStatusColor()">
              <i class="fas" [ngClass]="getStatusIcon()"></i>
              {{ record.Status }}
            </span>
            <span class="test-type" *ngIf="test">{{ test.Type }}</span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button kendoButton (click)="reRunTest()" icon="refresh">
          Re-run Test
        </button>
        <button kendoButton (click)="refresh()" icon="sync">
          Refresh
        </button>
      </div>
    </div>

    <!-- Metrics Bar -->
    <div class="metrics-bar">
      <div class="metric-card">
        <div class="metric-label">Started</div>
        <div class="metric-value">{{ record.StartedAt | date:'short' }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Completed</div>
        <div class="metric-value">{{ record.CompletedAt | date:'short' }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Duration</div>
        <div class="metric-value">{{ calculateDuration() }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Score</div>
        <div class="metric-value">{{ formatScore(record.Score) }}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Cost</div>
        <div class="metric-value">{{ formatCost(record.CostUSD) }}</div>
      </div>
    </div>

    <!-- Secondary Metrics -->
    <div class="secondary-metrics">
      <div class="metric-item">
        <span class="metric-label">Checks:</span>
        <span class="metric-value">{{ record.PassedChecks }}/{{ record.TotalChecks }}</span>
      </div>
      <div class="metric-item">
        <span class="metric-label">Run By:</span>
        <span class="metric-value">{{ record.RunByUser }}</span>
      </div>
      <div class="metric-item" *ngIf="testSuiteRun">
        <span class="metric-label">Part of Suite:</span>
        <a href="javascript:void(0)" (click)="openTestSuiteRun()">
          {{ testSuiteRun.ID }} (Seq: {{ record.Sequence }})
        </a>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <div class="tabs">
      <button class="tab" [class.active]="activeTab === 'overview'" (click)="changeTab('overview')">
        <i class="fas fa-th-large"></i>
        <span>Overview</span>
      </button>
      <button class="tab" [class.active]="activeTab === 'details'" (click)="changeTab('details')">
        <i class="fas fa-list"></i>
        <span>Details</span>
      </button>
      <button class="tab" [class.active]="activeTab === 'ai-runs'" (click)="changeTab('ai-runs')">
        <i class="fas fa-robot"></i>
        <span>AI Runs</span>
        <span class="tab-badge" *ngIf="aiRunsLoaded">{{ aiAgentRuns.length + aiPromptRuns.length }}</span>
      </button>
      <button class="tab" [class.active]="activeTab === 'feedback'" (click)="changeTab('feedback')">
        <i class="fas fa-comments"></i>
        <span>Feedback</span>
        <span class="tab-badge" *ngIf="feedbackLoaded">{{ feedbacks.length }}</span>
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="overview-tab" *ngIf="activeTab === 'overview'">
      <!-- Result Hero -->
      <div class="result-hero" [class.passed]="record.Status === 'Passed'" [class.failed]="record.Status === 'Failed'">
        <div class="result-icon">
          <i class="fas" [ngClass]="getStatusIcon()"></i>
        </div>
        <div class="result-text">
          <h2>TEST {{ record.Status.toUpperCase() }}</h2>
          <div class="result-score">Score: {{ formatScore(record.Score) }} / 1.0000</div>
          <div class="result-checks">{{ record.PassedChecks }} of {{ record.TotalChecks }} checks passed</div>
        </div>
      </div>

      <!-- Check Results -->
      <div class="check-results" *ngIf="getCheckResults().length > 0">
        <h3>Check Results</h3>
        <div class="check-list">
          <div class="check-item" *ngFor="let check of getCheckResults()" [class.passed]="check.passed" [class.failed]="!check.passed">
            <div class="check-icon">
              <i class="fas" [class.fa-check-circle]="check.passed" [class.fa-times-circle]="!check.passed"></i>
            </div>
            <div class="check-content">
              <div class="check-name">{{ check.name }}</div>
              <div class="check-details">{{ check.message }}</div>
              <div class="check-weight" *ngIf="check.weight">Weight: {{ check.weight }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input / Expected / Actual Comparison -->
      <div class="comparison-section">
        <h3>Data Comparison</h3>
        <div class="comparison-tabs">
          <button class="comparison-tab" [class.active]="comparisonView === 'input'" (click)="setComparisonView('input')">
            Input
          </button>
          <button class="comparison-tab" [class.active]="comparisonView === 'expected'" (click)="setComparisonView('expected')">
            Expected
          </button>
          <button class="comparison-tab" [class.active]="comparisonView === 'actual'" (click)="setComparisonView('actual')">
            Actual
          </button>
        </div>
        <div class="comparison-content">
          <pre>{{ getComparisonData() | json }}</pre>
        </div>
      </div>
    </div>

    <!-- Details Tab -->
    <div class="details-tab" *ngIf="activeTab === 'details'">
      <div class="details-grid">
        <div class="detail-item">
          <div class="detail-label">Test Run ID</div>
          <div class="detail-value">{{ record.ID }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Test</div>
          <div class="detail-value">
            <a href="javascript:void(0)" (click)="openTest()" *ngIf="test">{{ test.Name }}</a>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Status</div>
          <div class="detail-value">{{ record.Status }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Target Type</div>
          <div class="detail-value">{{ record.TargetType || 'N/A' }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Started At</div>
          <div class="detail-value">{{ record.StartedAt | date:'medium' }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Completed At</div>
          <div class="detail-value">{{ record.CompletedAt | date:'medium' }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Duration</div>
          <div class="detail-value">{{ calculateDuration() }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Score</div>
          <div class="detail-value">{{ formatScore(record.Score) }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Cost</div>
          <div class="detail-value">{{ formatCost(record.CostUSD) }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Passed Checks</div>
          <div class="detail-value">{{ record.PassedChecks }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Failed Checks</div>
          <div class="detail-value">{{ record.FailedChecks }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Total Checks</div>
          <div class="detail-value">{{ record.TotalChecks }}</div>
        </div>
      </div>

      <div class="error-message" *ngIf="record.ErrorMessage">
        <h4>Error Message</h4>
        <pre>{{ record.ErrorMessage }}</pre>
      </div>

      <div class="result-details-json" *ngIf="record.ResultDetails">
        <h4>Full Result Details (JSON)</h4>
        <pre>{{ parsedData.resultDetails | json }}</pre>
      </div>
    </div>

    <!-- AI Runs Tab -->
    <div class="ai-runs-tab" *ngIf="activeTab === 'ai-runs'">
      <div class="ai-runs-section" *ngIf="aiAgentRuns.length > 0">
        <h3>AI Agent Runs ({{ aiAgentRuns.length }})</h3>
        <div class="ai-run-list">
          <div class="ai-run-card" *ngFor="let run of aiAgentRuns" (click)="openAIAgentRun(run.ID)">
            <div class="ai-run-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div class="ai-run-content">
              <div class="ai-run-name">{{ run.Agent }}</div>
              <div class="ai-run-meta">
                <span>{{ run.Status }}</span>
                <span *ngIf="run.TotalCost">${{ run.TotalCost }}</span>
              </div>
            </div>
            <i class="fas fa-external-link-alt"></i>
          </div>
        </div>
      </div>

      <div class="ai-runs-section" *ngIf="aiPromptRuns.length > 0">
        <h3>AI Prompt Runs ({{ aiPromptRuns.length }})</h3>
        <div class="ai-run-list">
          <div class="ai-run-card" *ngFor="let run of aiPromptRuns" (click)="openAIPromptRun(run.ID)">
            <div class="ai-run-icon prompt">
              <i class="fas fa-comment-dots"></i>
            </div>
            <div class="ai-run-content">
              <div class="ai-run-name">{{ run.Prompt || run.Model }}</div>
              <div class="ai-run-meta">
                <span *ngIf="run.TotalCost">${{ run.TotalCost }}</span>
              </div>
            </div>
            <i class="fas fa-external-link-alt"></i>
          </div>
        </div>
      </div>

      <div class="no-data" *ngIf="aiRunsLoaded && aiAgentRuns.length === 0 && aiPromptRuns.length === 0">
        <i class="fas fa-inbox"></i>
        <p>No AI runs associated with this test execution</p>
      </div>
    </div>

    <!-- Feedback Tab -->
    <div class="feedback-tab" *ngIf="activeTab === 'feedback'">
      <div class="feedback-list" *ngIf="feedbacks.length > 0">
        <div class="feedback-item" *ngFor="let feedback of feedbacks">
          <div class="feedback-header">
            <div class="feedback-user">
              <i class="fas fa-user"></i>
              {{ feedback.ReviewerUserID }}
            </div>
            <div class="feedback-date">
              {{ feedback.__mj_CreatedAt | date:'medium' }}
            </div>
          </div>
          <div class="feedback-rating">
            Rating: {{ feedback.Rating }}/10
          </div>
          <div class="feedback-correct" *ngIf="feedback.IsCorrect !== null">
            Automated Result: {{ feedback.IsCorrect ? 'Correct' : 'Incorrect' }}
          </div>
          <div class="feedback-comments" *ngIf="feedback.CorrectionSummary">
            {{ feedback.CorrectionSummary }}
          </div>
        </div>
      </div>

      <div class="no-data" *ngIf="feedbackLoaded && feedbacks.length === 0">
        <i class="fas fa-inbox"></i>
        <p>No feedback submitted for this test run</p>
      </div>
    </div>
  </div>
</div>
