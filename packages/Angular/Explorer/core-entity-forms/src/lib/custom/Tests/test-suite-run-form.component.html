<div class="test-suite-run-form" kendoDialogContainer>
  <!-- Header Section -->
  <div class="suite-run-header">
    <!-- Breadcrumb -->
    <div class="breadcrumb" *ngIf="testSuite">
      <a href="javascript:void(0)" (click)="openTestSuite()">
        <i class="fas fa-layer-group"></i>
        {{ testSuite.Name }}
      </a>
      <i class="fas fa-chevron-right separator"></i>
      <span class="current">Run #{{ record.ID.substring(0, 8) }}</span>
    </div>

    <!-- Header Content -->
    <div class="header-content">
      <div class="header-left">
        <div class="suite-run-icon" [style.background-color]="getStatusColor()">
          <i class="fas" [ngClass]="getStatusIcon()"></i>
        </div>
        <div class="suite-run-info">
          <h1>Suite Run</h1>
          <div class="suite-run-meta">
            <span class="status-badge" [ngClass]="getStatusClass()">
              <i class="fas" [ngClass]="getStatusIcon()"></i>
              {{ record.Status }}
            </span>
            <span class="meta-tag environment" *ngIf="record.Environment">
              <i class="fas fa-server"></i>
              {{ record.Environment }}
            </span>
            <span class="meta-tag trigger" *ngIf="record.TriggerType">
              <i class="fas fa-bolt"></i>
              {{ record.TriggerType }}
            </span>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button kendoButton (click)="reRunSuite()" themeColor="primary" icon="play" *ngIf="record.SuiteID">
          Re-run Suite
        </button>
        <button kendoButton (click)="refresh()" icon="sync" [disabled]="isRefreshing">
          <i *ngIf="isRefreshing" class="fas fa-sync fa-spin"></i>
          {{ isRefreshing ? 'Refreshing...' : 'Refresh' }}
        </button>
      </div>
    </div>

    <!-- Metrics Bar -->
    <div class="metrics-bar">
      <div class="metric-card">
        <div class="metric-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="metric-content">
          <div class="metric-value">{{ calculateDuration() }}</div>
          <div class="metric-label">Duration</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">
          <i class="fas fa-percentage"></i>
        </div>
        <div class="metric-content">
          <div class="metric-value">{{ getPassRate().toFixed(1) }}%</div>
          <div class="metric-label">Pass Rate</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="metric-content">
          <div class="metric-value">{{ formatCost(record.TotalCostUSD) }}</div>
          <div class="metric-label">Total Cost</div>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-icon">
          <i class="fas fa-calendar"></i>
        </div>
        <div class="metric-content">
          <div class="metric-value">{{ getRelativeTime(record.StartedAt) }}</div>
          <div class="metric-label">Started</div>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="results-summary">
      <div class="result-item passed">
        <div class="result-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="result-content">
          <span class="result-count">{{ record.PassedTests || 0 }}</span>
          <span class="result-label">Passed</span>
        </div>
      </div>
      <div class="result-item failed">
        <div class="result-icon">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="result-content">
          <span class="result-count">{{ record.FailedTests || 0 }}</span>
          <span class="result-label">Failed</span>
        </div>
      </div>
      <div class="result-item error">
        <div class="result-icon">
          <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="result-content">
          <span class="result-count">{{ record.ErrorTests || 0 }}</span>
          <span class="result-label">Errors</span>
        </div>
      </div>
      <div class="result-item skipped">
        <div class="result-icon">
          <i class="fas fa-forward"></i>
        </div>
        <div class="result-content">
          <span class="result-count">{{ record.SkippedTests || 0 }}</span>
          <span class="result-label">Skipped</span>
        </div>
      </div>
      <div class="result-item total">
        <div class="result-icon">
          <i class="fas fa-list"></i>
        </div>
        <div class="result-content">
          <span class="result-count">{{ record.TotalTests || 0 }}</span>
          <span class="result-label">Total</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <div class="tabs" role="tablist">
      <button class="tab"
              [class.active]="activeTab === 'overview'"
              (click)="changeTab('overview')"
              role="tab"
              [attr.aria-selected]="activeTab === 'overview'">
        <i class="fas fa-th-large"></i> Overview
      </button>
      <button class="tab"
              [class.active]="activeTab === 'runs'"
              (click)="changeTab('runs')"
              role="tab"
              [attr.aria-selected]="activeTab === 'runs'">
        <i class="fas fa-list"></i> Test Runs
        <span class="tab-badge" *ngIf="testRunsLoaded">{{ testRuns.length }}</span>
      </button>
      <button class="tab"
              [class.active]="activeTab === 'details'"
              (click)="changeTab('details')"
              role="tab"
              [attr.aria-selected]="activeTab === 'details'">
        <i class="fas fa-info-circle"></i> Details
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="overview-tab" *ngIf="activeTab === 'overview'">
      <!-- Result Hero -->
      <div class="result-hero"
           [class.passed]="record.Status === 'Completed' && getPassRate() >= 90"
           [class.failed]="record.Status === 'Failed' || getPassRate() < 50"
           [class.running]="record.Status === 'Running'"
           [class.pending]="record.Status === 'Pending'">
        <div class="result-hero-icon">
          <i class="fas" [ngClass]="getStatusIcon()"></i>
        </div>
        <div class="result-hero-text">
          <h2>SUITE {{ record.Status.toUpperCase() || 'UNKNOWN' }}</h2>
          <div class="result-hero-stats">
            <div class="stat-item">
              <span class="stat-value">{{ getPassRate().toFixed(1) }}%</span>
              <span class="stat-label">Pass Rate</span>
            </div>
            <div class="stat-divider"></div>
            <div class="stat-item">
              <span class="stat-value">{{ record.PassedTests || 0 }} / {{ record.TotalTests || 0 }}</span>
              <span class="stat-label">Tests Passed</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Ring (when running) -->
      <div class="progress-section" *ngIf="record.Status === 'Running' || record.Status === 'Pending'">
        <div class="progress-info">
          <i class="fas fa-circle-notch fa-spin"></i>
          <span>Suite execution in progress...</span>
        </div>
        <div class="auto-refresh-notice">
          <i class="fas fa-sync"></i>
          Auto-refreshing every 5 seconds
        </div>
      </div>
    </div>

    <!-- Test Runs Tab -->
    <div class="runs-tab" *ngIf="activeTab === 'runs'">
      <!-- Loading State -->
      <div class="loading-state" *ngIf="loadingTestRuns">
        <div class="skeleton-list">
          <div class="skeleton-card" *ngFor="let i of [1,2,3,4,5]">
            <div class="skeleton-sequence"></div>
            <div class="skeleton-icon"></div>
            <div class="skeleton-content">
              <div class="skeleton-line wide"></div>
              <div class="skeleton-line narrow"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Runs List -->
      <div class="test-runs-list" *ngIf="!loadingTestRuns && testRuns.length > 0">
        <div class="test-run-item" *ngFor="let run of testRuns" (click)="openTestRun(run.ID)">
          <div class="run-sequence">{{ run.Sequence || '-' }}</div>
          <div class="run-icon" [style.background-color]="getRunStatusColor(run.Status)">
            <i class="fas" [ngClass]="getRunStatusIcon(run.Status)"></i>
          </div>
          <div class="run-content">
            <div class="run-name">{{ run.Test }}</div>
            <div class="run-meta">
              <span class="run-status" [style.color]="getRunStatusColor(run.Status)">
                {{ run.Status }}
              </span>
              <span class="run-score" *ngIf="run.Score != null">
                <i class="fas fa-star"></i> {{ run.Score.toFixed(4) }}
              </span>
              <span class="run-duration" *ngIf="run.DurationSeconds">
                <i class="fas fa-clock"></i> {{ run.DurationSeconds.toFixed(1) }}s
              </span>
            </div>
          </div>
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="testRunsLoaded && !loadingTestRuns && testRuns.length === 0">
        <div class="empty-icon">
          <i class="fas fa-inbox"></i>
        </div>
        <h4>No Test Runs Found</h4>
        <p>No test runs have been recorded for this suite execution.</p>
      </div>
    </div>

    <!-- Details Tab -->
    <div class="details-tab" *ngIf="activeTab === 'details'">
      <div class="details-card">
        <h3><i class="fas fa-info-circle"></i> Run Information</h3>
        <div class="details-grid">
          <div class="detail-item">
            <div class="detail-label">Run ID</div>
            <div class="detail-value monospace">{{ record.ID }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Test Suite</div>
            <div class="detail-value">
              <a href="javascript:void(0)" (click)="openTestSuite()" *ngIf="testSuite">{{ testSuite.Name }}</a>
              <span *ngIf="!testSuite">Loading...</span>
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value">
              <span class="status-inline" [ngClass]="getStatusClass()">{{ record.Status }}</span>
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Run By</div>
            <div class="detail-value">{{ record.RunByUser || 'N/A' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Started At</div>
            <div class="detail-value">{{ record.StartedAt | date:'medium' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Completed At</div>
            <div class="detail-value">{{ record.CompletedAt | date:'medium' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Environment</div>
            <div class="detail-value">{{ record.Environment || 'N/A' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Trigger Type</div>
            <div class="detail-value">{{ record.TriggerType || 'N/A' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Git Commit</div>
            <div class="detail-value monospace">{{ record.GitCommit || 'N/A' }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Agent Version</div>
            <div class="detail-value">{{ record.AgentVersion || 'N/A' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Keyboard Shortcuts Hint (Desktop Only) -->
  <div class="keyboard-shortcuts">
    <div class="shortcuts-header">
      <i class="fas fa-keyboard"></i>
      Shortcuts
    </div>
    <div class="shortcut-list">
      <div class="shortcut-item">
        <span>Refresh</span>
        <span class="shortcut-keys"><kbd>Cmd</kbd><kbd>R</kbd></span>
      </div>
      <div class="shortcut-item">
        <span>Re-run Suite</span>
        <span class="shortcut-keys"><kbd>Cmd</kbd><kbd>Shift</kbd><kbd>R</kbd></span>
      </div>
      <div class="shortcut-item">
        <span>Switch Tabs</span>
        <span class="shortcut-keys"><kbd>1</kbd>-<kbd>3</kbd></span>
      </div>
    </div>
  </div>
</div>
