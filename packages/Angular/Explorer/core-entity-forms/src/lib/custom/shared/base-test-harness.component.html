<!-- Shared Test Harness Template -->
<div class="test-harness-container">
    <!-- Header Section -->
    <div class="test-harness-header">
        <ng-content select="[slot=header]"></ng-content>
    </div>

    <!-- Main Content Area -->
    <div class="test-harness-main">
        <!-- Sidebar -->
        <div class="test-harness-sidebar">
            <!-- Tab Navigation -->
            <div class="sidebar-tabs">
                <button class="tab-button" 
                        [class.active]="activeTab === 'variables'"
                        (click)="activeTab = 'variables'">
                    <i class="fa-solid fa-code"></i> Variables
                </button>
                <button class="tab-button" 
                        [class.active]="activeTab === 'savedConversations'"
                        (click)="activeTab = 'savedConversations'">
                    <i class="fa-solid fa-bookmark"></i> Saved
                </button>
                <button class="tab-button" 
                        [class.active]="activeTab === 'settings'"
                        (click)="activeTab = 'settings'">
                    <i class="fa-solid fa-cog"></i> Settings
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Variables Tab -->
                @if (activeTab === 'variables') {
                    <div class="variables-panel">
                        <div class="panel-header">
                            <h4><i class="fa-solid fa-code"></i> Variables</h4>
                            <button class="add-variable-btn" (click)="addVariable()" title="Add Variable">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        
                        <div class="variables-list">
                            @if (variables.length === 0) {
                                <div class="empty-state">
                                    <i class="fa-solid fa-code"></i>
                                    <p>No variables defined</p>
                                    <button class="btn-secondary" (click)="addVariable()">
                                        <i class="fa-solid fa-plus"></i> Add Variable
                                    </button>
                                </div>
                            } @else {
                                @for (variable of variables; track $index) {
                                    <div class="variable-item">
                                        <div class="variable-header">
                                            <input type="text" 
                                                   [(ngModel)]="variable.name" 
                                                   placeholder="Variable name"
                                                   class="variable-name-input">
                                            <select [(ngModel)]="variable.type" 
                                                    (change)="onVariableTypeChange(variable)"
                                                    class="variable-type-select">
                                                <option value="string">String</option>
                                                <option value="number">Number</option>
                                                <option value="boolean">Boolean</option>
                                                <option value="object">Object</option>
                                                <option value="array">Array</option>
                                            </select>
                                            <button class="remove-variable-btn" 
                                                    (click)="removeVariable($index)"
                                                    title="Remove Variable">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                        
                                        @if (variable.type === 'boolean') {
                                            <select [(ngModel)]="variable.value" class="variable-value-input">
                                                <option value="true">true</option>
                                                <option value="false">false</option>
                                            </select>
                                        } @else if (variable.type === 'object' || variable.type === 'array') {
                                            <textarea [(ngModel)]="variable.value" 
                                                      placeholder="JSON value"
                                                      class="variable-value-textarea"
                                                      rows="3"></textarea>
                                        } @else {
                                            <input type="text" 
                                                   [(ngModel)]="variable.value" 
                                                   placeholder="Variable value"
                                                   class="variable-value-input">
                                        }
                                        
                                        @if (variable.description !== undefined) {
                                            <input type="text" 
                                                   [(ngModel)]="variable.description" 
                                                   placeholder="Description (optional)"
                                                   class="variable-description-input">
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }

                <!-- Saved Conversations Tab -->
                @if (activeTab === 'savedConversations') {
                    <div class="saved-conversations-panel">
                        <div class="panel-header">
                            <h4><i class="fa-solid fa-bookmark"></i> Saved Conversations</h4>
                        </div>
                        
                        @if (savedConversations.length === 0) {
                            <div class="empty-state">
                                <i class="fa-solid fa-bookmark"></i>
                                <p>No saved conversations</p>
                            </div>
                        } @else {
                            <div class="conversations-list">
                                @for (conversation of savedConversations; track conversation.id) {
                                    <div class="conversation-item" 
                                         [class.current]="currentConversationId === conversation.id">
                                        <div class="conversation-header">
                                            <h5>{{ conversation.name }}</h5>
                                            <div class="conversation-actions">
                                                <button class="btn-small" 
                                                        (click)="loadConversation(conversation)"
                                                        title="Load Conversation">
                                                    <i class="fa-solid fa-folder-open"></i>
                                                </button>
                                                <button class="btn-small btn-danger" 
                                                        (click)="deleteConversation(conversation)"
                                                        title="Delete Conversation">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="conversation-meta">
                                            <ng-content select="[slot=conversation-meta]" 
                                                        [ngTemplateOutlet]="conversationMetaTemplate"
                                                        [ngTemplateOutletContext]="{ $implicit: conversation }">
                                            </ng-content>
                                            <small>{{ conversation.messages.length }} messages</small>
                                            <small>{{ conversation.updatedAt | date:'short' }}</small>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }

                <!-- Settings Tab -->
                @if (activeTab === 'settings') {
                    <div class="settings-panel">
                        <div class="panel-header">
                            <h4><i class="fa-solid fa-cog"></i> Settings</h4>
                        </div>
                        
                        <ng-content select="[slot=settings]"></ng-content>
                    </div>
                }
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="test-harness-chat">
            <!-- Chat Messages -->
            <div class="messages-container" #messagesContainer>
                @if (conversationMessages.length === 0) {
                    <div class="empty-conversation">
                        <ng-content select="[slot=empty-state]"></ng-content>
                    </div>
                } @else {
                    @for (message of conversationMessages; track message.id) {
                        <div class="message-wrapper" [class]="message.role">
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-role">
                                        @if (message.role === 'user') {
                                            <i class="fa-solid fa-user"></i> You
                                        } @else if (message.role === 'assistant') {
                                            <i class="fa-solid fa-robot"></i> Assistant
                                        } @else {
                                            <i class="fa-solid fa-cog"></i> System
                                        }
                                    </span>
                                    <span class="message-time">{{ message.timestamp | date:'short' }}</span>
                                    
                                    @if (message.role === 'assistant' && message.executionTime) {
                                        <span class="execution-time">
                                            <i class="fa-solid fa-clock"></i> 
                                            {{ formatExecutionTime(message.executionTime) }}
                                        </span>
                                    }
                                </div>

                                <div class="message-body">
                                    @if (message.isStreaming) {
                                        <div class="streaming-content">
                                            <span [innerHTML]="formatMessageContent(message)"></span>
                                            @if (message.elapsedTime) {
                                                <span class="elapsed-time">
                                                    {{ formatElapsedTime(message.elapsedTime) }}
                                                </span>
                                            }
                                        </div>
                                    } @else {
                                        <div class="final-content" [innerHTML]="formatMessageContent(message)"></div>
                                    }

                                    @if (message.error) {
                                        <div class="message-error">
                                            <i class="fa-solid fa-exclamation-triangle"></i>
                                            {{ message.error }}
                                        </div>
                                    }
                                </div>

                                <!-- Raw Content Toggle -->
                                @if (message.role === 'assistant' && !message.isStreaming && (message.rawContent || message.content)) {
                                    <div class="message-actions">
                                        <button class="btn-text" (click)="toggleRawContent(message)">
                                            <i class="fa-solid" [class.fa-eye]="!message.showRaw" [class.fa-eye-slash]="message.showRaw"></i>
                                            {{ message.showRaw ? 'Hide' : 'Show' }} Raw
                                        </button>
                                        
                                        @if (isJsonString(message.rawContent || message.content)) {
                                            <button class="btn-text" (click)="toggleJsonRaw(message)">
                                                <i class="fa-solid fa-code"></i>
                                                {{ message.showJsonRaw ? 'Hide' : 'Show' }} JSON
                                            </button>
                                        }
                                    </div>

                                    @if (message.showRaw) {
                                        <div class="raw-content" [innerHTML]="getFormattedRawContent(message)"></div>
                                    }

                                    @if (message.showJsonRaw && isJsonString(message.rawContent || message.content)) {
                                        <div class="json-content">
                                            <pre><code>{{ getFormattedJsonContent(message) }}</code></pre>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                }
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <textarea [(ngModel)]="currentUserMessage" 
                              placeholder="Type your message..."
                              class="message-input"
                              rows="3"
                              [disabled]="isExecuting"
                              (keydown.ctrl.enter)="sendMessage()"
                              (keydown.meta.enter)="sendMessage()"></textarea>
                    
                    <div class="input-actions">
                        <div class="input-actions-left">
                            <button class="btn-secondary" 
                                    (click)="clearConversation()"
                                    [disabled]="conversationMessages.length === 0">
                                <i class="fa-solid fa-trash"></i> Clear
                            </button>
                            <button class="btn-secondary" 
                                    (click)="saveConversation()"
                                    [disabled]="conversationMessages.length === 0">
                                <i class="fa-solid fa-save"></i> Save
                            </button>
                        </div>
                        
                        <div class="input-actions-right">
                            <button class="btn-primary" 
                                    (click)="sendMessage()"
                                    [disabled]="!currentUserMessage.trim() || isExecuting">
                                @if (isExecuting) {
                                    <i class="fa-solid fa-spinner fa-spin"></i> Processing...
                                } @else {
                                    <i class="fa-solid fa-paper-plane"></i> Send
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for import/export -->
<input type="file" 
       #fileInput 
       accept=".json" 
       style="display: none;"
       (change)="onFileSelected($event)">