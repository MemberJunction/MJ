<div class="record-form-container">
    @if (record) {
        <form class="record-form" #form="ngForm">
            <mj-form-toolbar [Form]="this"></mj-form-toolbar>

            <!-- Header Section -->
            <div class="prompt-run-header">
                <div class="header-content">
                    <div class="run-overview">
                        <div class="run-icon-wrapper" [style.background-color]="getStatusColor() + '20'">
                            <i [class]="'fa-solid ' + getStatusIcon()" [style.color]="getStatusColor()"></i>
                        </div>
                        <div class="run-info">
                            <h1 class="run-title">
                                Prompt Run
                                @if (record.ID) {
                                    <span class="run-id">#{{ record.ID.substring(0, 8) }}</span>
                                }
                            </h1>
                            <div class="run-meta">
                                <span class="status-badge" [style.background-color]="getStatusColor()">
                                    <i [class]="'fa-solid ' + getStatusIcon()"></i>
                                    {{ getStatusText() }}
                                </span>
                                @if (record.RunType) {
                                    <span class="run-type-badge" [style.color]="getRunTypeColor(record.RunType)">
                                        <i [class]="'fa-solid ' + getRunTypeIcon(record.RunType)"></i>
                                        {{ record.RunType }}
                                    </span>
                                }
                                @if (prompt) {
                                    <span class="prompt-name" (click)="navigateToEntity('MJ: AI Prompts', prompt.ID)" title="View Prompt">
                                        <i class="fa-solid fa-comment-dots"></i>
                                        {{ prompt.Name }}
                                    </span>
                                }
                                @if (model) {
                                    <span class="model-name" (click)="navigateToEntity('MJ: AI Models', model.ID)" title="View Model">
                                        <i class="fa-solid fa-microchip"></i>
                                        {{ model.Name }}
                                    </span>
                                }
                                @if (record.Vendor) {
                                    <span class="vendor-name" (click)="navigateToEntity('MJ: AI Vendors', record.VendorID)" title="View Vendor">
                                        <i class="fa-solid fa-building"></i>
                                        {{ record.Vendor }}
                                    </span>
                                }
                                @if (record.RerunFromPromptRunID) {
                                    <span class="original-run" title="View Original Run">
                                        <i class="fa-solid fa-level-up-alt"></i>
                                        <a (click)="navigateToOriginalRun()" class="original-link">Original Run</a>
                                    </span>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="run-actions">
                        <button kendoButton fillMode="outline" size="small" (click)="reRunPrompt()" title="Re-run this prompt">
                            <i class="fa-solid fa-play-circle"></i>
                            Re-Run
                        </button>
                        <button kendoButton fillMode="outline" size="small" (click)="refreshData()" title="Refresh data">
                            <i class="fa-solid fa-refresh"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Key Metrics Bar -->
                @if (record.ConfigurationID) {
                    <!-- Configuration Bar -->
                    <div class="metrics-bar">
                        <div class="metric-item">
                            <i class="fa-solid fa-cog"></i>
                            <div class="metric-content">
                                <div class="metric-label">Configuration</div>
                                <div class="metric-value">
                                    <a href="javascript:void(0)" class="config-link" (click)="navigateToEntity('MJ: AI Configurations', record.ConfigurationID)">
                                        {{ record.Configuration || 'Unknown' }}
                                    </a>
                                </div>
                            </div>
                        </div>
                        @if (record.Temperature !== null && record.Temperature !== undefined) {
                            <div class="metric-item">
                                <i class="fa-solid fa-temperature-high"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Temperature</div>
                                    <div class="metric-value">{{ record.Temperature }}</div>
                                </div>
                            </div>
                        }
                        @if (record.TopP !== null && record.TopP !== undefined) {
                            <div class="metric-item">
                                <i class="fa-solid fa-percentage"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Top P</div>
                                    <div class="metric-value">{{ record.TopP }}</div>
                                </div>
                            </div>
                        }
                        @if (record.TopK !== null && record.TopK !== undefined) {
                            <div class="metric-item">
                                <i class="fa-solid fa-list-ol"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Top K</div>
                                    <div class="metric-value">{{ record.TopK }}</div>
                                </div>
                            </div>
                        }
                        @if (record.EffortLevel !== null && record.EffortLevel !== undefined) {
                            <div class="metric-item">
                                <i class="fa-solid fa-tachometer-alt"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Effort Level</div>
                                    <div class="metric-value">{{ record.EffortLevel }}</div>
                                </div>
                            </div>
                        }
                        @if (record.ResponseFormat) {
                            <div class="metric-item">
                                <i class="fa-solid fa-code"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Response Format</div>
                                    <div class="metric-value">{{ record.ResponseFormat }}</div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Execution Metrics Bar (always show when configuration exists) -->
                    <div class="metrics-bar">
                        <div class="metric-item">
                            <i class="fa-solid fa-clock"></i>
                            <div class="metric-content">
                                <div class="metric-label">Duration</div>
                                <div class="metric-value">{{ formatDuration(record.ExecutionTimeMS) }}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <i class="fa-solid fa-coins"></i>
                            <div class="metric-content">
                                <div class="metric-label">Total Tokens</div>
                                <div class="metric-value">{{ formatTokens(record.TokensUsed) }}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <i class="fa-solid fa-dollar-sign"></i>
                            <div class="metric-content">
                                <div class="metric-label">Cost</div>
                                <div class="metric-value">{{ formatCost(record.TotalCost || record.Cost) }}</div>
                            </div>
                        </div>
                        @if (record.RunAt) {
                            <div class="metric-item">
                                <i class="fa-solid fa-calendar"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Started</div>
                                    <div class="metric-value">{{ record.RunAt | date:'short' }}</div>
                                </div>
                            </div>
                        }
                    </div>
                } @else {
                    <!-- Execution Metrics Bar (original behavior when no configuration) -->
                    <div class="metrics-bar">
                        <div class="metric-item">
                            <i class="fa-solid fa-clock"></i>
                            <div class="metric-content">
                                <div class="metric-label">Duration</div>
                                <div class="metric-value">{{ formatDuration(record.ExecutionTimeMS) }}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <i class="fa-solid fa-coins"></i>
                            <div class="metric-content">
                                <div class="metric-label">Total Tokens</div>
                                <div class="metric-value">{{ formatTokens(record.TokensUsed) }}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <i class="fa-solid fa-dollar-sign"></i>
                            <div class="metric-content">
                                <div class="metric-label">Cost</div>
                                <div class="metric-value">{{ formatCost(record.TotalCost || record.Cost) }}</div>
                            </div>
                        </div>
                        @if (record.RunAt) {
                            <div class="metric-item">
                                <i class="fa-solid fa-calendar"></i>
                                <div class="metric-content">
                                    <div class="metric-label">Started</div>
                                    <div class="metric-value">{{ record.RunAt | date:'short' }}</div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            <!-- Main Content with Expansion Panels -->
            <div class="form-content">
                <kendo-panelbar [keepItemContent]="true">
                    
                    <!-- Input Panel with nested sub-panels -->
                    <kendo-panelbar-item [expanded]="inputExpanded" (stateChange)="onInputPanelToggle($event)">
                        <ng-template kendoPanelBarItemTitle>
                            <span class="panel-title">
                                <i class="fa-solid fa-comment-dots"></i>
                                Input
                                @if (record.Messages && record.Messages.trim() !== '') {
                                    <span class="panel-badge">JSON</span>
                                }
                            </span>
                        </ng-template>
                        <ng-template kendoPanelBarContent>
                            <div class="panel-content">
                                @if (record.Messages && record.Messages.trim() !== '') {
                                    <!-- Nested expansion panels for sub-sections -->
                                    <div class="nested-panels">
                                        <!-- Messages Sub-Panel -->
                                        <kendo-expansionpanel 
                                            [expanded]="messagesExpanded" 
                                            class="sub-expansion-panel"
                                            [animation]="false">
                                            <ng-template kendoExpansionPanelTitleDirective>
                                                <span class="sub-panel-title">
                                                    <i class="fa-solid fa-comments"></i>
                                                    Messages
                                                    @if (chatMessages.length > 0) {
                                                        <span class="panel-count">({{ chatMessages.length }})</span>
                                                    }
                                                </span>
                                            </ng-template>
                                            <div class="sub-panel-content">
                                                @if (isParsingMessages || isLoadingRelatedData) {
                                                    <div class="loading-state">
                                                        <i class="fa-solid fa-spinner fa-spin"></i>
                                                        <p>Loading messages...</p>
                                                    </div>
                                                } @else if (chatMessages.length > 0) {
                                                    <mj-chat-message-viewer 
                                                        [messages]="chatMessages">
                                                    </mj-chat-message-viewer>
                                                } @else {
                                                    <div class="empty-state">
                                                        <i class="fa-solid fa-comment-slash"></i>
                                                        <p>No chat messages found</p>
                                                    </div>
                                                }
                                            </div>
                                        </kendo-expansionpanel>
                                        
                                        <!-- Data Sub-Panel -->
                                        <kendo-expansionpanel 
                                            [expanded]="dataExpanded" 
                                            class="sub-expansion-panel"
                                            [animation]="false">
                                            <ng-template kendoExpansionPanelTitleDirective>
                                                <span class="sub-panel-title">
                                                    <i class="fa-solid fa-database"></i>
                                                    Data
                                                    @if (inputData) {
                                                        <span class="panel-badge">Object</span>
                                                    }
                                                </span>
                                            </ng-template>
                                            <div class="sub-panel-content">
                                                @if (inputData && formattedData) {
                                                    <div class="json-editor-container">
                                                        <div class="json-toolbar">
                                                            <button kendoButton
                                                                fillMode="flat" 
                                                                size="small"
                                                                (click)="copyToClipboard(formattedData, 'Data')"
                                                                title="Copy JSON">
                                                                <i class="fa-solid fa-copy"></i> Copy
                                                            </button>
                                                        </div>
                                                        <mj-code-editor 
                                                            [(ngModel)]="formattedData"
                                                            name="formattedData"
                                                            [readonly]="true"
                                                            [language]="'json'"
                                                            [lineWrapping]="true"
                                                            style="height: 300px; width: 100%;">
                                                        </mj-code-editor>
                                                    </div>
                                                } @else {
                                                    <div class="empty-state">
                                                        <i class="fa-solid fa-database"></i>
                                                        <p>No data object found</p>
                                                    </div>
                                                }
                                            </div>
                                        </kendo-expansionpanel>
                                        
                                        <!-- Raw Sub-Panel -->
                                        <kendo-expansionpanel 
                                            [expanded]="rawExpanded" 
                                            class="sub-expansion-panel"
                                            [animation]="false">
                                            <ng-template kendoExpansionPanelTitleDirective>
                                                <span class="sub-panel-title">
                                                    <i class="fa-solid fa-code"></i>
                                                    Raw
                                                </span>
                                            </ng-template>
                                            <div class="sub-panel-content">
                                                <div class="json-editor-container">
                                                    <div class="json-toolbar">
                                                        <button kendoButton
                                                            fillMode="flat" 
                                                            size="small"
                                                            (click)="copyToClipboard(formattedMessages, 'Messages')"
                                                            title="Copy JSON">
                                                            <i class="fa-solid fa-copy"></i> Copy
                                                        </button>
                                                    </div>
                                                    <mj-code-editor 
                                                        [(ngModel)]="formattedMessages"
                                                        name="formattedMessages"
                                                        [readonly]="true"
                                                        [language]="'json'"
                                                        [lineWrapping]="true"
                                                        style="height: 400px; width: 100%;">
                                                    </mj-code-editor>
                                                </div>
                                            </div>
                                        </kendo-expansionpanel>
                                    </div>
                                } @else {
                                    <div class="empty-state">
                                        <i class="fa-solid fa-comment-slash"></i>
                                        <p>No input messages recorded</p>
                                    </div>
                                }
                            </div>
                        </ng-template>
                    </kendo-panelbar-item>
                    
                    <!-- Result Panel -->
                    <kendo-panelbar-item [expanded]="resultExpanded" (stateChange)="onResultPanelToggle($event)">
                        <ng-template kendoPanelBarItemTitle>
                            <span class="panel-title">
                                <i class="fa-solid fa-square-check"></i>
                                Result
                                @if (record.Result && record.Result.trim() !== '') {
                                    <span class="panel-badge">JSON</span>
                                }
                                @if (record.ErrorMessage) {
                                    <span class="panel-badge error">Error</span>
                                }
                            </span>
                        </ng-template>
                        <ng-template kendoPanelBarContent>
                            <div class="panel-content">
                                @if (record.ErrorMessage) {
                                    <div class="error-message">
                                        <i class="fa-solid fa-exclamation-triangle"></i>
                                        <div class="error-content">
                                            <h4>Error Message</h4>
                                            <p>{{ record.ErrorMessage }}</p>
                                        </div>
                                    </div>
                                }
                                
                                @if (record.Result && record.Result.trim() !== '') {
                                    <div class="json-editor-container">
                                        <div class="json-toolbar">
                                            <button kendoButton
                                                fillMode="flat" 
                                                size="small"
                                                (click)="copyToClipboard(formattedResult, 'Result')"
                                                title="Copy JSON">
                                                <i class="fa-solid fa-copy"></i> Copy
                                            </button>
                                        </div>
                                        <mj-code-editor 
                                            [(ngModel)]="formattedResult"
                                            name="formattedResult"
                                            [readonly]="true"
                                            [language]="'json'"
                                            [lineWrapping]="true"
                                            style="height: 400px; width: 100%;">
                                        </mj-code-editor>
                                    </div>
                                } @else if (!record.ErrorMessage) {
                                    <div class="empty-state">
                                        <i class="fa-solid fa-inbox"></i>
                                        <p>No result data recorded</p>
                                        @if (record.Status === 'Failed' || record.Success === false) {
                                            <div class="error-info">
                                                @if (record.Status) {
                                                    <p class="finish-reason">
                                                        <strong>Status:</strong> {{ record.Status }}
                                                    </p>
                                                }
                                                @if (formattedErrorDetails) {
                                                    <div class="error-details">
                                                        <h4>Error Details</h4>
                                                        <mj-code-editor
                                                            [ngModel]="formattedErrorDetails"
                                                            [disabled]="true"
                                                            [language]="'json'"
                                                            [lineWrapping]="true"
                                                            style="height: 200px; width: 100%;">
                                                        </mj-code-editor>
                                                    </div>
                                                }
                                                @if (!formattedErrorDetails) {
                                                    <p class="error-hint">
                                                        The prompt execution failed but no additional error information is available.
                                                    </p>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </ng-template>
                    </kendo-panelbar-item>
                    
                    <!-- Token Usage & Metrics Panel -->
                    <kendo-panelbar-item [expanded]="metricsExpanded" (stateChange)="onMetricsPanelToggle($event)">
                        <ng-template kendoPanelBarItemTitle>
                            <span class="panel-title">
                                <i class="fa-solid fa-chart-line"></i>
                                Token Usage & Metrics
                            </span>
                        </ng-template>
                        <ng-template kendoPanelBarContent>
                            <div class="panel-content">
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-header">
                                            <i class="fa-solid fa-message"></i>
                                            <h4>Prompt Tokens</h4>
                                        </div>
                                        <div class="metric-value large">{{ formatTokens(record.TokensPrompt) }}</div>
                                        @if (record.TokensPromptRollup && record.TokensPromptRollup !== record.TokensPrompt) {
                                            <div class="metric-rollup">
                                                <span>Rollup: {{ formatTokens(record.TokensPromptRollup) }}</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-header">
                                            <i class="fa-solid fa-reply"></i>
                                            <h4>Completion Tokens</h4>
                                        </div>
                                        <div class="metric-value large">{{ formatTokens(record.TokensCompletion) }}</div>
                                        @if (record.TokensCompletionRollup && record.TokensCompletionRollup !== record.TokensCompletion) {
                                            <div class="metric-rollup">
                                                <span>Rollup: {{ formatTokens(record.TokensCompletionRollup) }}</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-header">
                                            <i class="fa-solid fa-coins"></i>
                                            <h4>Total Tokens</h4>
                                        </div>
                                        <div class="metric-value large">{{ formatTokens(record.TokensUsed) }}</div>
                                        @if (record.TokensUsedRollup && record.TokensUsedRollup !== record.TokensUsed) {
                                            <div class="metric-rollup">
                                                <span>Rollup: {{ formatTokens(record.TokensUsedRollup) }}</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-header">
                                            <i class="fa-solid fa-dollar-sign"></i>
                                            <h4>Cost</h4>
                                        </div>
                                        <div class="metric-value large">{{ formatCost(record.Cost) }}</div>
                                        @if (record.TotalCost && record.TotalCost !== record.Cost) {
                                            <div class="metric-rollup">
                                                <span>Total: {{ formatCost(record.TotalCost) }}</span>
                                            </div>
                                        }
                                        @if (record.CostCurrency) {
                                            <div class="metric-currency">{{ record.CostCurrency }}</div>
                                        }
                                    </div>
                                    
                                    <!-- Timing Metrics -->
                                    @if (record.QueueTime != null) {
                                        <div class="metric-card">
                                            <div class="metric-header">
                                                <i class="fa-solid fa-hourglass-start"></i>
                                                <h4>Queue Time</h4>
                                            </div>
                                            <div class="metric-value large">{{ formatDuration(record.QueueTime) }}</div>
                                        </div>
                                    }
                                    
                                    @if (record.PromptTime != null) {
                                        <div class="metric-card">
                                            <div class="metric-header">
                                                <i class="fa-solid fa-brain"></i>
                                                <h4>Prompt Time</h4>
                                            </div>
                                            <div class="metric-value large">{{ formatDuration(record.PromptTime) }}</div>
                                        </div>
                                    }
                                    
                                    @if (record.CompletionTime != null) {
                                        <div class="metric-card">
                                            <div class="metric-header">
                                                <i class="fa-solid fa-flag-checkered"></i>
                                                <h4>Completion Time</h4>
                                            </div>
                                            <div class="metric-value large">{{ formatDuration(record.CompletionTime) }}</div>
                                        </div>
                                    }
                                </div>
                                
                                <!-- Additional Metrics -->
                                <div class="additional-metrics">
                                    @if (record.ExecutionOrder !== null) {
                                        <div class="metric-row">
                                            <span class="metric-label">Execution Order:</span>
                                            <span class="metric-value">{{ record.ExecutionOrder }}</span>
                                        </div>
                                    }
                                    @if (record.AgentID) {
                                        <div class="metric-row">
                                            <span class="metric-label">Agent:</span>
                                            <span class="metric-value link" (click)="navigateToEntity('MJ: AI Agents', record.AgentID)">
                                                {{ record.Agent }}
                                                <i class="fa-solid fa-external-link"></i>
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </ng-template>
                    </kendo-panelbar-item>
                    
                    <!-- Validation & Retry Panel -->
                    @if (record && ((record.ValidationAttemptCount && record.ValidationAttemptCount > 0) || record.ValidationBehavior)) {
                        <kendo-panelbar-item [expanded]="validationExpanded" (stateChange)="onValidationPanelToggle($event)">
                            <ng-template kendoPanelBarItemTitle>
                                <span class="panel-title">
                                    <i class="fa-solid fa-shield-check"></i>
                                    Validation & Retries
                                    @if (record && record.ValidationAttemptCount && record.ValidationAttemptCount > 1) {
                                        <span class="panel-count">({{ record.ValidationAttemptCount }} attempts)</span>
                                    }
                                    @if (record.FinalValidationPassed) {
                                        <span class="panel-badge success">Passed</span>
                                    } @else if (record.FinalValidationPassed === false) {
                                        <span class="panel-badge error">Failed</span>
                                    }
                                </span>
                            </ng-template>
                            <ng-template kendoPanelBarContent>
                                <div class="panel-content">
                                    <!-- Validation Summary -->
                                    <div class="validation-summary">
                                        <div class="summary-header">
                                            <h4>Validation Summary</h4>
                                            <div class="validation-status" [class.success]="record.FinalValidationPassed" [class.failed]="!record.FinalValidationPassed">
                                                <i [class]="record.FinalValidationPassed ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle'"></i>
                                                {{ record.FinalValidationPassed ? 'Validation Passed' : 'Validation Failed' }}
                                            </div>
                                        </div>
                                        
                                        <div class="validation-metrics">
                                            <div class="metric-card small">
                                                <div class="metric-label">Total Attempts</div>
                                                <div class="metric-value">{{ record.ValidationAttemptCount || 0 }}</div>
                                            </div>
                                            <div class="metric-card small">
                                                <div class="metric-label">Successful</div>
                                                <div class="metric-value">{{ record.SuccessfulValidationCount || 0 }}</div>
                                            </div>
                                            <div class="metric-card small">
                                                <div class="metric-label">Behavior</div>
                                                <div class="metric-value">{{ record.ValidationBehavior || 'Not set' }}</div>
                                            </div>
                                            <div class="metric-card small">
                                                <div class="metric-label">Retry Strategy</div>
                                                <div class="metric-value">{{ record.RetryStrategy || 'Not set' }}</div>
                                            </div>
                                        </div>
                                        
                                        @if (record.FinalValidationError) {
                                            <div class="validation-error">
                                                <h5><i class="fa-solid fa-exclamation-triangle"></i> Final Validation Error</h5>
                                                <p>{{ record.FinalValidationError }}</p>
                                                @if (record && record.ValidationErrorCount && record.ValidationErrorCount > 0) {
                                                    <span class="error-count">{{ record.ValidationErrorCount }} validation errors</span>
                                                }
                                            </div>
                                        }
                                        
                                        @if (record.CommonValidationError && record.CommonValidationError !== record.FinalValidationError) {
                                            <div class="common-error">
                                                <h5><i class="fa-solid fa-repeat"></i> Most Common Error</h5>
                                                <p>{{ record.CommonValidationError }}</p>
                                            </div>
                                        }
                                    </div>
                                    
                                    <!-- Retry Timeline -->
                                    @if (record && record.ValidationAttemptCount && record.ValidationAttemptCount > 1) {
                                        <div class="retry-timeline">
                                            <h4>Retry Timeline</h4>
                                            <div class="timeline-info">
                                                <div class="timeline-stat">
                                                    <i class="fa-solid fa-clock"></i>
                                                    <span>First Attempt: {{ record.FirstAttemptAt | date:'short' }}</span>
                                                </div>
                                                <div class="timeline-stat">
                                                    <i class="fa-solid fa-flag-checkered"></i>
                                                    <span>Last Attempt: {{ record.LastAttemptAt | date:'short' }}</span>
                                                </div>
                                                <div class="timeline-stat">
                                                    <i class="fa-solid fa-stopwatch"></i>
                                                    <span>Total Retry Duration: {{ formatDuration(record.TotalRetryDurationMS) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    
                                    <!-- Validation Attempts Details -->
                                    @if (validationAttempts && validationAttempts.length > 0) {
                                        <div class="validation-attempts">
                                            <h4>Validation Attempts</h4>
                                            <div class="attempts-list">
                                                @for (attempt of validationAttempts; track attempt.attemptNumber) {
                                                    <div class="attempt-item" [class.success]="attempt.success" [class.failed]="!attempt.success">
                                                        <div class="attempt-number">
                                                            <i [class]="attempt.success ? 'fa-solid fa-check' : 'fa-solid fa-times'"></i>
                                                            Attempt #{{ attempt.attemptNumber }}
                                                        </div>
                                                        <div class="attempt-details">
                                                            <span class="attempt-time">{{ attempt.timestamp }}</span>
                                                            @if (!attempt.success) {
                                                                <span class="attempt-error">{{ attempt.errorMessage || 'Unknown error' }}</span>
                                                                @if (attempt.validationErrorCount > 0) {
                                                                    <span class="error-count">({{ attempt.validationErrorCount }} errors)</span>
                                                                }
                                                            }
                                                            @if (attempt.outputLength) {
                                                                <span class="output-length">Output: {{ attempt.outputLength }} chars</span>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    
                                    <!-- Validation Summary JSON -->
                                    @if (validationSummary) {
                                        <div class="validation-json">
                                            <h4>Validation Summary Details</h4>
                                            <div class="json-viewer-container">
                                                <mj-code-editor 
                                                    [(ngModel)]="formattedValidationSummary"
                                                    name="formattedValidationSummary"
                                                    [readonly]="true"
                                                    [language]="'json'"
                                                    [lineWrapping]="true"
                                                    style="height: 200px; width: 100%;">
                                                </mj-code-editor>
                                            </div>
                                        </div>
                                    }
                                    
                                    <!-- Validation Attempts JSON -->
                                    @if (record.ValidationAttempts) {
                                        <div class="validation-json">
                                            <h4>Validation Attempts (Raw JSON)</h4>
                                            <div class="json-viewer-container">
                                                <mj-code-editor 
                                                    [(ngModel)]="formattedValidationAttempts"
                                                    name="formattedValidationAttempts"
                                                    [readonly]="true"
                                                    [language]="'json'"
                                                    [lineWrapping]="true"
                                                    style="height: 300px; width: 100%;">
                                                </mj-code-editor>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </ng-template>
                        </kendo-panelbar-item>
                    }
                    
                    <!-- Hierarchy Panel (for parent/child relationships) -->
                    @if (record.ParentID || childRuns.length > 0) {
                        <kendo-panelbar-item [expanded]="hierarchyExpanded">
                            <ng-template kendoPanelBarItemTitle>
                                <span class="panel-title">
                                    <i class="fa-solid fa-sitemap"></i>
                                    Run Hierarchy
                                    @if (childRuns.length > 0) {
                                        <span class="panel-count">({{ childRuns.length }} children)</span>
                                    }
                                </span>
                            </ng-template>
                            <ng-template kendoPanelBarContent>
                                <div class="panel-content">
                                    @if (parentRun) {
                                        <div class="parent-run-section">
                                            <h4><i class="fa-solid fa-level-up-alt"></i> Parent Run</h4>
                                            <div class="run-item parent" (click)="navigateToEntity('MJ: AI Prompt Runs', parentRun.ID)">
                                                <div class="run-item-icon" [style.background-color]="getStatusColor() + '20'">
                                                    <i [class]="'fa-solid ' + getRunTypeIcon(parentRun.RunType)"></i>
                                                </div>
                                                <div class="run-item-content">
                                                    <div class="run-item-title">
                                                        Parent Run #{{ parentRun.ID.substring(0, 8) }}
                                                        <span class="run-item-type">{{ parentRun.RunType }}</span>
                                                    </div>
                                                    <div class="run-item-meta">
                                                        <span><i class="fa-solid fa-clock"></i> {{ formatDuration(parentRun.ExecutionTimeMS) }}</span>
                                                        <span><i class="fa-solid fa-coins"></i> {{ formatTokens(parentRun.TokensUsed) }}</span>
                                                        <span><i class="fa-solid fa-calendar"></i> {{ parentRun.RunAt | date:'short' }}</span>
                                                    </div>
                                                </div>
                                                <i class="fa-solid fa-external-link"></i>
                                            </div>
                                        </div>
                                    }
                                    
                                    @if (childRuns.length > 0) {
                                        <div class="child-runs-section">
                                            <h4><i class="fa-solid fa-level-down-alt"></i> Child Runs</h4>
                                            <div class="runs-list">
                                                @for (childRun of childRuns; track childRun.ID) {
                                                    <div class="run-item child" (click)="navigateToEntity('MJ: AI Prompt Runs', childRun.ID)">
                                                        <div class="run-item-icon" [style.background-color]="getStatusColor() + '20'">
                                                            <i [class]="'fa-solid ' + getRunTypeIcon(childRun.RunType)"></i>
                                                        </div>
                                                        <div class="run-item-content">
                                                            <div class="run-item-title">
                                                                Child Run #{{ childRun.ID.substring(0, 8) }}
                                                                @if (childRun.ExecutionOrder !== null) {
                                                                    <span class="execution-order">#{{ childRun.ExecutionOrder }}</span>
                                                                }
                                                                <span class="run-item-type">{{ childRun.RunType }}</span>
                                                            </div>
                                                            <div class="run-item-meta">
                                                                <span class="status-indicator" [style.color]="getStatusColor()">
                                                                    <i [class]="'fa-solid ' + getStatusIcon()"></i>
                                                                    {{ childRun.Success ? 'Success' : childRun.ErrorMessage ? 'Failed' : 'Running' }}
                                                                </span>
                                                                <span><i class="fa-solid fa-clock"></i> {{ formatDuration(childRun.ExecutionTimeMS) }}</span>
                                                                <span><i class="fa-solid fa-coins"></i> {{ formatTokens(childRun.TokensUsed) }}</span>
                                                            </div>
                                                        </div>
                                                        <i class="fa-solid fa-external-link"></i>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </ng-template>
                        </kendo-panelbar-item>
                    }
                    
                    <!-- Additional Details Panel -->
                    <kendo-panelbar-item [expanded]="false">
                        <ng-template kendoPanelBarItemTitle>
                            <span class="panel-title">
                                <i class="fa-solid fa-info-circle"></i>
                                Additional Details
                            </span>
                        </ng-template>
                        <ng-template kendoPanelBarContent>
                            <div class="panel-content">
                                <div class="detail-fields-grid">
                                    @if (record.AgentID) {
                                        <div class="detail-field">
                                            <label>Agent</label>
                                            <div class="detail-value clickable" (click)="navigateToEntity('MJ: AI Agents', record.AgentID)" title="View Agent">
                                                <i class="fa-solid fa-robot"></i>
                                                {{ record.Agent || 'Unknown' }}
                                                <i class="fa-solid fa-external-link"></i>
                                            </div>
                                        </div>
                                    }
                                    
                                    
                                    @if (record.RunType) {
                                        <div class="detail-field">
                                            <label>Run Type</label>
                                            <div class="detail-value">
                                                <i [class]="'fa-solid ' + getRunTypeIcon(record.RunType)"></i>
                                                {{ record.RunType }}
                                            </div>
                                        </div>
                                    }
                                    
                                    @if (record.ResponseFormat) {
                                        <div class="detail-field">
                                            <label>Response Format</label>
                                            <div class="detail-value">
                                                <i class="fa-solid fa-code"></i>
                                                {{ record.ResponseFormat }}
                                            </div>
                                        </div>
                                    }
                                    
                                    <div class="detail-field">
                                        <label>Temperature</label>
                                        <div class="detail-value" [class.null-value]="record.Temperature === null || record.Temperature === undefined">
                                            <i class="fa-solid fa-temperature-high"></i>
                                            {{ record.Temperature !== null && record.Temperature !== undefined ? record.Temperature : '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Top P</label>
                                        <div class="detail-value" [class.null-value]="record.TopP === null || record.TopP === undefined">
                                            <i class="fa-solid fa-percentage"></i>
                                            {{ record.TopP !== null && record.TopP !== undefined ? record.TopP : '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Top K</label>
                                        <div class="detail-value" [class.null-value]="record.TopK === null || record.TopK === undefined">
                                            <i class="fa-solid fa-list-ol"></i>
                                            {{ record.TopK !== null && record.TopK !== undefined ? record.TopK : '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Min P</label>
                                        <div class="detail-value" [class.null-value]="record.MinP === null || record.MinP === undefined">
                                            <i class="fa-solid fa-filter"></i>
                                            {{ record.MinP !== null && record.MinP !== undefined ? record.MinP : '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Frequency Penalty</label>
                                        <div class="detail-value" [class.null-value]="record.FrequencyPenalty === null || record.FrequencyPenalty === undefined">
                                            <i class="fa-solid fa-repeat"></i>
                                            {{ record.FrequencyPenalty !== null && record.FrequencyPenalty !== undefined ? record.FrequencyPenalty : '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Presence Penalty</label>
                                        <div class="detail-value" [class.null-value]="record.PresencePenalty === null || record.PresencePenalty === undefined">
                                            <i class="fa-solid fa-plus-circle"></i>
                                            {{ record.PresencePenalty !== null && record.PresencePenalty !== undefined ? record.PresencePenalty : '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Seed</label>
                                        <div class="detail-value" [class.null-value]="record.Seed === null || record.Seed === undefined">
                                            <i class="fa-solid fa-seedling"></i>
                                            {{ record.Seed !== null && record.Seed !== undefined ? record.Seed : '' }}
                                        </div>
                                    </div>
                                    
                                    @if (record.RunAt) {
                                        <div class="detail-field">
                                            <label>Started At</label>
                                            <div class="detail-value">
                                                <i class="fa-solid fa-clock"></i>
                                                {{ record.RunAt | date:'medium' }}
                                            </div>
                                        </div>
                                    }
                                    
                                    @if (record.CompletedAt) {
                                        <div class="detail-field">
                                            <label>Completed At</label>
                                            <div class="detail-value">
                                                <i class="fa-solid fa-check-circle"></i>
                                                {{ record.CompletedAt | date:'medium' }}
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </ng-template>
                    </kendo-panelbar-item>
                    
                    <!-- Model Specific Response Details Panel -->
                    @if (record.ModelSpecificResponseDetails) {
                        <kendo-panelbar-item [expanded]="modelSpecificExpanded" (stateChange)="onModelSpecificPanelToggle($event)">
                            <ng-template kendoPanelBarItemTitle>
                                <span class="panel-title">
                                    <i class="fa-solid fa-microchip"></i>
                                    Model Specific Response Details
                                    <span class="panel-badge">JSON</span>
                                </span>
                            </ng-template>
                            <ng-template kendoPanelBarContent>
                                <div class="panel-content">
                                    <div class="json-editor-container">
                                        <div class="json-toolbar">
                                            <button kendoButton
                                                fillMode="flat" 
                                                size="small"
                                                (click)="copyToClipboard(formattedModelSpecificResponseDetails, 'Model Specific Response Details')"
                                                title="Copy JSON">
                                                <i class="fa-solid fa-copy"></i> Copy
                                            </button>
                                        </div>
                                        <mj-code-editor 
                                            [(ngModel)]="formattedModelSpecificResponseDetails"
                                            name="formattedModelSpecificResponseDetails"
                                            [readonly]="true"
                                            [language]="'json'"
                                            [lineWrapping]="true"
                                            style="height: 400px; width: 100%;">
                                        </mj-code-editor>
                                    </div>
                                </div>
                            </ng-template>
                        </kendo-panelbar-item>
                    }
                    
                    <!-- Model Selection & Performance Panel (v2.78 fields) -->
                    <kendo-panelbar-item [expanded]="false" (stateChange)="onModelSelectionPanelToggle($event)">
                        <ng-template kendoPanelBarItemTitle>
                            <span class="panel-title">
                                <i class="fa-solid fa-microchip"></i>
                                Model Selection & Performance
                                @if (record.CacheHit) {
                                    <span class="panel-badge success">Cached</span>
                                }
                                @if (record.WasSelectedResult) {
                                    <span class="panel-badge success">Selected</span>
                                }
                            </span>
                        </ng-template>
                        <ng-template kendoPanelBarContent>
                            <div class="panel-content">
                                <div class="detail-fields-grid">
                                    <!-- Model Selection Details -->
                                    <div class="detail-field">
                                        <label>Status</label>
                                        <div class="detail-value">
                                            <i class="fa-solid fa-info-circle"></i>
                                            {{ record.Status || 'Unknown' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Selection Strategy</label>
                                        <div class="detail-value">
                                            <i class="fa-solid fa-strategy"></i>
                                            {{ record.SelectionStrategy || '' }}
                                        </div>
                                    </div>
                                    
                                    <div class="detail-field">
                                        <label>Model Power Rank</label>
                                        <div class="detail-value" [class.null-value]="record.ModelPowerRank === null">
                                            <i class="fa-solid fa-ranking-star"></i>
                                            {{ record.ModelPowerRank !== null ? record.ModelPowerRank : '' }}
                                        </div>
                                    </div>
                                    
                                    <!-- Cache Information -->
                                    <div class="detail-field">
                                        <label>Cache Hit</label>
                                        <div class="detail-value">
                                            <i [class]="record.CacheHit ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle'"></i>
                                            {{ record.CacheHit ? 'Yes' : 'No' }}
                                        </div>
                                    </div>
                                    
                                    @if (record.CacheKey) {
                                        <div class="detail-field full-width">
                                            <label>Cache Key</label>
                                            <div class="detail-value">
                                                <i class="fa-solid fa-key"></i>
                                                <code>{{ record.CacheKey }}</code>
                                            </div>
                                        </div>
                                    }
                                    
                                    <!-- Judge Information -->
                                    @if (record.JudgeID) {
                                        <div class="detail-field">
                                            <label>Judge Prompt</label>
                                            <div class="detail-value clickable" (click)="navigateToEntity('MJ: AI Prompts', record.JudgeID)" title="View Judge Prompt">
                                                <i class="fa-solid fa-gavel"></i>
                                                {{ record.Judge || 'Unknown' }}
                                                <i class="fa-solid fa-external-link"></i>
                                            </div>
                                        </div>
                                    }
                                    
                                    @if (record.JudgeScore !== null) {
                                        <div class="detail-field">
                                            <label>Judge Score</label>
                                            <div class="detail-value">
                                                <i class="fa-solid fa-star"></i>
                                                {{ record.JudgeScore }}
                                            </div>
                                        </div>
                                    }
                                    
                                    <div class="detail-field">
                                        <label>Was Selected Result</label>
                                        <div class="detail-value">
                                            <i [class]="record.WasSelectedResult ? 'fa-solid fa-trophy' : 'fa-solid fa-times'"></i>
                                            {{ record.WasSelectedResult ? 'Yes' : 'No' }}
                                        </div>
                                    </div>
                                    
                                    <!-- Performance Metrics -->
                                    <div class="detail-field">
                                        <label>Streaming Enabled</label>
                                        <div class="detail-value">
                                            <i [class]="record.StreamingEnabled ? 'fa-solid fa-stream' : 'fa-solid fa-ban'"></i>
                                            {{ record.StreamingEnabled ? 'Yes' : 'No' }}
                                        </div>
                                    </div>
                                    
                                    @if (record.FirstTokenTime !== null) {
                                        <div class="detail-field">
                                            <label>First Token Time</label>
                                            <div class="detail-value">
                                                <i class="fa-solid fa-bolt"></i>
                                                {{ record.FirstTokenTime }} ms
                                            </div>
                                        </div>
                                    }
                                    
                                    @if (record.Cancelled) {
                                        <div class="detail-field">
                                            <label>Cancelled</label>
                                            <div class="detail-value error">
                                                <i class="fa-solid fa-ban"></i>
                                                Yes
                                            </div>
                                        </div>
                                        
                                        @if (record.CancellationReason) {
                                            <div class="detail-field full-width">
                                                <label>Cancellation Reason</label>
                                                <div class="detail-value">
                                                    <i class="fa-solid fa-exclamation-circle"></i>
                                                    {{ record.CancellationReason }}
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                                
                                <!-- Model Selection JSON -->
                                @if (record.ModelSelection) {
                                    <div class="model-selection-json">
                                        <h4>Model Selection Details</h4>
                                        <div class="json-viewer-container">
                                            <mj-code-editor 
                                                [(ngModel)]="formattedModelSelection"
                                                name="formattedModelSelection"
                                                [readonly]="true"
                                                [language]="'json'"
                                                [lineWrapping]="true"
                                                style="height: 300px; width: 100%;">
                                            </mj-code-editor>
                                        </div>
                                    </div>
                                }
                                
                                <!-- Error Details JSON -->
                                @if (record.ErrorDetails) {
                                    <div class="error-details-json">
                                        <h4>Error Details</h4>
                                        <div class="json-viewer-container">
                                            <mj-code-editor 
                                                [(ngModel)]="formattedErrorDetails"
                                                name="formattedErrorDetails"
                                                [readonly]="true"
                                                [language]="'json'"
                                                [lineWrapping]="true"
                                                style="height: 200px; width: 100%;">
                                            </mj-code-editor>
                                        </div>
                                    </div>
                                }
                            </div>
                        </ng-template>
                    </kendo-panelbar-item>
                    
                </kendo-panelbar>
            </div>
        </form>
    }
</div>