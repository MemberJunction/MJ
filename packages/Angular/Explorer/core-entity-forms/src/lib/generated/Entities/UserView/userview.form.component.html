<div class="record-form-container">
    <form *ngIf="record" class="record-form" #form="ngForm">
        <mj-form-toolbar [form]="this"></mj-form-toolbar>

        <div class="form-section-controls">
            <div class="control-group">
                <button (click)="expandAllSections()" title="Expand all sections">
                    <i class="fa fa-expand-alt"></i>Expand All
                </button>
                <button (click)="collapseAllSections()" title="Collapse all sections">
                    <i class="fa fa-compress-alt"></i>Collapse All
                </button>
            </div>
            <input type="text"
                   class="section-search"
                   placeholder="Search sections..."
                   (input)="filterSections($event)"
                   #sectionSearch>
            <span class="section-count">
                <span class="section-count-badge">{{getExpandedCount()}}</span> of 8 expanded
            </span>
        </div>
        <div class="form-panels-container">
<!-- User & Ownership Section -->
        <div class="form-card collapsible-card" data-section-name="user & ownership" data-field-names="userid user id username user name userfirstlast user first last useremail user email usertype user type">
            <div class="collapsible-header" (click)="toggleSection('userOwnership')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-user"></i>
                    <h3><span class="section-name">User & Ownership</span></h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.userOwnership ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.userOwnership">
                <div class="form-body">
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UserID"
            Type="textbox"
            [EditMode]="EditMode"
            LinkType="Record"
            LinkComponentType="Search"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UserName"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UserFirstLast"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UserEmail"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UserType"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>

                </div>
            </div>
        </div>

        <!-- Entity Context Section -->
        <div class="form-card collapsible-card" data-section-name="entity context" data-field-names="entityid entity id entity entitybaseview entity base view">
            <div class="collapsible-header" (click)="toggleSection('entityContext')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-database"></i>
                    <h3><span class="section-name">Entity Context</span></h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.entityContext ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.entityContext">
                <div class="form-body">
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="EntityID"
            Type="textbox"
            [EditMode]="EditMode"
            LinkType="Record"
            LinkComponentType="Search"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Entity"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="EntityBaseView"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>

                </div>
            </div>
        </div>

        <!-- View Definition & Settings Section -->
        <div class="form-card collapsible-card" data-section-name="view definition & settings" data-field-names="name description categoryid category id isshared is shared isdefault is default gridstate grid state sortstate sort state thumbnail">
            <div class="collapsible-header" (click)="toggleSection('viewDefinitionSettings')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-sliders-h"></i>
                    <h3><span class="section-name">View Definition & Settings</span></h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.viewDefinitionSettings ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.viewDefinitionSettings">
                <div class="form-body">
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Name"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Description"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CategoryID"
            Type="textbox"
            [EditMode]="EditMode"
            LinkType="Record"
            LinkComponentType="Search"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="IsShared"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="IsDefault"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="GridState"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="SortState"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Thumbnail"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>

                </div>
            </div>
        </div>

        <!-- Filtering & Smart Search Section -->
        <div class="form-card collapsible-card" data-section-name="filtering & smart search" data-field-names="filterstate filter state customfilterstate custom filter state smartfilterenabled smart filter enabled smartfilterprompt smart filter prompt smartfilterwhereclause smart filter where clause smartfilterexplanation smart filter explanation whereclause where clause customwhereclause custom where clause">
            <div class="collapsible-header" (click)="toggleSection('filteringSmartSearch')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-search"></i>
                    <h3><span class="section-name">Filtering & Smart Search</span></h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.filteringSmartSearch ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.filteringSmartSearch">
                <div class="form-body">
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="FilterState"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CustomFilterState"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="SmartFilterEnabled"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="SmartFilterPrompt"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="SmartFilterWhereClause"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="SmartFilterExplanation"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="WhereClause"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CustomWhereClause"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>

                </div>
            </div>
        </div>

        <!-- System Metadata Section -->
        <div class="form-card collapsible-card" data-section-name="system metadata" data-field-names="__mj_createdat __mj _created at __mj_updatedat __mj _updated at">
            <div class="collapsible-header" (click)="toggleSection('systemMetadata')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-cog"></i>
                    <h3><span class="section-name">System Metadata</span></h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.systemMetadata ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.systemMetadata">
                <div class="form-body">
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="__mj_CreatedAt"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="__mj_UpdatedAt"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>

                </div>
            </div>
        </div>
        <div class="related-entity-grid">

        <!-- Data Context Items Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="data context items" data-field-names="data context items" data-section-key="dataContextItems">
            <div class="collapsible-header" (click)="toggleSection('dataContextItems')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-database"></i>
                    <h3>
                        <span class="section-name">Data Context Items</span>
                        <span class="row-count-badge"
                              *ngIf="sectionRowCounts?.['dataContextItems'] !== undefined"
                              [class.zero-rows]="sectionRowCounts['dataContextItems'] === 0">
                            {{sectionRowCounts['dataContextItems']}}
                        </span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.dataContextItems ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.dataContextItems" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('Data Context Items','ViewID')"
                        [NewRecordValues]="NewRecordValues('Data Context Items')"
                        [AllowLoad]="IsCurrentSection('dataContextItems')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['dataContextItems'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>

        <!-- Entity Relationships Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="entity relationships" data-field-names="entity relationships" data-section-key="entityRelationships">
            <div class="collapsible-header" (click)="toggleSection('entityRelationships')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-project-diagram"></i>
                    <h3>
                        <span class="section-name">Entity Relationships</span>
                        <span class="row-count-badge"
                              *ngIf="sectionRowCounts?.['entityRelationships'] !== undefined"
                              [class.zero-rows]="sectionRowCounts['entityRelationships'] === 0">
                            {{sectionRowCounts['entityRelationships']}}
                        </span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.entityRelationships ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.entityRelationships" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('Entity Relationships','DisplayUserViewGUID')"
                        [NewRecordValues]="NewRecordValues('Entity Relationships')"
                        [AllowLoad]="IsCurrentSection('entityRelationships')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['entityRelationships'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>

        <!-- User View Runs Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="user view runs" data-field-names="user view runs" data-section-key="userViewRuns">
            <div class="collapsible-header" (click)="toggleSection('userViewRuns')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-eye"></i>
                    <h3>
                        <span class="section-name">User View Runs</span>
                        <span class="row-count-badge"
                              *ngIf="sectionRowCounts?.['userViewRuns'] !== undefined"
                              [class.zero-rows]="sectionRowCounts['userViewRuns'] === 0">
                            {{sectionRowCounts['userViewRuns']}}
                        </span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.userViewRuns ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.userViewRuns" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('User View Runs','UserViewID')"
                        [NewRecordValues]="NewRecordValues('User View Runs')"
                        [AllowLoad]="IsCurrentSection('userViewRuns')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['userViewRuns'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>
        </div>
        </div>
    </form>
</div>
        