<div class="record-form-container">
    <form *ngIf="record" class="record-form" #form="ngForm">
        <mj-form-toolbar [form]="this"></mj-form-toolbar>

        <div class="form-section-controls">
            <div class="control-group">
                <button (click)="expandAllSections()" title="Expand all sections">
                    <i class="fa fa-expand-alt"></i>Expand All
                </button>
                <button (click)="collapseAllSections()" title="Collapse all sections">
                    <i class="fa fa-compress-alt"></i>Collapse All
                </button>
            </div>
            <input type="text"
                   class="section-search"
                   placeholder="Search sections..."
                   (input)="filterSections($event)"
                   #sectionSearch>
            <span class="section-count">
                <span class="section-count-badge">{{getExpandedCount()}}</span> of 6 expanded
            </span>
        </div>
        <div class="form-panels-container">
<!-- Details Section -->
        <div class="form-card collapsible-card" data-section-name="details" data-field-names="name categoryid category id userquestion user question description sql technicaldescription technical description originalsql original sql feedback status qualityrank quality rank executioncostrank execution cost rank __mj_createdat __mj _created at __mj_updatedat __mj _updated at usestemplate uses template auditqueryruns audit query runs cacheenabled cache enabled cachettlminutes cache ttl minutes cachemaxsize cache max size embeddingvector embedding vector embeddingmodelid embedding model id category embeddingmodel embedding model">
            <div class="collapsible-header" (click)="toggleSection('details')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-align-left"></i>
                    <h3><span class="section-name">Details</span></h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.details ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.details">
                <div class="form-body">
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Name"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CategoryID"
            Type="textbox"
            [EditMode]="EditMode"
            LinkType="Record"
            LinkComponentType="Search"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UserQuestion"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Description"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="SQL"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="TechnicalDescription"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="OriginalSQL"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Feedback"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Status"
            Type="dropdownlist"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="QualityRank"
            Type="numerictextbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="ExecutionCostRank"
            Type="numerictextbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="__mj_CreatedAt"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="__mj_UpdatedAt"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="UsesTemplate"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="AuditQueryRuns"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CacheEnabled"
            Type="checkbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CacheTTLMinutes"
            Type="numerictextbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="CacheMaxSize"
            Type="numerictextbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="EmbeddingVector"
            Type="textarea"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="EmbeddingModelID"
            Type="textbox"
            [EditMode]="EditMode"
            LinkType="Record"
            LinkComponentType="Search"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="Category"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>
        <mj-form-field 
            [record]="record"
            [ShowLabel]="true"
            FieldName="EmbeddingModel"
            Type="textbox"
            [EditMode]="EditMode"
        ></mj-form-field>

                </div>
            </div>
        </div>
        <div class="related-entity-grid">

        <!-- Data Context Items Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="data context items" data-field-names="data context items" data-section-key="dataContextItems">
            <div class="collapsible-header" (click)="toggleSection('dataContextItems')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-table"></i>
                    <h3>
                        <span class="section-name">Data Context Items</span>
                        <span class="row-count-badge" *ngIf="sectionRowCounts?.['dataContextItems']">{{sectionRowCounts['dataContextItems']}}</span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.dataContextItems ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.dataContextItems" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('Data Context Items','QueryID')"
                        [NewRecordValues]="NewRecordValues('Data Context Items')"
                        [AllowLoad]="IsCurrentSection('dataContextItems')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['dataContextItems'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>

        <!-- Query Fields Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="query fields" data-field-names="query fields" data-section-key="queryFields">
            <div class="collapsible-header" (click)="toggleSection('queryFields')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-table"></i>
                    <h3>
                        <span class="section-name">Query Fields</span>
                        <span class="row-count-badge" *ngIf="sectionRowCounts?.['queryFields']">{{sectionRowCounts['queryFields']}}</span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.queryFields ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.queryFields" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('Query Fields','QueryID')"
                        [NewRecordValues]="NewRecordValues('Query Fields')"
                        [AllowLoad]="IsCurrentSection('queryFields')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['queryFields'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>

        <!-- Query Permissions Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="query permissions" data-field-names="query permissions" data-section-key="queryPermissions">
            <div class="collapsible-header" (click)="toggleSection('queryPermissions')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-table"></i>
                    <h3>
                        <span class="section-name">Query Permissions</span>
                        <span class="row-count-badge" *ngIf="sectionRowCounts?.['queryPermissions']">{{sectionRowCounts['queryPermissions']}}</span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.queryPermissions ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.queryPermissions" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('Query Permissions','QueryID')"
                        [NewRecordValues]="NewRecordValues('Query Permissions')"
                        [AllowLoad]="IsCurrentSection('queryPermissions')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['queryPermissions'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>

        <!-- MJ: Query Parameters Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="mj: query parameters" data-field-names="mj: query parameters" data-section-key="mJQueryParameters">
            <div class="collapsible-header" (click)="toggleSection('mJQueryParameters')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-table"></i>
                    <h3>
                        <span class="section-name">MJ: Query Parameters</span>
                        <span class="row-count-badge" *ngIf="sectionRowCounts?.['mJQueryParameters']">{{sectionRowCounts['mJQueryParameters']}}</span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.mJQueryParameters ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.mJQueryParameters" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('MJ: Query Parameters','QueryID')"
                        [NewRecordValues]="NewRecordValues('MJ: Query Parameters')"
                        [AllowLoad]="IsCurrentSection('mJQueryParameters')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['mJQueryParameters'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>

        <!-- Query Entities Section -->
        <div class="form-card collapsible-card related-entity" data-section-name="query entities" data-field-names="query entities" data-section-key="queryEntities">
            <div class="collapsible-header" (click)="toggleSection('queryEntities')" role="button" tabindex="0">
                <div class="collapsible-title">
                    <i class="fa fa-table"></i>
                    <h3>
                        <span class="section-name">Query Entities</span>
                        <span class="row-count-badge" *ngIf="sectionRowCounts?.['queryEntities']">{{sectionRowCounts['queryEntities']}}</span>
                    </h3>
                </div>
                <div class="collapse-icon">
                    <i [class]="sectionsExpanded.queryEntities ? 'fa fa-chevron-up' : 'fa fa-chevron-down'"></i>
                </div>
            </div>
            <div class="collapsible-body" [class.collapsed]="!sectionsExpanded.queryEntities" *ngIf="record.IsSaved">
                <div class="form-body">
                    <mj-user-view-grid
                        [Params]="BuildRelationshipViewParamsByEntityName('Query Entities','QueryID')"
                        [NewRecordValues]="NewRecordValues('Query Entities')"
                        [AllowLoad]="IsCurrentSection('queryEntities')"
                        [EditMode]="GridEditMode()"
                        (dataLoaded)="sectionRowCounts['queryEntities'] = $event.totalRowCount"
                        >
                    </mj-user-view-grid>
                </div>
            </div>
        </div>
        </div>
        </div>
    </form>
</div>
        