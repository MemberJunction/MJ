<div class="skip-chat-container" #topLevelDiv>
    <!-- Left Sidebar -->
    <div class="skip-sidebar" [class.skip-sidebar-collapsed]="!IsConversationListVisible">
        <div class="skip-sidebar-header">
            <button class="skip-new-chat-btn" *ngIf="AllowNewConversations" (click)="CreateNewConversation()">
                <i class="fas fa-plus"></i>
                <span>New chat</span>
            </button>
            <button class="skip-sidebar-toggle" (click)="DisplayConversationList(false)">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="skip-conversations-list">
            @for (convo of Conversations; track convo.ID) {
                <div class="skip-conversation-item" 
                     [class.skip-conversation-active]="SelectedConversation?.ID === convo.ID"
                     [class.skip-conversation-processing]="IsSkipProcessing(convo)"
                     [title]="convo.Name"
                     (click)="SelectConversation(convo)">
                    <div class="skip-conversation-content">
                        @if (SelectedConversation && IsSkipProcessing(convo)) {
                            <i class="fas fa-circle-notch fa-spin skip-processing-icon"></i>
                        }
                        @if (SelectedConversation?.ID === convo.ID && ConversationEditMode) {
                            <textarea 
                                class="skip-conversation-edit" 
                                [(ngModel)]="convo.Name" 
                                maxlength="100"
                                (click)="$event.stopPropagation()"
                                (keyup.enter)="saveConvoName(convo)"
                                (keyup.escape)="cancelConvoEdit(convo)">
                            </textarea>
                        } @else {
                            <span class="skip-conversation-name">{{ convo.Name }}</span>
                        }
                    </div>
                    @if (SelectedConversation?.ID === convo.ID) {
                        <div class="skip-conversation-actions">
                            @if (!ConversationEditMode) {
                                <div class="skip-dropdown-wrapper">
                                    <button class="skip-dropdown-trigger" 
                                            (click)="toggleConversationMenu(convo.ID); $event.stopPropagation()"
                                            [class.active]="activeConversationMenu === convo.ID">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    @if (activeConversationMenu === convo.ID) {
                                        <div class="skip-dropdown-menu" 
                                             (click)="$event.stopPropagation()">
                                            <button class="skip-dropdown-item" 
                                                    (click)="editConvo(convo); closeConversationMenu()">
                                                <i class="fas fa-pen"></i>
                                                <span>Rename</span>
                                            </button>
                                            <div class="skip-dropdown-divider"></div>
                                            <button class="skip-dropdown-item skip-dropdown-item-danger" 
                                                    (click)="showDeleteConvoDialog(convo); closeConversationMenu()">
                                                <i class="fas fa-trash"></i>
                                                <span>Delete</span>
                                            </button>
                                        </div>
                                    }
                                </div>
                            } @else {
                                <button class="skip-icon-btn" (click)="saveConvoName(convo); $event.stopPropagation()">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="skip-icon-btn" (click)="cancelConvoEdit(convo); $event.stopPropagation()">
                                    <i class="fas fa-times"></i>
                                </button>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Collapsed Sidebar Toggle -->
    @if (!IsConversationListVisible) {
        <button class="skip-sidebar-expand" (click)="DisplayConversationList(true)">
            <i class="fas fa-chevron-right"></i>
        </button>
    }

    <!-- Main Chat Area -->
    <div class="skip-main-content">
        <skip-split-panel 
            #splitPanel
            [Mode]="EnableArtifactSplitView && selectedArtifact ? 'BothSides' : 'LeftOnly'" 
            [SplitRatio]="SplitRatio" 
            (SplitRatioChanged)="onSplitRatioChanged($event)"
            [RightPanelHeaderContent]="artifactHeaderInfo"
            [VersionList]="artifactVersionList"
            [SelectedVersionId]="selectedArtifactVersionId"
            (VersionSelected)="onArtifactVersionSelected($event)"
            mjFillContainer [fillWidth]="false" [fillHeight]="true">
            
            <!-- Chat Panel -->
            <div left-panel class="skip-chat-panel">
                <!-- Hidden reference div -->
                <div #AskSkipPanel style="width:0; height:0; overflow:hidden; position:absolute;"></div>
                
                <!-- Messages Area -->
                <div class="skip-messages-area" #scrollContainer (scroll)="checkScroll()">
                    <!-- Welcome Screen -->
                    @if ((!Messages || Messages.length === 0) && _conversationLoadComplete) {
                        <div class="skip-welcome">
                            <img [src]="SkipLogoURL" class="skip-welcome-logo" />
                            <h1 class="skip-welcome-title">What can I help with today?</h1>
                            <div class="skip-welcome-suggestions">
                                @for (question of WelcomeQuestions; track question.topLine) {
                                    <button class="skip-suggestion-card" (click)="sendPrompt(question.prompt)">
                                        <div class="skip-suggestion-title">{{ question.topLine }}</div>
                                        <div class="skip-suggestion-subtitle">{{ question.bottomLine }}</div>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    
                    <!-- Loading State -->
                    @if (!_conversationLoadComplete) {
                        <div class="skip-loading-wrapper">
                            <kendo-loader type="infinite-spinner" themeColor="primary" size="medium"></kendo-loader>
                            <span class="skip-loading-text">Loading conversation...</span>
                        </div>
                    }
                    
                    <!-- Messages Container -->
                    <div class="skip-messages-container" mjContainer mjSkipResize="true">
                        <!-- Dynamic messages will be injected here -->
                    </div>
                    
                    <!-- Scroll to Bottom Button -->
                    @if (_showScrollToBottomIcon && Messages && Messages.length > 0) {
                        <button class="skip-scroll-bottom" 
                                [style.left.px]="getScrollToBottomIconPosition()"
                                (click)="scrollToBottomAnimate()">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    }
                </div>
                
                <!-- Input Area -->
                @if (SelectedConversationCurrentUserPermissionLevel === 'Owner' || 
                     SelectedConversationCurrentUserPermissionLevel === 'Edit') {
                    <div class="skip-input-area">
                        <div class="skip-input-wrapper">
                            <textarea
                                #AskSkipInput 
                                class="skip-input"
                                [disabled]="SelectedConversation && IsSkipProcessing(SelectedConversation)" 
                                (keyup.enter)="onEnter($event)" 
                                (input)="onInputChange($event)"
                                [placeholder]="_AskSkipTextboxPlaceholder"
                                rows="1">
                            </textarea>
                            <div class="skip-input-actions">
                                @if (ShowDataContextButton) {
                                    <button class="skip-input-btn" (click)="showDataContextDialog()" title="Data Context">
                                        <i class="fas fa-database"></i>
                                    </button>
                                }
                                @if (ShowSharingButton && SelectedConversationCurrentUserPermissionLevel === 'Owner') {
                                    <button class="skip-input-btn" (click)="showSharingDialog()" title="Share">
                                        <i class="fas fa-share"></i>
                                    </button>
                                }
                                @if (SelectedConversation && IsSkipProcessing(SelectedConversation)) {
                                    <button class="skip-input-btn skip-stop-btn" (click)="stopProcessing()">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                } @else {
                                    <button class="skip-input-btn skip-send-btn" 
                                            [disabled]="IsTextAreaEmpty()" 
                                            (click)="sendSkipMessage()">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            <!-- Artifact Panel -->
            <div right-panel class="skip-artifact-panel">
                <skip-artifact-viewer
                    *ngIf="selectedArtifact"
                    [ArtifactID]="selectedArtifact.artifactId"
                    [ArtifactVersionID]="selectedArtifact.artifactVersionId"
                    [DataContext]="DataContext"
                    (NavigateToMatchingReport)="NavigateToMatchingReport.emit($event)"
                    (NewReportCreated)="NewReportCreated.emit($event)"
                    (DrillDownEvent)="DrillDownEvent.emit($event)"
                    (ArtifactInfoChanged)="onArtifactInfoChanged($event)">
                </skip-artifact-viewer>
            </div>
        </skip-split-panel>
    </div>
</div>

<!-- Dialogs -->
@if (isDataContextDialogVisible) {
    <mj-data-context-dialog 
        [dataContextId]="DataContextID" 
        (dialogClosed)="closeDataContextDialog()" 
        [Provider]="ProviderToUse">
    </mj-data-context-dialog>
}

@if (isSharingDialogVisible && SelectedConversation && conversationResourceTypeID) {
    <kendo-dialog
        title="Share Conversation"
        (close)="closeSharingDialog('no')"
        [width]="650"
        [height]="400"
        class="skip-dialog">
        <mj-resource-permissions 
            [Provider]="Provider"
            [ResourceTypeID]="conversationResourceTypeID"
            [ResourceRecordID]="SelectedConversation.ID"
            [ExcludedRoleNames]="SharingExcludeRoleNames"
            [ExcludedUserEmails]="SharingExcludeEmails"
            #resourcePermissions>
        </mj-resource-permissions>
        <kendo-dialog-actions>
            <button kendoButton (click)="closeSharingDialog('yes')" themeColor="primary">Save</button>
            <button kendoButton (click)="closeSharingDialog('no')">Cancel</button>
        </kendo-dialog-actions>
    </kendo-dialog>
}

@if (confirmDeleteConversationDialogOpen) {
    <kendo-dialog
        title="Delete Conversation"
        (close)="closeDeleteConversation('no')"
        [width]="450"
        class="skip-dialog">
        <p class="skip-dialog-message">
            Are you sure you want to delete "{{ SelectedConversation?.Name }}"? This action cannot be undone.
        </p>
        <kendo-dialog-actions>
            <button kendoButton (click)="closeDeleteConversation('yes')" themeColor="error">Delete</button>
            <button kendoButton (click)="closeDeleteConversation('no')">Cancel</button>
        </kendo-dialog-actions>
    </kendo-dialog>
}

@if (confirmMessageEditOrDeleteDialogOpen) {
    <kendo-dialog
        title="Confirm {{ messageEditOrDeleteType | titlecase }}"
        (close)="closeMessageEditOrDeleteDialog('no')"
        [width]="450"
        class="skip-dialog">
        <p class="skip-dialog-message">
            Would you like to {{ messageEditOrDeleteType }} this message? 
            Doing so will result in any subsequent messages in the conversation being deleted.
        </p>
        <kendo-dialog-actions>
            <button kendoButton (click)="closeMessageEditOrDeleteDialog('yes')" themeColor="primary">Yes</button>
            <button kendoButton (click)="closeMessageEditOrDeleteDialog('no')">Cancel</button>
        </kendo-dialog-actions>
    </kendo-dialog>
}