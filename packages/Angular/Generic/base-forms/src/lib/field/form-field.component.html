@if (Record && (Record.IsSaved || !IsFieldReadOnly)) {
  <!-- READ-ONLY MODE -->
  @if ((!EditMode || IsFieldReadOnly) && !ShouldHideField) {
    <div class="mj-forms-field" [class.mj-forms-field--readonly]="EditMode && IsFieldReadOnly" [class.mj-forms-field--dirty]="IsDirty">
      @if (ShowLabel) {
        <label class="mj-forms-field-label" [innerHTML]="HighlightedDisplayName"></label>
      }
      <div class="mj-forms-field-control">
        <!-- FK fields with a mapped name field: show the name as a hyperlink -->
        @if (IsFKWithNameField) {
          <span class="mj-forms-field-value">
            <a class="mj-forms-field-link mj-forms-field-link--fk" (click)="OnRecordLinkClick($event)" title="View related record">
              {{ FKDisplayName }}
            </a>
          </span>
        }
        @else {
          @switch (LinkType) {
            @case ('Email') {
              <span class="mj-forms-field-value">
                <a class="mj-forms-field-link" (click)="OnEmailLinkClick($event)" title="Send email">
                  {{ FormatValue() }}
                  <i class="fa-solid fa-envelope mj-forms-field-link-icon"></i>
                </a>
              </span>
            }
            @case ('URL') {
              <span class="mj-forms-field-value">
                <a class="mj-forms-field-link" (click)="OnUrlLinkClick($event)" title="Open link">
                  {{ FormatValue() }}
                  <i class="fa-solid fa-arrow-up-right-from-square mj-forms-field-link-icon"></i>
                </a>
              </span>
            }
            @case ('Record') {
              <span class="mj-forms-field-value">
                <a class="mj-forms-field-link" (click)="OnRecordLinkClick($event)" title="View related record">
                  {{ FormatValue() }}
                  <i class="fa-solid fa-arrow-up-right-from-square mj-forms-field-link-icon"></i>
                </a>
              </span>
            }
            @default {
              @if (Type === 'checkbox') {
                <span class="mj-forms-field-value">
                  <div class="mj-forms-field-checkbox">
                    <input type="checkbox" [checked]="!!Value" disabled>
                  </div>
                </span>
              }
              @else if (IsLongText) {
                <span class="mj-forms-field-value mj-forms-field-value--long">{{ FormatValue() }}</span>
              }
              @else {
                <span class="mj-forms-field-value">{{ FormatValue() }}</span>
              }
            }
          }
        }
      </div>
    </div>
  }

  <!-- EDIT MODE -->
  @if (EditMode && !IsFieldReadOnly) {
    <div class="mj-forms-field mj-forms-field--editing" [class.mj-forms-field--dirty]="IsDirty" [class.mj-forms-field--required-empty]="IsRequiredEmpty" [class.mj-forms-field--has-error]="ShowErrors" [class.mj-forms-field--has-warning]="ShowWarnings">
      @if (ShowLabel) {
        <label class="mj-forms-field-label" [innerHTML]="HighlightedDisplayName"></label>
      }
      <div class="mj-forms-field-control">
        <!-- Foreign Key fields get custom search autocomplete -->
        @if (HasRelatedEntity) {
          <div class="mj-fk-search" [class.mj-fk-search--matched]="FKIsMatched">
            <input type="text"
              class="mj-forms-field-input"
              [value]="FKSearchText"
              (input)="OnFKInput($event)"
              (focus)="OnFKFocus($event)"
              (blur)="OnFKBlur()"
              placeholder="Search...">
            @if (FKSearchText) {
              <button class="mj-fk-clear" (mousedown)="OnFKClearClick($event)" title="Clear">
                <i class="fa-solid fa-xmark"></i>
              </button>
            } @else {
              <i class="fa-solid fa-magnifying-glass mj-fk-search-icon"></i>
            }
            @if (ShowFKDropdown && FKSuggestions.length > 0) {
              <div class="mj-fk-dropdown" [ngStyle]="DropdownPositionStyle" [class.mj-fk-dropdown--above]="OpenAbove">
                @for (suggestion of FKSuggestions; track suggestion.PrimaryKeyValue) {
                  <div class="mj-fk-option" (mousedown)="OnFKSelectItem(suggestion, $event)">
                    {{ suggestion.DisplayName }}
                  </div>
                }
              </div>
            }
          </div>
        }
        @else {
          @switch (Type) {
            @case ('textbox') {
              <input type="text"
                class="mj-forms-field-input"
                [value]="FormatValue()"
                (change)="OnInputChange($event)">
            }
            @case ('textarea') {
              <textarea
                class="mj-forms-field-input mj-forms-field-input--textarea"
                [value]="FormatValue()"
                (change)="OnInputChange($event)"></textarea>
            }
            @case ('number') {
              <input type="number"
                class="mj-forms-field-input mj-forms-field-input--number"
                [value]="Value"
                (change)="OnNumberChange($event)">
            }
            @case ('datepicker') {
              <input type="date"
                class="mj-forms-field-input mj-forms-field-input--date"
                [value]="DateInputValue"
                (change)="OnDateChange($event)">
            }
            @case ('checkbox') {
              <div class="mj-forms-field-checkbox">
                <input type="checkbox"
                  [checked]="!!Value"
                  (change)="OnCheckboxChange($event)">
              </div>
            }
            @case ('select') {
              <div class="mj-custom-select-trigger"
                tabindex="0"
                (click)="OnSelectTriggerClick($event)"
                (blur)="OnSelectTriggerBlur()">
                <span class="mj-custom-select-value" [class.mj-custom-select-value--placeholder]="!FormatValue()">
                  {{ FormatValue() || '-- Select --' }}
                </span>
                <i class="fa-solid fa-chevron-down mj-custom-select-chevron" [class.mj-custom-select-chevron--open]="ShowSelectDropdown"></i>
              </div>
              @if (ShowSelectDropdown && PossibleValues.length > 0) {
                <div class="mj-fk-dropdown" [ngStyle]="DropdownPositionStyle" [class.mj-fk-dropdown--above]="OpenAbove">
                  @for (option of PossibleValues; track option) {
                    <div class="mj-fk-option" [class.mj-fk-option--selected]="FormatValue() === option" (mousedown)="OnSelectOptionClick(option, $event)">
                      {{ option }}
                    </div>
                  }
                </div>
              }
            }
            @case ('autocomplete') {
              <div class="mj-fk-search">
                <input type="text"
                  class="mj-forms-field-input"
                  [value]="FormatValue()"
                  (input)="OnValueListInput($event)"
                  (focus)="OnValueListFocus($event)"
                  (blur)="OnValueListBlur()"
                  placeholder="Type to search...">
                <i class="fa-solid fa-magnifying-glass mj-fk-search-icon"></i>
                @if (ShowValueListDropdown && FilteredPossibleValues.length > 0) {
                  <div class="mj-fk-dropdown" [ngStyle]="DropdownPositionStyle" [class.mj-fk-dropdown--above]="OpenAbove">
                    @for (option of FilteredPossibleValues; track option) {
                      <div class="mj-fk-option" (mousedown)="OnValueListSelect(option, $event)">
                        {{ option }}
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @default {
              <input type="text"
                class="mj-forms-field-input"
                [value]="FormatValue()"
                (change)="OnInputChange($event)">
            }
          }
        }
      </div>
      <!-- Inline validation messages -->
      @if (DisplayErrors.length > 0) {
        <div class="mj-forms-field-validation mj-forms-field-validation--error">
          @for (error of DisplayErrors; track error.Message) {
            <div class="mj-forms-field-validation-item">
              <i class="fa-solid fa-circle-exclamation"></i>
              <span>{{ error.Message }}</span>
            </div>
          }
        </div>
      }
      @if (DisplayWarnings.length > 0) {
        <div class="mj-forms-field-validation mj-forms-field-validation--warning">
          @for (warning of DisplayWarnings; track warning.Message) {
            <div class="mj-forms-field-validation-item">
              <i class="fa-solid fa-triangle-exclamation"></i>
              <span>{{ warning.Message }}</span>
            </div>
          }
        </div>
      }
    </div>
  }
}
