<div class="file-grid-container"
     (dragenter)="onDragEnter($event)"
     (dragover)="onDragOver($event)"
     (dragleave)="onDragLeave($event)"
     (drop)="onDrop($event)">
  <!-- Breadcrumb Navigation Bar -->
  <div class="breadcrumb-bar" *ngIf="!isLoading && !errorMessage">
    <div class="nav-buttons">
      <button class="nav-btn"
              [disabled]="!canNavigateUp()"
              (click)="navigateUp()"
              title="Go up to parent folder">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <button class="nav-btn" (click)="refresh()" title="Refresh">
        <i class="fa-solid fa-arrows-rotate"></i>
      </button>
    </div>
    <div class="breadcrumb-path">
      <i class="fa-solid fa-folder"></i>
      <span class="path-text">{{ folderPath || 'Root' }} /</span>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <mj-loading text="Loading files..."></mj-loading>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="errorMessage && !isLoading">
    <div class="error-icon">
      <i class="fa-solid fa-circle-exclamation"></i>
    </div>
    <p class="error-message">{{ errorMessage }}</p>
    <button class="retry-btn" (click)="refresh()">
      <i class="fa-solid fa-arrows-rotate"></i>
      Retry
    </button>
  </div>

  <!-- List View -->
  <div class="file-table-wrapper" *ngIf="!isLoading && !errorMessage && items.length > 0 && viewMode === 'list'">
    <table class="file-table">
      <thead>
        <tr>
          <th class="col-name" (click)="onSortChange([{ field: 'name', dir: sort[0]?.field === 'name' && sort[0]?.dir === 'asc' ? 'desc' : 'asc' }])">
            <span>Name</span>
            <i class="fa-solid sort-icon"
               [class.fa-caret-up]="sort[0]?.field === 'name' && sort[0]?.dir === 'asc'"
               [class.fa-caret-down]="sort[0]?.field === 'name' && sort[0]?.dir === 'desc'"
               [class.fa-sort]="sort[0]?.field !== 'name'"></i>
          </th>
          <th class="col-type">Type</th>
          <th class="col-size" (click)="onSortChange([{ field: 'size', dir: sort[0]?.field === 'size' && sort[0]?.dir === 'asc' ? 'desc' : 'asc' }])">
            <span>Size</span>
            <i class="fa-solid sort-icon"
               [class.fa-caret-up]="sort[0]?.field === 'size' && sort[0]?.dir === 'asc'"
               [class.fa-caret-down]="sort[0]?.field === 'size' && sort[0]?.dir === 'desc'"
               [class.fa-sort]="sort[0]?.field !== 'size'"></i>
          </th>
          <th class="col-modified" (click)="onSortChange([{ field: 'lastModified', dir: sort[0]?.field === 'lastModified' && sort[0]?.dir === 'asc' ? 'desc' : 'asc' }])">
            <span>Modified</span>
            <i class="fa-solid sort-icon"
               [class.fa-caret-up]="sort[0]?.field === 'lastModified' && sort[0]?.dir === 'asc'"
               [class.fa-caret-down]="sort[0]?.field === 'lastModified' && sort[0]?.dir === 'desc'"
               [class.fa-sort]="sort[0]?.field !== 'lastModified'"></i>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of items"
            class="file-row"
            [class.selected]="selectedItems.includes(item.key)"
            (click)="onTileClick(item, $event)"
            (dblclick)="onItemDoubleClick(item)">
          <td class="col-name">
            <i [class]="getItemIcon(item)" class="item-icon"></i>
            <span class="item-name">{{ item.name }}</span>
          </td>
          <td class="col-type">
            <span class="item-type">{{ getFileType(item) }}</span>
          </td>
          <td class="col-size">
            <span class="item-size">{{ item.type === 'folder' ? 'â€”' : formatFileSize(item.size) }}</span>
          </td>
          <td class="col-modified">
            <span class="item-date">{{ formatDate(item.lastModified) }}</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Grid View -->
  <div class="file-grid-wrapper" *ngIf="!isLoading && !errorMessage && items.length > 0 && viewMode === 'grid'">
    <div class="file-grid">
      <div *ngFor="let item of items"
           class="grid-item"
           [class.selected]="selectedItems.includes(item.key)"
           (click)="onTileClick(item, $event)"
           (dblclick)="onItemDoubleClick(item)">
        <div class="grid-icon">
          <i [class]="getItemIcon(item)"></i>
        </div>
        <div class="grid-name">{{ item.name }}</div>
        <div class="grid-meta" *ngIf="item.type === 'file'">{{ formatFileSize(item.size) }}</div>
        <div class="grid-meta" *ngIf="item.type === 'folder'">Folder</div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && !errorMessage && items.length === 0">
    <div class="empty-icon">
      <i class="fa-solid fa-folder-open"></i>
    </div>
    <p class="empty-message">This folder is empty</p>
    <button class="upload-btn" (click)="onUploadClick()">
      <i class="fa-solid fa-upload"></i>
      Upload Files
    </button>
  </div>

  <!-- Bottom Toolbar -->
  <div class="bottom-toolbar" *ngIf="!isLoading && !errorMessage">
    <div class="toolbar-left">
      <button class="toolbar-btn" (click)="onUploadClick()">
        <i class="fa-solid fa-upload"></i>
        Upload
      </button>
      <button class="toolbar-btn" (click)="onNewFolderClick()">
        <i class="fa-solid fa-folder-plus"></i>
        New Folder
      </button>
      <button class="toolbar-btn"
              [disabled]="selectedItems.length !== 1"
              (click)="onDownloadClick()">
        <i class="fa-solid fa-download"></i>
        Download
      </button>
      <button class="toolbar-btn"
              [disabled]="selectedItems.length !== 1"
              (click)="onCopyClick()">
        <i class="fa-solid fa-copy"></i>
        Copy
      </button>
      <button class="toolbar-btn"
              [disabled]="selectedItems.length !== 1"
              (click)="onMoveClick()">
        <i class="fa-solid fa-arrows-up-down-left-right"></i>
        Move
      </button>
      <button class="toolbar-btn"
              [disabled]="selectedItems.length === 0"
              (click)="onDeleteClick()">
        <i class="fa-solid fa-trash"></i>
        Delete
      </button>
    </div>
    <div class="toolbar-right">
      <!-- View Toggle -->
      <div class="view-toggle">
        <button class="view-btn"
                [class.active]="viewMode === 'list'"
                (click)="viewMode = 'list'"
                title="List View">
          <i class="fa-solid fa-list"></i>
        </button>
        <button class="view-btn"
                [class.active]="viewMode === 'grid'"
                (click)="viewMode = 'grid'"
                title="Grid View">
          <i class="fa-solid fa-th"></i>
        </button>
      </div>
      <span class="item-count">
        {{ items.length }} {{ items.length === 1 ? 'item' : 'items' }}
      </span>
    </div>
  </div>

  <!-- Drag & Drop Overlay -->
  <div class="drag-overlay" *ngIf="isDragging">
    <div class="drag-content">
      <div class="drag-icon">
        <i class="fa-solid fa-cloud-arrow-up"></i>
      </div>
      <h2 class="drag-title">Drop files to upload</h2>
    </div>
  </div>

  <!-- Upload Progress -->
  <div class="upload-progress" *ngIf="isUploading">
    <div class="progress-content">
      <div class="progress-info">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <span>Uploading {{ uploadingFileName }}...</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" [style.width.%]="uploadProgress"></div>
      </div>
      <span class="progress-percent">{{ uploadProgress }}%</span>
    </div>
  </div>
</div>

<!-- New Folder Modal -->
<div class="modal-overlay" *ngIf="showNewFolderDialog" (click)="onCancelNewFolder()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Create New Folder</h3>
      <button class="modal-close" (click)="onCancelNewFolder()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <label>Folder name:</label>
      <input type="text"
             [(ngModel)]="newFolderName"
             [disabled]="isCreatingFolder"
             placeholder="Enter folder name"
             (keydown.enter)="onCreateFolder()">
    </div>
    <div class="modal-footer">
      <button (click)="onCancelNewFolder()" [disabled]="isCreatingFolder">Cancel</button>
      <button (click)="onCreateFolder()" [disabled]="!newFolderName.trim() || isCreatingFolder">
        <i class="fa-solid fa-spinner fa-spin" *ngIf="isCreatingFolder"></i>
        {{ isCreatingFolder ? 'Creating...' : 'Create' }}
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteDialog && itemToDelete" (click)="onCancelDelete()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Delete {{ itemToDelete.type === 'folder' ? 'Folder' : 'File' }}?</h3>
      <button class="modal-close" (click)="onCancelDelete()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete <strong>{{ itemToDelete.name }}</strong>?</p>
      <p *ngIf="itemToDelete.type === 'folder'" class="warning">This will delete the folder and all its contents.</p>
    </div>
    <div class="modal-footer">
      <button (click)="onCancelDelete()" [disabled]="isDeleting">Cancel</button>
      <button (click)="onConfirmDelete()" [disabled]="isDeleting" class="danger">
        <i class="fa-solid fa-spinner fa-spin" *ngIf="isDeleting"></i>
        {{ isDeleting ? 'Deleting...' : 'Delete' }}
      </button>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal-overlay" *ngIf="showRenameDialog && itemToRename" (click)="onCancelRename()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Rename {{ itemToRename.type === 'folder' ? 'Folder' : 'File' }}</h3>
      <button class="modal-close" (click)="onCancelRename()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <label>New name:</label>
      <input type="text"
             [(ngModel)]="newItemName"
             [disabled]="isRenaming"
             placeholder="Enter new name"
             (keydown.enter)="onConfirmRename()">
    </div>
    <div class="modal-footer">
      <button (click)="onCancelRename()" [disabled]="isRenaming">Cancel</button>
      <button (click)="onConfirmRename()" [disabled]="isRenaming || !newItemName.trim()">
        <i class="fa-solid fa-spinner fa-spin" *ngIf="isRenaming"></i>
        {{ isRenaming ? 'Renaming...' : 'Rename' }}
      </button>
    </div>
  </div>
</div>

<!-- Copy Modal -->
<div class="modal-overlay" *ngIf="showCopyDialog && itemToCopy" (click)="onCancelCopy()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Copy {{ itemToCopy.type === 'folder' ? 'Folder' : 'File' }}</h3>
      <button class="modal-close" (click)="onCancelCopy()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Copying: <strong>{{ itemToCopy.name }}</strong></p>
      <label>Destination path:</label>
      <input type="text"
             [(ngModel)]="copyDestinationPath"
             [disabled]="isCopying"
             placeholder="Enter destination path"
             (keydown.enter)="onConfirmCopy()">
    </div>
    <div class="modal-footer">
      <button (click)="onCancelCopy()" [disabled]="isCopying">Cancel</button>
      <button (click)="onConfirmCopy()" [disabled]="isCopying || !copyDestinationPath.trim()">
        <i class="fa-solid fa-spinner fa-spin" *ngIf="isCopying"></i>
        {{ isCopying ? 'Copying...' : 'Copy' }}
      </button>
    </div>
  </div>
</div>

<!-- Move Modal -->
<div class="modal-overlay" *ngIf="showMoveDialog && itemToMove" (click)="onCancelMove()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Move {{ itemToMove.type === 'folder' ? 'Folder' : 'File' }}</h3>
      <button class="modal-close" (click)="onCancelMove()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>Moving: <strong>{{ itemToMove.name }}</strong></p>
      <label>Destination folder path:</label>
      <input type="text"
             [(ngModel)]="moveDestinationPath"
             [disabled]="isMoving"
             placeholder="Enter destination folder (e.g., folder1/folder2/)"
             (keydown.enter)="onConfirmMove()">
      <p style="font-size: 11px; color: #666; margin-top: 8px;">
        File will be moved to: {{ moveDestinationPath }}{{ itemToMove.name }}
      </p>
    </div>
    <div class="modal-footer">
      <button (click)="onCancelMove()" [disabled]="isMoving">Cancel</button>
      <button (click)="onConfirmMove()" [disabled]="isMoving || !moveDestinationPath.trim()">
        <i class="fa-solid fa-spinner fa-spin" *ngIf="isMoving"></i>
        {{ isMoving ? 'Moving...' : 'Move' }}
      </button>
    </div>
  </div>
</div>
