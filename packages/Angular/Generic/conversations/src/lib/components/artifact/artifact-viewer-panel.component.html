<div class="artifact-viewer-panel">
  <div class="panel-header">
    <div class="panel-header-left">
      <h3>
        <i class="fas fa-cube"></i>
        {{ artifact?.Name || 'Artifact' }}
      </h3>
    </div>
    <div class="panel-header-right">
      <div class="version-selector" [class.clickable]="allVersions.length > 1" (click)="toggleVersionDropdown()">
        <i class="fas fa-history"></i>
        <span class="version-label">v{{ selectedVersionNumber }}</span>
        @if (allVersions.length > 1) {
          <i class="fas fa-chevron-down dropdown-icon" [class.open]="showVersionDropdown"></i>
        }
        @if (showVersionDropdown) {
          <div class="version-dropdown" (click)="$event.stopPropagation()">
            @for (version of allVersions; track version.ID) {
              <div class="version-option"
                   [class.selected]="version.VersionNumber === selectedVersionNumber"
                   (click)="selectVersion(version); $event.stopPropagation()">
                <span class="version-number">v{{ version.VersionNumber }}</span>
                <span class="version-date">{{ version.__mj_CreatedAt | date:'short' }}</span>
                @if (version.VersionNumber === selectedVersionNumber) {
                  <i class="fas fa-check"></i>
                }
              </div>
            }
          </div>
        }
      </div>
      <button class="close-btn" (click)="onClose()" title="Close">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="panel-content">
    @if (isLoading) {
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading artifact...</span>
      </div>
    }

    @if (error) {
      <div class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ error }}</span>
      </div>
    }

    @if (!isLoading && !error && artifact) {
      <div class="artifact-content-wrapper">
        <div class="artifact-meta">
          <div class="meta-item">
            <label>Type</label>
            <span>{{ artifact.Type }}</span>
          </div>
          <div class="meta-item">
            <label>Version</label>
            <span>{{ artifactVersion?.VersionNumber || 1 }}</span>
          </div>
          <div class="meta-item">
            <label>Created</label>
            <span>{{ artifact.__mj_CreatedAt | date:'short' }}</span>
          </div>
        </div>

        @if (artifact.Description) {
          <div class="artifact-description">
            {{ artifact.Description }}
          </div>
        }

        <div class="json-viewer">
          <div class="json-toolbar">
            <button class="btn-icon" title="Copy JSON" (click)="onCopyToClipboard()">
              <i class="fas fa-copy"></i> Copy
            </button>
            <button class="btn-icon btn-primary" title="Save to Library" (click)="onSaveToLibrary()">
              <i class="fas fa-bookmark"></i> Save to Library
            </button>
          </div>
          <div class="json-editor-container">
            <mj-code-editor
              [(ngModel)]="jsonContent"
              [language]="'json'"
              [readonly]="true"
              style="width: 100%; height: 100%;">
            </mj-code-editor>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<!-- Save to Library Dialog -->
@if (showLibraryDialog) {
  <div class="modal-overlay" (click)="cancelLibraryDialog()">
    <div class="modal-content library-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="fas fa-bookmark"></i>
          Save to Library
        </h3>
        <button class="close-btn" (click)="cancelLibraryDialog()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label>Select Collection</label>
          <select [(ngModel)]="selectedCollectionId" class="form-select">
            <option [ngValue]="null">-- Choose a collection --</option>
            @for (collection of collections; track collection.ID) {
              <option [ngValue]="collection.ID">{{ collection.Name }}</option>
            }
          </select>
        </div>

        <div class="divider">
          <span>OR</span>
        </div>

        <div class="form-section">
          <label>Create New Collection</label>
          <div class="create-collection-row">
            <input
              type="text"
              [(ngModel)]="newCollectionName"
              placeholder="Enter collection name"
              class="form-input"
              (keyup.enter)="createNewCollection()">
            <button
              class="btn btn-secondary"
              (click)="createNewCollection()"
              [disabled]="isCreatingCollection || !newCollectionName.trim()">
              @if (isCreatingCollection) {
                <i class="fas fa-spinner fa-spin"></i>
              } @else {
                <i class="fas fa-plus"></i>
              }
              Create
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="cancelLibraryDialog()">
          Cancel
        </button>
        <button
          class="btn btn-primary"
          (click)="saveToSelectedCollection()"
          [disabled]="!selectedCollectionId || isSavingToLibrary">
          @if (isSavingToLibrary) {
            <i class="fas fa-spinner fa-spin"></i> Saving...
          } @else {
            <i class="fas fa-save"></i> Save to Library
          }
        </button>
      </div>
    </div>
  </div>
}
