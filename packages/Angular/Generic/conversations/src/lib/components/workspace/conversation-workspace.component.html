<div class="conversation-workspace" [attr.data-layout]="layout" mjSearchShortcut (searchTriggered)="openSearch()" kendoDialogContainer>
  <!-- Top Navigation Bar -->
  <div class="workspace-navigation">
    <mj-conversation-navigation
      [activeTab]="activeTab"
      [environmentId]="environmentId"
      [currentUser]="currentUser"
      [conversationId]="selectedConversationId"
      (tabChanged)="onTabChanged($event)"
      (sidebarToggled)="toggleSidebar()"
      (searchTriggered)="openSearch()"
      (refreshTriggered)="onRefreshAgentCache()">
    </mj-conversation-navigation>
  </div>

  <!-- Loading spinner while initializing agents -->
  @if (!isWorkspaceReady) {
    <div class="workspace-loading">
      <mj-loading text="Loading agents..." size="large"></mj-loading>
    </div>
  }

  <!-- Main workspace content - only renders when agents are ready -->
  @if (isWorkspaceReady) {
    <div class="workspace-content">
      <!-- Mobile sidebar backdrop -->
      @if (isMobileView && isSidebarVisible && activeTab !== 'collections' && activeTab !== 'tasks') {
        <div class="mobile-sidebar-backdrop visible" (click)="closeSidebar()"></div>
      }

      <!-- Left Sidebar (hidden when Collections or Tasks view is active) -->
      @if (activeTab !== 'collections' && activeTab !== 'tasks' && isSidebarSettingsLoaded) {
        <div class="workspace-sidebar"
          [class.open]="isSidebarVisible"
          [class.collapsed]="isSidebarCollapsed"
          [class.no-transition]="!sidebarTransitionsEnabled"
          [style.width.px]="isSidebarCollapsed ? 0 : sidebarWidth">
          <mj-conversation-sidebar
            [activeTab]="activeTab"
            [environmentId]="environmentId"
            [currentUser]="currentUser"
            [selectedConversationId]="selectedConversationId"
            [renamedConversationId]="renamedConversationId"
            [isSidebarPinned]="isSidebarPinned"
            [isMobileView]="isMobileView"
            (conversationSelected)="onConversationSelected($event)"
            (newConversationRequested)="startNewConversation()"
            (pinSidebarRequested)="pinSidebar()"
            (unpinSidebarRequested)="unpinSidebar()">
          </mj-conversation-sidebar>
        </div>
      }

      <!-- Floating toggle button (only visible when sidebar is collapsed and settings loaded) -->
      @if (activeTab !== 'collections' && activeTab !== 'tasks' && isSidebarCollapsed && isSidebarSettingsLoaded) {
        <button class="sidebar-floating-toggle"
          (click)="expandSidebar()"
          title="Show conversations">
          <i class="fas fa-table-columns"></i>
        </button>
      }

      <!-- Resize handle for sidebar (only when expanded and settings loaded) -->
      @if (isSidebarVisible && !isSidebarCollapsed && activeTab !== 'collections' && activeTab !== 'tasks' && isSidebarSettingsLoaded) {
        <div class="sidebar-resize-handle"
        (mousedown)="onSidebarResizeStart($event)"></div>
      }

      <!-- Collections Full-Panel View -->
      @if (activeTab === 'collections') {
        <div class="workspace-main">
          <mj-collections-full-view
            [environmentId]="environmentId"
            [currentUser]="currentUser"
            (collectionNavigated)="onCollectionNavigated($event)">
          </mj-collections-full-view>
        </div>
      }

      <!-- Tasks Full-Panel View -->
      @if (activeTab === 'tasks') {
        <div class="workspace-main">
          <mj-tasks-full-view
            [environmentId]="environmentId"
            [currentUser]="currentUser"
            [baseFilter]="tasksFilter"
            [activeTaskId]="activeTaskId"
            (openEntityRecord)="onOpenEntityRecordFromTasks($event)">
          </mj-tasks-full-view>
        </div>
      }

      <!-- Main Chat Area (only shown when not in Collections or Tasks view) -->
      @if (activeTab !== 'collections' && activeTab !== 'tasks') {
        <div class="workspace-main">
          <mj-conversation-chat-area
            [environmentId]="environmentId"
            [currentUser]="currentUser"
            [conversationId]="selectedConversationId"
            [conversation]="selectedConversation"
            [threadId]="selectedThreadId"
            [isNewConversation]="isNewUnsavedConversation"
            [pendingMessage]="pendingMessageToSend"
            [pendingAttachments]="pendingAttachmentsToSend"
            [pendingArtifactId]="pendingArtifactId"
            [pendingArtifactVersionNumber]="pendingArtifactVersionNumber"
            (conversationRenamed)="onConversationRenamed($event)"
            (openEntityRecord)="onOpenEntityRecord($event)"
            (taskClicked)="onTaskClicked($event)"
            (artifactLinkClicked)="onArtifactLinkNavigation($event)"
            (conversationCreated)="onConversationCreated($event)"
            (threadOpened)="onThreadOpened($event)"
            (threadClosed)="onThreadClosed()"
            (pendingArtifactConsumed)="pendingArtifactId = null; pendingArtifactVersionNumber = null"
            (pendingMessageConsumed)="pendingMessageToSend = null; pendingAttachmentsToSend = null"
            (pendingMessageRequested)="onPendingMessageRequested($event)">
          </mj-conversation-chat-area>
        </div>
      }

      <!-- Right Artifact Panel -->
      @if (isArtifactPanelOpen && activeArtifactId) {
        @if (!isArtifactPanelMaximized) {
          <div class="artifact-panel-resize-handle" (mousedown)="onArtifactPanelResizeStart($event)"></div>
        }
        <div class="workspace-artifact-panel"
          [style.width.%]="artifactPanelWidth"
          [class.maximized]="isArtifactPanelMaximized">
          <mj-artifact-viewer-panel
            [artifactId]="activeArtifactId"
            [currentUser]="currentUser"
            [environmentId]="environmentId"
            [versionNumber]="activeVersionNumber ?? undefined"
            [showSaveToCollection]="activeTab !== 'collections'"
            [viewContext]="activeTab === 'collections' ? 'collection' : 'conversation'"
            [contextCollectionId]="collectionState.activeCollectionId ?? undefined"
            [canShare]="canShareActiveArtifact"
            [canEdit]="canEditActiveArtifact"
            [isMaximized]="isArtifactPanelMaximized"
            (closed)="closeArtifactPanel()"
            (navigateToLink)="onArtifactLinkNavigation($event)"
            (shareRequested)="onArtifactShareRequested($event)"
            (maximizeToggled)="toggleMaximizeArtifactPanel()">
          </mj-artifact-viewer-panel>
        </div>
      }
    </div>
  }

  <!-- Global Search Panel -->
  <mj-search-panel
    [isOpen]="isSearchPanelOpen"
    [environmentId]="environmentId"
    [currentUser]="currentUser"
    (close)="closeSearch()"
    (resultSelected)="handleSearchResult($event)">
  </mj-search-panel>

  <!-- Toast Notifications -->
  <mj-toast></mj-toast>

  <!-- Artifact Share Modal -->
  <mj-artifact-share-modal
    [isOpen]="isArtifactShareModalOpen"
    [artifact]="artifactToShare"
    [currentUser]="currentUser"
    (saved)="onArtifactShared()"
    (cancelled)="onArtifactShareModalClose()">
  </mj-artifact-share-modal>
</div>