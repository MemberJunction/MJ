<div class="conversation-workspace" [attr.data-layout]="layout" mjSearchShortcut (searchTriggered)="openSearch()" kendoDialogContainer>
  <!-- Top Navigation Bar -->
  <div class="workspace-navigation">
    <mj-conversation-navigation
      [activeTab]="activeTab"
      [environmentId]="environmentId"
      (tabChanged)="onTabChanged($event)"
      (sidebarToggled)="toggleSidebar()"
      (searchTriggered)="openSearch()"
      (refreshTriggered)="onRefreshAgentCache()">
    </mj-conversation-navigation>
  </div>

  <!-- Loading spinner while initializing agents -->
  @if (!isWorkspaceReady) {
    <div class="workspace-loading">
      <div class="loading-spinner">
        <i class="fa-solid fa-spinner fa-spin"></i>
      </div>
      <p>Loading agents...</p>
    </div>
  }

  <!-- Main workspace content - only renders when agents are ready -->
  @if (isWorkspaceReady) {
    <div class="workspace-content">
      <!-- Mobile sidebar backdrop -->
      @if (isMobileView && isSidebarVisible && activeTab !== 'collections' && activeTab !== 'tasks') {
        <div class="mobile-sidebar-backdrop visible" (click)="closeSidebar()"></div>
      }

    <!-- Left Sidebar (hidden when Collections or Tasks view is active) -->
    <div class="workspace-sidebar"
         *ngIf="activeTab !== 'collections' && activeTab !== 'tasks'"
         [class.open]="isSidebarVisible"
         [style.width.px]="sidebarWidth">
      <mj-conversation-sidebar
        [activeTab]="activeTab"
        [environmentId]="environmentId"
        [currentUser]="currentUser"
        [renamedConversationId]="renamedConversationId">
      </mj-conversation-sidebar>
    </div>

    <!-- Resize handle for sidebar -->
    <div class="sidebar-resize-handle" *ngIf="isSidebarVisible && activeTab !== 'collections' && activeTab !== 'tasks'" (mousedown)="onSidebarResizeStart($event)"></div>

    <!-- Collections Full-Panel View -->
    <div class="workspace-main" *ngIf="activeTab === 'collections'">
      <mj-collections-full-view
        [environmentId]="environmentId"
        [currentUser]="currentUser"
        (collectionNavigated)="onCollectionNavigated($event)">
      </mj-collections-full-view>
    </div>

    <!-- Tasks Full-Panel View -->
    <div class="workspace-main" *ngIf="activeTab === 'tasks'">
      <mj-tasks-full-view
        [environmentId]="environmentId"
        [currentUser]="currentUser"
        [baseFilter]="tasksFilter"
        [activeTaskId]="activeTaskId"
        (openEntityRecord)="onOpenEntityRecordFromTasks($event)">
      </mj-tasks-full-view>
    </div>

    <!-- Main Chat Area (only shown when not in Collections or Tasks view) -->
    <div class="workspace-main" *ngIf="activeTab !== 'collections' && activeTab !== 'tasks'">
      <mj-conversation-chat-area
        [environmentId]="environmentId"
        [currentUser]="currentUser"
        (conversationRenamed)="onConversationRenamed($event)"
        (openEntityRecord)="onOpenEntityRecord($event)"
        (taskClicked)="onTaskClicked($event)"
        (artifactLinkClicked)="onArtifactLinkNavigation($event)">
      </mj-conversation-chat-area>
    </div>

    <!-- Right Artifact Panel -->
    @if (isArtifactPanelOpen && activeArtifactId) {
      <div class="artifact-panel-resize-handle" (mousedown)="onArtifactPanelResizeStart($event)"></div>
      <div class="workspace-artifact-panel" [style.width.%]="artifactPanelWidth">
        <mj-artifact-viewer-panel
          [artifactId]="activeArtifactId"
          [currentUser]="currentUser"
          [environmentId]="environmentId"
          [versionNumber]="activeVersionNumber ?? undefined"
          [showSaveToCollection]="activeTab !== 'collections'"
          [viewContext]="activeTab === 'collections' ? 'collection' : 'conversation'"
          [contextCollectionId]="collectionState.activeCollectionId ?? undefined"
          [canShare]="canShareActiveArtifact"
          [canEdit]="canEditActiveArtifact"
          (closed)="closeArtifactPanel()"
          (navigateToLink)="onArtifactLinkNavigation($event)"
          (shareRequested)="onArtifactShareRequested($event)">
        </mj-artifact-viewer-panel>
      </div>
    }
    </div>
  }

  <!-- Global Search Panel -->
  <mj-search-panel
    [isOpen]="isSearchPanelOpen"
    [environmentId]="environmentId"
    [currentUser]="currentUser"
    (close)="closeSearch()"
    (resultSelected)="handleSearchResult($event)">
  </mj-search-panel>

  <!-- Toast Notifications -->
  <mj-toast></mj-toast>

  <!-- Artifact Share Modal -->
  <mj-artifact-share-modal
    [isOpen]="isArtifactShareModalOpen"
    [artifact]="artifactToShare"
    [currentUser]="currentUser"
    (saved)="onArtifactShared()"
    (cancelled)="onArtifactShareModalClose()">
  </mj-artifact-share-modal>
</div>