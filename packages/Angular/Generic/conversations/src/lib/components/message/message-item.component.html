<div [class]="messageClasses">
  <div class="message-avatar">
    <div class="avatar-circle" [class.ai-avatar]="isAIMessage" [class.user-avatar]="isUserMessage">
      <i class="fas" [ngClass]="isAIMessage ? (aiAgentInfo?.iconClass || 'fa-robot') : 'fa-user'"></i>
    </div>
  </div>

  <div class="message-content">
    <div class="message-header">
      <span class="message-sender">{{ isAIMessage ? (aiAgentInfo?.name || 'AI Assistant') : currentUser.Name }}</span>
      <span class="message-time">{{ message.__mj_CreatedAt | date:'short' }}</span>

      <!-- Status indicator for user messages -->
      <span *ngIf="isUserMessage && messageStatus !== 'Complete'" class="message-status" [class.error]="messageStatus === 'Error'">
        <i class="fas" [ngClass]="messageStatus === 'Error' ? 'fa-exclamation-triangle' : 'fa-circle-notch fa-spin'"></i>
        <span class="status-text">{{ getStatusText() }}</span>
      </span>

      <!-- Elapsed time for AI messages still processing -->
      <span *ngIf="isTemporaryMessage" class="message-elapsed">{{ _elapsedTimeFormatted }}</span>
    </div>

    <div class="message-body">
      @if (!isEditing) {
        <div class="message-text">
          {{ message.Message }}
          @if (isMessageEdited) {
            <span class="edited-badge">(edited)</span>
          }
        </div>

        <!-- Artifact Card (ChatGPT/Claude.ai style) -->
        @if (hasArtifact) {
          <div class="artifact-card" (click)="onArtifactClick()">
            <div class="artifact-card-icon">
              <i class="fas fa-cube"></i>
            </div>
            <div class="artifact-card-content">
              <div class="artifact-card-title">Artifact</div>
              <div class="artifact-card-subtitle">Click to view in panel</div>
            </div>
            <div class="artifact-card-action">
              <i class="fas fa-arrow-right"></i>
            </div>
          </div>
        }
      }

      @if (isEditing) {
        <div class="message-edit-container">
          <textarea
            class="message-edit-textarea"
            [(ngModel)]="editedText"
            (keydown)="onEditKeydown($event)"
            rows="4"
            placeholder="Edit your message..."></textarea>
          <div class="edit-actions">
            <button class="edit-action-btn save" (click)="saveEdit()">
              <i class="fas fa-check"></i>
              Save
            </button>
            <button class="edit-action-btn cancel" (click)="cancelEditing()">
              <i class="fas fa-times"></i>
              Cancel
            </button>
          </div>
          <div class="edit-hint">
            Press Enter to save, Shift+Enter for new line, Escape to cancel
          </div>
        </div>
      }
    </div>

    <div class="message-actions" *ngIf="!isProcessing && !isTemporaryMessage && !isEditing">
      <button class="message-action-btn" (click)="onPinClick()" [title]="message.IsPinned ? 'Unpin' : 'Pin'">
        <i class="fas" [ngClass]="message.IsPinned ? 'fa-thumbtack' : 'fa-thumbtack'"></i>
      </button>
      <button class="message-action-btn" (click)="onEditClick()" title="Edit" *ngIf="isUserMessage">
        <i class="fas fa-edit"></i>
      </button>
      <button class="message-action-btn danger" (click)="onDeleteClick()" title="Delete">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  </div>
</div>