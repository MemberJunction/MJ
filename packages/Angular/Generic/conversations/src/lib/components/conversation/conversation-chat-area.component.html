<div class="chat-area">
    <!-- Fixed Header -->
    <div class="chat-header" *ngIf="conversationState.activeConversation as conversation">
    <div class="chat-info">
        <div class="chat-title">{{ conversation.Name }}</div>
        <button class="project-tag" (click)="openProjectSelector()" title="Assign to project" *ngIf="conversation.ProjectID">
        <i class="fas fa-folder"></i>
        <span>{{ conversation.Project || 'Project' }}</span>
        </button>
        <button class="test-indicator" (click)="viewTestRun(conversation.TestRunID)" title="View Test Run" *ngIf="conversation.TestRunID">
        <i class="fas fa-flask"></i>
        <span>Test</span>
        </button>
        <mj-active-agent-indicator
        [conversationId]="conversationState.activeConversation.ID"
        [currentUser]="currentUser"
        (togglePanel)="onToggleAgentPanel()"
        (agentSelected)="onAgentSelected($event)">
        </mj-active-agent-indicator>
    </div>
    <div class="chat-actions">
        <button class="chat-members" (click)="toggleMembersModal()" title="View members">
        <i class="fas fa-users"></i>
        <span>{{ memberCount }} member{{ memberCount !== 1 ? 's' : '' }}</span>
        </button>
        <button class="artifact-indicator" (click)="viewArtifacts()" title="View artifacts" *ngIf="artifactCountDisplay > 0">
        <i class="fas fa-cube"></i>
        <span>{{ artifactCountDisplay }} artifact{{ artifactCountDisplay !== 1 ? 's' : '' }}</span>
        </button>
        <mj-active-agent-indicator
        [conversationId]="conversationState.activeConversation.ID"
        [currentUser]="currentUser"
        (togglePanel)="onToggleAgentPanel()"
        (agentSelected)="onAgentSelected($event)">
        </mj-active-agent-indicator>
    </div>
    <div class="chat-actions">
        <button class="action-btn" (click)="exportConversation()" title="Export conversation">
        <i class="fas fa-download"></i>
        Export
        </button>
        <button class="action-btn share-btn"
                [class.shared]="isShared"
                (click)="shareConversation()"
                [title]="isShared ? 'Manage sharing' : 'Share conversation'">
        <i class="fas fa-share-nodes"></i>
        Share
        </button>
    </div>
    </div>

    <!-- Messages and Artifact Split Layout -->
    <div class="chat-content-area">
    <!-- Messages Pane -->
    <div class="chat-messages-pane" [class.full-width]="!showArtifactPanel">
        @if (!conversationState.activeConversation || conversationState.isNewUnsavedConversation) {
          <!-- Empty State - No conversation selected OR new unsaved conversation -->
          <mj-conversation-empty-state
            [currentUser]="currentUser"
            [disabled]="isProcessing"
            (messageSent)="onEmptyStateMessageSent($event)">
          </mj-conversation-empty-state>
        } @else if (isLoadingConversation) {
          <!-- Loading State - Show centered spinner while conversation loads -->
          <div class="conversation-loading-state">
            <div class="loading-content">
              <i class="fas fa-spinner fa-spin"></i>
              <span>Loading conversation...</span>
            </div>
          </div>
        } @else {
          <!-- Normal Message View -->
          <div class="chat-messages-wrapper">
          <div class="chat-messages-container" #scrollContainer (scroll)="checkScroll()">
              <mj-conversation-message-list
              [messages]="messages"
              [conversation]="conversationState.activeConversation"
              [currentUser]="currentUser"
              [isProcessing]="isProcessing"
              [artifactMap]="effectiveArtifactsMap"
              [agentRunMap]="agentRunsByDetailId"
              [ratingsMap]="ratingsByDetailId"
              [userAvatarMap]="userAvatarMap"
              (replyInThread)="onReplyInThread($event)"
              (viewThread)="onViewThread($event)"
              (retryMessage)="onRetryMessage($event)"
              (testFeedbackMessage)="onTestFeedbackMessage($event)"
              (artifactClicked)="onArtifactClicked($event)"
              (messageEdited)="onMessageEdited($event)"
              (openEntityRecord)="onOpenEntityRecord($event)"
              (suggestedResponseSelected)="onSuggestedResponseSelected($event)">
              </mj-conversation-message-list>

              <!-- Scroll to Bottom Icon (positioned within scroll container for proper centering) -->
              <span class="scroll-to-bottom-icon" style="left: 50%;"
                    *ngIf="showScrollToBottomIcon && messages && messages.length > 0"
                    (click)="scrollToBottomAnimate()">
                  <i class="fas fa-arrow-down"></i>
              </span>
          </div>

          <!-- Fixed Input Area -->
          <div class="chat-input-container">
              @if (isLoadingPeripheralData) {
                <!-- Loading State -->
                <div class="loading-peripheral-placeholder">
                  <div class="loading-peripheral-content">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Loading conversation data...</span>
                  </div>
                </div>
              } @else {
                <!-- Input Component - Multiple instances cached, only one visible -->
                <div class="message-input-container-wrapper">
                  @for (inputRef of getCachedInputs(); track inputRef.conversationId) {
                    <mj-message-input
                      #messageInput
                      [hidden]="inputRef.conversationId !== conversationState.activeConversation.ID"
                      [conversationId]="inputRef.conversationId"
                      [conversationName]="inputRef.conversationName"
                      [currentUser]="currentUser"
                      [conversationHistory]="inputRef.conversationId === conversationState.activeConversation.ID ? messages : []"
                      [artifactsByDetailId]="inputRef.conversationId === conversationState.activeConversation.ID ? artifactsByDetailId : emptyArtifactsMap"
                      [systemArtifactsByDetailId]="inputRef.conversationId === conversationState.activeConversation.ID ? systemArtifactsByDetailId : emptyArtifactsMap"
                      [agentRunsByDetailId]="inputRef.conversationId === conversationState.activeConversation.ID ? agentRunsByDetailId : emptyAgentRunsMap"
                      [inProgressMessageIds]="inputRef.conversationId === conversationState.activeConversation.ID ? inProgressMessageIds : emptyInProgressIds"
                      [disabled]="isProcessing"
                      [initialMessage]="inputRef.conversationId === conversationState.activeConversation.ID ? conversationState.pendingMessageToSend : null"
                      (messageSent)="onMessageSent($event)"
                      (agentResponse)="onAgentResponse($event)"
                      (agentRunDetected)="onAgentRunDetected($event)"
                      (agentRunUpdate)="onAgentRunUpdate($event)"
                      (messageComplete)="onMessageComplete($event)"
                      (artifactCreated)="onArtifactCreated($event)"
                      (conversationRenamed)="onConversationRenamed($event)"
                      (intentCheckStarted)="onIntentCheckStarted()"
                      (intentCheckCompleted)="onIntentCheckCompleted()">
                    </mj-message-input>
                  }
                </div>
              }
          </div>
          </div>
        }
    </div>

    <!-- Artifact Viewer Pane -->
    @if (showArtifactPanel && selectedArtifactId) {
        <div class="resize-handle" (mousedown)="onResizeStart($event)" (touchstart)="onResizeTouchStart($event)"></div>
        <div class="chat-artifact-pane" [style.width.%]="artifactPaneWidth">
        <mj-artifact-viewer-panel
            [artifactId]="selectedArtifactId"
            [currentUser]="currentUser"
            [environmentId]="environmentId"
            [versionNumber]="selectedVersionNumber"
            [viewContext]="'conversation'"
            [canShare]="canShareSelectedArtifact"
            [canEdit]="canEditSelectedArtifact"
            [refreshTrigger]="artifactViewerRefresh$"
            (closed)="onCloseArtifactPanel()"
            (saveToCollectionRequested)="onSaveToCollectionRequested($event)"
            (navigateToLink)="onArtifactLinkNavigation($event)"
            (shareRequested)="onArtifactShareRequested($event)">
        </mj-artifact-viewer-panel>
        </div>
    }

    <!-- Artifact Share Modal -->
    <mj-artifact-share-modal
      [isOpen]="isArtifactShareModalOpen"
      [artifact]="artifactToShare"
      [currentUser]="currentUser"
      (saved)="onArtifactShared()"
      (cancelled)="onArtifactShareModalClose()">
    </mj-artifact-share-modal>
    </div>
</div>

<!-- Thread Panel -->
@if (conversationState.activeThreadId) {
    <mj-thread-panel
    [parentMessageId]="conversationState.activeThreadId"
    [conversationId]="conversationState.activeConversation?.ID || ''"
    [currentUser]="currentUser"
    (closed)="onThreadClosed()"
    (replyAdded)="onThreadReplyAdded($event)">
    </mj-thread-panel>
}

<!-- Export Modal -->
<mj-export-modal
    [isVisible]="showExportModal"
    [conversation]="conversationState.activeConversation || undefined"
    [currentUser]="currentUser"
    (cancelled)="onExportModalCancelled()"
    (exported)="onExportModalComplete()">
</mj-export-modal>

<!-- Members Modal -->
<mj-members-modal
    [isVisible]="showMembersModal"
    [conversation]="conversationState.activeConversation || undefined"
    [currentUser]="currentUser"
    (cancelled)="showMembersModal = false"
    (membersChanged)="showMembersModal = false">
</mj-members-modal>

<!-- Project Selector Modal -->
@if (showProjectSelector && conversationState.activeConversation) {
    <div class="modal-overlay" (click)="showProjectSelector = false">
    <div class="modal-content project-selector-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
        <h3>Assign Project</h3>
        <button class="modal-close-btn" (click)="showProjectSelector = false">
            <i class="fas fa-times"></i>
        </button>
        </div>
        <div class="modal-body">
        <mj-project-selector
            [environmentId]="environmentId"
            [currentUser]="currentUser"
            [selectedProjectId]="conversationState.activeConversation.ProjectID"
            (projectSelected)="onProjectSelected($event)">
        </mj-project-selector>
        </div>
    </div>
    </div>
}

<!-- Artifacts Modal -->
@if (showArtifactsModal) {
    <div class="modal-overlay" (click)="showArtifactsModal = false">
    <div class="modal-content artifacts-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
        <h3>Conversation Artifacts</h3>
        <div class="modal-header-actions">
            @if (hasSystemArtifacts) {
              <button class="toggle-system-btn"
                      [class.active]="showSystemArtifacts"
                      (click)="toggleSystemArtifacts()"
                      title="Toggle system artifacts visibility">
              <i class="fas fa-cog"></i>
              <span>{{ showSystemArtifacts ? 'Hide' : 'Show' }} System</span>
              </button>
            }
            <button class="modal-close-btn" (click)="showArtifactsModal = false">
            <i class="fas fa-times"></i>
            </button>
        </div>
        </div>
        <div class="modal-body artifacts-grid">
        @if (artifactsByDetailId.size === 0) {
            <div class="empty-state">
            <i class="fas fa-cube" style="font-size: 48px; color: #D1D5DB; margin-bottom: 16px;"></i>
            <p style="color: #6B7280; font-size: 14px;">No artifacts in this conversation yet</p>
            </div>
        }
        @for (artifact of getArtifactsArray(); track artifact.artifactId) {
            <div class="artifact-modal-card"
                 [class.expanded]="expandedArtifactId === artifact.artifactId"
                 [class.system-artifact]="artifact.visibility === 'System Only'">
              <!-- Main card header - click to open latest version -->
              <div class="artifact-card-header" (click)="openArtifactFromModal(artifact.artifactId)">
                <div class="artifact-modal-icon">
                    <i class="fas fa-file-code"></i>
                </div>
                <div class="artifact-modal-info">
                    <div class="artifact-modal-title">{{artifact.name}}</div>
                    <div class="artifact-modal-meta">
                      @if (artifact.versionCount > 1) {
                        {{artifact.versionCount}} versions
                      } @else {
                        1 version
                      }
                    </div>
                </div>
                @if (artifact.versionCount > 1) {
                  <button class="expand-btn" (click)="toggleArtifactExpansion(artifact.artifactId, $event)">
                    <i class="fas" [class.fa-chevron-down]="expandedArtifactId !== artifact.artifactId"
                       [class.fa-chevron-up]="expandedArtifactId === artifact.artifactId"></i>
                  </button>
                }
                <div class="artifact-modal-action">
                    <i class="fas fa-external-link-alt"></i>
                </div>
              </div>

              <!-- Expanded version list -->
              @if (expandedArtifactId === artifact.artifactId && artifact.versionCount > 1) {
                <div class="artifact-versions-list">
                  @for (version of artifact.versions; track version.versionId) {
                    <div class="artifact-version-item" (click)="openArtifactFromModal(artifact.artifactId, version.versionNumber); $event.stopPropagation()">
                      <span class="version-badge">v{{version.versionNumber}}</span>
                      <span class="version-open-text">Open this version</span>
                      <i class="fas fa-arrow-right"></i>
                    </div>
                  }
                </div>
              }
            </div>
        }
        </div>
    </div>
    </div>
}

<!-- Collection Picker Modal -->
@if (showCollectionPicker) {
  <mj-artifact-collection-picker-modal
    [isOpen]="showCollectionPicker"
    [environmentId]="environmentId"
    [currentUser]="currentUser"
    [excludeCollectionIds]="collectionPickerExcludedIds"
    (saved)="onCollectionPickerSaved($event)"
    (cancelled)="onCollectionPickerCancelled()">
  </mj-artifact-collection-picker-modal>
}