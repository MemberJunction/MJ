<div class="mj-flow-editor" [class.mj-flow-editor--readonly]="ReadOnly" tabindex="0">

  <!-- Canvas Toolbar -->
  <div class="mj-flow-editor-toolbar-area" *ngIf="ShowToolbar">
    <mj-flow-toolbar
      [ZoomLevel]="zoomLevel"
      [ShowGrid]="ShowGrid"
      [ShowMinimap]="ShowMinimap"
      [ShowLegend]="ShowLegend"
      [ReadOnly]="ReadOnly"
      [PanMode]="panMode"
      (ZoomInClicked)="ZoomIn()"
      (ZoomOutClicked)="ZoomOut()"
      (FitToScreenClicked)="ZoomToFit()"
      (AutoLayoutClicked)="AutoArrange()"
      (GridToggled)="onGridToggled($event)"
      (MinimapToggled)="onMinimapToggled($event)"
      (LegendToggled)="onLegendToggled($event)"
      (PanModeToggled)="onPanModeToggled($event)">
    </mj-flow-toolbar>
  </div>

  <!-- Main Canvas Area -->
  <div class="mj-flow-editor-canvas-area">

    <!-- Palette Sidebar -->
    <mj-flow-palette
      *ngIf="ShowPalette && !ReadOnly"
      [NodeTypes]="NodeTypes">
    </mj-flow-palette>

    <!-- Foblex Canvas -->
    <div class="mj-flow-editor-canvas"
         [class.mj-flow-editor-canvas--pan-mode]="panMode"
         [class.mj-flow-editor-canvas--grid-dots]="ShowGrid">
      <f-flow fDraggable
              [fDraggableDisabled]="false"
              [fCanvasMoveTrigger]="canvasMoveTriggerFn"
              [vCellSize]="GridSize"
              [hCellSize]="GridSize"
              [fCellSizeWhileDragging]="ShowGrid"
              (fLoaded)="onFlowLoaded()"
              (fCreateConnection)="onCreateConnection($event)"
              (fCreateNode)="onCreateNode($event)"
              (fSelectionChange)="onSelectionChange($event)"
              (fMoveNodes)="onNodesMoved($event)">

        <f-canvas fZoom #fZoomRef="fComponent"
                  [fZoomMinimum]="0.15"
                  [fZoomMaximum]="3"
                  [fZoomStep]="0.1"
                  [position]="canvasPosition"
                  [scale]="canvasScale"
                  (fCanvasChange)="onCanvasChange($event)">

          <!-- Alignment snap lines (edit mode only) -->
          <f-line-alignment *ngIf="!ReadOnly" [fAlignThreshold]="10"></f-line-alignment>

          <!-- Interactive connection drawing -->
          <f-connection-for-create *ngIf="!ReadOnly"
                                   fType="bezier"
                                   [fRadius]="8"
                                   [fOffset]="12">
            <svg viewBox="0 0 10 10" fMarker type="end"
                 orient="auto" [refX]="9" [refY]="5" [height]="10" [width]="10">
              <path d="M0 0L10 5L0 10Z" fill="#94a3b8"/>
            </svg>
          </f-connection-for-create>

          <!-- Rubber-band selection (edit mode only) -->
          <f-selection-area *ngIf="!ReadOnly"></f-selection-area>

          <!-- Connections -->
          <f-connection *ngFor="let conn of Connections; trackBy: trackConnectionById"
                        [fConnectionId]="conn.ID"
                        [fOutputId]="conn.SourcePortID"
                        [fInputId]="conn.TargetPortID"
                        fType="bezier"
                        fBehavior="fixed"
                        [fRadius]="8"
                        [fOffset]="12"
                        [fSelectionDisabled]="false"
                        [fReassignDisabled]="ReadOnly"
                        [style.--connection-color]="conn.Color || '#94a3b8'"
                        [class.mj-flow-connection-colored]="!!conn.Color"
                        [class.mj-flow-connection-dashed]="conn.Style === 'dashed'"
                        [class.mj-flow-connection-dotted]="conn.Style === 'dotted'"
                        (click)="onConnectionClicked($event, conn)"
                        (contextmenu)="onConnectionContextMenu($event, conn)">
            <!-- Arrow marker -->
            <svg viewBox="0 0 10 10" fMarker type="end"
                 orient="auto" [refX]="9" [refY]="5" [height]="10" [width]="10">
              <path d="M0 0L10 5L0 10Z" [attr.fill]="conn.Color || '#94a3b8'"/>
            </svg>
            <!-- Connection label -->
            <div *ngIf="conn.Label" fConnectionContent [position]="0.5"
                 class="mj-flow-connection-label"
                 [style.backgroundColor]="ConnectionLabelBackground"
                 [style.borderColor]="ConnectionLabelBorderColor"
                 [style.color]="ConnectionLabelTextColor"
                 [title]="conn.LabelDetail || conn.Label || ''">
              <i *ngIf="conn.LabelIcon"
                 class="fa-solid mj-flow-connection-label-icon"
                 [ngClass]="conn.LabelIcon"
                 [style.color]="conn.LabelIconColor || 'inherit'"></i>
              {{ conn.Label }}
            </div>
          </f-connection>

          <!-- Nodes -->
          <mj-flow-node *ngFor="let node of Nodes; trackBy: trackNodeById"
                        fNode
                        fDragHandle
                        [fNodeId]="node.ID"
                        [fNodePosition]="{ x: node.Position.X, y: node.Position.Y }"
                        [fNodeDraggingDisabled]="ReadOnly || panMode || node.Locked === true"
                        [fNodeSelectionDisabled]="panMode"
                        [fConnectOnNode]="!ReadOnly && !panMode"
                        [Node]="node"
                        [TypeConfig]="GetTypeConfig(node.Type)"
                        [ReadOnly]="ReadOnly"
                        (contextmenu)="onNodeContextMenu($event, node)">
          </mj-flow-node>

        </f-canvas>

        <!-- Minimap -->
        <div *ngIf="ShowMinimap" class="mj-flow-editor-minimap" fDragBlocker>
          <f-minimap [fMinSize]="1500"></f-minimap>
        </div>
      </f-flow>

      <!-- Legend -->
      <div *ngIf="ShowLegend && Nodes.length > 0" class="mj-flow-editor-legend">
        <div class="mj-flow-editor-legend-title">Legend</div>
        <div class="mj-flow-editor-legend-section">
          <div class="mj-flow-editor-legend-heading">Connections</div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-line" style="background:#64748b;"></span>
            <span>Default (sole path)</span>
          </div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-line" style="background:#16a34a;"></span>
            <span>Default (with siblings)</span>
          </div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-line mj-flow-editor-legend-line--dashed" style="background:#f59e0b;"></span>
            <span>Conditional</span>
          </div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-line" style="background:#ef4444;"></span>
            <i class="fa-solid fa-triangle-exclamation" style="color:#ef4444;font-size:10px;"></i>
            <span>Duplicate defaults</span>
          </div>
        </div>
        <div class="mj-flow-editor-legend-section">
          <div class="mj-flow-editor-legend-heading">Node Borders</div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-box" style="border-color:#16a34a;background:#f0fdf4;"></span>
            <span>Start node</span>
          </div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-box" style="border-color:#3b82f6;background:#eff6ff;"></span>
            <span>Default / Active</span>
          </div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-box" style="border-color:#f59e0b;background:#fffbeb;"></span>
            <span>Loop</span>
          </div>
          <div class="mj-flow-editor-legend-item">
            <span class="mj-flow-editor-legend-box" style="border-color:#ef4444;background:#fef2f2;"></span>
            <i class="fa-solid fa-triangle-exclamation" style="color:#ea580c;font-size:10px;"></i>
            <span>Missing config</span>
          </div>
        </div>
      </div>

      <!-- Empty state overlay -->
      <div *ngIf="Nodes.length === 0" class="mj-flow-editor-empty">
        <div class="mj-flow-editor-empty-content">
          <i class="fa-solid fa-diagram-project mj-flow-editor-empty-icon"></i>
          <p class="mj-flow-editor-empty-title" *ngIf="!ReadOnly">Drag steps from the palette to start building your flow</p>
          <p class="mj-flow-editor-empty-title" *ngIf="ReadOnly">No steps defined for this flow</p>
          <p class="mj-flow-editor-empty-subtitle" *ngIf="!ReadOnly">
            Or use auto-layout after adding steps to arrange them automatically
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div *ngIf="contextMenuVisible"
       class="mj-flow-context-menu"
       [style.left.px]="contextMenuX"
       [style.top.px]="contextMenuY"
       (click)="$event.stopPropagation()">
    <button class="mj-flow-context-menu-item" (click)="onContextMenuAction('edit')">
      <i class="fa-solid fa-pen-to-square"></i>
      <span>Edit {{ contextMenuTargetType === 'node' ? 'Node' : 'Connection' }}</span>
    </button>
    <div class="mj-flow-context-menu-divider"></div>
    <button class="mj-flow-context-menu-item mj-flow-context-menu-item--danger" (click)="onContextMenuAction('remove')">
      <i class="fa-solid fa-trash-can"></i>
      <span>Remove {{ contextMenuTargetType === 'node' ? 'Node' : 'Connection' }}</span>
    </button>
  </div>

  <!-- Status Bar -->
  <mj-flow-status-bar *ngIf="ShowStatusBar"
                       [NodeCount]="Nodes.length"
                       [ConnectionCount]="Connections.length"
                       [SelectedCount]="selectedCount"
                       [ZoomLevel]="zoomLevel">
  </mj-flow-status-bar>
</div>
