<div class="mj-agent-editor">

  <!-- ── Top Toolbar ───────────────────────────────────────── -->
  <div class="mj-agent-editor-toolbar" [class.mj-agent-editor-toolbar--editing]="isEditingActive">
    <div class="mj-agent-editor-toolbar-left">
      <!-- Undo / Redo (edit mode only) -->
      <button *ngIf="isEditingActive" class="mj-agent-editor-btn"
              [disabled]="!flowEditor?.CanUndo" (click)="flowEditor?.Undo()" title="Undo (Ctrl+Z)">
        <i class="fa-solid fa-rotate-left"></i>
      </button>
      <button *ngIf="isEditingActive" class="mj-agent-editor-btn"
              [disabled]="!flowEditor?.CanRedo" (click)="flowEditor?.Redo()" title="Redo (Ctrl+Y)">
        <i class="fa-solid fa-rotate-right"></i>
      </button>
    </div>

    <div class="mj-agent-editor-toolbar-center">
      <!-- Fullscreen title -->
      <span *ngIf="FullScreen" class="mj-agent-editor-title">
        <i class="fa-solid fa-diagram-project"></i> Flow Configuration
      </span>

      <!-- View Mode Toggle -->
      <div class="mj-agent-editor-view-toggle">
        <button class="mj-agent-editor-view-btn"
                [class.mj-agent-editor-view-btn--active]="viewMode === 'diagram'"
                (click)="viewMode = 'diagram'">
          <i class="fa-solid fa-diagram-project"></i> Diagram
        </button>
        <button class="mj-agent-editor-view-btn"
                [class.mj-agent-editor-view-btn--active]="viewMode === 'list'"
                (click)="viewMode = 'list'">
          <i class="fa-solid fa-list"></i> List
        </button>
      </div>

      <!-- Mode indicator badge -->
      <span *ngIf="isEditingActive" class="mj-agent-editor-mode-badge mj-agent-editor-mode-badge--editing">
        <i class="fa-solid fa-pen"></i> Editing
      </span>
      <span *ngIf="!isEditingActive" class="mj-agent-editor-mode-badge mj-agent-editor-mode-badge--readonly">
        <i class="fa-solid fa-lock"></i> Read Only
      </span>
    </div>

    <div class="mj-agent-editor-toolbar-right">
      <!-- Status indicators -->
      <span *ngIf="hasUnsavedChanges" class="mj-agent-editor-status mj-agent-editor-status--unsaved">
        <i class="fa-solid fa-circle"></i> Unsaved
      </span>
      <span *ngIf="lastSaved" class="mj-agent-editor-status">
        Saved {{ lastSaved | date:'shortTime' }}
      </span>

      <!-- Save + Cancel (when editing) -->
      <button *ngIf="isEditingActive" class="mj-agent-editor-btn mj-agent-editor-btn--primary"
              [disabled]="isSaving || !hasUnsavedChanges" (click)="Save()">
        <i class="fa-solid" [ngClass]="isSaving ? 'fa-spinner fa-spin' : 'fa-floppy-disk'"></i>
        {{ isSaving ? 'Saving...' : 'Save' }}
      </button>
      <button *ngIf="FullScreen && fullscreenEditMode && !EditMode"
              class="mj-agent-editor-btn"
              (click)="cancelFullscreenEdit()" title="Cancel editing">
        <i class="fa-solid fa-xmark"></i> Cancel
      </button>

      <div *ngIf="isEditingActive" class="mj-agent-editor-btn-divider"></div>

      <!-- Fullscreen edit toggle (only in fullscreen, and only when parent is NOT in edit mode) -->
      <button *ngIf="FullScreen && !EditMode && !fullscreenEditMode"
              class="mj-agent-editor-btn mj-agent-editor-btn--edit"
              (click)="toggleFullscreenEditMode()" title="Edit flow">
        <i class="fa-solid fa-pen-to-square"></i> Edit
      </button>

      <!-- Expand / Close -->
      <button *ngIf="!FullScreen" class="mj-agent-editor-btn mj-agent-editor-btn--expand"
              (click)="toggleFullScreen()" title="Expand to full screen">
        <i class="fa-solid fa-up-right-and-down-left-from-center"></i> Expand
      </button>
      <button *ngIf="FullScreen" class="mj-agent-editor-btn mj-agent-editor-btn--close"
              (click)="toggleFullScreen()" title="Close full screen (Esc)">
        <i class="fa-solid fa-xmark"></i> Close
      </button>
    </div>
  </div>

  <!-- ── Loading State ─────────────────────────────────────── -->
  <div *ngIf="isLoading" class="mj-agent-editor-loading">
    <i class="fa-solid fa-spinner fa-spin"></i>
    <span>Loading flow...</span>
  </div>

  <!-- ── Main Content ──────────────────────────────────────── -->
  <div *ngIf="!isLoading" class="mj-agent-editor-body">

    <!-- Diagram View -->
    <div *ngIf="viewMode === 'diagram'" class="mj-agent-editor-diagram">
      <mj-flow-editor #flowEditor
                       [Nodes]="nodes"
                       [Connections]="connections"
                       [NodeTypes]="nodeTypes"
                       [ReadOnly]="!isEditingActive"
                       [ShowMinimap]="true"
                       [ShowPalette]="isEditingActive"
                       [ShowGrid]="true"
                       [ShowStatusBar]="true"
                       [ShowToolbar]="true"
                       [AutoLayoutDirection]="'vertical'"
                       (NodeSelected)="onNodeSelected($event)"
                       (NodeAdded)="onNodeAdded($event)"
                       (NodeRemoved)="onNodeRemoved($event)"
                       (ConnectionCreated)="onConnectionCreated($event)"
                       (ConnectionRemoved)="onConnectionRemoved($event)"
                       (ConnectionSelected)="onConnectionSelected($event)"
                       (NodesChanged)="onNodesChanged($event)"
                       (ConnectionsChanged)="onConnectionsChanged($event)">
      </mj-flow-editor>

      <!-- Properties Panel -->
      <div class="mj-agent-editor-properties"
           [class.mj-agent-editor-properties--visible]="showPropertiesPanel">
        <mj-agent-properties-panel
          [Step]="selectedStep"
          [SelectedConnection]="selectedConnection"
          [PathEntity]="selectedPathEntity"
          [ReadOnly]="!isEditingActive"
          [Actions]="availableActions"
          [Prompts]="availablePrompts"
          [Agents]="availableAgents"
          [AllSteps]="steps"
          (StepChanged)="onStepChanged($event)"
          (PathChanged)="onPathChanged($event)"
          (DeleteStepRequested)="onDeleteStepRequested($event)"
          (DeletePathRequested)="onDeletePathRequested($event)"
          (CloseRequested)="onCloseProperties()">
        </mj-agent-properties-panel>
      </div>
    </div>

    <!-- List View -->
    <div *ngIf="viewMode === 'list'" class="mj-agent-editor-list">
      <mj-agent-step-list
        [Steps]="steps"
        [Paths]="paths"
        [SelectedStepID]="selectedStep?.ID || null"
        (StepClicked)="onStepClickedInList($event)">
      </mj-agent-step-list>

      <!-- Properties Panel in list mode too -->
      <div class="mj-agent-editor-properties"
           [class.mj-agent-editor-properties--visible]="showPropertiesPanel">
        <mj-agent-properties-panel
          [Step]="selectedStep"
          [SelectedConnection]="selectedConnection"
          [PathEntity]="selectedPathEntity"
          [ReadOnly]="!isEditingActive"
          [Actions]="availableActions"
          [Prompts]="availablePrompts"
          [Agents]="availableAgents"
          [AllSteps]="steps"
          (StepChanged)="onStepChanged($event)"
          (PathChanged)="onPathChanged($event)"
          (DeleteStepRequested)="onDeleteStepRequested($event)"
          (DeletePathRequested)="onDeletePathRequested($event)"
          (CloseRequested)="onCloseProperties()">
        </mj-agent-properties-panel>
      </div>
    </div>
  </div>

  <!-- ── Unsaved Changes Dialog ──────────────────────────── -->
  <div *ngIf="showUnsavedDialog" class="mj-agent-editor-dialog-overlay">
    <div class="mj-agent-editor-dialog">
      <div class="mj-agent-editor-dialog-icon">
        <i class="fa-solid fa-triangle-exclamation"></i>
      </div>
      <h3 class="mj-agent-editor-dialog-title">Unsaved Changes</h3>
      <p class="mj-agent-editor-dialog-message">
        You have unsaved changes to this flow. What would you like to do?
      </p>
      <div class="mj-agent-editor-dialog-actions">
        <button class="mj-agent-editor-btn mj-agent-editor-btn--primary" (click)="onUnsavedDialogSave()">
          <i class="fa-solid fa-floppy-disk"></i> Save & Close
        </button>
        <button class="mj-agent-editor-btn mj-agent-editor-btn--danger-outline" (click)="onUnsavedDialogDiscard()">
          Discard Changes
        </button>
        <button class="mj-agent-editor-btn" (click)="onUnsavedDialogCancel()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
