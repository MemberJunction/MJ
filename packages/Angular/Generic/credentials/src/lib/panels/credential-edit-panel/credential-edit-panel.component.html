@if (isOpen) {
  <div class="panel-backdrop" (click)="onBackdropClick()">
    <div class="edit-panel" [class.open]="isOpen">
      <!-- Panel Header -->
      <div class="panel-header">
        <div class="header-content">
          @if (selectedType) {
            <div class="header-icon" [style.backgroundColor]="getTypeColor(selectedType) + '15'" [style.color]="getTypeColor(selectedType)">
              <i [class]="getTypeIcon(selectedType)"></i>
            </div>
          }
          @if (!selectedType) {
            <div class="header-icon default">
              <i class="fa-solid fa-key"></i>
            </div>
          }
          <div class="header-text">
            <h2>{{panelTitle}}</h2>
            @if (selectedType) {
              <span class="header-subtitle">{{selectedType.Name}}</span>
            }
            @if (!selectedType) {
              <span class="header-subtitle">Select a credential type</span>
            }
          </div>
        </div>
        <button class="close-btn" (click)="closePanel()" [disabled]="isSaving">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <!-- Panel Body -->
      <div class="panel-body">
        @if (isLoading) {
          <mj-loading text="Loading..."></mj-loading>
        }
        @if (!isLoading) {
          <form class="credential-form" (submit)="$event.preventDefault(); save()">
            <!-- Basic Info Section -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fa-solid fa-info-circle"></i>
                Basic Information
              </h3>
              <div class="form-group">
                <label for="credentialName" class="required">Name</label>
                <input
                  type="text"
                  id="credentialName"
                  name="credentialName"
                  [(ngModel)]="name"
                  placeholder="e.g., Production OpenAI Key"
                  [disabled]="isSaving"
                  required
                  />
              </div>
              <div class="form-group">
                <label for="credentialType" class="required">Credential Type</label>
                <select
                  id="credentialType"
                  name="credentialType"
                  [(ngModel)]="selectedTypeId"
                  (ngModelChange)="onTypeChange()"
                  [disabled]="isSaving || !isNew"
                  required
                  >
                  <option [ngValue]="''">Select a type...</option>
                  @for (group of groupedCredentialTypes; track group) {
                    <optgroup [label]="group.category">
                      @for (type of group.types; track type) {
                        <option [ngValue]="type.ID">
                          {{type.Name}}
                        </option>
                      }
                    </optgroup>
                  }
                </select>
                @if (!isNew) {
                  <span class="field-hint">Type cannot be changed after creation</span>
                }
              </div>
              <div class="form-group">
                <label for="credentialCategory">Category</label>
                <select
                  id="credentialCategory"
                  name="credentialCategory"
                  [(ngModel)]="selectedCategoryId"
                  [disabled]="isSaving"
                  >
                  <option [ngValue]="''">No category</option>
                  @for (cat of categories; track cat) {
                    <option [ngValue]="cat.ID">{{cat.Name}}</option>
                  }
                </select>
              </div>
              <div class="form-group">
                <label for="credentialDescription">Description</label>
                <textarea
                  id="credentialDescription"
                  name="credentialDescription"
                  [(ngModel)]="description"
                  placeholder="Optional description..."
                  rows="3"
                  [disabled]="isSaving"
                ></textarea>
              </div>
            </div>
            <!-- Credential Values Section -->
            @if (schemaFields.length > 0) {
              <div class="form-section">
                <h3 class="section-title">
                  <i class="fa-solid fa-key"></i>
                  Credential Values
                  <span class="encrypted-badge">
                    <i class="fa-solid fa-lock"></i>
                    Encrypted
                  </span>
                </h3>
                @for (field of schemaFields; track field) {
                  <div class="form-group">
                    <label [for]="'field-' + field.name" [class.required]="field.required">
                      {{field.title}}
                    </label>
                    @if (field.isSecret) {
                      <div class="secret-field-wrapper">
                        <input
                          [type]="isSecretVisible(field.name) ? 'text' : 'password'"
                          [id]="'field-' + field.name"
                          [name]="'field-' + field.name"
                          [value]="credentialValues[field.name] || ''"
                          (input)="onValueChange(field.name, $any($event.target).value)"
                          [placeholder]="field.description || 'Enter ' + field.title"
                          [disabled]="isSaving"
                          [required]="field.required"
                          autocomplete="off"
                          />
                        <button
                          type="button"
                          class="toggle-visibility-btn"
                          (click)="toggleSecretVisibility(field.name)"
                          [title]="isSecretVisible(field.name) ? 'Hide' : 'Show'"
                          >
                          <i [class]="isSecretVisible(field.name) ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                        </button>
                      </div>
                    } @else {
                      <!-- Const fields: Read-only display -->
                      @if (field.const !== undefined) {
                        <div class="const-field-display">
                          <div class="const-value-container">
                            <span class="const-value">{{credentialValues[field.name] || ''}}</span>
                            <i class="fa-solid fa-lock const-lock-icon" title="This value is fixed and cannot be changed"></i>
                          </div>
                          <span class="field-hint const-hint">This field is automatically configured</span>
                        </div>
                      }
                      <!-- Enum fields: Dropdown/select -->
                      @if (field.const === undefined && field.enum && field.enum.length > 0) {
                        <select
                          [id]="'field-' + field.name"
                          [name]="'field-' + field.name"
                          [ngModel]="credentialValues[field.name] || ''"
                          (ngModelChange)="onValueChange(field.name, $event)"
                          [disabled]="isSaving"
                          [required]="field.required"
                          >
                          <option [ngValue]="''">Select {{field.title}}...</option>
                          @for (option of field.enum; track option) {
                            <option [ngValue]="option">{{option}}</option>
                          }
                        </select>
                      }
                      <!-- Regular text/number input -->
                      @if (field.const === undefined && !field.enum && (field.type === 'string' || field.type === 'number')) {
                        <input
                          [type]="field.type === 'number' ? 'number' : 'text'"
                          [id]="'field-' + field.name"
                          [name]="'field-' + field.name"
                          [value]="credentialValues[field.name] || ''"
                          (input)="onValueChange(field.name, $any($event.target).value)"
                          [placeholder]="field.description || 'Enter ' + field.title"
                          [disabled]="isSaving"
                          [required]="field.required"
                          [attr.minlength]="field.minLength"
                          [attr.maxlength]="field.maxLength"
                          [attr.min]="field.minimum"
                          [attr.max]="field.maximum"
                          [attr.pattern]="field.pattern"
                          />
                      }
                    }
                    @if (field.description && !field.isSecret) {
                      <span class="field-hint">{{field.description}}</span>
                    }
                  </div>
                }
              </div>
            }
            <!-- No Type Selected Message -->
            @if (isNew && !selectedTypeId) {
              <div class="no-type-message">
                <div class="message-icon">
                  <i class="fa-solid fa-hand-pointer"></i>
                </div>
                <p>Select a credential type above to configure the credential values.</p>
              </div>
            }
            <!-- Settings Section -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fa-solid fa-cog"></i>
                Settings
              </h3>
              <div class="toggle-group">
                <label class="toggle-label">
                  <span class="toggle-wrapper">
                    <input
                      type="checkbox"
                      name="isActive"
                      [(ngModel)]="isActive"
                      [disabled]="isSaving"
                      />
                    <span class="toggle-slider"></span>
                  </span>
                  <span class="toggle-text">
                    <span class="toggle-title">Active</span>
                    <span class="toggle-description">Enable this credential for use</span>
                  </span>
                </label>
              </div>
              <div class="toggle-group">
                <label class="toggle-label">
                  <span class="toggle-wrapper">
                    <input
                      type="checkbox"
                      name="isDefault"
                      [(ngModel)]="isDefault"
                      [disabled]="isSaving"
                      />
                    <span class="toggle-slider"></span>
                  </span>
                  <span class="toggle-text">
                    <span class="toggle-title">Default</span>
                    <span class="toggle-description">Use as default for this credential type</span>
                  </span>
                </label>
              </div>
              <div class="form-group">
                <label for="expiresAt">Expiration Date</label>
                <input
                  type="date"
                  id="expiresAt"
                  name="expiresAt"
                  [value]="formatDateForInput(expiresAt)"
                  (change)="onExpiresAtChange($any($event.target).value)"
                  [disabled]="isSaving"
                  />
                <span class="field-hint">Leave empty for no expiration</span>
              </div>
            </div>
          </form>
        }
      </div>
      <!-- Panel Footer -->
      <div class="panel-footer">
        <div class="footer-left">
          @if (!isNew) {
            <button
              class="btn-delete"
              (click)="deleteCredential()"
              [disabled]="isSaving"
              >
              <i class="fa-solid fa-trash"></i>
              <span>Delete</span>
            </button>
          }
        </div>
        <div class="footer-right">
          <button
            class="btn-secondary"
            (click)="closePanel()"
            [disabled]="isSaving"
            >
            Cancel
          </button>
          <button
            class="btn-primary"
            (click)="save()"
            [disabled]="isSaving || !canSave"
            >
            @if (isSaving) {
              <i class="fa-solid fa-spinner fa-spin"></i>
            }
            @if (!isSaving) {
              <i class="fa-solid fa-check"></i>
            }
            <span>{{isNew ? 'Create' : 'Save'}}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
}
