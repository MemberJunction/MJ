@if (isOpen) {
  <div class="panel-backdrop" (click)="onBackdropClick($event)">
    <div class="edit-panel" [class.open]="isOpen">
      <!-- Panel Header -->
      <div class="panel-header">
        <div class="header-content">
          <div class="header-icon" [style.backgroundColor]="getCategoryColor(category) + '15'" [style.color]="getCategoryColor(category)">
            <i [class]="iconClass || getCategoryIcon(category)"></i>
          </div>
          <div class="header-text">
            <h2>{{panelTitle}}</h2>
            <span class="header-subtitle">{{category}} credential type</span>
          </div>
        </div>
        <button class="close-btn" (click)="closePanel()" [disabled]="isSaving">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <!-- Panel Body -->
      <div class="panel-body">
        @if (isLoading) {
          <mj-loading text="Loading..."></mj-loading>
        }
        @if (!isLoading) {
          <form class="type-form" (submit)="$event.preventDefault(); save()">
            <!-- Basic Info Section -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fa-solid fa-info-circle"></i>
                Basic Information
              </h3>
              <div class="form-group">
                <label for="typeName" class="required">Name</label>
                <input
                  type="text"
                  id="typeName"
                  name="typeName"
                  [(ngModel)]="name"
                  placeholder="e.g., OpenAI, SendGrid, AWS S3"
                  [disabled]="isSaving"
                  required
                  />
              </div>
              <div class="form-group">
                <label for="typeCategory" class="required">Category</label>
                <div class="category-selector">
                  @for (cat of categories; track cat) {
                    <button
                      type="button"
                      class="category-btn"
                      [class.selected]="category === cat"
                      [style.--cat-color]="getCategoryColor(cat)"
                      (click)="category = cat"
                      [disabled]="isSaving"
                      >
                      <i [class]="getCategoryIcon(cat)"></i>
                      <span>{{cat}}</span>
                    </button>
                  }
                </div>
              </div>
              <div class="form-group">
                <label for="typeDescription">Description</label>
                <textarea
                  id="typeDescription"
                  name="typeDescription"
                  [(ngModel)]="description"
                  placeholder="Optional description of this credential type..."
                  rows="3"
                  [disabled]="isSaving"
                ></textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="typeIcon">Icon Class</label>
                  <input
                    type="text"
                    id="typeIcon"
                    name="typeIcon"
                    [(ngModel)]="iconClass"
                    placeholder="e.g., fa-brands fa-openai"
                    [disabled]="isSaving"
                    />
                  <span class="field-hint">Font Awesome icon class</span>
                </div>
                <div class="form-group">
                  <label for="validationEndpoint">Validation Endpoint</label>
                  <input
                    type="text"
                    id="validationEndpoint"
                    name="validationEndpoint"
                    [(ngModel)]="validationEndpoint"
                    placeholder="https://api.example.com/validate"
                    [disabled]="isSaving"
                    />
                  <span class="field-hint">Optional API endpoint to validate credentials</span>
                </div>
              </div>
            </div>
            <!-- Field Schema Section -->
            <div class="form-section">
              <div class="section-header-row">
                <h3 class="section-title">
                  <i class="fa-solid fa-list-check"></i>
                  Field Schema
                </h3>
                <button
                  type="button"
                  class="btn-add-field"
                  (click)="addSchemaField()"
                  [disabled]="isSaving"
                  >
                  <i class="fa-solid fa-plus"></i>
                  Add Field
                </button>
              </div>
              @if (schemaFields.length > 0) {
                <div class="schema-fields">
                  @for (field of schemaFields; track field; let i = $index) {
                    <div class="schema-field">
                      <div class="field-drag-handle">
                        <button type="button" class="move-btn" (click)="moveFieldUp(i)" [disabled]="i === 0 || isSaving">
                          <i class="fa-solid fa-chevron-up"></i>
                        </button>
                        <button type="button" class="move-btn" (click)="moveFieldDown(i)" [disabled]="i === schemaFields.length - 1 || isSaving">
                          <i class="fa-solid fa-chevron-down"></i>
                        </button>
                      </div>
                      <div class="field-content">
                        <div class="field-row">
                          <input
                            type="text"
                            [name]="'fieldName_' + i"
                            [(ngModel)]="field.name"
                            placeholder="Field name (e.g., apiKey)"
                            class="field-name-input"
                            [disabled]="isSaving"
                            />
                          <input
                            type="text"
                            [name]="'fieldTitle_' + i"
                            [(ngModel)]="field.title"
                            placeholder="Display title"
                            class="field-title-input"
                            [disabled]="isSaving"
                            />
                          <select [name]="'fieldType_' + i" [(ngModel)]="field.type" class="field-type-select" [disabled]="isSaving">
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                          </select>
                        </div>
                        <div class="field-row">
                          <input
                            type="text"
                            [name]="'fieldDesc_' + i"
                            [(ngModel)]="field.description"
                            placeholder="Field description (optional)"
                            class="field-desc-input"
                            [disabled]="isSaving"
                            />
                        </div>
                        <div class="field-options">
                          <label class="checkbox-label">
                            <input type="checkbox" [name]="'fieldRequired_' + i" [(ngModel)]="field.required" [disabled]="isSaving" />
                            <span>Required</span>
                          </label>
                          <label class="checkbox-label">
                            <input type="checkbox" [name]="'fieldSecret_' + i" [(ngModel)]="field.isSecret" [disabled]="isSaving" />
                            <span><i class="fa-solid fa-lock"></i> Secret</span>
                          </label>
                        </div>
                      </div>
                      <button
                        type="button"
                        class="remove-field-btn"
                        (click)="removeSchemaField(i)"
                        [disabled]="isSaving"
                        title="Remove field"
                        >
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  }
                </div>
              }
              @if (schemaFields.length === 0) {
                <div class="no-fields-message">
                  <i class="fa-solid fa-info-circle"></i>
                  <span>No fields defined. Add fields that credentials of this type will need to store.</span>
                </div>
              }
            </div>
          </form>
        }
      </div>
      <!-- Panel Footer -->
      <div class="panel-footer">
        <div class="footer-left">
          @if (!isNew) {
            <button
              class="btn-delete"
              (click)="deleteType()"
              [disabled]="isSaving"
              >
              <i class="fa-solid fa-trash"></i>
              <span>Delete</span>
            </button>
          }
        </div>
        <div class="footer-right">
          <button
            class="btn-secondary"
            (click)="closePanel()"
            [disabled]="isSaving"
            >
            Cancel
          </button>
          <button
            class="btn-primary"
            (click)="save()"
            [disabled]="isSaving || !canSave"
            >
            @if (isSaving) {
              <i class="fa-solid fa-spinner fa-spin"></i>
            }
            @if (!isSaving) {
              <i class="fa-solid fa-check"></i>
            }
            <span>{{isNew ? 'Create' : 'Save'}}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
}
