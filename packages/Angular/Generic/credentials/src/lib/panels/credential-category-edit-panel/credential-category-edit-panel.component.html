@if (isOpen) {
  <div class="panel-backdrop" (click)="onBackdropClick($event)">
    <div class="edit-panel" [class.open]="isOpen">
      <!-- Panel Header -->
      <div class="panel-header">
        <div class="header-content">
          <div class="header-icon" [style.backgroundColor]="'#6366f1' + '15'" [style.color]="'#6366f1'">
            <i [class]="iconClass || 'fa-solid fa-folder'"></i>
          </div>
          <div class="header-text">
            <h2>{{panelTitle}}</h2>
            @if (parentId) {
              <span class="header-subtitle">
                Under: {{getParentPath(parentId)}}
              </span>
            }
            @if (!parentId) {
              <span class="header-subtitle">Root category</span>
            }
          </div>
        </div>
        <button class="close-btn" (click)="closePanel()" [disabled]="isSaving">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <!-- Panel Body -->
      <div class="panel-body">
        @if (isLoading) {
          <mj-loading text="Loading..."></mj-loading>
        }
        @if (!isLoading) {
          <form class="category-form" (submit)="$event.preventDefault(); save()">
            <!-- Basic Info Section -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fa-solid fa-info-circle"></i>
                Basic Information
              </h3>
              <div class="form-group">
                <label for="categoryName" class="required">Name</label>
                <input
                  type="text"
                  id="categoryName"
                  name="categoryName"
                  [(ngModel)]="name"
                  placeholder="e.g., Production, Development, API Keys"
                  [disabled]="isSaving"
                  required
                  />
              </div>
              <div class="form-group">
                <label for="categoryParent">Parent Category</label>
                <select
                  id="categoryParent"
                  name="categoryParent"
                  [(ngModel)]="parentId"
                  [disabled]="isSaving"
                  >
                  <option [ngValue]="''">No parent (root category)</option>
                  @for (cat of availableParentCategories; track cat) {
                    <option [ngValue]="cat.ID">
                      {{getParentPath(cat.ID)}}
                    </option>
                  }
                </select>
                <span class="field-hint">Select a parent to create a subcategory</span>
              </div>
              <div class="form-group">
                <label for="categoryDescription">Description</label>
                <textarea
                  id="categoryDescription"
                  name="categoryDescription"
                  [(ngModel)]="description"
                  placeholder="Optional description of this category..."
                  rows="3"
                  [disabled]="isSaving"
                ></textarea>
              </div>
            </div>
            <!-- Icon Section -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="fa-solid fa-icons"></i>
                Icon
              </h3>
              <div class="form-group">
                <label for="categoryIcon">Custom Icon Class</label>
                <input
                  type="text"
                  id="categoryIcon"
                  name="categoryIcon"
                  [(ngModel)]="iconClass"
                  placeholder="e.g., fa-solid fa-folder"
                  [disabled]="isSaving"
                  />
                <span class="field-hint">Font Awesome icon class</span>
              </div>
              <div class="icon-suggestions">
                <p class="suggestions-label">Quick pick:</p>
                <div class="icon-grid">
                  @for (suggestion of iconSuggestions; track suggestion) {
                    <button
                      type="button"
                      class="icon-btn"
                      [class.selected]="iconClass === suggestion.icon"
                      (click)="selectIcon(suggestion.icon)"
                      [disabled]="isSaving"
                      [title]="suggestion.label"
                      >
                      <i [class]="suggestion.icon"></i>
                    </button>
                  }
                </div>
              </div>
              @if (iconClass) {
                <div class="icon-preview">
                  <div class="preview-label">Preview:</div>
                  <div class="preview-icon">
                    <i [class]="iconClass"></i>
                  </div>
                </div>
              }
            </div>
          </form>
        }
      </div>
      <!-- Panel Footer -->
      <div class="panel-footer">
        <div class="footer-left">
          @if (!isNew) {
            <button
              class="btn-delete"
              (click)="deleteCategory()"
              [disabled]="isSaving"
              >
              <i class="fa-solid fa-trash"></i>
              <span>Delete</span>
            </button>
          }
        </div>
        <div class="footer-right">
          <button
            class="btn-secondary"
            (click)="closePanel()"
            [disabled]="isSaving"
            >
            Cancel
          </button>
          <button
            class="btn-primary"
            (click)="save()"
            [disabled]="isSaving || !canSave"
            >
            @if (isSaving) {
              <i class="fa-solid fa-spinner fa-spin"></i>
            }
            @if (!isSaving) {
              <i class="fa-solid fa-check"></i>
            }
            <span>{{isNew ? 'Create' : 'Save'}}</span>
          </button>
        </div>
      </div>
    </div>
  </div>
}
