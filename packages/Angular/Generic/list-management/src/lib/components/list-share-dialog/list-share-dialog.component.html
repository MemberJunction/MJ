@if (visible) {
  <kendo-dialog
    [title]="dialogTitle"
    [width]="500"
    [minWidth]="400"
    (close)="onCancel()">
    <div class="share-dialog-content">
      <!-- Loading state -->
      @if (loading) {
        <div class="loading-container">
          <mj-loading text="Loading shares..."></mj-loading>
        </div>
      }
      @if (!loading) {
        <!-- Add new share section -->
        @if (canModifyShares) {
          <div class="add-share-section">
            <h4 class="section-title">Add people or roles</h4>
            <!-- Search type toggle -->
            <div class="search-type-toggle">
              <button kendoButton
                [fillMode]="searchType === 'User' ? 'solid' : 'outline'"
                [themeColor]="searchType === 'User' ? 'primary' : 'base'"
                (click)="setSearchType('User')">
                <i class="fa-solid fa-user"></i> Users
              </button>
              <button kendoButton
                [fillMode]="searchType === 'Role' ? 'solid' : 'outline'"
                [themeColor]="searchType === 'Role' ? 'primary' : 'base'"
                (click)="setSearchType('Role')">
                <i class="fa-solid fa-users"></i> Roles
              </button>
            </div>
            <!-- Search input -->
            <div class="search-container">
              <kendo-textbox
                [value]="searchText"
                (valueChange)="onSearchInput($event)"
                [placeholder]="'Search for ' + (searchType === 'User' ? 'users' : 'roles') + '...'"
                [clearButton]="true"
                (blur)="showSearchResults = false">
                <ng-template kendoTextBoxPrefixTemplate>
                  <i class="fa-solid fa-search search-icon"></i>
                </ng-template>
              </kendo-textbox>
              <!-- Search results dropdown -->
              @if (showSearchResults && searchResults.length > 0) {
                <div class="search-results">
                  @for (recipient of searchResults; track recipient) {
                    <div class="search-result-item"
                      (mousedown)="selectRecipient(recipient)">
                      <i [class]="getShareTypeIcon(recipient.type)"></i>
                      <div class="recipient-info">
                        <span class="recipient-name">{{ recipient.name }}</span>
                        @if (recipient.email) {
                          <span class="recipient-email">{{ recipient.email }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
            <!-- Selected recipient and permission -->
            @if (selectedRecipient) {
              <div class="selected-recipient">
                <div class="recipient-chip">
                  <i [class]="getShareTypeIcon(selectedRecipient.type)"></i>
                  <span>{{ selectedRecipient.name }}</span>
                  <button kendoButton [look]="'flat'" [icon]="'close'" (click)="clearSearch()"></button>
                </div>
                <kendo-dropdownlist
                  [data]="permissionOptions"
                  [textField]="'label'"
                  [valueField]="'value'"
                  [(ngModel)]="selectedPermission"
                  [valuePrimitive]="true"
                  class="permission-dropdown">
                  <ng-template kendoDropDownListItemTemplate let-dataItem>
                    <div class="permission-option">
                      <span class="permission-label">{{ dataItem.label }}</span>
                      <span class="permission-desc">{{ dataItem.description }}</span>
                    </div>
                  </ng-template>
                </kendo-dropdownlist>
                <button kendoButton
                  themeColor="primary"
                  [disabled]="saving"
                  (click)="addShare()">
                  <i class="fa-solid fa-plus"></i> Add
                </button>
              </div>
            }
          </div>
        }
        <!-- Divider -->
        @if (currentShares.length > 0 && canModifyShares) {
          <hr class="section-divider">
        }
        <!-- Current shares section -->
        @if (currentShares.length > 0) {
          <div class="current-shares-section">
            <h4 class="section-title">People with access</h4>
            <div class="share-list">
              @for (share of currentShares; track share) {
                <div class="share-item">
                  <div class="share-info">
                    <i [class]="getShareTypeIcon(share.type)" class="share-type-icon"></i>
                    <div class="share-details">
                      <span class="share-name">{{ share.recipientName }}</span>
                      @if (share.recipientEmail) {
                        <span class="share-email">{{ share.recipientEmail }}</span>
                      }
                      @if (share.type === 'Role') {
                        <span class="share-type-label">Role</span>
                      }
                    </div>
                  </div>
                  <div class="share-actions">
                    @if (canModifyShares) {
                      <kendo-dropdownlist
                        [data]="permissionOptions"
                        [textField]="'label'"
                        [valueField]="'value'"
                        [value]="share.permissionLevel"
                        [valuePrimitive]="true"
                        (valueChange)="updateSharePermission(share, $event)"
                        [disabled]="saving"
                        class="permission-dropdown-small">
                      </kendo-dropdownlist>
                    }
                    @if (!canModifyShares) {
                      <span class="permission-badge">
                        {{ getPermissionLabel(share.permissionLevel) }}
                      </span>
                    }
                    @if (canModifyShares) {
                      <button kendoButton
                        [look]="'flat'"
                        [icon]="'trash'"
                        title="Remove access"
                        [disabled]="saving"
                        (click)="removeShare(share)">
                      </button>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        }
        <!-- Empty state -->
        @if (currentShares.length === 0 && !loading) {
          <div class="empty-state">
            <i class="fa-solid fa-share-nodes empty-icon"></i>
            <p>This list hasn't been shared with anyone yet.</p>
            @if (canModifyShares) {
              <p class="empty-hint">
                Use the search above to find users or roles to share with.
              </p>
            }
          </div>
        }
        <!-- Read-only notice -->
        @if (!canModifyShares) {
          <div class="readonly-notice">
            <i class="fa-solid fa-info-circle"></i>
            <span>Only the list owner can manage sharing.</span>
          </div>
        }
      }
    </div>
    <kendo-dialog-actions>
      <button kendoButton themeColor="primary" (click)="onDone()">Done</button>
      <button kendoButton (click)="onCancel()">Cancel</button>
    </kendo-dialog-actions>
  </kendo-dialog>
}
