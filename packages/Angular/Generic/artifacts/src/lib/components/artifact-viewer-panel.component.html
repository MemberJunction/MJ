<div class="artifact-viewer-panel">
  <div class="panel-header">
    <div class="panel-header-left">
      <h3>
        <i class="fas fa-cube"></i>
        {{ displayName }}
      </h3>
      @if (displayDescription) {
        <p class="header-description">{{ displayDescription }}</p>
      }
    </div>
    <div class="panel-header-right">
      <div class="version-selector" [class.clickable]="allVersions.length > 1" (click)="toggleVersionDropdown()">
        <i class="fas fa-history"></i>
        <span class="version-label">v{{ selectedVersionNumber }}</span>
        @if (allVersions.length > 1) {
          <i class="fas fa-chevron-down dropdown-icon" [class.open]="showVersionDropdown"></i>
        }
        @if (showVersionDropdown) {
          <div class="version-dropdown" (click)="$event.stopPropagation()">
            @for (version of allVersions; track version.ID) {
              <div class="version-option"
                   [class.selected]="version.VersionNumber === selectedVersionNumber"
                   (click)="selectVersion(version); $event.stopPropagation()">
                <span class="version-number">v{{ version.VersionNumber }}</span>
                <span class="version-date">{{ version.__mj_CreatedAt | date:'short' }}</span>
                @if (version.VersionNumber === selectedVersionNumber) {
                  <i class="fas fa-check"></i>
                }
              </div>
            }
          </div>
        }
      </div>
      @if (showSaveToCollection) {
        <button class="save-to-collection-btn"
                [class.in-collection]="isInCollection"
                (click)="onSaveToLibrary()"
                [title]="isInCollection ? 'Saved to ' + artifactCollections.length + ' collection(s)' : 'Save to Collection'">
          <i [class]="isInCollection ? 'fas fa-bookmark' : 'far fa-bookmark'"></i>
        </button>
      }
      @if (canShare) {
        <button class="share-btn"
                (click)="onShare()"
                title="Share">
          <i class="fas fa-share-nodes"></i>
        </button>
      }
      <button class="close-btn" (click)="onClose()" title="Close">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="panel-content">
    @if (isLoading) {
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading artifact...</span>
      </div>
    }

    @if (error) {
      <div class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ error }}</span>
      </div>
    }

    @if (!isLoading && !error && artifact) {
      <div class="artifact-content-wrapper">
        <!-- Tab Navigation (Dynamic) -->
        <div class="tab-navigation">
          @for (tab of allTabs; track tab) {
            <button class="tab-btn"
                    [class.active]="activeTab === tab.toLowerCase()"
                    (click)="SetActiveTab(tab)">
              @if (GetTabIcon(tab)) {
                <i [class]="GetTabIcon(tab)!"></i>
              }
              {{ tab }}
            </button>
          }
        </div>

        <!-- Tab Content (Dynamic) -->
        <div class="tab-content">
          <!-- Plugin Viewer - Created once, kept alive, shown/hidden with CSS -->
          @if (hasPlugin && artifactVersion && artifactTypeName) {
            <div class="plugin-container" [style.display]="activeTab === 'display' ? 'block' : 'none'">
              <mj-artifact-type-plugin-viewer
                [artifactVersion]="artifactVersion"
                [artifactTypeName]="artifactTypeName"
                [contentType]="contentType"
                [readonly]="true">
              </mj-artifact-type-plugin-viewer>
            </div>
          }

          <!-- Display Tab - Fallback content when no plugin -->
          @if (activeTab === 'display' && (!hasPlugin || !artifactVersion)) {
            <div class="display-content">
              @if (displayMarkdown || displayHtml) {
                <!-- Fallback to extracted markdown/HTML attributes -->
                <div class="display-toolbar">
                  <button class="btn-icon" title="Print" (click)="onPrintDisplayContent()">
                    <i class="fas fa-print"></i> Print
                  </button>
                  <button class="btn-icon" title="Copy Content" (click)="onCopyDisplayContent()">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                </div>
                @if (displayMarkdown) {
                  <div class="markdown-content">
                    <markdown [data]="displayMarkdown"></markdown>
                  </div>
                } @else if (displayHtml) {
                  <div class="html-content" [innerHTML]="displayHtml"></div>
                }
              }
            </div>
          }

          <!-- Details Tab - Artifact metadata (always in DOM, hidden with CSS) -->
          <div class="details-content" [style.display]="activeTab === 'details' ? 'block' : 'none'">
              <div class="artifact-meta">
                <div class="meta-item">
                  <label>Type</label>
                  <span>{{ artifact.Type }}</span>
                </div>
                <div class="meta-item">
                  <label>Version</label>
                  <span>{{ artifactVersion?.VersionNumber || 1 }}</span>
                </div>
                <div class="meta-item">
                  <label>Created</label>
                  <span>{{ artifact.__mj_CreatedAt | date:'short' }}</span>
                </div>
                <div class="meta-item">
                  <label>Updated</label>
                  <span>{{ artifactVersion?.__mj_UpdatedAt | date:'short' }}</span>
                </div>
                @if (artifact.Description) {
                  <div class="meta-item full-width">
                    <label>Artifact Description</label>
                    <span>{{ artifact.Description }}</span>
                  </div>
                }
                @if (artifactVersion?.Description && artifact.Description && artifactVersion?.Description !== artifact.Description) {
                  <div class="meta-item full-width">
                    <label>Version Description</label>
                    <span>{{ artifactVersion?.Description }}</span>
                  </div>
                }
              </div>

              <!-- Version Attributes -->
              @if (filteredAttributes.length > 0) {
                <div class="attributes-section">
                  <h4>Version Attributes</h4>
                  <div class="attributes-list">
                    @for (attr of filteredAttributes; track attr.ID) {
                      <div class="attribute-item">
                        <label>{{ attr.Name }}</label>
                        @if (attr.Value) {
                          <span>{{ attr.Value }}</span>
                        } @else {
                          <span class="attribute-empty-pill">Empty</span>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>

          <!-- Links Tab - Conversations and Collections (always in DOM, hidden with CSS) -->
          <div class="links-container" [style.display]="activeTab === 'links' ? 'block' : 'none'">
            @if (linksToShow.length > 0) {
              <div class="links-section">
                @for (link of linksToShow; track link.id) {
                  <div class="link-item"
                       [class.disabled]="!link.hasAccess"
                       [class.clickable]="link.hasAccess"
                       (click)="link.hasAccess ? onNavigateToLink(link) : null"
                       [title]="link.hasAccess ? 'Click to open' : 'No access'">
                    <div class="link-icon">
                      @if (link.type === 'conversation') {
                        <i class="fas fa-comments"></i>
                      } @else {
                        <i class="fas fa-folder"></i>
                      }
                    </div>
                    <div class="link-content">
                      <div class="link-name">{{ link.name }}</div>
                      <div class="link-type">{{ link.type === 'conversation' ? 'Conversation' : 'Collection' }}</div>
                    </div>
                    <div class="link-actions">
                      <i class="fas fa-arrow-right"></i>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-state">
                <i class="fas fa-link"></i>
                <p>No links available</p>
              </div>
            }
          </div>

          <!-- Dynamic Plugin Tabs and Base Tabs (JSON, etc.) -->
          @if (activeTab !== 'display' && activeTab !== 'details' && activeTab !== 'links') {
            @if (GetTabContent(activeTab); as tabData) {
              <div class="dynamic-tab-content">
                @switch (tabData.type) {
                  @case ('markdown') {
                    <div class="markdown-viewer" [innerHTML]="RenderMarkdown(tabData.content)"></div>
                  }
                  @case ('json') {
                    <div class="json-viewer">
                      <div class="json-toolbar">
                        <button class="btn-icon" title="Copy JSON" (click)="onCopyToClipboard()">
                          <i class="fas fa-copy"></i> Copy
                        </button>
                      </div>
                      <div class="json-editor-container">
                        <mj-code-editor
                          [value]="tabData.content"
                          [language]="'json'"
                          [readonly]="true"
                          [lineWrapping]="true"
                          style="width: 100%; height: 100%;">
                        </mj-code-editor>
                      </div>
                    </div>
                  }
                  @case ('code') {
                    <div class="code-viewer">
                      <div class="code-toolbar">
                        <button class="btn-icon" title="Copy Code" (click)="onCopyToClipboard()">
                          <i class="fas fa-copy"></i> Copy
                        </button>
                      </div>
                      <div class="code-editor-container">
                        <mj-code-editor
                          [value]="tabData.content"
                          [language]="tabData.language || 'typescript'"
                          [readonly]="true"
                          [lineWrapping]="true"
                          style="width: 100%; height: 100%;">
                        </mj-code-editor>
                      </div>
                    </div>
                  }
                  @case ('html') {
                    <div class="html-viewer" [innerHTML]="tabData.content"></div>
                  }
                  @case ('plaintext') {
                    <pre class="plaintext-viewer">{{ tabData.content }}</pre>
                  }
                }
              </div>
            }
          }
        </div>
      </div>
    }
  </div>
</div>

