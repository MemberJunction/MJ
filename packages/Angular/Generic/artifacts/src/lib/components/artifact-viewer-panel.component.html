<div class="artifact-viewer-panel">
  <div class="panel-header">
    <div class="panel-header-left">
      <h3>
        <i class="fas fa-cube"></i>
        {{ displayName }}
      </h3>
      @if (displayDescription) {
        <p class="header-description">{{ displayDescription }}</p>
      }
    </div>
    <div class="panel-header-right">
      <div class="version-selector" [class.clickable]="allVersions.length > 1" (click)="toggleVersionDropdown()">
        <i class="fas fa-history"></i>
        <span class="version-label">v{{ selectedVersionNumber }}</span>
        @if (allVersions.length > 1) {
          <i class="fas fa-chevron-down dropdown-icon" [class.open]="showVersionDropdown"></i>
        }
        @if (showVersionDropdown) {
          <div class="version-dropdown" (click)="$event.stopPropagation()">
            @for (version of allVersions; track version.ID) {
              <div class="version-option"
                   [class.selected]="version.VersionNumber === selectedVersionNumber"
                   (click)="selectVersion(version); $event.stopPropagation()">
                <span class="version-number">v{{ version.VersionNumber }}</span>
                <span class="version-date">{{ version.__mj_CreatedAt | date:'short' }}</span>
                @if (version.VersionNumber === selectedVersionNumber) {
                  <i class="fas fa-check"></i>
                }
              </div>
            }
          </div>
        }
      </div>
      @if (showSaveToCollection) {
        <button class="save-to-collection-btn"
                [class.in-collection]="isInCollection"
                (click)="onSaveToLibrary()"
                [title]="isInCollection ? 'View in Collection' : 'Save to Collection'">
          <i [ngClass]="isInCollection ? 'fas fa-bookmark' : 'far fa-bookmark'"></i>
        </button>
      }
      <button class="close-btn" (click)="onClose()" title="Close">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="panel-content">
    @if (isLoading) {
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading artifact...</span>
      </div>
    }

    @if (error) {
      <div class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ error }}</span>
      </div>
    }

    @if (!isLoading && !error && artifact) {
      <div class="artifact-content-wrapper">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
          @if (hasDisplayTab) {
            <button class="tab-btn" [class.active]="activeTab === 'display'" (click)="setActiveTab('display')">
              <i class="fas fa-eye"></i> Display
            </button>
          }
          @if (hasJsonTab) {
            <button class="tab-btn" [class.active]="activeTab === 'json'" (click)="setActiveTab('json')">
              <i class="fas fa-code"></i> JSON
            </button>
          }
          <button class="tab-btn" [class.active]="activeTab === 'details'" (click)="setActiveTab('details')">
            <i class="fas fa-info-circle"></i> Details
          </button>
          @if (hasLinksTab) {
            <button class="tab-btn" [class.active]="activeTab === 'links'" (click)="setActiveTab('links')">
              <i class="fas fa-link"></i> Links
            </button>
          }
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Display Tab (uses plugin system OR extracted attributes) -->
          @if (activeTab === 'display' && hasDisplayTab) {
            <div class="display-content">
              @if (hasPlugin && artifactVersion && artifactTypeName) {
                <!-- Use plugin viewer if available -->
                <mj-artifact-type-plugin-viewer
                  [artifactVersion]="artifactVersion"
                  [artifactTypeName]="artifactTypeName"
                  [contentType]="contentType"
                  [readonly]="true">
                </mj-artifact-type-plugin-viewer>
              } @else if (displayMarkdown || displayHtml) {
                <!-- Fallback to extracted markdown/HTML attributes -->
                <div class="display-toolbar">
                  <button class="btn-icon" title="Copy Content" (click)="onCopyDisplayContent()">
                    <i class="fas fa-copy"></i> Copy
                  </button>
                </div>
                @if (displayMarkdown) {
                  <div class="markdown-content">
                    <markdown [data]="displayMarkdown"></markdown>
                  </div>
                } @else if (displayHtml) {
                  <div class="html-content" [innerHTML]="displayHtml"></div>
                }
              }
            </div>
          }

          <!-- JSON Tab (only shown for elevated displays with JSON content) -->
          @if (activeTab === 'json' && hasJsonTab) {
            <div class="json-viewer">
              <div class="json-toolbar">
                <button class="btn-icon" title="Copy JSON" (click)="onCopyToClipboard()">
                  <i class="fas fa-copy"></i> Copy
                </button>
              </div>
              <div class="json-editor-container">
                <mj-code-editor
                  [(ngModel)]="jsonContent"
                  [language]="'json'"
                  [readonly]="true"
                  style="width: 100%; height: 100%;">
                </mj-code-editor>
              </div>
            </div>
          }

          <!-- Details Tab -->
          @if (activeTab === 'details') {
            <div class="details-content">
              <div class="artifact-meta">
                <div class="meta-item">
                  <label>Type</label>
                  <span>{{ artifact.Type }}</span>
                </div>
                <div class="meta-item">
                  <label>Version</label>
                  <span>{{ artifactVersion?.VersionNumber || 1 }}</span>
                </div>
                <div class="meta-item">
                  <label>Created</label>
                  <span>{{ artifact.__mj_CreatedAt | date:'short' }}</span>
                </div>
                <div class="meta-item">
                  <label>Updated</label>
                  <span>{{ artifactVersion?.__mj_UpdatedAt | date:'short' }}</span>
                </div>
                @if (artifact.Description) {
                  <div class="meta-item full-width">
                    <label>Artifact Description</label>
                    <span>{{ artifact.Description }}</span>
                  </div>
                }
                @if (artifactVersion?.Description && artifact.Description && artifactVersion?.Description !== artifact.Description) {
                  <div class="meta-item full-width">
                    <label>Version Description</label>
                    <span>{{ artifactVersion?.Description }}</span>
                  </div>
                }
              </div>

              <!-- Version Attributes -->
              @if (filteredAttributes.length > 0) {
                <div class="attributes-section">
                  <h4>Version Attributes</h4>
                  <div class="attributes-list">
                    @for (attr of filteredAttributes; track attr.ID) {
                      <div class="attribute-item">
                        <label>{{ attr.Name }}</label>
                        @if (attr.Value) {
                          <span>{{ attr.Value }}</span>
                        } @else {
                          <span class="attribute-empty-pill">Empty</span>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Links Tab -->
          @if (activeTab === 'links') {
            <div class="links-container">
              @if (linksToShow.length > 0) {
                <div class="links-section">
                  @for (link of linksToShow; track link.id) {
                    <div class="link-item">
                      <div class="link-icon">
                        @if (link.type === 'conversation') {
                          <i class="fas fa-comments"></i>
                        } @else {
                          <i class="fas fa-folder"></i>
                        }
                      </div>
                      <div class="link-content">
                        <div class="link-name">{{ link.name }}</div>
                        <div class="link-type">{{ link.type === 'conversation' ? 'Conversation' : 'Collection' }}</div>
                      </div>
                      <div class="link-actions">
                        <button
                          class="link-action-btn"
                          [disabled]="!link.hasAccess"
                          [title]="link.hasAccess ? 'Open' : 'No access'"
                          (click)="onNavigateToLink(link)">
                          <i class="fas fa-arrow-right"></i>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="empty-state">
                  <i class="fas fa-link"></i>
                  <p>No links available</p>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>

