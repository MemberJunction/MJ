<div class="entity-viewer-container" [style.height]="effectiveConfig.height">
  <!-- Header -->
  @if (effectiveConfig.showFilter || effectiveConfig.showViewModeToggle || effectiveConfig.showRecordCount) {
    <div class="viewer-header">
      <!-- Filter Input -->
      @if (effectiveConfig.showFilter) {
        <div class="filter-container">
          <i class="fa-solid fa-search filter-icon"></i>
          <input
            type="text"
            class="filter-input"
            [placeholder]="effectiveConfig.filterPlaceholder"
            [value]="effectiveFilterText"
            (input)="onFilterChange($any($event.target).value)"
          />
          @if (effectiveFilterText) {
            <button class="clear-filter-btn" (click)="clearFilter()" title="Clear filter">
              <i class="fa-solid fa-times"></i>
            </button>
          }
        </div>
      }

      <!-- Record Count -->
      @if (effectiveConfig.showRecordCount && entity) {
        <div class="record-count">
          @if (filteredRecordCount !== totalRecordCount) {
            <span>{{ filteredRecordCount | number }} of {{ totalRecordCount | number }} records</span>
          } @else {
            <span>{{ totalRecordCount | number }} records</span>
          }
        </div>
      }

      <!-- View Mode Toggle -->
      @if (effectiveConfig.showViewModeToggle) {
        <div class="view-mode-toggle">
          <button
            class="toggle-btn"
            [class.active]="effectiveViewMode === 'grid'"
            (click)="setViewMode('grid')"
            title="Grid View">
            <i class="fa-solid fa-list"></i>
          </button>
          <button
            class="toggle-btn"
            [class.active]="effectiveViewMode === 'cards'"
            (click)="setViewMode('cards')"
            title="Cards View">
            <i class="fa-solid fa-grip"></i>
          </button>
          @if (hasDateFields) {
            <button
              class="toggle-btn"
              [class.active]="effectiveViewMode === 'timeline'"
              (click)="setViewMode('timeline')"
              title="Timeline View">
              <i class="fa-solid fa-timeline"></i>
            </button>
          }
        </div>
      }

      <!-- Timeline Controls (only shown when timeline is active) -->
      @if (effectiveViewMode === 'timeline' && hasDateFields) {
        <!-- Date Field Selector -->
        <div class="timeline-date-selector">
          <i class="fa-solid fa-calendar-days"></i>
          @if (availableDateFields.length === 1) {
            <span class="date-field-label">{{ selectedDateFieldDisplayName }}</span>
          } @else {
            <select
              class="date-field-select"
              [value]="selectedTimelineDateField"
              (change)="setTimelineDateField($any($event.target).value)">
              @for (field of availableDateFields; track field.Name) {
                <option [value]="field.Name">{{ field.DisplayNameOrName }}</option>
              }
            </select>
          }
        </div>

        <!-- Orientation Toggle -->
        <div class="timeline-orientation-toggle">
          <button
            class="toggle-btn"
            (click)="toggleTimelineOrientation()"
            [title]="timelineOrientation === 'vertical' ? 'Switch to Horizontal' : 'Switch to Vertical'">
            <i [class]="timelineOrientation === 'vertical' ? 'fa-solid fa-ellipsis-vertical' : 'fa-solid fa-ellipsis'"></i>
          </button>
        </div>

        <!-- Sort Order Toggle -->
        <div class="timeline-sort-toggle">
          <button
            class="toggle-btn"
            (click)="toggleTimelineSortOrder()"
            [title]="timelineSortOrder === 'desc' ? 'Showing Newest First (click for Oldest First)' : 'Showing Oldest First (click for Newest First)'">
            <i [class]="timelineSortOrder === 'desc' ? 'fa-solid fa-arrow-down-wide-short' : 'fa-solid fa-arrow-up-wide-short'"></i>
          </button>
        </div>
      }
    </div>
  }

  <!-- Content -->
  <div class="viewer-content">
    @if (isLoading && filteredRecords.length === 0) {
      <!-- Initial loading state -->
      <div class="loading-container">
        <mj-loading [text]="loadingMessage" size="medium"></mj-loading>
      </div>
    } @else if (!entity) {
      <div class="empty-state">
        <i class="fa-solid fa-database"></i>
        <p>Select an entity to view records</p>
      </div>
    } @else if (filteredRecords.length === 0 && !isLoading) {
      <div class="empty-state">
        <i class="fa-solid fa-inbox"></i>
        <p>{{ debouncedFilterText ? 'No matching records' : 'No records found' }}</p>
      </div>
    } @else {
      <!-- Grid View - always rendered but hidden when not active to preserve state -->
      <mj-entity-data-grid
        [hidden]="effectiveViewMode !== 'grid'"
        [data]="filteredRecords"
        [Params]="{ EntityName: entity.Name, ViewEntity: viewEntity || undefined, OrderBy: effectiveSortOrderBy }"
        [filterText]="debouncedFilterText"
        [gridState]="gridState"
        [height]="'auto'"
        [showToolbar]="showGridToolbar"
        [toolbarConfig]="effectiveGridToolbarConfig"
        [selectionMode]="gridSelectionMode"
        [AllowLoad]="false"
        (afterRowClick)="onDataGridRowClick($event)"
        (afterRowDoubleClick)="onDataGridRowDoubleClick($event)"
        (afterSort)="onDataGridSortChanged($event)"
        (gridStateChanged)="onGridStateChanged($event)"
        (newButtonClick)="onGridAddRequested()"
        (refreshButtonClick)="onGridRefreshRequested()"
        (deleteButtonClick)="onGridDeleteRequested($event)"
        (exportButtonClick)="onGridExportRequested()">
      </mj-entity-data-grid>

      <!-- Cards View - always rendered but hidden when not active to preserve state -->
      <mj-entity-cards
        [hidden]="effectiveViewMode !== 'cards'"
        [entity]="entity"
        [records]="filteredRecords"
        [selectedRecordId]="selectedRecordId"
        [cardTemplate]="cardTemplate"
        [hiddenFieldMatches]="hiddenFieldMatches"
        [filterText]="debouncedFilterText"
        (recordSelected)="onRecordSelected($event)"
        (recordOpened)="onRecordOpened($event)">
      </mj-entity-cards>

      <!-- Timeline View - only created when timeline mode is active -->
      @if (hasDateFields && effectiveViewMode === 'timeline') {
        <mj-timeline
          [groups]="timelineGroups"
          [orientation]="timelineOrientation"
          [layout]="timelineOrientation === 'vertical' ? 'alternating' : 'single'"
          [sortOrder]="timelineSortOrder"
          [segmentGrouping]="timelineSegmentGrouping"
          [segmentsCollapsible]="true"
          [segmentsDefaultExpanded]="true"
          [selectedEventId]="timelineSelectedEventId"
          (afterEventClick)="onTimelineEventClick($event)">
        </mj-timeline>
      }
    }
  </div>

  <!-- Pagination - only show when there's more data to load OR we've loaded more than one page -->
  @if (effectiveConfig.showPagination && entity && (pagination.hasMore || pagination.totalRecords > effectiveConfig.pageSize)) {
    <mj-pagination
      [pagination]="pagination"
      [loadedRecordCount]="filteredRecords.length"
      (loadMore)="onLoadMore()">
    </mj-pagination>
  }
</div>
