<div class="cap-container">
    <!-- Loading State -->
    @if (IsLoading) {
        <div class="cap-loading" @fadeIn>
            <div class="cap-spinner"></div>
            <span>Loading...</span>
        </div>
    } @else {
        <!-- Error State -->
        @if (ErrorMessage) {
            <div class="cap-error" @slideDown>
                <i class="fa-solid fa-exclamation-triangle"></i>
                <span>{{ ErrorMessage }}</span>
                <button class="cap-error-dismiss" (click)="ErrorMessage = null">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        }

        <!-- Parent Agent Info -->
        @if (IsSubAgent && Config.ParentAgentName) {
            <div class="cap-parent-info" @slideDown>
                <i class="fa-solid fa-link"></i>
                <span>Sub-agent of: <strong>{{ Config.ParentAgentName }}</strong></span>
            </div>
        }

        <!-- Form -->
        <form [formGroup]="Form" (ngSubmit)="OnSubmit()" class="cap-form">
            <!-- Basic Information Section -->
            <section class="cap-section">
                <h3 class="cap-section-title">
                    <i class="fa-solid fa-info-circle"></i>
                    Basic Information
                </h3>

                <div class="cap-field">
                    <label class="cap-label cap-required">Name</label>
                    <input
                        type="text"
                        formControlName="name"
                        class="cap-input"
                        placeholder="Enter agent name..."
                        [class.cap-input-error]="Form.get('name')?.invalid && Form.get('name')?.touched"
                    />
                    @if (Form.get('name')?.invalid && Form.get('name')?.touched) {
                        <div class="cap-field-error">
                            <i class="fa-solid fa-exclamation-circle"></i>
                            Agent name is required
                        </div>
                    }
                </div>

                <div class="cap-field">
                    <label class="cap-label">Description</label>
                    <textarea
                        formControlName="description"
                        class="cap-textarea"
                        rows="2"
                        placeholder="Describe what this agent does..."
                    ></textarea>
                </div>

                <div class="cap-row">
                    <div class="cap-field">
                        <label class="cap-label cap-required">Type</label>
                        <select
                            formControlName="typeId"
                            class="cap-select"
                            [class.cap-input-error]="Form.get('typeId')?.invalid && Form.get('typeId')?.touched"
                        >
                            <option value="">Select agent type...</option>
                            @for (type of AgentTypes; track type.ID) {
                                <option [value]="type.ID">{{ type.Name }}</option>
                            }
                        </select>
                        @if (Form.get('typeId')?.invalid && Form.get('typeId')?.touched) {
                            <div class="cap-field-error">
                                <i class="fa-solid fa-exclamation-circle"></i>
                                Agent type is required
                            </div>
                        }
                    </div>

                    <div class="cap-field">
                        <label class="cap-label">Status</label>
                        <select formControlName="status" class="cap-select">
                            <option value="Pending">Pending</option>
                            <option value="Active">Active</option>
                            <option value="Disabled">Disabled</option>
                        </select>
                    </div>
                </div>

                <div class="cap-row">
                    <div class="cap-field">
                        <label class="cap-label">Execution Mode</label>
                        <select formControlName="executionMode" class="cap-select">
                            <option value="Sequential">Sequential</option>
                            <option value="Parallel">Parallel</option>
                        </select>
                    </div>

                    <div class="cap-field">
                        <label class="cap-label">Model Selection Mode</label>
                        <select formControlName="modelSelectionMode" class="cap-select">
                            <option value="Agent Type">Agent Type</option>
                            <option value="Agent">Agent</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Purpose & Messages Section -->
            <section class="cap-section">
                <h3 class="cap-section-title">
                    <i class="fa-solid fa-bullseye"></i>
                    Purpose & Messages
                </h3>

                <div class="cap-field">
                    <label class="cap-label">Purpose</label>
                    <input
                        type="text"
                        formControlName="purpose"
                        class="cap-input"
                        placeholder="Enter the purpose of this agent..."
                    />
                </div>

                <div class="cap-field">
                    <label class="cap-label">User Message</label>
                    <textarea
                        formControlName="userMessage"
                        class="cap-textarea"
                        rows="3"
                        placeholder="Enter user message template..."
                    ></textarea>
                </div>
            </section>

            <!-- Advanced Configuration Toggle -->
            <button
                type="button"
                class="cap-advanced-toggle"
                (click)="ToggleAdvancedConfig()"
            >
                <i class="fa-solid" [class.fa-chevron-down]="!ShowAdvancedConfig" [class.fa-chevron-up]="ShowAdvancedConfig"></i>
                {{ ShowAdvancedConfig ? 'Hide' : 'Show' }} Advanced Configuration
            </button>

            <!-- Advanced Configuration Section -->
            @if (ShowAdvancedConfig) {
                <section class="cap-section cap-section-advanced" @slideDown>
                    <h3 class="cap-section-title">
                        <i class="fa-solid fa-cogs"></i>
                        Model Configuration
                    </h3>

                    <div class="cap-row">
                        <div class="cap-field">
                            <label class="cap-label">Temperature</label>
                            <input
                                type="number"
                                formControlName="temperature"
                                class="cap-input"
                                min="0"
                                max="2"
                                step="0.1"
                            />
                            <div class="cap-field-hint">Controls randomness (0-2)</div>
                        </div>

                        <div class="cap-field">
                            <label class="cap-label">Top P</label>
                            <input
                                type="number"
                                formControlName="topP"
                                class="cap-input"
                                min="0"
                                max="1"
                                step="0.1"
                            />
                            <div class="cap-field-hint">Nucleus sampling (0-1)</div>
                        </div>
                    </div>

                    <div class="cap-row">
                        <div class="cap-field">
                            <label class="cap-label">Top K</label>
                            <input
                                type="number"
                                formControlName="topK"
                                class="cap-input"
                                min="1"
                                max="100"
                            />
                            <div class="cap-field-hint">Token sampling limit</div>
                        </div>

                        <div class="cap-field">
                            <label class="cap-label">Max Tokens</label>
                            <input
                                type="number"
                                formControlName="maxTokens"
                                class="cap-input"
                                min="1"
                                max="32000"
                                step="100"
                            />
                            <div class="cap-field-hint">Maximum response length</div>
                        </div>
                    </div>

                    <div class="cap-row">
                        <div class="cap-field cap-field-checkbox">
                            <label class="cap-checkbox-label">
                                <input type="checkbox" formControlName="enableCaching" />
                                <span>Enable Caching</span>
                            </label>
                        </div>

                        <div class="cap-field">
                            <label class="cap-label">Cache TTL (seconds)</label>
                            <input
                                type="number"
                                formControlName="cacheTTL"
                                class="cap-input"
                                min="60"
                                max="86400"
                                step="60"
                            />
                        </div>
                    </div>
                </section>
            }

            <!-- Prompts Section -->
            <section class="cap-section">
                <div class="cap-section-header">
                    <h3 class="cap-section-title">
                        <i class="fa-solid fa-comments"></i>
                        Prompts
                        <span class="cap-badge">{{ LinkedPromptCount }}</span>
                    </h3>
                    <button
                        type="button"
                        class="cap-btn cap-btn-small"
                        (click)="OnOpenPromptSelector()"
                    >
                        <i class="fa-solid fa-plus"></i>
                        Add Prompt
                    </button>
                </div>

                @if (LinkedPrompts.length > 0) {
                    <div class="cap-linked-items">
                        @for (prompt of LinkedPrompts; track prompt.ID) {
                            <div class="cap-linked-item" @slideDown>
                                <div class="cap-item-icon">
                                    <i class="fa-solid fa-comments"></i>
                                </div>
                                <div class="cap-item-info">
                                    <span class="cap-item-name">{{ prompt.Name }}</span>
                                    @if (prompt.Description) {
                                        <span class="cap-item-description">{{ prompt.Description }}</span>
                                    }
                                </div>
                                <button
                                    type="button"
                                    class="cap-item-remove"
                                    (click)="RemovePrompt(prompt)"
                                    title="Remove prompt"
                                >
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        }
                    </div>
                } @else {
                    <div class="cap-empty-state">
                        <i class="fa-solid fa-comments"></i>
                        <p>No prompts added yet</p>
                    </div>
                }

                <!-- Prompt Selector Dropdown -->
                @if (ShowPromptSelector) {
                    <div class="cap-selector" @slideDown>
                        <div class="cap-selector-header">
                            <input
                                type="text"
                                class="cap-selector-search"
                                placeholder="Search prompts..."
                                [(ngModel)]="PromptSearchQuery"
                                [ngModelOptions]="{standalone: true}"
                                (ngModelChange)="OnPromptSearchChanged()"
                            />
                            <button
                                type="button"
                                class="cap-selector-close"
                                (click)="OnClosePromptSelector()"
                            >
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="cap-selector-list">
                            @if (FilteredPrompts.length > 0) {
                                @for (prompt of FilteredPrompts; track prompt.ID) {
                                    <div
                                        class="cap-selector-item"
                                        (click)="OnSelectPrompt(prompt)"
                                    >
                                        <i class="fa-solid fa-comments"></i>
                                        <div class="cap-selector-item-info">
                                            <span class="cap-selector-item-name">{{ prompt.Name }}</span>
                                            @if (prompt.Description) {
                                                <span class="cap-selector-item-desc">{{ prompt.Description }}</span>
                                            }
                                        </div>
                                    </div>
                                }
                            } @else {
                                <div class="cap-selector-empty">
                                    <i class="fa-solid fa-search"></i>
                                    <span>No prompts found</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </section>

            <!-- Actions Section -->
            <section class="cap-section">
                <div class="cap-section-header">
                    <h3 class="cap-section-title">
                        <i class="fa-solid fa-bolt"></i>
                        Actions
                        <span class="cap-badge">{{ LinkedActionCount }}</span>
                    </h3>
                    <button
                        type="button"
                        class="cap-btn cap-btn-small"
                        (click)="OnOpenActionSelector()"
                    >
                        <i class="fa-solid fa-plus"></i>
                        Add Action
                    </button>
                </div>

                @if (LinkedActions.length > 0) {
                    <div class="cap-linked-items">
                        @for (action of LinkedActions; track action.ID) {
                            <div class="cap-linked-item" @slideDown>
                                <div class="cap-item-icon cap-icon-action">
                                    <i class="fa-solid fa-bolt"></i>
                                </div>
                                <div class="cap-item-info">
                                    <span class="cap-item-name">{{ action.Name }}</span>
                                    @if (action.Description) {
                                        <span class="cap-item-description">{{ action.Description }}</span>
                                    }
                                </div>
                                <button
                                    type="button"
                                    class="cap-item-remove"
                                    (click)="RemoveAction(action)"
                                    title="Remove action"
                                >
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        }
                    </div>
                } @else {
                    <div class="cap-empty-state">
                        <i class="fa-solid fa-bolt"></i>
                        <p>No actions added yet</p>
                    </div>
                }

                <!-- Action Selector Dropdown -->
                @if (ShowActionSelector) {
                    <div class="cap-selector" @slideDown>
                        <div class="cap-selector-header">
                            <input
                                type="text"
                                class="cap-selector-search"
                                placeholder="Search actions..."
                                [(ngModel)]="ActionSearchQuery"
                                [ngModelOptions]="{standalone: true}"
                                (ngModelChange)="OnActionSearchChanged()"
                            />
                            <button
                                type="button"
                                class="cap-selector-close"
                                (click)="OnCloseActionSelector()"
                            >
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="cap-selector-list">
                            @if (FilteredActions.length > 0) {
                                @for (action of FilteredActions; track action.ID) {
                                    <div
                                        class="cap-selector-item"
                                        (click)="OnSelectAction(action)"
                                    >
                                        <i class="fa-solid fa-bolt"></i>
                                        <div class="cap-selector-item-info">
                                            <span class="cap-selector-item-name">{{ action.Name }}</span>
                                            @if (action.Description) {
                                                <span class="cap-selector-item-desc">{{ action.Description }}</span>
                                            }
                                        </div>
                                    </div>
                                }
                            } @else {
                                <div class="cap-selector-empty">
                                    <i class="fa-solid fa-search"></i>
                                    <span>No actions found</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </section>

            <!-- Form Actions -->
            <div class="cap-actions">
                <button
                    type="submit"
                    class="cap-btn cap-btn-primary"
                    [disabled]="Form.invalid || IsSubmitting"
                >
                    @if (IsSubmitting) {
                        <span class="cap-btn-spinner"></span>
                        <span>Creating...</span>
                    } @else {
                        <i class="fa-solid fa-plus-circle"></i>
                        <span>Create {{ IsSubAgent ? 'Sub-Agent' : 'Agent' }}</span>
                    }
                </button>
                <button
                    type="button"
                    class="cap-btn cap-btn-secondary"
                    (click)="OnCancel()"
                    [disabled]="IsSubmitting"
                >
                    Cancel
                </button>
            </div>
        </form>
    }
</div>
