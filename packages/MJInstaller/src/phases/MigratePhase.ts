/**
 * Phase D — Database Migrations
 *
 * Runs database migrations via `npx mj migrate --verbose`, which invokes
 * node-flyway under the hood to apply pending SQL migration scripts from
 * the `migrations/` directory.
 *
 * The migration command reads database connection settings from the `.env`
 * file generated by the configure phase. It applies all pending migrations
 * in version order, creating the `__mj` schema tables, stored procedures,
 * views, and seed data that MemberJunction requires.
 *
 * @module phases/MigratePhase
 * @see ConfigurePhase — generates the `.env` file with database credentials.
 * @see DatabaseProvisionPhase — creates the database and SQL logins used by migrations.
 */

import type { InstallerEventEmitter } from '../events/InstallerEvents.js';
import type { PartialInstallConfig } from '../models/InstallConfig.js';
import { InstallerError } from '../errors/InstallerError.js';
import { ProcessRunner } from '../adapters/ProcessRunner.js';

/**
 * Input context for the migrate phase.
 *
 * @see MigratePhase.Run
 */
export interface MigrateContext {
  /** Absolute path to the repo root (where `npx mj migrate` is executed). */
  Dir: string;
  /** Current install config (used for diagnostic context, not directly by migrations). */
  Config: PartialInstallConfig;
  /** Event emitter for progress and log events. */
  Emitter: InstallerEventEmitter;
}

/**
 * Result of the migrate phase.
 *
 * @see MigratePhase.Run
 */
export interface MigrateResult {
  /** Whether all migrations completed successfully. */
  Success: boolean;
  /** Raw stdout output from the `npx mj migrate` command. */
  Output: string;
}

/**
 * Phase D — Runs database migrations via `npx mj migrate`.
 *
 * @example
 * ```typescript
 * const migrate = new MigratePhase();
 * const result = await migrate.Run({
 *   Dir: '/path/to/install',
 *   Config: { DatabaseHost: 'localhost' },
 *   Emitter: emitter,
 * });
 * console.log(result.Success ? 'Migrations applied' : 'Migration failed');
 * ```
 */
export class MigratePhase {
  private processRunner = new ProcessRunner();

  /**
   * Execute database migrations.
   *
   * @param context - Migrate input with directory, config, and emitter.
   * @returns Migration result with success status and raw output.
   * @throws {InstallerError} With code `MIGRATE_TIMEOUT` if migrations exceed 5 minutes.
   * @throws {InstallerError} With code `MIGRATE_FAILED` if the migration command exits non-zero.
   */
  async Run(context: MigrateContext): Promise<MigrateResult> {
    const { Emitter: emitter } = context;

    emitter.Emit('step:progress', {
      Type: 'step:progress',
      Phase: 'migrate',
      Message: 'Running database migrations...',
    });

    // Use npx mj migrate to run Flyway-based migrations
    // Always pass --verbose so we get detailed Flyway output for diagnostics
    const result = await this.processRunner.Run('npx', ['mj', 'migrate', '--verbose'], {
      Cwd: context.Dir,
      TimeoutMs: 300_000, // 5 minutes
      OnStdout: (line: string) => {
        emitter.Emit('step:progress', {
          Type: 'step:progress',
          Phase: 'migrate',
          Message: line.trim(),
        });
      },
      OnStderr: (line: string) => {
        emitter.Emit('log', {
          Type: 'log',
          Level: 'verbose',
          Message: `[migrate:stderr] ${line.trim()}`,
        });
      },
    });

    if (result.TimedOut) {
      throw new InstallerError(
        'migrate',
        'MIGRATE_TIMEOUT',
        'Database migration timed out after 5 minutes.',
        'Run "mj migrate" manually to see detailed output. Check database connectivity.'
      );
    }

    if (result.ExitCode !== 0) {
      // Combine stdout and stderr for full diagnostic output — Flyway errors go to stderr
      const combined = [result.Stdout, result.Stderr].filter(Boolean).join('\n');
      const lastLines = this.lastNLines(combined, 80);
      throw new InstallerError(
        'migrate',
        'MIGRATE_FAILED',
        `Database migration failed (exit code ${result.ExitCode}):\n${lastLines}`,
        'Check the migration output above. Common issues: database connectivity, incorrect credentials, or SQL syntax errors.'
      );
    }

    emitter.Emit('log', {
      Type: 'log',
      Level: 'info',
      Message: 'Database migrations completed successfully.',
    });

    return {
      Success: true,
      Output: result.Stdout,
    };
  }

  private lastNLines(text: string, n: number): string {
    const lines = text.split('\n');
    return lines.slice(-n).join('\n');
  }
}
