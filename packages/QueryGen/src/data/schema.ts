/**
 * Type definitions for QueryGen package
 */

import { EntityInfo } from '@memberjunction/core';

/**
 * Represents a group of related entities for query generation
 */
export interface EntityGroup {
  entities: EntityInfo[];
  relationships: RelationshipInfo[];
  primaryEntity: EntityInfo;
  relationshipType: 'single' | 'parent-child' | 'many-to-many';
}

/**
 * Represents a relationship between two entities
 */
export interface RelationshipInfo {
  from: string;
  to: string;
  via: string;
  type: 'one-to-many' | 'many-to-one' | 'many-to-many';
}

/**
 * Entity metadata formatted for AI prompts
 */
export interface EntityMetadataForPrompt {
  entityName: string;
  description: string;
  schemaName: string;
  baseTable: string;
  baseView: string;
  fields: EntityFieldMetadata[];
  relationships: EntityRelationshipMetadata[];
}

/**
 * Entity field metadata for prompts
 */
export interface EntityFieldMetadata {
  name: string;
  displayName: string;
  type: string;
  description: string;
  isPrimaryKey: boolean;
  isForeignKey: boolean;
  relatedEntity?: string;
  isRequired: boolean;
  defaultValue?: string;
}

/**
 * Entity relationship metadata for prompts
 */
export interface EntityRelationshipMetadata {
  type: 'one-to-many' | 'many-to-one' | 'many-to-many';
  relatedEntity: string;
  relatedEntityView: string;
  relatedEntitySchema: string;
  foreignKeyField: string;
  description: string;
}

/**
 * Business question generated by AI
 */
export interface BusinessQuestion {
  userQuestion: string;
  description: string;
  technicalDescription: string;
  complexity: 'simple' | 'medium' | 'complex';
  requiresAggregation: boolean;
  requiresJoins: boolean;
  entities: string[];
}

/**
 * SQL query generated by AI
 */
export interface GeneratedQuery {
  sql: string;
  selectClause: QueryOutputField[];
  parameters: QueryParameter[];
}

/**
 * Query output field definition
 */
export interface QueryOutputField {
  name: string;
  description: string;
  type: string;
  optional: boolean;
}

/**
 * Query parameter definition
 */
export interface QueryParameter {
  name: string;
  type: string;
  isRequired: boolean;
  description: string;
  usage: string[];
  defaultValue: string | null;
  sampleValue: string;
}

/**
 * Golden query for few-shot learning
 */
export interface GoldenQuery {
  name: string;
  userQuestion: string;
  description: string;
  technicalDescription: string;
  sql: string;
  parameters: QueryParameter[];
  selectClause: QueryOutputField[];
}

/**
 * Similarity search result
 */
export interface SimilarQuery {
  query: GoldenQuery;
  similarity: number;
  fieldScores: {
    nameSim: number;
    userQuestionSim: number;
    descSim: number;
    techDescSim: number;
  };
}

/**
 * Query test result
 */
export interface QueryTestResult {
  success: boolean;
  renderedSQL?: string;
  rowCount?: number;
  sampleRows?: unknown[];
  attempts?: number;
  error?: string;
}

/**
 * Query evaluation result
 */
export interface QueryEvaluation {
  answersQuestion: boolean;
  confidence: number;
  reasoning: string;
  suggestions: string[];
  needsRefinement: boolean;
}

/**
 * Refined query result
 */
export interface RefinedQuery {
  query: GeneratedQuery;
  testResult: QueryTestResult;
  evaluation: QueryEvaluation;
  refinementCount: number;
  reachedMaxRefinements?: boolean;
}

/**
 * Validated query ready for export
 */
export interface ValidatedQuery {
  businessQuestion: BusinessQuestion;
  query: GeneratedQuery;
  testResult: QueryTestResult;
  evaluation: QueryEvaluation;
  entityGroup: EntityGroup;
}

/**
 * Metadata export result
 */
export interface ExportResult {
  success: boolean;
  outputPath: string;
  queryCount: number;
}

/**
 * Database write result
 */
export interface WriteResult {
  success: boolean;
  results: string[];
}

/**
 * Query metadata record for MJ metadata format
 */
export interface QueryMetadataRecord {
  fields: {
    Name: string;
    CategoryID: string;
    UserQuestion: string;
    Description: string;
    TechnicalDescription: string;
    SQL: string;
    OriginalSQL: string;
    UsesTemplate: boolean;
    Status: string;
  };
  relatedEntities: {
    'Query Fields': Array<{ fields: Record<string, unknown> }>;
    'Query Params': Array<{ fields: Record<string, unknown> }>;
  };
}

/**
 * Embeddings for a query or golden query
 */
export interface QueryEmbeddings {
  name: number[];
  userQuestion: number[];
  description: number[];
  technicalDescription: number[];
}

/**
 * Golden query with embeddings
 */
export interface EmbeddedGoldenQuery {
  query: GoldenQuery;
  embeddings: QueryEmbeddings;
}
