/**
 * Client bootstrap file generator for MJ Open Apps.
 *
 * Generates the `open-app-bootstrap.generated.ts` file in MJExplorer
 * that contains static import statements for each installed app's
 * client bootstrap package. ESBuild processes these imports at build time.
 */
import { writeFileSync } from 'node:fs';
import { resolve } from 'node:path';

/**
 * Represents an installed app's client import entry.
 */
export interface ClientBootstrapEntry {
    /** App name */
    AppName: string;
    /** App version */
    Version: string;
    /** npm package name for the client bootstrap */
    PackageName: string;
    /** Whether the app is currently enabled */
    Enabled: boolean;
}

/**
 * Regenerates the open-app-bootstrap.generated.ts file with import
 * lines for all installed apps.
 *
 * Disabled apps have their imports commented out.
 * Apps are listed in the order provided (should be dependency order).
 *
 * @param repoRoot - Absolute path to the monorepo root
 * @param entries - List of installed app client bootstrap entries
 */
export function RegenerateClientBootstrap(
    repoRoot: string,
    entries: ClientBootstrapEntry[]
): void {
    const filePath = resolve(
        repoRoot,
        'packages/MJExplorer/src/app/generated/open-app-bootstrap.generated.ts'
    );

    const content = BuildBootstrapFileContent(entries);
    writeFileSync(filePath, content, 'utf-8');
}

/**
 * Builds the full content of the bootstrap file.
 */
function BuildBootstrapFileContent(entries: ClientBootstrapEntry[]): string {
    const header = BuildFileHeader();

    if (entries.length === 0) {
        return header + '\n// No Open Apps installed\n';
    }

    const importLines = entries.map(entry => BuildImportLine(entry)).join('\n');
    return header + '\n' + importLines + '\n';
}

/**
 * Builds the auto-generated file header.
 */
function BuildFileHeader(): string {
    return `/**
 * Open App Bootstrap - AUTO-GENERATED by \`mj app install\` / \`mj app remove\`
 * DO NOT EDIT - this file is overwritten on every app install/upgrade/remove
 *
 * Each import below loads an Open App's client bootstrap package, which triggers
 * @RegisterClass decorators and makes the app's components available to MJ's class factory.
 *
 * Generated: ${new Date().toISOString()}
 */
`;
}

/**
 * Builds a single import line (or commented-out import for disabled apps).
 */
function BuildImportLine(entry: ClientBootstrapEntry): string {
    const comment = `// ${entry.AppName} (v${entry.Version})`;

    if (entry.Enabled) {
        return `${comment}\nimport '${entry.PackageName}';\n`;
    }

    return `${comment} [DISABLED]\n// import '${entry.PackageName}';\n`;
}
