{
  "name": "DealsByStageBoard",
  "title": "Deals by Stage Board",
  "description": "Kanban-style board showing deals grouped by stage with drag-and-drop support",
  "type": "component",
  "location": "embedded",
  "namespace": "CRM/Sales",
  "functionalRequirements": "## Kanban Board for Deal Pipeline\n\n### Core Features\n- Display deals grouped by stage in columns\n- Show deal cards with key information\n- Display total value per stage\n- Count of deals per stage\n- Visual indicators for deal priority\n\n### Card Information\n- Deal name\n- Account name\n- Amount formatted as currency\n- Days to close\n- Probability indicator\n\n### Visual Design\n- Column headers with stage colors\n- Card shadows and hover effects\n- Responsive column layout\n- Scrollable columns for many deals",
  "dataRequirements": {
    "mode": "views",
    "description": "Fetches all deals for kanban board display",
    "entities": [
      {
        "name": "Deals",
        "description": "CRM deals grouped by stage in kanban columns",
        "displayFields": [
          "ID",
          "DealName",
          "AccountID",
          "Account",
          "Stage",
          "Amount",
          "Probability",
          "CloseDate",
          "DealSource",
          "NextStep"
        ],
        "filterFields": [
          "Stage"
        ],
        "sortFields": [
          "Stage",
          "CloseDate",
          "Amount"
        ],
        "fieldMetadata": [],
        "permissionLevelNeeded": [
          "read"
        ],
        "usageContext": "Groups deals by stage for kanban board visualization"
      }
    ],
    "queries": []
  },
  "technicalDesign": "## Implementation\n\n### Data Loading\n- Single RunView call to load all deals\n- Client-side grouping by Stage\n- Calculate totals per stage\n\n### Layout\n- Flexbox for horizontal column layout\n- Fixed height columns with scroll\n- Responsive breakpoints for mobile\n\n### Stage Order\n1. Prospecting\n2. Qualification\n3. Proposal\n4. Negotiation\n5. Closed Won\n6. Closed Lost",
  "properties": [],
  "exampleUsage": "<DealsByStageBoard\n  showClosedDeals={false}\n  onDealClick={handleDealClick}\n/>",
  "code": "function DealsByStageBoard({ utilities, styles, components, callbacks, savedUserSettings, onSaveUserSettings }) {\n  const [deals, setDeals] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [showClosedDeals, setShowClosedDeals] = useState(savedUserSettings?.showClosedDeals || false);\n  const [dealsByStage, setDealsByStage] = useState({});\n  const [dateFrom, setDateFrom] = useState(savedUserSettings?.dateFrom || '');\n  const [dateTo, setDateTo] = useState(savedUserSettings?.dateTo || '');\n  const [selectedDeal, setSelectedDeal] = useState(null);\n\n  // Define stage order and colors\n  const stages = [\n    { name: 'Prospecting', color: '#6B7280', bgColor: '#F3F4F6' },\n    { name: 'Qualification', color: '#2563EB', bgColor: '#DBEAFE' },\n    { name: 'Proposal', color: '#D97706', bgColor: '#FEF3C7' },\n    { name: 'Negotiation', color: '#EA580C', bgColor: '#FED7AA' },\n    { name: 'Closed Won', color: '#059669', bgColor: '#D1FAE5' },\n    { name: 'Closed Lost', color: '#DC2626', bgColor: '#FEE2E2' }\n  ];\n\n  useEffect(() => {\n    loadDeals();\n  }, [dateFrom, dateTo]);\n\n  useEffect(() => {\n    groupDealsByStage();\n  }, [deals, showClosedDeals]);\n\n  const loadDeals = async () => {\n    setLoading(true);\n    setError(null);\n    \n    try {\n      // Build filter based on date range\n      let filters = [];\n      if (dateFrom) {\n        filters.push(`CloseDate >= '${dateFrom}'`);\n      }\n      if (dateTo) {\n        filters.push(`CloseDate <= '${dateTo}'`);\n      }\n      const extraFilter = filters.length > 0 ? filters.join(' AND ') : '';\n      \n      const result = await utilities.rv.RunView({\n        EntityName: 'Deals',\n        OrderBy: 'CloseDate ASC',\n        ExtraFilter: extraFilter\n      });\n\n      if (result.Success) {\n        setDeals(result.Results || []);\n      } else {\n        setError(result.ErrorMessage || 'Failed to load deals');\n      }\n    } catch (err) {\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const groupDealsByStage = () => {\n    const grouped = {};\n    stages.forEach(stage => {\n      grouped[stage.name] = [];\n    });\n\n    deals.forEach(deal => {\n      if (grouped[deal.Stage]) {\n        grouped[deal.Stage].push(deal);\n      }\n    });\n\n    setDealsByStage(grouped);\n  };\n\n  const formatCurrency = (amount) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0\n    }).format(amount || 0);\n  };\n\n  const getDaysToClose = (closeDate) => {\n    if (!closeDate) return null;\n    const close = new Date(closeDate);\n    const today = new Date();\n    const days = Math.ceil((close - today) / (1000 * 60 * 60 * 24));\n    return days;\n  };\n\n  const calculateStageTotal = (stageName) => {\n    const stageDeals = dealsByStage[stageName] || [];\n    return stageDeals.reduce((sum, deal) => sum + (deal.Amount || 0), 0);\n  };\n\n  const toggleClosedDeals = () => {\n    const newValue = !showClosedDeals;\n    setShowClosedDeals(newValue);\n    onSaveUserSettings({ ...savedUserSettings, showClosedDeals: newValue });\n  };\n\n  const handleDateChange = (field, value) => {\n    if (field === 'from') {\n      setDateFrom(value);\n      onSaveUserSettings({ ...savedUserSettings, dateFrom: value });\n    } else {\n      setDateTo(value);\n      onSaveUserSettings({ ...savedUserSettings, dateTo: value });\n    }\n  };\n\n  const clearFilters = () => {\n    setDateFrom('');\n    setDateTo('');\n    onSaveUserSettings({ ...savedUserSettings, dateFrom: '', dateTo: '' });\n  };\n\n  if (loading) {\n    return (\n      <div style={{ padding: '40px', textAlign: 'center' }}>\n        <div style={{ fontSize: '18px', color: '#6B7280' }}>Loading deals...</div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div style={{ padding: '20px', backgroundColor: '#FEE2E2', borderRadius: '8px', margin: '20px' }}>\n        <div style={{ color: '#991B1B', fontWeight: 'bold' }}>Error loading deals</div>\n        <div style={{ color: '#DC2626', marginTop: '8px' }}>{error}</div>\n      </div>\n    );\n  }\n\n  const visibleStages = showClosedDeals ? stages : stages.filter(s => !s.name.includes('Closed'));\n\n  return (\n    <div style={{ padding: '20px', height: '100%', display: 'flex', flexDirection: 'column' }}>\n      <div style={{ marginBottom: '20px' }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>\n          <h2 style={{ fontSize: '24px', fontWeight: 'bold', margin: 0 }}>Deal Pipeline</h2>\n          <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>\n            <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>\n              <input\n                type=\"checkbox\"\n                checked={showClosedDeals}\n                onChange={toggleClosedDeals}\n                style={{ marginRight: '8px' }}\n              />\n              <span style={{ fontSize: '14px' }}>Show Closed Deals</span>\n            </label>\n            <button\n              onClick={loadDeals}\n              style={{\n                padding: '8px 16px',\n                backgroundColor: '#3B82F6',\n                color: 'white',\n                border: 'none',\n                borderRadius: '6px',\n                cursor: 'pointer',\n                fontSize: '14px'\n              }}\n            >\n              Refresh\n            </button>\n          </div>\n        </div>\n        \n        <div style={{ \n          display: 'flex', \n          gap: '12px', \n          alignItems: 'center',\n          padding: '12px',\n          backgroundColor: '#F9FAFB',\n          borderRadius: '8px'\n        }}>\n          <label style={{ fontSize: '14px', color: '#374151' }}>Close Date:</label>\n          <input\n            type=\"date\"\n            value={dateFrom}\n            onChange={(e) => handleDateChange('from', e.target.value)}\n            style={{\n              padding: '6px 12px',\n              border: '1px solid #D1D5DB',\n              borderRadius: '6px',\n              fontSize: '14px'\n            }}\n            placeholder=\"From\"\n          />\n          <span style={{ color: '#6B7280' }}>to</span>\n          <input\n            type=\"date\"\n            value={dateTo}\n            onChange={(e) => handleDateChange('to', e.target.value)}\n            style={{\n              padding: '6px 12px',\n              border: '1px solid #D1D5DB',\n              borderRadius: '6px',\n              fontSize: '14px'\n            }}\n            placeholder=\"To\"\n          />\n          {(dateFrom || dateTo) && (\n            <button\n              onClick={clearFilters}\n              style={{\n                padding: '6px 12px',\n                backgroundColor: '#EF4444',\n                color: 'white',\n                border: 'none',\n                borderRadius: '6px',\n                cursor: 'pointer',\n                fontSize: '14px'\n              }}\n            >\n              Clear\n            </button>\n          )}\n        </div>\n      </div>\n\n      <div style={{ \n        display: 'flex', \n        gap: '16px', \n        overflowX: 'auto', \n        flex: 1,\n        paddingBottom: '20px'\n      }}>\n        {visibleStages.map(stage => {\n          const stageDeals = dealsByStage[stage.name] || [];\n          const stageTotal = calculateStageTotal(stage.name);\n          \n          return (\n            <div\n              key={stage.name}\n              style={{\n                minWidth: '300px',\n                maxWidth: '300px',\n                display: 'flex',\n                flexDirection: 'column',\n                backgroundColor: '#F9FAFB',\n                borderRadius: '8px',\n                overflow: 'hidden'\n              }}\n            >\n              <div style={{\n                padding: '16px',\n                backgroundColor: stage.bgColor,\n                borderBottom: `3px solid ${stage.color}`\n              }}>\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                  <h3 style={{ \n                    fontSize: '16px', \n                    fontWeight: '600', \n                    color: stage.color,\n                    margin: 0 \n                  }}>\n                    {stage.name}\n                  </h3>\n                  <span style={{\n                    backgroundColor: 'white',\n                    color: stage.color,\n                    padding: '4px 8px',\n                    borderRadius: '12px',\n                    fontSize: '12px',\n                    fontWeight: '600'\n                  }}>\n                    {stageDeals.length}\n                  </span>\n                </div>\n                <div style={{ \n                  marginTop: '8px', \n                  fontSize: '18px', \n                  fontWeight: 'bold',\n                  color: '#111827'\n                }}>\n                  {formatCurrency(stageTotal)}\n                </div>\n              </div>\n\n              <div style={{\n                flex: 1,\n                overflowY: 'auto',\n                padding: '12px'\n              }}>\n                {stageDeals.map(deal => {\n                  const daysToClose = getDaysToClose(deal.CloseDate);\n                  \n                  return (\n                    <div\n                      key={deal.ID}\n                      style={{\n                        backgroundColor: 'white',\n                        borderRadius: '6px',\n                        padding: '12px',\n                        marginBottom: '8px',\n                        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',\n                        cursor: 'pointer',\n                        transition: 'transform 0.2s, box-shadow 0.2s',\n                        border: '1px solid #E5E7EB'\n                      }}\n                      onClick={() => setSelectedDeal(deal)}\n                      onMouseEnter={(e) => {\n                        e.currentTarget.style.transform = 'translateY(-2px)';\n                        e.currentTarget.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';\n                      }}\n                      onMouseLeave={(e) => {\n                        e.currentTarget.style.transform = 'translateY(0)';\n                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';\n                      }}\n                    >\n                      <div style={{ \n                        fontSize: '14px', \n                        fontWeight: '600', \n                        color: '#111827',\n                        marginBottom: '8px',\n                        overflow: 'hidden',\n                        textOverflow: 'ellipsis',\n                        whiteSpace: 'nowrap'\n                      }}>\n                        {deal.DealName}\n                      </div>\n                      \n                      <div style={{ \n                        fontSize: '18px', \n                        fontWeight: 'bold', \n                        color: '#059669',\n                        marginBottom: '8px'\n                      }}>\n                        {formatCurrency(deal.Amount)}\n                      </div>\n\n                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '6px' }}>\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>\n                          <span style={{ fontSize: '12px', color: '#6B7280' }}>Probability:</span>\n                          <div style={{ \n                            width: '60px', \n                            height: '4px', \n                            backgroundColor: '#E5E7EB', \n                            borderRadius: '2px',\n                            position: 'relative'\n                          }}>\n                            <div style={{ \n                              width: `${deal.Probability}%`, \n                              height: '100%', \n                              backgroundColor: deal.Probability > 75 ? '#10B981' : deal.Probability > 50 ? '#F59E0B' : '#6B7280',\n                              borderRadius: '2px'\n                            }} />\n                          </div>\n                          <span style={{ fontSize: '12px', fontWeight: '600', color: '#374151' }}>\n                            {deal.Probability}%\n                          </span>\n                        </div>\n                      </div>\n\n                      {daysToClose !== null && (\n                        <div style={{\n                          fontSize: '11px',\n                          padding: '4px 6px',\n                          borderRadius: '4px',\n                          display: 'inline-block',\n                          backgroundColor: daysToClose < 0 ? '#FEE2E2' : daysToClose < 7 ? '#FEF3C7' : daysToClose < 30 ? '#DBEAFE' : '#F3F4F6',\n                          color: daysToClose < 0 ? '#991B1B' : daysToClose < 7 ? '#92400E' : daysToClose < 30 ? '#1E40AF' : '#6B7280'\n                        }}>\n                          {daysToClose < 0 ? `${Math.abs(daysToClose)} days overdue` : `${daysToClose} days to close`}\n                        </div>\n                      )}\n\n                      {deal.NextStep && (\n                        <div style={{\n                          marginTop: '8px',\n                          fontSize: '11px',\n                          color: '#6B7280',\n                          fontStyle: 'italic',\n                          overflow: 'hidden',\n                          textOverflow: 'ellipsis',\n                          whiteSpace: 'nowrap'\n                        }}>\n                          Next: {deal.NextStep}\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n                \n                {stageDeals.length === 0 && (\n                  <div style={{\n                    padding: '20px',\n                    textAlign: 'center',\n                    color: '#9CA3AF',\n                    fontSize: '14px'\n                  }}>\n                    No deals in this stage\n                  </div>\n                )}\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      <div style={{ \n        marginTop: '20px', \n        padding: '16px', \n        backgroundColor: '#F9FAFB', \n        borderRadius: '8px',\n        display: 'flex',\n        justifyContent: 'space-around'\n      }}>\n        <div style={{ textAlign: 'center' }}>\n          <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>Total Deals</div>\n          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#111827' }}>{deals.length}</div>\n        </div>\n        <div style={{ textAlign: 'center' }}>\n          <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>Pipeline Value</div>\n          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#059669' }}>\n            {formatCurrency(deals.reduce((sum, deal) => sum + (deal.Amount || 0), 0))}\n          </div>\n        </div>\n        <div style={{ textAlign: 'center' }}>\n          <div style={{ fontSize: '12px', color: '#6B7280', marginBottom: '4px' }}>Expected Revenue</div>\n          <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#2563EB' }}>\n            {formatCurrency(deals.reduce((sum, deal) => sum + ((deal.Amount || 0) * (deal.Probability || 0) / 100), 0))}\n          </div>\n        </div>\n      </div>\n\n      {/* Deal Detail Modal */}\n      {selectedDeal && (\n        <div style={{\n          position: 'fixed',\n          top: 0,\n          left: 0,\n          right: 0,\n          bottom: 0,\n          backgroundColor: 'rgba(0, 0, 0, 0.5)',\n          display: 'flex',\n          alignItems: 'center',\n          justifyContent: 'center',\n          zIndex: 1000\n        }}\n        onClick={() => setSelectedDeal(null)}\n        >\n          <div \n            style={{\n              backgroundColor: 'white',\n              borderRadius: '12px',\n              padding: '24px',\n              maxWidth: '600px',\n              width: '90%',\n              maxHeight: '80vh',\n              overflowY: 'auto',\n              boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'\n            }}\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '20px' }}>\n              <h3 style={{ fontSize: '20px', fontWeight: 'bold', margin: 0 }}>{selectedDeal.DealName}</h3>\n              <button\n                onClick={() => setSelectedDeal(null)}\n                style={{\n                  background: 'none',\n                  border: 'none',\n                  fontSize: '24px',\n                  cursor: 'pointer',\n                  color: '#6B7280',\n                  padding: '0',\n                  width: '30px',\n                  height: '30px'\n                }}\n              >\n                ×\n              </button>\n            </div>\n            \n            <div style={{ display: 'grid', gap: '16px' }}>\n              <div>\n                <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Stage</label>\n                <span style={{\n                  padding: '6px 16px',\n                  borderRadius: '12px',\n                  fontSize: '14px',\n                  fontWeight: '600',\n                  backgroundColor: stages.find(s => s.name === selectedDeal.Stage)?.bgColor || '#F3F4F6',\n                  color: stages.find(s => s.name === selectedDeal.Stage)?.color || '#6B7280',\n                  border: `2px solid ${stages.find(s => s.name === selectedDeal.Stage)?.color || '#D1D5DB'}`,\n                  display: 'inline-block'\n                }}>\n                  {selectedDeal.Stage}\n                </span>\n              </div>\n              \n              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>\n                <div>\n                  <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Amount</label>\n                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#059669' }}>\n                    {formatCurrency(selectedDeal.Amount)}\n                  </div>\n                </div>\n                \n                <div>\n                  <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Probability</label>\n                  <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#374151' }}>\n                    {selectedDeal.Probability}%\n                  </div>\n                </div>\n              </div>\n              \n              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>\n                <div>\n                  <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Close Date</label>\n                  <div style={{ fontSize: '16px', color: '#111827' }}>\n                    {new Date(selectedDeal.CloseDate).toLocaleDateString('en-US', { \n                      month: 'short', \n                      day: 'numeric', \n                      year: 'numeric' \n                    })}\n                  </div>\n                </div>\n                \n                <div>\n                  <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Days to Close</label>\n                  <div style={{ fontSize: '16px', color: '#111827' }}>\n                    {(() => {\n                      const days = getDaysToClose(selectedDeal.CloseDate);\n                      if (days === null) return '-';\n                      return days < 0 ? `${Math.abs(days)} days overdue` : `${days} days`;\n                    })()}\n                  </div>\n                </div>\n              </div>\n              \n              {selectedDeal.DealSource && (\n                <div>\n                  <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Source</label>\n                  <div style={{ fontSize: '16px', color: '#111827' }}>\n                    {selectedDeal.DealSource}\n                  </div>\n                </div>\n              )}\n              \n              {selectedDeal.NextStep && (\n                <div>\n                  <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Next Step</label>\n                  <div style={{ fontSize: '16px', color: '#111827' }}>\n                    {selectedDeal.NextStep}\n                  </div>\n                </div>\n              )}\n              \n              <div>\n                <label style={{ fontSize: '12px', color: '#6B7280', display: 'block', marginBottom: '4px' }}>Expected Revenue</label>\n                <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#2563EB' }}>\n                  {formatCurrency((selectedDeal.Amount || 0) * (selectedDeal.Probability || 0) / 100)}\n                </div>\n              </div>\n              \n              <div style={{ \n                marginTop: '16px', \n                padding: '16px', \n                backgroundColor: '#F9FAFB', \n                borderRadius: '8px' \n              }}>\n                <div style={{ fontSize: '14px', color: '#6B7280', marginBottom: '8px' }}>Win Probability Indicator</div>\n                <div style={{ \n                  width: '100%', \n                  height: '20px', \n                  backgroundColor: '#E5E7EB', \n                  borderRadius: '10px',\n                  position: 'relative'\n                }}>\n                  <div style={{ \n                    width: `${selectedDeal.Probability}%`, \n                    height: '100%', \n                    backgroundColor: selectedDeal.Probability > 75 ? '#10B981' : selectedDeal.Probability > 50 ? '#F59E0B' : '#6B7280',\n                    borderRadius: '10px',\n                    transition: 'width 0.3s'\n                  }} />\n                  <div style={{\n                    position: 'absolute',\n                    top: '50%',\n                    left: '50%',\n                    transform: 'translate(-50%, -50%)',\n                    color: 'white',\n                    fontWeight: 'bold',\n                    fontSize: '12px'\n                  }}>\n                    {selectedDeal.Probability}%\n                  </div>\n                </div>\n              </div>\n            </div>\n            \n            <div style={{ \n              marginTop: '20px', \n              paddingTop: '20px', \n              borderTop: '1px solid #E5E7EB',\n              display: 'flex',\n              justifyContent: 'flex-end'\n            }}>\n              <button\n                onClick={() => {\n                  if (callbacks.OpenEntityRecord) {\n                    callbacks.OpenEntityRecord('Deals', [\n                      { FieldName: 'ID', Value: selectedDeal.ID }\n                    ]);\n                    setSelectedDeal(null);\n                  } else {\n                    console.warn('OpenEntityRecord callback not available');\n                  }\n                }}\n                style={{\n                  padding: '8px 12px',\n                  backgroundColor: '#3B82F6',\n                  color: 'white',\n                  border: 'none',\n                  borderRadius: '6px',\n                  cursor: 'pointer',\n                  fontSize: '20px',\n                  display: 'flex',\n                  alignItems: 'center',\n                  justifyContent: 'center',\n                  width: '40px',\n                  height: '40px'\n                }}\n                title=\"Open record\"\n              >\n                ↗\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}"
}
