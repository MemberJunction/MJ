{
  "name": "FinancialAnalyticsDashboard",
  "namespace": "CRM/Finance",
  "type": "Dashboard",
  "code": "function FinancialAnalyticsDashboard({ utilities, styles, components, callbacks, savedUserSettings, onSaveUserSettings }) {\n  // Load registry components\n  const AIInsightsPanel = components?.AIInsightsPanel;\n  const DataExportPanel = components?.DataExportPanel;\n  const [invoices, setInvoices] = useState([]);\n  const [deals, setDeals] = useState([]);\n  const [products, setProducts] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [timeRange, setTimeRange] = useState(savedUserSettings?.timeRange || 'quarter');\n  const [isPanelOpen, setIsPanelOpen] = useState(false);\n  const [selectedMetric, setSelectedMetric] = useState(null);\n  const [drillDownData, setDrillDownData] = useState(null);\n  const [drillDownTitle, setDrillDownTitle] = useState('');\n  const [sortConfig, setSortConfig] = useState({ key: 'TotalAmount', direction: 'desc' });\n  const chartRefs = useRef({});\n  const dashboardRef = useRef(null);\n  const aiInsightsRef = useRef(null);\n  \n  // Debug ref initialization\n  useEffect(() => {\n    console.log('Dashboard refs after mount:', {\n      dashboardRef: dashboardRef.current,\n      aiInsightsRef: aiInsightsRef.current\n    });\n  }, []);\n  \n  // AI Insights state\n  const [aiInsights, setAiInsights] = useState(null);\n  const [loadingInsights, setLoadingInsights] = useState(false);\n  const [insightsError, setInsightsError] = useState(null);\n\n  const getDateFilter = React.useCallback(() => {\n    const now = new Date();\n    let months = 3;\n\n    switch (timeRange) {\n      case 'month': months = 1; break;\n      case 'quarter': months = 3; break;\n      case 'year': months = 12; break;\n      default: months = 3;\n    }\n\n    const startDate = new Date(now.setMonth(now.getMonth() - months));\n    return startDate.toISOString().split('T')[0];\n  }, [timeRange]);\n\n  const loadFinancialData = React.useCallback(async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const dateFilter = getDateFilter();\n\n      const [invoicesResult, dealsResult, productsResult] = await Promise.all([\n        utilities.rv.RunView({\n          EntityName: 'Invoices',\n          ExtraFilter: dateFilter ? `InvoiceDate >= '${dateFilter}'` : '',\n          OrderBy: 'InvoiceDate DESC'\n        }),\n        utilities.rv.RunView({\n          EntityName: 'Deals',\n          ExtraFilter: dateFilter ? `CloseDate >= '${dateFilter}'` : '',\n          OrderBy: 'CloseDate DESC'\n        }),\n        utilities.rv.RunView({\n          EntityName: 'Products',\n          OrderBy: 'ProductName ASC'\n        })\n      ]);\n\n      if (invoicesResult.Success) {\n        setInvoices(invoicesResult.Results || []);\n      }\n      if (dealsResult.Success) {\n        setDeals(dealsResult.Results || []);\n      }\n      if (productsResult.Success) {\n        setProducts(productsResult.Results || []);\n      }\n\n      if (!invoicesResult.Success) {\n        setError('Failed to load financial data');\n      }\n    } catch (err) {\n      setError(err.message);\n    } finally {\n      setLoading(false);\n    }\n  }, [timeRange, getDateFilter, utilities.rv]);\n\n  useEffect(() => {\n    loadFinancialData();\n  }, [timeRange]);\n\n  const metrics = React.useMemo(() => {\n    const actualRevenue = invoices\n      .filter(inv => inv.Status === 'Paid')\n      .reduce((sum, inv) => sum + (inv.TotalAmount || 0), 0);\n    \n    const projectedRevenue = deals\n      .filter(d => !['Closed Won', 'Closed Lost'].includes(d.Stage))\n      .reduce((sum, d) => sum + ((d.Amount || 0) * (d.Probability || 0) / 100), 0);\n    \n    const outstandingRevenue = invoices\n      .filter(inv => inv.Status !== 'Paid' && inv.Status !== 'Cancelled')\n      .reduce((sum, inv) => sum + (inv.TotalAmount || 0), 0);\n    \n    const avgDealSize = deals.length > 0 ? \n      deals.reduce((sum, d) => sum + (d.Amount || 0), 0) / deals.length : 0;\n    \n    const grossMargin = products.length > 0 ?\n      products.reduce((sum, p) => {\n        const margin = p.Price && p.Cost ? ((p.Price - p.Cost) / p.Price) * 100 : 0;\n        return sum + margin;\n      }, 0) / products.length : 0;\n    \n    // Calculate revenue growth (comparing to previous period)\n    const currentPeriodRevenue = actualRevenue;\n    const previousPeriodRevenue = currentPeriodRevenue * 0.85; // Simulated previous period\n    const revenueGrowth = previousPeriodRevenue > 0 ? \n      ((currentPeriodRevenue - previousPeriodRevenue) / previousPeriodRevenue) * 100 : 0;\n    \n    return {\n      actualRevenue,\n      projectedRevenue,\n      outstandingRevenue,\n      avgDealSize,\n      grossMargin,\n      totalRevenue: actualRevenue + projectedRevenue,\n      cashFlow: actualRevenue - outstandingRevenue,\n      revenueGrowth\n    };\n  }, [invoices, deals, products]);\n\n  // Format insights text using marked library for proper markdown rendering\n\n  const generateAIInsights = React.useCallback(async () => {\n    setLoadingInsights(true);\n    setInsightsError(null);\n    \n    try {\n      // trendData is already calculated via useMemo\n      \n      const prompt = `Analyze this financial analytics data and provide insights:\n\nTime Period: ${timeRange}\nTotal Revenue: ${formatCurrency(metrics.totalRevenue)}\nActual Revenue: ${formatCurrency(metrics.actualRevenue)}\nProjected Revenue: ${formatCurrency(metrics.projectedRevenue)}\nOutstanding Revenue: ${formatCurrency(metrics.outstandingRevenue)}\nGross Margin: ${metrics.grossMargin.toFixed(1)}%\nRevenue Growth: ${metrics.revenueGrowth > 0 ? '+' : ''}${metrics.revenueGrowth.toFixed(1)}%\nAverage Deal Size: ${formatCurrency(metrics.avgDealSize)}\nCash Flow: ${formatCurrency(metrics.cashFlow)}\n\nData Summary:\n- Total Invoices: ${invoices.length}\n- Total Deals: ${deals.length}\n- Total Products: ${products.length}\n\nRecent Trend Data:\n${trendData.slice(-3).map(d => `${d.month}: Invoice Revenue ${formatCurrency(d.revenue)}, Deal Revenue ${formatCurrency(d.deals)}`).join('\\n')}\n\nProvide:\n1. Key financial performance insights and trends\n2. Revenue growth analysis and projections\n3. Cash flow and outstanding revenue concerns\n4. Gross margin analysis and optimization opportunities\n5. Specific actionable recommendations for financial improvement\n6. Risk factors to monitor\n\nFocus on actionable business insights that can help improve financial performance.`;\n      \n      const result = await utilities.ai.ExecutePrompt({\n        systemPrompt: 'You are an expert financial analyst with deep knowledge of business finance, cash flow management, and revenue optimization. Provide clear, actionable insights with specific recommendations. Format your response in clear markdown.',\n        messages: prompt,\n        preferredModels: ['GPT-OSS-120B', 'Qwen3 32B'],\n        modelPower: 'high',\n        temperature: 0.7,\n        maxTokens: 1500\n      });\n      \n      if (result?.success && result?.result) {\n        setAiInsights(result.result);\n      } else {\n        setInsightsError('Failed to generate insights. Please try again.');\n      }\n    } catch (error) {\n      setInsightsError(error.message || 'Failed to generate AI insights');\n    } finally {\n      setLoadingInsights(false);\n    }\n  }, [invoices, deals, metrics, utilities.ai]);\n\n  const trendData = React.useMemo(() => {\n    const monthlyData = {};\n    \n    invoices.forEach(inv => {\n      const month = new Date(inv.InvoiceDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });\n      if (!monthlyData[month]) {\n        monthlyData[month] = { revenue: 0, invoices: 0, deals: 0 };\n      }\n      monthlyData[month].revenue += inv.TotalAmount || 0;\n      monthlyData[month].invoices++;\n    });\n    \n    deals.forEach(deal => {\n      const month = new Date(deal.CloseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short' });\n      if (!monthlyData[month]) {\n        monthlyData[month] = { revenue: 0, invoices: 0, deals: 0 };\n      }\n      monthlyData[month].deals += deal.Amount || 0;\n    });\n    \n    return Object.entries(monthlyData)\n      .sort((a, b) => new Date(a[0]) - new Date(b[0]))\n      .map(([month, data]) => ({\n        month,\n        revenue: data.revenue,\n        deals: data.deals,\n        total: data.revenue + data.deals\n      }));\n  }, [invoices, deals]);\n\n  const formatCurrency = React.useCallback((amount) => {\n    if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;\n    if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;\n    return `$${amount?.toFixed(0) || 0}`;\n  }, []);\n\n  // Sub-component: KPI Gauges\n  const KPIGauges = () => {\n    useEffect(() => {\n      if (!loading && chartRefs.current.marginGauge && chartRefs.current.utilizationGauge) {\n        const gaugeOptions = {\n          chart: {\n            type: 'radialBar',\n            height: 200\n          },\n          plotOptions: {\n            radialBar: {\n              startAngle: -90,\n              endAngle: 90,\n              hollow: {\n                margin: 15,\n                size: '70%',\n                background: '#fff'\n              },\n              dataLabels: {\n                name: {\n                  show: true,\n                  offsetY: -10\n                },\n                value: {\n                  show: true,\n                  fontSize: '20px',\n                  fontWeight: 'bold',\n                  formatter: (val) => `${val.toFixed(0)}%`\n                }\n              }\n            }\n          },\n          fill: {\n            type: 'gradient',\n            gradient: {\n              shade: 'dark',\n              shadeIntensity: 0.15,\n              stops: [0, 100]\n            }\n          },\n          stroke: {\n            dashArray: 4\n          }\n        };\n\n        const marginGauge = new ApexCharts(chartRefs.current.marginGauge, {\n          ...gaugeOptions,\n          series: [metrics.grossMargin],\n          labels: ['Gross Margin'],\n          colors: ['#10B981']\n        });\n        marginGauge.render();\n\n        const utilizationGauge = new ApexCharts(chartRefs.current.utilizationGauge, {\n          ...gaugeOptions,\n          series: [75],\n          labels: ['Utilization'],\n          colors: ['#3B82F6']\n        });\n        utilizationGauge.render();\n\n        return () => {\n          marginGauge.destroy();\n          utilizationGauge.destroy();\n        };\n      }\n    }, [loading]);\n\n    return (\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>\n        <div ref={el => chartRefs.current.marginGauge = el}></div>\n        <div ref={el => chartRefs.current.utilizationGauge = el}></div>\n      </div>\n    );\n  };\n\n  // Sub-component: Revenue Trend Chart\n  const RevenueTrendChart = () => {\n    // trendData is already calculated via useMemo\n    \n    useEffect(() => {\n      if (!loading && chartRefs.current.trendChart && trendData.length > 0) {\n        const chart = new ApexCharts(chartRefs.current.trendChart, {\n          chart: {\n            type: 'area',\n            height: 350,\n            toolbar: {\n              show: false\n            }\n          },\n          series: [\n            {\n              name: 'Invoice Revenue',\n              data: trendData.map(d => d.revenue)\n            },\n            {\n              name: 'Deal Revenue',\n              data: trendData.map(d => d.deals)\n            }\n          ],\n          xaxis: {\n            categories: trendData.map(d => d.month)\n          },\n          yaxis: {\n            labels: {\n              formatter: (val) => formatCurrency(val)\n            }\n          },\n          colors: ['#3B82F6', '#8B5CF6'],\n          fill: {\n            type: 'gradient',\n            gradient: {\n              shadeIntensity: 1,\n              opacityFrom: 0.7,\n              opacityTo: 0.2\n            }\n          },\n          dataLabels: {\n            enabled: false\n          },\n          stroke: {\n            curve: 'smooth',\n            width: 2\n          },\n          tooltip: {\n            y: {\n              formatter: (val) => formatCurrency(val)\n            }\n          }\n        });\n        chart.render();\n\n        return () => chart.destroy();\n      }\n    }, [loading, trendData]);\n\n    return <div ref={el => chartRefs.current.trendChart = el}></div>;\n  };\n\n  // Sub-component: Cash Flow Chart\n  const CashFlowChart = () => {\n    useEffect(() => {\n      if (!loading && chartRefs.current.cashFlowChart) {\n        const categories = ['Revenue', 'Expenses', 'Outstanding', 'Net Cash'];\n        const data = [\n          metrics.actualRevenue,\n          -metrics.outstandingRevenue * 0.6,\n          -metrics.outstandingRevenue * 0.4,\n          metrics.cashFlow\n        ];\n\n        const chart = new ApexCharts(chartRefs.current.cashFlowChart, {\n          chart: {\n            type: 'bar',\n            height: 300\n          },\n          series: [{\n            name: 'Cash Flow',\n            data: data\n          }],\n          xaxis: {\n            categories: categories\n          },\n          yaxis: {\n            labels: {\n              formatter: (val) => formatCurrency(Math.abs(val))\n            }\n          },\n          colors: ['#10B981'],\n          plotOptions: {\n            bar: {\n              colors: {\n                ranges: [{\n                  from: -1000000000,\n                  to: 0,\n                  color: '#EF4444'\n                }]\n              }\n            }\n          },\n          dataLabels: {\n            enabled: true,\n            formatter: (val) => formatCurrency(val)\n          },\n          tooltip: {\n            y: {\n              formatter: (val) => formatCurrency(val)\n            }\n          }\n        });\n        chart.render();\n\n        return () => chart.destroy();\n      }\n    }, [loading]);\n\n    return <div ref={el => chartRefs.current.cashFlowChart = el}></div>;\n  };\n\n  // Sub-component: Forecast Model\n  const ForecastModel = () => {\n    const generateForecast = () => {\n      const historicalData = trendData;\n      const lastValue = historicalData[historicalData.length - 1]?.total || 0;\n      const growthRate = 1.05; // 5% growth\n      \n      return Array.from({ length: 6 }, (_, i) => ({\n        month: `Month +${i + 1}`,\n        forecast: lastValue * Math.pow(growthRate, i + 1),\n        confidence: 90 - (i * 10)\n      }));\n    };\n\n    const forecastData = generateForecast();\n\n    useEffect(() => {\n      if (!loading && chartRefs.current.forecastChart) {\n        const chart = new ApexCharts(chartRefs.current.forecastChart, {\n          chart: {\n            type: 'line',\n            height: 300,\n            toolbar: {\n              show: false\n            }\n          },\n          series: [{\n            name: 'Forecast',\n            data: forecastData.map(d => d.forecast)\n          }],\n          xaxis: {\n            categories: forecastData.map(d => d.month)\n          },\n          yaxis: {\n            labels: {\n              formatter: (val) => formatCurrency(val)\n            }\n          },\n          colors: ['#F59E0B'],\n          stroke: {\n            curve: 'smooth',\n            width: 3,\n            dashArray: 5\n          },\n          markers: {\n            size: 6\n          },\n          dataLabels: {\n            enabled: false\n          },\n          tooltip: {\n            y: {\n              formatter: (val, opts) => {\n                const confidence = forecastData[opts.dataPointIndex]?.confidence || 0;\n                return `${formatCurrency(val)} (${confidence}% confidence)`;\n              }\n            }\n          }\n        });\n        chart.render();\n\n        return () => chart.destroy();\n      }\n    }, [loading]);\n\n    return <div ref={el => chartRefs.current.forecastChart = el}></div>;\n  };\n\n  // Sub-component: Details Panel\n  const DetailsPanel = () => {\n    if (!selectedMetric) return null;\n\n    return (\n      <div\n        style={{\n          position: 'fixed',\n          right: isPanelOpen ? 0 : '-500px',\n          top: 0,\n          bottom: 0,\n          width: '500px',\n          backgroundColor: 'white',\n          boxShadow: '-4px 0 20px rgba(0,0,0,0.1)',\n          zIndex: 1000,\n          transition: 'right 0.3s ease',\n          display: 'flex',\n          flexDirection: 'column'\n        }}\n      >\n        <div style={{\n          padding: '20px',\n          borderBottom: '1px solid #E5E7EB',\n          display: 'flex',\n          justifyContent: 'space-between',\n          alignItems: 'center'\n        }}>\n          <h3 style={{ margin: 0 }}>{selectedMetric.title}</h3>\n          <button\n            onClick={() => setIsPanelOpen(false)}\n            style={{\n              background: 'none',\n              border: 'none',\n              fontSize: '24px',\n              cursor: 'pointer'\n            }}\n          >\n            ×\n          </button>\n        </div>\n        \n        <div style={{ flex: 1, overflow: 'auto', padding: '20px' }}>\n          <div style={{ marginBottom: '20px' }}>\n            <h4>Analysis</h4>\n            <p>{selectedMetric.analysis}</p>\n          </div>\n          \n          <div style={{ marginBottom: '20px' }}>\n            <h4>Recommendations</h4>\n            <ul>\n              {selectedMetric.recommendations?.map((rec, i) => (\n                <li key={i}>{rec}</li>\n              ))}\n            </ul>\n          </div>\n          \n          <div style={{ display: 'flex', gap: '10px' }}>\n            {DataExportPanel ? (\n              <DataExportPanel\n                data={exportData}\n                columns={exportColumns}\n                htmlElement={dashboardRef.current}\n                filename={`financial-report-${new Date().toISOString().split('T')[0]}`}\n                formats={['csv', 'excel', 'pdf']}\n                buttonStyle=\"menu\"\n                pdfOptions={{\n                  orientation: 'landscape',\n                  pageSize: 'a4',\n                  margins: { top: 40, bottom: 40, left: 40, right: 40 },\n                  title: 'Financial Analytics Report',\n                  includeDataTable: true,\n                  multiPage: true  // Enable multi-page support for tall dashboards\n                }}\n                excelOptions={{\n                  sheetName: 'Financial Data',\n                  includeFilters: true,\n                  autoWidth: true\n                }}\n                utilities={utilities}\n                styles={styles}\n                components={components}\n                callbacks={callbacks}\n              />\n            ) : null}\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  // Prepare data for export\n  const exportData = React.useMemo(() => {\n    // Return empty array if data is not loaded\n    if (!invoices || invoices.length === 0) {\n      return [];\n    }\n\n    // metrics is already calculated via useMemo\n    const monthlyTrends = trendData;\n\n    // Combine all financial data into a flat structure for export\n    const exportData = [];\n\n    // Add monthly revenue data\n    monthlyTrends.forEach(month => {\n      exportData.push({\n        category: 'Monthly Revenue',\n        date: month.month,\n        metric: 'Invoice Revenue',\n        value: month.revenue,\n        type: 'Actual'\n      });\n      exportData.push({\n        category: 'Monthly Revenue',\n        date: month.month,\n        metric: 'Deal Revenue',\n        value: month.deals,\n        type: 'Projected'\n      });\n    });\n\n    // Add summary metrics\n    const currentDate = new Date().toISOString().split('T')[0];\n    exportData.push(\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Total Revenue',\n        value: metrics.totalRevenue,\n        type: 'Combined'\n      },\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Actual Revenue',\n        value: metrics.actualRevenue,\n        type: 'Actual'\n      },\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Projected Revenue',\n        value: metrics.projectedRevenue,\n        type: 'Projected'\n      },\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Outstanding Revenue',\n        value: metrics.outstandingRevenue,\n        type: 'Outstanding'\n      },\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Average Deal Size',\n        value: metrics.avgDealSize,\n        type: 'Calculated'\n      },\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Gross Margin',\n        value: metrics.grossMargin,\n        type: 'Percentage'\n      },\n      {\n        category: 'Summary',\n        date: currentDate,\n        metric: 'Revenue Growth',\n        value: metrics.revenueGrowth,\n        type: 'Percentage'\n      }\n    );\n\n    // Add top invoices\n    const topInvoices = invoices\n      .filter(inv => inv.Status === 'Paid')\n      .sort((a, b) => (b.TotalAmount || 0) - (a.TotalAmount || 0))\n      .slice(0, 5);\n\n    topInvoices.forEach(invoice => {\n      exportData.push({\n        category: 'Top Invoices',\n        date: invoice.InvoiceDate,\n        metric: `Invoice #${invoice.ID}`,\n        value: invoice.TotalAmount,\n        type: 'Invoice'\n      });\n    });\n\n    return exportData;\n  }, [invoices, deals, metrics]);\n\n  // Export columns configuration - memoized value\n  const exportColumns = React.useMemo(() => {\n    return [\n      { key: 'category', label: 'Category', type: 'string' },\n      { key: 'date', label: 'Date', type: 'date' },\n      { key: 'metric', label: 'Metric', type: 'string' },\n      { key: 'value', label: 'Value', type: 'currency' },\n      { key: 'type', label: 'Type', type: 'string' }\n    ];\n  }, []);\n\n\n  if (loading) {\n    return (\n      <div style={{ padding: '40px', textAlign: 'center' }}>\n        <div style={{ fontSize: '18px', color: '#6B7280' }}>Loading financial data...</div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div style={{ padding: '20px', backgroundColor: '#FEE2E2', borderRadius: '8px', margin: '20px' }}>\n        <div style={{ color: '#991B1B', fontWeight: 'bold' }}>Error loading data</div>\n        <div style={{ color: '#DC2626', marginTop: '8px' }}>{error}</div>\n      </div>\n    );\n  }\n\n  return (\n    <div ref={(el) => {\n      dashboardRef.current = el;\n      console.log('Dashboard ref callback:', el);\n    }} style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>\n      <style>{`\n        .ai-insights-content h1, .ai-insights-content h2, .ai-insights-content h3 {\n          margin-top: 16px;\n          margin-bottom: 8px;\n          color: #111827;\n        }\n        .ai-insights-content h1 { font-size: 1.5em; }\n        .ai-insights-content h2 { font-size: 1.3em; }\n        .ai-insights-content h3 { font-size: 1.1em; }\n        .ai-insights-content p {\n          margin: 8px 0;\n          line-height: 1.6;\n          color: #374151;\n        }\n        .ai-insights-content ul, .ai-insights-content ol {\n          margin: 8px 0;\n          padding-left: 24px;\n        }\n        .ai-insights-content li {\n          margin: 4px 0;\n          color: #374151;\n        }\n        .ai-insights-content strong {\n          color: #111827;\n          font-weight: 600;\n        }\n        .ai-insights-content code {\n          background: #F3F4F6;\n          padding: 2px 6px;\n          border-radius: 3px;\n          font-size: 0.9em;\n        }\n        .ai-insights-content blockquote {\n          border-left: 4px solid #3B82F6;\n          padding-left: 16px;\n          margin: 12px 0;\n          color: #4B5563;\n        }\n      `}</style>\n      \n      <div style={{ padding: '20px', borderBottom: '1px solid #E5E7EB' }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>\n          <h2 style={{ margin: 0, fontSize: '24px', fontWeight: 'bold' }}>Financial Analytics</h2>\n          <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>\n            <select\n              value={timeRange}\n              onChange={(e) => {\n                setTimeRange(e.target.value);\n                onSaveUserSettings({ ...savedUserSettings, timeRange: e.target.value });\n              }}\n              style={{\n                padding: '8px 12px',\n                border: '1px solid #D1D5DB',\n                borderRadius: '6px'\n              }}\n            >\n              <option value=\"month\">Last Month</option>\n              <option value=\"quarter\">Last Quarter</option>\n              <option value=\"year\">Last Year</option>\n            </select>\n            \n            {/* AI Insights Button */}\n            <button\n              onClick={generateAIInsights}\n              disabled={loadingInsights || loading}\n              style={{\n                padding: '8px 16px',\n                backgroundColor: '#3B82F6',\n                color: 'white',\n                border: 'none',\n                borderRadius: '6px',\n                cursor: loadingInsights || loading ? 'not-allowed' : 'pointer',\n                display: 'flex',\n                alignItems: 'center',\n                gap: '8px',\n                opacity: loadingInsights || loading ? 0.6 : 1\n              }}\n            >\n              <i className={`fa-solid fa-${loadingInsights ? 'spinner fa-spin' : 'wand-magic-sparkles'}`}></i>\n              {loadingInsights ? 'Analyzing...' : 'Get AI Insights'}\n            </button>\n            \n            {/* Export Button - hidden during PDF capture */}\n            <div className=\"no-print\">\n              {DataExportPanel ? (\n                console.log('Rendering DataExportPanel with:', {\n                  dashboardRef: dashboardRef,\n                  dashboardRefCurrent: dashboardRef.current,\n                  dashboardRefExists: !!dashboardRef.current,\n                  aiInsights: !!aiInsights,\n                  aiInsightsRef: aiInsightsRef,\n                  aiInsightsRefCurrent: aiInsightsRef.current\n                }) ||\n                <DataExportPanel\n                  data={exportData}\n                  columns={exportColumns}\n                  getHtmlElement={() => dashboardRef.current}\n                  aiInsightsText={aiInsights}  // Pass raw markdown text only\n                  filename={`financial-report-${new Date().toISOString().split('T')[0]}`}\n                  formats={['csv', 'excel', 'pdf']}\n                  buttonStyle=\"dropdown\"\n                  buttonText=\"Export\"\n                  icon=\"fa-download\"\n                  pdfOptions={{\n                    orientation: 'landscape',\n                    pageSize: 'a4',\n                    margins: { top: 40, bottom: 40, left: 40, right: 40 },\n                    title: 'Financial Analytics Report',\n                    includeDataTable: true,\n                    multiPage: true  // Enable multi-page support for tall dashboards\n                  }}\n                  excelOptions={{\n                    sheetName: 'Financial Data',\n                    includeFilters: true,\n                    autoWidth: true\n                  }}\n                  utilities={utilities}\n                  styles={styles}\n                  components={components}\n                  callbacks={callbacks}\n                />\n              ) : null}\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      {/* AI Insights Panel */}\n      <div ref={(el) => {\n        aiInsightsRef.current = el;\n        console.log('AI Insights ref callback:', el);\n      }}>\n      {AIInsightsPanel ? (\n        <AIInsightsPanel\n          utilities={utilities}\n          styles={styles}\n          components={components}\n          callbacks={callbacks}\n          savedUserSettings={savedUserSettings?.aiInsights}\n          onSaveUserSettings={(settings) => onSaveUserSettings?.({\n            ...savedUserSettings,\n            aiInsights: settings\n          })}\n          insights={aiInsights}\n          loading={loadingInsights}\n          error={insightsError}\n          onGenerate={generateAIInsights}\n          title=\"Financial Analytics Insights\"\n          icon=\"fa-wand-magic-sparkles\"\n          iconColor={styles?.colors?.primary || '#8B5CF6'}\n          position=\"top\"\n          onClose={() => {\n            setAiInsights(null);\n            setInsightsError(null);\n          }}\n        />\n      ) : null}\n      </div>\n      \n      <div style={{ margin: '20px' }}>\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px' }}>\n          <div \n            style={{ \n              padding: '16px', \n              backgroundColor: '#F9FAFB', \n              borderRadius: '8px',\n              cursor: 'pointer'\n            }}\n            onClick={() => {\n              const relevantData = [\n                ...invoices.filter(inv => inv.Status === 'Paid').map(inv => ({...inv, Type: 'Paid Invoice', EntityType: 'Invoices', DisplayAmount: inv.TotalAmount})),\n                ...deals.filter(d => !['Closed Won', 'Closed Lost'].includes(d.Stage)).map(d => ({...d, Type: 'Projected Deal', EntityType: 'Deals', DisplayAmount: (d.Amount || 0) * (d.Probability || 0) / 100}))\n              ];\n              setDrillDownData(relevantData);\n              setDrillDownTitle('Total Revenue Breakdown');\n            }}\n          >\n            <div style={{ fontSize: '12px', color: '#6B7280' }}>Total Revenue</div>\n            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#10B981' }}>\n              {formatCurrency(metrics.totalRevenue)}\n            </div>\n          </div>\n          \n          <div \n            style={{ \n              padding: '16px', \n              backgroundColor: '#F9FAFB', \n              borderRadius: '8px',\n              cursor: 'pointer'\n            }}\n            onClick={() => {\n              const paidInvoices = invoices.filter(inv => inv.Status === 'Paid').map(inv => ({...inv, Type: 'Paid Invoice', EntityType: 'Invoices', DisplayAmount: inv.TotalAmount}));\n              setDrillDownData(paidInvoices);\n              setDrillDownTitle('Actual Revenue - Paid Invoices');\n            }}\n          >\n            <div style={{ fontSize: '12px', color: '#6B7280' }}>Actual Revenue</div>\n            <div style={{ fontSize: '24px', fontWeight: 'bold' }}>\n              {formatCurrency(metrics.actualRevenue)}\n            </div>\n          </div>\n          \n          <div style={{ padding: '16px', backgroundColor: '#F9FAFB', borderRadius: '8px' }}>\n            <div style={{ fontSize: '12px', color: '#6B7280' }}>Projected</div>\n            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#F59E0B' }}>\n              {formatCurrency(metrics.projectedRevenue)}\n            </div>\n          </div>\n          \n          <div \n            style={{ \n              padding: '16px', \n              backgroundColor: '#F9FAFB', \n              borderRadius: '8px',\n              cursor: 'pointer'\n            }}\n            onClick={() => {\n              const unpaidInvoices = invoices.filter(inv => inv.Status !== 'Paid' && inv.Status !== 'Cancelled').map(inv => ({...inv, Type: 'Unpaid Invoice', EntityType: 'Invoices', DisplayAmount: inv.TotalAmount}));\n              setDrillDownData(unpaidInvoices);\n              setDrillDownTitle('Outstanding Revenue - Unpaid Invoices');\n            }}\n          >\n            <div style={{ fontSize: '12px', color: '#6B7280' }}>Outstanding</div>\n            <div style={{ fontSize: '24px', fontWeight: 'bold', color: '#EF4444' }}>\n              {formatCurrency(metrics.outstandingRevenue)}\n            </div>\n          </div>\n          \n          <div style={{ padding: '16px', backgroundColor: '#F9FAFB', borderRadius: '8px' }}>\n            <div style={{ fontSize: '12px', color: '#6B7280' }}>Avg Deal Size</div>\n            <div style={{ fontSize: '24px', fontWeight: 'bold' }}>\n              {formatCurrency(metrics.avgDealSize)}\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div style={{ flex: 1, overflow: 'auto', padding: '20px' }}>\n        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '20px', marginBottom: '20px' }}>\n          <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '8px', border: '1px solid #E5E7EB' }}>\n            <h3 style={{ marginTop: 0 }}>Revenue Trend</h3>\n            <RevenueTrendChart />\n          </div>\n          <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '8px', border: '1px solid #E5E7EB' }}>\n            <h3 style={{ marginTop: 0 }}>KPI Gauges</h3>\n            <KPIGauges />\n          </div>\n        </div>\n        \n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>\n          <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '8px', border: '1px solid #E5E7EB' }}>\n            <h3 style={{ marginTop: 0 }}>Cash Flow Analysis</h3>\n            <CashFlowChart />\n          </div>\n          <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '8px', border: '1px solid #E5E7EB' }}>\n            <h3 style={{ marginTop: 0 }}>Revenue Forecast</h3>\n            <ForecastModel />\n          </div>\n        </div>\n      </div>\n      \n      {/* Drill-down Table */}\n      {drillDownData && (\n        <DrillDownTable \n          data={drillDownData}\n          title={drillDownTitle}\n          onClose={() => setDrillDownData(null)}\n          sortConfig={sortConfig}\n          setSortConfig={setSortConfig}\n          callbacks={callbacks}\n        />\n      )}\n      \n      <DetailsPanel />\n    </div>\n  );\n}\n\n// Drill-down Table Component\nfunction DrillDownTable({ data, title, onClose, sortConfig, setSortConfig, callbacks }) {\n  const formatCurrency = (value) => {\n    if (!value) return '$0';\n    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;\n    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;\n    return `$${value.toFixed(0)}`;\n  };\n\n  const formatDate = (date) => {\n    if (!date) return 'N/A';\n    return new Date(date).toLocaleDateString();\n  };\n\n  const sortedData = [...data].sort((a, b) => {\n    const aValue = a[sortConfig.key];\n    const bValue = b[sortConfig.key];\n    \n    if (aValue === null || aValue === undefined) return 1;\n    if (bValue === null || bValue === undefined) return -1;\n    \n    if (sortConfig.direction === 'asc') {\n      return aValue > bValue ? 1 : -1;\n    } else {\n      return aValue < bValue ? 1 : -1;\n    }\n  });\n\n  const handleSort = (key) => {\n    setSortConfig({\n      key,\n      direction: sortConfig.key === key && sortConfig.direction === 'desc' ? 'asc' : 'desc'\n    });\n  };\n\n  return (\n    <div style={{\n      backgroundColor: 'white',\n      borderRadius: '8px',\n      padding: '20px',\n      margin: '20px',\n      border: '1px solid #E5E7EB',\n      boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'\n    }}>\n      <div style={{ \n        display: 'flex', \n        justifyContent: 'space-between', \n        alignItems: 'center',\n        marginBottom: '16px'\n      }}>\n        <h3 style={{ margin: 0, fontSize: '18px', fontWeight: 'bold' }}>\n          {title} ({data.length} records)\n        </h3>\n        <button\n          onClick={onClose}\n          style={{\n            background: 'none',\n            border: 'none',\n            fontSize: '24px',\n            cursor: 'pointer',\n            color: '#6B7280'\n          }}\n        >\n          <i className=\"fa-solid fa-times\"></i>\n        </button>\n      </div>\n\n      <div style={{ overflowX: 'auto' }}>\n        <table style={{ width: '100%', borderCollapse: 'collapse' }}>\n          <thead>\n            <tr style={{ borderBottom: '2px solid #E5E7EB' }}>\n              <th \n                onClick={() => handleSort('Type')}\n                style={{ \n                  padding: '12px 8px', \n                  textAlign: 'left', \n                  cursor: 'pointer',\n                  fontSize: '12px',\n                  fontWeight: '600',\n                  color: '#374151',\n                  textTransform: 'uppercase'\n                }}\n              >\n                Type {sortConfig.key === 'Type' && (sortConfig.direction === 'asc' ? '↑' : '↓')}\n              </th>\n              <th \n                onClick={() => handleSort('InvoiceNumber')}\n                style={{ \n                  padding: '12px 8px', \n                  textAlign: 'left', \n                  cursor: 'pointer',\n                  fontSize: '12px',\n                  fontWeight: '600',\n                  color: '#374151',\n                  textTransform: 'uppercase'\n                }}\n              >\n                Reference {sortConfig.key === 'InvoiceNumber' && (sortConfig.direction === 'asc' ? '↑' : '↓')}\n              </th>\n              <th \n                onClick={() => handleSort('InvoiceDate')}\n                style={{ \n                  padding: '12px 8px', \n                  textAlign: 'left', \n                  cursor: 'pointer',\n                  fontSize: '12px',\n                  fontWeight: '600',\n                  color: '#374151',\n                  textTransform: 'uppercase'\n                }}\n              >\n                Date {sortConfig.key === 'InvoiceDate' && (sortConfig.direction === 'asc' ? '↑' : '↓')}\n              </th>\n              <th \n                onClick={() => handleSort('DisplayAmount')}\n                style={{ \n                  padding: '12px 8px', \n                  textAlign: 'right', \n                  cursor: 'pointer',\n                  fontSize: '12px',\n                  fontWeight: '600',\n                  color: '#374151',\n                  textTransform: 'uppercase'\n                }}\n              >\n                Amount {sortConfig.key === 'DisplayAmount' && (sortConfig.direction === 'asc' ? '↑' : '↓')}\n              </th>\n              <th \n                onClick={() => handleSort('Status')}\n                style={{ \n                  padding: '12px 8px', \n                  textAlign: 'left', \n                  cursor: 'pointer',\n                  fontSize: '12px',\n                  fontWeight: '600',\n                  color: '#374151',\n                  textTransform: 'uppercase'\n                }}\n              >\n                Status {sortConfig.key === 'Status' && (sortConfig.direction === 'asc' ? '↑' : '↓')}\n              </th>\n              <th style={{ \n                padding: '12px 8px', \n                textAlign: 'center',\n                fontSize: '12px',\n                fontWeight: '600',\n                color: '#374151',\n                textTransform: 'uppercase'\n              }}>\n                Action\n              </th>\n            </tr>\n          </thead>\n          <tbody>\n            {sortedData.map((item, index) => (\n              <tr \n                key={item.ID || index}\n                style={{ \n                  borderBottom: '1px solid #F3F4F6',\n                  transition: 'background-color 0.2s'\n                }}\n                onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#F9FAFB'}\n                onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}\n              >\n                <td style={{ padding: '12px 8px', fontSize: '14px' }}>\n                  <span style={{\n                    padding: '2px 8px',\n                    backgroundColor: item.Type === 'Paid Invoice' ? '#D1FAE5' : \n                                     item.Type === 'Unpaid Invoice' ? '#FEE2E2' : \n                                     item.Type === 'Projected Deal' ? '#FEF3C7' : '#E5E7EB',\n                    color: item.Type === 'Paid Invoice' ? '#065F46' : \n                           item.Type === 'Unpaid Invoice' ? '#991B1B' : \n                           item.Type === 'Projected Deal' ? '#92400E' : '#374151',\n                    borderRadius: '4px',\n                    fontSize: '12px'\n                  }}>\n                    {item.Type}\n                  </span>\n                </td>\n                <td style={{ padding: '12px 8px', fontSize: '14px' }}>\n                  {item.InvoiceNumber || item.DealName || item.ProductName || '-'}\n                </td>\n                <td style={{ padding: '12px 8px', fontSize: '14px', color: '#6B7280' }}>\n                  {formatDate(item.InvoiceDate || item.CloseDate || item.CreatedAt)}\n                </td>\n                <td style={{ padding: '12px 8px', textAlign: 'right', fontSize: '14px', fontWeight: '500' }}>\n                  {formatCurrency(item.DisplayAmount || item.TotalAmount || item.Amount || item.Price)}\n                </td>\n                <td style={{ padding: '12px 8px', fontSize: '14px' }}>\n                  <span style={{\n                    padding: '2px 8px',\n                    backgroundColor: item.Status === 'Paid' ? '#D1FAE5' : \n                                     item.Status === 'Pending' ? '#FEF3C7' : \n                                     item.Stage === 'Closed Won' ? '#D1FAE5' :\n                                     item.Stage === 'Closed Lost' ? '#FEE2E2' : '#E5E7EB',\n                    color: item.Status === 'Paid' ? '#065F46' : \n                           item.Status === 'Pending' ? '#92400E' : \n                           item.Stage === 'Closed Won' ? '#065F46' :\n                           item.Stage === 'Closed Lost' ? '#991B1B' : '#374151',\n                    borderRadius: '4px',\n                    fontSize: '12px'\n                  }}>\n                    {item.Status || item.Stage || 'Active'}\n                  </span>\n                </td>\n                <td style={{ padding: '12px 8px', textAlign: 'center' }}>\n                  <button\n                    onClick={() => {\n                      if (callbacks && callbacks.OpenEntityRecord) {\n                        callbacks.OpenEntityRecord(item.EntityType, [{ FieldName: 'ID', Value: item.ID }]);\n                      }\n                    }}\n                    style={{\n                      background: 'none',\n                      border: 'none',\n                      color: '#4F46E5',\n                      cursor: 'pointer',\n                      fontSize: '16px',\n                      padding: '4px'\n                    }}\n                    title=\"Open Record\"\n                  >\n                    <i className=\"fa-solid fa-arrow-up-right-from-square\"></i>\n                  </button>\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}",
  "functionalRequirements": "## Financial Analytics Dashboard\n\n### Purpose\nComprehensive financial overview with revenue trends, forecasting, and profitability analysis.\n\n### Core Features\n- **Revenue Trends**: Historical and projected revenue\n- **Cash Flow Analysis**: Income vs expenses tracking\n- **Profitability Metrics**: Margin analysis by product/customer\n- **Forecast Modeling**: AI-powered predictions\n- **Budget vs Actual**: Variance analysis\n- **Interactive Gauges**: Using Recharts for KPIs\n- **Slide-out Reports**: Detailed financial reports\n- **Export Options**: PDF and Excel export\n\n### Visualizations\n- Area charts for revenue trends\n- Gauge charts for KPIs\n- Waterfall charts for P&L\n- Scatter plots for correlation analysis",
  "dataRequirements": {
    "mode": "views",
    "entities": [
      {
        "name": "Invoices",
        "displayFields": [
          "InvoiceDate",
          "TotalAmount",
          "Status"
        ],
        "filterFields": [
          "InvoiceDate",
          "Status"
        ],
        "sortFields": [
          "InvoiceDate"
        ]
      },
      {
        "name": "Deals",
        "displayFields": [
          "CloseDate",
          "Amount",
          "Stage",
          "Probability"
        ],
        "filterFields": [
          "CloseDate",
          "Stage"
        ],
        "sortFields": [
          "CloseDate"
        ]
      },
      {
        "name": "Products",
        "displayFields": [
          "ProductName",
          "Price",
          "Cost"
        ]
      }
    ]
  },
  "technicalDesign": "## Implementation\n\n### Components\n- Main: FinancialAnalyticsDashboard\n- Sub-components:\n  - RevenueTrend: Time series analysis\n  - CashFlowChart: Income/expense flow\n  - ProfitabilityMatrix: Margin analysis\n  - ForecastModel: Predictive analytics\n  - KPIGauges: Performance indicators\n\n### Features\n- Real-time calculations\n- Statistical forecasting\n- Responsive charts\n- Export functionality",
  "properties": [],
  "events": [],
  "dependencies": [
    {
      "name": "AIInsightsPanel",
      "location": "registry",
      "namespace": "Generic/UI/AI",
      "version": "^1.0.0"
    },
    {
      "name": "DataExportPanel",
      "location": "registry",
      "namespace": "Generic/UI/Export",
      "version": "^1.0.0"
    }
  ],
  "libraries": [
    {
      "name": "ApexCharts",
      "version": "^3.45.1",
      "globalVariable": "ApexCharts"
    }
  ]
}
