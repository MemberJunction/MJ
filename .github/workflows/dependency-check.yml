name: Check Dependencies

on:
  pull_request:
    branches:
      - next
    paths:
      - 'packages/**/*.ts'
      - 'packages/**/*.tsx'
      - 'packages/**/package.json'
      - 'package.json'
      - 'package-lock.json'

jobs:
  check-dependencies:
    name: Detect missing and unused dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run Knip dependency check
        id: knip
        run: |
          echo "Running Knip to check for missing dependencies..."
          # Use npm script to ensure consistency with local development
          if npm run deps:missing --silent > knip-report.txt 2>&1; then
            echo "‚úÖ No missing dependencies found"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Missing dependencies detected"
            echo "status=warning" >> $GITHUB_OUTPUT
          fi

          # Display the report
          cat knip-report.txt
        continue-on-error: true

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const rawReport = fs.existsSync('knip-report.txt')
              ? fs.readFileSync('knip-report.txt', 'utf8')
              : '';

            const status = '${{ steps.knip.outputs.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';

            // Parse Knip output into structured data
            function parseKnipOutput(output) {
              const lines = output.trim().split('\n').filter(l => l.trim());
              const depsByPackage = new Map();

              for (const line of lines) {
                const match = line.match(/^(@?[^\s]+)\s+(.+?):\d+:\d+/);
                if (!match) continue;

                const [, depName, filePath] = match;

                // Extract package path from file path
                // e.g., packages/Actions/CoreActions/src/file.ts -> packages/Actions/CoreActions
                const packageMatch = filePath.match(/(packages\/[^\/]+(?:\/[^\/]+)*?)\/(?:src|dist|lib)/);
                const packagePath = packageMatch ? packageMatch[1] : 'root';

                if (!depsByPackage.has(packagePath)) {
                  depsByPackage.set(packagePath, new Set());
                }
                depsByPackage.get(packagePath).add(depName);
              }

              return depsByPackage;
            }

            let body;

            if (status === 'success') {
              body = '## ‚úÖ Dependency Check Results\n\n' +
                     '**All dependencies are properly declared!**\n\n' +
                     'No missing dependencies detected in this PR.';
            } else {
              const depsByPackage = parseKnipOutput(rawReport);
              const totalPackages = depsByPackage.size;
              const totalDeps = Array.from(depsByPackage.values())
                .reduce((sum, deps) => sum + deps.size, 0);

              let formattedReport = '## ‚ö†Ô∏è Missing Dependencies Detected\\n\\n';
              formattedReport += 'Found **' + totalDeps + ' missing dependencies** across **' + totalPackages + ' packages**.\\n\\n';
              formattedReport += '<details>\\n';
              formattedReport += '<summary><b>üì¶ Click to see affected packages</b></summary>\\n\\n';

              // Sort packages alphabetically
              const sortedPackages = Array.from(depsByPackage.entries())
                .sort(([a], [b]) => a.localeCompare(b));

              for (const [packagePath, deps] of sortedPackages) {
                const sortedDeps = Array.from(deps).sort();
                formattedReport += '\\n### \\`' + packagePath + '\\`\\n\\n';
                formattedReport += 'Missing ' + sortedDeps.length + ' dependencies:\\n';
                for (const dep of sortedDeps) {
                  formattedReport += '- \\`' + dep + '\\`\\n';
                }
              }

              formattedReport += '\\n</details>\\n\\n---\\n\\n';
              formattedReport += '### üîß How to Fix\\n\\n';
              formattedReport += '**Option 1: Auto-fix (recommended)**\\n';
              formattedReport += '\\`\\`\\`bash\\n';
              formattedReport += 'npm run deps:fix-missing:dry  # Preview changes\\n';
              formattedReport += 'npm run deps:fix-missing       # Apply fixes\\n';
              formattedReport += '\\`\\`\\`\\n\\n';
              formattedReport += '**Option 2: Manual fix**\\n';
              formattedReport += 'Add the missing dependencies to each package\\'s \\`package.json\\` file, then run:\\n';
              formattedReport += '\\`\\`\\`bash\\n';
              formattedReport += 'npm install\\n';
              formattedReport += '\\`\\`\\`\\n\\n';
              formattedReport += '### üìö Documentation\\n';
              formattedReport += '- [Dependency Management Guide](../scripts/README.md)\\n';
              formattedReport += '- [Why This Matters](../.github/workflows/DEPENDENCY-CHECK.md#why-this-matters)\\n';

              body = formattedReport;
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Dependency Check Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload Knip report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: knip-report
          path: knip-report.txt
          retention-days: 30
