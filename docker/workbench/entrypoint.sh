#!/bin/bash
set -e

MJ_REPO="https://github.com/MemberJunction/MJ.git"
MJ_DIR="/workspace/MJ"

# ─── Auto-update global packages on container start ─────────────────────────
echo "Checking for updates to Claude Code, MJ CLI, and Playwright CLI..."
npm update -g @anthropic-ai/claude-code @memberjunction/cli @playwright/cli 2>/dev/null || true

CLAUDE_VERSION=$(claude --version 2>/dev/null || echo "unknown")
MJ_VERSION=$(mj --version 2>/dev/null || echo "unknown")
PW_VERSION=$(playwright-cli --version 2>/dev/null || echo "unknown")
echo "  Claude Code:    ${CLAUDE_VERSION}"
echo "  MJ CLI:         ${MJ_VERSION}"
echo "  Playwright CLI: ${PW_VERSION}"
echo ""

# ─── Clone or update MJ repository ──────────────────────────────────────────
FRESH_CLONE=false
if [ ! -d "$MJ_DIR/.git" ]; then
    echo "Cloning MemberJunction repo (next branch)..."
    if command -v gh &>/dev/null && gh auth status &>/dev/null 2>&1; then
        gh repo clone MemberJunction/MJ "$MJ_DIR" -- --branch next
    else
        git clone --branch next "$MJ_REPO" "$MJ_DIR"
    fi
    echo "  MJ repo cloned to $MJ_DIR"
    FRESH_CLONE=true
else
    echo "MJ repo found at $MJ_DIR"
    cd "$MJ_DIR"
    # Fetch latest from origin without disrupting current work
    git fetch origin next 2>/dev/null || true
    CURRENT=$(git branch --show-current 2>/dev/null || echo "unknown")
    echo "  Current branch: $CURRENT"
    LOCAL=$(git rev-parse HEAD 2>/dev/null)
    REMOTE=$(git rev-parse origin/next 2>/dev/null)
    if [ "$CURRENT" = "next" ] && [ "$LOCAL" != "$REMOTE" ]; then
        echo "  Pulling latest next..."
        git pull origin next 2>/dev/null || true
    elif [ "$LOCAL" != "$REMOTE" ]; then
        echo "  origin/next has new commits (use 'git pull origin next' to update)"
    fi
    cd /workspace
fi
echo ""

# ─── Install dependencies on fresh clone ─────────────────────────────────────
if [ "$FRESH_CLONE" = true ] && [ -f "$MJ_DIR/package.json" ]; then
    echo "Running npm install (this may take a few minutes on first run)..."
    cd "$MJ_DIR"
    npm install 2>&1 | tail -5
    echo "  npm install complete"
    cd /workspace
    echo ""
fi

# ─── Create .env for MJAPI if missing ────────────────────────────────────────
if [ -d "$MJ_DIR" ] && [ ! -f "$MJ_DIR/.env" ]; then
    echo "Creating .env for MJAPI (pointing at sql-claude)..."
    cat > "$MJ_DIR/.env" << 'ENVEOF'
# Auto-generated by workbench entrypoint
# SQL Server connection (sql-claude container)
DB_HOST=sql-claude
DB_PORT=1433
DB_USERNAME=sa
DB_PASSWORD=Claude2Sql99
CODEGEN_DB_USERNAME=sa
CODEGEN_DB_PASSWORD=Claude2Sql99
DB_DATABASE=MJ_Workbench
DB_TRUST_SERVER_CERTIFICATE=true
MJ_CORE_SCHEMA=__mj
GRAPHQL_PORT=4000
ENVEOF
    echo "  Created $MJ_DIR/.env"
    echo ""
fi

# ─── Ensure .env symlink for MJAPI package ──────────────────────────────────
MJAPI_ENV="$MJ_DIR/packages/MJAPI/.env"
if [ -f "$MJ_DIR/.env" ] && [ ! -L "$MJAPI_ENV" ]; then
    # Remove existing non-symlink .env if present
    if [ -f "$MJAPI_ENV" ]; then
        mv "$MJAPI_ENV" "$MJAPI_ENV.bak"
    fi
    ln -sf "$MJ_DIR/.env" "$MJAPI_ENV"
    echo "  Symlinked .env → packages/MJAPI/.env"
fi

# ─── Auth0 setup: prompt on first run or when credentials are missing ────────
if [ -d "$MJ_DIR" ]; then
    if ! auth-setup --check 2>/dev/null; then
        echo ""
        echo "  Auth0 credentials not found in .env."
        echo "  MJAPI and MJExplorer need Auth0 to authenticate users."
        echo ""
        # Check if we're in an interactive terminal
        if [ -t 0 ]; then
            read -rp "  Run Auth0 setup now? [Y/n] " SETUP_ANSWER
            SETUP_ANSWER=${SETUP_ANSWER:-Y}
            if [[ "$SETUP_ANSWER" =~ ^[Yy] ]]; then
                auth-setup
            else
                echo ""
                echo "  Skipped. Run 'auth-setup' later to configure Auth0."
                echo ""
            fi
        else
            echo "  Non-interactive terminal detected. Run 'auth-setup' manually."
            echo ""
        fi
    fi
fi

# ─── Drop into zsh ──────────────────────────────────────────────────────────
exec /bin/zsh "$@"
