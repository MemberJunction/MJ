#!/bin/bash
set -e

MJ_REPO="https://github.com/MemberJunction/MJ.git"
MJ_DIR="/workspace/MJ"

# ─── Auto-update global packages on container start ─────────────────────────
echo "Checking for updates to Claude Code, MJ CLI, and Playwright CLI..."
npm update -g @anthropic-ai/claude-code @memberjunction/cli @playwright/cli 2>/dev/null || true

CLAUDE_VERSION=$(claude --version 2>/dev/null || echo "unknown")
MJ_VERSION=$(mj --version 2>/dev/null || echo "unknown")
PW_VERSION=$(playwright-cli --version 2>/dev/null || echo "unknown")
echo "  Claude Code:    ${CLAUDE_VERSION}"
echo "  MJ CLI:         ${MJ_VERSION}"
echo "  Playwright CLI: ${PW_VERSION}"
echo ""

# ─── Clone or update MJ repository ──────────────────────────────────────────
FRESH_CLONE=false
if [ ! -d "$MJ_DIR/.git" ]; then
    echo "Cloning MemberJunction repo (next branch)..."
    if command -v gh &>/dev/null && gh auth status &>/dev/null 2>&1; then
        gh repo clone MemberJunction/MJ "$MJ_DIR" -- --branch next
    else
        git clone --branch next "$MJ_REPO" "$MJ_DIR"
    fi
    echo "  MJ repo cloned to $MJ_DIR"
    FRESH_CLONE=true
else
    echo "MJ repo found at $MJ_DIR"
    cd "$MJ_DIR"
    # Fetch latest from origin without disrupting current work
    git fetch origin next 2>/dev/null || true
    CURRENT=$(git branch --show-current 2>/dev/null || echo "unknown")
    echo "  Current branch: $CURRENT"
    LOCAL=$(git rev-parse HEAD 2>/dev/null)
    REMOTE=$(git rev-parse origin/next 2>/dev/null)
    if [ "$CURRENT" = "next" ] && [ "$LOCAL" != "$REMOTE" ]; then
        echo "  Pulling latest next..."
        git pull origin next 2>/dev/null || true
    elif [ "$LOCAL" != "$REMOTE" ]; then
        echo "  origin/next has new commits (use 'git pull origin next' to update)"
    fi
    cd /workspace
fi
echo ""

# ─── Install dependencies on fresh clone ─────────────────────────────────────
if [ "$FRESH_CLONE" = true ] && [ -f "$MJ_DIR/package.json" ]; then
    echo "Running npm install (this may take a few minutes on first run)..."
    cd "$MJ_DIR"
    npm install 2>&1 | tail -5
    echo "  npm install complete"
    cd /workspace
    echo ""
fi

# ─── Create .env for MJAPI if missing ────────────────────────────────────────
if [ -d "$MJ_DIR" ] && [ ! -f "$MJ_DIR/.env" ]; then
    echo "Creating .env for MJAPI (pointing at sql-claude)..."
    cat > "$MJ_DIR/.env" << 'ENVEOF'
# Auto-generated by workbench entrypoint
# SQL Server connection (sql-claude container)
DB_HOST=sql-claude
DB_PORT=1433
DB_USERNAME=sa
DB_PASSWORD=Claude2Sql99
CODEGEN_DB_USERNAME=sa
CODEGEN_DB_PASSWORD=Claude2Sql99
DB_DATABASE=MJ_Workbench
DB_TRUST_SERVER_CERTIFICATE=true
MJ_CORE_SCHEMA=__mj
GRAPHQL_PORT=4000
ENVEOF
    echo "  Created $MJ_DIR/.env"
    echo ""
fi

# ─── Ensure .env symlink for MJAPI package ──────────────────────────────────
MJAPI_ENV="$MJ_DIR/packages/MJAPI/.env"
if [ -f "$MJ_DIR/.env" ] && [ ! -L "$MJAPI_ENV" ]; then
    # Remove existing non-symlink .env if present
    if [ -f "$MJAPI_ENV" ]; then
        mv "$MJAPI_ENV" "$MJAPI_ENV.bak"
    fi
    ln -sf "$MJ_DIR/.env" "$MJAPI_ENV"
    echo "  Symlinked .env → packages/MJAPI/.env"
fi

# ─── Auth0 setup: auto-configure from env vars or prompt interactively ────────
if [ -d "$MJ_DIR" ]; then
    if ! auth-setup --check 2>/dev/null; then
        # Check if Auth0 credentials were passed as environment variables
        if [ -n "$TEST_AUTH0_DOMAIN" ] && [ -n "$TEST_AUTH0_CLIENT_ID" ] && [ -n "$TEST_AUTH0_CLIENT_SECRET" ]; then
            echo "  Auth0 credentials found in environment variables — auto-configuring..."
            # Write Auth0 vars to MJ .env (same format as auth-setup)
            ENV_FILE="$MJ_DIR/.env"
            cat >> "$ENV_FILE" << EOF

# ─── Auth0 Configuration (auto-configured from environment) ──────────────────
AUTH0_DOMAIN=${TEST_AUTH0_DOMAIN}
AUTH0_CLIENT_ID=${TEST_AUTH0_CLIENT_ID}
AUTH0_CLIENT_SECRET=${TEST_AUTH0_CLIENT_SECRET}

# Test credentials for browser automation (used by Claude Code for headless login)
TEST_AUTH0_DOMAIN=${TEST_AUTH0_DOMAIN}
TEST_AUTH0_CLIENT_ID=${TEST_AUTH0_CLIENT_ID}
TEST_AUTH0_CLIENT_SECRET=${TEST_AUTH0_CLIENT_SECRET}
TEST_UID=${TEST_UID}
TEST_PWD=${TEST_PWD}
EOF
            echo "  Auth0 domain:    ${TEST_AUTH0_DOMAIN}"
            echo "  Client ID:       ${TEST_AUTH0_CLIENT_ID:0:8}..."
            echo "  Test user:       ${TEST_UID}"

            # Generate Angular environment files
            ENVIRONMENTS_DIR="$MJ_DIR/packages/MJExplorer/src/environments"
            mkdir -p "$ENVIRONMENTS_DIR"

            for ENV_VARIANT in \
                "environment.ts:production:true:DOCKER" \
                "environment.development.ts:development:false:DEV" \
                "environment.staging.ts:staging:false:STAGING"; do
                IFS=':' read -r FNAME NODE_ENV PROD APP_INSTANCE <<< "$ENV_VARIANT"
                cat > "$ENVIRONMENTS_DIR/$FNAME" << ENVTS
export const environment = {
  GRAPHQL_URI: 'http://localhost:4000/',
  GRAPHQL_WS_URI: 'ws://localhost:4000/',
  REDIRECT_URI: 'http://localhost:4200/',
  AUTH_TYPE: 'auth0',
  NODE_ENV: '${NODE_ENV}',
  AUTOSAVE_DEBOUNCE_MS: 1200,
  SEARCH_DEBOUNCE_MS: 800,
  MIN_SEARCH_LENGTH: 3,
  MJ_CORE_SCHEMA_NAME: '__mj',
  production: ${PROD},
  APPLICATION_NAME: 'MemberJunction Explorer',
  APPLICATION_INSTANCE: '${APP_INSTANCE}',
  AUTH0_DOMAIN: '${TEST_AUTH0_DOMAIN}',
  AUTH0_CLIENTID: '${TEST_AUTH0_CLIENT_ID}',
} as const;
ENVTS
            done
            echo "  Angular environment files generated."
        else
            echo ""
            echo "  Auth0 credentials not found in .env."
            echo "  MJAPI and MJExplorer need Auth0 to authenticate users."
            echo ""
            # Check if we're in an interactive terminal
            if [ -t 0 ]; then
                read -rp "  Run Auth0 setup now? [Y/n] " SETUP_ANSWER
                SETUP_ANSWER=${SETUP_ANSWER:-Y}
                if [[ "$SETUP_ANSWER" =~ ^[Yy] ]]; then
                    auth-setup
                else
                    echo ""
                    echo "  Skipped. Run 'auth-setup' later to configure Auth0."
                    echo ""
                fi
            else
                echo "  Non-interactive terminal detected. Run 'auth-setup' manually."
                echo "  Or pass TEST_AUTH0_DOMAIN, TEST_AUTH0_CLIENT_ID, TEST_AUTH0_CLIENT_SECRET,"
                echo "  TEST_UID, and TEST_PWD in your workbench .env file."
                echo ""
            fi
        fi
    fi
fi

# ─── Drop into zsh ──────────────────────────────────────────────────────────
exec /bin/zsh "$@"
