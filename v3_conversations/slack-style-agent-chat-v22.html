<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Chat Workspace v21 - Libraries First-Class & Active Tasks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Global button reset */
        button {
            border: none;
            background: none;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            cursor: pointer;
            padding: 0;
            outline: none;
        }

        :root {
            /* Original color scheme */
            --navy: #092340;
            --light-blue: #AAE7FD;
            --gray-600: #F4F4F4;
            --gray-700: #D9D9D9;
            --gray-800: #AAA;
            --gray-900: #333;
            --mj-blue: #0076B6;
            --white-color: #FFF;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            
            /* Semantic mappings */
            --primary-color: var(--mj-blue);
            --background: var(--gray-600);
            --surface: var(--white-color);
            --surface-hover: var(--gray-700);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-800);
            --border-color: var(--gray-700);
            --success: #059669;
            --warning: #D97706;
            --error: #DC2626;
            --accent: var(--light-blue);
            
            /* Agent colors */
            --agent-claude: #9b59b6;
            --agent-designer: #e74c3c;
            --agent-coder: #3498db;
            --agent-code: #3498db; /* Alias for compatibility */
            --agent-analyst: #f39c12;
            --agent-analysis: #f39c12; /* Alias for compatibility */
            --agent-research: #2ecc71;
            --agent-skip: #00BFA5; /* Skip agent color */
            
            /* Message type backgrounds */
            --ai-message-bg: rgba(0, 118, 182, 0.05);
            --human-message-bg: transparent;
            
            /* User colors - Subtle, professional palette */
            --user-1: #6c5ce7; /* Purple */
            --user-2: #00b894; /* Teal */
            --user-3: #fdcb6e; /* Yellow */
            --user-4: #e17055; /* Coral */
            --user-5: #74b9ff; /* Light Blue */
            --user-6: #a29bfe; /* Lavender */
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Main Navigation Bar */
        .main-navigation {
            height: 48px;
            background: var(--navy);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-tabs {
            display: flex;
            gap: 4px;
            height: 100%;
        }
        
        .nav-tab {
            padding: 0 20px;
            height: 100%;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
        
        .nav-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--accent);
        }
        
        .nav-actions {
            display: flex;
            gap: 8px;
        }
        
        .nav-action {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .nav-action:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        /* Main Layout Container */
        .workspace-container {
            display: flex;
            height: calc(100vh - 48px);
            background-color: var(--background);
        }

        /* Left Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--navy);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
        }
        
        #librariesSidebar {
            position: fixed;
            top: 48px;
            left: 0;
            bottom: 0;
            height: calc(100vh - 48px);
        }

        /* Explorer View Header */
        .workspace-header {
            padding: 0;
            background-color: var(--navy);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 50px;
            display: flex;
            align-items: center;
        }

        .sidebar-title {
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--white-color);
            font-weight: 600;
            font-size: 14px;
            width: 100%;
            height: 50px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .explorer-header:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .explorer-header i {
            font-size: 12px;
        }

        /* Quick Actions Bar */
        .quick-actions {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .new-chat-btn {
            width: 100%;
            padding: 8px;
            background-color: var(--mj-blue);
            color: var(--white-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .new-chat-btn:hover {
            background-color: #005a8a;
        }

        .new-chat-btn i {
            font-size: 12px;
        }

        /* Search Bar */
        .sidebar-search {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-search-input {
            width: 100%;
            padding: 6px 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: var(--white-color);
            font-size: 13px;
            transition: all 0.2s;
        }

        .sidebar-search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .sidebar-search-input:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.15);
            border-color: var(--mj-blue);
        }

        /* Sidebar Sections */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            position: relative;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .section-header {
            padding: 4px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            font-weight: 500;
            transition: color 0.2s;
            user-select: none;
        }

        .section-header:hover {
            color: var(--white-color);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title i {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .section-header.expanded .section-title i {
            transform: rotate(90deg);
        }
        
        .section-action {
            padding: 2px 6px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0;
        }
        
        .section-header:hover .section-action {
            opacity: 1;
        }
        
        .section-action:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white-color);
        }

        .add-btn i {
            font-size: 12px;
        }

        /* Chat List Items */
        .chat-list {
            padding: 4px 0;
            display: none;
        }

        .chat-list.expanded {
            display: block;
        }

        .chat-item {
            padding: 6px 40px 6px 28px;  /* Add more right padding for the action button */
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            transition: all 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--white-color);
        }

        .chat-item:hover .chat-actions {
            opacity: 1;
        }
        
        /* ========== NOTIFICATION BADGES & DOTS ========== */
        .notification-badge {
            position: absolute;
            left: 28px;  /* Position over the right side of the chat icon */
            top: 8px;     /* Position at the top of the chat item */
            background: #ef4444;
            color: white;
            font-size: 10px;  /* Slightly smaller */
            font-weight: 600;
            padding: 1px 4px;  /* Smaller padding */
            border-radius: 8px;
            min-width: 14px;   /* Smaller minimum width */
            height: 14px;      /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1.5px solid var(--sidebar-bg);  /* Add border to make it stand out */
            z-index: 1;
        }
        
        .new-artifact-dot {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: dotPulse 2s ease-in-out infinite;
        }
        
        .progress-dot {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: var(--warning);
            border-radius: 50%;
            animation: dotSpin 1s linear infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            50% {
                opacity: 0.7;
                transform: translateY(-50%) scale(1.2);
            }
        }
        
        @keyframes dotSpin {
            from {
                box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.8);
            }
            to {
                box-shadow: 0 0 0 6px rgba(217, 119, 6, 0);
            }
        }
        
        /* Visual hint for chats without projects */
        .chat-item:not([data-project-id]) {
            position: relative;
        }
        

        .chat-item.active {
            background-color: var(--mj-blue);
            color: var(--white-color);
        }
        
        /* Project Badge */
        .project-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: auto;
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-item:hover .project-badge {
            background-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .chat-item.active .project-badge {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--white-color);
        }
        
        /* Project colors */
        .project-badge.project-website { background-color: #4A90E2; }
        .project-badge.project-mobile { background-color: #7ED321; }
        .project-badge.project-data { background-color: #BD10E0; }
        .project-badge.project-marketing { background-color: #F5A623; }

        .chat-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
            margin-right: 8px;  /* Add some spacing from the right edge */
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;  /* Position absolutely */
            right: 8px;  /* Align to the right edge */
            top: 50%;  /* Center vertically */
            transform: translateY(-50%);  /* Perfect vertical centering */
            z-index: 10;  /* Ensure actions are above chat item */
        }
        
        /* Chat Menu Dropdown */
        .chat-menu-dropdown {
            position: fixed;  /* Changed from absolute to fixed to escape overflow containers */
            background: white;
            border: 1px solid var(--gray-700);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            display: none;
            z-index: 9999;
            padding: 4px 0;
        }
        
        .chat-menu-dropdown.show {
            display: block;
        }
        
        .chat-menu-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            color: var(--gray-900);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .chat-menu-item:hover {
            background: var(--gray-600);
        }
        
        .chat-menu-item i {
            width: 14px;
            font-size: 12px;
            color: var(--gray-800);
        }
        
        .chat-menu-divider {
            height: 1px;
            background: var(--gray-700);
            margin: 4px 0;
        }
        
        .chat-menu-item.danger {
            color: #e74c3c;
        }
        
        .chat-menu-item.danger i {
            color: #e74c3c;
        }

        .chat-action-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            color: rgba(255, 255, 255, 0.6);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--white-color);
        }

        .chat-action-btn.delete:hover {
            background-color: rgba(239, 68, 68, 0.3);
            color: #ff6b6b;
        }

        .chat-action-btn i {
            font-size: 11px;
        }

        .chat-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        .chat-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* DM and Channel specific styles */
        .chat-participants {
            display: flex;
            gap: 2px;
            margin-left: auto;
        }
        
        .participant-avatar {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: white;
        }
        
        .chat-item[data-chat-type="dm"] .chat-icon {
            color: var(--light-blue);
        }
        
        .chat-item[data-chat-type="channel"] .chat-icon {
            color: var(--accent);
        }

        .unread-indicator {
            width: 8px;
            height: 8px;
            background-color: var(--error);
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--white-color);
        }

        /* Chat Header */
        .chat-header {
            background-color: var(--white-color);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .project-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background-color: var(--gray-600);
            border: 1px solid var(--gray-700);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            height: 28px;
            margin-left: 12px;
        }
        
        .project-tag:hover {
            background-color: var(--gray-700);
            border-color: var(--gray-800);
        }
        
        .project-tag i {
            font-size: 10px;
        }
        
        .chat-members {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: var(--gray-600);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            height: 32px;
        }

        .chat-members:hover {
            background-color: var(--gray-700);
            color: var(--text-primary);
        }

        .chat-members i {
            font-size: 12px;
            color: inherit;
        }

        .chat-members span {
            font-size: 12px;
            font-weight: 500;
        }

        .active-agents {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background-color: var(--gray-600);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            height: 32px;
        }

        .active-agents-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--navy);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            margin-right: -8px;
            border: 2px solid var(--gray-600);
        }

        .member-count {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Remove duplicate - already defined above with height: 32px */

        .active-agents-label {
            font-weight: 500;
        }

        .agent-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--white-color);
            position: relative;
        }

        .agent-indicator.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            border: 2px solid var(--white-color);
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn i {
            font-size: 12px;
        }

        .action-btn:hover {
            background-color: var(--gray-600);
            color: var(--text-primary);
            border-color: var(--gray-800);
        }

        /* Chat Search Bar */
        .chat-search-bar {
            padding: 12px 20px;
            background-color: var(--white-color);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-search-container {
            position: relative;
            display: flex;
            align-items: center;
            background-color: var(--gray-600);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0 12px;
            transition: all 0.2s;
        }

        .chat-search-container:focus-within {
            border-color: var(--mj-blue);
            background-color: var(--white-color);
        }

        .chat-search-container i {
            color: var(--text-secondary);
            font-size: 14px;
            margin-right: 10px;
        }

        .chat-search-input {
            flex: 1;
            background: none;
            border: none;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
        }

        .chat-search-input::placeholder {
            color: var(--text-secondary);
        }

        .clear-search-btn {
            padding: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .clear-search-btn:hover {
            background-color: var(--gray-700);
            color: var(--text-primary);
        }

        .clear-search-btn i {
            font-size: 12px;
            margin: 0;
        }

        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: var(--background);
            position: relative;
        }
        
        /* Pinned Messages */
        .pinned-messages {
            background: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .pinned-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--gray-600);
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .pinned-header i {
            color: var(--mj-blue);
            font-size: 12px;
        }
        
        .pinned-toggle {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .pinned-toggle:hover {
            background: var(--gray-700);
        }
        
        .pinned-list {
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s;
        }
        
        .pinned-list.collapsed {
            max-height: 0;
        }
        
        .pinned-message {
            padding: 10px 16px;
            border-bottom: 1px solid var(--gray-600);
            font-size: 13px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .pinned-message:hover {
            background: var(--gray-600);
        }
        
        .pinned-message:last-child {
            border-bottom: none;
        }
        
        .pinned-message-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .pinned-message-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .pinned-message:hover .pinned-message-actions {
            opacity: 1;
        }
        
        .unpin-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .unpin-btn:hover {
            background: var(--gray-700);
            color: var(--text-primary);
        }

        .message {
            display: flex;
            gap: 12px;
            padding: 8px 24px;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        
        .message:hover {
            background-color: var(--gray-600);
        }
        
        /* Human vs AI message distinction */
        
        .message.human-message {
            background-color: var(--human-message-bg);
        }
        
        .user-message {
            padding: 8px 24px;
        }
        
        .assistant-message {
            padding: 8px 24px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
            position: relative;
        }
        
        /* Enhanced Avatar Distinction for Human vs AI - CORRECTED */
        .human-avatar {
            border-radius: 50%; /* Circular for humans as per spec */
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .ai-avatar {
            border-radius: 8px; /* Square/rounded for AI as per spec */
            position: relative;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        
        /* Animated border for AI */
        .ai-avatar::before {
            content: '';
            position: absolute;
            inset: -3px;
            background: linear-gradient(45deg, #8b5cf6, #ec4899, #3b82f6);
            border-radius: 8px; /* Match AI avatar shape */
            z-index: -1;
            opacity: 0.5;
            animation: rotate-gradient 3s linear infinite;
        }
        
        @keyframes rotate-gradient {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* AI badge indicator */
        .ai-indicator {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            border: 2px solid var(--background);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Message bubble shapes */
        .human-message .message-content {
            border-radius: 12px 12px 12px 4px;
        }
        
        .ai-message .message-content {
            border-radius: 4px 12px 12px 12px;
        }
        
        /* Active Tasks Section */
        .active-tasks-section {
            background: white;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1px;
        }
        
        .active-tasks-header {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .active-tasks-header:hover {
            background: var(--gray-600);
        }
        
        .active-tasks-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .task-count {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .active-tasks-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
        }
        
        .active-tasks-content {
            padding: 0 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .active-tasks-content.collapsed {
            display: none;
        }
        
        .active-task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--gray-600);
            border-radius: 6px;
            transition: all var(--transition-fast);
        }
        
        .active-task-item:hover {
            background: var(--gray-700);
        }
        
        .active-task-item.working {
            background: linear-gradient(90deg, var(--gray-600), var(--gray-700));
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        .task-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .task-info {
            flex: 1;
            min-width: 0;
        }
        
        .task-agent {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .task-message {
            font-size: 12px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .task-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .task-status .mini-dots {
            display: flex;
            gap: 3px;
        }
        
        .task-status .mini-dots span {
            width: 4px;
            height: 4px;
            background: var(--mj-blue);
            border-radius: 50%;
            animation: pulse 1.4s infinite;
        }
        
        .task-status .mini-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .task-status .mini-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .task-status .status-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: capitalize;
        }
        
        .task-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .no-active-tasks {
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            padding: 8px;
        }
        
        
        /* Expanded View */
        .status-bar-expanded {
            display: none;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        
        
        .process-detail {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            background: var(--gray-600);
            border-radius: 6px;
            font-size: 12px;
        }
        
        .process-detail .agent-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }
        
        .process-detail .process-info {
            flex: 1;
        }
        
        .process-detail .process-status {
            color: var(--text-secondary);
            font-size: 11px;
        }
        
        .process-detail .process-time {
            color: var(--text-secondary);
            font-size: 10px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes typingFade {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Pulse animation for active tasks button */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 174, 0, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(255, 174, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 174, 0, 0); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Artifact Created Indicator */
        .artifact-created-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--mj-blue) 0%, var(--accent) 100%);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            animation: slideIn 0.3s ease;
        }
        
        .artifact-created-indicator button {
            margin-left: auto;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .artifact-created-indicator button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .user-avatar {
            background-color: var(--navy);
            color: var(--white-color);
        }

        .agent-message-avatar {
            color: var(--white-color);
        }

        .message-content {
            flex: 1;
            position: relative;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .agent-badge {
            padding: 2px 8px;
            background-color: var(--gray-600);
            border-radius: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .message-actions {
            position: absolute;
            top: 4px;
            right: 0;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .message-action:hover {
            background-color: var(--gray-600);
            color: var(--text-primary);
        }
        
        /* Message Menu Dropdown */
        .message-menu-dropdown {
            position: absolute;
            top: 30px;
            right: 0;
            background: white;
            border: 1px solid var(--gray-700);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            display: none;
            z-index: 1000;
        }
        
        .message-menu-dropdown.show {
            display: block;
        }
        
        .message-menu-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
            color: var(--gray-900);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .message-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .message-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        .message-menu-item:hover {
            background: var(--gray-600);
        }
        
        .message-menu-item i {
            width: 14px;
            font-size: 12px;
            color: var(--gray-800);
        }
        
        .message-menu-divider {
            height: 1px;
            background: var(--gray-700);
            margin: 2px 0;
        }
        
        /* Message Edit Mode */
        .message-edit-mode {
            display: none;
            flex: 1;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border: none !important;
            margin-top: 8px;
        }
        
        .message-edit-mode.active {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .message-edit-input {
            width: 100%;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 400;
            color: #555;
            background-color: white;
            resize: vertical;
            min-height: 60px;
            transition: all 0.2s ease;
        }
        
        .message-edit-input:focus {
            outline: none;
            background-color: white;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
            color: #333;
        }
        
        .message-edit-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .message-edit-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .message-edit-save {
            background: #e8e8e8;
            color: #555;
            border: 1px solid #d0d0d0;
        }
        
        .message-edit-save:hover {
            background: #d8d8d8;
            color: #333;
        }
        
        .message-edit-cancel {
            background: white;
            border: 1px solid #e0e0e0;
            color: #888;
        }
        
        .message-edit-cancel:hover {
            background: #f8f8f8;
            color: #666;
        }
        
        
        /* Agent Response Feedback */
        .agent-feedback {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--gray-600);
        }
        
        .feedback-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .feedback-btn:hover {
            background: var(--gray-600);
            border-color: var(--gray-700);
        }
        
        .feedback-btn.liked {
            color: #4CAF50;
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .feedback-btn.disliked {
            color: #f44336;
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        
        .feedback-btn i {
            font-size: 14px;
        }
        
        .feedback-count {
            font-weight: 500;
        }

        /* Input Area */
        .input-container {
            background-color: var(--white-color);
            border-top: 1px solid var(--border-color);
            padding: 20px;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
        }

        .chat-input {
            flex: 1;
            background-color: var(--gray-600);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 50px 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 150px;
            transition: all 0.2s;
            line-height: 1.5;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--mj-blue);
            background-color: var(--white-color);
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .input-container .send-btn {
            width: 32px;
            height: 32px;
            background-color: var(--mj-blue);
            color: var(--white-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .input-container .send-btn:hover:not(:disabled) {
            background-color: #005a8a;
        }

        .input-container .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .input-container .send-btn i {
            font-size: 14px;
        }

        .input-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .input-option {
            padding: 6px 12px;
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .input-option i {
            font-size: 12px;
        }

        .input-option:hover {
            background-color: var(--gray-600);
            color: var(--text-primary);
            border-color: var(--gray-800);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Libraries View */
        .libraries-view {
            display: none;
            position: fixed;
            top: 48px;
            left: 260px; /* Leave space for sidebar */
            right: 0;
            bottom: 0;
            flex-direction: column;
            background: var(--background);
            overflow: hidden;
        }
        
        .libraries-view.active {
            display: flex;
        }
        
        .libraries-header {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .libraries-search {
            flex: 1;
            max-width: 400px;
            position: relative;
        }
        
        .libraries-search i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .library-search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--gray-600);
            transition: all 0.2s;
        }
        
        .library-search-input:focus {
            outline: none;
            border-color: var(--mj-blue);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 101, 255, 0.1);
        }
        
        .libraries-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .libraries-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            display: block;
            height: calc(100% - 80px);
        }
        
        .library-folders {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .library-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .library-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        /* V4: Artifact Side Panel */
        .artifact-panel {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100vh;
            background: var(--white-color);
            border-left: 1px solid var(--border-color);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: right var(--transition-base);
            z-index: 1000;
        }

        .artifact-panel.open {
            right: 0;
        }

        .artifact-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--gray-600);
            border-bottom: 1px solid var(--border-color);
        }

        .artifact-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .artifact-panel-type {
            padding: 3px 10px;
            background: var(--mj-blue);
            color: var(--white-color);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .artifact-panel-type.markdown {
            background: #6366F1;
        }

        .artifact-panel-type.code {
            background: #10B981;
        }

        .artifact-panel-type.data {
            background: #F59E0B;
        }

        .artifact-panel-type.design {
            background: #EC4899;
        }

        .artifact-panel-actions {
            display: flex;
            gap: 8px;
        }

        .artifact-panel-action {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .artifact-panel-action:hover {
            background: var(--white-color);
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        .artifact-panel-close {
            background: transparent;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            transition: color var(--transition-fast);
        }

        .artifact-panel-close:hover {
            color: var(--text-primary);
        }

        .artifact-panel-tabs {
            display: flex;
            background: var(--gray-600);
            border-bottom: 1px solid var(--border-color);
        }

        .artifact-panel-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-bottom: 2px solid transparent;
        }

        .artifact-panel-tab:hover {
            color: var(--text-primary);
        }

        .artifact-panel-tab.active {
            color: var(--mj-blue);
            border-bottom-color: var(--mj-blue);
            background: var(--white-color);
        }

        .artifact-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #FAFAFA;
        }

        .artifact-panel-content pre {
            margin: 0;
            background: #1E1E1E;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
        }

        .artifact-panel-content pre code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #D4D4D4;
        }

        /* Markdown styles for artifact panel */
        .artifact-panel-content.markdown-content {
            background: var(--white-color);
            font-size: 15px;
            line-height: 1.7;
        }

        .artifact-panel-content.markdown-content h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 24px 0 16px;
            color: var(--text-primary);
        }

        .artifact-panel-content.markdown-content h2 {
            font-size: 22px;
            font-weight: 600;
            margin: 20px 0 12px;
            color: var(--text-primary);
        }

        .artifact-panel-content.markdown-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 16px 0 8px;
            color: var(--text-primary);
        }

        .artifact-panel-content.markdown-content p {
            margin: 12px 0;
        }

        .artifact-panel-content.markdown-content ul,
        .artifact-panel-content.markdown-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .artifact-panel-content.markdown-content li {
            margin: 6px 0;
        }

        .artifact-panel-content.markdown-content code {
            background: var(--gray-600);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
            color: var(--error);
        }

        .artifact-panel-content.markdown-content pre {
            background: var(--gray-600);
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .artifact-panel-content.markdown-content pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }

        .artifact-panel-content.markdown-content blockquote {
            margin: 16px 0;
            padding: 12px 20px;
            border-left: 4px solid var(--mj-blue);
            background: var(--gray-600);
            color: var(--text-secondary);
        }

        /* History view */
        .artifact-history-item {
            padding: 12px;
            background: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .artifact-history-item:hover {
            background: var(--gray-600);
            border-color: var(--mj-blue);
        }

        .artifact-history-version {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .artifact-history-time {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Inline artifact reference (in messages) */
        .artifact-reference {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--gray-600);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin: 8px 0;
        }

        .artifact-reference:hover {
            background: var(--white-color);
            border-color: var(--mj-blue);
            box-shadow: 0 2px 8px rgba(0, 118, 182, 0.1);
        }

        .artifact-reference-icon {
            font-size: 14px;
            color: var(--mj-blue);
        }

        .artifact-reference-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .artifact-reference-type {
            padding: 2px 6px;
            background: var(--mj-blue);
            color: var(--white-color);
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Adjust main content when panel is open */
        .main-content.artifact-panel-open {
            margin-right: 600px;
        }

        /* Panel resize handle */
        .artifact-panel-resize {
            position: absolute;
            left: -4px;
            top: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
        }

        .artifact-panel-resize:hover {
            background: rgba(0, 118, 182, 0.2);
        }

        /* Syntax highlighting adjustments */
        .token.comment { color: #6A9955; }
        .token.string { color: #CE9178; }
        .token.keyword { color: #569CD6; }
        .token.function { color: #DCDCAA; }
        .token.number { color: #B5CEA8; }
        .token.operator { color: #D4D4D4; }
        .token.class-name { color: #4EC9B0; }
        .token.property { color: #9CDCFE; }

        /* V5: Artifact Sharing Features */
        .artifact-share-button {
            padding: 6px 12px;
            background: var(--mj-blue);
            color: var(--white-color);
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .artifact-share-button:hover {
            background: #005a8a;
        }

        /* Share Modal */
        .share-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .share-modal-overlay.show {
            display: flex;
        }

        .share-modal {
            background: var(--white-color);
            border-radius: 12px;
            width: 500px;
            max-height: 600px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .share-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .share-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-modal-close {
            background: transparent;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .share-modal-close:hover {
            color: var(--text-primary);
        }

        .share-modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        /* Share Link Section */
        .share-link-section {
            margin-bottom: 24px;
        }

        .share-link-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .share-link-input-group {
            display: flex;
            gap: 8px;
        }

        .share-link-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-primary);
            background: var(--gray-600);
        }

        .share-link-copy-btn {
            padding: 8px 16px;
            background: var(--mj-blue);
            color: var(--white-color);
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .share-link-copy-btn:hover {
            background: #005a8a;
        }

        /* Permissions Section */
        .permissions-section {
            margin-bottom: 24px;
        }

        .permissions-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .permission-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-600);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .permission-option:hover {
            background: var(--gray-700);
        }

        .permission-option.selected {
            background: rgba(0, 118, 182, 0.1);
            border: 1px solid var(--mj-blue);
        }

        .permission-radio {
            width: 18px;
            height: 18px;
            margin-right: 12px;
        }

        .permission-info {
            flex: 1;
        }

        .permission-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .permission-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Shared With Section */
        .shared-with-section {
            margin-bottom: 24px;
        }

        .shared-with-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .shared-user-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .shared-user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--gray-600);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .shared-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shared-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--navy);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .shared-user-details {
            display: flex;
            flex-direction: column;
        }

        .shared-user-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .shared-user-permission {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .remove-share-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--error);
            font-size: 11px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .remove-share-btn:hover {
            background: var(--error);
            color: var(--white-color);
        }

        /* Share Settings */
        .share-settings {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .share-setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .share-setting-label {
            font-size: 13px;
            color: var(--text-primary);
        }

        .share-toggle {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .share-toggle input {
            display: none;
        }

        .share-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-700);
            border-radius: 24px;
            transition: all var(--transition-fast);
        }

        .share-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--white-color);
            border-radius: 50%;
            transition: all var(--transition-fast);
        }

        .share-toggle input:checked + .share-toggle-slider {
            background: var(--mj-blue);
        }

        .share-toggle input:checked + .share-toggle-slider:before {
            transform: translateX(20px);
        }

        /* Shared Artifacts Dashboard */
        .shared-artifacts-button {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .shared-artifacts-button:hover {
            background: var(--gray-600);
            color: var(--text-primary);
        }

        .shared-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 10px;
            font-size: 11px;
            color: #27AE60;
            font-weight: 600;
        }

        .shared-indicator i {
            font-size: 10px;
        }

        /* Collaboration Avatars on Artifact */
        .artifact-collaborators {
            display: inline-flex;
            margin-left: 12px;
        }

        .artifact-collaborator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--navy);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            border: 2px solid var(--white-color);
            margin-left: -8px;
        }

        .artifact-collaborator:first-child {
            margin-left: 0;
        }

        .artifact-collaborator-count {
            background: var(--gray-700);
            color: var(--text-primary);
            font-size: 10px;
            padding: 0 6px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px;
            box-shadow: var(--shadow);
            z-index: 9999;
            display: none;
            min-width: 160px;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: var(--gray-600);
        }

        .context-menu-item.danger {
            color: var(--error);
        }

        .context-menu-item.danger:hover {
            background-color: rgba(220, 38, 38, 0.1);
        }

        .context-menu-separator {
            height: 1px;
            background-color: var(--border-color);
            margin: 4px 8px;
        }

        .context-menu-item i {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }

        /* Edit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background-color: var(--white-color);
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Library Modal Styles */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--mj-blue);
            box-shadow: 0 0 0 3px rgba(0, 118, 182, 0.1);
        }
        
        textarea.form-input {
            resize: vertical;
        }
        
        .icon-picker, .color-picker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .icon-option, .color-option {
            width: 40px;
            height: 40px;
            border: 2px solid transparent;
            border-radius: 6px;
            background: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .icon-option:hover, .color-option:hover {
            transform: scale(1.1);
        }
        
        .icon-option.selected {
            border-color: var(--mj-blue);
            background: rgba(0, 118, 182, 0.1);
        }
        
        .color-option {
            border-radius: 50%;
        }
        
        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .btn-primary, .btn-secondary {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--mj-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #005a8a;
        }
        
        .btn-secondary {
            background: var(--gray-600);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--gray-700);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-primary);
            background-color: var(--gray-600);
            transition: all 0.2s;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--mj-blue);
            background-color: var(--white-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background-color: var(--gray-600);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-btn.cancel:hover {
            background-color: var(--gray-700);
        }

        .modal-btn.primary {
            background-color: var(--mj-blue);
            color: var(--white-color);
        }

        .modal-btn.primary:hover {
            background-color: #005a8a;
        }

        .modal-btn.danger {
            background-color: var(--error);
            color: var(--white-color);
        }

        .modal-btn.danger:hover {
            background-color: #b91c1c;
        }

        /* Members Modal */
        .members-modal {
            background-color: var(--white-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
        }

        .members-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .members-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .members-badge {
            padding: 2px 8px;
            background-color: var(--gray-600);
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .members-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .invite-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .invite-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .invite-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .invite-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-primary);
            background-color: var(--gray-600);
            transition: all 0.2s;
        }

        .invite-input:focus {
            outline: none;
            border-color: var(--mj-blue);
            background-color: var(--white-color);
        }

        .invite-btn {
            padding: 10px 24px;
            background-color: var(--mj-blue);
            color: var(--white-color);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .invite-btn:hover {
            background-color: #005a8a;
        }

        .invite-helper {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .members-list {
            margin-bottom: 32px;
        }

        .members-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.2s;
            margin-bottom: 8px;
            background-color: var(--gray-600);
        }

        .member-item:hover {
            background-color: var(--gray-700);
        }

        .member-item-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--navy);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            margin-right: 12px;
        }

        .member-item-info {
            flex: 1;
        }

        .member-item-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .member-item-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .member-item-role {
            padding: 4px 10px;
            background-color: var(--white-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            margin-right: 8px;
        }

        .member-item-role.owner {
            background-color: var(--mj-blue);
            color: var(--white-color);
            border-color: var(--mj-blue);
        }

        .member-item-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .member-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .member-action-btn:hover {
            background-color: var(--gray-700);
            color: var(--text-primary);
        }

        .member-action-btn.remove:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border-color: var(--error);
        }

        .member-action-btn i {
            font-size: 14px;
        }

        .permission-select {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-primary);
            background-color: var(--white-color);
            cursor: pointer;
            margin-right: 8px;
        }

        /* Invite Success Message */
        .invite-success {
            padding: 10px 14px;
            background-color: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.3);
            border-radius: 6px;
            color: var(--success);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .invite-success.show {
            display: flex;
        }

        .invite-success i {
            font-size: 14px;
        }
        .delete-warning {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: var(--error);
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-600);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-700);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-800);
        }


        /* Welcome Prompt */
        .welcome-prompt {
            padding: 24px;
        }
        
        /* Conversation History */
        .conversation-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }
        
        /* Artifact Inline Display - Enhanced */
        /* Modern Artifact Card Design */
        .artifact-inline {
            margin-top: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .artifact-inline:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 118, 182, 0.15);
            transform: translateY(-1px);
        }
        
        .artifact-inline::after {
            content: "Click to view in panel ";
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: var(--primary-color);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .artifact-inline:hover::after {
            opacity: 1;
        }
        
        .artifact-inline .artifact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-bottom: 1px solid var(--border-color);
        }
        
        .artifact-inline .artifact-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .artifact-inline .artifact-icon {
            font-size: 16px;
        }
        
        .artifact-inline .artifact-type {
            font-size: 11px;
            padding: 2px 8px;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
        }
        
        .artifact-version {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--gray-700);
            color: var(--text-secondary);
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }
        
        .fork-indicator {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--warning);
            color: white;
            border-radius: 4px;
            margin-left: 4px;
        }
        
        .fork-indicator i {
            font-size: 10px;
            margin-right: 2px;
        }
        
        
        .artifact-inline .artifact-preview {
            padding: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .artifact-inline .artifact-actions {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            background: #fafafa;
            border-top: 1px solid var(--border-color);
        }
        
        .artifact-inline .artifact-action {
            font-size: 12px;
            color: var(--primary-color);
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .artifact-inline .artifact-action:hover {
            background: rgba(0, 118, 182, 0.1);
        }

        /* Sticky Date Header */
        .sticky-date-header {
            position: sticky;
            top: 12px;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            pointer-events: none;
        }
        
        .sticky-date-wrapper {
            pointer-events: auto;
            position: relative;
        }

        .sticky-date-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            background: white;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
        }

        .sticky-date-button:hover {
            background: var(--gray-600);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .sticky-date-button i {
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Date Navigation Dropdown */
        .date-nav-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            display: none;
            z-index: 101;
        }

        .date-nav-dropdown.show {
            display: block;
        }

        .date-nav-option {
            padding: 10px 16px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--gray-600);
        }

        .date-nav-option:last-child {
            border-bottom: none;
        }

        .date-nav-option:hover {
            background: var(--gray-600);
        }

        .date-nav-option.jump-to {
            color: var(--mj-blue);
            font-weight: 500;
        }

        /* Date Separators - Simple lines like Slack */
        .date-separator {
            margin: 20px 24px;
            height: 1px;
            background: var(--border-color);
            position: relative;
        }

        /* Date Picker Modal */
        .date-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .date-picker-modal.show {
            display: flex;
        }

        .date-picker-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            min-width: 300px;
        }

        .date-picker-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .date-picker-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .date-picker-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .date-picker-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .date-picker-cancel {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .date-picker-cancel:hover {
            background: var(--gray-600);
        }

        .date-picker-submit {
            background: var(--mj-blue);
            color: white;
            border: none;
        }

        .date-picker-submit:hover {
            background: #005a8a;
        }

        .new-messages-separator {
            display: flex;
            align-items: center;
            margin: 16px 24px;
            position: relative;
        }

        .new-messages-separator::before {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--mj-blue);
        }

        .new-messages-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--mj-blue);
            padding: 4px 12px;
            background: white;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column-reverse;
            gap: 12px;
        }


        .toast.removing {
            animation: slideOutRight var(--transition-base) ease;
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background: var(--success);
            color: var(--white-color);
        }

        .toast.error .toast-icon {
            background: var(--error);
            color: var(--white-color);
        }

        .toast.info .toast-icon {
            background: var(--mj-blue);
            color: var(--white-color);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .toast-close {
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            transition: color var(--transition-fast);
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        /* Enhanced Message Edit Mode - Removed duplicate, using the one above */

        .edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            background: var(--white-color);
            color: var(--text-primary);
        }

        .edit-input:focus {
            outline: none;
            border-color: var(--mj-blue);
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .edit-btn {
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .edit-save {
            background: var(--mj-blue);
            color: var(--white-color);
            border: 1px solid var(--mj-blue);
        }

        .edit-save:hover {
            background: #005a8a;
            border-color: #005a8a;
        }

        .edit-cancel {
            background: var(--white-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .edit-cancel:hover {
            background: var(--gray-600);
        }

        .message-edited {
            font-size: 11px;
            color: #999;
            font-style: italic;
            font-weight: 400;
            margin-left: 8px;
        }

        /* Loading Skeletons */
        .skeleton-loader {
            display: flex;
            gap: 12px;
            padding: 12px 0;
        }

        .skeleton-avatar {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: linear-gradient(90deg, var(--gray-600) 25%, var(--gray-700) 50%, var(--gray-600) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-content {
            flex: 1;
        }

        .skeleton-line {
            height: 14px;
            background: linear-gradient(90deg, var(--gray-600) 25%, var(--gray-700) 50%, var(--gray-600) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        /* Enhanced Thread System */
        .thread-preview {
            display: none;
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(to right, var(--gray-600), transparent);
            border-left: 3px solid var(--mj-blue);
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .thread-preview.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .thread-preview:hover {
            background: linear-gradient(to right, var(--gray-700), transparent);
            transform: translateX(2px);
        }
        
        .thread-new-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 10px;
            min-width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            box-shadow: 0 1px 3px rgba(239, 68, 68, 0.3);
        }
        
        
        
        .thread-panel-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .thread-panel-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .thread-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .thread-reply-box {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        
        /* Enhanced Notification System */
        .notification-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.2);
                opacity: 0.7;
            }
        }
        
        .task-complete-badge {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .artifact-ready-badge {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }
        
        .mention-alert {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        /* Notification Center */
        .notification-center {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 320px;
            max-height: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: none;
            flex-direction: column;
        }
        
        .notification-center.open {
            display: flex;
        }
        
        .notification-center-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notification-center-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .mark-all-read {
            font-size: 12px;
            color: var(--mj-blue);
            cursor: pointer;
        }
        
        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .notification-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .notification-item:hover {
            background: var(--gray-700);
            transform: translateX(-2px);
        }
        
        .notification-item.unread {
            background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);
            border-left: 3px solid var(--mj-blue);
        }
        
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .notification-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .notification-time {
            font-size: 11px;
            color: var(--text-secondary);
            position: absolute;
            top: 12px;
            right: 12px;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .toast-close:hover {
            opacity: 1;
        }

        .thread-avatars {
            display: flex;
        }

        .thread-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--gray-600);
            margin-right: -6px;
            font-size: 9px;
            font-weight: 600;
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thread-info {
            flex: 1;
            font-size: 13px;
            color: var(--mj-blue);
            font-weight: 500;
        }

        .thread-timestamp {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* ========== ENHANCED SLIDING THREAD PANEL ========== */
        .thread-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            border-left: 1px solid var(--border-color);
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .thread-panel.open {
            transform: translateX(0);
        }
        
        .thread-panel-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-600);
        }
        
        .thread-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .thread-panel-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .thread-panel-close:hover {
            background: var(--gray-700);
            color: var(--text-primary);
        }
        
        .thread-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .thread-original-message {
            padding: 12px;
            background: var(--gray-600);
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 3px solid var(--mj-blue);
        }
        
        .thread-replies {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .thread-reply {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .thread-reply:hover {
            background: var(--gray-600);
        }
        
        .thread-reply-box {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: white;
        }
        
        .thread-reply-box textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: none;
            min-height: 60px;
            transition: all 0.2s;
        }
        
        .thread-reply-box textarea:focus {
            outline: none;
            border-color: var(--mj-blue);
        }
        
        .also-send-to-channel {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }
        
        .also-send-to-channel input[type="checkbox"] {
            cursor: pointer;
        }
        
        .also-send-to-channel:hover {
            color: var(--text-primary);
        }
        
        .thread-reply-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .thread-reply-box .send-btn {
            padding: 6px 16px;
            background: var(--mj-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .thread-reply-box .send-btn:hover:not(:disabled) {
            background: #005a8a;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .thread-reply-box .send-btn:active {
            transform: translateY(0);
        }
        
        .thread-reply-box .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Enhanced Typing Indicator */
        .typing-indicator-enhanced {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
        }

        .typing-agent-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--white-color);
        }

        .typing-agent-name {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
        }


        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .chat-actions {
                display: none;
            }
            
            .active-agents {
                padding: 2px 8px;
                font-size: 11px;
            }
            
            .agent-indicator {
                width: 20px;
                height: 20px;
            }
        }

        /* Shared Artifacts Dashboard */
        .shared-dashboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1002;
            animation: fadeIn 0.2s ease;
        }

        .shared-dashboard-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .shared-dashboard-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .shared-dashboard-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-700);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shared-dashboard-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .shared-dashboard-stats {
            display: flex;
            gap: 24px;
            padding: 16px 24px;
            background-color: var(--gray-600);
            border-bottom: 1px solid var(--gray-700);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--mj-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .shared-dashboard-filters {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--gray-700);
        }

        .filter-btn {
            padding: 6px 16px;
            height: 32px;
            border: 1px solid var(--gray-700);
            border-radius: 6px;
            background: white;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background-color: var(--mj-blue);
            color: white;
            border-color: var(--mj-blue);
        }

        .filter-btn:hover:not(.active) {
            background-color: var(--gray-600);
        }

        .shared-artifacts-grid {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        /* MJ Explorer Integration Styles */
        /* Breadcrumb Navigation */
        .mj-breadcrumb {
            position: fixed;
            top: 60px;
            left: 20px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        
        .breadcrumb-separator {
            color: var(--gray-800);
        }
        
        .breadcrumb-item {
            color: var(--mj-blue);
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .breadcrumb-item:hover {
            opacity: 0.8;
        }
        
        .breadcrumb-current {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* Libraries Section Styles */
        .libraries-section {
            border-top: 1px solid var(--border-color);
            margin-top: 16px;
            padding-top: 16px;
        }
        
        .library-folder {
            margin-bottom: 8px;
            background: var(--gray-600);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .library-folder:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .library-folder-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 12px;
            position: relative;
            z-index: 1;
            pointer-events: auto !important;
            background: white;
            user-select: none;
        }
        
        .library-folder-header:hover {
            background: var(--gray-600);
        }
        
        /* Library Action Buttons */
        .library-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .library-folder-header:hover .library-actions {
            opacity: 1;
        }
        
        .library-action-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .library-action-btn:hover {
            background: var(--gray-700);
            color: var(--mj-blue);
        }
        
        .library-action-btn.create {
            color: var(--success);
        }
        
        .library-action-btn.edit {
            color: var(--mj-blue);
        }
        
        .library-action-btn.delete {
            color: var(--error);
        }
        
        .library-folder-header:hover {
            background: var(--gray-600);
        }
        
        .library-folder-header.expanded {
            background: var(--gray-600);
        }
        
        .library-expand-icon {
            width: 20px;
            transition: transform 0.2s;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .library-folder-header.expanded .library-expand-icon {
            transform: rotate(90deg);
            color: var(--mj-blue);
        }
        
        .library-folder-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
        }
        
        .library-folder-name {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .library-count {
            font-size: 12px;
            color: white;
            background: var(--mj-blue);
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 500;
            min-width: 24px;
            text-align: center;
        }
        
        .library-items {
            display: none;
            background: var(--gray-600);
            padding: 12px 16px 16px 48px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid var(--border-color);
        }
        
        .library-items.expanded {
            display: block !important;
        }
        
        .library-folder-header.expanded + .library-items {
            display: block !important;
        }
        
        .library-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            background: white;
            margin-bottom: 6px;
            border: 1px solid var(--border-color);
            gap: 10px;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .library-item:hover {
            background: var(--gray-600);
            transform: translateX(4px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .library-item:last-child {
            margin-bottom: 0;
        }
        
        /* New artifact card styles within libraries */
        .library-artifact-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            height: 180px;
            display: flex;
            flex-direction: column;
        }
        
        .library-artifact-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
            border-color: var(--mj-blue);
        }
        
        .library-artifact-card:last-child {
            margin-bottom: 0;
        }
        
        .artifact-card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .artifact-card-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--mj-blue), #4A90E2);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .artifact-card-info {
            flex: 1;
            min-width: 0;
        }
        
        .artifact-card-title {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .artifact-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .artifact-type-badge {
            background: var(--mj-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .artifact-version-badge {
            background: var(--gray-700);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .artifact-date {
            color: var(--text-secondary);
            font-size: 11px;
        }
        
        .artifact-card-actions {
            display: flex;
            gap: 8px;
            opacity: 1;
            margin-left: auto;
        }
        
        .artifact-card-actions button {
            color: #6b7280;
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .artifact-card-actions button:hover {
            color: var(--text-primary);
        }
        
        .artifact-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
        }
        
        .artifact-action-btn {
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        
        .artifact-action-btn:hover {
            background: var(--mj-blue);
            color: white;
            border-color: var(--mj-blue);
        }
        
        .artifact-card-preview {
            margin-top: 8px;
            padding: 8px;
            background: var(--gray-600);
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
        }
        
        .library-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 13px;
            font-style: italic;
            background: var(--gray-600);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        /* Drag and drop visual feedback */
        .library-folder.drag-over .library-items {
            background: linear-gradient(to bottom, rgba(0, 101, 255, 0.05), rgba(0, 101, 255, 0.02));
            border-color: var(--mj-blue);
        }
        
        .library-folder.drag-over .library-empty {
            background: rgba(0, 101, 255, 0.1);
            border-color: var(--mj-blue);
            border-style: solid;
            transform: scale(1.02);
        }
        
        .library-artifact-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        
        /* Context Menu Styles */
        .library-context-menu {
            position: fixed;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            min-width: 180px;
        }
        
        .library-context-menu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: var(--hover-bg);
        }
        
        .context-menu-item i {
            width: 16px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 8px;
        }
        
        .library-folder-header.drag-over {
            background: linear-gradient(to right, rgba(0, 101, 255, 0.1), transparent);
            border-left-width: 5px !important;
        }
        
        .library-item-icon {
            width: 16px;
            opacity: 0.6;
        }
        
        .library-item.dragging {
            opacity: 0.5;
        }
        
        .library-folder-header.drag-over {
            background: rgba(0, 118, 182, 0.1);
            border: 1px dashed var(--mj-blue);
        }

        .shared-artifact-card {
            border: 1px solid var(--gray-700);
            border-radius: 8px;
            padding: 16px;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }

        .shared-artifact-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .artifact-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .artifact-card-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .artifact-card-type {
            font-size: 12px;
            color: var(--text-secondary);
            background-color: var(--gray-600);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .artifact-card-preview {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            height: 60px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .artifact-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .artifact-card-shared {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .artifact-card-collaborators {
            display: flex;
            margin-left: auto;
        }

        .mini-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            margin-left: -8px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .mini-avatar:first-child {
            margin-left: 0;
        }
        
        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }
        
        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            pointer-events: auto;
            animation: toastSlideIn 0.3s ease;
            transition: all 0.3s ease;
        }
        
        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.hiding {
            animation: toastSlideOut 0.3s ease;
        }
        
        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .toast.error .toast-icon {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .toast.warning .toast-icon {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .toast.info .toast-icon {
            background: rgba(0, 118, 182, 0.1);
            color: var(--mj-blue);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .toast-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            background: var(--gray-600);
            color: var(--text-primary);
        }
        
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--mj-blue);
            border-radius: 0 0 0 8px;
            animation: toastProgress 5s linear;
        }
        
        @keyframes toastProgress {
            from {
                width: 100%;
            }
            to {
                width: 0;
            }
        }

        /* Universal Delete Modal Styles */
        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .delete-modal.show {
            display: flex;
        }

        .delete-modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .delete-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .delete-modal-icon {
            color: #DC2626;
            font-size: 24px;
        }

        .delete-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .delete-modal-body {
            color: #666;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .delete-item-name {
            font-weight: 600;
            color: #333;
            background: #F4F4F4;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-family: monospace;
        }

        .delete-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Reminder Modal Styles */
        .reminder-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .reminder-modal.show {
            display: flex;
        }

        .reminder-modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .reminder-modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .reminder-quick-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .reminder-quick-option {
            padding: 10px;
            border: 1px solid #D9D9D9;
            border-radius: 6px;
            background: #F4F4F4;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 14px;
        }

        .reminder-quick-option:hover {
            background: #AAE7FD;
            border-color: #0076B6;
        }

        .reminder-custom-time {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #D9D9D9;
        }

        .reminder-custom-time label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #666;
        }

        .reminder-custom-time input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #D9D9D9;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .reminder-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Notification Center -->
    <div class="notification-center" id="notificationCenter">
        <div class="notification-center-header">
            <span class="notification-center-title">Notifications</span>
            <span class="mark-all-read" onclick="markAllRead()">Mark all read</span>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be populated here -->
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Thread Panel -->
    <div class="thread-panel" id="threadPanel">
        <div class="thread-panel-header">
            <span class="thread-panel-title">Thread</span>
            <button class="close-btn" onclick="closeThreadPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="thread-messages" id="threadMessages"></div>
        <div class="thread-reply-box">
            <textarea placeholder="Reply in thread..." rows="3"></textarea>
            <div class="thread-reply-actions">
                <div class="also-send-to-channel">
                    <input type="checkbox" id="alsoSendToChannel">
                    <label for="alsoSendToChannel">Also send to channel</label>
                </div>
                <button class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Navigation -->
    <div class="main-navigation">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchToView('chats')" data-view="chats">
                <i class="fas fa-comments"></i>
                <span>Chats</span>
            </button>
            <button class="nav-tab" onclick="switchToView('libraries')" data-view="libraries">
                <i class="fas fa-folder"></i>
                <span>Libraries</span>
            </button>
        </div>
        <div class="nav-actions">
            <button class="nav-action" onclick="toggleSettings()" title="Settings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="nav-action" onclick="toggleProfile()" title="Profile">
                <i class="fas fa-user-circle"></i>
            </button>
        </div>
    </div>
    
    <div class="workspace-container">
        <!-- Left Sidebar -->
        <div class="sidebar" id="chatSidebar">
            <!-- Sidebar Header -->
            <div class="workspace-header">
                <div class="sidebar-title">
                    <i class="fas fa-comments"></i>
                    <span>Conversations</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="new-chat-btn" onclick="createNewChat(event)">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>

            <!-- Search -->
            <div class="sidebar-search">
                <input type="text" class="sidebar-search-input" placeholder="Search chats..." onkeyup="searchChats(event)">
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Direct Messages Section -->
                <div class="sidebar-section">
                    <div class="section-header expanded" onclick="toggleSection(this)">
                        <div class="section-title">
                            <i class="fas fa-chevron-right"></i>
                            <span>Direct Messages</span>
                        </div>
                        <button class="section-action" onclick="createNewDM(event)" title="New DM">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="chat-list expanded" id="dmsList">
                        <div class="chat-item active" onclick="selectChat(this, 'dm-you-claude', 'dm')" data-chat-id="dm-you-claude" data-chat-type="dm">
                            <i class="fas fa-at chat-icon"></i>
                            <span class="chat-name">You & Claude</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleChatMenu(event, 'current')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-item" onclick="selectChat(this, 'dm-you-skip', 'dm')" data-chat-id="dm-you-skip" data-chat-type="dm">
                            <i class="fas fa-at chat-icon"></i>
                            <span class="chat-name">You & Skip</span>
                            <span class="project-badge project-mobile">Mobile</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleChatMenu(event, 'api-integration')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-item" onclick="selectChat(this, 'dm-team', 'dm')" data-chat-id="dm-team" data-chat-type="dm">
                            <i class="fas fa-at chat-icon"></i>
                            <span class="chat-name">Team Discussion</span>
                            <span class="project-badge project-website">Website</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleChatMenu(event, 'design-feedback')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Channels Section -->
                <div class="sidebar-section">
                    <div class="section-header expanded" onclick="toggleSection(this)">
                        <div class="section-title">
                            <i class="fas fa-chevron-right"></i>
                            <span>Channels</span>
                        </div>
                        <button class="section-action" onclick="createNewChannel(event)" title="New channel">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="chat-list expanded" id="channelsList">
                        <div class="chat-item" onclick="selectChat(this, 'channel-general', 'channel')" data-chat-id="channel-general" data-chat-type="channel">
                            <i class="fas fa-hashtag chat-icon"></i>
                            <span class="chat-name">general</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleChatMenu(event, 'channel-general')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-item" onclick="selectChat(this, 'channel-lca-working', 'channel')" data-chat-id="channel-lca-working" data-chat-type="channel">
                            <i class="fas fa-hashtag chat-icon"></i>
                            <span class="chat-name">lca-working-group</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleChatMenu(event, 'channel-lca-working')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-item" onclick="selectChat(this, 'channel-engineering', 'channel')" data-chat-id="channel-engineering" data-chat-type="channel">
                            <i class="fas fa-hashtag chat-icon"></i>
                            <span class="chat-name">engineering</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleChatMenu(event, 'channel-engineering')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projects (Temporary, Goal-Oriented) -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection(this)" title="Organize chats by project (optional)">
                        <div class="section-title">
                            <i class="fas fa-chevron-right"></i>
                            <span>Projects</span>
                            <span style="font-size: 11px; color: var(--text-secondary); margin-left: 8px;">(optional)</span>
                        </div>
                        <div class="section-actions">
                            <div class="add-btn" onclick="createNewProject(event)" title="New Project">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                    </div>
                    <div class="chat-list" id="projectsList">
                        <div class="chat-item" onclick="handleProjectClick(event, 'website')" data-project-id="website">
                            <i class="fas fa-folder chat-icon" style="color: #4A90E2;"></i>
                            <span class="chat-name">Website Redesign</span>
                            <span class="project-badge">1 chat</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleProjectMenu(event, 'website')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-item" onclick="handleProjectClick(event, 'mobile')" data-project-id="mobile">
                            <i class="fas fa-folder chat-icon" style="color: #7ED321;"></i>
                            <span class="chat-name">Mobile App</span>
                            <span class="project-badge">1 chat</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleProjectMenu(event, 'mobile')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chat-item" onclick="handleProjectClick(event, 'data')" data-project-id="data">
                            <i class="fas fa-folder chat-icon" style="color: #BD10E0;"></i>
                            <span class="chat-name">Data Analysis</span>
                            <span class="project-badge">1 chat</span>
                            <div class="chat-actions">
                                <button class="chat-action-btn" onclick="toggleProjectMenu(event, 'data')" title="Options">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
        
        <!-- Libraries Sidebar (Hidden by default) -->

        <!-- Main Chat Area -->
        <div class="main-content" id="chatView">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-title" id="chatTitle">Quick Question</div>
                    <button class="project-tag" id="chatProjectTag" onclick="showProjectSelector()" title="Assign to project" style="display: none;">
                        <i class="fas fa-folder"></i>
                        <span id="chatProjectName">No Project</span>
                    </button>
                    <button class="chat-members" onclick="toggleMembersModal()" title="View members">
                        <i class="fas fa-users"></i>
                        <span id="memberCountLabel">3 members</span>
                    </button>
                    <button class="artifact-indicator" onclick="openSharedArtifactsDashboard()" title="View artifacts" style="background: var(--mj-blue); color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; margin-left: 8px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-cube"></i>
                        <span>3 artifacts</span>
                    </button>
                    <button class="active-tasks-btn" id="activeTasksBtn" onclick="toggleActiveTasksDropdown()" title="View active tasks" style="background: var(--gray-700); color: var(--text-primary); padding: 6px 12px; border-radius: 6px; font-size: 13px; margin-left: 8px; display: none; align-items: center; gap: 6px; position: relative; border: 1px solid var(--border-color);">
                        <i class="fas fa-tasks"></i>
                        <span>Tasks</span>
                        <span class="task-count-badge" id="taskCountBadge" style="background: var(--navy); color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: bold; min-width: 18px; text-align: center;">0</span>
                    </button>
                    <div class="active-agents">
                        <span class="active-agents-label">Active:</span>
                        <div class="agent-indicator active" style="background-color: var(--agent-claude);" title="Claude">C</div>
                        <div class="agent-indicator" style="background-color: var(--agent-research);" title="Research Agent">R</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn" onclick="openSharedArtifactsDashboard()" title="View shared artifacts">
                        <i class="fas fa-share-alt"></i>
                        Shared
                    </button>
                    <button class="action-btn" onclick="forkChat()">
                        <i class="fas fa-code-branch"></i>
                        Fork
                    </button>
                    <button class="action-btn" onclick="exportChat()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="action-btn" onclick="shareChat()">
                        <i class="fas fa-share-nodes"></i>
                        Share
                    </button>
                </div>
            </div>

            <!-- Active Tasks Dropdown Panel -->
            <div class="active-tasks-dropdown" id="activeTasksDropdown" style="position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 400px; max-width: 500px; display: none;">
                <div class="dropdown-header" style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-tasks" style="color: var(--accent);"></i>
                        <span style="font-weight: 600; color: var(--text-primary);">Active Tasks</span>
                    </div>
                    <button onclick="closeActiveTasksDropdown()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="dropdown-content" id="activeTasksDropdownContent" style="max-height: 400px; overflow-y: auto; padding: 8px;">
                    <!-- Task items will be rendered here -->
                </div>
            </div>

            <!-- Search Bar -->
            <div class="chat-search-bar">
                <div class="chat-search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" class="chat-search-input" placeholder="Search in this chat..." onkeyup="searchInChat(event)">
                    <button class="clear-search-btn" onclick="clearSearch()" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Pinned Messages Section -->
                <div class="pinned-messages" id="pinnedMessages" style="display: none;">
                    <div class="pinned-header">
                        <i class="fas fa-thumbtack"></i>
                        <span>Pinned Messages</span>
                        <button class="pinned-toggle" onclick="togglePinnedMessages()">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="pinned-list" id="pinnedList">
                        <!-- Pinned messages will appear here -->
                    </div>
                </div>
                <!-- Multi-Day Conversation Example -->
                <div class="conversation-history" id="conversationHistory">
                    <!-- Sticky Date Header (overlays on top of messages) -->
                    <div class="sticky-date-header" id="stickyDateHeader">
                        <div class="sticky-date-wrapper">
                            <button class="sticky-date-button" onclick="toggleDateNav()">
                                <span id="currentDateDisplay">Today</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="date-nav-dropdown" id="dateNavDropdown">
                                <div class="date-nav-option jump-to">Jump to...</div>
                                <div class="date-nav-option" onclick="jumpToDate('today')">Today</div>
                                <div class="date-nav-option" onclick="jumpToDate('yesterday')">Yesterday</div>
                                <div class="date-nav-option" onclick="jumpToDate('last-week')">Last week</div>
                                <div class="date-nav-option" onclick="jumpToDate('last-month')">Last month</div>
                                <div class="date-nav-option" onclick="openDatePicker()">Jump to a specific date</div>
                            </div>
                        </div>
                    </div>
                    <!-- Monday, 3 days ago -->
                    <div class="date-separator" data-date="2024-12-23"></div>
                    
                    <div class="message human-message" id="msg-1">
                        <div class="message-avatar human-avatar user-avatar">JD</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">John Doe</span>
                                <span class="message-time">9:15 AM</span>
                            </div>
                            <div class="message-text" id="msg-text-1">Can you document our authentication API? I need a comprehensive reference guide for the team.</div>
                            <div class="message-edit-mode" id="msg-edit-1">
                                <textarea class="message-edit-input" id="msg-input-1">Hey team, I need help setting up the new authentication system for our API. Can someone assist with implementing OAuth2?</textarea>
                                <div class="message-edit-actions">
                                    <button class="message-edit-btn message-edit-cancel" onclick="cancelEdit('1')">Cancel</button>
                                    <button class="message-edit-btn message-edit-save" onclick="saveEdit('1')">Save</button>
                                </div>
                            </div>
                        </div>
                        <div class="message-actions">
                            <button class="message-action" onclick="editMessage('1')" title="Edit message">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="message-action" onclick="deleteMessage('msg-1')" title="Delete message">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-claude);">
                            C
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Claude</span>
                                <span class="agent-badge">AI Assistant</span>
                                <span class="message-time">9:16 AM</span>
                            </div>
                            <div class="message-text">I'll help you set up OAuth2 authentication for your API. Let me bring in the Code Agent to assist with the implementation details.</div>
                            <div class="agent-feedback">
                                <button class="feedback-btn" onclick="toggleFeedback(this, 'like', 'msg-claude-1')">
                                    <i class="far fa-thumbs-up"></i>
                                    <span class="feedback-count">0</span>
                                </button>
                                <button class="feedback-btn" onclick="toggleFeedback(this, 'dislike', 'msg-claude-1')">
                                    <i class="far fa-thumbs-down"></i>
                                    <span class="feedback-count">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-code);">
                            CA
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Code Agent</span>
                                <span class="agent-badge">Code Expert</span>
                                <span class="message-time">9:16 AM</span>
                            </div>
                            <div class="message-text">I'll create comprehensive API documentation for your authentication endpoints. Let me generate a detailed reference guide...</div>
                            <div class="artifact-inline" onclick="openArtifact('artifact-1', 'API Documentation', 'markdown')">
                                <div class="artifact-header">
                                    <span class="artifact-title">
                                        <span class="artifact-icon"></span>
                                        API Authentication Documentation
                                    </span>
                                    <span class="artifact-type markdown">markdown</span>
                                </div>
                                <div class="artifact-preview">## Authentication API Reference\n\n### POST /auth/login\nAuthenticates a user and returns access tokens...</div>
                                <div class="artifact-actions" onclick="event.stopPropagation()">
                                    <button class="artifact-action" onclick="saveArtifactToLibrary('artifact-1', 'API Authentication Documentation', 'markdown')">
                                        <i class="fas fa-folder-plus"></i> Save
                                    </button>
                                    <button class="artifact-action" onclick="shareArtifact('artifact-1')">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                    <button class="artifact-action" onclick="exportArtifact('artifact-1')">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div class="agent-feedback">
                                <button class="feedback-btn liked" onclick="toggleFeedback(this, 'like', 'msg-code-1')">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="feedback-count">3</span>
                                </button>
                                <button class="feedback-btn" onclick="toggleFeedback(this, 'dislike', 'msg-code-1')">
                                    <i class="far fa-thumbs-down"></i>
                                    <span class="feedback-count">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tuesday, 2 days ago -->
                    <div class="date-separator" data-date="2024-12-24"></div>
                    
                    <div class="message human-message">
                        <div class="message-avatar human-avatar user-avatar">SM</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Sarah Miller</span>
                                <span class="message-time">10:30 AM</span>
                            </div>
                            <div class="message-text">Can you analyze our user engagement metrics from last month? I need insights on user retention and growth.</div>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-analysis);">
                            AA
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Analysis Agent</span>
                                <span class="agent-badge">Data Analyst</span>
                                <span class="message-time">10:31 AM</span>
                            </div>
                            <div class="message-text">I'm analyzing your engagement data now. Let me create an interactive dashboard with the key metrics and trends...</div>
                        </div>
                    </div>
                    
                    <div class="message human-message">
                        <div class="message-avatar human-avatar user-avatar">MR</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Mike Roberts</span>
                                <span class="message-time">2:45 PM</span>
                            </div>
                            <div class="message-text">Can we also get some analytics on API usage? I'd like to track authentication success rates and identify any bottlenecks.</div>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-analysis);">
                            AA
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Analysis Agent</span>
                                <span class="agent-badge">Data Analyst</span>
                                <span class="message-time">2:46 PM</span>
                            </div>
                            <div class="message-text">I've analyzed your user engagement data and created an interactive visualization showing key metrics and trends.</div>
                            <div class="artifact-inline" onclick="openArtifact('artifact-2', 'User Engagement Analytics', 'chart')">
                                <div class="artifact-header">
                                    <span class="artifact-title">
                                        <span class="artifact-icon"></span>
                                        User Engagement Analytics
                                    </span>
                                    <span class="artifact-type chart">chart</span>
                                </div>
                                <div class="artifact-preview">Daily Active Users: 12.5K | Monthly Growth: +23% | Retention Rate: 87%...</div>
                                <div class="artifact-actions" onclick="event.stopPropagation()">
                                    <button class="artifact-action" onclick="saveArtifactToLibrary('artifact-2', 'User Engagement Analytics', 'chart')">
                                        <i class="fas fa-folder-plus"></i> Save
                                    </button>
                                    <button class="artifact-action" onclick="shareArtifact('artifact-2')">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                    <button class="artifact-action" onclick="exportArtifact('artifact-2')">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Wednesday (Yesterday) -->
                    <div class="date-separator" data-date="yesterday"></div>
                    
                    <div class="message human-message">
                        <div class="message-avatar human-avatar user-avatar">JD</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">John Doe</span>
                                <span class="message-time">11:20 AM</span>
                            </div>
                            <div class="message-text">Can you create a React component for the login screen? It should match our design system and include form validation.</div>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-code);">
                            CA
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Code Agent</span>
                                <span class="agent-badge">Code Expert</span>
                                <span class="message-time">11:21 AM</span>
                            </div>
                            <div class="message-text">I'll create a secure React login component with built-in validation and error handling. Generating the component now...</div>
                            <div class="artifact-inline" onclick="openArtifact('artifact-3', 'React Login Component', 'code')">
                                <div class="artifact-header">
                                    <span class="artifact-title">
                                        <span class="artifact-icon"></span>
                                        React Login Component
                                    </span>
                                    <span class="artifact-type code">
                                        code
                                        <span class="artifact-new-badge" id="artifact-3-new-badge">NEW</span>
                                    </span>
                                </div>
                                <div class="artifact-preview">import React, { useState } from 'react';\nconst LoginForm = () => { ...</div>
                                <div class="artifact-actions" onclick="event.stopPropagation()">
                                    <button class="artifact-action" onclick="saveArtifactToLibrary('artifact-3', 'React Login Component', 'code')">
                                        <i class="fas fa-folder-plus"></i> Save
                                    </button>
                                    <button class="artifact-action" onclick="shareArtifact('artifact-3')">
                                        <i class="fas fa-share"></i> Share
                                    </button>
                                    <button class="artifact-action" onclick="exportArtifact('artifact-3')">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Messages Divider -->
                    <div class="new-messages-separator">
                        <span class="new-messages-text">New Messages</span>
                    </div>
                    
                    <!-- Today -->
                    <div class="date-separator" data-date="today"></div>
                    
                    <div class="message human-message">
                        <div class="message-avatar human-avatar user-avatar">SM</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Sarah Miller</span>
                                <span class="message-time">9:05 AM</span>
                            </div>
                            <div class="message-text">Good morning! The rate limiting is working perfectly. We caught several attempted brute force attacks overnight. Can you help us set up alerting for suspicious activity?</div>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-claude);">
                            C
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Claude</span>
                                <span class="agent-badge">AI Assistant</span>
                                <span class="message-time">9:06 AM</span>
                            </div>
                            <div class="message-text">Great to hear the rate limiting is effective! I'll coordinate with both the Code Agent and Analysis Agent to set up comprehensive security alerting.</div>
                        </div>
                    </div>
                    
                    <div class="message ai-message">
                        <div class="message-avatar ai-avatar agent-message-avatar" style="background-color: var(--agent-analysis);">
                            AA
                            <span class="ai-indicator">AI</span>
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Analysis Agent</span>
                                <span class="agent-badge">Data Analyst</span>
                                <span class="message-time">9:07 AM</span>
                            </div>
                            <div class="message-text">I've configured anomaly detection algorithms to identify suspicious patterns. You'll receive alerts for: unusual login locations, multiple failed attempts, and abnormal traffic spikes.</div>
                        </div>
                    </div>
                    
                    <div class="message human-message">
                        <div class="message-avatar human-avatar user-avatar">MR</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Mike Roberts</span>
                                <span class="message-time">just now</span>
                            </div>
                            <div class="message-text">Perfect! Can you share the alert configuration as an artifact so we can review it with the security team?</div>
                        </div>
                    </div>
                </div>
                <!-- Welcome Message with Features (hidden by default) -->
                <div class="message" id="message-1" style="display: none;">
                    <div class="message-avatar agent-message-avatar" style="background-color: #9b59b6;">
                        C
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">Claude</span>
                            <span class="agent-badge">AI Assistant</span>
                            <span class="message-time">10:30 AM</span>
                        </div>
                        <div class="message-text" id="message-text-1">
                            Hello! I'm ready to help you with your questions. I'll automatically bring in specialized agents as needed based on what you're working on. What can I assist you with today?
                        </div>
                        <div class="message-edit-mode" id="edit-mode-1">
                            <textarea class="edit-input" id="edit-input-1">Hello! I'm ready to help you with your questions.</textarea>
                            <div class="edit-actions">
                                <button class="edit-btn edit-save" onclick="saveEdit(1)">Save</button>
                                <button class="edit-btn edit-cancel" onclick="cancelEdit(1)">Cancel</button>
                            </div>
                        </div>
                        <div class="message-actions">
                            <button class="message-action" onclick="copyMessage(1)">Copy</button>
                            <button class="message-action" onclick="forkFromMessage(1)">Fork</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Container -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)"
                        onkeydown="handleInputKeydown(event)"
                    ></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="input-options">
                    <button class="input-option" onclick="attachFile()">
                        <i class="fas fa-paperclip"></i>
                        Attach File
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Libraries View (Full Panel, Hidden by default) -->
    <div class="libraries-view" id="librariesView" style="display: none;">
        <div class="libraries-header">
            <div class="libraries-breadcrumb" id="libraryBreadcrumb">
                <div class="breadcrumb-item">
                    <i class="fas fa-home"></i>
                    <a class="breadcrumb-link" onclick="showLibrariesLandingPage()" style="cursor: pointer; text-decoration: none; color: var(--text-primary);">Libraries</a>
                </div>
                <span id="breadcrumbPath"></span>
            </div>
            <div class="libraries-search">
                <i class="fas fa-search"></i>
                <input type="text" 
                       id="librarySearchInput" 
                       placeholder="Search libraries and artifacts..." 
                       onkeyup="searchLibraries(this.value)"
                       class="library-search-input">
            </div>
            <div class="libraries-actions">
                <button class="btn-secondary" onclick="librariesManager.renderLibraries();" title="Refresh">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
        </div>
        <div class="libraries-content" id="librariesContent">
            <!-- Libraries folders will be populated here -->
            <div class="library-folders">
                <!-- Library folders structure will be rendered here -->
            </div>
        </div>
    </div>

    <!-- V4: Artifact Side Panel -->
    <div class="artifact-panel" id="artifactPanel">
        <div class="artifact-panel-resize"></div>
        <div class="artifact-panel-header">
            <div class="artifact-panel-title">
                <i class="fas fa-file-alt"></i>
                <span id="artifactPanelTitle">Artifact Title</span>
            </div>
            <div class="artifact-panel-actions">
                <button class="artifact-share-button" onclick="openShareModal()" title="Share">
                    <i class="fas fa-share"></i>
                    <span>Share</span>
                </button>
                <button class="artifact-panel-action" onclick="copyArtifactContent()" title="Copy">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="artifact-panel-action" onclick="downloadArtifact()" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="artifact-panel-action" onclick="maximizeArtifact()" title="Maximize">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="artifact-panel-close" onclick="closeArtifactPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="artifact-panel-tabs">
            <button class="artifact-panel-tab active" onclick="switchPanelTab('preview')">Preview</button>
            <button class="artifact-panel-tab" onclick="switchPanelTab('source')">Source</button>
            <button class="artifact-panel-tab" onclick="switchPanelTab('history')">History</button>
        </div>
        <div class="artifact-panel-content" id="artifactPanelContent">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>

    <!-- V5: Share Artifact Modal -->
    <div class="share-modal-overlay" id="shareModal">
        <div class="share-modal" style="position: relative;">
            <button class="share-modal-close" onclick="closeShareModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="share-modal-header">
                <h3 class="share-modal-title">
                    <i class="fas fa-share"></i>
                    Share Artifact
                </h3>
            </div>
            <div class="share-modal-body">
                <!-- Share Link Section -->
                <div class="share-link-section">
                    <div class="share-link-label">Share Link</div>
                    <div class="share-link-input-group">
                        <input type="text" class="share-link-input" id="shareLink" readonly value="https://agentchat.com/artifact/abc123">
                        <button class="share-link-copy-btn" onclick="copyShareLink()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>

                <!-- Permissions Section -->
                <div class="permissions-section">
                    <div class="permissions-title">Access Permissions</div>
                    <div class="permission-option selected" onclick="selectPermission(this, 'view')">
                        <input type="radio" name="permission" class="permission-radio" checked>
                        <div class="permission-info">
                            <div class="permission-name">View Only</div>
                            <div class="permission-desc">Users can view but not edit the artifact</div>
                        </div>
                    </div>
                    <div class="permission-option" onclick="selectPermission(this, 'comment')">
                        <input type="radio" name="permission" class="permission-radio">
                        <div class="permission-info">
                            <div class="permission-name">Can Comment</div>
                            <div class="permission-desc">Users can view and add comments</div>
                        </div>
                    </div>
                    <div class="permission-option" onclick="selectPermission(this, 'edit')">
                        <input type="radio" name="permission" class="permission-radio">
                        <div class="permission-info">
                            <div class="permission-name">Can Edit</div>
                            <div class="permission-desc">Users can view, comment, and edit</div>
                        </div>
                    </div>
                </div>

                <!-- Shared With Section -->
                <div class="shared-with-section">
                    <div class="shared-with-title">Shared With</div>
                    <div class="shared-user-list" id="sharedUsersList">
                        <div class="shared-user-item">
                            <div class="shared-user-info">
                                <div class="shared-user-avatar" style="background: var(--mj-blue);">JD</div>
                                <div class="shared-user-details">
                                    <div class="shared-user-name">John Doe</div>
                                    <div class="shared-user-permission">Can View</div>
                                </div>
                            </div>
                            <button class="remove-share-btn" onclick="removeShare('john')">Remove</button>
                        </div>
                        <div class="shared-user-item">
                            <div class="shared-user-info">
                                <div class="shared-user-avatar" style="background: var(--agent-research);">SM</div>
                                <div class="shared-user-details">
                                    <div class="shared-user-name">Sarah Miller</div>
                                    <div class="shared-user-permission">Can Edit</div>
                                </div>
                            </div>
                            <button class="remove-share-btn" onclick="removeShare('sarah')">Remove</button>
                        </div>
                    </div>
                </div>

                <!-- Share Settings -->
                <div class="share-settings">
                    <div class="share-setting-item">
                        <span class="share-setting-label">Allow public access</span>
                        <label class="share-toggle">
                            <input type="checkbox" id="publicAccess">
                            <span class="share-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="share-setting-item">
                        <span class="share-setting-label">Allow downloads</span>
                        <label class="share-toggle">
                            <input type="checkbox" id="allowDownloads" checked>
                            <span class="share-toggle-slider"></span>
                        </label>
                    </div>
                    <div class="share-setting-item">
                        <span class="share-setting-label">Expire after 30 days</span>
                        <label class="share-toggle">
                            <input type="checkbox" id="expireShare">
                            <span class="share-toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Members Modal -->
    <div class="modal-overlay" id="membersModal">
        <div class="members-modal" style="position: relative;">
            <button class="modal-close" onclick="closeMembersModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="members-modal-header">
                <h3 class="members-modal-title">
                    <i class="fas fa-users"></i>
                    Chat Members
                    <span class="members-badge" id="totalMembersBadge">3 members</span>
                </h3>
            </div>
            <div class="members-modal-body">
                <!-- Invite Section -->
                <div class="invite-section">
                    <h4 class="invite-title">Invite People</h4>
                    <div class="invite-success" id="inviteSuccess">
                        <i class="fas fa-check-circle"></i>
                        Invitation sent successfully!
                    </div>
                    <div class="invite-input-group">
                        <input type="email" class="invite-input" id="inviteEmail" placeholder="Enter email address">
                        <button class="invite-btn" onclick="inviteMember()">Send Invite</button>
                    </div>
                    <p class="invite-helper">Invite team members to collaborate in this chat</p>
                </div>

                <!-- Current Members -->
                <div class="members-list">
                    <div class="members-section-title">
                        <i class="fas fa-user-friends"></i>
                        Current Members
                    </div>
                    
                    <!-- Owner -->
                    <div class="member-item">
                        <div class="member-item-avatar">U</div>
                        <div class="member-item-info">
                            <div class="member-item-name">You</div>
                            <div class="member-item-email">user@example.com</div>
                        </div>
                        <span class="member-item-role owner">Owner</span>
                    </div>

                    <!-- Member 1 -->
                    <div class="member-item" id="member-john">
                        <div class="member-item-avatar" style="background-color: var(--mj-blue);">J</div>
                        <div class="member-item-info">
                            <div class="member-item-name">John Smith</div>
                            <div class="member-item-email">john@example.com</div>
                        </div>
                        <select class="permission-select" onchange="updatePermission('john', this.value)">
                            <option value="edit">Can Edit</option>
                            <option value="view">Can View</option>
                        </select>
                        <button class="member-action-btn remove" onclick="removeMember('john')" title="Remove member">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    </div>

                    <!-- Member 2 -->
                    <div class="member-item" id="member-sarah">
                        <div class="member-item-avatar" style="background-color: var(--agent-research);">S</div>
                        <div class="member-item-info">
                            <div class="member-item-name">Sarah Johnson</div>
                            <div class="member-item-email">sarah@example.com</div>
                        </div>
                        <select class="permission-select" onchange="updatePermission('sarah', this.value)">
                            <option value="edit">Can Edit</option>
                            <option value="view" selected>Can View</option>
                        </select>
                        <button class="member-action-btn remove" onclick="removeMember('sarah')" title="Remove member">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    </div>
                </div>

                <!-- AI Agents Section -->
                <div class="members-list">
                    <div class="members-section-title">
                        <i class="fas fa-robot"></i>
                        Active AI Agents
                    </div>
                    
                    <div class="member-item">
                        <div class="member-item-avatar" style="background-color: var(--agent-claude);">C</div>
                        <div class="member-item-info">
                            <div class="member-item-name">Claude</div>
                            <div class="member-item-email">AI Assistant</div>
                        </div>
                        <span class="member-item-role" style="background-color: var(--success); color: white;">Active</span>
                    </div>

                    <div class="member-item">
                        <div class="member-item-avatar" style="background-color: var(--agent-research);">R</div>
                        <div class="member-item-info">
                            <div class="member-item-name">Research Agent</div>
                            <div class="member-item-email">Research Specialist</div>
                        </div>
                        <span class="member-item-role">Available</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="renameFromContext()">
            <i class="fas fa-pencil"></i>
            <span>Rename</span>
        </div>
        <div class="context-menu-item" onclick="duplicateChat()">
            <i class="fas fa-copy"></i>
            <span>Duplicate</span>
        </div>
        <div class="context-menu-item" onclick="starChat()">
            <i class="fas fa-star"></i>
            <span>Star</span>
        </div>
        <div class="context-menu-item" onclick="showProjectSelector()">
            <i class="fas fa-folder"></i>
            <span>Add to Project</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" onclick="exportFromContext()">
            <i class="fas fa-download"></i>
            <span>Export</span>
        </div>
        <div class="context-menu-item" onclick="archiveChat()">
            <i class="fas fa-archive"></i>
            <span>Archive</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item danger" onclick="deleteFromContext()">
            <i class="fas fa-trash"></i>
            <span>Delete</span>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rename Chat</h3>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="renameInput" placeholder="Enter new name">
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeRenameModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmRename()">Rename</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Delete Chat</h3>
            </div>
            <div class="modal-body">
                <div class="delete-warning">
                    <strong>Warning:</strong> This action cannot be undone. All messages and artifacts in this chat will be permanently deleted.
                </div>
                <p style="font-size: 14px; color: var(--text-primary);">
                    Are you sure you want to delete "<span id="deleteChatName"></span>"?
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDelete()">Delete Chat</button>
            </div>
        </div>
    </div>

    <!-- Shared Artifacts Dashboard Modal -->
    <div class="shared-dashboard-modal" id="sharedDashboardModal">
        <div class="shared-dashboard-content">
            <div class="shared-dashboard-header">
                <h2 class="shared-dashboard-title">Shared Artifacts</h2>
                <button class="close-btn" onclick="closeSharedDashboard()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="shared-dashboard-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalSharedCount">12</div>
                    <div class="stat-label">Total Shared</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="activeCollaboratorsCount">8</div>
                    <div class="stat-label">Collaborators</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="recentActivityCount">3</div>
                    <div class="stat-label">Active Today</div>
                </div>
            </div>
            
            <div class="shared-dashboard-filters">
                <button class="filter-btn active" onclick="filterSharedArtifacts('all')">All</button>
                <button class="filter-btn" onclick="filterSharedArtifacts('owned')">Created by Me</button>
                <button class="filter-btn" onclick="filterSharedArtifacts('shared-with-me')">Shared with Me</button>
                <button class="filter-btn" onclick="filterSharedArtifacts('public')">Public</button>
            </div>
            
            <div class="shared-artifacts-grid" id="sharedArtifactsGrid">
                <!-- Artifacts will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Enhanced Agent System with Capabilities
        const agents = {
            claude: { 
                name: 'Claude', 
                color: 'var(--agent-claude)', 
                avatar: 'C', 
                role: 'AI Assistant',
                capabilities: ['general', 'help', 'explain', 'summarize', 'coordinate'],
                confidence: 0.95
            },
            skip: { 
                name: 'Skip', 
                color: 'var(--agent-skip)', 
                avatar: 'S', 
                role: 'Analytics Expert',
                capabilities: ['analyze', 'report', 'data', 'metrics', 'dashboard', 'statistics'],
                confidence: 0.92
            },
            research: { 
                name: 'Research Agent', 
                color: 'var(--agent-research)', 
                avatar: 'R', 
                role: 'Research Specialist',
                capabilities: ['research', 'study', 'investigate', 'explore', 'discover', 'find'],
                confidence: 0.88
            },
            designer: { 
                name: 'Design Agent', 
                color: 'var(--agent-designer)', 
                avatar: 'D', 
                role: 'Design Expert',
                capabilities: ['design', 'ui', 'ux', 'mockup', 'prototype', 'wireframe', 'layout'],
                confidence: 0.90
            },
            coder: { 
                name: 'Code Agent', 
                color: 'var(--agent-coder)', 
                avatar: 'CD', 
                role: 'Development Expert',
                capabilities: ['code', 'implement', 'debug', 'function', 'api', 'develop', 'program'],
                confidence: 0.93
            },
            analyst: { 
                name: 'Analysis Agent', 
                color: 'var(--agent-analyst)', 
                avatar: 'A', 
                role: 'Data Analyst',
                capabilities: ['statistics', 'trends', 'insights', 'forecast', 'predict', 'model'],
                confidence: 0.89
            }
        };

        // Libraries Data Structure and Management
        function saveLibrariesData() {
            localStorage.setItem('librariesData', JSON.stringify(librariesData));
        }
        
        function loadLibrariesData() {
            const saved = localStorage.getItem('librariesData');
            if (saved) {
                return JSON.parse(saved);
            }
            return null;
        }
        
        const librariesData = loadLibrariesData() || {
            libraries: [
                {
                    id: 'lib-api-docs',
                    name: 'API Documentation',
                    icon: 'fa-book',
                    color: '#3b82f6',
                    description: 'API specifications and integration guides',
                    parent: null,
                    artifacts: ['art-oauth-guide', 'art-rest-api'],
                    createdAt: new Date('2024-01-15'),
                    permissions: { view: 'all', edit: 'owner' }
                },
                {
                    id: 'lib-reports',
                    name: 'Reports & Analysis',
                    icon: 'fa-chart-bar',
                    color: '#10b981',
                    description: 'Business reports and data analysis',
                    parent: null,
                    artifacts: ['art-q3-report'],
                    createdAt: new Date('2024-01-10'),
                    permissions: { view: 'all', edit: 'owner' }
                },
                {
                    id: 'lib-code',
                    name: 'Code Snippets',
                    icon: 'fa-code',
                    color: '#8b5cf6',
                    description: 'Reusable code snippets and templates',
                    parent: null,
                    artifacts: ['art-auth-component'],
                    createdAt: new Date('2024-01-20'),
                    permissions: { view: 'all', edit: 'owner' }
                }
            ],
            artifacts: {
                'art-oauth-guide': {
                    id: 'art-oauth-guide',
                    name: 'OAuth2 Setup Guide',
                    type: 'document',
                    icon: 'fa-file-alt',
                    libraries: ['lib-api-docs'],
                    content: 'Complete guide for implementing OAuth2 authentication...',
                    createdAt: new Date('2024-01-15'),
                    lastModified: new Date('2024-01-20'),
                    author: 'Claude'
                },
                'art-rest-api': {
                    id: 'art-rest-api',
                    name: 'REST API Specification',
                    type: 'document',
                    icon: 'fa-file-code',
                    libraries: ['lib-api-docs'],
                    content: 'REST API endpoint documentation...',
                    createdAt: new Date('2024-01-16'),
                    lastModified: new Date('2024-01-18'),
                    author: 'Skip'
                },
                'art-q3-report': {
                    id: 'art-q3-report',
                    name: 'Q3 2024 Analysis',
                    type: 'report',
                    icon: 'fa-file-chart-line',
                    libraries: ['lib-reports'],
                    content: 'Quarterly business analysis report...',
                    createdAt: new Date('2024-01-10'),
                    lastModified: new Date('2024-01-10'),
                    author: 'Research'
                },
                'art-auth-component': {
                    id: 'art-auth-component',
                    name: 'Auth Component',
                    type: 'code',
                    icon: 'fa-file-code',
                    libraries: ['lib-code'],
                    content: 'React authentication component with hooks...',
                    createdAt: new Date('2024-01-20'),
                    lastModified: new Date('2024-01-21'),
                    author: 'Claude'
                }
            }
        };

        // Libraries Management Class
        class LibrariesManager {
            constructor() {
                this.loadFromStorage();
            }
            
            get libraries() {
                return librariesData.libraries;
            }

            loadFromStorage() {
                const stored = localStorage.getItem('mj-libraries');
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        Object.assign(librariesData, parsed);
                    } catch (e) {
                        console.error('Failed to load libraries from storage:', e);
                    }
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('mj-libraries', JSON.stringify(librariesData));
                } catch (e) {
                    console.error('Failed to save libraries to storage:', e);
                }
            }

            createLibrary(data) {
                const library = {
                    id: `lib-${Date.now()}`,
                    name: data.name,
                    icon: data.icon || 'fa-folder',
                    color: data.color || '#6b7280',
                    description: data.description || '',
                    parent: data.parent || null,
                    artifacts: [],
                    createdAt: new Date(),
                    permissions: { view: 'all', edit: 'owner' }
                };
                
                librariesData.libraries.push(library);
                this.saveToStorage();
                this.renderLibraries();
                showToast(`Library "${library.name}" created!`, 'success');
                return library;
            }

            updateLibrary(id, updates) {
                const library = librariesData.libraries.find(lib => lib.id === id);
                if (library) {
                    Object.assign(library, updates);
                    this.saveToStorage();
                    this.renderLibraries();
                    showToast(`Library "${library.name}" updated!`, 'success');
                }
                return library;
            }

            deleteLibrary(id) {
                const library = librariesData.libraries.find(lib => lib.id === id);
                if (!library) return false;

                // Check if library has children
                const hasChildren = librariesData.libraries.some(lib => lib.parent === id);
                if (hasChildren) {
                    showDeleteModal(
                        'Delete Library',
                        'This library has sub-libraries. All sub-libraries will also be deleted.',
                        library.name,
                        () => {
                            // Remove library and all children
                            librariesData.libraries = librariesData.libraries.filter(lib => 
                                lib.id !== id && lib.parent !== id
                            );

                            // Remove library reference from artifacts
                            Object.values(librariesData.artifacts).forEach(artifact => {
                                artifact.libraries = artifact.libraries.filter(libId => libId !== id);
                            });

                            this.saveToStorage();
                            this.renderLibraries();
                            showToast(`Library "${library.name}" deleted!`, 'info');
                        }
                    );
                    return false;
                }

                // Remove library and all children
                librariesData.libraries = librariesData.libraries.filter(lib => 
                    lib.id !== id && lib.parent !== id
                );

                // Remove library reference from artifacts
                Object.values(librariesData.artifacts).forEach(artifact => {
                    artifact.libraries = artifact.libraries.filter(libId => libId !== id);
                });

                this.saveToStorage();
                this.renderLibraries();
                showToast(`Library "${library.name}" deleted!`, 'info');
                return true;
            }

            addArtifactToLibrary(artifactId, libraryId) {
                const library = librariesData.libraries.find(lib => lib.id === libraryId);
                const artifact = librariesData.artifacts[artifactId];
                
                if (library && artifact) {
                    if (!library.artifacts.includes(artifactId)) {
                        library.artifacts.push(artifactId);
                    }
                    if (!artifact.libraries.includes(libraryId)) {
                        artifact.libraries.push(libraryId);
                    }
                    this.saveToStorage();
                    this.renderLibraries();
                    showToast(`Added "${artifact.name}" to "${library.name}"`, 'success');
                    return true;
                }
                return false;
            }

            removeArtifactFromLibrary(artifactId, libraryId) {
                const library = librariesData.libraries.find(lib => lib.id === libraryId);
                const artifact = librariesData.artifacts[artifactId];
                
                if (library && artifact) {
                    library.artifacts = library.artifacts.filter(id => id !== artifactId);
                    artifact.libraries = artifact.libraries.filter(id => id !== libraryId);
                    this.saveToStorage();
                    this.renderLibraries();
                    return true;
                }
                return false;
            }

            moveArtifact(artifactId, fromLibraryId, toLibraryId) {
                if (fromLibraryId === toLibraryId) return false;
                
                this.removeArtifactFromLibrary(artifactId, fromLibraryId);
                this.addArtifactToLibrary(artifactId, toLibraryId);
                return true;
            }

            searchLibraries(query) {
                const lowerQuery = query.toLowerCase();
                return librariesData.libraries.filter(lib => 
                    lib.name.toLowerCase().includes(lowerQuery) ||
                    lib.description.toLowerCase().includes(lowerQuery)
                );
            }

            getLibraryArtifacts(libraryId) {
                const library = librariesData.libraries.find(lib => lib.id === libraryId);
                if (library) {
                    return library.artifacts.map(id => librariesData.artifacts[id]).filter(Boolean);
                }
                return [];
            }

            renderLibraries() {
                const container = document.querySelector('.library-folders');
                if (!container) {
                    // Container doesn't exist yet, which is fine if modal isn't open
                    return;
                }

                container.innerHTML = '';
                
                // Render root libraries
                const rootLibraries = librariesData.libraries.filter(lib => !lib.parent);
                rootLibraries.forEach(library => {
                    const element = this.createLibraryElement(library);
                    container.appendChild(element);
                    
                    // Add event listener as backup to onclick
                    const header = element.querySelector('.library-folder-header');
                    if (header) {
                        header.addEventListener('click', function(e) {
                            e.stopPropagation();
                            toggleLibraryFolder(this);
                        });
                    }
                });

                // Add empty state if no libraries
                if (rootLibraries.length === 0) {
                    container.innerHTML = `
                        <div class="libraries-empty-state">
                            <i class="fas fa-folder-open" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 16px;"></i>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">No libraries yet</p>
                            <button class="btn-primary" onclick="showCreateLibraryModal()">
                                <i class="fas fa-plus"></i> Create First Library
                            </button>
                        </div>
                    `;
                }
            }

            createLibraryElement(library) {
                const div = document.createElement('div');
                div.className = 'library-folder';
                div.dataset.libraryId = library.id;

                const artifacts = this.getLibraryArtifacts(library.id);
                const hasChildren = librariesData.libraries.some(lib => lib.parent === library.id);

                // Determine icon based on artifact type
                const getArtifactIcon = (type) => {
                    const icons = {
                        'code': 'fa-code',
                        'markdown': 'fa-file-alt',
                        'chart': 'fa-chart-bar',
                        'document': 'fa-file-alt',
                        'report': 'fa-file-chart-line',
                        'analysis': 'fa-analytics'
                    };
                    return icons[type] || 'fa-file';
                };

                div.innerHTML = `
                    <div class="library-folder-header" 
                         onclick="toggleLibraryFolder(this)" 
                         ondblclick="navigateToLibrary('${library.id}')"
                         oncontextmenu="showLibraryContextMenu(event, '${library.id}')"
                         draggable="true" 
                         ondragstart="handleLibraryDragStart(event, '${library.id}')"
                         ondragover="handleLibraryDragOver(event)"
                         ondragleave="handleLibraryDragLeave(event)"
                         ondrop="handleLibraryDrop(event, '${library.id}')"
                         style="border-left: 3px solid ${library.color}">
                        <i class="fas fa-chevron-right library-expand-icon"></i>
                        <i class="fas ${library.icon} library-folder-icon" style="color: ${library.color}"></i>
                        <span class="library-folder-name">${library.name}</span>
                        <span class="library-count">${artifacts.length}</span>
                        <div class="library-actions">
                            <button class="library-action-btn create" onclick="event.stopPropagation(); showCreateSubLibraryModal('${library.id}')" title="Add sub-library">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="library-action-btn edit" onclick="event.stopPropagation(); showEditLibraryModal('${library.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="library-action-btn delete" onclick="event.stopPropagation(); confirmDeleteLibrary('${library.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="library-items">
                        ${artifacts.length > 0 ? artifacts.map(artifact => `
                            <div class="library-artifact-card" 
                                 draggable="true"
                                 ondragstart="handleArtifactDragStart(event, '${artifact.id}', '${library.id}')"
                                 onclick="openArtifactFromLibrary('${artifact.id}')"
                                 oncontextmenu="showArtifactContextMenu(event, '${artifact.id}', '${library.id}')">
                                <div class="artifact-card-header">
                                    <i class="fas ${getArtifactIcon(artifact.type)} artifact-card-icon"></i>
                                    <div class="artifact-card-info">
                                        <div class="artifact-card-title">${artifact.name}</div>
                                        <div class="artifact-card-meta">
                                            <span class="artifact-type-badge">${artifact.type || 'document'}</span>
                                            ${artifact.version ? `<span class="artifact-version-badge">v${artifact.version}</span>` : ''}
                                            <span class="artifact-date">${new Date(artifact.createdAt || Date.now()).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                    <div class="artifact-card-actions" onclick="event.stopPropagation()">
                                        <button class="artifact-action-btn" onclick="openArtifactFromLibrary('${artifact.id}')" title="Open">
                                            <i class="fas fa-external-link-alt"></i>
                                        </button>
                                        <button class="artifact-action-btn" onclick="event.stopPropagation(); showArtifactMenu(event, '${artifact.id}')" title="More">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </div>
                                ${artifact.preview ? `<div class="artifact-card-preview">${artifact.preview.substring(0, 150)}...</div>` : ''}
                            </div>
                        `).join('') : '<div class="library-empty">Drop artifacts here or click the + button to add</div>'}
                    </div>
                `;

                // Add children libraries
                const children = librariesData.libraries.filter(lib => lib.parent === library.id);
                if (children.length > 0) {
                    const childrenContainer = div.querySelector('.library-items');
                    children.forEach(child => {
                        const childElement = this.createLibraryElement(child);
                        childElement.style.marginLeft = '20px';
                        childrenContainer.appendChild(childElement);
                    });
                }

                return div;
            }
        }

        // Initialize Libraries Manager
        const librariesManager = new LibrariesManager();

        // Mock Database with LocalStorage Backend
        class ChatDatabase {
            constructor() {
                this.dbPrefix = 'agentChat_v15_';
                this.initializeDatabase();
            }

            initializeDatabase() {
                // Initialize data structures if not exists
                if (!this.getData('conversations')) {
                    this.setData('conversations', [
                        {
                            id: 'conv-001',
                            name: 'Product Design Discussion',
                            projectId: null,
                            members: ['user', 'john', 'sarah'],
                            lastMessage: new Date(),
                            unreadCount: 0,
                            created: new Date()
                        },
                        {
                            id: 'conv-002', 
                            name: 'API Integration Help',
                            projectId: 'proj-001',
                            members: ['user'],
                            lastMessage: new Date(),
                            unreadCount: 1,
                            created: new Date()
                        }
                    ]);
                }

                if (!this.getData('projects')) {
                    this.setData('projects', [
                        {
                            id: 'proj-001',
                            name: 'Website Redesign',
                            description: 'Q4 2024 website redesign project',
                            color: '#4A90E2',
                            chatCount: 1,
                            created: new Date()
                        },
                        {
                            id: 'proj-002',
                            name: 'Mobile App',
                            description: 'New mobile application development',
                            color: '#7ED321',
                            chatCount: 0,
                            created: new Date()
                        }
                    ]);
                }

                if (!this.getData('messages')) {
                    this.setData('messages', {});
                }

                if (!this.getData('artifacts')) {
                    this.setData('artifacts', []);
                }

                if (!this.getData('libraries')) {
                    this.setData('libraries', {
                        root: {
                            id: 'root',
                            name: 'Libraries',
                            type: 'folder',
                            children: [
                                {
                                    id: 'lib-reports',
                                    name: 'Reports',
                                    type: 'folder',
                                    children: []
                                },
                                {
                                    id: 'lib-dashboards',
                                    name: 'Dashboards',
                                    type: 'folder',
                                    children: []
                                },
                                {
                                    id: 'lib-documents',
                                    name: 'Documents',
                                    type: 'folder',
                                    children: []
                                }
                            ]
                        }
                    });
                }

                if (!this.getData('notifications')) {
                    this.setData('notifications', []);
                }

                if (!this.getData('agentMemory')) {
                    this.setData('agentMemory', {});
                }
            }

            getData(key) {
                const data = localStorage.getItem(this.dbPrefix + key);
                return data ? JSON.parse(data) : null;
            }

            setData(key, value) {
                localStorage.setItem(this.dbPrefix + key, JSON.stringify(value));
            }

            // Conversation methods
            getConversation(id) {
                const conversations = this.getData('conversations') || [];
                return conversations.find(c => c.id === id);
            }

            updateConversation(id, updates) {
                const conversations = this.getData('conversations') || [];
                const index = conversations.findIndex(c => c.id === id);
                if (index !== -1) {
                    conversations[index] = { ...conversations[index], ...updates };
                    this.setData('conversations', conversations);
                }
            }

            // Message methods
            getMessages(conversationId) {
                const allMessages = this.getData('messages') || {};
                return allMessages[conversationId] || [];
            }

            addMessage(conversationId, message) {
                const allMessages = this.getData('messages') || {};
                if (!allMessages[conversationId]) {
                    allMessages[conversationId] = [];
                }
                allMessages[conversationId].push(message);
                this.setData('messages', allMessages);
                
                // Update conversation last message
                this.updateConversation(conversationId, { lastMessage: new Date() });
            }

            // Artifact methods
            createArtifact(artifact) {
                const artifacts = this.getData('artifacts') || [];
                artifact.id = `artifact-${Date.now()}`;
                artifact.created = new Date();
                artifact.version = 1;
                artifacts.push(artifact);
                this.setData('artifacts', artifacts);
                return artifact;
            }

            // Agent memory methods
            getAgentMemory(agentId, conversationId) {
                const memory = this.getData('agentMemory') || {};
                const key = `${agentId}_${conversationId}`;
                return memory[key] || { context: [], lastActive: null };
            }

            updateAgentMemory(agentId, conversationId, context) {
                const memory = this.getData('agentMemory') || {};
                const key = `${agentId}_${conversationId}`;
                memory[key] = {
                    context: context,
                    lastActive: new Date()
                };
                this.setData('agentMemory', memory);
            }
        }

        // Initialize database
        const db = new ChatDatabase();

        // Agent Intelligence System
        class AgentIntelligence {
            constructor(agentId) {
                this.agent = agents[agentId];
                this.agentId = agentId;
                this.conversationContext = [];
            }

            analyzeMessage(message, conversationHistory = []) {
                const analysis = {
                    intent: this.detectIntent(message),
                    entities: this.extractEntities(message),
                    sentiment: this.analyzeSentiment(message),
                    requiresArtifact: this.shouldCreateArtifact(message),
                    confidence: 0
                };

                // Calculate confidence based on keyword matches
                const messageLower = message.toLowerCase();
                const matchCount = this.agent.capabilities.filter(cap => 
                    messageLower.includes(cap)
                ).length;
                
                analysis.confidence = Math.min(1, (matchCount / this.agent.capabilities.length) * 2);
                
                return analysis;
            }

            detectIntent(message) {
                const intents = {
                    'question': /\?|what|how|why|when|where|who|can you/i,
                    'request': /please|could you|would you|can you|i need|help me/i,
                    'analysis': /analyze|report|investigate|examine|review/i,
                    'creation': /create|make|build|generate|design|develop/i,
                    'explanation': /explain|tell me|describe|clarify/i
                };

                for (const [intent, pattern] of Object.entries(intents)) {
                    if (pattern.test(message)) {
                        return intent;
                    }
                }
                return 'statement';
            }

            extractEntities(message) {
                const entities = [];
                
                // Extract code blocks
                const codeMatch = message.match(/```[\s\S]*?```/g);
                if (codeMatch) {
                    entities.push({ type: 'code', value: codeMatch[0] });
                }
                
                // Extract URLs
                const urlMatch = message.match(/https?:\/\/[^\s]+/g);
                if (urlMatch) {
                    entities.push({ type: 'url', value: urlMatch[0] });
                }
                
                // Extract numbers/metrics
                const numberMatch = message.match(/\d+(\.\d+)?%?/g);
                if (numberMatch) {
                    entities.push({ type: 'number', value: numberMatch });
                }
                
                return entities;
            }

            analyzeSentiment(message) {
                const positive = /good|great|excellent|perfect|love|amazing|wonderful/i;
                const negative = /bad|terrible|hate|awful|horrible|wrong|error|bug/i;
                const urgent = /urgent|asap|immediately|critical|emergency/i;
                
                if (urgent.test(message)) return 'urgent';
                if (positive.test(message)) return 'positive';
                if (negative.test(message)) return 'negative';
                return 'neutral';
            }

            shouldCreateArtifact(message) {
                const artifactTriggers = /create|generate|make|build|show me|provide|give me|analyze.*report|analyze.*data.*report/i;
                const artifactTypes = /report|dashboard|code|document|analysis|chart|graph|data/i;
                
                // Special case for "analyze the data and create a report"
                if (/analyze.*data.*create.*report|analyze.*data.*report/i.test(message)) {
                    return true;
                }
                
                return artifactTriggers.test(message) && artifactTypes.test(message);
            }

            async generateResponse(message, analysis, conversationHistory) {
                // Simulate thinking time
                await this.simulateThinking(analysis.complexity);
                
                // Build response based on intent and context
                let response = '';
                
                switch (analysis.intent) {
                    case 'question':
                        response = this.generateAnswer(message, analysis);
                        break;
                    case 'request':
                        response = this.generateSolution(message, analysis);
                        break;
                    case 'analysis':
                        response = this.generateAnalysis(message, analysis);
                        break;
                    case 'creation':
                        response = this.generateCreation(message, analysis);
                        break;
                    default:
                        response = this.generateGeneral(message, analysis);
                }
                
                // Add confidence indicator if low
                if (analysis.confidence < 0.5) {
                    response += "\n\n*Note: I may not be the best agent for this task. Would you like me to bring in another specialist?*";
                }
                
                return response;
            }

            generateAnswer(message, analysis) {
                const templates = [
                    "Based on my analysis, {answer}. {details}",
                    "Great question! {answer}. Let me explain: {details}",
                    "The answer is {answer}. Here's why: {details}"
                ];
                
                const answer = this.generateContextualContent(message);
                const details = this.generateDetails(analysis);
                
                const template = templates[Math.floor(Math.random() * templates.length)];
                return template.replace('{answer}', answer).replace('{details}', details);
            }

            generateSolution(message, analysis) {
                return `I'll help you with that. Here's my solution:\n\n1. ${this.generateStep()}\n2. ${this.generateStep()}\n3. ${this.generateStep()}\n\nWould you like me to create an artifact with the complete implementation?`;
            }

            generateAnalysis(message, analysis) {
                // Check if this is specifically asking for data analysis and report creation
                const isReportRequest = /report|analysis.*data|analyze.*data/i.test(message);
                
                if (isReportRequest && this.agentId === 'skip') {
                    // Skip (Data Agent) response for report creation
                    return `I've analyzed your data and created a comprehensive report with key metrics and insights. The report includes performance trends, growth indicators, and actionable recommendations based on the current data patterns.`;
                } else {
                    const metrics = Math.floor(Math.random() * 1000) + 500;
                    const patterns = Math.floor(Math.random() * 10) + 3;
                    
                    return `I've completed the analysis you requested. Here's what I found:

 **Analysis Summary**
- Processed ${metrics} data points
- Identified ${patterns} key patterns
- Confidence level: ${(analysis.confidence * 100).toFixed(0)}%

**Key Findings:**
1. ${this.generateFinding()}
2. ${this.generateFinding()}
3. ${this.generateFinding()}

I'm preparing a detailed report with visualizations for you.`;
                }
            }

            generateCreation(message, analysis) {
                return `I'll create that for you. ${this.generateCreationDetails(message)}

I can generate this as an artifact. Should I proceed?`;
            }

            generateGeneral(message, analysis) {
                return `I understand. ${this.generateContextualContent(message)}

Is there anything specific you'd like me to help you with?`;
            }

            generateContextualContent(message) {
                // Generate contextually relevant content based on message
                const responses = [
                    "I've analyzed your requirements",
                    "Based on the context provided",
                    "After reviewing the information",
                    "I've processed your request"
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            generateDetails(analysis) {
                const details = [
                    "This involves multiple factors that I've considered",
                    "The solution takes into account best practices",
                    "I've optimized this based on current standards",
                    "This approach ensures scalability and maintainability"
                ];
                return details[Math.floor(Math.random() * details.length)];
            }

            generateStep() {
                const steps = [
                    "Analyze the current implementation",
                    "Identify key requirements and constraints",
                    "Design the solution architecture",
                    "Implement core functionality",
                    "Add error handling and validation",
                    "Optimize for performance",
                    "Write comprehensive tests"
                ];
                return steps[Math.floor(Math.random() * steps.length)];
            }

            generateFinding() {
                const findings = [
                    "Performance metrics show 23% improvement",
                    "User engagement increased significantly",
                    "System efficiency optimized by 15%",
                    "Data processing time reduced",
                    "Error rates decreased substantially"
                ];
                return findings[Math.floor(Math.random() * findings.length)];
            }

            generateCreationDetails(message) {
                if (message.toLowerCase().includes('dashboard')) {
                    return "I'll design an interactive dashboard with real-time metrics, charts, and filtering options.";
                } else if (message.toLowerCase().includes('report')) {
                    return "I'll generate a comprehensive report with executive summary, detailed analysis, and recommendations.";
                } else if (message.toLowerCase().includes('code')) {
                    return "I'll write clean, well-documented code following best practices and design patterns.";
                }
                return "I'll create a professional solution that meets your requirements.";
            }

            async simulateThinking(complexity = 1) {
                const baseTime = 500;
                const thinkingTime = baseTime + (Math.random() * 1000 * complexity);
                return new Promise(resolve => setTimeout(resolve, thinkingTime));
            }
        }

        // Agent Router - Determines which agents should respond
        class AgentRouter {
            analyzeAndRoute(message) {
                const messageLower = message.toLowerCase();
                const activeAgents = new Set();
                
                // Check if this is a specialized request that should bypass Claude
                let specializedRequest = false;
                
                // If it's a report/analytics request, only use Skip
                if (messageLower.includes('report') || 
                    messageLower.includes('dashboard') || 
                    messageLower.includes('analytics') ||
                    messageLower.includes('metrics') ||
                    messageLower.includes('statistics')) {
                    activeAgents.add('skip');
                    specializedRequest = true;
                }
                
                // Check other agent capabilities
                for (const [agentId, agent] of Object.entries(agents)) {
                    if (agentId === 'claude' || agentId === 'skip') continue;
                    
                    const shouldActivate = agent.capabilities.some(capability => 
                        messageLower.includes(capability)
                    );
                    
                    if (shouldActivate) {
                        activeAgents.add(agentId);
                        specializedRequest = true;
                    }
                }
                
                // Special multi-agent scenarios (override specialized request)
                if (messageLower.includes('full') && messageLower.includes('analysis')) {
                    activeAgents.clear();
                    activeAgents.add('skip');
                    activeAgents.add('analyst');
                    specializedRequest = true;
                }
                
                if (messageLower.includes('design') && messageLower.includes('implement')) {
                    activeAgents.clear();
                    activeAgents.add('designer');
                    activeAgents.add('coder');
                    specializedRequest = true;
                }
                
                // Only add Claude if no specialized agents were activated
                if (!specializedRequest || activeAgents.size === 0) {
                    activeAgents.add('claude');
                }
                
                return Array.from(activeAgents);
            }
        }

        const agentRouter = new AgentRouter();

        // Agent Process Manager - Handles concurrent agent activities
        class AgentProcessManager {
            constructor() {
                this.processesByChat = new Map(); // Map of chatId -> Map of processes
                this.currentChatProcesses = new Map(); // Active processes for current chat
                this.isDropdownOpen = false;
                // Will be initialized after DOM loads
                this.activeTasksBtn = null;
                this.activeTasksDropdown = null;
                this.activeTasksDropdownContent = null;
                this.taskCountBadge = null;
            }
            
            initializeDOMElements() {
                this.activeTasksBtn = document.getElementById('activeTasksBtn');
                this.activeTasksDropdown = document.getElementById('activeTasksDropdown');
                this.activeTasksDropdownContent = document.getElementById('activeTasksDropdownContent');
                this.taskCountBadge = document.getElementById('taskCountBadge');
            }
            
            addProcess(agentId, taskId, status, message, chatId = null) {
                const key = `${agentId}-${taskId}`;
                const agent = agents[agentId];
                const targetChatId = chatId || currentChatId || 'current';
                
                // Get or create process map for this chat
                if (!this.processesByChat.has(targetChatId)) {
                    this.processesByChat.set(targetChatId, new Map());
                }
                
                const chatProcesses = this.processesByChat.get(targetChatId);
                
                chatProcesses.set(key, {
                    key: key,
                    agent: agent,
                    agentId: agentId,
                    taskId: taskId,
                    status: status,
                    message: message,
                    timestamp: Date.now(),
                    startTime: Date.now(),
                    chatId: targetChatId
                });
                
                // Only update UI if this is for the current chat
                if (targetChatId === currentChatId) {
                    this.currentChatProcesses = chatProcesses;
                    
                    this.updateUI();
                    
                    // Show Active Tasks button if hidden
                    if (this.activeTasksBtn && this.activeTasksBtn.style.display === 'none') {
                        this.activeTasksBtn.style.display = 'flex';
                    }
                }
            }
            
            updateProcess(agentId, taskId, status, message, chatId = null) {
                const key = `${agentId}-${taskId}`;
                const targetChatId = chatId || currentChatId || 'current';
                
                const chatProcesses = this.processesByChat.get(targetChatId);
                if (!chatProcesses) return;
                
                const process = chatProcesses.get(key);
                
                if (process) {
                    process.status = status;
                    process.message = message;
                    process.timestamp = Date.now();
                    
                    if (status === 'completed') {
                        // Auto-remove completed processes after 2 seconds
                        setTimeout(() => {
                            this.removeProcess(agentId, taskId, targetChatId);
                        }, 2000);
                    }
                    
                    // Only update UI if this is for the current chat
                    if (targetChatId === currentChatId) {
                        this.updateUI();
                    }
                }
            }
            
            removeProcess(agentId, taskId, chatId = null) {
                const key = `${agentId}-${taskId}`;
                const targetChatId = chatId || currentChatId || 'current';
                
                const chatProcesses = this.processesByChat.get(targetChatId);
                if (chatProcesses) {
                    chatProcesses.delete(key);
                    
                    // Clean up empty chat process maps
                    if (chatProcesses.size === 0) {
                        this.processesByChat.delete(targetChatId);
                    }
                }
                
                // Only update UI if this is for the current chat
                if (targetChatId === currentChatId) {
                    this.currentChatProcesses = chatProcesses || new Map();
                    this.updateUI();
                    
                    // Hide button if no active processes for current chat
                    if (this.currentChatProcesses.size === 0) {
                        // Hide Active Tasks button after delay when empty
                        setTimeout(() => {
                            if (this.currentChatProcesses.size === 0 && this.activeTasksBtn) {
                                this.activeTasksBtn.style.display = 'none';
                                // Also close dropdown if open
                                if (this.isDropdownOpen) {
                                    this.closeDropdown();
                                }
                            }
                        }, 500);
                    }
                }
            }
            
            updateUI() {
                const activeCount = Array.from(this.currentChatProcesses.values())
                    .filter(p => p.status === 'working').length;
                const totalCount = this.currentChatProcesses.size;
                
                // Update task count badge
                if (this.taskCountBadge) {
                    this.taskCountBadge.textContent = totalCount.toString();
                }
                
                // Add pulse animation if there are active tasks
                if (this.activeTasksBtn) {
                    if (activeCount > 0) {
                        this.activeTasksBtn.classList.add('pulse-animation');
                    } else {
                        this.activeTasksBtn.classList.remove('pulse-animation');
                    }
                }
                
                // Update dropdown content if open
                if (this.activeTasksDropdownContent) {
                    if (totalCount === 0) {
                        this.activeTasksDropdownContent.innerHTML = '<div style="text-align: center; padding: 24px; color: var(--text-secondary);">No active tasks</div>';
                    } else {
                        const processes = Array.from(this.currentChatProcesses.values())
                            .sort((a, b) => b.timestamp - a.timestamp);
                        
                        this.activeTasksDropdownContent.innerHTML = processes.map(p => this.createTaskHTML(p)).join('');
                    }
                }
            }
            
            createTaskHTML(process) {
                const isWorking = process.status === 'working';
                return `
                    <div class="active-task-item ${isWorking ? 'working' : ''}">
                        <div class="task-avatar" style="background: ${process.agent.color};">
                            ${process.agent.avatar}
                        </div>
                        <div class="task-info">
                            <div class="task-agent">${process.agent.name}</div>
                            <div class="task-message">${process.message}</div>
                        </div>
                        ${isWorking ? `
                            <div class="task-status">
                                <div class="mini-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        ` : `
                            <div class="task-status">
                                <span class="status-label">${process.status}</span>
                            </div>
                        `}
                        <div class="task-time">
                            ${this.getElapsedTime(process.startTime)}
                        </div>
                    </div>
                `;
            }
            
            switchToChat(chatId) {
                // Save current chat's processes
                this.currentChatProcesses = this.processesByChat.get(chatId) || new Map();
                
                // Update UI for the new chat
                this.updateUI();
                
                // Hide or show Active Tasks button based on processes
                if (this.activeTasksBtn) {
                    if (this.currentChatProcesses.size === 0) {
                        this.activeTasksBtn.style.display = 'none';
                        // Close dropdown if open
                        if (this.isDropdownOpen) {
                            this.closeDropdown();
                        }
                    } else {
                        this.activeTasksBtn.style.display = 'flex';
                    }
                }
            }
            
            // Removed updateExpandedView - now handled by updateUI
            
            getElapsedTime(startTime) {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor(elapsed / 1000);
                if (seconds < 60) return `${seconds}s`;
                const minutes = Math.floor(seconds / 60);
                return `${minutes}m ${seconds % 60}s`;
            }
            
            toggleDropdown() {
                if (this.isDropdownOpen) {
                    this.closeDropdown();
                } else {
                    this.openDropdown();
                }
            }
            
            openDropdown() {
                if (this.activeTasksDropdown) {
                    this.activeTasksDropdown.style.display = 'block';
                    this.isDropdownOpen = true;
                    this.updateUI(); // Update content when opening
                }
            }
            
            closeDropdown() {
                if (this.activeTasksDropdown) {
                    this.activeTasksDropdown.style.display = 'none';
                    this.isDropdownOpen = false;
                }
            }
        }
        
        const processManager = new AgentProcessManager();
        
        // Toggle Active Tasks dropdown
        function toggleActiveTasksDropdown() {
            processManager.toggleDropdown();
        }
        
        function closeActiveTasksDropdown() {
            processManager.closeDropdown();
        }
        
        // Toggle Settings (placeholder for future implementation)
        function toggleSettings() {
            // For now, just show a toast that settings is not yet implemented
            showToast('Settings panel coming soon!', 'info');
        }
        
        // Toggle Profile (placeholder for future implementation)
        function toggleProfile() {
            // For now, just show a toast that profile is not yet implemented
            showToast('Profile panel coming soon!', 'info');
        }
        
        // Universal Delete Modal Functions
        let currentDeleteCallback = null;

        function showDeleteModal(title, warningText, itemName, onConfirm) {
            const modal = document.getElementById('universalDeleteModal');
            document.getElementById('deleteModalTitle').textContent = title;
            document.getElementById('deleteWarningText').textContent = warningText;
            document.getElementById('deleteItemName').textContent = itemName;
            
            currentDeleteCallback = onConfirm;
            modal.classList.add('show');
        }

        function closeUniversalDeleteModal() {
            const modal = document.getElementById('universalDeleteModal');
            modal.classList.remove('show');
            currentDeleteCallback = null;
        }

        function executeDelete() {
            if (currentDeleteCallback) {
                currentDeleteCallback();
            }
            closeUniversalDeleteModal();
        }

        // Reminder Modal Functions
        let currentReminderCallback = null;

        function showReminderModal(onConfirm) {
            const modal = document.getElementById('reminderModal');
            modal.classList.add('show');
            currentReminderCallback = onConfirm;
            
            // Set default datetime to current time
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 16);
            document.getElementById('reminderDateTime').value = dateStr;
        }

        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            modal.classList.remove('show');
            currentReminderCallback = null;
        }

        function setQuickReminder(minutes) {
            const reminderTime = new Date();
            reminderTime.setMinutes(reminderTime.getMinutes() + minutes);
            
            if (currentReminderCallback) {
                currentReminderCallback(reminderTime);
            }
            closeReminderModal();
        }

        function confirmReminder() {
            const dateTimeValue = document.getElementById('reminderDateTime').value;
            if (dateTimeValue && currentReminderCallback) {
                const reminderTime = new Date(dateTimeValue);
                currentReminderCallback(reminderTime);
            }
            closeReminderModal();
        }

        let messages = [];
        let activeAgents = ['claude'];
        let isTyping = false;
        let currentContextChat = null;
        let currentEditingChat = null;
        let currentChatId = 'current'; // Track current chat ID
        let chatMessagesCache = {}; // Cache messages for each chat
        let chatArtifactsCache = {}; // Cache artifacts for each chat
        let initialQuickQuestionHTML = null; // Store the initial mock collaborative HTML
        let chatMembers = [
            { id: 'user', name: 'You', email: 'user@example.com', role: 'owner', avatar: 'U', color: 'var(--navy)' },
            { id: 'john', name: 'John Smith', email: 'john@example.com', role: 'edit', avatar: 'J', color: 'var(--mj-blue)' },
            { id: 'sarah', name: 'Sarah Johnson', email: 'sarah@example.com', role: 'view', avatar: 'S', color: 'var(--agent-research)' }
        ];

        // Toggle members modal
        function toggleMembersModal() {
            const modal = document.getElementById('membersModal');
            if (modal.classList.contains('show')) {
                closeMembersModal();
            } else {
                modal.classList.add('show');
                // Focus on invite input when modal opens
                setTimeout(() => {
                    document.getElementById('inviteEmail').focus();
                }, 100);
            }
        }

        function closeMembersModal() {
            document.getElementById('membersModal').classList.remove('show');
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            // Capture the initial mock collaborative HTML for Quick Question
            const conversationHistory = document.getElementById('conversationHistory');
            if (conversationHistory) {
                initialQuickQuestionHTML = conversationHistory.innerHTML;
                // Mark Quick Question as having special content
                chatMessagesCache['current'] = 'MOCK_CONTENT';
            }
        });

        // Also handle ESC key for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (document.getElementById('membersModal').classList.contains('show')) {
                    closeMembersModal();
                }
            }
        });

        // Toast Notification System
        function showToast(message, type = 'info', title = '') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'fa-check' : 
                        type === 'error' ? 'fa-exclamation' : 
                        'fa-info';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close" onclick="removeToast(this)">
                    <i class="fas fa-times"></i>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 250);
            }, 5000);
        }
        
        function removeToast(closeBtn) {
            const toast = closeBtn.parentElement;
            toast.classList.add('removing');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 250);
        }

        // Invite member
        function inviteMember() {
            const emailInput = document.getElementById('inviteEmail');
            const email = emailInput.value.trim();
            
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Check if member already exists
            if (chatMembers.some(m => m.email === email)) {
                showToast('This member is already in the chat', 'error');
                return;
            }
            
            // Add new member
            const newMember = {
                id: 'member-' + Date.now(),
                name: email.split('@')[0],
                email: email,
                role: 'view',
                avatar: email.charAt(0).toUpperCase(),
                color: getRandomColor()
            };
            
            chatMembers.push(newMember);
            
            // Add to UI
            addMemberToList(newMember);
            updateMemberCount();
            updateMemberAvatars();
            
            // Show success toast
            showToast(`Successfully invited ${newMember.name} to the chat`, 'success', 'Member Invited');
            
            // Clear input
            emailInput.value = '';
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function getRandomColor() {
            const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function addMemberToList(member) {
            const membersList = document.querySelector('.members-list');
            const memberItem = document.createElement('div');
            memberItem.className = 'member-item';
            memberItem.id = `member-${member.id}`;
            memberItem.innerHTML = `
                <div class="member-item-avatar" style="background-color: ${member.color};">${member.avatar}</div>
                <div class="member-item-info">
                    <div class="member-item-name">${member.name}</div>
                    <div class="member-item-email">${member.email}</div>
                </div>
                <select class="permission-select" onchange="updatePermission('${member.id}', this.value)">
                    <option value="edit" ${member.role === 'edit' ? 'selected' : ''}>Can Edit</option>
                    <option value="view" ${member.role === 'view' ? 'selected' : ''}>Can View</option>
                </select>
                <div class="member-item-actions">
                    <button class="member-action-btn remove" onclick="removeMember('${member.id}')" title="Remove member">
                        <i class="fas fa-user-minus"></i>
                    </button>
                </div>
            `;
            
            // Insert before AI agents section
            const aiAgentsSection = membersList.parentElement.querySelector('.members-list:last-child');
            membersList.insertBefore(memberItem, aiAgentsSection);
        }

        // Remove member
        function removeMember(memberId) {
            const memberName = chatMembers.find(m => m.id === memberId)?.name;
            
            // Use delete modal for confirmation
            showDeleteModal(
                'Remove Member',
                'This member will no longer have access to this chat.',
                memberName,
                () => {
                    // Remove from data
                    chatMembers = chatMembers.filter(m => m.id !== memberId);
                    
                    // Remove from UI
                    const memberElement = document.getElementById(`member-${memberId}`);
                    if (memberElement) {
                        memberElement.remove();
                    }
                    
                    updateMemberCount();
                    updateMemberAvatars();
                }
            );
        }

        // Update permission
        function updatePermission(memberId, permission) {
            const member = chatMembers.find(m => m.id === memberId);
            if (member) {
                member.role = permission;
                console.log(`Updated ${member.name}'s permission to: ${permission}`);
            }
        }

        // Update member count
        function updateMemberCount() {
            const count = chatMembers.length;
            
            const memberCountLabel = document.getElementById('memberCountLabel');
            if (memberCountLabel) {
                memberCountLabel.textContent = `${count} members`;
            }
            
            const totalBadge = document.getElementById('totalMembersBadge');
            if (totalBadge) {
                totalBadge.textContent = `${count} members`;
            }
        }

        // Update member avatars in header (no longer needed, but keeping for compatibility)
        function updateMemberAvatars() {
            // This function is now empty since we're not showing avatars in the header
            // Just update the count
            updateMemberCount();
        }

        // Toggle sidebar sections
        function toggleSection(header) {
            header.classList.toggle('expanded');
            const chatList = header.parentElement.querySelector('.chat-list');
            if (chatList) {
                chatList.classList.toggle('expanded');
            }
        }

        // Select a chat
        function selectChat(element, chatId, chatType = 'chat') {
            // Don't do anything if selecting the same chat
            if (currentChatId === chatId) {
                return;
            }
            
            // Clear notifications for this chat
            notificationManager.clearNotifications(chatId);
            
            // Switch process manager to new chat's context
            processManager.switchToChat(chatId);
            
            // Save current chat messages to cache before switching
            if (currentChatId) {
                // Don't overwrite the mock content for Quick Question if no new messages were added
                if (currentChatId === 'current' && chatMessagesCache['current'] === 'MOCK_CONTENT' && messages.length === 0) {
                    // Keep the MOCK_CONTENT marker
                    console.log('Preserving Quick Question mock content');
                } else if (messages.length > 0) {
                    // Store messages with serialized timestamps
                    chatMessagesCache[currentChatId] = messages.map(msg => ({
                        ...msg,
                        timestamp: msg.timestamp instanceof Date ? 
                                  msg.timestamp.toISOString() : 
                                  msg.timestamp
                    }));
                    console.log(`Saved ${messages.length} messages for chat ${currentChatId}`);
                }
                
                // Save artifacts for current chat (both .artifact and .artifact-inline)
                const chatArtifacts = document.querySelectorAll('.conversation-history .artifact, .conversation-history .artifact-inline');
                if (chatArtifacts.length > 0) {
                    chatArtifactsCache[currentChatId] = Array.from(chatArtifacts).map(artifact => {
                        // For artifact-inline, extract the ID from onclick
                        let artifactId = artifact.dataset?.artifactId;
                        if (!artifactId && artifact.onclick) {
                            const onclickStr = artifact.onclick.toString();
                            const match = onclickStr.match(/openArtifact\(['"]([^'"]+)['"]/);
                            if (match) artifactId = match[1];
                        }
                        
                        return {
                            id: artifactId || `artifact-${Date.now()}-${Math.random()}`,
                            title: artifact.querySelector('.artifact-title')?.textContent?.trim(),
                            type: artifact.querySelector('.artifact-type')?.textContent?.toLowerCase(),
                            content: artifact.querySelector('.artifact-preview')?.textContent,
                            html: artifact.outerHTML,
                            className: artifact.className
                        };
                    });
                    console.log(`Saved ${chatArtifacts.length} artifacts for chat ${currentChatId}`);
                }
            }
            
            // Remove active class from all chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected item
            element.classList.add('active');
            
            // Remove unread indicator if present
            const unreadIndicator = element.querySelector('.unread-indicator');
            if (unreadIndicator) {
                unreadIndicator.remove();
            }
            
            // Update chat title
            const chatName = element.querySelector('.chat-name').textContent;
            document.getElementById('chatTitle').textContent = chatName;
            
            // Update project tag if present
            const projectId = element.getAttribute('data-project-id');
            const projectTag = document.getElementById('chatProjectTag');
            const projectNameSpan = document.getElementById('chatProjectName');
            
            if (projectId) {
                projectTag.style.display = 'flex';
                const projectMap = {
                    'website': 'Website Redesign',
                    'mobile': 'Mobile App',
                    'data': 'Data Analysis'
                };
                projectNameSpan.textContent = projectMap[projectId] || projectId;
                projectTag.className = `project-tag project-${projectId}`;
            } else {
                projectTag.style.display = 'none';
            }
            
            // Update current chat ID
            const previousChatId = currentChatId;
            currentChatId = chatId;
            
            // Clear the conversation history display but preserve sticky date header
            const conversationHistory = document.getElementById('conversationHistory');
            const stickyHeader = document.getElementById('stickyDateHeader');
            
            // Create sticky date header HTML if it doesn't exist
            const stickyHeaderHTML = stickyHeader ? stickyHeader.outerHTML : `
                <div class="sticky-date-header" id="stickyDateHeader">
                    <div class="sticky-date-wrapper">
                        <button class="sticky-date-button" onclick="toggleDateNav()">
                            <span id="currentDateDisplay">Today</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="date-nav-dropdown" id="dateNavDropdown">
                            <a href="javascript:void(0)" onclick="jumpToDate('today')">Jump to Today</a>
                            <a href="javascript:void(0)" onclick="jumpToDate('yesterday')">Jump to Yesterday</a>
                            <a href="javascript:void(0)" onclick="openDatePicker()">Jump to Date...</a>
                        </div>
                    </div>
                </div>`;
            
            conversationHistory.innerHTML = '';
            
            // Always restore/create sticky date header first
            conversationHistory.innerHTML = stickyHeaderHTML;
            
            // Update the date display to "Today" by default for new chats
            const dateDisplay = document.getElementById('currentDateDisplay');
            if (dateDisplay) {
                dateDisplay.textContent = 'Today';
            }
            
            // Special handling for Quick Question chat with mock content
            if (chatId === 'current' && (chatMessagesCache['current'] === 'MOCK_CONTENT' || initialQuickQuestionHTML)) {
                // Restore the mock collaborative HTML but keep sticky header
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = initialQuickQuestionHTML;
                
                // Remove any existing sticky header from the mock content
                const mockStickyHeader = tempDiv.querySelector('#stickyDateHeader');
                if (mockStickyHeader) {
                    mockStickyHeader.remove();
                }
                
                // Append the mock content after the sticky header
                const currentStickyHeader = conversationHistory.querySelector('#stickyDateHeader');
                if (currentStickyHeader) {
                    conversationHistory.innerHTML = currentStickyHeader.outerHTML + tempDiv.innerHTML;
                } else {
                    conversationHistory.innerHTML = stickyHeaderHTML + tempDiv.innerHTML;
                }
                
                messages = []; // Reset messages array since we're using the mock HTML
                console.log('Restored Quick Question mock collaborative view');
            } else if (chatMessagesCache[chatId] && Array.isArray(chatMessagesCache[chatId]) && chatMessagesCache[chatId].length > 0) {
                // Restore cached messages for regular chats
                // Convert timestamp strings back to Date objects when loading from cache
                messages = chatMessagesCache[chatId].map(msg => ({
                    ...msg,
                    timestamp: typeof msg.timestamp === 'string' ? 
                              new Date(msg.timestamp) : 
                              msg.timestamp
                }));
                console.log(`Restored ${messages.length} messages for chat ${chatId}`);
                
                // Re-render all messages
                messages.forEach(msg => renderMessage(msg));
                
                // Restore cached artifacts if any
                if (chatArtifactsCache[chatId] && chatArtifactsCache[chatId].length > 0) {
                    chatArtifactsCache[chatId].forEach(artifact => {
                        // Check if artifact is already in the DOM (by ID or by checking for similar content)
                        const existingArtifact = document.querySelector(`[data-artifact-id="${artifact.id}"]`) ||
                                                Array.from(document.querySelectorAll('.artifact-inline, .artifact')).find(el => {
                                                    const title = el.querySelector('.artifact-title')?.textContent?.trim();
                                                    return title === artifact.title;
                                                });
                        
                        if (!existingArtifact) {
                            // Find the appropriate message to append to, or append to conversation history
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = artifact.html;
                            const artifactElement = tempDiv.firstElementChild;
                            
                            // Restore onclick handler if it's an artifact-inline
                            if (artifact.className && artifact.className.includes('artifact-inline') && artifact.id) {
                                artifactElement.onclick = function() { 
                                    openArtifact(artifact.id, artifact.title, artifact.type); 
                                };
                            }
                            
                            conversationHistory.appendChild(artifactElement);
                        }
                    });
                    console.log(`Restored ${chatArtifactsCache[chatId].length} artifacts for chat ${chatId}`);
                }
            } else if (db && db.getMessages) {
                // Try to load from database if cache is empty
                const dbMessages = db.getMessages(chatId);
                if (dbMessages && dbMessages.length > 0) {
                    messages = [...dbMessages];
                    chatMessagesCache[chatId] = messages;
                    messages.forEach(msg => renderMessage(msg));
                } else {
                    // Only show welcome message for new/empty chats
                    const welcomeMessage = {
                        id: Date.now(),
                        sender: 'Claude',
                        agent: 'claude',
                        type: 'agent',
                        text: `Welcome to "${chatName}"! I'm ready to help you with your questions. I'll automatically bring in specialized agents as needed based on what you're working on. What can I assist you with today?`,
                        timestamp: new Date()
                    };
                    messages = [welcomeMessage];
                    chatMessagesCache[chatId] = [welcomeMessage];
                    renderMessage(welcomeMessage);
                }
            } else {
                // Only show welcome message for new/empty chats
                const welcomeMessage = {
                    id: Date.now(),
                    sender: 'Claude',
                    agent: 'claude',
                    type: 'agent',
                    text: `Welcome to "${chatName}"! I'm ready to help you with your questions. I'll automatically bring in specialized agents as needed based on what you're working on. What can I assist you with today?`,
                    timestamp: new Date()
                };
                messages = [welcomeMessage];
                chatMessagesCache[chatId] = [welcomeMessage];
                renderMessage(welcomeMessage);
            }
        }

        // Edit chat name
        function editChatName(event, button) {
            event.stopPropagation();
            const chatItem = button.closest('.chat-item');
            const chatName = chatItem.querySelector('.chat-name');
            currentEditingChat = chatItem;
            
            document.getElementById('renameInput').value = chatName.textContent;
            document.getElementById('renameModal').classList.add('show');
            document.getElementById('renameInput').select();
        }

        // Delete chat
        function deleteChat(event, button) {
            event.stopPropagation();
            const chatItem = button.closest('.chat-item');
            const chatName = chatItem.querySelector('.chat-name').textContent;
            currentEditingChat = chatItem;
            
            document.getElementById('deleteChatName').textContent = chatName;
            document.getElementById('deleteModal').classList.add('show');
        }

        // Show context menu
        function showContextMenu(event, chatItem) {
            event.preventDefault();
            const contextMenu = document.getElementById('contextMenu');
            currentContextChat = chatItem;
            
            // Position the context menu
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.classList.add('show');
            
            // Hide context menu when clicking elsewhere
            document.addEventListener('click', hideContextMenu);
        }

        // Hide context menu
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
            document.removeEventListener('click', hideContextMenu);
        }

        // Context menu actions
        function renameFromContext() {
            if (currentContextChat) {
                const chatName = currentContextChat.querySelector('.chat-name');
                currentEditingChat = currentContextChat;
                document.getElementById('renameInput').value = chatName.textContent;
                document.getElementById('renameModal').classList.add('show');
                document.getElementById('renameInput').select();
            }
            hideContextMenu();
        }

        function deleteFromContext() {
            if (currentContextChat) {
                const chatName = currentContextChat.querySelector('.chat-name').textContent;
                currentEditingChat = currentContextChat;
                document.getElementById('deleteChatName').textContent = chatName;
                document.getElementById('deleteModal').classList.add('show');
            }
            hideContextMenu();
        }

        function duplicateChat() {
            if (currentContextChat) {
                const originalName = currentContextChat.querySelector('.chat-name').textContent;
                const newChat = currentContextChat.cloneNode(true);
                newChat.classList.remove('active');
                newChat.querySelector('.chat-name').textContent = originalName + ' (Copy)';
                
                // Remove unread indicator if present
                const unreadIndicator = newChat.querySelector('.unread-indicator');
                if (unreadIndicator) {
                    unreadIndicator.remove();
                }
                
                // Re-attach event listeners
                newChat.onclick = function() { selectChat(this, Date.now()); };
                newChat.oncontextmenu = function(e) { showContextMenu(e, this); };
                
                // Re-attach button listeners
                const editBtn = newChat.querySelector('.chat-action-btn:not(.delete)');
                const deleteBtn = newChat.querySelector('.chat-action-btn.delete');
                if (editBtn) editBtn.onclick = function(e) { editChatName(e, this); };
                if (deleteBtn) deleteBtn.onclick = function(e) { deleteChat(e, this); };
                
                currentContextChat.parentElement.insertBefore(newChat, currentContextChat.nextSibling);
            }
            hideContextMenu();
        }

        // Toggle chat menu dropdown
        function toggleChatMenu(event, chatId) {
            event.stopPropagation();
            const menuId = `chat-menu-${chatId}`;
            let menu = document.getElementById(menuId);
            const button = event.currentTarget;
            
            if (!menu) {
                // Create menu dynamically if it doesn't exist
                createChatMenuForItem(chatId, button);
                menu = document.getElementById(menuId);
            }
            
            // Close all other menus
            document.querySelectorAll('.chat-menu-dropdown').forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });
            
            // Position the menu based on the button's position (since we're using fixed positioning)
            if (menu) {
                const rect = button.getBoundingClientRect();
                menu.style.left = (rect.left - 180 + rect.width) + 'px';  // Align to button's right edge
                menu.style.top = (rect.bottom + 4) + 'px';  // Position below button
            }
            
            // Toggle this menu
            menu.classList.toggle('show');
            
            // Close on click outside
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closeAllChatMenus);
                }, 0);
            }
        }
        
        function closeAllChatMenus() {
            document.querySelectorAll('.chat-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            document.removeEventListener('click', closeAllChatMenus);
        }
        
        function createChatMenuForItem(chatId, button) {
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            // Remove any existing menu for this chat
            const existingMenu = document.getElementById(`chat-menu-${chatId}`);
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Check if chat has a project
            const projectId = chatItem.dataset.projectId;
            let projectMenuText = 'Add to Project';
            let projectMenuIcon = 'fa-folder-plus';
            let removeProjectOption = '';
            
            if (projectId) {
                // Find project name
                const projectBadge = chatItem.querySelector('.project-badge');
                const projectName = projectBadge ? projectBadge.textContent : 'Unknown';
                projectMenuText = `Change Project (${projectName})`;
                projectMenuIcon = 'fa-folder-open';
                removeProjectOption = `
                    <div class="chat-menu-item" onclick="removeFromProject('${chatId}')">
                        <i class="fas fa-folder-minus"></i>
                        <span>Remove from Project</span>
                    </div>`;
            }
            
            // Create menu element
            const menu = document.createElement('div');
            menu.className = 'chat-menu-dropdown';
            menu.id = `chat-menu-${chatId}`;
            menu.innerHTML = `
                <div class="chat-menu-item" onclick="renameChat('${chatId}')">
                    <i class="fas fa-pencil"></i>
                    <span>Rename</span>
                </div>
                <div class="chat-menu-item" onclick="showProjectSelectorForChat('${chatId}')">
                    <i class="fas ${projectMenuIcon}"></i>
                    <span>${projectMenuText}</span>
                </div>
                ${removeProjectOption}
                <div class="chat-menu-item" onclick="duplicateChatById('${chatId}')">
                    <i class="fas fa-copy"></i>
                    <span>Duplicate</span>
                </div>
                <div class="chat-menu-item" onclick="starChatFromMenu('${chatId}')">
                    <i class="fas fa-star"></i>
                    <span>Star</span>
                </div>
                <div class="chat-menu-divider"></div>
                <div class="chat-menu-item" onclick="archiveChatById('${chatId}')">
                    <i class="fas fa-archive"></i>
                    <span>Archive</span>
                </div>
                <div class="chat-menu-item danger" onclick="deleteChatById('${chatId}')">
                    <i class="fas fa-trash"></i>
                    <span>Delete</span>
                </div>
            `;
            
            // Append to body for fixed positioning
            document.body.appendChild(menu);
            
            // Position the menu if button is provided
            if (button) {
                const rect = button.getBoundingClientRect();
                menu.style.left = (rect.left - 180 + rect.width) + 'px';
                menu.style.top = (rect.bottom + 4) + 'px';
            }
            
            // Show the menu after creating it
            setTimeout(() => {
                menu.classList.add('show');
                document.addEventListener('click', closeAllChatMenus);
            }, 0);
        }
        
        function renameChat(chatId) {
            closeAllChatMenus();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            const chatName = chatItem.querySelector('.chat-name');
            currentEditingChat = chatItem;
            
            // Set current values in modal
            document.getElementById('renameInput').value = chatName.textContent;
            document.getElementById('renameModal').classList.add('show');
            
            // Focus and select text
            setTimeout(() => {
                const input = document.getElementById('renameInput');
                input.focus();
                input.select();
            }, 100);
        }
        
        function showProjectSelectorForChat(chatId) {
            closeAllChatMenus();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            currentContextChat = chatItem;
            showProjectSelector();
        }
        
        function removeFromProject(chatId) {
            closeAllChatMenus();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            // Remove project association
            delete chatItem.dataset.projectId;
            
            // Remove project badge
            const badge = chatItem.querySelector('.project-badge');
            if (badge) badge.remove();
            
            showToast('Chat removed from project', 'success');
        }
        
        function duplicateChatById(chatId) {
            closeAllChatMenus();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            const originalName = chatItem.querySelector('.chat-name').textContent;
            const newChat = chatItem.cloneNode(true);
            const newChatId = Date.now().toString();
            
            newChat.classList.remove('active');
            newChat.setAttribute('data-chat-id', newChatId);
            newChat.querySelector('.chat-name').textContent = originalName + ' (Copy)';
            
            // Update onclick handlers
            newChat.setAttribute('onclick', `selectChat(this, '${newChatId}')`);
            const menuBtn = newChat.querySelector('.chat-action-btn');
            if (menuBtn) {
                menuBtn.setAttribute('onclick', `toggleChatMenu(event, '${newChatId}')`);
            }
            
            // Remove old menu if exists
            const oldMenu = newChat.querySelector('.chat-menu-dropdown');
            if (oldMenu) oldMenu.remove();
            
            const allChats = document.getElementById('allChats');
            chatItem.parentNode.insertBefore(newChat, chatItem.nextSibling);
            
            showToast('Chat duplicated', 'success');
        }
        
        function starChatFromMenu(chatId) {
            closeAllChatMenus();
            // Implementation for starring
            showToast('Chat starred', 'success');
        }
        
        function archiveChatById(chatId) {
            closeAllChatMenus();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            chatItem.style.opacity = '0.5';
            showToast('Chat archived', 'success');
        }
        
        function deleteChatById(chatId) {
            closeAllChatMenus();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (!chatItem) return;
            
            const chatName = chatItem.querySelector('.chat-name').textContent;
            currentEditingChat = chatItem;
            
            // Update delete modal with chat name
            document.getElementById('deleteChatName').textContent = chatName;
            document.getElementById('deleteModal').classList.add('show');
        }
        
        function showProjectSelector() {
            hideContextMenu();
            const currentChat = currentContextChat || document.querySelector('.chat-item.active');
            if (!currentChat) return;
            
            currentChatForProject = currentChat;
            const chatName = currentChat.querySelector('.chat-name').textContent;
            
            // Update modal with chat name
            document.getElementById('chatToAddName').textContent = chatName;
            
            // Populate projects list
            const projectsListDiv = document.getElementById('projectsModalList');
            projectsListDiv.innerHTML = '';
            
            // Get all existing projects from the sidebar projects section
            const projects = [];
            document.querySelectorAll('#projectsList .chat-item').forEach(item => {
                const projectId = item.dataset.projectId;
                if (projectId) {
                    const projectName = item.querySelector('.chat-name').textContent;
                    const iconElement = item.querySelector('.chat-icon');
                    const projectColor = iconElement ? (iconElement.style.color || '#4A90E2') : '#4A90E2';
                    projects.push({ id: projectId, name: projectName, color: projectColor });
                }
            });
            
            // If no projects exist, show a message
            if (projects.length === 0) {
                projectsListDiv.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-folder-open" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>No projects yet. Create your first project below!</p>
                    </div>
                `;
                // Still show the modal even with no projects
                document.getElementById('addToProjectModal').classList.add('show');
                
                // Update button text and hide remove button
                const confirmBtn = document.getElementById('confirmAddBtn');
                confirmBtn.textContent = 'Add to Project';
                confirmBtn.disabled = true;
                
                const removeBtn = document.querySelector('#addToProjectModal .modal-btn.danger');
                removeBtn.style.display = 'none';
                return;
            }
            
            projects.forEach(project => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-option';
                projectDiv.style.cssText = `
                    padding: 10px;
                    margin-bottom: 8px;
                    border-radius: 6px;
                    background: var(--gray-600);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    transition: background 0.2s;
                `;
                projectDiv.onmouseover = () => projectDiv.style.background = 'var(--gray-700)';
                projectDiv.onmouseout = () => projectDiv.style.background = 'var(--gray-600)';
                projectDiv.onclick = () => selectProject(project.id);
                
                const isCurrentProject = currentChat.dataset.projectId === project.id;
                
                projectDiv.innerHTML = `
                    <i class="fas fa-folder" style="color: ${project.color};"></i>
                    <span style="flex: 1;">${project.name}</span>
                    ${isCurrentProject ? '<i class="fas fa-check" style="color: var(--primary-color);"></i>' : ''}
                `;
                
                projectsListDiv.appendChild(projectDiv);
            });
            
            // Show the modal
            document.getElementById('addToProjectModal').classList.add('show');
            
            // Update button text based on current state
            const confirmBtn = document.getElementById('confirmAddBtn');
            confirmBtn.textContent = currentChat.dataset.projectId ? 'Change Project' : 'Add to Project';
            
            // Show/hide remove button
            const removeBtn = document.querySelector('#addToProjectModal .modal-btn.danger');
            removeBtn.style.display = currentChat.dataset.projectId ? 'block' : 'none';
        }
        
        function selectProject(projectId) {
            selectedProjectId = projectId;
            // Update visual selection
            document.querySelectorAll('.project-option').forEach(opt => {
                const icon = opt.querySelector('.fa-check');
                if (icon) icon.remove();
            });
            
            event.currentTarget.innerHTML += '<i class="fas fa-check" style="color: var(--primary-color);"></i>';
        }
        
        function closeAddToProjectModal() {
            document.getElementById('addToProjectModal').classList.remove('show');
            currentChatForProject = null;
            selectedProjectId = null;
        }
        
        function confirmAddToProject() {
            if (!currentChatForProject || !selectedProjectId) return;
            
            // Find project details from the sidebar
            const projectElement = document.querySelector(`[data-project-id="${selectedProjectId}"]`);
            if (!projectElement) return;
            
            const projectName = projectElement.querySelector('.chat-name').textContent;
            const iconElement = projectElement.querySelector('.chat-icon');
            const projectColor = iconElement ? (iconElement.style.color || '#4A90E2') : '#4A90E2';
            
            // Remove existing badge
            const existingBadge = currentChatForProject.querySelector('.project-badge');
            if (existingBadge) existingBadge.remove();
            
            // Add new badge
            const chatName = currentChatForProject.querySelector('.chat-name');
            const badge = document.createElement('span');
            badge.className = 'project-badge';
            badge.textContent = projectName.split(' ')[0];
            badge.style.cssText = `
                background-color: ${projectColor};
                color: white;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 11px;
                margin-left: 8px;
            `;
            const actions = currentChatForProject.querySelector('.chat-actions');
            currentChatForProject.insertBefore(badge, actions);
            
            // Set project ID
            currentChatForProject.setAttribute('data-project-id', selectedProjectId);
            
            showToast(`Chat added to ${projectName}`, 'success');
            closeAddToProjectModal();
        }
        
        function removeFromCurrentProject() {
            if (!currentChatForProject) return;
            
            const badge = currentChatForProject.querySelector('.project-badge');
            if (badge) badge.remove();
            currentChatForProject.removeAttribute('data-project-id');
            
            showToast('Chat removed from project', 'info');
            closeAddToProjectModal();
        }
        
        function createProjectFromSelector() {
            closeAddToProjectModal();
            // Create a fake event to prevent errors
            const fakeEvent = { stopPropagation: () => {} };
            createNewProject(fakeEvent);
        }
        
        // Handle project item clicks (prevent filtering when clicking menu)
        function handleProjectClick(event, projectId) {
            // Don't filter if clicking on the actions area
            if (event.target.closest('.chat-actions')) {
                return;
            }
            filterByProject(projectId);
        }
        
        // Project Management Functions
        function toggleProjectMenu(event, projectId) {
            event.stopPropagation();
            
            // Close any existing menus
            document.querySelectorAll('.project-menu-dropdown').forEach(menu => menu.remove());
            
            const projectItem = document.querySelector(`#projectsList [data-project-id="${projectId}"]`);
            if (!projectItem) return;
            
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            
            // Create menu
            const menu = document.createElement('div');
            menu.className = 'chat-menu-dropdown project-menu-dropdown show';
            menu.id = `project-menu-${projectId}`;
            
            // Position menu using fixed positioning
            menu.style.left = (rect.left - 180 + rect.width) + 'px';
            menu.style.top = (rect.bottom + 4) + 'px';
            
            menu.innerHTML = `
                <div class="chat-menu-item" onclick="editProject('${projectId}')">
                    <i class="fas fa-edit"></i>
                    <span>Edit Project</span>
                </div>
                <div class="chat-menu-item" onclick="viewProjectChats('${projectId}')">
                    <i class="fas fa-comments"></i>
                    <span>View Chats</span>
                </div>
                <div class="chat-menu-divider"></div>
                <div class="chat-menu-item danger" onclick="deleteProject('${projectId}')">
                    <i class="fas fa-trash"></i>
                    <span>Delete Project</span>
                </div>
            `;
            
            // Append to body instead of actions container (for fixed positioning)
            document.body.appendChild(menu);
            
            // Add click listener to close menu
            setTimeout(() => {
                document.addEventListener('click', closeAllProjectMenus);
            }, 0);
        }
        
        function closeAllProjectMenus() {
            document.querySelectorAll('.project-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
                setTimeout(() => menu.remove(), 200);
            });
            document.removeEventListener('click', closeAllProjectMenus);
        }
        
        // Library Menu Functions
        function toggleLibraryMenu(event, libraryId) {
            event.stopPropagation();
            
            // Close any existing menus
            document.querySelectorAll('.library-menu-dropdown').forEach(menu => menu.remove());
            
            const libraryItem = document.querySelector(`[data-library-id="${libraryId}"]`);
            if (!libraryItem) return;
            
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            
            // Create menu
            const menu = document.createElement('div');
            menu.className = 'chat-menu-dropdown library-menu-dropdown show';
            menu.id = `library-menu-${libraryId}`;
            
            // Position menu using fixed positioning
            menu.style.left = (rect.left - 180 + rect.width) + 'px';
            menu.style.top = (rect.bottom + 4) + 'px';
            
            menu.innerHTML = `
                <div class="chat-menu-item" onclick="showEditLibraryModal('${libraryId}')">
                    <i class="fas fa-edit"></i>
                    <span>Edit Library</span>
                </div>
                <div class="chat-menu-item" onclick="viewLibraryArtifacts('${libraryId}')">
                    <i class="fas fa-archive"></i>
                    <span>View Artifacts</span>
                </div>
                <div class="chat-menu-divider"></div>
                <div class="chat-menu-item danger" onclick="confirmDeleteLibrary('${libraryId}')">
                    <i class="fas fa-trash"></i>
                    <span>Delete Library</span>
                </div>
            `;
            
            // Append to body instead of actions container (for fixed positioning)
            document.body.appendChild(menu);
            
            // Add click listener to close menu
            setTimeout(() => {
                document.addEventListener('click', closeAllLibraryMenus);
            }, 0);
        }
        
        function closeAllLibraryMenus() {
            document.querySelectorAll('.library-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
                setTimeout(() => menu.remove(), 200);
            });
            document.removeEventListener('click', closeAllLibraryMenus);
        }
        
        function viewLibraryArtifacts(libraryId) {
            closeAllLibraryMenus();
            selectLibrary(libraryId);
        }
        
        function editProject(projectId) {
            closeAllProjectMenus();
            
            const projectItem = document.querySelector(`#projectsList [data-project-id="${projectId}"]`);
            if (!projectItem) return;
            
            currentProjectForEdit = projectId;
            
            // Get current project details
            const projectName = projectItem.querySelector('.chat-name').textContent;
            const iconElement = projectItem.querySelector('.chat-icon');
            const projectColor = iconElement ? (iconElement.style.color || '#4A90E2') : '#4A90E2';
            
            // Set values in modal
            document.getElementById('editProjectName').value = projectName;
            editProjectColor = projectColor;
            
            // Set color selection
            document.querySelectorAll('.edit-color-option').forEach(btn => {
                btn.style.borderColor = btn.dataset.color === projectColor ? 'var(--primary-color)' : 'transparent';
            });
            
            // Show modal
            document.getElementById('editProjectModal').classList.add('show');
        }
        
        function selectEditProjectColor(button) {
            document.querySelectorAll('.edit-color-option').forEach(btn => {
                btn.style.borderColor = 'transparent';
            });
            button.style.borderColor = 'var(--primary-color)';
            editProjectColor = button.dataset.color;
        }
        
        function closeEditProjectModal() {
            document.getElementById('editProjectModal').classList.remove('show');
            currentProjectForEdit = null;
        }
        
        function confirmEditProject() {
            if (!currentProjectForEdit) return;
            
            const newName = document.getElementById('editProjectName').value.trim();
            if (!newName) return;
            
            const projectItem = document.querySelector(`#projectsList [data-project-id="${currentProjectForEdit}"]`);
            if (!projectItem) return;
            
            // Update project name
            projectItem.querySelector('.chat-name').textContent = newName;
            
            // Update project color
            const iconElement = projectItem.querySelector('.chat-icon');
            if (iconElement) {
                iconElement.style.color = editProjectColor;
            }
            
            // Update all chat badges with this project
            document.querySelectorAll(`[data-project-id="${currentProjectForEdit}"] .project-badge`).forEach(badge => {
                badge.textContent = newName.split(' ')[0];
                badge.style.backgroundColor = editProjectColor;
            });
            
            // Update badges in chats
            document.querySelectorAll(`#allChats [data-project-id="${currentProjectForEdit}"] .project-badge`).forEach(badge => {
                badge.textContent = newName.split(' ')[0];
                badge.style.backgroundColor = editProjectColor;
            });
            
            showToast('Project updated successfully', 'success');
            closeEditProjectModal();
        }
        
        function deleteProject(projectId) {
            closeAllProjectMenus();
            
            const projectItem = document.querySelector(`#projectsList [data-project-id="${projectId}"]`);
            if (!projectItem) return;
            
            currentProjectForEdit = projectId;
            
            // Get project details
            const projectName = projectItem.querySelector('.chat-name').textContent;
            
            // Count associated chats
            const associatedChats = document.querySelectorAll(`#allChats [data-project-id="${projectId}"]`).length;
            
            // Update modal
            document.getElementById('deleteProjectName').textContent = projectName;
            document.getElementById('deleteProjectChatCount').textContent = associatedChats;
            
            // Show modal
            document.getElementById('deleteProjectModal').classList.add('show');
        }
        
        function closeDeleteProjectModal() {
            document.getElementById('deleteProjectModal').classList.remove('show');
            currentProjectForEdit = null;
        }
        
        function confirmDeleteProject() {
            if (!currentProjectForEdit) return;
            
            // Remove project from sidebar
            const projectItem = document.querySelector(`#projectsList [data-project-id="${currentProjectForEdit}"]`);
            if (projectItem) {
                projectItem.remove();
            }
            
            // Remove project association from all chats
            document.querySelectorAll(`#allChats [data-project-id="${currentProjectForEdit}"]`).forEach(chat => {
                chat.removeAttribute('data-project-id');
                const badge = chat.querySelector('.project-badge');
                if (badge) badge.remove();
            });
            
            // Clear filter if this project was being filtered
            const filterIndicator = document.getElementById('filterIndicator');
            if (filterIndicator) {
                filterByProject('all');
            }
            
            showToast('Project deleted successfully', 'success');
            closeDeleteProjectModal();
        }
        
        function viewProjectChats(projectId) {
            closeAllProjectMenus();
            filterByProject(projectId);
        }
        
        function filterByProject(projectId) {
            const allChats = document.querySelectorAll('#allChats .chat-item');
            const chatsHeader = document.querySelector('.section-title span');
            
            // Check if we have an existing filter indicator
            let filterIndicator = document.getElementById('filterIndicator');
            
            if (projectId === 'all') {
                // Clear filter - show all chats
                allChats.forEach(chat => {
                    chat.style.display = 'flex';
                });
                
                // Remove filter indicator
                if (filterIndicator) {
                    filterIndicator.remove();
                }
                
                // Reset header text
                if (chatsHeader) {
                    chatsHeader.textContent = 'Chats';
                }
                
                showToast('Showing all chats', 'info');
            } else {
                // Apply filter
                let visibleCount = 0;
                allChats.forEach(chat => {
                    const chatProjectId = chat.getAttribute('data-project-id');
                    if (chatProjectId === projectId) {
                        chat.style.display = 'flex';
                        visibleCount++;
                    } else {
                        chat.style.display = 'none';
                    }
                });
                
                // Find project name
                const projectItem = document.querySelector(`[data-project-id="${projectId}"] .chat-name`);
                const projectName = projectItem ? projectItem.textContent : projectId;
                
                // Update header to show filter
                if (chatsHeader) {
                    chatsHeader.innerHTML = `Chats <span style="color: var(--primary-color);">(${projectName})</span>`;
                }
                
                // Add or update filter indicator
                if (!filterIndicator) {
                    filterIndicator = document.createElement('div');
                    filterIndicator.id = 'filterIndicator';
                    filterIndicator.style.cssText = `
                        background: var(--primary-color);
                        color: white;
                        padding: 6px 12px;
                        margin: 8px 12px;
                        border-radius: 6px;
                        font-size: 12px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        cursor: pointer;
                    `;
                    filterIndicator.onclick = () => filterByProject('all');
                    
                    const chatsSection = document.getElementById('allChats');
                    chatsSection.parentNode.insertBefore(filterIndicator, chatsSection);
                }
                
                filterIndicator.innerHTML = `
                    <span>Filtered: ${projectName} (${visibleCount} chats)</span>
                    <span style="font-weight: bold;"> Clear</span>
                `;
                
                showToast(`Showing ${visibleCount} chats in ${projectName}`, 'info');
            }
        }
        
        function starChat() {
            if (currentContextChat) {
                const chatName = currentContextChat.querySelector('.chat-name').textContent;
                const starredChats = document.getElementById('starredChats');
                
                // Check if already starred
                const existingStarred = Array.from(starredChats.children).find(
                    item => item.querySelector('.chat-name').textContent === chatName
                );
                
                if (!existingStarred) {
                    const starredChat = currentContextChat.cloneNode(true);
                    starredChat.classList.remove('active');
                    starredChat.querySelector('.chat-icon').className = 'fas fa-star chat-icon';
                    starredChat.querySelector('.chat-icon').style.color = '#f39c12';
                    
                    // Re-attach event listeners
                    starredChat.onclick = function() { selectChat(this, Date.now()); };
                    starredChat.oncontextmenu = function(e) { showContextMenu(e, this); };
                    
                    // Re-attach button listeners
                    const editBtn = starredChat.querySelector('.chat-action-btn:not(.delete)');
                    const deleteBtn = starredChat.querySelector('.chat-action-btn.delete');
                    if (editBtn) editBtn.onclick = function(e) { editChatName(e, this); };
                    if (deleteBtn) deleteBtn.onclick = function(e) { deleteChat(e, this); };
                    
                    starredChats.appendChild(starredChat);
                    
                    // Expand starred section
                    const starredSection = starredChats.closest('.sidebar-section').querySelector('.section-header');
                    if (!starredSection.classList.contains('expanded')) {
                        starredSection.classList.add('expanded');
                        starredChats.classList.add('expanded');
                    }
                }
            }
            hideContextMenu();
        }

        function archiveChat() {
            if (currentContextChat) {
                const wasActive = currentContextChat.classList.contains('active');
                currentContextChat.remove();
                
                if (wasActive) {
                    // Select first available chat
                    const firstChat = document.querySelector('.chat-item');
                    if (firstChat) {
                        firstChat.click();
                    } else {
                        // No chats left, show empty state
                        document.getElementById('chatTitle').textContent = 'No Chat Selected';
                        clearMessages();
                    }
                }
            }
            hideContextMenu();
        }

        function exportFromContext() {
            showToast('Export feature coming soon', 'info', 'Export');
            hideContextMenu();
        }

        // Modal functions
        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('show');
            currentEditingChat = null;
        }

        function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (newName && currentEditingChat) {
                const chatNameElement = currentEditingChat.querySelector('.chat-name');
                chatNameElement.textContent = newName;
                
                // Update header if this is the active chat
                if (currentEditingChat.classList.contains('active')) {
                    document.getElementById('chatTitle').textContent = newName;
                }
            }
            closeRenameModal();
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            currentEditingChat = null;
        }

        function confirmDelete() {
            if (currentEditingChat) {
                const wasActive = currentEditingChat.classList.contains('active');
                currentEditingChat.remove();
                
                if (wasActive) {
                    // Select first available chat
                    const firstChat = document.querySelector('.chat-item');
                    if (firstChat) {
                        firstChat.click();
                    } else {
                        // No chats left, show empty state
                        document.getElementById('chatTitle').textContent = 'No Chat Selected';
                        clearMessages();
                    }
                }
            }
            closeDeleteModal();
        }

        // Artifact Delete Function
        function deleteArtifact(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            showDeleteModal(
                'Remove Artifact',
                'This artifact will be removed from all libraries permanently.',
                artifact.name,
                () => {
                    // Remove from all libraries
                    librariesData.libraries.forEach(library => {
                        library.artifacts = library.artifacts.filter(id => id !== artifactId);
                    });
                    
                    // Remove from artifacts object
                    delete librariesData.artifacts[artifactId];
                
                    // Update UI
                    const artifactElements = document.querySelectorAll(`[data-artifact-id="${artifactId}"]`);
                    artifactElements.forEach(element => element.remove());
                    
                    // Save to localStorage
                    librariesManager.saveToStorage();
                    showToast('Artifact removed from libraries', 'success');
                }
            );
        }
        
        // Artifact Management System
        class ArtifactManager {
            constructor() {
                this.artifacts = this.loadArtifacts();
                this.NEW_THRESHOLD = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            }
            
            loadArtifacts() {
                const stored = localStorage.getItem('artifactsData');
                if (stored) {
                    return JSON.parse(stored);
                }
                
                // Demo artifacts with timestamps
                const now = Date.now();
                return {
                    'artifact-1': {
                        id: 'artifact-1',
                        title: 'API Authentication Documentation',
                        type: 'markdown',
                        content: '## Authentication API Reference\n\n### POST /auth/login\nAuthenticates a user and returns access tokens...',
                        created: now - (2 * 60 * 60 * 1000), // 2 hours ago
                        modified: now - (2 * 60 * 60 * 1000),
                        author: 'Documentation Agent',
                        projectId: 'project-1'
                    },
                    'artifact-2': {
                        id: 'artifact-2',
                        title: 'User Engagement Analytics',
                        type: 'chart',
                        content: 'Daily Active Users: 12.5K | Monthly Growth: +23% | Retention Rate: 87%...',
                        created: now - (48 * 60 * 60 * 1000), // 2 days ago
                        modified: now - (48 * 60 * 60 * 1000),
                        author: 'Analysis Agent',
                        projectId: 'project-1'
                    },
                    'artifact-3': {
                        id: 'artifact-3',
                        title: 'React Login Component',
                        type: 'code',
                        content: 'import React, { useState } from \'react\';\nconst LoginForm = () => { ...',
                        created: now - (10 * 60 * 1000), // 10 minutes ago - NEW!
                        modified: now - (10 * 60 * 1000),
                        author: 'Code Agent',
                        projectId: 'project-1'
                    }
                };
            }
            
            saveArtifacts() {
                localStorage.setItem('artifactsData', JSON.stringify(this.artifacts));
            }
            
            isNew(artifactId) {
                const artifact = this.artifacts[artifactId];
                if (!artifact) return false;
                
                const age = Date.now() - artifact.created;
                return age < this.NEW_THRESHOLD;
            }
            
            getArtifact(artifactId) {
                return this.artifacts[artifactId];
            }
            
            createArtifact(data) {
                const id = `artifact-${Date.now()}`;
                const artifact = {
                    id,
                    title: data.title,
                    type: data.type,
                    content: data.content,
                    created: Date.now(),
                    modified: Date.now(),
                    author: data.author || 'Code Agent',
                    projectId: data.projectId || 'project-1',
                    version: 1,
                    versions: [{
                        version: 1,
                        content: data.content,
                        author: data.author || 'Code Agent',
                        timestamp: Date.now(),
                        message: 'Initial version'
                    }],
                    forkParent: null,
                    forkChildren: []
                };
                
                this.artifacts[id] = artifact;
                this.saveArtifacts();
                return artifact;
            }
            
            updateArtifact(artifactId, newContent, author = 'User', message = '') {
                const artifact = this.artifacts[artifactId];
                if (!artifact) return null;
                
                artifact.version++;
                artifact.content = newContent;
                artifact.modified = Date.now();
                
                artifact.versions.push({
                    version: artifact.version,
                    content: newContent,
                    author: author,
                    timestamp: Date.now(),
                    message: message || `Version ${artifact.version} update`
                });
                
                this.saveArtifacts();
                return artifact;
            }
            
            forkArtifact(artifactId, targetChatId) {
                const original = this.artifacts[artifactId];
                if (!original) return null;
                
                const forkedId = `artifact-${Date.now()}`;
                const forked = {
                    ...original,
                    id: forkedId,
                    title: `${original.title} (Fork)`,
                    created: Date.now(),
                    modified: Date.now(),
                    version: 1,
                    versions: [{
                        version: 1,
                        content: original.content,
                        author: 'Forked',
                        timestamp: Date.now(),
                        message: `Forked from ${original.title}`
                    }],
                    forkParent: artifactId,
                    forkChildren: [],
                    chatId: targetChatId
                };
                
                // Update parent's fork children
                if (!original.forkChildren) original.forkChildren = [];
                original.forkChildren.push(forkedId);
                
                this.artifacts[forkedId] = forked;
                this.saveArtifacts();
                return forked;
            }
        }
        
        const artifactManager = new ArtifactManager();
        
        // Save artifact to library functionality
        let currentArtifactToSave = null;
        
        function saveArtifactToLibrary(artifactId, title, type) {
            const artifact = artifactManager.getArtifact(artifactId);
            currentArtifactToSave = artifact || { id: artifactId, title, type };
            openSaveToLibraryModal();
        }
        
        function openSaveToLibraryModal() {
            const modal = document.getElementById('saveToLibraryModal');
            const select = document.getElementById('librarySelect');
            const previewName = document.getElementById('artifactPreviewName');
            
            // Show artifact name in preview
            if (currentArtifactToSave) {
                previewName.textContent = currentArtifactToSave.title;
            }
            
            // Populate library options
            const libraries = librariesManager.libraries;
            select.innerHTML = '<option value="">Select a library...</option>';
            
            libraries.forEach(library => {
                const option = document.createElement('option');
                option.value = library.id;
                option.textContent = library.name;
                select.appendChild(option);
            });
            
            // Add option to create new library
            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = '+ Create New Library';
            newOption.style.fontStyle = 'italic';
            select.appendChild(newOption);
            
            modal.style.display = 'flex';
        }
        
        function closeSaveToLibraryModal() {
            document.getElementById('saveToLibraryModal').style.display = 'none';
            currentArtifactToSave = null;
        }
        
        function confirmSaveToLibrary() {
            const select = document.getElementById('librarySelect');
            const selectedValue = select.value;
            
            if (!selectedValue) {
                showToast('Please select a library', 'warning');
                return;
            }
            
            if (selectedValue === 'new') {
                // Close save modal and open create library modal
                closeSaveToLibraryModal();
                openCreateLibraryModal();
                return;
            }
            
            // Add artifact to selected library
            if (currentArtifactToSave) {
                const library = librariesManager.libraries.find(lib => lib.id === selectedValue);
                if (library) {
                    // Check if artifact already exists in library
                    const exists = library.artifacts.some(a => a.id === currentArtifactToSave.id);
                    if (exists) {
                        showToast(`"${currentArtifactToSave.title}" is already in ${library.name}`, 'warning');
                    } else {
                        // First ensure the artifact exists in librariesData.artifacts
                        if (!librariesData.artifacts[currentArtifactToSave.id]) {
                            librariesData.artifacts[currentArtifactToSave.id] = {
                                id: currentArtifactToSave.id,
                                name: currentArtifactToSave.title || currentArtifactToSave.name,
                                type: currentArtifactToSave.type,
                                content: currentArtifactToSave.content,
                                libraries: [],
                                created: new Date().toISOString()
                            };
                        }
                        
                        // Now add the artifact to the library
                        librariesManager.addArtifactToLibrary(currentArtifactToSave.id, selectedValue);
                        showToast(`Saved "${currentArtifactToSave.title}" to ${library.name}`, 'success', 'Artifact Saved');
                        
                        // Update library count in UI
                        const libraryItem = document.querySelector(`[data-library-id="${selectedValue}"]`);
                        if (libraryItem) {
                            const countElement = libraryItem.querySelector('.library-count');
                            if (countElement) {
                                countElement.textContent = library.artifacts.length + 1;
                            }
                        }
                    }
                }
                closeSaveToLibraryModal();
            }
        }

        // Libraries Modal Functions
        let originalSidebarContent = null; // Store original sidebar content
        
        // Switch between Chats and Libraries views
        function switchToView(view) {
            const chatView = document.getElementById('chatView');
            const librariesView = document.getElementById('librariesView');
            const sidebar = document.querySelector('.sidebar');
            const sidebarContent = document.querySelector('.sidebar-content');
            
            // Update nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });
            
            if (view === 'libraries') {
                // Save original sidebar content if not already saved
                if (!originalSidebarContent && sidebarContent) {
                    originalSidebarContent = sidebarContent.innerHTML;
                }
                
                // Switch to Libraries view
                chatView.style.display = 'none';
                librariesView.style.display = 'flex';
                librariesView.style.left = '260px'; // Keep space for sidebar
                
                // Transform sidebar to show libraries
                const workspaceTitle = sidebar.querySelector('.workspace-name');
                if (workspaceTitle) {
                    workspaceTitle.innerHTML = '<i class="fas fa-folder"></i> Libraries';
                }
                
                // Replace New Chat button with New Library button
                const quickActions = sidebar.querySelector('.quick-actions');
                if (quickActions) {
                    const newChatBtn = quickActions.querySelector('.new-chat-btn');
                    if (newChatBtn) {
                        // Store original button HTML
                        if (!newChatBtn.dataset.originalHtml) {
                            newChatBtn.dataset.originalHtml = newChatBtn.innerHTML;
                        }
                        // Transform to New Library button
                        newChatBtn.innerHTML = '<i class="fas fa-plus"></i> New Library';
                        newChatBtn.onclick = (e) => createNewLibrary(e);
                    }
                }
                
                // Update workspace header
                const workspaceHeader = sidebar.querySelector('.workspace-header');
                if (workspaceHeader) {
                    let headerTitle = workspaceHeader.querySelector('.sidebar-title');
                    if (!headerTitle) {
                        // Create a title if it doesn't exist
                        const title = document.createElement('div');
                        title.className = 'sidebar-title libraries-title'; // Add a specific class
                        title.innerHTML = '<i class="fas fa-folder"></i> <span>Libraries</span>';
                        title.style.cssText = 'font-size: 16px; font-weight: 600; color: white; padding: 12px 16px;';
                        workspaceHeader.appendChild(title);
                    } else {
                        // Store original content if not already stored
                        if (!headerTitle.dataset.originalContent) {
                            headerTitle.dataset.originalContent = headerTitle.innerHTML;
                        }
                        headerTitle.innerHTML = '<i class="fas fa-folder"></i> <span>Libraries</span>';
                        headerTitle.style.color = 'white';
                    }
                }
                
                // Update search placeholder
                const searchInput = sidebar.querySelector('.sidebar-search-input');
                if (searchInput) {
                    searchInput.placeholder = 'Search libraries...';
                }
                
                // Replace channels list with libraries list
                renderLibrariesInSidebar();
                
                // Load libraries in main view
                renderLibrariesView();
            } else {
                // Switch to Chats view
                chatView.style.display = 'flex';
                librariesView.style.display = 'none';
                
                // Restore sidebar to show channels
                const workspaceTitle = sidebar.querySelector('.workspace-name');
                if (workspaceTitle) {
                    workspaceTitle.innerHTML = '<i class="fas fa-comments"></i> Agent Workspace';
                }
                
                // Restore the New Chat button
                const quickActions = sidebar.querySelector('.quick-actions');
                if (quickActions) {
                    const newChatBtn = quickActions.querySelector('.new-chat-btn');
                    if (newChatBtn && newChatBtn.dataset.originalHtml) {
                        // Restore original button
                        newChatBtn.innerHTML = newChatBtn.dataset.originalHtml;
                        newChatBtn.onclick = (e) => createNewChat(e);
                    }
                }
                
                // Restore workspace header
                const workspaceHeader = sidebar.querySelector('.workspace-header');
                if (workspaceHeader) {
                    let headerTitle = workspaceHeader.querySelector('.sidebar-title');
                    if (headerTitle) {
                        if (headerTitle.classList.contains('libraries-title')) {
                            // Remove the Libraries title we added
                            headerTitle.remove();
                        } else if (headerTitle.dataset.originalContent) {
                            // Restore original content
                            headerTitle.innerHTML = headerTitle.dataset.originalContent;
                            headerTitle.style.color = ''; // Reset color
                            delete headerTitle.dataset.originalContent;
                        }
                    }
                    // Make sure Conversations title exists
                    headerTitle = workspaceHeader.querySelector('.sidebar-title');
                    if (!headerTitle) {
                        const title = document.createElement('div');
                        title.className = 'sidebar-title';
                        title.innerHTML = '<i class="fas fa-comments"></i> <span>Conversations</span>';
                        workspaceHeader.appendChild(title);
                    }
                }
                
                // Restore search placeholder
                const searchInput = sidebar.querySelector('.sidebar-search-input');
                if (searchInput) {
                    searchInput.placeholder = 'Search chats...';
                }
                
                // Restore original sidebar content
                if (originalSidebarContent && sidebarContent) {
                    sidebarContent.innerHTML = originalSidebarContent;
                }
            }
        }
        
        function renderLibrariesInSidebar() {
            // Find the sidebar content container
            const sidebarContent = document.querySelector('.sidebar-content');
            if (!sidebarContent) return;
            
            const libraries = librariesData.libraries || [];
            
            // Replace entire sidebar content with libraries
            sidebarContent.innerHTML = `
                <div class="sidebar-section">
                    <div class="section-header">
                        <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">YOUR LIBRARIES</span>
                    </div>
                    <div class="chat-list expanded">
                        ${libraries.map(library => {
                            const artifactCount = library.artifacts ? library.artifacts.length : 0;
                            return `
                                <div class="chat-item" 
                                     onclick="selectLibrary('${library.id}')"
                                     data-library-id="${library.id}"
                                     style="cursor: pointer;">
                                    <i class="fas ${library.icon}" style="color: ${library.color}; width: 16px;"></i>
                                    <span class="chat-name">${library.name}</span>
                                    <span class="chat-badge" style="margin-left: auto;">
                                        ${artifactCount}
                                    </span>
                                    <div class="chat-actions">
                                        <button class="chat-action-btn" onclick="toggleLibraryMenu(event, '${library.id}')" title="Options">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function selectLibrary(libraryId) {
            console.log('selectLibrary called with:', libraryId);
            
            // Highlight selected library in sidebar
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[data-library-id="${libraryId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // Show only this library's content in main view
            renderSingleLibraryView(libraryId);
        }
        
        function renderSingleLibraryView(libraryId) {
            console.log('renderSingleLibraryView called with:', libraryId);
            console.log('librariesData:', librariesData);
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) {
                console.error('Library not found:', libraryId);
                return;
            }
            console.log('Found library:', library);
            
            const librariesContent = document.getElementById('librariesContent');
            if (!librariesContent) {
                console.error('librariesContent element not found');
                return;
            }
            
            const artifacts = library.artifacts ? 
                library.artifacts.map(id => librariesData.artifacts[id]).filter(Boolean) : [];
            
            console.log('Library artifacts property:', library.artifacts);
            console.log('Resolved artifacts:', artifacts);
            
            // Update breadcrumb
            updateBreadcrumb([{ id: library.id, name: library.name }]);
            
            // Clear and show only this library's artifacts (without the folder header)
            librariesContent.innerHTML = '';
            
            // Create a container for just the artifacts
            const artifactsContainer = document.createElement('div');
            artifactsContainer.className = 'library-items-grid';
            artifactsContainer.style.cssText = 'padding: 24px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;';
            
            if (artifacts.length > 0) {
                console.log(`Creating ${artifacts.length} artifact cards`);
                artifacts.forEach(artifact => {
                    console.log('Creating card for artifact:', artifact);
                    const card = createArtifactCard(artifact, library.id);
                    artifactsContainer.appendChild(card);
                });
            } else {
                console.log('No artifacts found for this library');
                artifactsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 48px; color: var(--text-secondary);">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>No artifacts in this library yet</p>
                        <p style="font-size: 13px; margin-top: 8px;">Drag artifacts here or use the Add button to get started</p>
                    </div>
                `;
            }
            
            librariesContent.appendChild(artifactsContainer);
            console.log('Appended artifacts container to librariesContent');
            console.log('Final HTML:', librariesContent.innerHTML);
        }
        
        function createArtifactCard(artifact, libraryId) {
            const card = document.createElement('div');
            card.className = 'library-artifact-card';
            card.draggable = true;
            card.onclick = () => openArtifactFromLibrary(artifact.id);
            card.oncontextmenu = (e) => showArtifactContextMenu(e, artifact.id, libraryId);
            card.ondragstart = (e) => handleArtifactDragStart(e, artifact.id, libraryId);
            
            const getArtifactIcon = (type) => {
                const icons = {
                    'code': 'fa-code',
                    'document': 'fa-file-alt',
                    'data': 'fa-database',
                    'chart': 'fa-chart-bar',
                    'image': 'fa-image',
                    'api': 'fa-plug',
                    'config': 'fa-cog'
                };
                return icons[type] || 'fa-file';
            };
            
            card.innerHTML = `
                <div class="artifact-card-header">
                    <i class="fas ${getArtifactIcon(artifact.type)} artifact-card-icon"></i>
                    <div class="artifact-card-info">
                        <div class="artifact-card-title">${artifact.name}</div>
                        <div class="artifact-card-meta">
                            <span class="artifact-type-badge">${artifact.type || 'document'}</span>
                            ${artifact.version ? `<span class="artifact-version-badge">v${artifact.version}</span>` : ''}
                        </div>
                    </div>
                </div>
                ${artifact.preview ? `
                    <div class="artifact-card-preview">
                        ${artifact.preview}
                    </div>
                ` : ''}
                <div class="artifact-card-footer">
                    <span class="artifact-date" style="color: var(--text-secondary);">Actions</span>
                    <div class="artifact-card-actions" style="opacity: 1; margin-left: auto;">
                        <button onclick="event.stopPropagation(); editArtifactName('${artifact.id}', '${libraryId}')" title="Edit" style="color: #6b7280;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); moveArtifactToLibrary('${artifact.id}', '${libraryId}')" title="Move" style="color: #6b7280;">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button onclick="event.stopPropagation(); duplicateArtifact('${artifact.id}', '${libraryId}')" title="Duplicate" style="color: #6b7280;">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="event.stopPropagation(); removeArtifactFromLibrary('${artifact.id}', '${libraryId}')" title="Remove" style="color: #6b7280;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function renderLibrariesView() {
            console.log('renderLibrariesView called');
            console.log('librariesData:', librariesData);
            
            // Check if we're in the libraries view
            const librariesView = document.getElementById('librariesView');
            console.log('Libraries view display:', librariesView ? librariesView.style.display : 'not found');
            
            // Show libraries landing page
            showLibrariesLandingPage();
        }
        
        function showLibrariesLandingPage() {
            const librariesContent = document.getElementById('librariesContent');
            if (!librariesContent) return;
            
            const libraries = librariesData.libraries || [];
            
            // Clear breadcrumb for landing page
            updateBreadcrumb([]);
            
            // Clear sidebar selection
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (libraries.length > 0) {
                // Create library cards grid
                librariesContent.innerHTML = `
                    <div style="padding: 32px;">
                        <h2 style="font-size: 24px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Your Libraries</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">Select a library to view and manage its artifacts</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                            ${libraries.map(library => {
                                const artifactCount = library.artifacts ? library.artifacts.length : 0;
                                const recentArtifacts = library.artifacts ? 
                                    library.artifacts.slice(0, 3).map(id => librariesData.artifacts[id]).filter(Boolean) : [];
                                
                                return `
                                    <div class="library-card" onclick="selectLibrary('${library.id}')" style="
                                        background: white;
                                        border: 1px solid var(--border-color);
                                        border-radius: 12px;
                                        padding: 20px;
                                        cursor: pointer;
                                        transition: all 0.2s;
                                        border-left: 4px solid ${library.color};
                                        height: 200px;
                                        display: flex;
                                        flex-direction: column;
                                    " onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" 
                                       onmouseout="this.style.boxShadow=''; this.style.transform=''">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                            <i class="fas ${library.icon}" style="color: ${library.color}; font-size: 24px;"></i>
                                            <div style="flex: 1;">
                                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">${library.name}</h3>
                                                <span style="font-size: 12px; color: var(--text-secondary);">${artifactCount} artifact${artifactCount !== 1 ? 's' : ''}</span>
                                            </div>
                                        </div>
                                        ${library.description ? `
                                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.4;">
                                                ${library.description}
                                            </p>
                                        ` : ''}
                                        <div style="margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                            ${recentArtifacts.length > 0 ? `
                                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">Recent artifacts:</div>
                                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                                    ${recentArtifacts.map(artifact => `
                                                        <span style="
                                                            font-size: 11px;
                                                            padding: 2px 6px;
                                                            background: var(--surface);
                                                            border-radius: 4px;
                                                            color: var(--text-secondary);
                                                        ">${artifact.name}</span>
                                                    `).join('')}
                                                </div>
                                            ` : `
                                                <div style="font-size: 12px; color: var(--text-secondary); font-style: italic;">
                                                    No artifacts yet
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Show empty state
                librariesContent.innerHTML = `
                    <div style="text-align: center; padding: 48px; color: var(--text-secondary);">
                        <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p style="font-size: 18px; margin-bottom: 8px;">No libraries yet</p>
                        <p>Create your first library to organize artifacts.</p>
                        <button onclick="createNewLibrary()" style="
                            margin-top: 16px;
                            padding: 10px 20px;
                            background: var(--mj-blue);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                        ">
                            <i class="fas fa-plus" style="margin-right: 8px;"></i>
                            Create Library
                        </button>
                    </div>
                `;
            }
        }
        
        // Commented out - replaced with inline expansion
        // function openLibrary(libraryId) {
        //     // This function was replacing the entire view - now we expand inline instead
        // }
        
        function viewArtifactInLibrary(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // Take over the entire libraries content area
            const content = document.getElementById('librariesContent');
            content.innerHTML = `
                <div class="artifact-full-view">
                    <div class="artifact-view-header">
                        <button class="btn-secondary" onclick="history.back()">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <h2>${artifact.name}</h2>
                        <div class="artifact-view-actions">
                            <button class="btn-secondary" onclick="forkArtifact('${artifact.id}')">
                                <i class="fas fa-code-branch"></i> Fork
                            </button>
                            <button class="btn-primary" onclick="editArtifact('${artifact.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                    </div>
                    <div class="artifact-view-content">
                        <pre><code>${artifact.content}</code></pre>
                    </div>
                </div>
            `;
        }
        
        function openLibrariesModal() {
            const modal = document.getElementById('librariesModal');
            modal.style.display = 'flex';
            renderLibrariesInModal();
            updateLibraryCount();
        }
        
        function closeLibrariesModal() {
            document.getElementById('librariesModal').style.display = 'none';
        }
        
        function renderLibrariesInModal() {
            // First, reset the modal body to the libraries list view
            const modalBody = document.querySelector('#librariesModal .modal-body');
            if (!modalBody) return;
            
            // Restore the libraries list structure
            modalBody.innerHTML = `
                <div style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
                    <div class="library-search-bar" style="display: flex; gap: 12px; margin-bottom: 20px;">
                        <input type="text" placeholder="Search libraries..." onkeyup="searchLibraries(event)" 
                               style="flex: 1; padding: 10px 16px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 14px;">
                        <div class="view-toggle" style="display: flex; gap: 8px;">
                            <button onclick="toggleLibraryView('grid')" class="view-btn active" id="gridViewBtn" 
                                    style="padding: 8px 12px; background: var(--mj-blue); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-th"></i>
                            </button>
                            <button onclick="toggleLibraryView('list')" class="view-btn" id="listViewBtn"
                                    style="padding: 8px 12px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="flex: 1; overflow-y: auto; min-height: 0;">
                        <div id="librariesGrid" class="libraries-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <!-- Grid items will be rendered here -->
                        </div>
                        
                        <div id="librariesList" class="libraries-list" style="display: none;">
                            <!-- List items will be rendered here -->
                        </div>
                    </div>
                </div>
            `;
            
            const gridContainer = document.getElementById('librariesGrid');
            const listContainer = document.getElementById('librariesList');
            const libraries = librariesManager.libraries;
            
            // Render Grid View
            gridContainer.innerHTML = '';
            libraries.forEach(library => {
                const card = document.createElement('div');
                card.className = 'library-card';
                card.style.cssText = `
                    background: white;
                    border: 1px solid #e5e5e5;
                    border-radius: 8px;
                    padding: 20px;
                    cursor: pointer;
                    transition: all 0.2s;
                    position: relative;
                `;
                card.onmouseover = () => card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                card.onmouseout = () => card.style.boxShadow = 'none';
                
                card.innerHTML = `
                    <div style="display: flex; align-items: start; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; background: ${library.color}20; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${library.icon}" style="color: ${library.color}; font-size: 18px;"></i>
                            </div>
                            <div>
                                <h4 style="margin: 0; color: #333; font-size: 16px;">${library.name}</h4>
                                <p style="margin: 4px 0 0; color: #666; font-size: 12px;">${library.artifacts.length} artifacts</p>
                            </div>
                        </div>
                        <div class="library-card-actions" style="display: flex; gap: 4px;">
                            <button onclick="event.stopPropagation(); editLibrary('${library.id}')" style="padding: 4px 8px; background: transparent; border: none; color: #666; cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteLibrary('${library.id}')" style="padding: 4px 8px; background: transparent; border: none; color: #666; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p style="color: #888; font-size: 13px; margin: 12px 0;">${library.description || 'No description'}</p>
                    <div style="border-top: 1px solid #f0f0f0; margin-top: 16px; padding-top: 12px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            ${library.artifacts.slice(0, 3).map(artifact => `
                                <span style="display: inline-block; padding: 4px 8px; background: #f4f4f4; border-radius: 4px; font-size: 11px; color: #666;">
                                    ${artifact.title}
                                </span>
                            `).join('')}
                            ${library.artifacts.length > 3 ? `
                                <span style="display: inline-block; padding: 4px 8px; background: #f4f4f4; border-radius: 4px; font-size: 11px; color: #999;">
                                    +${library.artifacts.length - 3} more
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                card.onclick = () => viewLibraryDetails(library.id);
                gridContainer.appendChild(card);
            });
            
            // Add empty state if no libraries
            if (libraries.length === 0) {
                gridContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-folder-open" style="font-size: 64px; color: #ddd; margin-bottom: 16px;"></i>
                        <h3 style="color: #666; margin-bottom: 8px;">No Libraries Yet</h3>
                        <p style="color: #999; margin-bottom: 20px;">Create your first library to start organizing artifacts</p>
                        <button class="btn-primary" onclick="openCreateLibraryModal()" style="padding: 10px 20px; background: var(--mj-blue); color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Create Library
                        </button>
                    </div>
                `;
            }
        }
        
        function toggleLibraryView(view) {
            const gridContainer = document.getElementById('librariesGrid');
            const listContainer = document.getElementById('librariesList');
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (view === 'grid') {
                gridContainer.style.display = 'grid';
                listContainer.style.display = 'none';
                gridBtn.style.background = 'var(--mj-blue)';
                gridBtn.style.color = 'white';
                listBtn.style.background = 'white';
                listBtn.style.color = '#333';
            } else {
                gridContainer.style.display = 'none';
                listContainer.style.display = 'block';
                listBtn.style.background = 'var(--mj-blue)';
                listBtn.style.color = 'white';
                gridBtn.style.background = 'white';
                gridBtn.style.color = '#333';
                renderLibrariesList();
            }
        }
        
        function setLibraryView(view) {
            // Alias for compatibility
            toggleLibraryView(view);
        }
        
        function renderLibrariesList() {
            const listContainer = document.getElementById('librariesList');
            const libraries = librariesManager.libraries;
            
            listContainer.innerHTML = libraries.map(library => `
                <div class="library-list-item" style="display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; margin-bottom: 8px; cursor: pointer;" onclick="viewLibraryDetails('${library.id}')">
                    <div style="width: 32px; height: 32px; background: ${library.color}20; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                        <i class="fas ${library.icon}" style="color: ${library.color}; font-size: 14px;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #333; font-size: 14px;">${library.name}</div>
                        <div style="color: #666; font-size: 12px; margin-top: 2px;">${library.description || 'No description'}</div>
                    </div>
                    <div style="color: #999; font-size: 13px; margin-right: 16px;">${library.artifacts.length} artifacts</div>
                    <div class="library-list-actions" style="display: flex; gap: 8px;">
                        <button onclick="event.stopPropagation(); editLibrary('${library.id}')" style="padding: 4px 8px; background: transparent; border: none; color: #666; cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteLibrary('${library.id}')" style="padding: 4px 8px; background: transparent; border: none; color: #666; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function viewLibraryDetails(libraryId) {
            const library = librariesManager.libraries.find(lib => lib.id === libraryId);
            if (!library) return;
            
            // Store current library for reference
            window.currentLibraryId = libraryId;
            
            // Update modal to show library details
            const modalContent = document.querySelector('#librariesModal .modal-body');
            
            modalContent.innerHTML = `
                <div class="library-detail-view" style="height: 100%; display: flex; flex-direction: column; overflow: hidden; padding: 20px;">
                    <!-- Header with back button -->
                    <div style="display: flex; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e5e5e5; flex-shrink: 0;">
                        <button onclick="backToLibrariesList()" style="padding: 8px 12px; background: transparent; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; margin-right: 16px;">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <div style="width: 40px; height: 40px; background: ${library.color}20; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                            <i class="fas ${library.icon}" style="color: ${library.color}; font-size: 18px;"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 20px; color: #333;">${library.name}</h3>
                            <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">${library.description || 'No description'}</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="editLibrary('${libraryId}')" style="padding: 8px 16px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                            <button onclick="deleteLibrary('${libraryId}')" style="padding: 8px 16px; background: white; border: 1px solid #ef4444; color: #ef4444; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Stats bar -->
                    <div style="display: flex; gap: 24px; margin-bottom: 24px; padding: 16px; background: #f9f9f9; border-radius: 8px; flex-shrink: 0;">
                        <div>
                            <div style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Total Artifacts</div>
                            <div style="font-size: 24px; font-weight: 600; color: #333; margin-top: 4px;">${library.artifacts.length}</div>
                        </div>
                        <div>
                            <div style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Last Updated</div>
                            <div style="font-size: 14px; color: #333; margin-top: 8px;">${new Date(library.updatedAt || library.createdAt).toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <!-- Search and filter bar -->
                    <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-shrink: 0;">
                        <input type="text" placeholder="Search artifacts..." onkeyup="searchLibraryArtifacts(event, '${libraryId}')" style="flex: 1; padding: 10px 16px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 14px;">
                        <select onchange="sortLibraryArtifacts(event, '${libraryId}')" style="padding: 10px 16px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            <option value="name">Sort by Name</option>
                            <option value="date">Sort by Date</option>
                            <option value="type">Sort by Type</option>
                        </select>
                        <select onchange="filterLibraryArtifacts(event, '${libraryId}')" style="padding: 10px 16px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            <option value="all">All Types</option>
                            <option value="code">Code</option>
                            <option value="markdown">Documentation</option>
                            <option value="data">Data</option>
                            <option value="chart">Visualizations</option>
                        </select>
                    </div>
                    
                    <!-- Scrollable artifacts container -->
                    <div style="flex: 1; overflow-y: auto; min-height: 0; padding: 4px;">
                        <!-- Artifacts grid -->
                        <div id="libraryArtifactsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                        ${library.artifacts.length > 0 ? 
                            library.artifacts.map(artifactId => {
                                const artifact = librariesData.artifacts[artifactId];
                                if (!artifact) return '';
                                
                                const typeColors = {
                                    code: '#3b82f6',
                                    markdown: '#10b981',
                                    data: '#f59e0b',
                                    chart: '#8b5cf6',
                                    component: '#ec4899'
                                };
                                
                                const typeIcons = {
                                    code: 'fa-code',
                                    markdown: 'fa-file-alt',
                                    data: 'fa-database',
                                    chart: 'fa-chart-bar',
                                    component: 'fa-cube'
                                };
                                
                                const color = typeColors[artifact.type] || '#6b7280';
                                const icon = typeIcons[artifact.type] || 'fa-file';
                                
                                return `
                                    <div class="artifact-card" data-artifact-id="${artifactId}" style="background: white; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative;" 
                                         onclick="openArtifactFromLibrary('${artifactId}')"
                                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'"
                                         onmouseout="this.style.boxShadow=''; this.style.transform=''">
                                        
                                        <!-- Artifact menu button -->
                                        <button onclick="event.stopPropagation(); showArtifactMenu(event, '${artifactId}')" 
                                                style="position: absolute; top: 8px; right: 8px; width: 32px; height: 32px; background: white; border: 1px solid #e5e5e5; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 10;"
                                                onmouseover="this.parentElement.querySelector('.artifact-menu-btn').style.opacity='1'"
                                                class="artifact-menu-btn">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        
                                        <!-- Color bar -->
                                        <div style="height: 4px; background: ${color};"></div>
                                        
                                        <!-- Content -->
                                        <div style="padding: 16px;">
                                            <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px;">
                                                <div style="width: 36px; height: 36px; background: ${color}20; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                    <i class="fas ${icon}" style="color: ${color}; font-size: 16px;"></i>
                                                </div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 500; color: #333; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${artifact.name}</div>
                                                    <div style="color: ${color}; font-size: 12px; margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px;">${artifact.type}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Preview -->
                                            <div style="background: #f9f9f9; border-radius: 6px; padding: 12px; margin-bottom: 12px; height: 80px; overflow: hidden; position: relative;">
                                                <div style="font-family: 'Monaco', 'Courier New', monospace; font-size: 11px; color: #666; line-height: 1.4;">
                                                    ${artifact.preview || artifact.content || 'No preview available'}
                                                </div>
                                                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 20px; background: linear-gradient(transparent, #f9f9f9);"></div>
                                            </div>
                                            
                                            <!-- Footer -->
                                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999;">
                                                <span>${new Date(artifact.createdAt).toLocaleDateString()}</span>
                                                <div style="display: flex; gap: 12px;">
                                                    <button onclick="event.stopPropagation(); shareArtifact('${artifactId}')" style="background: transparent; border: none; color: #666; cursor: pointer; padding: 4px;">
                                                        <i class="fas fa-share"></i>
                                                    </button>
                                                    <button onclick="event.stopPropagation(); exportArtifact('${artifactId}')" style="background: transparent; border: none; color: #666; cursor: pointer; padding: 4px;">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')
                            : `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: #cbd5e1; margin-bottom: 16px;"></i>
                                <h3 style="color: #64748b; margin: 0 0 8px 0;">No artifacts yet</h3>
                                <p style="color: #94a3b8; margin: 0 0 20px 0;">Save artifacts from your chats to this library</p>
                            </div>
                        `}
                        </div>
                    </div>
                </div>
            `;
            
            // Show hover effect for artifact cards
            modalContent.querySelectorAll('.artifact-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.querySelector('.artifact-menu-btn').style.opacity = '1';
                });
                card.addEventListener('mouseleave', function() {
                    this.querySelector('.artifact-menu-btn').style.opacity = '0';
                });
            });
        }
        
        function backToLibrariesList() {
            renderLibrariesInModal();
            window.currentLibraryId = null;
        }
        
        function searchLibraryArtifacts(event, libraryId) {
            const searchTerm = event.target.value.toLowerCase();
            const cards = document.querySelectorAll('#libraryArtifactsGrid .artifact-card');
            
            cards.forEach(card => {
                const artifact = librariesData.artifacts[card.dataset.artifactId];
                if (artifact) {
                    const matches = artifact.name.toLowerCase().includes(searchTerm) ||
                                  (artifact.content && artifact.content.toLowerCase().includes(searchTerm)) ||
                                  artifact.type.toLowerCase().includes(searchTerm);
                    card.style.display = matches ? 'block' : 'none';
                }
            });
        }
        
        function sortLibraryArtifacts(event, libraryId) {
            const sortBy = event.target.value;
            const grid = document.getElementById('libraryArtifactsGrid');
            const cards = Array.from(grid.querySelectorAll('.artifact-card'));
            
            cards.sort((a, b) => {
                const artifactA = librariesData.artifacts[a.dataset.artifactId];
                const artifactB = librariesData.artifacts[b.dataset.artifactId];
                
                switch(sortBy) {
                    case 'name':
                        return artifactA.name.localeCompare(artifactB.name);
                    case 'date':
                        return new Date(artifactB.createdAt) - new Date(artifactA.createdAt);
                    case 'type':
                        return artifactA.type.localeCompare(artifactB.type);
                    default:
                        return 0;
                }
            });
            
            // Re-append sorted cards
            cards.forEach(card => grid.appendChild(card));
        }
        
        function filterLibraryArtifacts(event, libraryId) {
            const filterType = event.target.value;
            const cards = document.querySelectorAll('#libraryArtifactsGrid .artifact-card');
            
            cards.forEach(card => {
                const artifact = librariesData.artifacts[card.dataset.artifactId];
                if (artifact) {
                    const matches = filterType === 'all' || artifact.type === filterType;
                    card.style.display = matches ? 'block' : 'none';
                }
            });
        }
        
        function updateLibraryCount() {
            const countElement = document.querySelector('.library-total-count');
            if (countElement) {
                const totalArtifacts = librariesManager.libraries.reduce((sum, lib) => sum + lib.artifacts.length, 0);
                countElement.textContent = totalArtifacts;
            }
        }
        
        function searchLibraries(event) {
            const query = event.target.value.toLowerCase();
            const cards = document.querySelectorAll('.library-card');
            
            cards.forEach(card => {
                const name = card.querySelector('h4').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                
                if (name.includes(query) || description.includes(query)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function editLibrary(libraryId) {
            const library = librariesManager.libraries.find(lib => lib.id === libraryId);
            if (!library) return;
            
            openEditLibraryModal(library);
        }
        
        function deleteLibrary(libraryId) {
            const library = librariesManager.libraries.find(lib => lib.id === libraryId);
            showDeleteModal(
                'Delete Library',
                'This will permanently delete the library and all its artifacts. This action cannot be undone.',
                library ? library.name : 'this library',
                () => {
                    librariesManager.deleteLibrary(libraryId);
                    renderLibrariesInModal();
                    updateLibraryCount();
                }
            );
        }
        
        // Initialize demo libraries with sample content
        function initializeDemoLibraries() {
            if (librariesData.libraries.length === 0) {
                // Create demo libraries
                librariesManager.createLibrary({
                    name: 'API Documentation',
                    description: 'REST API guides and references',
                    icon: 'fa-book',
                    color: '#4A90E2',
                    artifacts: []
                });
                
                librariesManager.createLibrary({
                    name: 'React Components',
                    description: 'Reusable UI components',
                    icon: 'fa-code',
                    color: '#7ED321',
                    artifacts: []
                });
                
                librariesManager.createLibrary({
                    name: 'Analytics Reports',
                    description: 'Data visualizations and insights',
                    icon: 'fa-chart-bar',
                    color: '#BD10E0',
                    artifacts: []
                });
            }
        }
        
        // Update artifact NEW badges based on timestamps
        function updateArtifactBadges() {
            // Check all artifacts and update their NEW badges
            document.querySelectorAll('[id$="-new-badge"]').forEach(badge => {
                const artifactId = badge.id.replace('-new-badge', '');
                if (!artifactManager.isNew(artifactId)) {
                    badge.style.display = 'none';
                }
            });
        }
        
        // Dynamic Notification System
        class NotificationManager {
            constructor() {
                this.notifications = new Map(); // chatId -> count
                this.loadNotifications();
            }
            
            loadNotifications() {
                const stored = localStorage.getItem('chatNotifications');
                if (stored) {
                    const data = JSON.parse(stored);
                    this.notifications = new Map(Object.entries(data));
                }
            }
            
            saveNotifications() {
                const data = Object.fromEntries(this.notifications);
                localStorage.setItem('chatNotifications', JSON.stringify(data));
            }
            
            addNotification(chatId, count = 1) {
                const current = this.notifications.get(chatId) || 0;
                this.notifications.set(chatId, current + count);
                this.saveNotifications();
                this.updateUI(chatId);
            }
            
            clearNotifications(chatId) {
                this.notifications.delete(chatId);
                this.saveNotifications();
                this.updateUI(chatId);
            }
            
            updateUI(chatId) {
                const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (!chatItem) return;
                
                // Remove existing badge
                const existingBadge = chatItem.querySelector('.notification-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Add new badge if there are notifications
                const count = this.notifications.get(chatId);
                if (count && count > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = count > 99 ? '99+' : count;
                    chatItem.appendChild(badge);
                }
            }
            
            updateAllUI() {
                // Update all chat items
                document.querySelectorAll('[data-chat-id]').forEach(chatItem => {
                    const chatId = chatItem.dataset.chatId;
                    this.updateUI(chatId);
                });
            }
        }
        
        const notificationManager = new NotificationManager();
        
        // Handle Enter key in rename modal
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize global objects
            window.currentArtifacts = window.currentArtifacts || {};
            
            // Initialize ProcessManager DOM elements
            processManager.initializeDOMElements();
            
            // Initialize Libraries
            initializeDemoLibraries();
            // Don't call renderLibraries here as the modal container doesn't exist yet
            updateLibraryCount();
            
            // Update artifact badges
            updateArtifactBadges();
            
            // Initialize notifications UI
            notificationManager.updateAllUI();
            
            document.getElementById('renameInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    confirmRename();
                } else if (event.key === 'Escape') {
                    closeRenameModal();
                }
            });
        });

        // Create new chat
        function createNewDM(event) {
            event.stopPropagation();
            
            // For now, create a simple DM - in production would have user/agent selector
            const dmNumber = document.querySelectorAll('#dmsList .chat-item').length + 1;
            const finalName = `You & NewPerson${dmNumber}`;
            
            const dmsList = document.getElementById('dmsList');
            const newDM = document.createElement('div');
            const chatId = 'dm-' + Date.now().toString();
            newDM.className = 'chat-item';
            newDM.setAttribute('data-chat-id', chatId);
            newDM.setAttribute('data-chat-type', 'dm');
            newDM.onclick = function() { selectChat(this, chatId, 'dm'); };
            newDM.style.animation = 'slideIn 0.3s ease';
            
            newDM.innerHTML = `
                <i class="fas fa-at chat-icon"></i>
                <span class="chat-name">${finalName}</span>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="toggleChatMenu(event, '${chatId}')" title="Options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            `;
            
            dmsList.appendChild(newDM);
            
            // Auto-select the new DM
            selectChat(newDM, chatId, 'dm');
            
            showToast('New Direct Message created!', 'success');
        }
        
        function createNewChannel(event) {
            event.stopPropagation();
            
            // For now, create a simple channel - in production would have name input
            const channelNumber = document.querySelectorAll('#channelsList .chat-item').length + 1;
            const finalName = `new-channel-${channelNumber}`;
            
            const channelsList = document.getElementById('channelsList');
            const newChannel = document.createElement('div');
            const chatId = 'channel-' + Date.now().toString();
            newChannel.className = 'chat-item';
            newChannel.setAttribute('data-chat-id', chatId);
            newChannel.setAttribute('data-chat-type', 'channel');
            newChannel.onclick = function() { selectChat(this, chatId, 'channel'); };
            newChannel.style.animation = 'slideIn 0.3s ease';
            
            newChannel.innerHTML = `
                <i class="fas fa-hashtag chat-icon"></i>
                <span class="chat-name">${finalName}</span>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="toggleChatMenu(event, '${chatId}')" title="Options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            `;
            
            channelsList.appendChild(newChannel);
            
            // Auto-select the new channel
            selectChat(newChannel, chatId, 'channel');
            
            showToast('New Channel created!', 'success');
        }
        
        function createNewChat(event) {
            event.stopPropagation();
            
            // Auto-generate a name
            const chatNumber = document.querySelectorAll('.chat-item').length + 1;
            const finalName = `New Chat ${chatNumber}`;
            
            const allChats = document.getElementById('allChats');
            const newChat = document.createElement('div');
            const chatId = Date.now().toString();
            newChat.className = 'chat-item';
            newChat.setAttribute('data-chat-id', chatId);
            newChat.onclick = function() { selectChat(this, chatId); };
            // Add a subtle animation
            newChat.style.animation = 'slideIn 0.3s ease';
            
            newChat.innerHTML = `
                <i class="fas fa-comments chat-icon"></i>
                <span class="chat-name">${finalName}</span>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="toggleChatMenu(event, '${chatId}')" title="Options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            `;
            
            // Add as first chat in the list
            allChats.insertBefore(newChat, allChats.firstChild.nextSibling); // After the section header
            
            // Update the header to show the new chat
            document.getElementById('chatTitle').textContent = finalName;
            
            // Clear any existing artifacts counter
            const artifactIndicator = document.querySelector('.artifact-indicator span');
            if (artifactIndicator) {
                artifactIndicator.textContent = '0 artifacts';
            }
            
            // Select the new chat
            newChat.click();
            
            // Show helpful toast
            showToast('New chat created! Start typing below.', 'success');
            
            // Focus the message input
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.focus();
                    messageInput.placeholder = 'Type your message here...';
                }
            }, 200);
            
            // Add welcome message to the chat
            setTimeout(() => {
                const messagesContainer = document.getElementById('conversationHistory');
                if (messagesContainer) {
                    // Clear previous messages
                    messagesContainer.innerHTML = `
                        <!-- Today's Date -->
                        <div class="date-separator" data-date="today">
                            <span class="date-text">Today</span>
                        </div>
                        
                        <div class="message assistant-message" style="animation: fadeIn 0.5s ease;">
                            <div class="message-avatar" style="background-color: var(--agent-claude);">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-author">Claude</span>
                                    <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                                <div class="message-text">
                                     Hello! How can I help you today?
                                    
                                    <div style="background: #f0f9ff; border-left: 3px solid #0076B6; padding: 12px; margin-top: 16px; border-radius: 4px;">
                                        <strong>I can help you:</strong>
                                        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                            <li> Generate documentation and artifacts</li>
                                            <li> Write and review code</li>
                                            <li> Analyze data and create visualizations</li>
                                            <li> Research and answer questions</li>
                                        </ul>
                                    </div>
                                    
                                    <div style="color: #666; font-size: 12px; margin-top: 12px;">
                                         <strong>Tip:</strong> Any documentation, code, or analysis I create will appear as artifacts that you can click to view and share.
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }, 100);
        }

        // Global variables for modal state
        let selectedProjectColor = '#4A90E2';
        let currentChatForProject = null;
        let selectedProjectId = null;
        let currentProjectForEdit = null;
        let editProjectColor = '#4A90E2';
        
        // Create new project
        function createNewProject(event) {
            event.stopPropagation();
            // Show the modal instead of prompt
            document.getElementById('createProjectModal').classList.add('show');
            document.getElementById('newProjectName').focus();
            
            // Reset color selection
            selectedProjectColor = '#4A90E2';
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.style.borderColor = btn.dataset.color === '#4A90E2' ? 'var(--primary-color)' : 'transparent';
            });
        }
        
        function selectProjectColor(button) {
            // Clear all selections
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.style.borderColor = 'transparent';
            });
            // Select this color
            button.style.borderColor = 'var(--primary-color)';
            selectedProjectColor = button.dataset.color;
        }
        
        function closeCreateProjectModal() {
            document.getElementById('createProjectModal').classList.remove('show');
            document.getElementById('newProjectName').value = '';
        }
        
        function confirmCreateProject() {
            const projectName = document.getElementById('newProjectName').value.trim();
            if (projectName) {
                const projectsList = document.querySelector('.sidebar-section:nth-child(2) .chat-list');
                const projectId = 'project-' + Date.now();
                const newProject = document.createElement('div');
                newProject.className = 'chat-item';
                newProject.setAttribute('data-project-id', projectId);
                newProject.onclick = function(event) { handleProjectClick(event, projectId); };
                newProject.innerHTML = `
                    <i class="fas fa-folder chat-icon" style="color: ${selectedProjectColor};"></i>
                    <span class="chat-name">${projectName}</span>
                    <span class="project-badge">0 chats</span>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="toggleProjectMenu(event, '${projectId}')" title="Options">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                `;
                
                if (projectsList) {
                    projectsList.appendChild(newProject);
                }
                
                showToast(`Project "${projectName}" created`, 'success');
                closeCreateProjectModal();
            }
        }

        // Search chats
        function searchChats(event) {
            const searchTerm = event.target.value.toLowerCase();
            const allChats = document.querySelectorAll('.chat-item');
            
            allChats.forEach(chat => {
                const chatName = chat.querySelector('.chat-name').textContent.toLowerCase();
                if (chatName.includes(searchTerm)) {
                    chat.style.display = 'flex';
                } else {
                    chat.style.display = 'none';
                }
            });
        }

        // Clear messages
        function clearMessages() {
            messages = [];
            document.getElementById('conversationHistory').innerHTML = '';
        }

        // Add welcome message
        function addWelcomeMessage(chatName) {
            const welcomeMessage = {
                id: Date.now(),
                sender: 'Claude',
                agent: 'claude',
                text: `Welcome to "${chatName}"! I'm here to help. What would you like to work on?`,
                timestamp: new Date()
            };
            messages.push(welcomeMessage);
            renderMessage(welcomeMessage);
        }

        // Handle input keydown
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || isTyping) return;
            
            const currentConvId = currentChatId || 'current'; // Use current chat ID
            
            // Add user message
            const userMessage = {
                id: Date.now(),
                conversationId: currentConvId,
                sender: 'You',
                type: 'user',
                text: text,
                timestamp: new Date(),
                threadId: null
            };
            
            // Store in database
            db.addMessage(currentConvId, userMessage);
            messages.push(userMessage);
            
            // Update cache for current chat (before it might change)
            chatMessagesCache[currentConvId] = [...messages];
            
            renderMessage(userMessage);
            
            // Clear input
            input.value = '';
            
            // Route to appropriate agents
            const activeAgentIds = agentRouter.analyzeAndRoute(text);
            console.log('Active agents:', activeAgentIds);
            
            // Update UI to show active agents
            updateActiveAgents(activeAgentIds);
            
            // Process message with each active agent
            for (const agentId of activeAgentIds) {
                processAgentResponse(agentId, text, currentConvId);
            }
        }
        
        async function processAgentResponse(agentId, userMessage, conversationId) {
            const agent = agents[agentId];
            const intelligence = new AgentIntelligence(agentId);
            const taskId = Date.now();
            
            // Add process to manager for the specific conversation
            processManager.addProcess(agentId, taskId, 'acknowledging', 'Analyzing request...', conversationId);
            
            // Analyze the message
            const conversationHistory = db.getMessages(conversationId);
            const analysis = intelligence.analyzeMessage(userMessage, conversationHistory);
            
            // Update to working status
            setTimeout(() => {
                const workingMessages = [
                    'Processing data...',
                    'Analyzing context...',
                    'Generating insights...',
                    'Preparing response...'
                ];
                const message = workingMessages[Math.floor(Math.random() * workingMessages.length)];
                processManager.updateProcess(agentId, taskId, 'working', message, conversationId);
            }, 1000);
            
            // Generate response
            const response = await intelligence.generateResponse(userMessage, analysis, conversationHistory);
            
            // Complete and show response
            setTimeout(async () => {
                processManager.updateProcess(agentId, taskId, 'completed', 'Done', conversationId);
                
                const agentMessage = {
                    id: Date.now() + Math.random(),
                    conversationId: conversationId,
                    sender: agent.name,
                    agent: agentId,
                    type: 'agent',
                    timestamp: new Date(),
                    text: response,
                    timestamp: new Date(),
                    analysis: analysis,
                    confidence: analysis.confidence
                };
                
                // Store in database
                db.addMessage(conversationId, agentMessage);
                
                // Check if this response is for a different chat than the current one
                if (conversationId !== currentChatId) {
                    // Update the cache for the chat that actually received the response
                    if (!chatMessagesCache[conversationId]) {
                        chatMessagesCache[conversationId] = [];
                    }
                    // Ensure timestamp is stored properly for caching
                    const messageForCache = {
                        ...agentMessage,
                        timestamp: agentMessage.timestamp instanceof Date ? 
                                  agentMessage.timestamp.toISOString() : 
                                  agentMessage.timestamp
                    };
                    chatMessagesCache[conversationId].push(messageForCache);
                    
                    // Add notification for the chat that received the response
                    notificationManager.addNotification(conversationId, 1);
                    
                    // Get chat name for notification
                    const chatItem = document.querySelector(`[data-chat-id="${conversationId}"]`);
                    const chatName = chatItem ? chatItem.querySelector('.chat-name').textContent : conversationId;
                    
                    // Show a toast notification
                    showToast(`${agent.name} responded in "${chatName}"`, 'info', 'New Message');
                } else {
                    // This is the current chat, update messages array and cache
                    messages.push(agentMessage);
                    // Store messages with serialized timestamps in cache
                    chatMessagesCache[currentChatId] = messages.map(msg => ({
                        ...msg,
                        timestamp: msg.timestamp instanceof Date ? 
                                  msg.timestamp.toISOString() : 
                                  msg.timestamp
                    }));
                    
                    // Render the message if it's for the current chat
                    renderMessage(agentMessage);
                }
                
                // Create artifact if needed
                if (analysis.requiresArtifact) {
                    await createArtifactFromAnalysis(agentMessage, analysis);
                }
                
                // Update agent memory
                const memory = db.getAgentMemory(agentId, conversationId);
                memory.context.push({ message: userMessage, response: response });
                db.updateAgentMemory(agentId, conversationId, memory.context);
                
            }, 3000 + Math.random() * 2000);
        }
        
        async function createArtifactFromAnalysis(agentMessage, analysis) {
            // Determine artifact type based on message content
            let artifactType = 'report';
            let artifactIcon = '';
            let artifactTitle = 'Data Analysis Report';
            
            if (agentMessage.text.toLowerCase().includes('chart') || agentMessage.text.toLowerCase().includes('graph')) {
                artifactType = 'chart';
                artifactIcon = '';
                artifactTitle = 'Data Visualization';
            } else if (agentMessage.text.toLowerCase().includes('dashboard')) {
                artifactType = 'dashboard';
                artifactIcon = '';
                artifactTitle = 'Analytics Dashboard';
            }
            
            const artifact = {
                id: `artifact-${Date.now()}`,
                title: artifactTitle,
                type: artifactType.toUpperCase(),
                content: agentMessage.text,
                metadata: {
                    agent: agentMessage.sender,
                    confidence: analysis.confidence,
                    intent: analysis.intent
                }
            };
            
            const created = db.createArtifact(artifact);
            
            // Create inline artifact display matching the landing page mock
            const messageElement = document.getElementById(`msg-${agentMessage.id}`);
            if (messageElement) {
                const artifactInline = document.createElement('div');
                artifactInline.className = 'artifact-inline';
                artifactInline.dataset.artifactId = created.id;
                artifactInline.onclick = function() { openArtifact(created.id, created.title, created.type); };
                
                // Generate preview content based on type
                let previewContent = 'Loading analysis results...';
                if (artifactType === 'chart') {
                    previewContent = 'Daily Active Users: 12.5K | Monthly Growth: +23% | Retention Rate: 87%...';
                } else if (artifactType === 'dashboard') {
                    previewContent = 'Total Revenue: $125K | Conversion Rate: 3.2% | Average Order Value: $89...';
                } else {
                    previewContent = 'Executive Summary: Performance metrics show positive trends across all key indicators...';
                }
                
                artifactInline.innerHTML = `
                    <div class="artifact-header">
                        <span class="artifact-title">
                            <span class="artifact-icon">${artifactIcon}</span>
                            ${created.title}
                        </span>
                        <span class="artifact-version" title="Version ${created.version}">v${created.version}</span>
                        <span class="artifact-type ${artifactType}">${artifactType}</span>
                    </div>
                    <div class="artifact-preview">${previewContent}</div>
                    <div class="artifact-actions" onclick="event.stopPropagation()">
                        <button class="artifact-action" onclick="saveArtifactToLibrary('${created.id}', '${created.title}', '${artifactType}')">
                            <i class="fas fa-folder-plus"></i> Save
                        </button>
                        <button class="artifact-action" onclick="forkArtifact('${created.id}')">
                            <i class="fas fa-code-branch"></i> Fork
                        </button>
                        <button class="artifact-action" onclick="viewVersionHistory('${created.id}')">
                            <i class="fas fa-history"></i> History
                        </button>
                        <button class="artifact-action" onclick="shareArtifact('${created.id}')">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                `;
                messageElement.querySelector('.message-content').appendChild(artifactInline);
                
                // Also save to chat artifacts cache immediately
                if (!chatArtifactsCache[currentChatId]) {
                    chatArtifactsCache[currentChatId] = [];
                }
                chatArtifactsCache[currentChatId].push({
                    id: created.id,
                    title: created.title,
                    type: artifactType,
                    content: previewContent,
                    html: artifactInline.outerHTML,
                    className: 'artifact-inline'
                });
                console.log(`Added artifact to cache for chat ${currentChatId}`);
            }
        }
        
        function updateActiveAgents(agentIds) {
            activeAgents = agentIds;
            const container = document.querySelector('.active-agents');
            if (container) {
                const agentIndicators = agentIds.map(id => {
                    const agent = agents[id];
                    return `
                        <div class="agent-indicator active" style="background-color: ${agent.color};">
                            ${agent.avatar}
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <span class="active-agents-label">Active Agents:</span>
                    ${agentIndicators}
                `;
            }
        }

        // Determine active agents based on message content
        function determineActiveAgents(text) {
            const textLower = text.toLowerCase();
            const newActiveAgents = ['claude']; // Claude is always active
            
            if (textLower.includes('design') || textLower.includes('ui') || textLower.includes('ux')) {
                newActiveAgents.push('designer');
            }
            if (textLower.includes('code') || textLower.includes('implement') || textLower.includes('function')) {
                newActiveAgents.push('coder');
            }
            if (textLower.includes('research') || textLower.includes('study') || textLower.includes('investigate')) {
                newActiveAgents.push('research');
            }
            if (textLower.includes('data') || textLower.includes('analysis') || textLower.includes('metrics')) {
                newActiveAgents.push('analyst');
            }
            
            // Update active agents display
            updateActiveAgentsDisplay(newActiveAgents);
            activeAgents = newActiveAgents;
        }

        // Update active agents display
        function updateActiveAgentsDisplay(agentKeys) {
            const container = document.querySelector('.active-agents');
            const indicators = agentKeys.map(key => {
                const agent = agents[key];
                return `<div class="agent-indicator active" style="background-color: ${agent.color};" title="${agent.name}">${agent.avatar}</div>`;
            });
            
            container.innerHTML = `
                <span class="active-agents-label">Active:</span>
                ${indicators.join('')}
            `;
        }

        // Generate agent response
        function generateAgentResponse(userText) {
            const textLower = userText.toLowerCase();
            
            // Select responding agent from active agents
            const respondingAgentKey = activeAgents[Math.floor(Math.random() * activeAgents.length)];
            const respondingAgent = agents[respondingAgentKey];
            
            const responses = {
                claude: "I understand what you're looking for. Let me help you with that...",
                research: "Based on my research, here are the key findings...",
                designer: "From a design perspective, I recommend the following approach...",
                coder: "Here's how we can implement this solution...",
                analyst: "After analyzing the data, here are the insights..."
            };
            
            const response = {
                id: Date.now(),
                sender: respondingAgent.name,
                agent: respondingAgentKey,
                text: responses[respondingAgentKey],
                timestamp: new Date()
            };
            
            // ALWAYS show artifact if user mentions "artifact"
            if (textLower.includes('artifact')) {
                // Showcase different artifact types based on context
                if (textLower.includes('code') || textLower.includes('function') || textLower.includes('api')) {
                    response.artifact = {
                        type: 'CODE',
                        title: 'API Implementation',
                        content: `// REST API endpoint implementation\napp.post('/api/users', async (req, res) => {\n  try {\n    const { name, email } = req.body;\n    \n    // Validate input\n    if (!name || !email) {\n      return res.status(400).json({\n        error: 'Name and email are required'\n      });\n    }\n    \n    // Create user in database\n    const user = await User.create({\n      name,\n      email,\n      createdAt: new Date()\n    });\n    \n    // Return success response\n    res.status(201).json({\n      success: true,\n      data: user\n    });\n  } catch (error) {\n    res.status(500).json({\n      error: 'Internal server error'\n    });\n  }\n});`
                    };
                } else if (textLower.includes('data') || textLower.includes('chart') || textLower.includes('metrics')) {
                    response.artifact = {
                        type: 'DATA',
                        title: 'Performance Metrics Dashboard',
                        content: ` Q4 2024 Performance Metrics\n\n**Key Metrics:**\n User Growth: +45% MoM\n Revenue: $2.4M (+32%)\n Engagement Rate: 68%\n Churn Rate: 3.2% (-1.5%)\n\n**User Segments:**\n1. Enterprise: 35% of total users\n2. Pro Users: 45% of total users\n3. Free Tier: 20% of total users\n\n**Top Features by Usage:**\n- Dashboard Analytics: 89% daily active\n- Collaboration Tools: 76% daily active\n- Export Functions: 54% weekly active\n\n[Interactive Chart Placeholder]\n Trend shows consistent upward trajectory`
                    };
                } else if (textLower.includes('design') || textLower.includes('ui') || textLower.includes('mockup')) {
                    response.artifact = {
                        type: 'DESIGN',
                        title: 'UI Component Specifications',
                        content: ` Button Component Design System\n\n**Primary Button:**\n- Background: #0076B6\n- Text: #FFFFFF\n- Padding: 12px 24px\n- Border-radius: 6px\n- Font-size: 14px\n- Font-weight: 600\n- Hover: darken(10%)\n- Active: darken(15%)\n\n**Secondary Button:**\n- Background: transparent\n- Border: 1px solid #D9D9D9\n- Text: #333333\n- Hover: background #F4F4F4\n\n**States:**\n Default\n Hover\n Active\n Disabled\n Loading\n\n**Accessibility:**\n- WCAG AA compliant\n- Focus ring: 2px offset\n- Min touch target: 44x44px`
                    };
                } else {
                    // Default markdown artifact
                    response.artifact = {
                        type: 'MARKDOWN',
                        title: 'Project Documentation',
                        content: `# Project Overview\n\n## Executive Summary\nThis artifact demonstrates the rich content display capabilities of our system. Artifacts can contain various types of structured content that can be versioned, shared, and edited collaboratively.\n\n## Key Features\n- **Version Control**: Track changes over time\n- **Collaboration**: Multiple users can edit\n- **Export Options**: PDF, HTML, Markdown\n- **Rich Formatting**: Support for various content types\n\n## Implementation Details\n\n### Phase 1: Foundation\n- Set up core infrastructure\n- Implement basic CRUD operations\n- Design database schema\n\n### Phase 2: Enhancement\n- Add real-time collaboration\n- Implement version history\n- Create export functionality\n\n### Phase 3: Polish\n- Optimize performance\n- Add advanced features\n- Improve user experience\n\n## Next Steps\n1. Review requirements\n2. Get stakeholder approval\n3. Begin implementation\n4. Deploy to staging\n5. User acceptance testing\n\n---\n*Last updated: ${new Date().toLocaleDateString()}*`
                    };
                }
                
                response.text = `I've created an artifact with the ${response.artifact.type.toLowerCase()} content you requested. You can preview it below, view the source code, or check the version history using the tabs.`;
            } else if (Math.random() > 0.7) {
                // Sometimes add an artifact randomly
                response.artifact = {
                    type: 'MARKDOWN',
                    title: 'Analysis Results',
                    content: `## Key Findings\n\nBased on our analysis, here are the main insights:\n\n1. **Performance**: System is operating at optimal levels\n2. **User Satisfaction**: 92% positive feedback\n3. **Areas for Improvement**: Mobile experience needs enhancement\n\n### Recommendations\n- Implement caching strategy\n- Optimize database queries\n- Enhance mobile responsive design`
                };
            }
            
            return response;
        }

        // Agent Lifecycle Management (Updated to use ProcessManager)
        function triggerAgentLifecycle(agentName, userRequest) {
            const agentId = agentName.toLowerCase();
            const taskId = Date.now();
            
            // Use ProcessManager for status
            processManager.addProcess(agentId, taskId, 'acknowledging', 'Starting analysis...');
            
            // Phase 2: Working (after 1 second)
            setTimeout(() => {
                processManager.updateProcess(agentId, taskId, 'working', 'Processing request...');
            }, 1000);
            
            // Phase 3: Completed (after 5 seconds)
            setTimeout(() => {
                processManager.updateProcess(agentId, taskId, 'completed', 'Complete');
                
                // Add agent's response message
                const agentMessage = {
                    id: Date.now(),
                    sender: agentName,
                    agent: agentId,
                    type: 'agent',
                    text: `Analysis complete! I've processed your request for "${userRequest}". The results are ready for review.`,
                    timestamp: new Date()
                };
                messages.push(agentMessage);
                renderMessage(agentMessage);
            }, 5000);
        }
        
        // Legacy functions kept for compatibility with triggerAgentLifecycle if needed
        // These are now replaced by the ProcessManager

        // Render message
        function renderMessage(message) {
            // Use conversationHistory as the container for messages (it's the scrollable area)
            const container = document.getElementById('conversationHistory');
            const agent = agents[message.agent];
            const messageId = `msg-${message.id || Date.now()}`;
            const isAI = message.type === 'agent' || message.agent;
            const messageClass = isAI ? 'ai-message' : 'human-message';
            const avatarClass = isAI ? 'ai-avatar' : 'human-avatar';
            
            const isUserMessage = message.type === 'user';
            
            const messageHtml = `
                <div class="message ${messageClass}" id="${messageId}">
                    <div class="message-avatar ${avatarClass} ${isUserMessage ? 'user-avatar' : 'agent-message-avatar'}" 
                         ${!isUserMessage ? `style="background-color: ${agent.color};"` : ''}>
                        ${isUserMessage ? 'U' : agent.avatar}
                        ${isAI ? '<span class="ai-indicator">AI</span>' : ''}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${message.sender}</span>
                            ${!isUserMessage ? `<span class="agent-badge">${agent.role}</span>` : ''}
                            <span class="message-time">${formatTime(message.timestamp)}</span>
                        </div>
                        <div class="message-text" id="message-text-${messageId}">${message.text}</div>
                        ${isUserMessage ? `
                            <div class="message-edit-mode" id="message-edit-${messageId}">
                                <textarea class="message-edit-input" id="message-edit-input-${messageId}">${message.text}</textarea>
                                <div class="message-edit-actions">
                                    <button class="message-edit-btn message-edit-cancel" onclick="cancelEditMessage('${messageId}')">Cancel</button>
                                    <button class="message-edit-btn message-edit-save" onclick="saveEditMessage('${messageId}')">Save</button>
                                </div>
                            </div>
                        ` : ''}
                        ${message.artifact ? renderArtifact(message.artifact) : ''}
                        <div id="thread-preview-${messageId}"></div>
                        ${!isUserMessage ? `
                            <div class="agent-feedback">
                                <button class="feedback-btn" onclick="likeMessage('${messageId}')" title="Good response">
                                    <i class="far fa-thumbs-up"></i>
                                </button>
                                <button class="feedback-btn" onclick="dislikeMessage('${messageId}')" title="Poor response">
                                    <i class="far fa-thumbs-down"></i>
                                </button>
                            </div>
                        ` : ''}
                        <div class="message-actions">
                            <button class="message-action" onclick="copyMessage('${messageId}')" title="Copy message">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="message-action" onclick="toggleMessageMenu(event, '${messageId}')" title="More actions">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <div class="message-menu-dropdown" id="message-menu-${messageId}">
                                ${isUserMessage ? `
                                    <button class="message-menu-item" onclick="editMessage('${messageId}')">
                                        <i class="fas fa-edit"></i>
                                        <span>Edit message</span>
                                    </button>
                                ` : ''}
                                <button class="message-menu-item" onclick="copyMessage('${messageId}')">
                                    <i class="fas fa-copy"></i>
                                    <span>Copy text</span>
                                </button>
                                <button class="message-menu-item" onclick="pinMessage('${messageId}')">
                                    <i class="fas fa-thumbtack"></i>
                                    <span>Pin message</span>
                                </button>
                                <button class="message-menu-item" onclick="startThread('${messageId}')">
                                    <i class="fas fa-reply"></i>
                                    <span>Reply in thread</span>
                                </button>
                                <button class="message-menu-item" onclick="createReminder('${messageId}')">
                                    <i class="fas fa-bell"></i>
                                    <span>Set reminder</span>
                                </button>
                                <button class="message-menu-item" onclick="forkFromMessage('${messageId}')">
                                    <i class="fas fa-code-branch"></i>
                                    <span>Fork from here</span>
                                </button>
                                ${!isUserMessage ? `
                                    <button class="message-menu-item" onclick="regenerateMessage('${messageId}')">
                                        <i class="fas fa-redo"></i>
                                        <span>Regenerate</span>
                                    </button>
                                ` : ''}
                                ${isUserMessage ? `
                                    <div class="message-menu-divider"></div>
                                    <button class="message-menu-item" onclick="deleteMessage('${messageId}')">
                                        <i class="fas fa-trash"></i>
                                        <span>Delete message</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += messageHtml;
            container.scrollTop = container.scrollHeight;
        }

        // V5: Render artifact reference in message with sharing status
        function renderArtifact(artifact) {
            // Store artifact data
            const artifactId = `artifact-${Date.now()}`;
            window.currentArtifacts = window.currentArtifacts || {};
            
            // Add sharing metadata
            artifact.shared = artifact.shared || false;
            artifact.sharedWith = artifact.sharedWith || [];
            artifact.shareLink = `https://agentchat.com/artifact/${artifactId.split('-')[1]}`;
            
            window.currentArtifacts[artifactId] = artifact;
            
            // Return inline reference that opens side panel
            const sharedIndicator = artifact.shared ? `
                <span class="shared-indicator">
                    <i class="fas fa-users"></i>
                    Shared
                </span>
            ` : '';
            
            const collaborators = artifact.sharedWith.length > 0 ? `
                <div class="artifact-collaborators">
                    ${artifact.sharedWith.slice(0, 3).map(user => 
                        `<div class="artifact-collaborator" style="background: ${user.color};" title="${user.name}">${user.initials}</div>`
                    ).join('')}
                    ${artifact.sharedWith.length > 3 ? 
                        `<div class="artifact-collaborator artifact-collaborator-count">+${artifact.sharedWith.length - 3}</div>` : ''
                    }
                </div>
            ` : '';
            
            return `
                <div class="artifact-reference" onclick="openArtifactPanel('${artifactId}')">
                    <i class="fas fa-file-alt artifact-reference-icon"></i>
                    <span class="artifact-reference-name">${artifact.title}</span>
                    <span class="artifact-reference-type">${artifact.type}</span>
                    ${sharedIndicator}
                    ${collaborators}
                </div>
            `;
        }
        
        // V4: Open artifact in side panel
        // Open artifact with proper content
        function openArtifact(artifactId, title, type) {
            // If only one parameter is passed, it's from a library
            if (arguments.length === 1) {
                openArtifactFromLibrary(artifactId);
                return;
            }
            
            // Store artifact data for the panel
            window.currentArtifacts = window.currentArtifacts || {};
            
            // Generate content based on artifact ID or type
            let content = generateChatArtifactContent(artifactId, title, type);
            
            const artifactData = {
                id: artifactId,
                title: title,
                type: type.toUpperCase(),
                content: content,
                fromChat: true
            };
            
            window.currentArtifacts[artifactId] = artifactData;
            
            // Open the artifact panel
            openArtifactPanel(artifactId);
        }
        
        function generateChatArtifactContent(artifactId, title, type) {
            
            // Set content based on artifact ID
            let content = '';
            if (artifactId === 'artifact-1') {
                // API Documentation
                content = `
# Authentication API Reference

## Overview
This document provides comprehensive documentation for our authentication API endpoints.

## Endpoints

### POST /auth/login
Authenticates a user and returns access and refresh tokens.

**Request Body:**
\`\`\`json
{
  "email": "user@example.com",
  "password": "securepassword"
}
\`\`\`

**Response:**
\`\`\`json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "expiresIn": 3600
}
\`\`\`

### POST /auth/refresh
Refreshes an expired access token using a valid refresh token.

### POST /auth/logout
Invalidates the current refresh token.

## Error Handling
All endpoints return appropriate HTTP status codes and error messages.
                `;
            } else if (artifactId === 'artifact-2') {
                // Analytics Chart
                content = `
<div style="padding: 20px;">
    <h3>User Engagement Metrics - Last 30 Days</h3>
    <div style="background: #f5f5f5; border-radius: 8px; padding: 20px; margin: 20px 0;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: #0076B6;">12.5K</div>
                <div style="color: #666; margin-top: 8px;">Daily Active Users</div>
                <div style="color: #4CAF50; font-size: 14px; margin-top: 4px;"> 23% from last month</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: #0076B6;">87%</div>
                <div style="color: #666; margin-top: 8px;">Retention Rate</div>
                <div style="color: #4CAF50; font-size: 14px; margin-top: 4px;"> 5% from last month</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: bold; color: #0076B6;">3.2min</div>
                <div style="color: #666; margin-top: 8px;">Avg. Session Duration</div>
                <div style="color: #FF9800; font-size: 14px; margin-top: 4px;"> No change</div>
            </div>
        </div>
    </div>
    <div style="margin-top: 20px;">
        <canvas id="chartCanvas" width="400" height="200"></canvas>
    </div>
</div>
                `;
            } else if (artifactId === 'artifact-3') {
                // React Component
                content = `
\`\`\`jsx
import React, { useState } from 'react';
import './LoginForm.css';

const LoginForm = () => {
  const [formData, setFormData] = useState({
    email: '',
    password: ''
  });
  const [errors, setErrors] = useState({});
  const [isLoading, setIsLoading] = useState(false);

  const validateForm = () => {
    const newErrors = {};
    
    if (!formData.email) {
      newErrors.email = 'Email is required';
    } else if (!/\\S+@\\S+\\.\\S+/.test(formData.email)) {
      newErrors.email = 'Email is invalid';
    }
    
    if (!formData.password) {
      newErrors.password = 'Password is required';
    } else if (formData.password.length < 8) {
      newErrors.password = 'Password must be at least 8 characters';
    }
    
    return newErrors;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const validationErrors = validateForm();
    
    if (Object.keys(validationErrors).length > 0) {
      setErrors(validationErrors);
      return;
    }
    
    setIsLoading(true);
    try {
      const response = await fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        const data = await response.json();
        // Handle successful login
        console.log('Login successful', data);
      }
    } catch (error) {
      setErrors({ general: 'Login failed. Please try again.' });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form className="login-form" onSubmit={handleSubmit}>
      <h2>Sign In</h2>
      
      <div className="form-group">
        <input
          type="email"
          placeholder="Email"
          value={formData.email}
          onChange={(e) => setFormData({...formData, email: e.target.value})}
          className={errors.email ? 'error' : ''}
        />
        {errors.email && <span className="error-msg">{errors.email}</span>}
      </div>
      
      <div className="form-group">
        <input
          type="password"
          placeholder="Password"
          value={formData.password}
          onChange={(e) => setFormData({...formData, password: e.target.value})}
          className={errors.password ? 'error' : ''}
        />
        {errors.password && <span className="error-msg">{errors.password}</span>}
      </div>
      
      <button type="submit" disabled={isLoading}>
        {isLoading ? 'Signing in...' : 'Sign In'}
      </button>
    </form>
  );
};

export default LoginForm;
\`\`\`
                `;
            }
            
            return content;
        }
        
        function openArtifactPanel(artifactId) {
            const artifact = window.currentArtifacts[artifactId];
            if (!artifact) return;
            
            const panel = document.getElementById('artifactPanel');
            const mainContent = document.querySelector('.main-content');
            
            // Update panel content
            document.getElementById('artifactPanelTitle').textContent = artifact.title;
            
            // Add "Back to Library" button if artifact is from a library
            const panelActions = document.querySelector('.artifact-panel-actions');
            const existingBackBtn = panelActions.querySelector('.back-to-library-btn');
            if (existingBackBtn) {
                existingBackBtn.remove();
            }
            
            if (artifact.fromLibrary) {
                const backButton = document.createElement('button');
                backButton.className = 'artifact-panel-action back-to-library-btn';
                backButton.innerHTML = '<i class="fas fa-folder-open"></i>';
                backButton.title = 'Back to Libraries';
                backButton.onclick = function() {
                    closeArtifactPanel();
                    openLibrariesModal();
                    if (artifact.libraryId) {
                        // Optionally navigate to the specific library
                        setTimeout(() => viewLibraryDetails(artifact.libraryId), 100);
                    }
                };
                panelActions.insertBefore(backButton, panelActions.firstChild);
            }
            
            // Set content based on type
            const contentDiv = document.getElementById('artifactPanelContent');
            
            if (artifact.type === 'CODE') {
                contentDiv.className = 'artifact-panel-content';
                contentDiv.innerHTML = `<pre><code class="language-javascript">${escapeHtml(artifact.content)}</code></pre>`;
                // Apply syntax highlighting if Prism is available
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAll();
                }
            } else if (artifact.type === 'MARKDOWN' || artifact.type === 'DATA' || artifact.type === 'DESIGN') {
                contentDiv.className = 'artifact-panel-content markdown-content';
                // Use marked if available, otherwise show raw
                if (typeof marked !== 'undefined') {
                    contentDiv.innerHTML = marked.parse(artifact.content);
                } else {
                    contentDiv.innerHTML = `<pre>${escapeHtml(artifact.content)}</pre>`;
                }
            } else {
                contentDiv.className = 'artifact-panel-content';
                contentDiv.innerHTML = `<pre>${escapeHtml(artifact.content)}</pre>`;
            }
            
            // Open panel with animation
            panel.classList.add('open');
            mainContent.classList.add('artifact-panel-open');
            
            // Store current artifact for other operations
            window.currentArtifact = artifact;
            
            // Reset tabs to preview
            document.querySelectorAll('.artifact-panel-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.artifact-panel-tab').classList.add('active');
            
            showToast('Artifact opened in side panel', 'info');
        }
        
        // V4: Close artifact panel
        function closeArtifactPanel() {
            const panel = document.getElementById('artifactPanel');
            const mainContent = document.querySelector('.main-content');
            
            panel.classList.remove('open');
            mainContent.classList.remove('artifact-panel-open');
        }
        
        // Share artifact function
        function forkArtifact(artifactId) {
            event.stopPropagation();
            
            // Show a modal to select target chat/channel
            const artifact = artifactManager.getArtifact(artifactId);
            if (!artifact) {
                showToast('Artifact not found', 'error');
                return;
            }
            
            // For now, fork to current chat
            const forked = artifactManager.forkArtifact(artifactId, currentChatId);
            if (forked) {
                showToast(`Forked "${artifact.title}" to current conversation`, 'success');
                
                // Add the forked artifact to the conversation
                const messageElement = document.createElement('div');
                messageElement.className = 'message system-message';
                messageElement.innerHTML = `
                    <div class="message-content">
                        <i class="fas fa-code-branch"></i> Forked artifact "${forked.title}" from "${artifact.title}"
                    </div>
                `;
                document.querySelector('.conversation-history').appendChild(messageElement);
                
                // Add the forked artifact display
                const artifactInline = document.createElement('div');
                artifactInline.className = 'artifact-inline';
                artifactInline.dataset.artifactId = forked.id;
                artifactInline.onclick = function() { openArtifact(forked.id, forked.title, forked.type); };
                
                artifactInline.innerHTML = `
                    <div class="artifact-header">
                        <span class="artifact-title">
                            <span class="artifact-icon"></span>
                            ${forked.title}
                        </span>
                        <span class="artifact-version" title="Version ${forked.version}">v${forked.version}</span>
                        <span class="artifact-type">${forked.type}</span>
                        <span class="fork-indicator" title="Forked from ${artifact.title}">
                            <i class="fas fa-code-branch"></i> Fork
                        </span>
                    </div>
                    <div class="artifact-preview">${forked.content.substring(0, 200)}...</div>
                    <div class="artifact-actions" onclick="event.stopPropagation()">
                        <button class="artifact-action" onclick="forkArtifact('${forked.id}')">
                            <i class="fas fa-code-branch"></i> Fork Again
                        </button>
                        <button class="artifact-action" onclick="viewVersionHistory('${forked.id}')">
                            <i class="fas fa-history"></i> History
                        </button>
                    </div>
                `;
                
                document.querySelector('.conversation-history').appendChild(artifactInline);
            }
        }
        
        function viewVersionHistory(artifactId) {
            event.stopPropagation();
            
            const artifact = artifactManager.getArtifact(artifactId);
            if (!artifact || !artifact.versions) {
                showToast('No version history available', 'info');
                return;
            }
            
            // Create a modal to show version history
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal" style="width: 600px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Version History: ${artifact.title}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${artifact.versions.map((v, idx) => `
                            <div class="version-item" style="padding: 12px; border-bottom: 1px solid var(--border-color); ${idx === artifact.versions.length - 1 ? 'background: var(--accent); background-opacity: 0.1;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>Version ${v.version}</strong>
                                        ${idx === artifact.versions.length - 1 ? '<span class="badge" style="margin-left: 8px; background: var(--success); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Current</span>' : ''}
                                    </div>
                                    <small>${new Date(v.timestamp).toLocaleString()}</small>
                                </div>
                                <div style="margin-top: 4px; color: var(--text-secondary); font-size: 13px;">
                                    By ${v.author}  ${v.message}
                                </div>
                                ${idx < artifact.versions.length - 1 ? `
                                    <button class="btn-secondary" style="margin-top: 8px; font-size: 12px;" onclick="rollbackToVersion('${artifactId}', ${v.version})">
                                        <i class="fas fa-undo"></i> Rollback to this version
                                    </button>
                                ` : ''}
                            </div>
                        `).reverse().join('')}
                    </div>
                    ${artifact.forkParent ? `
                        <div class="modal-footer" style="border-top: 1px solid var(--border-color); padding: 12px;">
                            <i class="fas fa-code-branch"></i> Forked from: <strong>${artifactManager.getArtifact(artifact.forkParent)?.title || 'Unknown'}</strong>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function rollbackToVersion(artifactId, versionNumber) {
            const artifact = artifactManager.getArtifact(artifactId);
            if (!artifact) return;
            
            const targetVersion = artifact.versions.find(v => v.version === versionNumber);
            if (!targetVersion) return;
            
            // Create new version with old content
            artifactManager.updateArtifact(
                artifactId, 
                targetVersion.content, 
                'User', 
                `Rolled back to version ${versionNumber}`
            );
            
            showToast(`Rolled back to version ${versionNumber}`, 'success');
            
            // Close modal and refresh artifact display
            document.querySelector('.modal-overlay').remove();
            
            // Update any displayed artifacts
            const artifactElements = document.querySelectorAll(`[data-artifact-id="${artifactId}"]`);
            artifactElements.forEach(el => {
                const versionEl = el.querySelector('.artifact-version');
                if (versionEl) {
                    versionEl.textContent = `v${artifact.version}`;
                    versionEl.title = `Version ${artifact.version}`;
                }
            });
        }
        
        function shareArtifact(artifactId) {
            event.stopPropagation();
            
            // Set up current artifact for sharing
            window.currentArtifact = window.currentArtifact || {};
            window.currentArtifact.id = artifactId;
            window.currentArtifact.shareLink = `https://agentchat.com/artifact/${artifactId}`;
            
            // Get artifact title based on ID
            let title = 'Artifact';
            if (artifactId === 'artifact-1') {
                title = 'API Authentication Documentation';
            } else if (artifactId === 'artifact-2') {
                title = 'User Engagement Analytics';
            } else if (artifactId === 'artifact-3') {
                title = 'React Login Component';
            }
            window.currentArtifact.title = title;
            
            // Open the share modal
            openShareModal();
        }
        
        // Export artifact function
        function exportArtifact(artifactId) {
            event.stopPropagation();
            showToast('Downloading artifact...', 'info');
            
            // Simulate download
            setTimeout(() => {
                showToast('Artifact downloaded successfully', 'success');
            }, 1000);
        }
        
        // V4: Switch panel tabs
        function switchPanelTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.artifact-panel-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase() === tabName) {
                    tab.classList.add('active');
                }
            });
            
            // Update content
            const contentDiv = document.getElementById('artifactPanelContent');
            const artifact = window.currentArtifact;
            
            if (!artifact) return;
            
            if (tabName === 'preview') {
                if (artifact.type === 'CODE') {
                    contentDiv.className = 'artifact-panel-content';
                    contentDiv.innerHTML = `<pre><code class="language-javascript">${escapeHtml(artifact.content)}</code></pre>`;
                    if (typeof Prism !== 'undefined') Prism.highlightAll();
                } else {
                    contentDiv.className = 'artifact-panel-content markdown-content';
                    if (typeof marked !== 'undefined') {
                        contentDiv.innerHTML = marked.parse(artifact.content);
                    } else {
                        contentDiv.innerHTML = `<pre>${escapeHtml(artifact.content)}</pre>`;
                    }
                }
            } else if (tabName === 'source') {
                contentDiv.className = 'artifact-panel-content';
                contentDiv.innerHTML = `<pre><code>${escapeHtml(artifact.content)}</code></pre>`;
            } else if (tabName === 'history') {
                contentDiv.className = 'artifact-panel-content';
                
                // Get current artifact ID from panel title
                const title = document.getElementById('artifactPanelTitle').textContent;
                let historyContent = '';
                
                if (title.includes('API')) {
                    historyContent = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 20px;">Version History</h3>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #0076B6; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 2.1 (Current)</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Today at 9:16 AM by Code Agent</div>
                                <div style="color: #666; font-size: 13px;">Added refresh token endpoints and error handling</div>
                            </div>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #ccc; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 2.0</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Yesterday at 3:45 PM by Code Agent</div>
                                <div style="color: #666; font-size: 13px;">Updated authentication flow with OAuth2</div>
                            </div>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #ccc; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 1.0</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Monday at 11:30 AM by John Doe</div>
                                <div style="color: #666; font-size: 13px;">Initial API documentation</div>
                            </div>
                        </div>
                    `;
                } else if (title.includes('Analytics')) {
                    historyContent = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 20px;">Version History</h3>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #0076B6; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 1.2 (Current)</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Today at 10:31 AM by Analysis Agent</div>
                                <div style="color: #666; font-size: 13px;">Added monthly comparison metrics</div>
                            </div>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #ccc; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 1.1</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Yesterday at 2:15 PM by Sarah Miller</div>
                                <div style="color: #666; font-size: 13px;">Requested additional retention metrics</div>
                            </div>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #ccc; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 1.0</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Tuesday at 10:30 AM by Analysis Agent</div>
                                <div style="color: #666; font-size: 13px;">Initial dashboard creation</div>
                            </div>
                        </div>
                    `;
                } else if (title.includes('React')) {
                    historyContent = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 20px;">Version History</h3>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #0076B6; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 1.0 (Current)</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">Today at 11:21 AM by Code Agent</div>
                                <div style="color: #666; font-size: 13px;">Initial component with form validation</div>
                            </div>
                        </div>
                    `;
                } else {
                    historyContent = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 20px;">Version History</h3>
                            
                            <div class="artifact-history-item" style="border-left: 3px solid #0076B6; padding-left: 15px; margin-bottom: 20px;">
                                <div style="font-weight: 600; color: #333;">Version 1.0 (Current)</div>
                                <div style="color: #666; font-size: 13px; margin: 4px 0;">${new Date().toLocaleString()}</div>
                                <div style="color: #666; font-size: 13px;">Initial version</div>
                            </div>
                        </div>
                    `;
                }
                
                contentDiv.innerHTML = historyContent;
            }
        }
        
        // V4: Copy artifact content
        function copyArtifactContent() {
            if (window.currentArtifact) {
                navigator.clipboard.writeText(window.currentArtifact.content);
                showToast('Artifact content copied to clipboard', 'success');
            }
        }
        
        // V4: Download artifact
        function downloadArtifact() {
            if (window.currentArtifact) {
                const blob = new Blob([window.currentArtifact.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${window.currentArtifact.title.replace(/\s+/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Artifact downloaded', 'success');
            }
        }
        
        // V4: Maximize artifact panel
        function maximizeArtifact() {
            const panel = document.getElementById('artifactPanel');
            if (panel.style.width === '100%') {
                panel.style.width = '600px';
                showToast('Artifact panel restored', 'info');
            } else {
                panel.style.width = '100%';
                showToast('Artifact panel maximized', 'info');
            }
        }
        
        // V4: Escape HTML helper
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // V5: Share Modal Functions
        function openShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('show');
            
            // Generate unique share link for current artifact
            if (window.currentArtifact) {
                const shareLink = window.currentArtifact.shareLink || 
                    `https://agentchat.com/artifact/${Date.now()}`;
                document.getElementById('shareLink').value = shareLink;
                
                // Update shared users list if artifact has shares
                if (window.currentArtifact.sharedWith && window.currentArtifact.sharedWith.length > 0) {
                    updateSharedUsersList(window.currentArtifact.sharedWith);
                }
            }
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('show');
        }
        
        function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value);
            showToast('Share link copied to clipboard', 'success');
        }
        
        function selectPermission(element, permission) {
            // Update UI
            document.querySelectorAll('.permission-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input').checked = false;
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
            
            // Store permission
            if (window.currentArtifact) {
                window.currentArtifact.defaultPermission = permission;
            }
        }
        
        function removeShare(userId) {
            if (window.currentArtifact && window.currentArtifact.sharedWith) {
                window.currentArtifact.sharedWith = window.currentArtifact.sharedWith.filter(u => u.id !== userId);
                updateSharedUsersList(window.currentArtifact.sharedWith);
                showToast('User removed from shared artifact', 'info');
            }
        }
        
        function updateSharedUsersList(users) {
            const listContainer = document.getElementById('sharedUsersList');
            if (users.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 13px;">No users have access yet</div>';
            } else {
                listContainer.innerHTML = users.map(user => `
                    <div class="shared-user-item">
                        <div class="shared-user-info">
                            <div class="shared-user-avatar" style="background: ${user.color};">${user.initials}</div>
                            <div class="shared-user-details">
                                <div class="shared-user-name">${user.name}</div>
                                <div class="shared-user-permission">${user.permission}</div>
                            </div>
                        </div>
                        <button class="remove-share-btn" onclick="removeShare('${user.id}')">Remove</button>
                    </div>
                `).join('');
            }
        }
        
        // V5: Add user to share
        function shareWithUser(email) {
            if (!window.currentArtifact) return;
            
            // Initialize sharedWith array if not exists
            if (!window.currentArtifact.sharedWith) {
                window.currentArtifact.sharedWith = [];
            }
            
            // Get selected permission
            const selectedPermission = document.querySelector('.permission-option.selected');
            const permission = selectedPermission ? 
                selectedPermission.querySelector('.permission-name').textContent : 'View Only';
            
            // Add new user
            const newUser = {
                id: `user-${Date.now()}`,
                name: email.split('@')[0],
                email: email,
                initials: email.substring(0, 2).toUpperCase(),
                color: ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6'][Math.floor(Math.random() * 5)],
                permission: permission
            };
            
            window.currentArtifact.sharedWith.push(newUser);
            window.currentArtifact.shared = true;
            
            updateSharedUsersList(window.currentArtifact.sharedWith);
            showToast(`Artifact shared with ${newUser.name}`, 'success');
            
            // Update artifact reference in message to show it's shared
            refreshArtifactDisplay();
        }
        
        function refreshArtifactDisplay() {
            // This would update the artifact reference in the chat to show sharing status
            // For demo purposes, we'll just log it
            console.log('Artifact sharing status updated');
        }

        // Show typing indicator
        function showTypingIndicator() {
            const container = document.getElementById('conversationHistory');
            const typingHtml = `
                <div class="message" id="typingIndicator">
                    <div class="message-avatar agent-message-avatar" style="background-color: var(--agent-claude);">
                        C
                    </div>
                    <div class="message-content">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += typingHtml;
            container.scrollTop = container.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Format time
        function formatTime(date) {
            // Ensure date is a Date object
            if (!date) return '';
            
            // Convert string dates to Date objects
            if (typeof date === 'string') {
                date = new Date(date);
            }
            
            // Check if it's a valid date
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                return '';
            }
            
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // Action functions
        function likeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                const likeBtn = message.querySelector('.feedback-btn .fa-thumbs-up').parentElement;
                const dislikeBtn = message.querySelector('.feedback-btn .fa-thumbs-down').parentElement;
                
                // Toggle like state
                likeBtn.classList.toggle('liked');
                // Remove dislike if it was active
                dislikeBtn.classList.remove('disliked');
                
                // Update icon to filled/outline
                const likeIcon = likeBtn.querySelector('i');
                if (likeBtn.classList.contains('liked')) {
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas');
                } else {
                    likeIcon.classList.remove('fas');
                    likeIcon.classList.add('far');
                }
                
                // Reset dislike icon to outline
                const dislikeIcon = dislikeBtn.querySelector('i');
                dislikeIcon.classList.remove('fas');
                dislikeIcon.classList.add('far');
                
                showToast('Feedback recorded', 'success');
            }
        }
        
        function dislikeMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                const likeBtn = message.querySelector('.feedback-btn .fa-thumbs-up').parentElement;
                const dislikeBtn = message.querySelector('.feedback-btn .fa-thumbs-down').parentElement;
                
                // Toggle dislike state
                dislikeBtn.classList.toggle('disliked');
                // Remove like if it was active
                likeBtn.classList.remove('liked');
                
                // Update icon to filled/outline
                const dislikeIcon = dislikeBtn.querySelector('i');
                if (dislikeBtn.classList.contains('disliked')) {
                    dislikeIcon.classList.remove('far');
                    dislikeIcon.classList.add('fas');
                } else {
                    dislikeIcon.classList.remove('fas');
                    dislikeIcon.classList.add('far');
                }
                
                // Reset like icon to outline
                const likeIcon = likeBtn.querySelector('i');
                likeIcon.classList.remove('fas');
                likeIcon.classList.add('far');
                
                showToast('Feedback recorded', 'success');
            }
        }
        
        function copyMessage(messageId) {
            closeAllMessageMenus();
            let messageText;
            if (typeof messageId === 'object') {
                // Old style with button parameter
                messageText = messageId.closest('.message-content').querySelector('.message-text').textContent;
            } else {
                // New style with messageId
                const message = document.getElementById(messageId) || document.querySelector(`#msg-${messageId}, #message-${messageId}`);
                if (message) {
                    messageText = message.querySelector('.message-text').textContent;
                }
            }
            if (messageText) {
                navigator.clipboard.writeText(messageText);
                showToast('Message copied to clipboard', 'success');
            }
        }

        function forkFromMessage(messageId) {
            closeAllMessageMenus();
            showToast('Forking conversation from this point...', 'info');
        }
        
        function toggleMessageMenu(event, messageId) {
            event.stopPropagation();
            const menuId = `message-menu-${messageId}`;
            const menu = document.getElementById(menuId);
            
            if (!menu) return;
            
            // Close all other menus
            document.querySelectorAll('.message-menu-dropdown').forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });
            
            // Toggle this menu
            menu.classList.toggle('show');
            
            // Close on click outside
            if (menu.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', closeAllMessageMenus);
                }, 0);
            }
        }
        
        function closeAllMessageMenus() {
            document.querySelectorAll('.message-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            document.removeEventListener('click', closeAllMessageMenus);
        }
        
        function regenerateMessage(messageId) {
            closeAllMessageMenus();
            showToast('Regenerating response...', 'info');
        }
        
        const pinnedMessages = new Set();
        
        function pinMessage(messageId) {
            closeAllMessageMenus();
            
            const message = document.getElementById(messageId);
            if (!message) return;
            
            const messageText = message.querySelector('.message-text').textContent;
            const sender = message.querySelector('.message-sender')?.textContent || 'Unknown';
            
            if (pinnedMessages.has(messageId)) {
                showToast('Message already pinned', 'info');
                return;
            }
            
            pinnedMessages.add(messageId);
            
            // Show pinned messages section
            const pinnedSection = document.getElementById('pinnedMessages');
            pinnedSection.style.display = 'block';
            
            // Add to pinned list
            const pinnedList = document.getElementById('pinnedList');
            const pinnedItem = document.createElement('div');
            pinnedItem.className = 'pinned-message';
            pinnedItem.setAttribute('data-message-id', messageId);
            pinnedItem.innerHTML = `
                <i class="fas fa-thumbtack" style="color: var(--mj-blue); font-size: 12px;"></i>
                <div class="pinned-message-text">
                    <strong>${sender}:</strong> ${messageText.substring(0, 100)}${messageText.length > 100 ? '...' : ''}
                </div>
                <div class="pinned-message-actions">
                    <button class="unpin-btn" onclick="unpinMessage('${messageId}')" title="Unpin">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            pinnedItem.onclick = function() {
                const targetMessage = document.getElementById(messageId);
                if (targetMessage) {
                    targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetMessage.style.animation = 'highlight 2s';
                }
            };
            
            pinnedList.appendChild(pinnedItem);
            showToast('Message pinned', 'success');
        }
        
        function unpinMessage(messageId) {
            pinnedMessages.delete(messageId);
            
            const pinnedItem = document.querySelector(`.pinned-message[data-message-id="${messageId}"]`);
            if (pinnedItem) {
                pinnedItem.remove();
            }
            
            // Hide section if no pinned messages
            if (pinnedMessages.size === 0) {
                document.getElementById('pinnedMessages').style.display = 'none';
            }
            
            showToast('Message unpinned', 'success');
        }
        
        function togglePinnedMessages() {
            const pinnedList = document.getElementById('pinnedList');
            const toggleIcon = document.querySelector('.pinned-toggle i');
            
            pinnedList.classList.toggle('collapsed');
            
            if (pinnedList.classList.contains('collapsed')) {
                toggleIcon.className = 'fas fa-chevron-down';
            } else {
                toggleIcon.className = 'fas fa-chevron-up';
            }
        }
        
        function createReminder(messageId) {
            closeAllMessageMenus();
            
            showReminderModal((reminderTime) => {
                const timeStr = reminderTime.toLocaleString();
                showToast(`Reminder set for ${timeStr}`, 'success');
                
                // Store reminder data
                const message = document.getElementById(messageId);
                if (message) {
                    // Add visual indicator
                    const reminderBadge = document.createElement('span');
                    reminderBadge.className = 'reminder-badge';
                    reminderBadge.innerHTML = '<i class="fas fa-bell"></i> Reminder set';
                    
                    // Store reminder in localStorage (for persistence)
                    const reminders = JSON.parse(localStorage.getItem('chatReminders') || '[]');
                    reminders.push({
                        id: Date.now(),
                        messageId: messageId,
                        time: reminderTime.toISOString(),
                        created: new Date().toISOString()
                    });
                    localStorage.setItem('chatReminders', JSON.stringify(reminders));
                    reminderBadge.style.cssText = 'display: inline-block; margin-left: 8px; padding: 2px 8px; background: #f39c12; color: white; border-radius: 12px; font-size: 11px;';
                    
                    const messageHeader = message.querySelector('.message-header');
                    if (messageHeader && !messageHeader.querySelector('.reminder-badge')) {
                        messageHeader.appendChild(reminderBadge);
                    }
                }
            });
        }

        function viewArtifact(button) {
            alert('View artifact in full screen');
        }

        function forkChat() {
            showToast('Fork feature coming soon', 'info', 'Fork Conversation');
        }

        function exportChat() {
            showToast('Export feature coming soon', 'info', 'Export');
        }

        function shareChat() {
            showToast('Share feature coming soon', 'info', 'Share');
        }

        function attachFile() {
            showToast('File attachment coming soon', 'info', 'Attach File');
        }

        function toggleThread() {
            showToast('Thread feature coming soon', 'info', 'Threads');
        }

        // Search in chat functionality
        function searchInChat(event) {
            const searchTerm = event.target.value.trim().toLowerCase();
            const clearBtn = document.querySelector('.clear-search-btn');
            
            if (searchTerm) {
                clearBtn.style.display = 'block';
                // Highlight matching messages
                const messages = document.querySelectorAll('.message-text');
                messages.forEach(message => {
                    const text = message.textContent.toLowerCase();
                    const parent = message.closest('.message');
                    if (text.includes(searchTerm)) {
                        parent.style.opacity = '1';
                        // Highlight the matching text
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const originalText = message.textContent;
                        message.innerHTML = originalText.replace(regex, '<mark>$1</mark>');
                    } else {
                        parent.style.opacity = '0.3';
                    }
                });
            } else {
                clearBtn.style.display = 'none';
                clearSearchHighlights();
            }
            
            // Handle Enter key for navigation between results
            if (event.key === 'Enter' && searchTerm) {
                navigateToNextResult();
            }
        }

        function clearSearch() {
            const searchInput = document.querySelector('.chat-search-input');
            searchInput.value = '';
            document.querySelector('.clear-search-btn').style.display = 'none';
            clearSearchHighlights();
        }

        function clearSearchHighlights() {
            const messages = document.querySelectorAll('.message');
            messages.forEach(message => {
                message.style.opacity = '1';
            });
            // Remove highlight marks
            const highlights = document.querySelectorAll('mark');
            highlights.forEach(mark => {
                const parent = mark.parentNode;
                parent.replaceChild(document.createTextNode(mark.textContent), mark);
                parent.normalize();
            });
        }

        function navigateToNextResult() {
            const visibleMessages = document.querySelectorAll('.message[style*="opacity: 1"]');
            if (visibleMessages.length > 0) {
                visibleMessages[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function searchMessages() {
            console.log('Search messages functionality');
            showNotification('Search feature coming soon');
        }

        // Notification system instead of alerts
        // Store thread replies (in production this would be in a database)
        const threadReplies = {};
        
        // Add thread functionality
        function startThread(messageId) {
            const message = document.getElementById(messageId);
            if (!message) return;
            
            // Open the thread panel for this message
            openThreadPanel(messageId);
        }
        
        function getThreadReplies(messageId) {
            return threadReplies[messageId] || [];
        }
        
        function sendThreadReply(messageId) {
            const replyBox = document.querySelector('.thread-reply-box textarea');
            const replyText = replyBox.value.trim();
            
            if (!replyText) return;
            
            // Add the reply to storage
            if (!threadReplies[messageId]) {
                threadReplies[messageId] = [];
            }
            
            const newReply = {
                id: Date.now(),
                sender: 'You',
                avatar: 'U',
                text: replyText,
                timestamp: new Date(),
                isAI: false
            };
            
            threadReplies[messageId].push(newReply);
            
            // Update the thread preview on the main message
            updateThreadPreview(messageId);
            
            // Reload the thread messages
            loadThreadMessages(messageId);
            
            // Clear the reply box
            replyBox.value = '';
            
            // Simulate AI response after a delay
            setTimeout(() => {
                const aiReply = {
                    id: Date.now() + 1,
                    sender: 'Claude',
                    avatar: 'C',
                    text: 'Thanks for your reply! Let me help you with that.',
                    timestamp: new Date(),
                    isAI: true,
                    color: 'var(--agent-claude)',
                    seen: false  // Mark as unseen for notification
                };
                
                threadReplies[messageId].push(aiReply);
                updateThreadPreview(messageId);
                
                // If thread panel is open, reload and mark as seen
                const panel = document.getElementById('threadPanel');
                if (panel && panel.classList.contains('open')) {
                    loadThreadMessages(messageId);
                    // Mark all as seen since panel is open
                    threadReplies[messageId].forEach(r => r.seen = true);
                    updateThreadPreview(messageId);
                } else {
                    showToast('New reply in thread', 'info');
                }
            }, 2000);
        }
        
        function updateThreadPreview(messageId) {
            const message = document.getElementById(messageId);
            if (!message) return;
            
            const previewContainer = document.getElementById(`thread-preview-${messageId}`);
            const replies = getThreadReplies(messageId);
            
            if (!previewContainer || replies.length === 0) return;
            
            // Get unique avatars (max 3)
            const avatars = [...new Set(replies.map(r => ({text: r.avatar, color: r.isAI ? r.color : 'var(--navy)'})))].slice(0, 3);
            
            previewContainer.innerHTML = `
                <div class="thread-preview show" onclick="openThreadPanel('${messageId}')">
                    <div class="thread-avatars">
                        ${avatars.map(a => `<div class="thread-avatar" style="background: ${a.color};">${a.text}</div>`).join('')}
                    </div>
                    <div class="thread-info">${replies.length} ${replies.length === 1 ? 'reply' : 'replies'}</div>
                    <div class="thread-timestamp" style="display: flex; align-items: center;">
                        <span>Last reply ${formatTime(replies[replies.length - 1].timestamp)}</span>
                        ${replies.some(r => !r.seen) ? `<span class="thread-new-badge">${replies.filter(r => !r.seen).length}</span>` : ''}
                    </div>
                </div>
            `;
        }
        

        // Shared Artifacts Dashboard Functions
        let sharedArtifacts = [];
        let currentFilter = 'all';

        function openSharedArtifactsDashboard() {
            const modal = document.getElementById('sharedDashboardModal');
            modal.classList.add('show');
            loadSharedArtifacts();
        }

        function closeSharedDashboard() {
            const modal = document.getElementById('sharedDashboardModal');
            modal.classList.remove('show');
        }

        function loadSharedArtifacts() {
            // Simulate loading shared artifacts
            sharedArtifacts = [
                {
                    id: 'art-1',
                    title: 'API Documentation',
                    type: 'markdown',
                    preview: 'Complete REST API documentation for the authentication service including endpoints, request/response examples...',
                    owner: 'You',
                    sharedWith: ['John D.', 'Sarah M.', 'Mike R.'],
                    lastModified: '2 hours ago',
                    isPublic: false
                },
                {
                    id: 'art-2',
                    title: 'Data Processing Script',
                    type: 'code',
                    preview: 'Python script for processing CSV files and generating analytics reports with pandas and matplotlib...',
                    owner: 'Sarah M.',
                    sharedWith: ['You', 'John D.'],
                    lastModified: '1 day ago',
                    isPublic: false
                },
                {
                    id: 'art-3',
                    title: 'Project Architecture',
                    type: 'diagram',
                    preview: 'System architecture diagram showing microservices, databases, and communication patterns...',
                    owner: 'You',
                    sharedWith: ['Team'],
                    lastModified: '3 days ago',
                    isPublic: true
                },
                {
                    id: 'art-4',
                    title: 'Database Schema',
                    type: 'sql',
                    preview: 'Complete database schema for the user management system including tables, indexes, and relationships...',
                    owner: 'Mike R.',
                    sharedWith: ['You', 'Sarah M.', 'John D.'],
                    lastModified: '1 week ago',
                    isPublic: false
                },
                {
                    id: 'art-5',
                    title: 'React Components Library',
                    type: 'code',
                    preview: 'Reusable React components with TypeScript definitions and Storybook documentation...',
                    owner: 'You',
                    sharedWith: ['Frontend Team'],
                    lastModified: '2 days ago',
                    isPublic: true
                },
                {
                    id: 'art-6',
                    title: 'Meeting Notes - Q4 Planning',
                    type: 'markdown',
                    preview: 'Q4 planning meeting notes including objectives, key results, and action items for the team...',
                    owner: 'John D.',
                    sharedWith: ['You', 'Sarah M.', 'Mike R.', 'Lisa K.'],
                    lastModified: '5 hours ago',
                    isPublic: false
                }
            ];

            // Update stats
            document.getElementById('totalSharedCount').textContent = sharedArtifacts.length;
            document.getElementById('activeCollaboratorsCount').textContent = 
                new Set(sharedArtifacts.flatMap(a => a.sharedWith)).size;
            document.getElementById('recentActivityCount').textContent = 
                sharedArtifacts.filter(a => a.lastModified.includes('hour') || a.lastModified === '1 day ago').length;

            renderSharedArtifacts();
        }

        function filterSharedArtifacts(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderSharedArtifacts();
        }

        function renderSharedArtifacts() {
            const grid = document.getElementById('sharedArtifactsGrid');
            let filtered = sharedArtifacts;

            switch(currentFilter) {
                case 'owned':
                    filtered = sharedArtifacts.filter(a => a.owner === 'You');
                    break;
                case 'shared-with-me':
                    filtered = sharedArtifacts.filter(a => a.owner !== 'You');
                    break;
                case 'public':
                    filtered = sharedArtifacts.filter(a => a.isPublic);
                    break;
            }

            const typeColors = {
                'markdown': '#4CAF50',
                'code': '#2196F3',
                'diagram': '#FF9800',
                'sql': '#9C27B0',
                'chart': '#F44336'
            };

            grid.innerHTML = filtered.map(artifact => `
                <div class="shared-artifact-card" onclick="openArtifactFromDashboard('${artifact.id}')">
                    <div class="artifact-card-header">
                        <div>
                            <div class="artifact-card-title">${artifact.title}</div>
                            <span class="artifact-card-type">${artifact.type}</span>
                        </div>
                        ${artifact.isPublic ? '<i class="fas fa-globe" title="Public"></i>' : ''}
                    </div>
                    <div class="artifact-card-preview">${artifact.preview}</div>
                    <div class="artifact-card-meta">
                        <div class="artifact-card-shared">
                            <i class="fas fa-user"></i> ${artifact.owner}
                            <span> ${artifact.lastModified}</span>
                        </div>
                        <div class="artifact-card-collaborators">
                            ${artifact.sharedWith.slice(0, 3).map(name => 
                                `<div class="mini-avatar" style="background-color: ${typeColors[artifact.type]}" title="${name}">${name.charAt(0)}</div>`
                            ).join('')}
                            ${artifact.sharedWith.length > 3 ? 
                                `<div class="mini-avatar" style="background-color: #666" title="${artifact.sharedWith.length - 3} more">+${artifact.sharedWith.length - 3}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openArtifactFromDashboard(artifactId) {
            const artifact = sharedArtifacts.find(a => a.id === artifactId);
            if (artifact) {
                // Close dashboard
                closeSharedDashboard();
                
                // Create a mock artifact for display
                const mockArtifact = {
                    id: artifactId,
                    type: artifact.type,
                    title: artifact.title,
                    content: `# ${artifact.title}\n\n${artifact.preview}\n\n## Details\n\nThis is a shared artifact that you can view and potentially edit based on your permissions.`,
                    language: artifact.type === 'code' ? 'javascript' : artifact.type,
                    sharedWith: artifact.sharedWith.map(name => ({
                        id: `user-${name.replace(/\s/g, '-')}`,
                        name: name,
                        avatar: name.charAt(0),
                        permission: name === 'You' ? 'owner' : 'editor'
                    })),
                    isPublic: artifact.isPublic
                };
                
                // Ensure currentArtifacts is initialized
                window.currentArtifacts = window.currentArtifacts || {};
                window.currentArtifacts[artifactId] = mockArtifact;
                openArtifactPanel(artifactId);
            }
        }
        // Date Navigation Functions
        let dateNavOpen = false;
        let currentVisibleDate = 'today';
        
        function toggleDateNav() {
            const dropdown = document.getElementById('dateNavDropdown');
            dateNavOpen = !dateNavOpen;
            dropdown.classList.toggle('show', dateNavOpen);
        }
        
        function jumpToDate(period) {
            const dropdown = document.getElementById('dateNavDropdown');
            dropdown.classList.remove('show');
            dateNavOpen = false;
            
            let targetElement;
            let displayText;
            
            switch(period) {
                case 'today':
                    targetElement = document.querySelector('[data-date="today"]');
                    displayText = 'Today';
                    break;
                case 'yesterday':
                    targetElement = document.querySelector('[data-date="yesterday"]');
                    displayText = 'Yesterday';
                    break;
                case 'last-week':
                    // Find Monday's date
                    targetElement = document.querySelector('[data-date="2024-12-23"]');
                    displayText = 'Last Week';
                    break;
                case 'last-month':
                    targetElement = document.querySelector('.date-separator');
                    displayText = 'Last Month';
                    break;
            }
            
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                document.getElementById('currentDateDisplay').textContent = displayText;
                currentVisibleDate = period;
            }
        }
        
        function openDatePicker() {
            const dropdown = document.getElementById('dateNavDropdown');
            dropdown.classList.remove('show');
            dateNavOpen = false;
            
            const modal = document.getElementById('datePickerModal');
            modal.classList.add('show');
        }
        
        function closeDatePicker() {
            const modal = document.getElementById('datePickerModal');
            modal.classList.remove('show');
        }
        
        function submitDatePicker() {
            const dateInput = document.getElementById('datePickerInput');
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            
            if (selectedDate) {
                // Calculate days difference
                const diffTime = today - selectedDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let displayText;
                if (diffDays === 0) {
                    displayText = 'Today';
                } else if (diffDays === 1) {
                    displayText = 'Yesterday';
                } else if (diffDays < 7) {
                    displayText = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
                } else {
                    displayText = selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                document.getElementById('currentDateDisplay').textContent = displayText;
                closeDatePicker();
                
                // Scroll to approximate position (in real app, would find exact date)
                const messagesContainer = document.getElementById('conversationHistory');
                messagesContainer.scrollTop = messagesContainer.scrollHeight * (1 - diffDays / 30);
            }
        }
        
        // Update sticky date header on scroll
        document.getElementById('conversationHistory').addEventListener('scroll', function() {
            const separators = document.querySelectorAll('.date-separator');
            const scrollTop = this.scrollTop;
            
            separators.forEach(separator => {
                const rect = separator.getBoundingClientRect();
                const containerRect = this.getBoundingClientRect();
                
                if (rect.top <= containerRect.top + 50 && rect.bottom > containerRect.top) {
                    const dateAttr = separator.getAttribute('data-date');
                    let displayText = 'Today';
                    
                    if (dateAttr === 'today') {
                        displayText = 'Today';
                    } else if (dateAttr === 'yesterday') {
                        displayText = 'Yesterday';
                    } else if (dateAttr === '2024-12-24') {
                        displayText = 'Tuesday, December 24';
                    } else if (dateAttr === '2024-12-23') {
                        displayText = 'Monday, December 23';
                    }
                    
                    document.getElementById('currentDateDisplay').textContent = displayText;
                }
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dateNavDropdown');
            const button = event.target.closest('.sticky-date-button');
            const dropdownMenu = event.target.closest('.date-nav-dropdown');
            
            if (!button && !dropdownMenu && dateNavOpen) {
                dropdown.classList.remove('show');
                dateNavOpen = false;
            }
        });
    </script>
    
    <!-- Date Picker Modal -->
    <div class="date-picker-modal" id="datePickerModal">
        <div class="date-picker-content">
            <h3 class="date-picker-title">Jump to Date</h3>
            <input type="date" class="date-picker-input" id="datePickerInput" max="">
            <div class="date-picker-actions">
                <button class="date-picker-btn date-picker-cancel" onclick="closeDatePicker()">Cancel</button>
                <button class="date-picker-btn date-picker-submit" onclick="submitDatePicker()">Jump</button>
            </div>
        </div>
    </div>
    
    <script>
        // Set max date to today for date picker
        document.getElementById('datePickerInput').max = new Date().toISOString().split('T')[0];
        
        // Message Edit/Delete Functions
        function editMessage(messageId) {
            closeAllMessageMenus();
            
            // Handle both old format (msg-text-) and new format (message-text-)
            let textEl = document.getElementById(`message-text-${messageId}`);
            let editEl = document.getElementById(`message-edit-${messageId}`);
            let inputEl = document.getElementById(`message-edit-input-${messageId}`);
            
            // Fallback to old format if new format not found
            if (!textEl) {
                textEl = document.getElementById(`msg-text-${messageId}`);
                editEl = document.getElementById(`msg-edit-${messageId}`);
                inputEl = document.getElementById(`msg-input-${messageId}`);
            }
            
            if (!textEl || !editEl || !inputEl) {
                console.error('Edit elements not found for message:', messageId);
                return;
            }
            
            textEl.style.display = 'none';
            editEl.classList.add('active');
            inputEl.focus();
            inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length);
        }
        
        function cancelEditMessage(messageId) {
            const textEl = document.getElementById(`message-text-${messageId}`);
            const editEl = document.getElementById(`message-edit-${messageId}`);
            const inputEl = document.getElementById(`message-edit-input-${messageId}`);
            
            if (!textEl || !editEl || !inputEl) return;
            
            // Reset input value to original text
            inputEl.value = textEl.textContent;
            
            textEl.style.display = 'block';
            editEl.classList.remove('active');
        }
        
        function saveEditMessage(messageId) {
            const textEl = document.getElementById(`message-text-${messageId}`);
            const editEl = document.getElementById(`message-edit-${messageId}`);
            const inputEl = document.getElementById(`message-edit-input-${messageId}`);
            
            if (!textEl || !editEl || !inputEl) return;
            
            const newText = inputEl.value.trim();
            if (!newText) {
                showToast('Message cannot be empty', 'error');
                return;
            }
            
            textEl.textContent = newText;
            textEl.style.display = 'block';
            editEl.classList.remove('active');
            
            // Add edited indicator
            const header = textEl.closest('.message-content').querySelector('.message-header');
            if (!header.querySelector('.message-edited')) {
                const editedSpan = document.createElement('span');
                editedSpan.className = 'message-edited';
                editedSpan.textContent = '(edited)';
                header.appendChild(editedSpan);
            }
            
            // Update the message in the messages array if needed
            const messageIndex = messages.findIndex(m => `msg-${m.id}` === messageId);
            if (messageIndex !== -1) {
                messages[messageIndex].text = newText;
                messages[messageIndex].edited = true;
            }
            
            showToast('Message edited', 'success');
        }
        
        function cancelEdit(msgId) {
            const textEl = document.getElementById(`msg-text-${msgId}`);
            const editEl = document.getElementById(`msg-edit-${msgId}`);
            
            textEl.style.display = 'block';
            editEl.classList.remove('active');
        }
        
        function saveEdit(msgId) {
            const textEl = document.getElementById(`msg-text-${msgId}`);
            const editEl = document.getElementById(`msg-edit-${msgId}`);
            const inputEl = document.getElementById(`msg-input-${msgId}`);
            
            textEl.textContent = inputEl.value;
            textEl.style.display = 'block';
            editEl.classList.remove('active');
            
            // Add edited indicator
            const header = textEl.previousElementSibling;
            if (!header.querySelector('.edited-indicator')) {
                const edited = document.createElement('span');
                edited.className = 'edited-indicator';
                edited.textContent = '(edited)';
                edited.style.fontSize = '11px';
                edited.style.color = 'var(--text-secondary)';
                edited.style.marginLeft = '8px';
                header.appendChild(edited);
            }
        }
        
        function deleteMessage(msgId) {
            closeAllMessageMenus();
            const message = document.getElementById(msgId);
            const messageText = message.querySelector('.message-content')?.textContent || 'this message';
            const preview = messageText.substring(0, 50) + (messageText.length > 50 ? '...' : '');
            
            showDeleteModal(
                'Delete Message',
                'This message will be permanently deleted from the chat.',
                preview,
                () => {
                    message.style.transition = 'opacity 0.3s, transform 0.3s';
                    message.style.opacity = '0';
                    message.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        message.remove();
                    }, 300);
                }
            );
        }
        
        
        // Agent Feedback Functions
        function toggleFeedback(button, type, msgId) {
            const parent = button.parentElement;
            const otherButton = type === 'like' 
                ? parent.querySelector('.feedback-btn:last-child')
                : parent.querySelector('.feedback-btn:first-child');
            
            const isActive = button.classList.contains(type === 'like' ? 'liked' : 'disliked');
            const countEl = button.querySelector('.feedback-count');
            let count = parseInt(countEl.textContent);
            
            if (isActive) {
                // Remove feedback
                button.classList.remove(type === 'like' ? 'liked' : 'disliked');
                count = Math.max(0, count - 1);
                countEl.textContent = count;
                
                // Change icon to outline
                const icon = button.querySelector('i');
                icon.className = type === 'like' ? 'far fa-thumbs-up' : 'far fa-thumbs-down';
            } else {
                // Add feedback
                button.classList.add(type === 'like' ? 'liked' : 'disliked');
                count++;
                countEl.textContent = count;
                
                // Change icon to solid
                const icon = button.querySelector('i');
                icon.className = type === 'like' ? 'fas fa-thumbs-up' : 'fas fa-thumbs-down';
                
                // Remove opposite feedback if active
                if (otherButton.classList.contains(type === 'like' ? 'disliked' : 'liked')) {
                    const otherCount = otherButton.querySelector('.feedback-count');
                    let otherCountVal = parseInt(otherCount.textContent);
                    otherButton.classList.remove(type === 'like' ? 'disliked' : 'liked');
                    otherCount.textContent = Math.max(0, otherCountVal - 1);
                    
                    // Change other icon to outline
                    const otherIcon = otherButton.querySelector('i');
                    otherIcon.className = type === 'like' ? 'far fa-thumbs-down' : 'far fa-thumbs-up';
                }
            }
            
            // In a real app, this would send feedback to the server
            console.log(`Feedback ${type} for ${msgId}: ${!isActive}`);
        }
        
        // MJ Explorer Toggle Functions
        function navigateTo(destination) {
            if (destination === 'explorer') {
                showToast('Navigating to MJ Explorer...', 'info');
                // In real implementation, would navigate to explorer
            } else if (destination === 'chat') {
                // Already in chat view
                toggleView('chat');
            }
        }
        
        // Libraries Functions
        function toggleLibraryFolder(element) {
            // Toggle the header expanded state
            element.classList.toggle('expanded');
            const isExpanded = element.classList.contains('expanded');
            
            // Find and toggle the library-items sibling
            const items = element.nextElementSibling;
            
            if (items && items.classList.contains('library-items')) {
                if (isExpanded) {
                    items.classList.add('expanded');
                } else {
                    items.classList.remove('expanded');
                }
            }
        }
        
        // Search libraries and artifacts
        function searchLibraries(query) {
            const lowerQuery = query.toLowerCase().trim();
            const folders = document.querySelectorAll('.library-folder');
            
            if (!lowerQuery) {
                // Show all if search is empty
                folders.forEach(folder => {
                    folder.style.display = 'block';
                    // Collapse all when clearing search
                    const header = folder.querySelector('.library-folder-header');
                    if (header && header.classList.contains('expanded')) {
                        toggleLibraryFolder(header);
                    }
                });
                return;
            }
            
            folders.forEach(folder => {
                const libraryName = folder.querySelector('.library-folder-name')?.textContent.toLowerCase() || '';
                const artifacts = folder.querySelectorAll('.library-artifact-card');
                let hasMatchingArtifact = false;
                
                // Check if library name matches
                const libraryMatches = libraryName.includes(lowerQuery);
                
                // Check if any artifact matches
                artifacts.forEach(artifact => {
                    const title = artifact.querySelector('.artifact-card-title')?.textContent.toLowerCase() || '';
                    const type = artifact.querySelector('.artifact-type-badge')?.textContent.toLowerCase() || '';
                    const preview = artifact.querySelector('.artifact-card-preview')?.textContent.toLowerCase() || '';
                    
                    if (title.includes(lowerQuery) || type.includes(lowerQuery) || preview.includes(lowerQuery)) {
                        hasMatchingArtifact = true;
                        artifact.style.display = 'block';
                        // Highlight matching text
                        artifact.style.background = 'linear-gradient(to right, #fff, #f0f9ff)';
                    } else {
                        artifact.style.display = 'none';
                    }
                });
                
                // Show folder if it matches or has matching artifacts
                if (libraryMatches || hasMatchingArtifact) {
                    folder.style.display = 'block';
                    // Auto-expand if has matching artifacts
                    if (hasMatchingArtifact && !libraryMatches) {
                        const header = folder.querySelector('.library-folder-header');
                        if (header && !header.classList.contains('expanded')) {
                            toggleLibraryFolder(header);
                        }
                    }
                } else {
                    folder.style.display = 'none';
                }
            });
        }
        
        let selectedLibraryIcon = 'fa-folder';
        let selectedLibraryColor = '#6b7280';
        
        // Debug helper - expose to global for testing
        window.debugLibraries = function() {
            console.log('=== Library Debug Info ===');
            console.log('Libraries data:', librariesData);
            const container = document.querySelector('.library-folders');
            console.log('Container element:', container);
            console.log('Container innerHTML length:', container ? container.innerHTML.length : 'No container');
            console.log('Container children:', container ? container.children : 'No container');
            const headers = document.querySelectorAll('.library-folder-header');
            console.log('Library headers found:', headers.length);
            headers.forEach((header, i) => {
                console.log(`Header ${i}:`, header, 'onclick:', header.onclick);
            });
            console.log('toggleLibraryFolder function exists:', typeof toggleLibraryFolder);
            return 'Debug complete - check console above';
        };
        
        function openCreateLibraryModal(parentId = null) {
            // Close Libraries modal first if open
            const librariesModal = document.getElementById('librariesModal');
            if (librariesModal) {
                librariesModal.style.display = 'none';
            }
            
            const modal = document.getElementById('createLibraryModal');
            modal.style.display = 'flex';
            
            // Reset form
            document.getElementById('libraryName').value = '';
            document.getElementById('libraryDescription').value = '';
            selectedLibraryIcon = 'fa-folder';
            selectedLibraryColor = '#6b7280';
            
            // Reset icon selection
            document.querySelectorAll('.icon-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.icon === 'fa-folder') {
                    btn.classList.add('selected');
                }
            });
            
            // Reset color selection
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.color === '#6b7280') {
                    btn.classList.add('selected');
                }
            });
            
            // Handle parent library if creating sub-library
            const parentGroup = document.getElementById('parentLibraryGroup');
            const parentSelect = document.getElementById('parentLibrary');
            if (parentId) {
                parentGroup.style.display = 'block';
                parentSelect.innerHTML = '<option value="">None (Root Level)</option>';
                librariesData.libraries.forEach(lib => {
                    if (lib.id !== parentId) {
                        parentSelect.innerHTML += `<option value="${lib.id}" ${lib.id === parentId ? 'selected' : ''}>${lib.name}</option>`;
                    }
                });
            } else {
                parentGroup.style.display = 'none';
            }
        }
        
        // Alias for compatibility
        function showCreateLibraryModal(parentId = null) {
            openCreateLibraryModal(parentId);
        }
        
        function showCreateSubLibraryModal(parentId) {
            event.stopPropagation();
            showCreateLibraryModal(parentId);
        }
        
        function closeCreateLibraryModal() {
            document.getElementById('createLibraryModal').style.display = 'none';
            
            // Reopen Libraries modal
            openLibrariesModal();
        }
        
        function selectLibraryIcon(button) {
            document.querySelectorAll('.icon-option').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedLibraryIcon = button.dataset.icon;
        }
        
        function selectLibraryColor(button) {
            document.querySelectorAll('.color-option').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedLibraryColor = button.dataset.color;
        }
        
        function confirmCreateLibrary() {
            const name = document.getElementById('libraryName').value.trim();
            const description = document.getElementById('libraryDescription').value.trim();
            
            if (!name) {
                showToast('Please enter a library name', 'error');
                return;
            }
            
            // Create new library
            const newLibrary = {
                id: 'lib-' + Date.now(),
                name: name,
                description: description,
                icon: selectedLibraryIcon || 'fa-folder',
                color: selectedLibraryColor || '#6b7280',
                artifacts: [],
                createdAt: new Date()
            };
            
            // Add to libraries data
            librariesData.libraries = librariesData.libraries || [];
            librariesData.libraries.push(newLibrary);
            
            // Save to localStorage
            saveLibrariesData();
            
            // Close modal
            closeCreateLibraryModal();
            
            // Refresh the view if we're in libraries view
            if (document.getElementById('librariesView').style.display !== 'none') {
                // Re-render sidebar
                renderLibrariesInSidebar();
                // Show the new library
                selectLibrary(newLibrary.id);
            }
            
            showToast(`Library "${name}" created successfully`, 'success');
        }
        
        function showEditLibraryModal(libraryId) {
            event.stopPropagation();
            const library = librariesData.libraries.find(lib => lib.id === libraryId);
            if (!library) return;
            
            const modal = document.getElementById('editLibraryModal');
            modal.classList.add('show');
            
            // Populate form
            document.getElementById('editLibraryId').value = library.id;
            document.getElementById('editLibraryName').value = library.name;
            document.getElementById('editLibraryDescription').value = library.description;
            
            // Populate icons
            const iconPicker = document.getElementById('editIconPicker');
            const icons = ['fa-folder', 'fa-book', 'fa-code', 'fa-chart-bar', 'fa-database', 'fa-file-alt', 'fa-image', 'fa-cog'];
            iconPicker.innerHTML = icons.map(icon => `
                <button class="icon-option ${icon === library.icon ? 'selected' : ''}" 
                        data-icon="${icon}" 
                        onclick="selectEditLibraryIcon(this)">
                    <i class="fas ${icon}"></i>
                </button>
            `).join('');
            
            // Populate colors
            const colorPicker = document.getElementById('editColorPicker');
            const colors = ['#6b7280', '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6'];
            colorPicker.innerHTML = colors.map(color => `
                <button class="color-option ${color === library.color ? 'selected' : ''}" 
                        data-color="${color}" 
                        style="background: ${color}"
                        onclick="selectEditLibraryColor(this)">
                </button>
            `).join('');
            
            selectedLibraryIcon = library.icon;
            selectedLibraryColor = library.color;
        }
        
        function openEditLibraryModal(library) {
            const modal = document.getElementById('editLibraryModal');
            modal.classList.add('show');
            
            // Store selected values
            selectedLibraryIcon = library.icon || 'fa-folder';
            selectedLibraryColor = library.color || '#6b7280';
            
            // Populate form
            document.getElementById('editLibraryId').value = library.id;
            document.getElementById('editLibraryName').value = library.name;
            document.getElementById('editLibraryDescription').value = library.description || '';
            
            // Populate icons
            const iconPicker = document.getElementById('editIconPicker');
            const icons = ['fa-folder', 'fa-book', 'fa-code', 'fa-chart-bar', 'fa-database', 'fa-file-alt', 'fa-image', 'fa-cog'];
            iconPicker.innerHTML = icons.map(icon => `
                <button class="icon-option ${icon === library.icon ? 'selected' : ''}" 
                        data-icon="${icon}" 
                        onclick="selectEditLibraryIcon(this)">
                    <i class="fas ${icon}"></i>
                </button>
            `).join('');
            
            // Populate colors
            const colorPicker = document.getElementById('editColorPicker');
            const colors = ['#6b7280', '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6'];
            colorPicker.innerHTML = colors.map(color => `
                <button class="color-option ${color === library.color ? 'selected' : ''}" 
                        data-color="${color}" 
                        style="background: ${color}"
                        onclick="selectEditLibraryColor(this)">
                </button>
            `).join('');
        }
        
        function closeEditLibraryModal() {
            document.getElementById('editLibraryModal').classList.remove('show');
        }
        
        function selectEditLibraryIcon(button) {
            document.querySelectorAll('#editIconPicker .icon-option').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedLibraryIcon = button.dataset.icon;
        }
        
        function selectEditLibraryColor(button) {
            document.querySelectorAll('#editColorPicker .color-option').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedLibraryColor = button.dataset.color;
        }
        
        function confirmEditLibrary() {
            const id = document.getElementById('editLibraryId').value;
            const name = document.getElementById('editLibraryName').value.trim();
            const description = document.getElementById('editLibraryDescription').value.trim();
            
            if (!name) {
                showToast('Please enter a library name', 'error');
                return;
            }
            
            librariesManager.updateLibrary(id, {
                name: name,
                description: description,
                icon: selectedLibraryIcon,
                color: selectedLibraryColor
            });
            
            closeEditLibraryModal();
        }
        
        function confirmDeleteLibrary(libraryId) {
            event.stopPropagation();
            const library = librariesData.libraries.find(lib => lib.id === libraryId);
            if (!library) return;
            
            showDeleteModal(
                'Delete Library',
                'This will permanently delete the library and all its artifacts.',
                library.name,
                () => {
                    librariesManager.deleteLibrary(libraryId);
                }
            );
        }
        
        function createNewLibrary(event) {
            if (event) {
                event.stopPropagation();
            }
            openCreateLibraryModal();
        }
        
        // Drag and Drop Functions
        let draggedArtifactId = null;
        let draggedFromLibraryId = null;
        let draggedLibraryId = null;
        
        function handleArtifactDragStart(event, artifactId, libraryId) {
            event.stopPropagation();
            draggedArtifactId = artifactId;
            draggedFromLibraryId = libraryId;
            draggedLibraryId = null;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.5';
        }
        
        function handleLibraryDragStart(event, libraryId) {
            event.stopPropagation();
            draggedLibraryId = libraryId;
            draggedArtifactId = null;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleLibraryDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Only allow drop if dragging an artifact
            if (draggedArtifactId) {
                event.dataTransfer.dropEffect = 'move';
                const header = event.currentTarget;
                header.classList.add('drag-over');
            }
        }
        
        function handleLibraryDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // Remove visual feedback when leaving
            const header = event.currentTarget;
            header.classList.remove('drag-over');
        }
        
        function handleLibraryDrop(event, toLibraryId) {
            event.preventDefault();
            event.stopPropagation();
            
            const header = event.currentTarget;
            header.classList.remove('drag-over');
            
            if (draggedArtifactId && draggedFromLibraryId) {
                // Move artifact to new library
                librariesManager.moveArtifact(draggedArtifactId, draggedFromLibraryId, toLibraryId);
            }
            
            // Reset
            draggedArtifactId = null;
            draggedFromLibraryId = null;
        }
        
        // Context Menu Functions
        function showLibraryContextMenu(event, libraryId) {
            event.preventDefault();
            event.stopPropagation();
            
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            const menu = document.getElementById('libraryContextMenu');
            menu.innerHTML = `
                <div class="context-menu-item" onclick="renameLibrary('${libraryId}')">
                    <i class="fas fa-edit"></i>
                    <span>Rename Library</span>
                </div>
                <div class="context-menu-item" onclick="changeLibraryColor('${libraryId}')">
                    <i class="fas fa-palette"></i>
                    <span>Change Color</span>
                </div>
                <div class="context-menu-item" onclick="changeLibraryIcon('${libraryId}')">
                    <i class="fas fa-icons"></i>
                    <span>Change Icon</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="duplicateLibrary('${libraryId}')">
                    <i class="fas fa-copy"></i>
                    <span>Duplicate Library</span>
                </div>
                <div class="context-menu-item" onclick="exportLibrary('${libraryId}')">
                    <i class="fas fa-download"></i>
                    <span>Export Library</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="deleteLibrary('${libraryId}')">
                    <i class="fas fa-trash"></i>
                    <span>Delete Library</span>
                </div>
            `;
            
            showContextMenu(menu, event);
        }
        
        function showArtifactContextMenu(event, artifactId, libraryId) {
            event.preventDefault();
            event.stopPropagation();
            
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            const menu = document.getElementById('libraryContextMenu');
            menu.innerHTML = `
                <div class="context-menu-item" onclick="openArtifactFromLibrary('${artifactId}')">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Open Artifact</span>
                </div>
                <div class="context-menu-item" onclick="editArtifact('${artifactId}')">
                    <i class="fas fa-edit"></i>
                    <span>Edit Artifact</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="duplicateArtifact('${artifactId}', '${libraryId}')">
                    <i class="fas fa-copy"></i>
                    <span>Duplicate</span>
                </div>
                <div class="context-menu-item" onclick="moveArtifactToLibrary('${artifactId}', '${libraryId}')">
                    <i class="fas fa-arrow-right"></i>
                    <span>Move to...</span>
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="exportArtifact('${artifactId}')">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </div>
                <div class="context-menu-item" onclick="removeArtifactFromLibrary('${artifactId}', '${libraryId}')">
                    <i class="fas fa-times"></i>
                    <span>Remove from Library</span>
                </div>
            `;
            
            showContextMenu(menu, event);
        }
        
        function showContextMenu(menu, event) {
            // Hide any existing context menus
            hideContextMenu();
            
            // Position and show the menu
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');
            
            // Add click outside listener
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu);
            }, 0);
        }
        
        function hideContextMenu() {
            const menu = document.getElementById('libraryContextMenu');
            if (menu) {
                menu.classList.remove('show');
            }
            document.removeEventListener('click', hideContextMenu);
        }
        
        // Context Menu Actions
        function renameLibrary(libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            const newName = prompt('Enter new library name:', library.name);
            if (newName && newName.trim()) {
                library.name = newName.trim();
                saveLibrariesData();
                updateLibrariesView();
                showToast(`Library renamed to "${newName}"`);
            }
        }
        
        function changeLibraryColor(libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            // Simple color picker using prompt for now
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const colorOptions = colors.map((c, i) => `${i + 1}. ${c}`).join('\n');
            const choice = prompt(`Choose a color:\n${colorOptions}\n\nEnter number (1-${colors.length}):`);
            
            if (choice && colors[parseInt(choice) - 1]) {
                library.color = colors[parseInt(choice) - 1];
                saveLibrariesData();
                updateLibrariesView();
                showToast('Library color updated');
            }
        }
        
        function changeLibraryIcon(libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            const icons = ['fa-folder', 'fa-star', 'fa-bookmark', 'fa-archive', 'fa-briefcase', 'fa-box'];
            const iconOptions = icons.map((icon, i) => `${i + 1}. ${icon.replace('fa-', '')}`).join('\n');
            const choice = prompt(`Choose an icon:\n${iconOptions}\n\nEnter number (1-${icons.length}):`);
            
            if (choice && icons[parseInt(choice) - 1]) {
                library.icon = icons[parseInt(choice) - 1];
                saveLibrariesData();
                updateLibrariesView();
                showToast('Library icon updated');
            }
        }
        
        function duplicateLibrary(libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            const newLibrary = {
                ...library,
                id: generateId(),
                name: library.name + ' (Copy)',
                artifactIds: [...library.artifactIds]
            };
            
            librariesData.libraries.push(newLibrary);
            saveLibrariesData();
            updateLibrariesView();
            showToast(`Library "${newLibrary.name}" created`);
        }
        
        function exportLibrary(libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            const artifacts = library.artifactIds.map(id => librariesData.artifacts[id]).filter(Boolean);
            const exportData = {
                library: library,
                artifacts: artifacts
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${library.name.replace(/[^a-z0-9]/gi, '_')}_library.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Library "${library.name}" exported`);
        }
        
        function deleteLibrary(libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            if (confirm(`Are you sure you want to delete the library "${library.name}"? The artifacts will remain in your collection.`)) {
                librariesData.libraries = librariesData.libraries.filter(l => l.id !== libraryId);
                saveLibrariesData();
                updateLibrariesView();
                showToast(`Library "${library.name}" deleted`);
            }
        }
        
        function editArtifact(artifactId) {
            hideContextMenu();
            openArtifactFromLibrary(artifactId);
        }
        
        function editArtifactName(artifactId, libraryId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            const newName = prompt('Enter new name for artifact:', artifact.name);
            if (newName && newName.trim() && newName.trim() !== artifact.name) {
                artifact.name = newName.trim();
                saveLibrariesData();
                
                // Re-render the current library view
                renderSingleLibraryView(libraryId);
                showToast(`Artifact renamed to "${newName}"`);
            }
        }
        
        function duplicateArtifact(artifactId, libraryId) {
            hideContextMenu();
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            const newArtifact = {
                ...artifact,
                id: generateId(),
                name: artifact.name + ' (Copy)'
            };
            
            librariesData.artifacts[newArtifact.id] = newArtifact;
            
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (library) {
                library.artifactIds.push(newArtifact.id);
            }
            
            saveLibrariesData();
            updateLibrariesView();
            showToast(`Artifact "${newArtifact.name}" duplicated`);
        }
        
        function moveArtifactToLibrary(artifactId, fromLibraryId) {
            hideContextMenu();
            
            const libraries = librariesData.libraries.filter(l => l.id !== fromLibraryId);
            if (libraries.length === 0) {
                showToast('No other libraries available');
                return;
            }
            
            const libraryOptions = libraries.map((l, i) => `${i + 1}. ${l.name}`).join('\n');
            const choice = prompt(`Move to library:\n${libraryOptions}\n\nEnter number (1-${libraries.length}):`);
            
            if (choice && libraries[parseInt(choice) - 1]) {
                const toLibrary = libraries[parseInt(choice) - 1];
                librariesManager.moveArtifact(artifactId, fromLibraryId, toLibrary.id);
                showToast(`Artifact moved to "${toLibrary.name}"`);
            }
        }
        
        function exportArtifact(artifactId) {
            hideContextMenu();
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            const blob = new Blob([JSON.stringify(artifact, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${artifact.name.replace(/[^a-z0-9]/gi, '_')}_artifact.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Artifact "${artifact.name}" exported`);
        }
        
        function removeArtifactFromLibrary(artifactId, libraryId) {
            hideContextMenu();
            const library = librariesData.libraries.find(l => l.id === libraryId);
            const artifact = librariesData.artifacts[artifactId];
            
            if (!library || !artifact) return;
            
            if (confirm(`Remove "${artifact.name}" from "${library.name}"?`)) {
                library.artifactIds = library.artifactIds.filter(id => id !== artifactId);
                saveLibrariesData();
                updateLibrariesView();
                showToast(`Artifact removed from "${library.name}"`);
            }
        }
        
        // Breadcrumb Navigation
        let currentLibraryPath = [];
        
        function updateBreadcrumb(path = []) {
            currentLibraryPath = path;
            const breadcrumbPath = document.getElementById('breadcrumbPath');
            if (!breadcrumbPath) return;
            
            if (path.length === 0) {
                breadcrumbPath.innerHTML = '';
                return;
            }
            
            const pathHTML = path.map((item, index) => {
                const isLast = index === path.length - 1;
                const separator = '<span class="breadcrumb-separator"> / </span>';
                
                if (isLast) {
                    return `${separator}<span class="breadcrumb-current">${item.name}</span>`;
                } else {
                    return `${separator}<a class="breadcrumb-link" onclick="navigateToLibrary('${item.id}')" style="cursor: pointer; text-decoration: none;">${item.name}</a>`;
                }
            }).join('');
            
            breadcrumbPath.innerHTML = pathHTML;
        }
        
        function navigateToLibraryHome() {
            // Reset to show all libraries
            updateBreadcrumb([]);
            const folders = document.querySelectorAll('.library-folder');
            folders.forEach(folder => {
                folder.style.display = 'block';
            });
            
            // Clear any filters
            const searchInput = document.getElementById('librarySearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
        }
        
        function navigateToLibrary(libraryId) {
            const library = librariesData.libraries.find(l => l.id === libraryId);
            if (!library) return;
            
            // Update breadcrumb to show just this library
            updateBreadcrumb([{ id: library.id, name: library.name }]);
            
            // Show only this library's folder and expand it
            const folders = document.querySelectorAll('.library-folder');
            folders.forEach(folder => {
                const folderName = folder.querySelector('.library-folder-name');
                if (folderName && folderName.textContent === library.name) {
                    folder.style.display = 'block';
                    // Expand the folder
                    const header = folder.querySelector('.library-folder-header');
                    if (header && !header.classList.contains('expanded')) {
                        toggleLibraryFolder(header);
                    }
                } else {
                    folder.style.display = 'none';
                }
            });
        }
        
        function openArtifactFromLibrary(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // Get the libraries content container
            const librariesContent = document.getElementById('librariesContent');
            if (!librariesContent) return;
            
            // Store current artifact and tab for this view
            window.currentLibraryArtifact = {
                id: artifactId,
                currentTab: 'preview'
            };
            
            // Create full-width artifact view with tabs
            librariesContent.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column; background: white;">
                    <!-- Artifact Header -->
                    <div class="artifact-panel-header" style="padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background: var(--gray-600);">
                        <div class="artifact-panel-title" style="display: flex; align-items: center; gap: 12px;">
                            <button onclick="backToLibraryView()" style="padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; color: var(--text-primary);">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                            <i class="fas fa-file-alt"></i>
                            <div>
                                <span style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${artifact.name}</span>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 2px;">
                                    <span style="background: var(--mj-blue); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${artifact.type || 'document'}</span>
                                    ${artifact.version ? `<span style="color: var(--text-secondary); font-size: 11px;">v${artifact.version}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="artifact-panel-actions" style="display: flex; gap: 8px;">
                            <button class="artifact-share-button" onclick="shareLibraryArtifact('${artifactId}')" title="Share" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); cursor: pointer;">
                                <i class="fas fa-share"></i>
                                <span>Share</span>
                            </button>
                            <button class="artifact-panel-action" onclick="copyLibraryArtifactContent('${artifactId}')" title="Copy" style="width: 32px; height: 32px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="artifact-panel-action" onclick="downloadLibraryArtifact('${artifactId}')" title="Download" style="width: 32px; height: 32px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="artifact-panel-action" onclick="maximizeLibraryArtifact('${artifactId}')" title="Maximize" style="width: 32px; height: 32px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Artifact Tabs -->
                    <div class="artifact-panel-tabs" style="display: flex; background: var(--surface); border-bottom: 1px solid var(--border-color); padding: 0 24px;">
                        <button class="artifact-panel-tab active" onclick="switchLibraryArtifactTab('preview', '${artifactId}')" style="padding: 12px 20px; background: transparent; border: none; border-bottom: 2px solid var(--mj-blue); color: var(--text-primary); font-weight: 500; cursor: pointer;">Preview</button>
                        <button class="artifact-panel-tab" onclick="switchLibraryArtifactTab('source', '${artifactId}')" style="padding: 12px 20px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary); font-weight: 500; cursor: pointer;">Source</button>
                        <button class="artifact-panel-tab" onclick="switchLibraryArtifactTab('history', '${artifactId}')" style="padding: 12px 20px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary); font-weight: 500; cursor: pointer;">History</button>
                    </div>
                    
                    <!-- Artifact Content -->
                    <div class="artifact-panel-content" id="libraryArtifactContent" style="flex: 1; overflow: auto; padding: 24px;">
                        ${renderLibraryArtifactTabContent('preview', artifact)}
                    </div>
                </div>
            `;
            
            // Store current library for back navigation
            window.currentLibraryId = artifact.libraries ? artifact.libraries[0] : null;
        }
        
        function renderLibraryArtifactTabContent(tab, artifact) {
            if (tab === 'preview') {
                return `
                    <div style="width: 100%;">
                        ${artifact.type === 'code' ? `
                            <pre style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px; line-height: 1.5;"><code>${escapeHtml(artifact.content || artifact.preview || generateArtifactContent(artifact))}</code></pre>
                        ` : `
                            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                                ${artifact.content || artifact.preview || generateArtifactContent(artifact)}
                            </div>
                        `}
                    </div>
                `;
            } else if (tab === 'source') {
                const sourceCode = artifact.content || artifact.preview || generateArtifactContent(artifact);
                return `
                    <div style="width: 100%;">
                        <div style="background: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Source Code</h3>
                                <button onclick="copyLibraryArtifactSource('${artifact.id}')" style="margin-left: auto; padding: 4px 8px; background: var(--mj-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-copy"></i> Copy Source
                                </button>
                            </div>
                            <pre style="background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 4px; overflow-x: auto; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; line-height: 1.5; margin: 0;"><code>${escapeHtml(sourceCode)}</code></pre>
                        </div>
                    </div>
                `;
            } else if (tab === 'history') {
                return `
                    <div style="width: 100%;">
                        <div style="background: var(--surface); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
                            <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 14px; font-weight: 600;">Version History</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${artifact.history && artifact.history.length > 0 ? artifact.history.map((version, index) => `
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border: 1px solid var(--border-color); border-radius: 6px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: var(--text-primary); font-size: 13px;">Version ${version.version || index + 1}</div>
                                            <div style="color: var(--text-secondary); font-size: 12px; margin-top: 2px;">${version.date || new Date().toLocaleDateString()}</div>
                                        </div>
                                        <button onclick="restoreLibraryArtifactVersion('${artifact.id}', ${index})" style="padding: 4px 12px; background: transparent; border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px; cursor: pointer;">
                                            Restore
                                        </button>
                                    </div>
                                `).join('') : `
                                    <div style="text-align: center; padding: 32px; color: var(--text-secondary);">
                                        <i class="fas fa-history" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                                        <p>No version history available</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function switchLibraryArtifactTab(tab, artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // Update active tab styling
            document.querySelectorAll('.artifact-panel-tab').forEach(tabBtn => {
                tabBtn.classList.remove('active');
                tabBtn.style.borderBottomColor = 'transparent';
                tabBtn.style.color = 'var(--text-secondary)';
            });
            
            event.target.classList.add('active');
            event.target.style.borderBottomColor = 'var(--mj-blue)';
            event.target.style.color = 'var(--text-primary)';
            
            // Update content
            const contentDiv = document.getElementById('libraryArtifactContent');
            if (contentDiv) {
                contentDiv.innerHTML = renderLibraryArtifactTabContent(tab, artifact);
            }
            
            // Store current tab
            if (window.currentLibraryArtifact) {
                window.currentLibraryArtifact.currentTab = tab;
            }
        }
        
        function copyLibraryArtifactContent(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            const content = artifact.content || artifact.preview || '';
            navigator.clipboard.writeText(content).then(() => {
                showToast('Artifact content copied to clipboard');
            });
        }
        
        function copyLibraryArtifactSource(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            const source = artifact.content || artifact.preview || '';
            navigator.clipboard.writeText(source).then(() => {
                showToast('Source code copied to clipboard');
            });
        }
        
        function downloadLibraryArtifact(artifactId) {
            exportArtifact(artifactId);
        }
        
        function shareLibraryArtifact(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // For now, copy a shareable link
            const shareableLink = `${window.location.origin}/artifact/${artifactId}`;
            navigator.clipboard.writeText(shareableLink).then(() => {
                showToast('Shareable link copied to clipboard');
            });
        }
        
        function maximizeLibraryArtifact(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // Create fullscreen overlay
            const overlay = document.createElement('div');
            overlay.id = 'artifactFullscreen';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 10000;
                display: flex;
                flex-direction: column;
            `;
            
            overlay.innerHTML = `
                <div style="padding: 16px 24px; background: var(--surface); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: var(--text-primary);">${artifact.name}</h2>
                    <button onclick="document.getElementById('artifactFullscreen').remove()" style="padding: 8px 16px; background: var(--mj-blue); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-compress"></i> Exit Fullscreen
                    </button>
                </div>
                <div style="flex: 1; overflow: auto; padding: 32px;">
                    ${artifact.type === 'code' ? `
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 24px; border-radius: 8px; font-family: 'Monaco', 'Menlo', monospace; font-size: 14px; line-height: 1.6;"><code>${escapeHtml(artifact.content || artifact.preview || '')}</code></pre>
                    ` : `
                        <div style="background: white; padding: 32px;">
                            ${artifact.content || artifact.preview || ''}
                        </div>
                    `}
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function restoreLibraryArtifactVersion(artifactId, versionIndex) {
            showToast('Version restore feature coming soon');
        }
        
        function backToLibraryView() {
            // Go back to the library view
            if (window.currentLibraryId) {
                selectLibrary(window.currentLibraryId);
            } else {
                showLibrariesLandingPage();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function exportArtifact(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // Create a blob with the artifact content
            const content = artifact.content || artifact.preview || '';
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const a = document.createElement('a');
            a.href = url;
            a.download = `${artifact.name.replace(/[^a-z0-9]/gi, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Exported "${artifact.name}"`);
        }
        
        function generateArtifactContent(artifact) {
            // Generate sample content based on artifact type
            if (artifact.type === 'code') {
                return `// ${artifact.name}
import React, { useState, useEffect } from 'react';

const Component = () => {
    const [data, setData] = useState(null);
    
    useEffect(() => {
        // Fetch data or perform initialization
        fetchData();
    }, []);
    
    const fetchData = async () => {
        try {
            const response = await fetch('/api/data');
            const result = await response.json();
            setData(result);
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    };
    
    return (
        <div className="component">
            <h2>${artifact.name}</h2>
            {data ? (
                <div>{JSON.stringify(data, null, 2)}</div>
            ) : (
                <p>Loading...</p>
            )}
        </div>
    );
};

export default Component;`;
            } else if (artifact.type === 'markdown' || artifact.type === 'documentation') {
                return `# ${artifact.name}

## Overview
This document provides comprehensive information about ${artifact.name}.

## Key Features
- Feature 1: Description of the first feature
- Feature 2: Description of the second feature
- Feature 3: Description of the third feature

## Implementation Details
The implementation follows best practices and modern patterns...

## API Reference
### Methods
- \`method1()\`: Description of method 1
- \`method2()\`: Description of method 2

## Examples
\`\`\`javascript
// Example usage
const example = new Example();
example.init();
\`\`\`

## Conclusion
This artifact was generated from the libraries system.`;
            } else if (artifact.type === 'data') {
                return JSON.stringify({
                    name: artifact.name,
                    type: artifact.type,
                    data: {
                        metrics: {
                            users: 12500,
                            sessions: 45000,
                            pageViews: 125000
                        },
                        performance: {
                            avgLoadTime: 1.2,
                            errorRate: 0.02,
                            uptime: 99.95
                        }
                    },
                    generated: new Date().toISOString()
                }, null, 2);
            } else {
                return `Content for ${artifact.name}\n\nType: ${artifact.type}\n\nThis is a placeholder for the artifact content.`;
            }
        }
        
        function showArtifactMenu(event, artifactId) {
            event.stopPropagation();
            
            // Remove any existing menus
            document.querySelectorAll('.artifact-menu').forEach(menu => menu.remove());
            
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // Create menu
            const menu = document.createElement('div');
            menu.className = 'chat-menu-dropdown artifact-menu show';
            menu.style.position = 'fixed';
            
            const rect = event.currentTarget.getBoundingClientRect();
            menu.style.left = (rect.left - 140) + 'px';
            menu.style.top = (rect.bottom + 4) + 'px';
            menu.style.zIndex = '10000';
            
            menu.innerHTML = `
                <div class="chat-menu-item" onclick="moveArtifact('${artifactId}')">
                    <i class="fas fa-folder-open"></i>
                    <span>Move to Library</span>
                </div>
                <div class="chat-menu-item" onclick="shareArtifact('${artifactId}')">
                    <i class="fas fa-share"></i>
                    <span>Share</span>
                </div>
                <div class="chat-menu-item" onclick="exportArtifact('${artifactId}')">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </div>
                <div class="chat-menu-divider"></div>
                <div class="chat-menu-item danger" onclick="deleteArtifact('${artifactId}')">
                    <i class="fas fa-trash"></i>
                    <span>Remove from Library</span>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }
        
        function moveArtifact(artifactId) {
            const artifact = librariesData.artifacts[artifactId];
            if (!artifact) return;
            
            // For now, just show the save to library modal
            currentArtifactToSave = artifact;
            document.getElementById('artifactPreviewName').textContent = artifact.name;
            document.getElementById('saveToLibraryModal').style.display = 'flex';
        }
        
        // Legacy functions for compatibility
        function startDrag(event) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
            event.target.classList.add('dragging');
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }
        
        function dropArtifact(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            showToast('Artifact moved to library!', 'success');
            // In real implementation, would handle the drop
        }
        
        // Thread Panel Functions
        function closeThreadPanel() {
            document.getElementById('threadPanel').classList.remove('open');
        }
        
        function openThreadPanel(messageId) {
            const panel = document.getElementById('threadPanel');
            panel.classList.add('open');
            // Load thread messages
            loadThreadMessages(messageId);
            
            // Mark all replies as seen when opening the thread
            if (threadReplies[messageId]) {
                threadReplies[messageId].forEach(reply => reply.seen = true);
                updateThreadPreview(messageId);
            }
        }
        
        function loadThreadMessages(messageId) {
            // In real implementation, would load actual thread messages
            const threadMessages = document.getElementById('threadMessages');
            threadMessages.innerHTML = '<div class="message">Loading thread...</div>';
        }
        
        // Notification Functions
        function markAllRead() {
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            unreadItems.forEach(item => item.classList.remove('unread'));
            showToast('All notifications marked as read', 'success');
        }
        
        function toggleNotificationCenter() {
            const center = document.getElementById('notificationCenter');
            center.classList.toggle('open');
        }
        
        function addNotification(title, desc, type = 'info') {
            const notificationList = document.getElementById('notificationList');
            const notification = document.createElement('div');
            notification.className = 'notification-item unread';
            notification.innerHTML = `
                <div class="notification-icon" style="background: var(--mj-blue);">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-desc">${desc}</div>
                </div>
                <div class="notification-time">Just now</div>
            `;
            notificationList.insertBefore(notification, notificationList.firstChild);
            
            // Show badge on notification icon
            updateNotificationBadge();
        }
        
        function updateNotificationBadge() {
            const unreadCount = document.querySelectorAll('.notification-item.unread').length;
            // Update badge count in UI
            console.log(`${unreadCount} unread notifications`);
        }
        
        // Open Thread Panel
        function openThreadPanel(messageId) {
            const panel = document.getElementById('threadPanel');
            panel.classList.add('open');
            // Load thread messages here
            loadThreadMessages(messageId);
        }
        
        // Close Thread Panel  
        function closeThreadPanel() {
            const panel = document.getElementById('threadPanel');
            panel.classList.remove('open');
        }
        
        // Load Thread Messages
        function loadThreadMessages(messageId) {
            const originalMessage = document.getElementById(messageId);
            const threadMessages = document.getElementById('threadMessages');
            
            if (!originalMessage || !threadMessages) return;
            
            // Get original message content
            const messageText = originalMessage.querySelector('.message-text')?.textContent || '';
            const messageSender = originalMessage.querySelector('.message-sender')?.textContent || '';
            const messageTime = originalMessage.querySelector('.message-time')?.textContent || '';
            const isAI = originalMessage.classList.contains('ai-message');
            
            const replies = getThreadReplies(messageId);
            
            threadMessages.innerHTML = `
                <div class="thread-original-message" style="border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 15px;">
                    <div class="message ${isAI ? 'ai-message' : 'human-message'}" style="padding: 0;">
                        <div class="message-avatar ${isAI ? 'ai-avatar agent-message-avatar' : 'human-avatar user-avatar'}" 
                             ${isAI ? `style="background-color: var(--agent-claude);"` : ''}>
                            ${isAI ? 'C' : messageSender.charAt(0).toUpperCase()}
                            ${isAI ? '<span class="ai-indicator">AI</span>' : ''}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${messageSender}</span>
                                <span class="message-time">${messageTime}</span>
                            </div>
                            <div class="message-text">${messageText}</div>
                        </div>
                    </div>
                </div>
                ${replies.length > 0 ? `
                    <div style="padding: 10px; background: #f5f5f5; margin: 10px 0; border-radius: 4px; font-size: 12px; color: #666;">
                        ${replies.length} ${replies.length === 1 ? 'reply' : 'replies'} in thread
                    </div>
                ` : '<div style="padding: 10px; color: #666; font-size: 13px;">No replies yet. Start the conversation!</div>'}
                <div class="thread-replies" id="thread-replies-${messageId}">
                    ${replies.map(reply => `
                        <div class="message ${reply.isAI ? 'ai-message' : 'human-message'}" style="padding-left: 20px; margin-bottom: 10px;">
                            <div class="message-avatar ${reply.isAI ? 'ai-avatar agent-message-avatar' : 'human-avatar user-avatar'}" 
                                 style="width: 28px; height: 28px; font-size: 11px; ${reply.isAI ? `background-color: ${reply.color || 'var(--agent-claude)'};` : ''}">
                                ${reply.avatar}
                                ${reply.isAI ? '<span class="ai-indicator" style="font-size: 8px;">AI</span>' : ''}
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">${reply.sender}</span>
                                    <span class="message-time">${formatTime(reply.timestamp)}</span>
                                </div>
                                <div class="message-text">${reply.text}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Set up the reply box handler
            const replyBox = document.querySelector('.thread-reply-box textarea');
            const sendButton = document.querySelector('.thread-reply-box .send-btn');
            
            if (replyBox && sendButton) {
                // Clear any existing handlers
                sendButton.onclick = null;
                replyBox.onkeydown = null;
                
                // Add new handlers
                sendButton.onclick = () => sendThreadReply(messageId);
                replyBox.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendThreadReply(messageId);
                    }
                };
            }
        }
        
        // Enhanced showToast function
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            toast.innerHTML = `
                <div class="toast-icon" style="background: ${colors[type]}; color: white;">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        // Add slideOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideOut {
                to {
                    transform: translateX(120%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Create Project Modal -->
    <div class="modal-overlay" id="createProjectModal">
        <div class="modal" style="width: 400px; position: relative;">
            <button class="modal-close" onclick="closeCreateProjectModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-folder-plus" style="margin-right: 8px;"></i>
                    Create New Project
                </h3>
            </div>
            <div class="modal-body">
                <label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">
                    Project Name
                </label>
                <input type="text" class="modal-input" id="newProjectName" placeholder="e.g., Q1 Planning, Customer Portal, Data Migration">
                
                <label style="display: block; margin: 16px 0 8px; font-size: 13px; color: var(--text-secondary);">
                    Project Color
                </label>
                <div style="display: flex; gap: 10px;">
                    <button class="color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #4A90E2; border: 2px solid transparent;" data-color="#4A90E2" onclick="selectProjectColor(this)"></button>
                    <button class="color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #7ED321; border: 2px solid transparent;" data-color="#7ED321" onclick="selectProjectColor(this)"></button>
                    <button class="color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #BD10E0; border: 2px solid transparent;" data-color="#BD10E0" onclick="selectProjectColor(this)"></button>
                    <button class="color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #F5A623; border: 2px solid transparent;" data-color="#F5A623" onclick="selectProjectColor(this)"></button>
                    <button class="color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #FF6B6B; border: 2px solid transparent;" data-color="#FF6B6B" onclick="selectProjectColor(this)"></button>
                    <button class="color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #4ECDC4; border: 2px solid transparent;" data-color="#4ECDC4" onclick="selectProjectColor(this)"></button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeCreateProjectModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmCreateProject()">Create Project</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Project Modal -->
    <div class="modal-overlay" id="editProjectModal">
        <div class="modal" style="width: 400px; position: relative;">
            <button class="modal-close" onclick="closeEditProjectModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit" style="margin-right: 8px;"></i>
                    Edit Project
                </h3>
            </div>
            <div class="modal-body">
                <label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">
                    Project Name
                </label>
                <input type="text" class="modal-input" id="editProjectName" placeholder="Enter project name">
                
                <label style="display: block; margin: 16px 0 8px; font-size: 13px; color: var(--text-secondary);">
                    Project Color
                </label>
                <div style="display: flex; gap: 10px;">
                    <button class="edit-color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #4A90E2; border: 2px solid transparent;" data-color="#4A90E2" onclick="selectEditProjectColor(this)"></button>
                    <button class="edit-color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #7ED321; border: 2px solid transparent;" data-color="#7ED321" onclick="selectEditProjectColor(this)"></button>
                    <button class="edit-color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #BD10E0; border: 2px solid transparent;" data-color="#BD10E0" onclick="selectEditProjectColor(this)"></button>
                    <button class="edit-color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #F5A623; border: 2px solid transparent;" data-color="#F5A623" onclick="selectEditProjectColor(this)"></button>
                    <button class="edit-color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #FF6B6B; border: 2px solid transparent;" data-color="#FF6B6B" onclick="selectEditProjectColor(this)"></button>
                    <button class="edit-color-option" style="width: 32px; height: 32px; border-radius: 6px; background: #4ECDC4; border: 2px solid transparent;" data-color="#4ECDC4" onclick="selectEditProjectColor(this)"></button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeEditProjectModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmEditProject()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Project Modal -->
    <div class="modal-overlay" id="deleteProjectModal">
        <div class="modal" style="width: 400px; position: relative;">
            <button class="modal-close" onclick="closeDeleteProjectModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-trash" style="margin-right: 8px; color: var(--danger-color);"></i>
                    Delete Project
                </h3>
            </div>
            <div class="modal-body">
                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                    <strong style="color: #856404;"> Warning:</strong>
                    <p style="margin: 8px 0 0; color: #856404; font-size: 13px;">
                        Deleting this project will remove it from all associated chats. The chats themselves will not be deleted.
                    </p>
                </div>
                <p style="font-size: 14px;">
                    Are you sure you want to delete <strong id="deleteProjectName"></strong>?
                </p>
                <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                    This project is associated with <span id="deleteProjectChatCount">0</span> chat(s).
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeDeleteProjectModal()">Cancel</button>
                <button class="modal-btn danger" onclick="confirmDeleteProject()">Delete Project</button>
            </div>
        </div>
    </div>
    
    <!-- Libraries Modal -->
    <div class="modal-overlay" id="librariesModal">
        <div class="modal" style="width: 900px; max-width: 90vw; height: 80vh; max-height: 600px; position: relative; display: flex; flex-direction: column;">
            <button class="modal-close" onclick="closeLibrariesModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header" style="flex-shrink: 0;">
                <h3 class="modal-title">
                    <i class="fas fa-folder-open"></i>
                    Libraries
                </h3>
            </div>
            <div class="modal-body" style="padding: 0; flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">
                <!-- Libraries Toolbar -->
                <div class="libraries-toolbar" style="padding: 16px 20px; border-bottom: 1px solid #e5e5e5; display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                    <button class="btn-primary" onclick="openCreateLibraryModal()" style="padding: 8px 16px; background: var(--mj-blue); color: white; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-plus"></i>
                        New Library
                    </button>
                    <div class="libraries-search" style="flex: 1; max-width: 300px;">
                        <input type="text" placeholder="Search libraries..." style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" onkeyup="searchLibraries(event)">
                    </div>
                    <div class="view-toggle" style="margin-left: auto; display: flex; gap: 4px;">
                        <button class="view-btn active" onclick="setLibraryView('grid')" title="Grid view" style="padding: 6px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px 0 0 4px; cursor: pointer;">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-btn" onclick="setLibraryView('list')" title="List view" style="padding: 6px 10px; background: white; border: 1px solid #ddd; border-radius: 0 4px 4px 0; cursor: pointer;">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Libraries Container -->
                <div class="libraries-container" style="flex: 1; overflow-y: auto; padding: 20px; min-height: 0;">
                    <div class="libraries-grid" id="librariesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
                        <!-- Library cards will be dynamically rendered here -->
                    </div>
                    <div class="libraries-list" id="librariesList" style="display: none;">
                        <!-- Library list items will be dynamically rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save to Library Modal -->
    <div class="modal-overlay" id="saveToLibraryModal">
        <div class="modal" style="width: 400px; position: relative;">
            <button class="modal-close" onclick="closeSaveToLibraryModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-folder-plus"></i>
                    Save to Library
                </h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="librarySelect">Select Library</label>
                    <select id="librarySelect" class="form-input">
                        <option value="">Select a library...</option>
                    </select>
                </div>
                <div class="artifact-preview-info" style="margin-top: 16px; padding: 12px; background: #f4f4f4; border-radius: 6px;">
                    <small style="color: #666; display: block; margin-bottom: 4px;">Artifact to save:</small>
                    <div id="artifactPreviewName" style="font-weight: 600; color: #333;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeSaveToLibraryModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmSaveToLibrary()">Save to Library</button>
            </div>
        </div>
    </div>
    
    <!-- Create Library Modal -->
    <div class="modal-overlay" id="createLibraryModal">
        <div class="modal" style="width: 450px; position: relative;">
            <button class="modal-close" onclick="closeCreateLibraryModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-folder-plus"></i>
                    Create New Library
                </h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="libraryName">Library Name</label>
                    <input type="text" id="libraryName" class="form-input" placeholder="Enter library name">
                </div>
                <div class="form-group">
                    <label for="libraryDescription">Description</label>
                    <textarea id="libraryDescription" class="form-input" rows="2" placeholder="Brief description of this library"></textarea>
                </div>
                <div class="form-group">
                    <label>Icon</label>
                    <div class="icon-picker">
                        <button class="icon-option selected" data-icon="fa-folder" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-folder"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-book" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-book"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-code" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-code"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-chart-bar" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-database" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-database"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-file-alt" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-image" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="icon-option" data-icon="fa-cog" onclick="selectLibraryIcon(this)">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <button class="color-option selected" data-color="#6b7280" style="background: #6b7280" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#3b82f6" style="background: #3b82f6" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#10b981" style="background: #10b981" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#8b5cf6" style="background: #8b5cf6" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#f59e0b" style="background: #f59e0b" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#ef4444" style="background: #ef4444" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#ec4899" style="background: #ec4899" onclick="selectLibraryColor(this)"></button>
                        <button class="color-option" data-color="#14b8a6" style="background: #14b8a6" onclick="selectLibraryColor(this)"></button>
                    </div>
                </div>
                <div class="form-group" id="parentLibraryGroup" style="display: none;">
                    <label for="parentLibrary">Parent Library</label>
                    <select id="parentLibrary" class="form-input">
                        <option value="">None (Root Level)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCreateLibraryModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmCreateLibrary()">
                    <i class="fas fa-plus"></i> Create Library
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Library Modal -->
    <div class="modal-overlay" id="editLibraryModal">
        <div class="modal" style="width: 450px; position: relative;">
            <button class="modal-close" onclick="closeEditLibraryModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: transparent; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Edit Library
                </h3>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLibraryId">
                <div class="form-group">
                    <label for="editLibraryName">Library Name</label>
                    <input type="text" id="editLibraryName" class="form-input" placeholder="Enter library name">
                </div>
                <div class="form-group">
                    <label for="editLibraryDescription">Description</label>
                    <textarea id="editLibraryDescription" class="form-input" rows="2" placeholder="Brief description of this library"></textarea>
                </div>
                <div class="form-group">
                    <label>Icon</label>
                    <div class="icon-picker" id="editIconPicker">
                        <!-- Icons will be populated dynamically -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker" id="editColorPicker">
                        <!-- Colors will be populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeEditLibraryModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmEditLibrary()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Add to Project Modal -->
    <div class="modal-overlay" id="addToProjectModal">
        <div class="modal" style="width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-folder" style="margin-right: 8px;"></i>
                    Add to Project
                </h3>
            </div>
            <div class="modal-body">
                <label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">
                    Select a project for: <strong id="chatToAddName">Chat Name</strong>
                </label>
                
                <div id="projectsModalList" style="max-height: 300px; overflow-y: auto;">
                    <!-- Projects will be populated dynamically -->
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <button class="modal-btn" style="width: 100%; background: var(--gray-600);" onclick="createProjectFromSelector()">
                        <i class="fas fa-plus"></i> Create New Project
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeAddToProjectModal()">Cancel</button>
                <button class="modal-btn danger" onclick="removeFromCurrentProject()" style="margin-right: auto;">Remove from Project</button>
                <button class="modal-btn primary" onclick="confirmAddToProject()" id="confirmAddBtn">Add to Project</button>
            </div>
        </div>
    </div>

    <!-- Universal Delete Confirmation Modal -->
    <div class="modal-overlay" id="universalDeleteModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="deleteModalTitle">Confirm Delete</h3>
                <button class="modal-close" onclick="closeUniversalDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="delete-warning" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 16px;">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 18px;"></i>
                    <div>
                        <strong style="color: #ef4444;">Warning:</strong>
                        <span id="deleteWarningText">This action cannot be undone.</span>
                    </div>
                </div>
                <p style="font-size: 14px; color: var(--text-primary); margin-bottom: 20px;">
                    Are you sure you want to delete <strong id="deleteItemName"></strong>?
                </p>
                <div id="deleteAdditionalInfo" style="font-size: 13px; color: var(--text-secondary);"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeUniversalDeleteModal()">Cancel</button>
                <button class="modal-btn danger" id="confirmDeleteBtn" onclick="executeDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Set Reminder</h3>
                <button class="modal-close" onclick="closeReminderModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">Quick Options</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <button class="reminder-quick-option" onclick="setQuickReminder('30min')">
                            <i class="fas fa-clock"></i> In 30 minutes
                        </button>
                        <button class="reminder-quick-option" onclick="setQuickReminder('1hour')">
                            <i class="fas fa-clock"></i> In 1 hour
                        </button>
                        <button class="reminder-quick-option" onclick="setQuickReminder('tomorrow')">
                            <i class="fas fa-calendar-day"></i> Tomorrow
                        </button>
                        <button class="reminder-quick-option" onclick="setQuickReminder('nextweek')">
                            <i class="fas fa-calendar-week"></i> Next week
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">Custom Date & Time</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="date" id="reminderDate" class="modal-input" style="flex: 1;">
                        <input type="time" id="reminderTime" class="modal-input" style="flex: 1;">
                    </div>
                </div>
                
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">Note (optional)</label>
                    <textarea id="reminderNote" class="modal-input" rows="2" placeholder="Add a note for this reminder..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeReminderModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmReminder()">Set Reminder</button>
            </div>
        </div>
    </div>
    <!-- Context Menu -->
    <div id="libraryContextMenu" class="library-context-menu"></div>

</body>
</html>