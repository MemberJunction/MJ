{
  "name": "AccountRevenueByType",
  "title": "Account Revenue by Type",
  "type": "chart",
  "namespace": "CRM/Analytics",
  "userExplanation": "Shows revenue breakdown by account type (Enterprise, SMB, Individual, etc.) with click-to-drill-down functionality. Click any chart segment to view detailed invoice records for that account type using EntityDataGrid. Demonstrates the fundamental hybrid pattern: RunQuery for aggregated chart data + EntityDataGrid for automatic drill-down.",
  "functionalRequirements": "## Business Objectives\n- Visualize revenue distribution across different account types\n- Identify which account types generate the most revenue\n- Enable quick drill-down to see invoice details for any account type\n- Demonstrate the core hybrid pattern for educational purposes\n\n## Functional Requirements\n- **Revenue Chart**: Display pie or bar chart showing total revenue by account type\n- **Account Count**: Show number of accounts in each type (in tooltip or segment label)\n- **Click-to-Drill-Down**: When user clicks chart segment, display EntityDataGrid with invoices for that account type\n- **Automatic Filtering**: EntityDataGrid automatically filters to selected account type using SQL filter\n- **Invoice Details**: Show invoice number, date, account name, total, and status in grid\n- **Grid Features**: EntityDataGrid provides automatic pagination, sorting, filtering, and OpenEntityRecord\n- **Clear Selection**: Provide button/action to clear selection and return to chart-only view\n- **Highlight Selection**: Visual feedback showing which segment is currently selected\n- **Chart Type Options**: Support switching between pie, doughnut, and bar chart types\n- **Loading States**: Show loading indicator while data loads\n- **Empty States**: Handle cases with no revenue data",
  "description": "Analyzes revenue distribution across different account types with comparison metrics and trend analysis.",
  "dataRequirements": {
    "mode": "hybrid",
    "queries": [
      {
        "name": "Account Revenue by Type",
        "categoryPath": "Demo",
        "description": "Aggregates total revenue by AccountType. Joins Account → AccountType → Invoice where Status='Paid'. Returns AccountType, AccountCount, TotalRevenue for chart. **Result Order: TotalRevenue DESC** - Highest revenue account types first for ranking comparison.",
        "entityNames": [
          "Accounts",
          "Account Types",
          "Invoices"
        ],
        "fields": [
          {
            "name": "AccountType",
            "sequence": 1,
            "defaultInView": true,
            "type": "nvarchar(255)",
            "allowsNull": true,
            "isPrimaryKey": false,
            "description": "Type of account (e.g., Enterprise, SMB, Individual)"
          },
          {
            "name": "AccountCount",
            "sequence": 2,
            "defaultInView": true,
            "type": "int",
            "allowsNull": false,
            "isPrimaryKey": false,
            "description": "Number of distinct accounts of this type"
          },
          {
            "name": "TotalRevenue",
            "sequence": 3,
            "defaultInView": true,
            "type": "decimal(18,2)",
            "allowsNull": true,
            "isPrimaryKey": false,
            "description": "Total revenue from paid invoices for this account type"
          },
          {
            "name": "AvgInvoice",
            "sequence": 4,
            "defaultInView": true,
            "type": "decimal(18,2)",
            "allowsNull": true,
            "isPrimaryKey": false,
            "description": "Average invoice amount for this account type"
          },
          {
            "name": "InvoiceCount",
            "sequence": 5,
            "defaultInView": true,
            "type": "int",
            "allowsNull": false,
            "isPrimaryKey": false,
            "description": "Number of paid invoices for this account type"
          },
          {
            "name": "TotalOutstanding",
            "sequence": 6,
            "defaultInView": true,
            "type": "decimal(18,2)",
            "allowsNull": true,
            "isPrimaryKey": false,
            "description": "Total outstanding balance due for this account type"
          }
        ],
        "parameters": [
          {
            "name": "AccountType",
            "isRequired": false,
            "type": "string",
            "sampleValue": "Enterprise",
            "description": "Optional filter by specific account type"
          },
          {
            "name": "StartDate",
            "isRequired": false,
            "type": "string",
            "sampleValue": "2024-01-01",
            "description": "Optional start date filter in YYYY-MM-DD format"
          },
          {
            "name": "EndDate",
            "isRequired": false,
            "type": "string",
            "sampleValue": "2024-12-31",
            "description": "Optional end date filter in YYYY-MM-DD format"
          }
        ]
      }
    ],
    "entities": [
      {
        "name": "Accounts",
        "description": "Account records used in SQL filter for drill-down. The AccountType column is used to filter invoices by account type.",
        "displayFields": [
          "Name",
          "AccountType",
          "Status"
        ],
        "filterFields": [
          "ID",
          "AccountType",
          "Status"
        ],
        "sortFields": [
          "Name",
          "CreatedAt"
        ],
        "usageContext": "Referenced in EntityDataGrid extraFilter SQL subquery: SELECT ID FROM CRM.vwAccounts WHERE AccountType='{selectedType}'"
      },
      {
        "name": "Invoices",
        "description": "Invoice records shown in EntityDataGrid when drilling down from account type chart segment.",
        "displayFields": [
          "InvoiceNumber",
          "InvoiceDate",
          "AccountName",
          "TotalAmount",
          "Status",
          "AmountPaid",
          "BalanceDue"
        ],
        "filterFields": [
          "AccountID",
          "InvoiceDate",
          "Status"
        ],
        "sortFields": [
          "InvoiceDate",
          "TotalAmount"
        ],
        "usageContext": "Loaded by EntityDataGrid using SQL filter: AccountID IN (SELECT ID FROM CRM.vwAccounts WHERE AccountType = '{selectedType}') AND InvoiceDate >= '{startDate}' AND InvoiceDate <= '{endDate}'"
      }
    ]
  },
  "properties": [
    {
      "name": "accountType",
      "type": "string",
      "required": false,
      "description": "Optional filter by specific account type (e.g., 'Enterprise', 'SMB', 'Individual'). If provided, shows only that account type.",
      "default": null
    },
    {
      "name": "startDate",
      "type": "string",
      "required": false,
      "description": "Optional start date filter (ISO format: '2024-01-01'). Returns invoices with InvoiceDate >= startDate.",
      "default": null
    },
    {
      "name": "endDate",
      "type": "string",
      "required": false,
      "description": "Optional end date filter (ISO format: '2024-12-31'). Returns invoices with InvoiceDate <= endDate.",
      "default": null
    },
    {
      "name": "chartType",
      "type": "string",
      "required": false,
      "description": "Type of chart to display: 'bar' (default), 'pie', or 'doughnut'",
      "default": "bar",
      "possibleValues": [
        "bar",
        "pie",
        "doughnut"
      ]
    },
    {
      "name": "title",
      "type": "string",
      "required": false,
      "description": "Custom chart title. If not provided, uses default title.",
      "default": "Account Revenue by Type"
    }
  ],
  "events": [
    {
      "name": "onSegmentClick",
      "description": "Fired when user clicks a chart segment (account type bar/slice)",
      "payload": {
        "accountType": "string - The account type that was clicked (e.g., 'Customer', 'Prospect')",
        "accountCount": "number - Number of accounts of this type",
        "totalRevenue": "number - Total revenue for this account type",
        "avgInvoice": "number - Average invoice amount for this account type",
        "invoiceCount": "number - Number of invoices for this account type"
      },
      "example": "{ accountType: 'Customer', accountCount: 17, totalRevenue: 720558.36, avgInvoice: 30023.26, invoiceCount: 24 }"
    },
    {
      "name": "onRecordClick",
      "description": "Fired when user clicks a row in the EntityDataGrid drill-down",
      "payload": {
        "invoiceId": "string - The ID of the clicked invoice record",
        "invoiceNumber": "string - Invoice number (e.g., 'INV-001')",
        "accountName": "string - Name of the account",
        "totalAmount": "number - Total invoice amount",
        "status": "string - Invoice status (e.g., 'Paid', 'Pending')"
      },
      "example": "{ invoiceId: 'abc-123', invoiceNumber: 'INV-001', accountName: 'Acme Corp', totalAmount: 5000.00, status: 'Paid' }"
    }
  ],
  "dependencies": [
    {
      "name": "SimpleChart",
      "location": "registry",
      "namespace": "Generic/UI/Chart",
      "version": "^1.0.0"
    },
    {
      "name": "EntityDataGrid",
      "location": "registry",
      "namespace": "Generic/UI/Table",
      "version": "^1.0.0"
    }
  ],
  "location": "embedded",
  "technicalDesign": "## Component Architecture\n\n### Data Flow\n1. **Initial Load**: RunQuery executes 'Account Revenue by Type' with optional filters (accountType, startDate, endDate)\n2. **Chart Rendering**: SimpleChart displays aggregated revenue data grouped by AccountType\n3. **User Interaction**: User clicks chart segment (bar/pie slice)\n4. **Drill-Down**: Component sets selectedType state and triggers EntityDataGrid\n5. **Grid Filtering**: EntityDataGrid loads Invoices filtered by SQL subquery on Accounts.AccountType\n6. **Date Consistency**: Date filters applied to both query and EntityDataGrid extraFilter\n\n### State Management\n- `data`: Array of query results (AccountType, TotalRevenue, AccountCount, etc.)\n- `loading`: Boolean for async operation status\n- `error`: String for error messages\n- `selectedType`: String for currently selected account type (null = chart view, value = grid view)\n- `internalStartDate`: String for user-controlled start date (only when prop is null)\n- `internalEndDate`: String for user-controlled end date (only when prop is null)\n\n### Conditional UI Controls\n**Date Filter Panel**: Only rendered when both `startDate` and `endDate` props are null. Allows user to set date range filters with:\n- Start Date input (HTML date picker)\n- End Date input (HTML date picker)\n- Clear Dates button (shown when either date is set)\n\n### Filter Coordination\n**effectiveStartDate/endDate**: Computed values that prioritize props over internal state\n- Used in RunQuery Parameters\n- Used in EntityDataGrid extraFilter for consistency\n\n### EntityDataGrid Integration\n**extraFilter Construction**:\n1. Account type filter: `AccountID IN (SELECT ID FROM CRM.vwAccounts WHERE AccountType='{selectedType}')`\n   - Uses correct column name: `AccountType` (not `Type`)\n   - References BaseView: `CRM.vwAccounts` (not table)\n2. Date filters (when provided):\n   - Start: `InvoiceDate >= '{effectiveStartDate}'`\n   - End: `InvoiceDate <= '{effectiveEndDate}'`\n3. Filters combined with AND operator\n\n### Event System\n**onSegmentClick**: Fires when chart segment clicked, provides:\n- accountType, accountCount, totalRevenue, avgInvoice, invoiceCount\n\n**onRecordClick**: Fires when EntityDataGrid row clicked, provides:\n- invoiceId, invoiceNumber, accountName, totalAmount, status\n\n### Educational Value\nDemonstrates:\n1. **Hybrid Pattern**: RunQuery for aggregation + EntityDataGrid for drill-down\n2. **SQL Filter Construction**: Subquery pattern for related entity filtering\n3. **Filter Consistency**: Same date filters applied to chart and grid\n4. **Conditional UI**: Show/hide controls based on prop nullability\n5. **Event Exposure**: External consumers can listen to user interactions\n6. **Schema Awareness**: Correct column names validated against entity schema",
  "code": "@file:../../code/query-examples/account-revenue-by-type.js",
  "exampleUsage": "// Basic usage (no filters)\n<AccountRevenueByType\n  utilities={utilities}\n  styles={styles}\n  components={components}\n  callbacks={callbacks}\n/>\n\n// With date filters controlled externally\n<AccountRevenueByType\n  startDate=\"2024-01-01\"\n  endDate=\"2024-12-31\"\n  utilities={utilities}\n  styles={styles}\n  components={components}\n  callbacks={callbacks}\n/>\n\n// With event handlers and custom chart type\n<AccountRevenueByType\n  chartType=\"doughnut\"\n  onSegmentClick={(event) => {\n    console.log(`Clicked ${event.accountType}: $${event.totalRevenue}`);\n  }}\n  onRecordClick={(event) => {\n    console.log(`Invoice ${event.invoiceNumber} clicked`);\n    // Navigate to invoice detail page\n    router.push(`/invoices/${event.invoiceId}`);\n  }}\n  utilities={utilities}\n  styles={styles}\n  components={components}\n  callbacks={callbacks}\n/>\n\n// Let user control date filters (no props provided)\n<AccountRevenueByType\n  title=\"Revenue Analysis by Account Type\"\n  utilities={utilities}\n  styles={styles}\n  components={components}\n  callbacks={callbacks}\n/>"
}
