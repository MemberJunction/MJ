-- SQL Logging Session
-- Session ID: 38320539-b611-4e99-a79a-fbf849930269
-- Started: 2025-11-20T00:21:54.813Z
-- Description: MetadataSync push operation
-- Format: Migration-ready with Flyway schema placeholders
-- Generated by MemberJunction SQLServerDataProvider

-- Save Template Contents (core SP call only)
DECLARE @TemplateID_a8f32c64 UNIQUEIDENTIFIER,
@TypeID_a8f32c64 UNIQUEIDENTIFIER,
@TemplateText_a8f32c64 NVARCHAR(MAX),
@Priority_a8f32c64 INT,
@IsActive_a8f32c64 BIT,
@ID_a8f32c64 UNIQUEIDENTIFIER
SET
  @TemplateID_a8f32c64 = '9FE0EBC4-FF3F-44CF-AD31-AA1A191CD291'
SET
  @TypeID_a8f32c64 = 'E7AFCCEC-6A37-EF11-86D4-000D3A4E707E'
SET
  @TemplateText_a8f32c64 = N'You are an expert at parsing Nunjucks templates. You are also an expert at SQL Server queries. 
Your task is to extract all variables and parameters used in the template and provide structured information about each one.

## SQL Query Template: 
{{ templateText }}

## Instructions:
Identify ALL variables used in the template, including:
1. Simple variables: {% raw %}{{ variableName }}{% endraw %}
2. Object properties: {% raw %}{{ user.email }}{% endraw %}, {% raw %}{{ data.items[0].name }}{% endraw %}
3. Variables in conditionals: {% raw %}{% if isActive %}{% endraw %}, {% raw %}{% if user.role == "admin" %}{% endraw %}
4. Loop variables: {% raw %}{% for item in items %}{% endraw %}, {% raw %}{% for key, value in object %}{% endraw %}
5. Variables in filters: {% raw %}{{ name | default(userName) }}{% endraw %}
6. Variables in assignments: {% raw %}{% set total = price * quantity %}{% endraw %}

## **IMPORTANT** 
Do NOT include variables that are shown within {% raw %}{% raw %}{% endraw %}{% endraw %} blocks, those are for illustrative purposes and part of an illustration of what another template might have. Only consider variables that are **NOT** part of raw blocks to be valid for the purpose of this request.

For nested object references (like user.email), extract only the TOP-LEVEL variable name (user).

## Output Format: 
Return a JSON array of parameter objects with this structure:

```json
{
  "parameters": [
    {
      "name": "variableName",
      "type": "string|number|date|boolean|array|object",
      "isRequired": true|false,
      "description": "Brief description of what this parameter is used for based on context",
      "usage": ["List of locations where this variable is used in the template"],
      "defaultValue": "Default value if found in template (e.g., from default filter)"
    }
  ],
  "selectClause": [
    {
        "name": "name of field in the result of the query",  
        "dynamicName": true, // only true if the name of the field in the result is calculated in the nunjucks template. Uncommon but possible
        "description": "Description of what this field will contain",
        "type": "number|string|date|boolean",
        "optional": false // usually false, only true if the field is part of an IF block and sometimes not emitted based on parameter values
    }
  ],
  "fromClause": [
    {
        "schemaName": "name of the schema the view or table is in",
        "baseViewOrTable": "name of the view or table being selected from",
        "alias": "if an alias was used in the query for this base view/table, indicate it here"
    }
  ]
}
```

## Rules:
1. Only include each variable ONCE (deduplicate)
2. Ignore Nunjucks built-in variables (loop, super, etc.)
3. Ignore {% raw %}single curly braces like { and } --- only look for double curly braces {{ and }} for true nunjucks params {% endraw %}
4. For type detection:
   - If used in {% raw %}{% for x in variable %}{% endraw %} → type is "array"
   - If properties are accessed (variable.property) → type is "object" and extract only the top-level variable name
   - Check filters for type hints: sqlString → "string", sqlNumber → "number", sqlDate → "date", sqlIn → "array"
   - Otherwise infer from context: comparison operators, SQL clause usage, default values
   - When in doubt, use "string"
5. Include meaningful descriptions based on usage context
6. For usage array, provide specific examples showing exactly where/how the variable is used in the template

## Example:
Template:
{% raw %}
```sql
SELECT 
   COUNT(*) TotalAccounts,
   SUM(a.Revenue) TotalAccountRevenue,
{% if extraSumField != "" and extraSumFieldAlias != "" }
   SUM({{ extraSumField | sqlIdentifier }}) {{ extraSumFieldAlias | sqlIdentifier }},
{% endif %}
   a.City,
   a.Country,
   a.Region,
   a.Industry,
   i.AverageFirmRevenue,
   i.NumFirms,
   (SELECT COUNT(*) FROM crm.vwCities WHERE Country = a.Country) AS CitiesInCountry,
FROM
   crm.vwAccounts a
INNER JOIN
   crm.vwIndustries i
ON
   a.IndustryID = i.ID
WHERE
   a.Country IN {{ countryList | sqlIn }} AND
   i.NumFirms >= {{ minIndustryFirmCount | sqlNumber }} AND
   a.__mj_CreatedAt >= {{ accountsCreatedOnOrAfter | sqlDate }}
GROUP BY
   a.City,
   a.Country,
   a.Region,
   a.Industry,
   i.AverageFirmRevenue,
   i.NumFirms
{% if orderByClause }
ORDER BY
   {{ orderByClause | sqlNoKeywordsExpression }} -- this means that we run through a filter making sure no keywords are included to prevent common SQL injection attacks
{% endif %}
{% endraw %}
```

Example Output for the above template:
```json
{
  "parameters": [
    {
      "name": "extraSumField",
      "type": "string",
      "isRequired": false,
      "description": "Field name for an optional additional sum aggregation",
      "usage": [
        "Conditional SELECT: SUM({% raw %}{{ extraSumField | sqlIdentifier }}{% endraw %}) {% raw %}{{ extraSumFieldAlias | sqlIdentifier }}{% endraw %}",
        "IF condition check: {% raw %}{% if extraSumField != \"\" and extraSumFieldAlias != \"\" %}{% endraw %}"
      ],
      "defaultValue": null
    },
    {
      "name": "extraSumFieldAlias",
      "type": "string",
      "isRequired": false,
      "description": "Alias for the optional extraSumField aggregation column",
      "usage": [
        "Column alias: {% raw %}{{ extraSumFieldAlias | sqlIdentifier }}{% endraw %}",
        "IF condition check: {% raw %}{% if extraSumField != \"\" and extraSumFieldAlias != \"\" %}{% endraw %}"
      ],
      "defaultValue": null
    },
    {
      "name": "countryList",
      "type": "array",
      "isRequired": true,
      "description": "Array of country names to filter accounts",
      "usage": [
        "WHERE clause: a.Country IN {% raw %}{{ countryList | sqlIn }}{% endraw %}"
      ],
      "defaultValue": null
    },
    {
      "name": "minIndustryFirmCount",
      "type": "number",
      "isRequired": true,
      "description": "Minimum number of firms required for industry inclusion",
      "usage": [
        "WHERE clause: i.NumFirms >= {% raw %}{{ minIndustryFirmCount | sqlNumber }}{% endraw %}"
      ],
      "defaultValue": null
    },
    {
      "name": "accountsCreatedOnOrAfter",
      "type": "date",
      "isRequired": true,
      "description": "Earliest account creation date for filtering",
      "usage": [
        "WHERE clause: a.__mj_CreatedAt >= {% raw %}{{ accountsCreatedOnOrAfter | sqlDate }}{% endraw %}"
      ],
      "defaultValue": null
    },
    {
      "name": "orderByClause",
      "type": "string",
      "isRequired": false,
      "description": "Custom ORDER BY expression for result sorting",
      "usage": [
        "ORDER BY clause: {% raw %}{{ orderByClause | sqlNoKeywordsExpression }}{% endraw %}",
        "IF condition check: {% raw %}{% if orderByClause %}{% endraw %}"
      ],
      "defaultValue": null
    } 
  ],
  "selectClause": [
    {
        "name": "TotalAccounts",
        "description": "Total number of accounts for each grouping",
        "type": "number",
        "optional": false // field is always returned
    },
    {
        "name": "TotalAccountRevenue",
        "description": "Total revenue for all accounts, combined, for each grouping",
        "type": "number",
        "optional": false
    },
    {
        "name": "extraSumFieldAlias", // parameter name the field ends up having as its name 
        "dynamicName": true, // indicates the name of the field in the result is dynamic, derived from the parameter specified
        "description": "Additional Summary based on provided paramater: extraSumField",
        "type": "number",
        "optional": true
    },
    {
        "name": "City",
        "description": "City name for the grouping",
        "type": "string",
        "optional": false
    },
    {
        "name": "Country",
        "description": "Country name for the grouping",
        "type": "string",
        "optional": false
    },
    {
        "name": "Region",
        "description": "Region name for the grouping",
        "type": "string",
        "optional": false
    },
    {
        "name": "Industry",
        "description": "Name of the industry for the grouping",
        "type": "string",
        "optional": false
    },
    {
        "name": "AverageFirmRevenue",
        "description": "Average Revenue for the industry in this grouping",
        "type": "number",
        "optional": false
    },
    {
        "name": "NumFirms",
        "description": "Total # of firms for the industry in this grouping",
        "type": "number",
        "optional": false
    },
    {
      "name": "CitiesInCountry",
      "description": "Count of the # of cities in the country in this grouping",
      "type": "number",
      "optional": false
    }
  ],
  "fromClause": [
    {
        "schemaName": "crm",
        "baseViewOrTable": "vwAccounts",
        "alias": "a"
    },
    {
        "schemaName": "crm",
        "baseViewOrTable": "vwIndustries",
        "alias": "i"
    },
    {
        "schemaName": "crm",
        "baseViewOrTable": "vwCities"
    }
  ]
}
```'
SET
  @Priority_a8f32c64 = 1
SET
  @IsActive_a8f32c64 = 1
SET
  @ID_a8f32c64 = '15574DEC-2E10-41E3-9E5B-B8A25CF0BD7A'
EXEC [${flyway:defaultSchema}].spUpdateTemplateContent @TemplateID = @TemplateID_a8f32c64,
  @TypeID = @TypeID_a8f32c64,
  @TemplateText = @TemplateText_a8f32c64,
  @Priority = @Priority_a8f32c64,
  @IsActive = @IsActive_a8f32c64,
  @ID = @ID_a8f32c64;

-- Save Template Params (core SP call only)
DECLARE @TemplateID_7bc3ea3b UNIQUEIDENTIFIER,
@Name_7bc3ea3b NVARCHAR(255),
@Description_7bc3ea3b NVARCHAR(MAX),
@Type_7bc3ea3b NVARCHAR(20),
@DefaultValue_7bc3ea3b NVARCHAR(MAX),
@IsRequired_7bc3ea3b BIT,
@LinkedParameterName_7bc3ea3b NVARCHAR(255),
@LinkedParameterField_7bc3ea3b NVARCHAR(500),
@ExtraFilter_7bc3ea3b NVARCHAR(MAX),
@EntityID_7bc3ea3b UNIQUEIDENTIFIER,
@RecordID_7bc3ea3b NVARCHAR(2000),
@OrderBy_7bc3ea3b NVARCHAR(MAX),
@TemplateContentID_7bc3ea3b UNIQUEIDENTIFIER,
@ID_7bc3ea3b UNIQUEIDENTIFIER
SET
  @TemplateID_7bc3ea3b = '9FE0EBC4-FF3F-44CF-AD31-AA1A191CD291'
SET
  @Name_7bc3ea3b = N'templateText'
SET
  @Description_7bc3ea3b = N'The SQL query template text to be analyzed for variables'
SET
  @Type_7bc3ea3b = N'Scalar'
SET
  @IsRequired_7bc3ea3b = 0
SET
  @ID_7bc3ea3b = '23B91592-C4FF-4916-973E-7CBACEAAC511'
EXEC [${flyway:defaultSchema}].spUpdateTemplateParam @TemplateID = @TemplateID_7bc3ea3b,
  @Name = @Name_7bc3ea3b,
  @Description = @Description_7bc3ea3b,
  @Type = @Type_7bc3ea3b,
  @DefaultValue = @DefaultValue_7bc3ea3b,
  @IsRequired = @IsRequired_7bc3ea3b,
  @LinkedParameterName = @LinkedParameterName_7bc3ea3b,
  @LinkedParameterField = @LinkedParameterField_7bc3ea3b,
  @ExtraFilter = @ExtraFilter_7bc3ea3b,
  @EntityID = @EntityID_7bc3ea3b,
  @RecordID = @RecordID_7bc3ea3b,
  @OrderBy = @OrderBy_7bc3ea3b,
  @TemplateContentID = @TemplateContentID_7bc3ea3b,
  @ID = @ID_7bc3ea3b;

-- Save AI Prompts (core SP call only)
DECLARE @Name_ff536905 NVARCHAR(255),
@Description_ff536905 NVARCHAR(MAX),
@TemplateID_ff536905 UNIQUEIDENTIFIER,
@CategoryID_ff536905 UNIQUEIDENTIFIER,
@TypeID_ff536905 UNIQUEIDENTIFIER,
@Status_ff536905 NVARCHAR(50),
@ResponseFormat_ff536905 NVARCHAR(20),
@ModelSpecificResponseFormat_ff536905 NVARCHAR(MAX),
@AIModelTypeID_ff536905 UNIQUEIDENTIFIER,
@MinPowerRank_ff536905 INT,
@SelectionStrategy_ff536905 NVARCHAR(20),
@PowerPreference_ff536905 NVARCHAR(20),
@ParallelizationMode_ff536905 NVARCHAR(20),
@ParallelCount_ff536905 INT,
@ParallelConfigParam_ff536905 NVARCHAR(100),
@OutputType_ff536905 NVARCHAR(50),
@OutputExample_ff536905 NVARCHAR(MAX),
@ValidationBehavior_ff536905 NVARCHAR(50),
@MaxRetries_ff536905 INT,
@RetryDelayMS_ff536905 INT,
@RetryStrategy_ff536905 NVARCHAR(20),
@ResultSelectorPromptID_ff536905 UNIQUEIDENTIFIER,
@EnableCaching_ff536905 BIT,
@CacheTTLSeconds_ff536905 INT,
@CacheMatchType_ff536905 NVARCHAR(20),
@CacheSimilarityThreshold_ff536905 FLOAT(53),
@CacheMustMatchModel_ff536905 BIT,
@CacheMustMatchVendor_ff536905 BIT,
@CacheMustMatchAgent_ff536905 BIT,
@CacheMustMatchConfig_ff536905 BIT,
@PromptRole_ff536905 NVARCHAR(20),
@PromptPosition_ff536905 NVARCHAR(20),
@Temperature_ff536905 DECIMAL(3, 2),
@TopP_ff536905 DECIMAL(3, 2),
@TopK_ff536905 INT,
@MinP_ff536905 DECIMAL(3, 2),
@FrequencyPenalty_ff536905 DECIMAL(3, 2),
@PresencePenalty_ff536905 DECIMAL(3, 2),
@Seed_ff536905 INT,
@StopSequences_ff536905 NVARCHAR(1000),
@IncludeLogProbs_ff536905 BIT,
@TopLogProbs_ff536905 INT,
@FailoverStrategy_ff536905 NVARCHAR(50),
@FailoverMaxAttempts_ff536905 INT,
@FailoverDelaySeconds_ff536905 INT,
@FailoverModelStrategy_ff536905 NVARCHAR(50),
@FailoverErrorScope_ff536905 NVARCHAR(50),
@EffortLevel_ff536905 INT,
@ID_ff536905 UNIQUEIDENTIFIER
SET
  @Name_ff536905 = N'SQL Query Parameter Extraction'
SET
  @Description_ff536905 = N'Extracts Nunjucks variables and their types from Query strings'
SET
  @TemplateID_ff536905 = '9FE0EBC4-FF3F-44CF-AD31-AA1A191CD291'
SET
  @CategoryID_ff536905 = '7D2DEF7F-138F-4620-8309-33964A97A997'
SET
  @TypeID_ff536905 = 'A6DA423E-F36B-1410-8DAC-00021F8B792E'
SET
  @Status_ff536905 = N'Active'
SET
  @ResponseFormat_ff536905 = N'JSON'
SET
  @MinPowerRank_ff536905 = 0
SET
  @SelectionStrategy_ff536905 = N'Specific'
SET
  @PowerPreference_ff536905 = N'Highest'
SET
  @ParallelizationMode_ff536905 = N'None'
SET
  @OutputType_ff536905 = N'object'
SET
  @OutputExample_ff536905 = N'{"parameters":[{"name":"customerName","type":"Scalar","isRequired":true,"description":"The name of the customer","usage":["greeting header","personalization"],"defaultValue":null},{"name":"orderItems","type":"Array","isRequired":false,"description":"List of items in the customer''s order","usage":["order details section","item iteration"],"defaultValue":null},{"name":"companyInfo","type":"Object","isRequired":true,"description":"Company information object containing name, address, and contact details","usage":["footer section","contact information"],"defaultValue":null}]}'
SET
  @ValidationBehavior_ff536905 = N'Strict'
SET
  @MaxRetries_ff536905 = 2
SET
  @RetryDelayMS_ff536905 = 1000
SET
  @RetryStrategy_ff536905 = N'Fixed'
SET
  @EnableCaching_ff536905 = 0
SET
  @CacheMatchType_ff536905 = N'Exact'
SET
  @CacheMustMatchModel_ff536905 = 1
SET
  @CacheMustMatchVendor_ff536905 = 1
SET
  @CacheMustMatchAgent_ff536905 = 0
SET
  @CacheMustMatchConfig_ff536905 = 0
SET
  @PromptRole_ff536905 = N'System'
SET
  @PromptPosition_ff536905 = N'First'
SET
  @IncludeLogProbs_ff536905 = 0
SET
  @FailoverStrategy_ff536905 = N'SameModelDifferentVendor'
SET
  @FailoverMaxAttempts_ff536905 = 3
SET
  @FailoverDelaySeconds_ff536905 = 5
SET
  @FailoverModelStrategy_ff536905 = N'PreferSameModel'
SET
  @FailoverErrorScope_ff536905 = N'All'
SET
  @ID_ff536905 = '8BF32885-8504-4DAF-87AE-695E09F1BC3A'
EXEC [${flyway:defaultSchema}].spUpdateAIPrompt @Name = @Name_ff536905,
  @Description = @Description_ff536905,
  @TemplateID = @TemplateID_ff536905,
  @CategoryID = @CategoryID_ff536905,
  @TypeID = @TypeID_ff536905,
  @Status = @Status_ff536905,
  @ResponseFormat = @ResponseFormat_ff536905,
  @ModelSpecificResponseFormat = @ModelSpecificResponseFormat_ff536905,
  @AIModelTypeID = @AIModelTypeID_ff536905,
  @MinPowerRank = @MinPowerRank_ff536905,
  @SelectionStrategy = @SelectionStrategy_ff536905,
  @PowerPreference = @PowerPreference_ff536905,
  @ParallelizationMode = @ParallelizationMode_ff536905,
  @ParallelCount = @ParallelCount_ff536905,
  @ParallelConfigParam = @ParallelConfigParam_ff536905,
  @OutputType = @OutputType_ff536905,
  @OutputExample = @OutputExample_ff536905,
  @ValidationBehavior = @ValidationBehavior_ff536905,
  @MaxRetries = @MaxRetries_ff536905,
  @RetryDelayMS = @RetryDelayMS_ff536905,
  @RetryStrategy = @RetryStrategy_ff536905,
  @ResultSelectorPromptID = @ResultSelectorPromptID_ff536905,
  @EnableCaching = @EnableCaching_ff536905,
  @CacheTTLSeconds = @CacheTTLSeconds_ff536905,
  @CacheMatchType = @CacheMatchType_ff536905,
  @CacheSimilarityThreshold = @CacheSimilarityThreshold_ff536905,
  @CacheMustMatchModel = @CacheMustMatchModel_ff536905,
  @CacheMustMatchVendor = @CacheMustMatchVendor_ff536905,
  @CacheMustMatchAgent = @CacheMustMatchAgent_ff536905,
  @CacheMustMatchConfig = @CacheMustMatchConfig_ff536905,
  @PromptRole = @PromptRole_ff536905,
  @PromptPosition = @PromptPosition_ff536905,
  @Temperature = @Temperature_ff536905,
  @TopP = @TopP_ff536905,
  @TopK = @TopK_ff536905,
  @MinP = @MinP_ff536905,
  @FrequencyPenalty = @FrequencyPenalty_ff536905,
  @PresencePenalty = @PresencePenalty_ff536905,
  @Seed = @Seed_ff536905,
  @StopSequences = @StopSequences_ff536905,
  @IncludeLogProbs = @IncludeLogProbs_ff536905,
  @TopLogProbs = @TopLogProbs_ff536905,
  @FailoverStrategy = @FailoverStrategy_ff536905,
  @FailoverMaxAttempts = @FailoverMaxAttempts_ff536905,
  @FailoverDelaySeconds = @FailoverDelaySeconds_ff536905,
  @FailoverModelStrategy = @FailoverModelStrategy_ff536905,
  @FailoverErrorScope = @FailoverErrorScope_ff536905,
  @EffortLevel = @EffortLevel_ff536905,
  @ID = @ID_ff536905;


-- End of SQL Logging Session
-- Session ID: 38320539-b611-4e99-a79a-fbf849930269
-- Completed: 2025-11-20T00:22:14.114Z
-- Duration: 19301ms
-- Total Statements: 3
