-- SQL Logging Session
-- Session ID: 59b72a85-cd54-4f37-880b-7c695b73a578
-- Started: 2025-07-29T21:19:53.141Z
-- Description: MetadataSync push operation
-- Format: Migration-ready with Flyway schema placeholders
-- Generated by MemberJunction SQLServerDataProvider

-- Save Queries (core SP call only)
EXEC [${flyway:defaultSchema}].spUpdateQuery @Name = N'CalculateRunCost',
@CategoryID = '5609FBC7-381C-4F9C-9C74-04B52C1FF3DA',
@UserQuestion = N'What is the total cost, token usage, and number of prompts for an AI Agent Run including all its sub-agent runs?',
@Description = N'Calculates comprehensive cost metrics for an AI Agent Run, including all nested sub-agent runs. Returns total cost, token usage (input/output), and prompt count by recursively traversing the agent run hierarchy.',
@SQL = N'-- Calculate AI Agent Run Cost with Recursive Sub-Agent Hierarchy
WITH AgentRunHierarchy AS (
  -- Base case: Start with the specified agent run
  SELECT ID, AgentID, ParentRunID, 1 as Level
  FROM [${flyway:defaultSchema}].vwAIAgentRuns
  WHERE ID = {{ AIAgentRunID | sqlString }} -- Replace with the actual Agent Run ID parameter. This is a UUID.
  
  UNION ALL
  
  -- Recursive case: Get all child agent runs
  SELECT ar.ID, ar.AgentID, ar.ParentRunID, arh.Level + 1
  FROM [${flyway:defaultSchema}].vwAIAgentRuns ar
  INNER JOIN AgentRunHierarchy arh ON ar.ParentRunID = arh.ID
  WHERE arh.Level < 20  -- Prevent infinite recursion
),
PromptRunCosts AS (
  -- Get all prompt runs for the agent run hierarchy
  SELECT 
    pr.ID as PromptRunID,
    pr.TotalCost,
    pr.TokensPrompt,
    pr.TokensCompletion,
    ars.AgentRunID
  FROM [${flyway:defaultSchema}].vwAIAgentRunSteps ars
  INNER JOIN AgentRunHierarchy arh ON ars.AgentRunID = arh.ID
  INNER JOIN [${flyway:defaultSchema}].vwAIPromptRuns pr ON ars.TargetLogID = pr.ID
  WHERE ars.StepType = ''Prompt''
)
SELECT 
  {{ AIAgentRunID | sqlString }} AS AgentRunID,
  COALESCE(SUM(prc.TotalCost), 0) AS TotalCost,
  COUNT(prc.PromptRunID) AS TotalPrompts,
  COALESCE(SUM(prc.TokensPrompt), 0) AS TotalTokensInput,
  COALESCE(SUM(prc.TokensCompletion), 0) AS TotalTokensOutput,
  COALESCE(SUM(prc.TokensPrompt), 0) + COALESCE(SUM(prc.TokensCompletion), 0) AS TotalTokens
FROM PromptRunCosts prc',
@TechnicalDescription = N'This query uses a Common Table Expression (CTE) to recursively traverse the AI Agent Run hierarchy, starting from a specified root agent run and including all nested sub-agent runs up to 20 levels deep. It then joins with AI Agent Run Steps to find all prompt executions and calculates aggregate cost and token metrics. The query uses template parameters for the MJ Core schema name and agent run ID to ensure compatibility across different environments.',
@OriginalSQL = NULL,
@Feedback = NULL,
@Status = N'Approved',
@QualityRank = 9,
@ExecutionCostRank = 3,
@UsesTemplate = 1,
@ID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF';

-- Delete MJ: Query Parameters (core SP call only)
EXEC [${flyway:defaultSchema}].[spDeleteQueryParameter] @ID = '8A6E309A-EEBA-4763-B018-4463D0901323';

-- Save MJ: Query Parameters (core SP call only)
EXEC [${flyway:defaultSchema}].spUpdateQueryParameter @QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'AIAgentRunID',
@Type = N'string',
@IsRequired = 0,
@DefaultValue = NULL,
@Description = N'The UUID of the AI Agent Run to calculate costs for, including all recursive sub-agents',
@SampleValue = NULL,
@ValidationFilters = NULL,
@DetectionMethod = N'AI',
@AutoDetectConfidenceScore = NULL,
@ID = '9DE9C1D2-B13E-47EC-8D8D-BE4C5F1FBE24';

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spUpdateQueryField @QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalCost',
@Description = N'Total cost of all prompt runs for the specified agent and all its recursive sub-agents',
@Sequence = 2,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL,
@ID = '1CB5979C-E6AC-471E-8CAC-0BBD50FA422D';

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spUpdateQueryField @QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalTokens',
@Description = N'Total number of tokens (input + output) across all prompt runs',
@Sequence = 6,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL,
@ID = '48457DF4-D7B5-4315-8DD3-3B73ED3580D4';

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spUpdateQueryField @QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalPrompts',
@Description = N'Total number of prompt runs executed by the specified agent and all its recursive sub-agents',
@Sequence = 3,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL,
@ID = '71D9F433-3D07-4A63-B0FF-4E2C2B86E9D0';

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spUpdateQueryField @QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'AgentRunID',
@Description = N'The ID of the agent run for which the cost calculation was performed',
@Sequence = 1,
@SQLBaseType = N'nvarchar',
@SQLFullType = N'nvarchar(MAX)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL,
@ID = '0C0BC527-1F71-47C7-9B97-69FC780A0F76';

-- Save Query Entities (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryEntity @ID = 'b9dd88ec-5be6-494c-9542-553d2a09630c',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@EntityID = '5190AF93-4C39-4429-BDAA-0AEB492A0256',
@DetectionMethod = N'AI',
@AutoDetectConfidenceScore = 0.95;

-- Save Query Entities (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryEntity @ID = 'f68c999c-86d8-4683-b31a-15b7d3943861',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@EntityID = '99273DAD-560E-4ABC-8332-C97AB58B7463',
@DetectionMethod = N'AI',
@AutoDetectConfidenceScore = 0.95;

-- Save Query Entities (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryEntity @ID = 'ea8b1449-0be7-454f-acc0-109b04eeb87c',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@EntityID = '7C1C98D0-3978-4CE8-8E3F-C90301E59767',
@DetectionMethod = N'AI',
@AutoDetectConfidenceScore = 0.95;


-- End of SQL Logging Session
-- Session ID: 59b72a85-cd54-4f37-880b-7c695b73a578
-- Completed: 2025-07-29T21:20:10.752Z
-- Duration: 17611ms
-- Total Statements: 10
