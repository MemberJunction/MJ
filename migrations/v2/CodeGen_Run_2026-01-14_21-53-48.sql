/* SQL text to insert new entity field */

      IF NOT EXISTS (
         SELECT 1 FROM [${flyway:defaultSchema}].EntityField 
         WHERE ID = '9052718a-4249-48b7-a861-5addf6756a0d'  OR 
               (EntityID = '3DE4E36C-692F-4311-8732-4C7F4B7DD748' AND Name = 'FirstName')
         -- check to make sure we're not inserting a duplicate entity field metadata record
      )
      BEGIN
         INSERT INTO [${flyway:defaultSchema}].EntityField
         (
            ID,
            EntityID,
            Sequence,
            Name,
            DisplayName,
            Description,
            Type,
            Length,
            Precision,
            Scale,
            AllowsNull,
            DefaultValue,
            AutoIncrement,
            AllowUpdateAPI,
            IsVirtual,
            RelatedEntityID,
            RelatedEntityFieldName,
            IsNameField,
            IncludeInUserSearchAPI,
            IncludeRelatedEntityNameFieldInBaseView,
            DefaultInView,
            IsPrimaryKey,
            IsUnique,
            RelatedEntityDisplayType
         )
         VALUES
         (
            '9052718a-4249-48b7-a861-5addf6756a0d',
            '3DE4E36C-692F-4311-8732-4C7F4B7DD748', -- Entity: Riders
            100021,
            'FirstName',
            'First Name',
            NULL,
            'nvarchar',
            200,
            0,
            0,
            1,
            'null',
            0,
            1,
            0,
            NULL,
            NULL,
            0,
            0,
            0,
            0,
            0,
            0,
            'Search'
         )
      END

/* SQL text to insert new entity field */

      IF NOT EXISTS (
         SELECT 1 FROM [${flyway:defaultSchema}].EntityField 
         WHERE ID = '013d9ff3-70bd-4517-adc9-b65548740421'  OR 
               (EntityID = '3DE4E36C-692F-4311-8732-4C7F4B7DD748' AND Name = 'LastName')
         -- check to make sure we're not inserting a duplicate entity field metadata record
      )
      BEGIN
         INSERT INTO [${flyway:defaultSchema}].EntityField
         (
            ID,
            EntityID,
            Sequence,
            Name,
            DisplayName,
            Description,
            Type,
            Length,
            Precision,
            Scale,
            AllowsNull,
            DefaultValue,
            AutoIncrement,
            AllowUpdateAPI,
            IsVirtual,
            RelatedEntityID,
            RelatedEntityFieldName,
            IsNameField,
            IncludeInUserSearchAPI,
            IncludeRelatedEntityNameFieldInBaseView,
            DefaultInView,
            IsPrimaryKey,
            IsUnique,
            RelatedEntityDisplayType
         )
         VALUES
         (
            '013d9ff3-70bd-4517-adc9-b65548740421',
            '3DE4E36C-692F-4311-8732-4C7F4B7DD748', -- Entity: Riders
            100022,
            'LastName',
            'Last Name',
            NULL,
            'nvarchar',
            200,
            0,
            0,
            1,
            'null',
            0,
            1,
            0,
            NULL,
            NULL,
            0,
            0,
            0,
            0,
            0,
            0,
            'Search'
         )
      END

/* Index for Foreign Keys for Rider */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: Riders
-- Item: Index for Foreign Keys
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------


/* Base View SQL for Riders */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: Riders
-- Item: vwRiders
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- BASE VIEW FOR ENTITY:      Riders
-----               SCHEMA:      MJ_Biking_App
-----               BASE TABLE:  Rider
-----               PRIMARY KEY: rider_id
------------------------------------------------------------
IF OBJECT_ID('[MJ_Biking_App].[vwRiders]', 'V') IS NOT NULL
    DROP VIEW [MJ_Biking_App].[vwRiders];
GO

CREATE VIEW [MJ_Biking_App].[vwRiders]
AS
SELECT
    r.*
FROM
    [MJ_Biking_App].[Rider] AS r
GO
GRANT SELECT ON [MJ_Biking_App].[vwRiders] TO [cdp_UI], [cdp_Developer], [cdp_Integration]
    

/* Base View Permissions SQL for Riders */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: Riders
-- Item: Permissions for vwRiders
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

GRANT SELECT ON [MJ_Biking_App].[vwRiders] TO [cdp_UI], [cdp_Developer], [cdp_Integration]

/* spCreate SQL for Riders */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: Riders
-- Item: spCreateRider
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- CREATE PROCEDURE FOR Rider
------------------------------------------------------------
IF OBJECT_ID('[MJ_Biking_App].[spCreateRider]', 'P') IS NOT NULL
    DROP PROCEDURE [MJ_Biking_App].[spCreateRider];
GO

CREATE PROCEDURE [MJ_Biking_App].[spCreateRider]
    @rider_id uniqueidentifier = NULL,
    @username nvarchar(50),
    @email nvarchar(255),
    @weight_kg decimal(5, 2),
    @fitness_level int,
    @preferred_terrain nvarchar(20),
    @lifetime_stats nvarchar(MAX),
    @created_at datetime2 = NULL,
    @FirstName nvarchar(100),
    @LastName nvarchar(100)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @InsertedRow TABLE ([rider_id] UNIQUEIDENTIFIER)
    
    IF @rider_id IS NOT NULL
    BEGIN
        -- User provided a value, use it
        INSERT INTO [MJ_Biking_App].[Rider]
            (
                [rider_id],
                [username],
                [email],
                [weight_kg],
                [fitness_level],
                [preferred_terrain],
                [lifetime_stats],
                [created_at],
                [FirstName],
                [LastName]
            )
        OUTPUT INSERTED.[rider_id] INTO @InsertedRow
        VALUES
            (
                @rider_id,
                @username,
                @email,
                @weight_kg,
                @fitness_level,
                @preferred_terrain,
                @lifetime_stats,
                ISNULL(@created_at, getutcdate()),
                @FirstName,
                @LastName
            )
    END
    ELSE
    BEGIN
        -- No value provided, let database use its default (e.g., NEWSEQUENTIALID())
        INSERT INTO [MJ_Biking_App].[Rider]
            (
                [username],
                [email],
                [weight_kg],
                [fitness_level],
                [preferred_terrain],
                [lifetime_stats],
                [created_at],
                [FirstName],
                [LastName]
            )
        OUTPUT INSERTED.[rider_id] INTO @InsertedRow
        VALUES
            (
                @username,
                @email,
                @weight_kg,
                @fitness_level,
                @preferred_terrain,
                @lifetime_stats,
                ISNULL(@created_at, getutcdate()),
                @FirstName,
                @LastName
            )
    END
    -- return the new record from the base view, which might have some calculated fields
    SELECT * FROM [MJ_Biking_App].[vwRiders] WHERE [rider_id] = (SELECT [rider_id] FROM @InsertedRow)
END
GO
GRANT EXECUTE ON [MJ_Biking_App].[spCreateRider] TO [cdp_Developer], [cdp_Integration]
    

/* spCreate Permissions for Riders */

GRANT EXECUTE ON [MJ_Biking_App].[spCreateRider] TO [cdp_Developer], [cdp_Integration]



/* spUpdate SQL for Riders */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: Riders
-- Item: spUpdateRider
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- UPDATE PROCEDURE FOR Rider
------------------------------------------------------------
IF OBJECT_ID('[MJ_Biking_App].[spUpdateRider]', 'P') IS NOT NULL
    DROP PROCEDURE [MJ_Biking_App].[spUpdateRider];
GO

CREATE PROCEDURE [MJ_Biking_App].[spUpdateRider]
    @rider_id uniqueidentifier,
    @username nvarchar(50),
    @email nvarchar(255),
    @weight_kg decimal(5, 2),
    @fitness_level int,
    @preferred_terrain nvarchar(20),
    @lifetime_stats nvarchar(MAX),
    @created_at datetime2,
    @FirstName nvarchar(100),
    @LastName nvarchar(100)
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [MJ_Biking_App].[Rider]
    SET
        [username] = @username,
        [email] = @email,
        [weight_kg] = @weight_kg,
        [fitness_level] = @fitness_level,
        [preferred_terrain] = @preferred_terrain,
        [lifetime_stats] = @lifetime_stats,
        [created_at] = @created_at,
        [FirstName] = @FirstName,
        [LastName] = @LastName
    WHERE
        [rider_id] = @rider_id

    -- Check if the update was successful
    IF @@ROWCOUNT = 0
        -- Nothing was updated, return no rows, but column structure from base view intact, semantically correct this way.
        SELECT TOP 0 * FROM [MJ_Biking_App].[vwRiders] WHERE 1=0
    ELSE
        -- Return the updated record so the caller can see the updated values and any calculated fields
        SELECT
                                        *
                                    FROM
                                        [MJ_Biking_App].[vwRiders]
                                    WHERE
                                        [rider_id] = @rider_id
                                    
END
GO

GRANT EXECUTE ON [MJ_Biking_App].[spUpdateRider] TO [cdp_Developer], [cdp_Integration]
GO

------------------------------------------------------------
----- TRIGGER FOR __mj_UpdatedAt field for the Rider table
------------------------------------------------------------
IF OBJECT_ID('[MJ_Biking_App].[trgUpdateRider]', 'TR') IS NOT NULL
    DROP TRIGGER [MJ_Biking_App].[trgUpdateRider];
GO
CREATE TRIGGER [MJ_Biking_App].trgUpdateRider
ON [MJ_Biking_App].[Rider]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [MJ_Biking_App].[Rider]
    SET
        __mj_UpdatedAt = GETUTCDATE()
    FROM
        [MJ_Biking_App].[Rider] AS _organicTable
    INNER JOIN
        INSERTED AS I ON
        _organicTable.[rider_id] = I.[rider_id];
END;
GO
        

/* spUpdate Permissions for Riders */

GRANT EXECUTE ON [MJ_Biking_App].[spUpdateRider] TO [cdp_Developer], [cdp_Integration]



/* spDelete SQL for Riders */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: Riders
-- Item: spDeleteRider
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- DELETE PROCEDURE FOR Rider
------------------------------------------------------------
IF OBJECT_ID('[MJ_Biking_App].[spDeleteRider]', 'P') IS NOT NULL
    DROP PROCEDURE [MJ_Biking_App].[spDeleteRider];
GO

CREATE PROCEDURE [MJ_Biking_App].[spDeleteRider]
    @rider_id uniqueidentifier
AS
BEGIN
    SET NOCOUNT ON;

    DELETE FROM
        [MJ_Biking_App].[Rider]
    WHERE
        [rider_id] = @rider_id


    -- Check if the delete was successful
    IF @@ROWCOUNT = 0
        SELECT NULL AS [rider_id] -- Return NULL for all primary key fields to indicate no record was deleted
    ELSE
        SELECT @rider_id AS [rider_id] -- Return the primary key values to indicate we successfully deleted the record
END
GO
GRANT EXECUTE ON [MJ_Biking_App].[spDeleteRider] TO [cdp_Integration]
    

/* spDelete Permissions for Riders */

GRANT EXECUTE ON [MJ_Biking_App].[spDeleteRider] TO [cdp_Integration]



