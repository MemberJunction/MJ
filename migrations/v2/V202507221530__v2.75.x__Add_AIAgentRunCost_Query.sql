-- SQL Logging Session
-- Session ID: 500f46ae-133d-4ac3-950a-bab12876c964
-- Started: 2025-07-22T21:00:17.012Z
-- Description: MetadataSync push operation
-- Format: Migration-ready with Flyway schema placeholders
-- Generated by MemberJunction SQLServerDataProvider

-- Save Query Categories (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryCategory @ID = 'de6afa78-6da3-44ff-b0a8-0abe96a98e3c',
@Name = N'AI',
@ParentID = NULL,
@Description = N'Queries related to AI operations including AI Agent Runs, AI Prompt Runs, cost calculations, and performance analytics.',
@UserID = 'ECAFCCEC-6A37-EF11-86D4-000D3A4E707E';

-- Save Queries (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQuery @ID = 'c4bc63cf-cb62-4008-80bb-d2f4202c6d51',
@Name = N'CalculateAIAgentRunCost',
@CategoryID = 'DE6AFA78-6DA3-44FF-B0A8-0ABE96A98E3C',
@UserQuestion = N'What is the total cost, token usage, and number of prompts for an AI Agent Run including all its sub-agent runs?',
@Description = N'Calculates comprehensive cost metrics for an AI Agent Run, including all nested sub-agent runs. Returns total cost, token usage (input/output), and prompt count by recursively traversing the agent run hierarchy.',
@SQL = N'-- Calculate AI Agent Run Cost with Recursive Sub-Agent Hierarchy
WITH AgentRunHierarchy AS (
  -- Base case: Start with the specified agent run
  SELECT ID, AgentID, ParentRunID, 1 as Level
  FROM {{ MJCoreSchemaName }}.vwAIAgentRuns
  WHERE ID = {{ AIAgentRunID | sqlString }}
  
  UNION ALL
  
  -- Recursive case: Get all child agent runs
  SELECT ar.ID, ar.AgentID, ar.ParentRunID, arh.Level + 1
  FROM {{ MJCoreSchemaName }}.vwAIAgentRuns ar
  INNER JOIN AgentRunHierarchy arh ON ar.ParentRunID = arh.ID
  WHERE arh.Level < 20  -- Prevent infinite recursion
),
PromptRunCosts AS (
  -- Get all prompt runs for the agent run hierarchy
  SELECT 
    pr.ID as PromptRunID,
    pr.TotalCost,
    pr.TokensPrompt,
    pr.TokensCompletion,
    ars.AgentRunID
  FROM {{ MJCoreSchemaName }}.vwAIAgentRunSteps ars
  INNER JOIN AgentRunHierarchy arh ON ars.AgentRunID = arh.ID
  INNER JOIN {{ MJCoreSchemaName }}.vwAIPromptRuns pr ON ars.TargetLogID = pr.ID
  WHERE ars.StepType = ''Prompt''
)
SELECT 
  {{ AIAgentRunID | sqlString }} AS AgentRunID,
  COALESCE(SUM(prc.TotalCost), 0) AS TotalCost,
  COUNT(prc.PromptRunID) AS TotalPrompts,
  COALESCE(SUM(prc.TokensPrompt), 0) AS TotalTokensInput,
  COALESCE(SUM(prc.TokensCompletion), 0) AS TotalTokensOutput,
  COALESCE(SUM(prc.TokensPrompt), 0) + COALESCE(SUM(prc.TokensCompletion), 0) AS TotalTokens
FROM PromptRunCosts prc',
@TechnicalDescription = N'This query uses a Common Table Expression (CTE) to recursively traverse the AI Agent Run hierarchy, starting from a specified root agent run and including all nested sub-agent runs up to 20 levels deep. It then joins with AI Agent Run Steps to find all prompt executions and calculates aggregate cost and token metrics. The query uses template parameters for the MJ Core schema name and agent run ID to ensure compatibility across different environments.',
@OriginalSQL = NULL,
@Feedback = NULL,
@Status = N'Approved',
@QualityRank = 9,
@ExecutionCostRank = 3,
@UsesTemplate = 1;

-- Save MJ: Query Parameters (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryParameter @ID = '5c4a4c90-f2f1-4785-9d1e-17978d92e245',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'AIAgentRunID',
@Type = N'string',
@IsRequired = 1,
@DefaultValue = NULL,
@Description = N'The unique identifier of the AI Agent Run to calculate costs for. The query will include this run and all its nested sub-agent runs in the cost calculation.',
@SampleValue = NULL,
@ValidationFilters = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save MJ: Query Parameters (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryParameter @ID = '272bdd00-88c5-4f41-8088-3bc5701b7777',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'MJCoreSchemaName',
@Type = N'string',
@IsRequired = 1,
@DefaultValue = N'__mj',
@Description = N'The database schema name for MemberJunction core tables. Typically ''__mj'' but may vary by environment to ensure cross-environment compatibility.',
@SampleValue = NULL,
@ValidationFilters = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '82053da0-530d-4d1d-9909-475766d7063d',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'AgentRunID',
@Description = N'The root AI agent run ID that was provided as parameter',
@Sequence = 1,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '67634804-49a2-4765-b4d2-a8e46ff222c9',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'TotalCost',
@Description = N'Total cost of all prompt runs across the agent run hierarchy',
@Sequence = 2,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = 'b64efe80-c484-47dd-8d05-d603c39aaaa1',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'TotalPrompts',
@Description = N'Count of all prompt runs across the agent run hierarchy',
@Sequence = 3,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '222106aa-8998-429b-991b-4106bb23ded9',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'TotalTokensInput',
@Description = N'Total input tokens across all prompt runs in the hierarchy',
@Sequence = 4,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = 'caa557bf-28ce-4891-8056-5322fee0703d',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'TotalTokensOutput',
@Description = N'Total output tokens across all prompt runs in the hierarchy',
@Sequence = 5,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '9239d2de-70ab-4cea-b49d-8b030970fc82',
@QueryID = 'C4BC63CF-CB62-4008-80BB-D2F4202C6D51',
@Name = N'TotalTokens',
@Description = N'Total tokens (input + output) across all prompt runs in the hierarchy',
@Sequence = 6,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;


-- End of SQL Logging Session
-- Session ID: 500f46ae-133d-4ac3-950a-bab12876c964
-- Completed: 2025-07-22T21:00:26.769Z
-- Duration: 9757ms
-- Total Statements: 10
