-- SQL Logging Session
-- Session ID: d088d8e8-e13b-46f0-b5b7-498d382e0b15
-- Started: 2025-07-23T16:19:33.244Z
-- Description: MetadataSync push operation
-- Format: Migration-ready with Flyway schema placeholders
-- Generated by MemberJunction SQLServerDataProvider

-- Save Query Categories (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryCategory @ID = 'fe1ae5b2-fc57-43b2-b560-a673713e1679',
@Name = N'MJ',
@ParentID = NULL,
@Description = N'MemberJunction framework queries for core system operations, analytics, and administrative functions.',
@UserID = 'ECAFCCEC-6A37-EF11-86D4-000D3A4E707E';

-- Save Query Categories (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryCategory @ID = '6c8c5ba5-d9d1-47a1-8ef8-e59da57f9d22',
@Name = N'AI',
@ParentID = 'FE1AE5B2-FC57-43B2-B560-A673713E1679',
@Description = N'AI-related queries for operations, analytics, and management of AI services within MemberJunction.',
@UserID = 'ECAFCCEC-6A37-EF11-86D4-000D3A4E707E';

-- Save Query Categories (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryCategory @ID = '5609fbc7-381c-4f9c-9c74-04b52c1ff3da',
@Name = N'Agents',
@ParentID = '6C8C5BA5-D9D1-47A1-8EF8-E59DA57F9D22',
@Description = N'AI Agent specific queries including run cost calculations, performance analytics, and execution monitoring.',
@UserID = 'ECAFCCEC-6A37-EF11-86D4-000D3A4E707E';

-- Save Queries (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQuery @ID = '1ed5f808-5b12-45db-a376-324cf65b0caf',
@Name = N'CalculateRunCost',
@CategoryID = '5609FBC7-381C-4F9C-9C74-04B52C1FF3DA',
@UserQuestion = N'What is the total cost, token usage, and number of prompts for an AI Agent Run including all its sub-agent runs?',
@Description = N'Calculates comprehensive cost metrics for an AI Agent Run, including all nested sub-agent runs. Returns total cost, token usage (input/output), and prompt count by recursively traversing the agent run hierarchy.',
@SQL = N'-- Calculate AI Agent Run Cost with Recursive Sub-Agent Hierarchy
WITH AgentRunHierarchy AS (
  -- Base case: Start with the specified agent run
  SELECT ID, AgentID, ParentRunID, 1 as Level
  FROM {{ MJCoreSchemaName }}.vwAIAgentRuns
  WHERE ID = {{ AIAgentRunID | sqlString }} -- Replace with the actual Agent Run ID parameter. This is a UUID.
  
  UNION ALL
  
  -- Recursive case: Get all child agent runs
  SELECT ar.ID, ar.AgentID, ar.ParentRunID, arh.Level + 1
  FROM {{ MJCoreSchemaName }}.vwAIAgentRuns ar
  INNER JOIN AgentRunHierarchy arh ON ar.ParentRunID = arh.ID
  WHERE arh.Level < 20  -- Prevent infinite recursion
),
PromptRunCosts AS (
  -- Get all prompt runs for the agent run hierarchy
  SELECT 
    pr.ID as PromptRunID,
    pr.TotalCost,
    pr.TokensPrompt,
    pr.TokensCompletion,
    ars.AgentRunID
  FROM {{ MJCoreSchemaName }}.vwAIAgentRunSteps ars
  INNER JOIN AgentRunHierarchy arh ON ars.AgentRunID = arh.ID
  INNER JOIN {{ MJCoreSchemaName }}.vwAIPromptRuns pr ON ars.TargetLogID = pr.ID
  WHERE ars.StepType = ''Prompt''
)
SELECT 
  {{ AIAgentRunID | sqlString }} AS AgentRunID,
  COALESCE(SUM(prc.TotalCost), 0) AS TotalCost,
  COUNT(prc.PromptRunID) AS TotalPrompts,
  COALESCE(SUM(prc.TokensPrompt), 0) AS TotalTokensInput,
  COALESCE(SUM(prc.TokensCompletion), 0) AS TotalTokensOutput,
  COALESCE(SUM(prc.TokensPrompt), 0) + COALESCE(SUM(prc.TokensCompletion), 0) AS TotalTokens
FROM PromptRunCosts prc',
@TechnicalDescription = N'This query uses a Common Table Expression (CTE) to recursively traverse the AI Agent Run hierarchy, starting from a specified root agent run and including all nested sub-agent runs up to 20 levels deep. It then joins with AI Agent Run Steps to find all prompt executions and calculates aggregate cost and token metrics. The query uses template parameters for the MJ Core schema name and agent run ID to ensure compatibility across different environments.',
@OriginalSQL = NULL,
@Feedback = NULL,
@Status = N'Approved',
@QualityRank = 9,
@ExecutionCostRank = 3,
@UsesTemplate = 1;

-- Save MJ: Query Parameters (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryParameter @ID = '8a6e309a-eeba-4763-b018-4463d0901323',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'MJCoreSchemaName',
@Type = N'string',
@IsRequired = 0,
@DefaultValue = NULL,
@Description = N'Schema name for the MJCore database objects (views and tables)',
@SampleValue = NULL,
@ValidationFilters = NULL,
@DetectionMethod = N'AI',
@AutoDetectConfidenceScore = NULL;

-- Save MJ: Query Parameters (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryParameter @ID = '9de9c1d2-b13e-47ec-8d8d-be4c5f1fbe24',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'AIAgentRunID',
@Type = N'string',
@IsRequired = 0,
@DefaultValue = NULL,
@Description = N'UUID of the AI Agent Run to calculate costs for, including all child/sub-agent runs',
@SampleValue = NULL,
@ValidationFilters = NULL,
@DetectionMethod = N'AI',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '0c0bc527-1f71-47c7-9b97-69fc780a0f76',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'AgentRunID',
@Description = N'The UUID of the root AI Agent Run being analyzed',
@Sequence = 1,
@SQLBaseType = N'nvarchar',
@SQLFullType = N'nvarchar(MAX)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '1cb5979c-e6ac-471e-8cac-0bbd50fa422d',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalCost',
@Description = N'Total cost of all prompt runs across the agent run hierarchy',
@Sequence = 2,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '71d9f433-3d07-4a63-b0ff-4e2c2b86e9d0',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalPrompts',
@Description = N'Count of total prompts executed across the agent run hierarchy',
@Sequence = 3,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '17654da0-443e-4638-8753-777e1c1678d0',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalTokensInput',
@Description = N'Total number of input tokens across all prompt runs',
@Sequence = 4,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '4c182d40-b2ef-4887-9a13-b41c2b8fadc5',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalTokensOutput',
@Description = N'Total number of output tokens across all prompt runs',
@Sequence = 5,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;

-- Save Query Fields (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateQueryField @ID = '48457df4-d7b5-4315-8dd3-3b73ed3580d4',
@QueryID = '1ED5F808-5B12-45DB-A376-324CF65B0CAF',
@Name = N'TotalTokens',
@Description = N'Total tokens (input + output) across all prompt runs',
@Sequence = 6,
@SQLBaseType = N'decimal',
@SQLFullType = N'decimal(18,2)',
@SourceEntityID = NULL,
@SourceFieldName = NULL,
@IsComputed = 0,
@ComputationDescription = NULL,
@IsSummary = 0,
@SummaryDescription = NULL,
@DetectionMethod = N'Manual',
@AutoDetectConfidenceScore = NULL;


-- End of SQL Logging Session
-- Session ID: d088d8e8-e13b-46f0-b5b7-498d382e0b15
-- Completed: 2025-07-23T16:19:42.123Z
-- Duration: 8879ms
-- Total Statements: 12
