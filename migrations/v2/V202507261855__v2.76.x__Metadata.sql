-- SQL Logging Session
-- Session ID: 74fc7edf-2b4e-4a98-8408-889b82247699
-- Started: 2025-07-26T23:53:26.739Z
-- Description: MetadataSync push operation
-- Format: Migration-ready with Flyway schema placeholders
-- Generated by MemberJunction SQLServerDataProvider

-- Save Templates (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplate @ID = '2768459b-de31-4b46-8eeb-9de935307e61',
@Name = N'Flow Agent Type: System Prompt',
@Description = N'Template for AI Prompt: Flow Agent Type: System Prompt',
@CategoryID = 'B09D433E-F36B-1410-8DB1-00021F8B792E',
@UserPrompt = NULL,
@UserID = 'ECAFCCEC-6A37-EF11-86D4-000D3A4E707E',
@ActiveAt = NULL,
@DisabledAt = NULL,
@IsActive = 1;

-- Save Template Contents (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateContent @ID = '06ecfdb2-bbed-45f6-a04a-02062fd8e887',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@TypeID = 'E7AFCCEC-6A37-EF11-86D4-000D3A4E707E',
@TemplateText = N'# Flow Agent System Prompt

You are executing a step in a deterministic workflow. Your role is to make decisions at key decision points when the workflow requires AI-driven judgment.

## Current Flow Context
**Current Step:** {{ flowContext.currentStepId }}
**Completed Steps:** {{ flowContext.completedSteps | length }}
**Execution Path:** {{ flowContext.executionPath | join('' â†’ '') }}

**Payload State:**
```json
{{ _CURRENT_PAYLOAD | dump | safe }}
```

## Your Task
You are at a decision point in the workflow. Based on the current state and the available information, you need to determine the next step to execute.

{%- if availableNextSteps %}
## Available Next Steps
The following steps are potential next actions in this workflow:
{{ availableNextSteps | safe }}
{%- endif %}

## Decision Criteria
Consider the following when making your decision:
1. Current payload state and any recent changes
2. Results from previous steps in the execution path
3. The overall goal of the workflow
4. Any business rules or constraints

{%- if decisionGuidance %}
## Specific Guidance
{{ decisionGuidance | safe }}
{%- endif %}

# Agent: {{ agentName }}
{{ agentDescription | safe }}

## Workflow Description
{{ agentSpecificPrompt | safe }}

# Response Format
Return ONLY valid JSON with your decision:

```typescript
interface FlowAgentPromptResponse {
    // The name of the next step to execute (if you know specific steps)
    nextStepName?: string;
    
    // Your reasoning for this decision
    reasoning?: string;
    
    // Confidence level (0.0-1.0) in your decision
    confidence?: number;
    
    // Set to true if the workflow should terminate
    terminate?: boolean;
    
    // Optional message about your decision
    message?: string;
}
```

## Example Response
```json
{
    "nextStepName": "Manual Review Required",
    "reasoning": "The order amount exceeds the automatic approval threshold and contains restricted items",
    "confidence": 0.95,
    "terminate": false,
    "message": "Routing to manual review due to high value and restricted items"
}
```

## Important Rules
- If you determine the workflow should end, set `terminate: true`
- If you''re unsure about available steps, explain your reasoning without specifying `nextStepName`
- Always provide clear reasoning for your decision
- Consider edge cases and error conditions

# **CRITICAL**
Your **entire** response must be only JSON with no leading or trailing characters!',
@Priority = 1,
@IsActive = 1;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = 'f9051e70-1014-4f78-9376-5ad49984b521',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'flowContext',
@Description = N'Workflow execution context containing current step, completed steps, and execution path',
@Type = N'Object',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = 'd0b57918-f25c-4dca-ab2a-c9a79e4a3840',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'_CURRENT_PAYLOAD',
@Description = N'Current state payload data for the workflow',
@Type = N'Object',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = 'ba3764dd-a53d-45f3-b572-3a55ca723ed8',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'availableNextSteps',
@Description = N'List of potential next workflow steps available for selection',
@Type = N'Array',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = '443a21bc-2ab0-484d-8ee9-9c672276fca5',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'decisionGuidance',
@Description = N'Specific guidance for making the workflow decision',
@Type = N'Scalar',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = '442a11d3-c9ce-4fdb-96b8-a7ef45280ddd',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'agentName',
@Description = N'Name of the AI agent making the decision',
@Type = N'Scalar',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = '76e746ad-f130-4a8c-adc0-8a005ad1131c',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'agentDescription',
@Description = N'Description of the AI agent''s role and capabilities',
@Type = N'Scalar',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save Template Params (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateTemplateParam @ID = 'a6410813-5e3e-4f27-b35b-055e23f32cb8',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@Name = N'agentSpecificPrompt',
@Description = N'Workflow-specific instructions for the AI agent',
@Type = N'Scalar',
@DefaultValue = NULL,
@IsRequired = 0,
@LinkedParameterName = NULL,
@LinkedParameterField = NULL,
@ExtraFilter = NULL,
@EntityID = NULL,
@RecordID = NULL,
@OrderBy = NULL,
@TemplateContentID = NULL;

-- Save AI Prompts (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateAIPrompt @ID = '43a6d122-4a76-453f-97d6-82cacc619227',
@Name = N'Flow Agent Type: System Prompt',
@Description = N'Used for Flow Agents when they have Step Types == Prompt',
@TemplateID = '2768459B-DE31-4B46-8EEB-9DE935307E61',
@CategoryID = '838572BE-9464-4935-BC34-4806FD80A69C',
@TypeID = 'A6DA423E-F36B-1410-8DAC-00021F8B792E',
@Status = N'Active',
@ResponseFormat = N'Any',
@ModelSpecificResponseFormat = NULL,
@AIModelTypeID = NULL,
@MinPowerRank = 0,
@SelectionStrategy = N'Specific',
@PowerPreference = N'Highest',
@ParallelizationMode = N'None',
@ParallelCount = NULL,
@ParallelConfigParam = NULL,
@OutputType = N'object',
@OutputExample = N'{
  "taskComplete?": "[BOOLEAN: true if task is fully complete, false if more steps needed, defaults to false]",
  "message?": "[STRING: A brief, human-readable message about current status or final result. Limit to 100 words.]",
  "payloadChangeRequest*": {
    "[NOTE]": "Follow the format of AgentPayloadChangeRequest. OMIT payloadChangeRequest entirely if no changes are needed."
  },
  "reasoning?": "[STRING: Your internal explanation of why you made this decision - helps with debugging]",
  "confidence?": "[OPTIONAL NUMBER: 0.0 to 1.0 indicating confidence in this decision]",
  "nextStep?": {
    "type?": "REQUIRED: Should be one of the options in the type definition. If not provided, if subAgent key provided it will default to ''subAgent'' and if actions key is provided it will default to ''actions''. If type is not provided and neither actions or subAgent keys are specified, it will be an error condition!",
    "actions?": [
      {
        "name": "[STRING: The exact name from available actions list]",
        "params*": {
          "[PARAM_NAME]": "[PARAM_VALUE: Must match action''s expected parameters]",
          "[ANOTHER_PARAM]": "[Value matching the action''s parameter type]"
        }
      }
    ],
    "subAgent?": {
      "name": "[STRING: The exact name from available sub-agents list]",
      "message": "[STRING: Complete context and instructions for the sub-agent - they don''t see conversation history]",
      "templateParameters*": {
        "[TEMPLATE_PARAM_NAME]": "[VALUE: If sub-agent has template parameters, provide values here]"
      },
      "terminateAfter?": "[BOOLEAN: true to end parent agent after sub-agent completes, false to continue]"
    }
  }
}',
@ValidationBehavior = N'Warn',
@MaxRetries = 2,
@RetryDelayMS = 1000,
@RetryStrategy = N'Fixed',
@ResultSelectorPromptID = NULL,
@EnableCaching = 0,
@CacheTTLSeconds = NULL,
@CacheMatchType = N'Exact',
@CacheSimilarityThreshold = NULL,
@CacheMustMatchModel = 1,
@CacheMustMatchVendor = 1,
@CacheMustMatchAgent = 0,
@CacheMustMatchConfig = 0,
@PromptRole = N'System',
@PromptPosition = N'First',
@Temperature = NULL,
@TopP = NULL,
@TopK = NULL,
@MinP = NULL,
@FrequencyPenalty = NULL,
@PresencePenalty = NULL,
@Seed = NULL,
@StopSequences = NULL,
@IncludeLogProbs = 0,
@TopLogProbs = NULL,
@FailoverStrategy = N'SameModelDifferentVendor',
@FailoverMaxAttempts = 3,
@FailoverDelaySeconds = 5,
@FailoverModelStrategy = N'PreferSameModel',
@FailoverErrorScope = N'All';

-- Save MJ: AI Prompt Models (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateAIPromptModel @ID = '921350bb-9b51-48bb-a619-1947e431f4a6',
@PromptID = '43A6D122-4A76-453F-97D6-82CACC619227',
@ModelID = '9604B1A4-3A21-F011-8B3D-7C1E5249773E',
@VendorID = 'D8A5CCEC-6A37-EF11-86D4-000D3A4E707E',
@ConfigurationID = NULL,
@Priority = 10,
@ExecutionGroup = 0,
@ModelParameters = NULL,
@Status = N'Active',
@ParallelizationMode = N'None',
@ParallelCount = 1,
@ParallelConfigParam = NULL;

-- Save MJ: AI Prompt Models (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateAIPromptModel @ID = '12ac6bcc-9695-4185-942d-cfe68c7e6360',
@PromptID = '43A6D122-4A76-453F-97D6-82CACC619227',
@ModelID = 'C496B988-4EA4-4D7E-A6DD-255F56D93933',
@VendorID = 'E3A5CCEC-6A37-EF11-86D4-000D3A4E707E',
@ConfigurationID = NULL,
@Priority = 15,
@ExecutionGroup = 0,
@ModelParameters = NULL,
@Status = N'Active',
@ParallelizationMode = N'None',
@ParallelCount = 1,
@ParallelConfigParam = NULL;

-- Save MJ: AI Prompt Models (core SP call only)
EXEC [${flyway:defaultSchema}].spCreateAIPromptModel @ID = 'b056959a-f6f5-42e6-8330-8390defa6478',
@PromptID = '43A6D122-4A76-453F-97D6-82CACC619227',
@ModelID = '287E317F-BF26-F011-A770-AC1A3D21423D',
@VendorID = 'D8A5CCEC-6A37-EF11-86D4-000D3A4E707E',
@ConfigurationID = NULL,
@Priority = 12,
@ExecutionGroup = 0,
@ModelParameters = NULL,
@Status = N'Active',
@ParallelizationMode = N'None',
@ParallelCount = 1,
@ParallelConfigParam = NULL;
 
-- End of SQL Logging Session
-- Session ID: 74fc7edf-2b4e-4a98-8408-889b82247699
-- Completed: 2025-07-26T23:53:45.227Z
-- Duration: 18488ms
-- Total Statements: 25
