/*
   Add RepeatCount field to Tests table

   This migration adds support for running a test multiple times
   to gather statistical data and measure consistency.
*/

-- Add RepeatCount column to Tests table
ALTER TABLE [${flyway:defaultSchema}].[Test]
ADD [RepeatCount] INT NULL
GO

-- Add check constraint to ensure RepeatCount is NULL or greater than 0
ALTER TABLE [${flyway:defaultSchema}].[Test]
ADD CONSTRAINT [CK_Test_RepeatCount] CHECK ([RepeatCount] IS NULL OR [RepeatCount] > 0)
GO

-- Add extended property for documentation
EXEC sys.sp_addextendedproperty
    @name = N'MS_Description',
    @value = N'Number of times to repeat this test execution. NULL or 1 = single execution. Values > 1 will create multiple test runs for statistical analysis.',
    @level0type = N'SCHEMA', @level0name = N'${flyway:defaultSchema}',
    @level1type = N'TABLE',  @level1name = N'Test',
    @level2type = N'COLUMN', @level2name = N'RepeatCount'
GO





---- CODE GEN RUN
/* SQL text to insert new entity field */

      IF NOT EXISTS (
         SELECT 1 FROM [${flyway:defaultSchema}].EntityField 
         WHERE ID = '152cbd8b-04b0-4ff4-9fe1-edaebf4a11a4'  OR 
               (EntityID = '1F949AD0-8C72-4846-8A0B-0B3D9F644231' AND Name = 'RepeatCount')
         -- check to make sure we're not inserting a duplicate entity field metadata record
      )
      BEGIN
         INSERT INTO [${flyway:defaultSchema}].EntityField
         (
            ID,
            EntityID,
            Sequence,
            Name,
            DisplayName,
            Description,
            Type,
            Length,
            Precision,
            Scale,
            AllowsNull,
            DefaultValue,
            AutoIncrement,
            AllowUpdateAPI,
            IsVirtual,
            RelatedEntityID,
            RelatedEntityFieldName,
            IsNameField,
            IncludeInUserSearchAPI,
            IncludeRelatedEntityNameFieldInBaseView,
            DefaultInView,
            IsPrimaryKey,
            IsUnique,
            RelatedEntityDisplayType
         )
         VALUES
         (
            '152cbd8b-04b0-4ff4-9fe1-edaebf4a11a4',
            '1F949AD0-8C72-4846-8A0B-0B3D9F644231', -- Entity: MJ: Tests
            100030,
            'RepeatCount',
            'Repeat Count',
            'Number of times to repeat this test execution. NULL or 1 = single execution. Values > 1 will create multiple test runs for statistical analysis.',
            'int',
            4,
            10,
            0,
            1,
            'null',
            0,
            1,
            0,
            NULL,
            NULL,
            0,
            0,
            0,
            0,
            0,
            0,
            'Search'
         )
      END

/* Index for Foreign Keys for Test */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: Tests
-- Item: Index for Foreign Keys
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------
-- Index for foreign key TypeID in table Test
IF NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IDX_AUTO_MJ_FKEY_Test_TypeID' 
    AND object_id = OBJECT_ID('[${flyway:defaultSchema}].[Test]')
)
CREATE INDEX IDX_AUTO_MJ_FKEY_Test_TypeID ON [${flyway:defaultSchema}].[Test] ([TypeID]);

/* Base View SQL for MJ: Tests */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: Tests
-- Item: vwTests
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- BASE VIEW FOR ENTITY:      MJ: Tests
-----               SCHEMA:      ${flyway:defaultSchema}
-----               BASE TABLE:  Test
-----               PRIMARY KEY: ID
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[vwTests]', 'V') IS NOT NULL
    DROP VIEW [${flyway:defaultSchema}].[vwTests];
GO

CREATE VIEW [${flyway:defaultSchema}].[vwTests]
AS
SELECT
    t.*,
    TestType_TypeID.[Name] AS [Type]
FROM
    [${flyway:defaultSchema}].[Test] AS t
INNER JOIN
    [${flyway:defaultSchema}].[TestType] AS TestType_TypeID
  ON
    [t].[TypeID] = TestType_TypeID.[ID]
GO
GRANT SELECT ON [${flyway:defaultSchema}].[vwTests] TO [cdp_UI], [cdp_Developer], [cdp_Integration]
    

/* Base View Permissions SQL for MJ: Tests */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: Tests
-- Item: Permissions for vwTests
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

GRANT SELECT ON [${flyway:defaultSchema}].[vwTests] TO [cdp_UI], [cdp_Developer], [cdp_Integration]

/* spCreate SQL for MJ: Tests */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: Tests
-- Item: spCreateTest
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- CREATE PROCEDURE FOR Test
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spCreateTest]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spCreateTest];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spCreateTest]
    @ID uniqueidentifier = NULL,
    @TypeID uniqueidentifier,
    @Name nvarchar(255),
    @Description nvarchar(MAX),
    @Status nvarchar(20) = NULL,
    @InputDefinition nvarchar(MAX),
    @ExpectedOutcomes nvarchar(MAX),
    @Configuration nvarchar(MAX),
    @Tags nvarchar(MAX),
    @Priority int,
    @EstimatedDurationSeconds int,
    @EstimatedCostUSD decimal(10, 6),
    @RepeatCount int
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @InsertedRow TABLE ([ID] UNIQUEIDENTIFIER)
    
    IF @ID IS NOT NULL
    BEGIN
        -- User provided a value, use it
        INSERT INTO [${flyway:defaultSchema}].[Test]
            (
                [ID],
                [TypeID],
                [Name],
                [Description],
                [Status],
                [InputDefinition],
                [ExpectedOutcomes],
                [Configuration],
                [Tags],
                [Priority],
                [EstimatedDurationSeconds],
                [EstimatedCostUSD],
                [RepeatCount]
            )
        OUTPUT INSERTED.[ID] INTO @InsertedRow
        VALUES
            (
                @ID,
                @TypeID,
                @Name,
                @Description,
                ISNULL(@Status, 'Active'),
                @InputDefinition,
                @ExpectedOutcomes,
                @Configuration,
                @Tags,
                @Priority,
                @EstimatedDurationSeconds,
                @EstimatedCostUSD,
                @RepeatCount
            )
    END
    ELSE
    BEGIN
        -- No value provided, let database use its default (e.g., NEWSEQUENTIALID())
        INSERT INTO [${flyway:defaultSchema}].[Test]
            (
                [TypeID],
                [Name],
                [Description],
                [Status],
                [InputDefinition],
                [ExpectedOutcomes],
                [Configuration],
                [Tags],
                [Priority],
                [EstimatedDurationSeconds],
                [EstimatedCostUSD],
                [RepeatCount]
            )
        OUTPUT INSERTED.[ID] INTO @InsertedRow
        VALUES
            (
                @TypeID,
                @Name,
                @Description,
                ISNULL(@Status, 'Active'),
                @InputDefinition,
                @ExpectedOutcomes,
                @Configuration,
                @Tags,
                @Priority,
                @EstimatedDurationSeconds,
                @EstimatedCostUSD,
                @RepeatCount
            )
    END
    -- return the new record from the base view, which might have some calculated fields
    SELECT * FROM [${flyway:defaultSchema}].[vwTests] WHERE [ID] = (SELECT [ID] FROM @InsertedRow)
END
GO
GRANT EXECUTE ON [${flyway:defaultSchema}].[spCreateTest] TO [cdp_Developer], [cdp_Integration]
    

/* spCreate Permissions for MJ: Tests */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spCreateTest] TO [cdp_Developer], [cdp_Integration]



/* spUpdate SQL for MJ: Tests */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: Tests
-- Item: spUpdateTest
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- UPDATE PROCEDURE FOR Test
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spUpdateTest]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spUpdateTest];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spUpdateTest]
    @ID uniqueidentifier,
    @TypeID uniqueidentifier,
    @Name nvarchar(255),
    @Description nvarchar(MAX),
    @Status nvarchar(20),
    @InputDefinition nvarchar(MAX),
    @ExpectedOutcomes nvarchar(MAX),
    @Configuration nvarchar(MAX),
    @Tags nvarchar(MAX),
    @Priority int,
    @EstimatedDurationSeconds int,
    @EstimatedCostUSD decimal(10, 6),
    @RepeatCount int
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [${flyway:defaultSchema}].[Test]
    SET
        [TypeID] = @TypeID,
        [Name] = @Name,
        [Description] = @Description,
        [Status] = @Status,
        [InputDefinition] = @InputDefinition,
        [ExpectedOutcomes] = @ExpectedOutcomes,
        [Configuration] = @Configuration,
        [Tags] = @Tags,
        [Priority] = @Priority,
        [EstimatedDurationSeconds] = @EstimatedDurationSeconds,
        [EstimatedCostUSD] = @EstimatedCostUSD,
        [RepeatCount] = @RepeatCount
    WHERE
        [ID] = @ID

    -- Check if the update was successful
    IF @@ROWCOUNT = 0
        -- Nothing was updated, return no rows, but column structure from base view intact, semantically correct this way.
        SELECT TOP 0 * FROM [${flyway:defaultSchema}].[vwTests] WHERE 1=0
    ELSE
        -- Return the updated record so the caller can see the updated values and any calculated fields
        SELECT
                                        *
                                    FROM
                                        [${flyway:defaultSchema}].[vwTests]
                                    WHERE
                                        [ID] = @ID
                                    
END
GO

GRANT EXECUTE ON [${flyway:defaultSchema}].[spUpdateTest] TO [cdp_Developer], [cdp_Integration]
GO

------------------------------------------------------------
----- TRIGGER FOR __mj_UpdatedAt field for the Test table
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[trgUpdateTest]', 'TR') IS NOT NULL
    DROP TRIGGER [${flyway:defaultSchema}].[trgUpdateTest];
GO
CREATE TRIGGER [${flyway:defaultSchema}].trgUpdateTest
ON [${flyway:defaultSchema}].[Test]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [${flyway:defaultSchema}].[Test]
    SET
        __mj_UpdatedAt = GETUTCDATE()
    FROM
        [${flyway:defaultSchema}].[Test] AS _organicTable
    INNER JOIN
        INSERTED AS I ON
        _organicTable.[ID] = I.[ID];
END;
GO
        

/* spUpdate Permissions for MJ: Tests */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spUpdateTest] TO [cdp_Developer], [cdp_Integration]



/* spDelete SQL for MJ: Tests */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: Tests
-- Item: spDeleteTest
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- DELETE PROCEDURE FOR Test
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spDeleteTest]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spDeleteTest];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spDeleteTest]
    @ID uniqueidentifier
AS
BEGIN
    SET NOCOUNT ON;

    DELETE FROM
        [${flyway:defaultSchema}].[Test]
    WHERE
        [ID] = @ID


    -- Check if the delete was successful
    IF @@ROWCOUNT = 0
        SELECT NULL AS [ID] -- Return NULL for all primary key fields to indicate no record was deleted
    ELSE
        SELECT @ID AS [ID] -- Return the primary key values to indicate we successfully deleted the record
END
GO
GRANT EXECUTE ON [${flyway:defaultSchema}].[spDeleteTest] TO [cdp_Integration]
    

/* spDelete Permissions for MJ: Tests */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spDeleteTest] TO [cdp_Integration]



/* Set field properties for entity */

            UPDATE [${flyway:defaultSchema}].EntityField
            SET IsNameField = 1
            WHERE ID = '3F0A0E85-2F76-4CEF-B11B-82D68BE3C7DC'
            AND AutoUpdateIsNameField = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '3F0A0E85-2F76-4CEF-B11B-82D68BE3C7DC'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '94340107-B647-483D-A377-F6AE1B69E9CC'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '3E9E16F5-3120-450B-B3FD-041C1AEA446D'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '4565473C-1E86-4D73-AC1E-5ED369EE0822'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '15569044-4E7C-4722-B2D6-47D201042E84'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = 'BE67FEF8-9AE8-4BEB-A724-8AFEB9732DC3'
            AND AutoUpdateDefaultInView = 1
         

/* Set categories for 16 fields */
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Definition',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'DA709873-2485-4DF4-9CE4-B9156F0A6930'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Definition',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'EC7184C8-1675-4834-8FFB-17051DFA19A9'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Definition',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'BE67FEF8-9AE8-4BEB-A724-8AFEB9732DC3'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Definition',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '3F0A0E85-2F76-4CEF-B11B-82D68BE3C7DC'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Definition',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '099D18DA-CFFF-45FF-9AB6-96E53D0AC763'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Definition',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '94340107-B647-483D-A377-F6AE1B69E9CC'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Logic',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '10497D13-07A5-4378-B333-BA1C7E6310BC'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Logic',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '03201FF5-0D92-49C0-96C2-DA387D455CAC'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Test Logic',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'CE8574A1-32DD-4485-9EA1-EA23A6A974FA'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Execution Settings',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '3E9E16F5-3120-450B-B3FD-041C1AEA446D'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Execution Settings',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '4565473C-1E86-4D73-AC1E-5ED369EE0822'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Execution Settings',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '15569044-4E7C-4722-B2D6-47D201042E84'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Execution Settings',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '152CBD8B-04B0-4FF4-9FE1-EDAEBF4A11A4'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Execution Settings',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'BCA40242-8377-4EC4-B963-0683F608DE81'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'D67C05C2-D342-4182-A655-EE8AE8DDA9D8'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '071B36B5-96D6-4C88-A416-BDC0B0E7689B'
   AND AutoUpdateCategory = 1

/* Set entity icon to fa fa-vial */

                  UPDATE [${flyway:defaultSchema}].Entity
                  SET Icon = 'fa fa-vial',
                      __mj_UpdatedAt = GETUTCDATE()
                  WHERE ID = '1F949AD0-8C72-4846-8A0B-0B3D9F644231'
               

/* Insert FieldCategoryIcons setting for entity */

               INSERT INTO [${flyway:defaultSchema}].EntitySetting (ID, EntityID, Name, Value, __mj_CreatedAt, __mj_UpdatedAt)
               VALUES ('0F57B63C-C7F2-431A-AB59-67B2143A2D35', '1F949AD0-8C72-4846-8A0B-0B3D9F644231', 'FieldCategoryIcons', '{"Test Definition":"fa fa-file-alt","Test Logic":"fa fa-code","Execution Settings":"fa fa-sliders-h","System Metadata":"fa fa-cog"}', GETUTCDATE(), GETUTCDATE())
            

/* Generated Validation Functions for MJ: Test Run Feedbacks */
-- CHECK constraint for MJ: Test Run Feedbacks: Field: Rating was newly set or modified since the last generation of the validation function, the code was regenerated and updating the GeneratedCode table with the new generated validation function
INSERT INTO [${flyway:defaultSchema}].[GeneratedCode] (CategoryID, GeneratedByModelID, GeneratedAt, Language, Status, Source, Code, Description, Name, LinkedEntityID, LinkedRecordPrimaryKey)
                      VALUES ((SELECT ID FROM ${flyway:defaultSchema}.vwGeneratedCodeCategories WHERE Name='CodeGen: Validators'), '8E1BADD5-D593-4F9B-90D4-BF6D8AFA74A0', GETUTCDATE(), 'TypeScript','Approved', '([Rating]>=(1) AND [Rating]<=(10))', 'public ValidateRatingRange(result: ValidationResult) {
	if (this.Rating != null && (this.Rating < 1 || this.Rating > 10)) {
		result.Errors.push(new ValidationErrorInfo(
			"Rating",
			"Rating must be between 1 and 10.",
			this.Rating,
			ValidationErrorType.Failure
		));
	}
}', 'When a rating is provided, it must be a whole number from 1 up to 10. This ensures that every recorded rating falls within the allowed scoring range.', 'ValidateRatingRange', 'DF238F34-2837-EF11-86D4-6045BDEE16E6', '6237F9DB-DE75-4867-8F2D-C4F02992D728');
  
            

/* Generated Validation Functions for MJ: Tests */
-- CHECK constraint for MJ: Tests: Field: RepeatCount was newly set or modified since the last generation of the validation function, the code was regenerated and updating the GeneratedCode table with the new generated validation function
INSERT INTO [${flyway:defaultSchema}].[GeneratedCode] (CategoryID, GeneratedByModelID, GeneratedAt, Language, Status, Source, Code, Description, Name, LinkedEntityID, LinkedRecordPrimaryKey)
                      VALUES ((SELECT ID FROM ${flyway:defaultSchema}.vwGeneratedCodeCategories WHERE Name='CodeGen: Validators'), '8E1BADD5-D593-4F9B-90D4-BF6D8AFA74A0', GETUTCDATE(), 'TypeScript','Approved', '([RepeatCount] IS NULL OR [RepeatCount]>(0))', 'public ValidateRepeatCountPositive(result: ValidationResult) {
	// If a repeat count is set, it must be greater than zero
	if (this.RepeatCount != null && this.RepeatCount <= 0) {
		result.Errors.push(new ValidationErrorInfo(
			"RepeatCount",
			"Repeat count must be greater than zero if provided.",
			this.RepeatCount,
			ValidationErrorType.Failure
		));
	}
}', 'If a repeat count is entered, it must be a positive number greater than zero; otherwise it can be left empty.', 'ValidateRepeatCountPositive', 'DF238F34-2837-EF11-86D4-6045BDEE16E6', '152CBD8B-04B0-4FF4-9FE1-EDAEBF4A11A4');
  
            

