-- =============================================================================
-- Migration: Add UIConfig JSON field to APIScope entity
-- Version: 3.4.x
-- Description: Adds a UIConfig column to store UI presentation metadata like
--              icons and colors, making scope presentation configurable and
--              extensible without code changes.
--
-- UIConfig JSON Schema:
-- {
--     "icon": "fa-solid fa-database",   -- Font Awesome icon class
--     "color": "#6366f1"                 -- Hex color for the scope
-- }
-- =============================================================================

-- Add UIConfig column for UI presentation metadata
ALTER TABLE ${flyway:defaultSchema}.APIScope ADD
    UIConfig NVARCHAR(MAX) NULL;
GO

-- Add extended property to document the JSON schema
EXEC sp_addextendedproperty
    @name = N'MS_Description',
    @value = N'JSON configuration for UI presentation. Schema: { "icon": "fa-solid fa-xxx", "color": "#hexcolor" }. Icon should be a Font Awesome class. Color should be a hex color code.',
    @level0type = N'SCHEMA', @level0name = '${flyway:defaultSchema}',
    @level1type = N'TABLE',  @level1name = 'APIScope',
    @level2type = N'COLUMN', @level2name = 'UIConfig';
GO












































-- CODE GEN RUN
/* SQL text to insert new entity field */

      IF NOT EXISTS (
         SELECT 1 FROM [${flyway:defaultSchema}].EntityField 
         WHERE ID = 'ddb44426-f4ed-43c5-b1bd-c606631b32ca'  OR 
               (EntityID = '12A68DBD-84A6-4C13-9CC1-BACFCC850D9B' AND Name = 'UIConfig')
         -- check to make sure we're not inserting a duplicate entity field metadata record
      )
      BEGIN
         INSERT INTO [${flyway:defaultSchema}].EntityField
         (
            ID,
            EntityID,
            Sequence,
            Name,
            DisplayName,
            Description,
            Type,
            Length,
            Precision,
            Scale,
            AllowsNull,
            DefaultValue,
            AutoIncrement,
            AllowUpdateAPI,
            IsVirtual,
            RelatedEntityID,
            RelatedEntityFieldName,
            IsNameField,
            IncludeInUserSearchAPI,
            IncludeRelatedEntityNameFieldInBaseView,
            DefaultInView,
            IsPrimaryKey,
            IsUnique,
            RelatedEntityDisplayType
         )
         VALUES
         (
            'ddb44426-f4ed-43c5-b1bd-c606631b32ca',
            '12A68DBD-84A6-4C13-9CC1-BACFCC850D9B', -- Entity: MJ: API Scopes
            100023,
            'UIConfig',
            'UI Config',
            'JSON configuration for UI presentation. Schema: { "icon": "fa-solid fa-xxx", "color": "#hexcolor" }. Icon should be a Font Awesome class. Color should be a hex color code.',
            'nvarchar',
            -1,
            0,
            0,
            1,
            'null',
            0,
            1,
            0,
            NULL,
            NULL,
            0,
            0,
            0,
            0,
            0,
            0,
            'Search'
         )
      END

/* Index for Foreign Keys for APIScope */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: Index for Foreign Keys
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------
-- Index for foreign key ParentID in table APIScope
IF NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IDX_AUTO_MJ_FKEY_APIScope_ParentID' 
    AND object_id = OBJECT_ID('[${flyway:defaultSchema}].[APIScope]')
)
CREATE INDEX IDX_AUTO_MJ_FKEY_APIScope_ParentID ON [${flyway:defaultSchema}].[APIScope] ([ParentID]);

/* Root ID Function SQL for MJ: API Scopes.ParentID */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: fnAPIScopeParentID_GetRootID
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------
------------------------------------------------------------
----- ROOT ID FUNCTION FOR: [APIScope].[ParentID]
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[fnAPIScopeParentID_GetRootID]', 'IF') IS NOT NULL
    DROP FUNCTION [${flyway:defaultSchema}].[fnAPIScopeParentID_GetRootID];
GO

CREATE FUNCTION [${flyway:defaultSchema}].[fnAPIScopeParentID_GetRootID]
(
    @RecordID uniqueidentifier,
    @ParentID uniqueidentifier
)
RETURNS TABLE
AS
RETURN
(
    WITH CTE_RootParent AS (
        -- Anchor: Start from @ParentID if not null, otherwise start from @RecordID
        SELECT
            [ID],
            [ParentID],
            [ID] AS [RootParentID],
            0 AS [Depth]
        FROM
            [${flyway:defaultSchema}].[APIScope]
        WHERE
            [ID] = COALESCE(@ParentID, @RecordID)

        UNION ALL

        -- Recursive: Keep going up the hierarchy until ParentID is NULL
        -- Includes depth counter to prevent infinite loops from circular references
        SELECT
            c.[ID],
            c.[ParentID],
            c.[ID] AS [RootParentID],
            p.[Depth] + 1 AS [Depth]
        FROM
            [${flyway:defaultSchema}].[APIScope] c
        INNER JOIN
            CTE_RootParent p ON c.[ID] = p.[ParentID]
        WHERE
            p.[Depth] < 100  -- Prevent infinite loops, max 100 levels
    )
    SELECT TOP 1
        [RootParentID] AS RootID
    FROM
        CTE_RootParent
    WHERE
        [ParentID] IS NULL
    ORDER BY
        [RootParentID]
);
GO


/* Base View SQL for MJ: API Scopes */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: vwAPIScopes
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- BASE VIEW FOR ENTITY:      MJ: API Scopes
-----               SCHEMA:      ${flyway:defaultSchema}
-----               BASE TABLE:  APIScope
-----               PRIMARY KEY: ID
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[vwAPIScopes]', 'V') IS NOT NULL
    DROP VIEW [${flyway:defaultSchema}].[vwAPIScopes];
GO

CREATE VIEW [${flyway:defaultSchema}].[vwAPIScopes]
AS
SELECT
    a.*,
    APIScope_ParentID.[Name] AS [Parent],
    root_ParentID.RootID AS [RootParentID]
FROM
    [${flyway:defaultSchema}].[APIScope] AS a
LEFT OUTER JOIN
    [${flyway:defaultSchema}].[APIScope] AS APIScope_ParentID
  ON
    [a].[ParentID] = APIScope_ParentID.[ID]
OUTER APPLY
    [${flyway:defaultSchema}].[fnAPIScopeParentID_GetRootID]([a].[ID], [a].[ParentID]) AS root_ParentID
GO
GRANT SELECT ON [${flyway:defaultSchema}].[vwAPIScopes] TO [cdp_UI], [cdp_Developer], [cdp_Integration]
    

/* Base View Permissions SQL for MJ: API Scopes */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: Permissions for vwAPIScopes
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

GRANT SELECT ON [${flyway:defaultSchema}].[vwAPIScopes] TO [cdp_UI], [cdp_Developer], [cdp_Integration]

/* spCreate SQL for MJ: API Scopes */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: spCreateAPIScope
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- CREATE PROCEDURE FOR APIScope
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spCreateAPIScope]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spCreateAPIScope];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spCreateAPIScope]
    @ID uniqueidentifier = NULL,
    @Name nvarchar(100),
    @Category nvarchar(100),
    @Description nvarchar(500),
    @ParentID uniqueidentifier,
    @FullPath nvarchar(500),
    @ResourceType nvarchar(50),
    @IsActive bit = NULL,
    @UIConfig nvarchar(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @InsertedRow TABLE ([ID] UNIQUEIDENTIFIER)
    
    IF @ID IS NOT NULL
    BEGIN
        -- User provided a value, use it
        INSERT INTO [${flyway:defaultSchema}].[APIScope]
            (
                [ID],
                [Name],
                [Category],
                [Description],
                [ParentID],
                [FullPath],
                [ResourceType],
                [IsActive],
                [UIConfig]
            )
        OUTPUT INSERTED.[ID] INTO @InsertedRow
        VALUES
            (
                @ID,
                @Name,
                @Category,
                @Description,
                @ParentID,
                @FullPath,
                @ResourceType,
                ISNULL(@IsActive, 1),
                @UIConfig
            )
    END
    ELSE
    BEGIN
        -- No value provided, let database use its default (e.g., NEWSEQUENTIALID())
        INSERT INTO [${flyway:defaultSchema}].[APIScope]
            (
                [Name],
                [Category],
                [Description],
                [ParentID],
                [FullPath],
                [ResourceType],
                [IsActive],
                [UIConfig]
            )
        OUTPUT INSERTED.[ID] INTO @InsertedRow
        VALUES
            (
                @Name,
                @Category,
                @Description,
                @ParentID,
                @FullPath,
                @ResourceType,
                ISNULL(@IsActive, 1),
                @UIConfig
            )
    END
    -- return the new record from the base view, which might have some calculated fields
    SELECT * FROM [${flyway:defaultSchema}].[vwAPIScopes] WHERE [ID] = (SELECT [ID] FROM @InsertedRow)
END
GO
GRANT EXECUTE ON [${flyway:defaultSchema}].[spCreateAPIScope] TO [cdp_Developer], [cdp_Integration]
    

/* spCreate Permissions for MJ: API Scopes */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spCreateAPIScope] TO [cdp_Developer], [cdp_Integration]



/* spUpdate SQL for MJ: API Scopes */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: spUpdateAPIScope
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- UPDATE PROCEDURE FOR APIScope
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spUpdateAPIScope]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spUpdateAPIScope];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spUpdateAPIScope]
    @ID uniqueidentifier,
    @Name nvarchar(100),
    @Category nvarchar(100),
    @Description nvarchar(500),
    @ParentID uniqueidentifier,
    @FullPath nvarchar(500),
    @ResourceType nvarchar(50),
    @IsActive bit,
    @UIConfig nvarchar(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [${flyway:defaultSchema}].[APIScope]
    SET
        [Name] = @Name,
        [Category] = @Category,
        [Description] = @Description,
        [ParentID] = @ParentID,
        [FullPath] = @FullPath,
        [ResourceType] = @ResourceType,
        [IsActive] = @IsActive,
        [UIConfig] = @UIConfig
    WHERE
        [ID] = @ID

    -- Check if the update was successful
    IF @@ROWCOUNT = 0
        -- Nothing was updated, return no rows, but column structure from base view intact, semantically correct this way.
        SELECT TOP 0 * FROM [${flyway:defaultSchema}].[vwAPIScopes] WHERE 1=0
    ELSE
        -- Return the updated record so the caller can see the updated values and any calculated fields
        SELECT
                                        *
                                    FROM
                                        [${flyway:defaultSchema}].[vwAPIScopes]
                                    WHERE
                                        [ID] = @ID
                                    
END
GO

GRANT EXECUTE ON [${flyway:defaultSchema}].[spUpdateAPIScope] TO [cdp_Developer], [cdp_Integration]
GO

------------------------------------------------------------
----- TRIGGER FOR __mj_UpdatedAt field for the APIScope table
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[trgUpdateAPIScope]', 'TR') IS NOT NULL
    DROP TRIGGER [${flyway:defaultSchema}].[trgUpdateAPIScope];
GO
CREATE TRIGGER [${flyway:defaultSchema}].trgUpdateAPIScope
ON [${flyway:defaultSchema}].[APIScope]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [${flyway:defaultSchema}].[APIScope]
    SET
        __mj_UpdatedAt = GETUTCDATE()
    FROM
        [${flyway:defaultSchema}].[APIScope] AS _organicTable
    INNER JOIN
        INSERTED AS I ON
        _organicTable.[ID] = I.[ID];
END;
GO
        

/* spUpdate Permissions for MJ: API Scopes */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spUpdateAPIScope] TO [cdp_Developer], [cdp_Integration]



/* spDelete SQL for MJ: API Scopes */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: API Scopes
-- Item: spDeleteAPIScope
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- DELETE PROCEDURE FOR APIScope
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spDeleteAPIScope]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spDeleteAPIScope];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spDeleteAPIScope]
    @ID uniqueidentifier
AS
BEGIN
    SET NOCOUNT ON;

    DELETE FROM
        [${flyway:defaultSchema}].[APIScope]
    WHERE
        [ID] = @ID


    -- Check if the delete was successful
    IF @@ROWCOUNT = 0
        SELECT NULL AS [ID] -- Return NULL for all primary key fields to indicate no record was deleted
    ELSE
        SELECT @ID AS [ID] -- Return the primary key values to indicate we successfully deleted the record
END
GO
GRANT EXECUTE ON [${flyway:defaultSchema}].[spDeleteAPIScope] TO [cdp_Integration]
    

/* spDelete Permissions for MJ: API Scopes */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spDeleteAPIScope] TO [cdp_Integration]



/* Set field properties for entity */

            UPDATE [${flyway:defaultSchema}].EntityField
            SET IsNameField = 1
            WHERE ID = '88167D70-305F-4D45-A847-FFCE13C0043D'
            AND AutoUpdateIsNameField = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '88167D70-305F-4D45-A847-FFCE13C0043D'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = 'CED10C09-DAF0-4301-BB54-FE877FF2F6D6'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '80DAE0F3-3DAE-49C5-9FFC-C491C00BC67B'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = 'E82768CA-02AC-4D80-A3BE-28BA985A5551'
            AND AutoUpdateDefaultInView = 1
         

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '88167D70-305F-4D45-A847-FFCE13C0043D'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = 'CED10C09-DAF0-4301-BB54-FE877FF2F6D6'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '80DAE0F3-3DAE-49C5-9FFC-C491C00BC67B'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = 'A4F7D024-0661-4F4B-99DD-3C121EAFA8A2'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '7C99F86D-E060-42F4-8FDC-18603B470169'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

/* Set categories for 13 fields */
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'ID',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '80CAFD84-016C-489E-9F81-9B105A19BCC3'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'Created At',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '782493FA-A14C-4DEB-96B3-D9178CA23A5D'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'Updated At',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '1EDE7763-3304-41F9-86C0-1BDF42F77EAD'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Definition',
       GeneratedFormSection = 'Category',
       DisplayName = 'Name',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '88167D70-305F-4D45-A847-FFCE13C0043D'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Definition',
       GeneratedFormSection = 'Category',
       DisplayName = 'Category',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'CED10C09-DAF0-4301-BB54-FE877FF2F6D6'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Definition',
       GeneratedFormSection = 'Category',
       DisplayName = 'Description',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '80DAE0F3-3DAE-49C5-9FFC-C491C00BC67B'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Definition',
       GeneratedFormSection = 'Category',
       DisplayName = 'UI Config',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'DDB44426-F4ED-43C5-B1BD-C606631B32CA'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Hierarchy',
       GeneratedFormSection = 'Category',
       DisplayName = 'Parent ID',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'F268FAAF-E9CA-4467-9621-827EDCCD71C0'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Hierarchy',
       GeneratedFormSection = 'Category',
       DisplayName = 'Full Path',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'A4F7D024-0661-4F4B-99DD-3C121EAFA8A2'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Hierarchy',
       GeneratedFormSection = 'Category',
       DisplayName = 'Resource Type',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '7C99F86D-E060-42F4-8FDC-18603B470169'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Hierarchy',
       GeneratedFormSection = 'Category',
       DisplayName = 'Active',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'E82768CA-02AC-4D80-A3BE-28BA985A5551'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Hierarchy',
       GeneratedFormSection = 'Category',
       DisplayName = 'Parent',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'D621233D-81AD-4351-B4C7-35176D87D009'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Scope Hierarchy',
       GeneratedFormSection = 'Category',
       DisplayName = 'Root Parent ID',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'AD53CF84-9B40-4BD7-AA05-70D63009D90D'
   AND AutoUpdateCategory = 1

/* Update FieldCategoryInfo setting for entity */

               UPDATE [${flyway:defaultSchema}].EntitySetting
               SET Value = '{"Scope Hierarchy":{"icon":"fa fa-sitemap","description":"Defines hierarchical relationships and core attributes of permission scopes"},"Scope Definition":{"icon":"fa fa-key","description":"Core details of the permission scope including its name, category, and description"},"System Metadata":{"icon":"fa fa-cog","description":"Technical audit fields and primary identifier"}}',
                   __mj_UpdatedAt = GETUTCDATE()
               WHERE EntityID = '12A68DBD-84A6-4C13-9CC1-BACFCC850D9B' AND Name = 'FieldCategoryInfo'
            

/* Update FieldCategoryIcons setting for entity (legacy format) */

               UPDATE [${flyway:defaultSchema}].EntitySetting
               SET Value = '{"Scope Hierarchy":"fa fa-sitemap","Scope Definition":"fa fa-key","System Metadata":"fa fa-cog"}',
                   __mj_UpdatedAt = GETUTCDATE()
               WHERE EntityID = '12A68DBD-84A6-4C13-9CC1-BACFCC850D9B' AND Name = 'FieldCategoryIcons'
            

