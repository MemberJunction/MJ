/*
    Migration: Make MCPServerConnection.CompanyID nullable

    This allows MCP connections to be created without a company assignment,
    making them "global" connections available to all companies.
    NULL CompanyID = global/shared connection
    Non-NULL CompanyID = company-specific connection
*/


-- NEED R Scripts here since we're modifying tables modified in the last migraiton that is
-- also part of 3.3
/* SQL text to recompile all views */
EXEC [${flyway:defaultSchema}].spRecompileAllViews

/* SQL text to update existing entities from schema */
EXEC [${flyway:defaultSchema}].spUpdateExistingEntitiesFromSchema @ExcludedSchemaNames='sys,staging'

/* SQL text to sync schema info from database schemas */
EXEC [${flyway:defaultSchema}].spUpdateSchemaInfoFromDatabase @ExcludedSchemaNames='sys,staging'

/* SQL text to delete unneeded entity fields */
EXEC [${flyway:defaultSchema}].spDeleteUnneededEntityFields @ExcludedSchemaNames='sys,staging'

/* SQL text to update existing entity fields from schema */
EXEC [${flyway:defaultSchema}].spUpdateExistingEntityFieldsFromSchema @ExcludedSchemaNames='sys,staging'

/* SQL text to set default column width where needed */
EXEC [${flyway:defaultSchema}].spSetDefaultColumnWidthWhereNeeded @ExcludedSchemaNames='sys,staging'

/* SQL text to recompile all stored procedures in dependency order */
EXEC [${flyway:defaultSchema}].spRecompileAllProceduresInDependencyOrder @ExcludedSchemaNames='sys,staging', @LogOutput=0, @ContinueOnError=1

GO
-- Make CompanyID nullable on MCPServerConnection table
ALTER TABLE ${flyway:defaultSchema}.MCPServerConnection
    ALTER COLUMN CompanyID UNIQUEIDENTIFIER NULL;

-- Update extended property (column description) for CompanyID
-- Drop existing description if it exists
IF EXISTS (
    SELECT 1 FROM sys.extended_properties ep
    INNER JOIN sys.columns c ON ep.major_id = c.object_id AND ep.minor_id = c.column_id
    INNER JOIN sys.tables t ON c.object_id = t.object_id
    INNER JOIN sys.schemas s ON t.schema_id = s.schema_id
    WHERE s.name = '${flyway:defaultSchema}'
      AND t.name = 'MCPServerConnection'
      AND c.name = 'CompanyID'
      AND ep.name = 'MS_Description'
)
BEGIN
    EXEC sp_dropextendedproperty
        @name = N'MS_Description',
        @level0type = N'SCHEMA', @level0name = N'${flyway:defaultSchema}',
        @level1type = N'TABLE',  @level1name = N'MCPServerConnection',
        @level2type = N'COLUMN', @level2name = N'CompanyID';
END

-- Add updated description indicating nullable behavior
EXEC sp_addextendedproperty
    @name = N'MS_Description',
    @value = N'Optional company association. NULL means the connection is global and available to all companies. Non-NULL restricts the connection to that specific company.',
    @level0type = N'SCHEMA', @level0name = N'${flyway:defaultSchema}',
    @level1type = N'TABLE',  @level1name = N'MCPServerConnection',
    @level2type = N'COLUMN', @level2name = N'CompanyID';

















































-- CODE GEN RUN 
/* Index for Foreign Keys for MCPServerConnection */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: MCP Server Connections
-- Item: Index for Foreign Keys
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------
-- Index for foreign key MCPServerID in table MCPServerConnection
IF NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IDX_AUTO_MJ_FKEY_MCPServerConnection_MCPServerID' 
    AND object_id = OBJECT_ID('[${flyway:defaultSchema}].[MCPServerConnection]')
)
CREATE INDEX IDX_AUTO_MJ_FKEY_MCPServerConnection_MCPServerID ON [${flyway:defaultSchema}].[MCPServerConnection] ([MCPServerID]);

-- Index for foreign key CredentialID in table MCPServerConnection
IF NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IDX_AUTO_MJ_FKEY_MCPServerConnection_CredentialID' 
    AND object_id = OBJECT_ID('[${flyway:defaultSchema}].[MCPServerConnection]')
)
CREATE INDEX IDX_AUTO_MJ_FKEY_MCPServerConnection_CredentialID ON [${flyway:defaultSchema}].[MCPServerConnection] ([CredentialID]);

-- Index for foreign key CompanyID in table MCPServerConnection
IF NOT EXISTS (
    SELECT 1
    FROM sys.indexes
    WHERE name = 'IDX_AUTO_MJ_FKEY_MCPServerConnection_CompanyID' 
    AND object_id = OBJECT_ID('[${flyway:defaultSchema}].[MCPServerConnection]')
)
CREATE INDEX IDX_AUTO_MJ_FKEY_MCPServerConnection_CompanyID ON [${flyway:defaultSchema}].[MCPServerConnection] ([CompanyID]);

/* Base View SQL for MJ: MCP Server Connections */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: MCP Server Connections
-- Item: vwMCPServerConnections
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- BASE VIEW FOR ENTITY:      MJ: MCP Server Connections
-----               SCHEMA:      ${flyway:defaultSchema}
-----               BASE TABLE:  MCPServerConnection
-----               PRIMARY KEY: ID
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[vwMCPServerConnections]', 'V') IS NOT NULL
    DROP VIEW [${flyway:defaultSchema}].[vwMCPServerConnections];
GO

CREATE VIEW [${flyway:defaultSchema}].[vwMCPServerConnections]
AS
SELECT
    m.*,
    MCPServer_MCPServerID.[Name] AS [MCPServer],
    Credential_CredentialID.[Name] AS [Credential],
    Company_CompanyID.[Name] AS [Company]
FROM
    [${flyway:defaultSchema}].[MCPServerConnection] AS m
INNER JOIN
    [${flyway:defaultSchema}].[MCPServer] AS MCPServer_MCPServerID
  ON
    [m].[MCPServerID] = MCPServer_MCPServerID.[ID]
LEFT OUTER JOIN
    [${flyway:defaultSchema}].[Credential] AS Credential_CredentialID
  ON
    [m].[CredentialID] = Credential_CredentialID.[ID]
LEFT OUTER JOIN
    [${flyway:defaultSchema}].[Company] AS Company_CompanyID
  ON
    [m].[CompanyID] = Company_CompanyID.[ID]
GO
GRANT SELECT ON [${flyway:defaultSchema}].[vwMCPServerConnections] TO [cdp_UI], [cdp_Developer], [cdp_Integration]
    

/* Base View Permissions SQL for MJ: MCP Server Connections */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: MCP Server Connections
-- Item: Permissions for vwMCPServerConnections
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

GRANT SELECT ON [${flyway:defaultSchema}].[vwMCPServerConnections] TO [cdp_UI], [cdp_Developer], [cdp_Integration]

/* spCreate SQL for MJ: MCP Server Connections */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: MCP Server Connections
-- Item: spCreateMCPServerConnection
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- CREATE PROCEDURE FOR MCPServerConnection
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spCreateMCPServerConnection]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spCreateMCPServerConnection];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spCreateMCPServerConnection]
    @ID uniqueidentifier = NULL,
    @MCPServerID uniqueidentifier,
    @Name nvarchar(255),
    @Description nvarchar(MAX),
    @CredentialID uniqueidentifier,
    @CustomHeaderName nvarchar(100),
    @CompanyID uniqueidentifier,
    @Status nvarchar(50) = NULL,
    @AutoSyncTools bit = NULL,
    @AutoGenerateActions bit = NULL,
    @LogToolCalls bit = NULL,
    @LogInputParameters bit = NULL,
    @LogOutputContent bit = NULL,
    @MaxOutputLogSize int,
    @LastConnectedAt datetimeoffset,
    @LastErrorMessage nvarchar(MAX),
    @EnvironmentVars nvarchar(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @InsertedRow TABLE ([ID] UNIQUEIDENTIFIER)
    
    IF @ID IS NOT NULL
    BEGIN
        -- User provided a value, use it
        INSERT INTO [${flyway:defaultSchema}].[MCPServerConnection]
            (
                [ID],
                [MCPServerID],
                [Name],
                [Description],
                [CredentialID],
                [CustomHeaderName],
                [CompanyID],
                [Status],
                [AutoSyncTools],
                [AutoGenerateActions],
                [LogToolCalls],
                [LogInputParameters],
                [LogOutputContent],
                [MaxOutputLogSize],
                [LastConnectedAt],
                [LastErrorMessage],
                [EnvironmentVars]
            )
        OUTPUT INSERTED.[ID] INTO @InsertedRow
        VALUES
            (
                @ID,
                @MCPServerID,
                @Name,
                @Description,
                @CredentialID,
                @CustomHeaderName,
                @CompanyID,
                ISNULL(@Status, 'Active'),
                ISNULL(@AutoSyncTools, 1),
                ISNULL(@AutoGenerateActions, 0),
                ISNULL(@LogToolCalls, 1),
                ISNULL(@LogInputParameters, 1),
                ISNULL(@LogOutputContent, 1),
                @MaxOutputLogSize,
                @LastConnectedAt,
                @LastErrorMessage,
                @EnvironmentVars
            )
    END
    ELSE
    BEGIN
        -- No value provided, let database use its default (e.g., NEWSEQUENTIALID())
        INSERT INTO [${flyway:defaultSchema}].[MCPServerConnection]
            (
                [MCPServerID],
                [Name],
                [Description],
                [CredentialID],
                [CustomHeaderName],
                [CompanyID],
                [Status],
                [AutoSyncTools],
                [AutoGenerateActions],
                [LogToolCalls],
                [LogInputParameters],
                [LogOutputContent],
                [MaxOutputLogSize],
                [LastConnectedAt],
                [LastErrorMessage],
                [EnvironmentVars]
            )
        OUTPUT INSERTED.[ID] INTO @InsertedRow
        VALUES
            (
                @MCPServerID,
                @Name,
                @Description,
                @CredentialID,
                @CustomHeaderName,
                @CompanyID,
                ISNULL(@Status, 'Active'),
                ISNULL(@AutoSyncTools, 1),
                ISNULL(@AutoGenerateActions, 0),
                ISNULL(@LogToolCalls, 1),
                ISNULL(@LogInputParameters, 1),
                ISNULL(@LogOutputContent, 1),
                @MaxOutputLogSize,
                @LastConnectedAt,
                @LastErrorMessage,
                @EnvironmentVars
            )
    END
    -- return the new record from the base view, which might have some calculated fields
    SELECT * FROM [${flyway:defaultSchema}].[vwMCPServerConnections] WHERE [ID] = (SELECT [ID] FROM @InsertedRow)
END
GO
GRANT EXECUTE ON [${flyway:defaultSchema}].[spCreateMCPServerConnection] TO [cdp_Developer], [cdp_Integration]
    

/* spCreate Permissions for MJ: MCP Server Connections */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spCreateMCPServerConnection] TO [cdp_Developer], [cdp_Integration]



/* spUpdate SQL for MJ: MCP Server Connections */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: MCP Server Connections
-- Item: spUpdateMCPServerConnection
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- UPDATE PROCEDURE FOR MCPServerConnection
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spUpdateMCPServerConnection]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spUpdateMCPServerConnection];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spUpdateMCPServerConnection]
    @ID uniqueidentifier,
    @MCPServerID uniqueidentifier,
    @Name nvarchar(255),
    @Description nvarchar(MAX),
    @CredentialID uniqueidentifier,
    @CustomHeaderName nvarchar(100),
    @CompanyID uniqueidentifier,
    @Status nvarchar(50),
    @AutoSyncTools bit,
    @AutoGenerateActions bit,
    @LogToolCalls bit,
    @LogInputParameters bit,
    @LogOutputContent bit,
    @MaxOutputLogSize int,
    @LastConnectedAt datetimeoffset,
    @LastErrorMessage nvarchar(MAX),
    @EnvironmentVars nvarchar(MAX)
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [${flyway:defaultSchema}].[MCPServerConnection]
    SET
        [MCPServerID] = @MCPServerID,
        [Name] = @Name,
        [Description] = @Description,
        [CredentialID] = @CredentialID,
        [CustomHeaderName] = @CustomHeaderName,
        [CompanyID] = @CompanyID,
        [Status] = @Status,
        [AutoSyncTools] = @AutoSyncTools,
        [AutoGenerateActions] = @AutoGenerateActions,
        [LogToolCalls] = @LogToolCalls,
        [LogInputParameters] = @LogInputParameters,
        [LogOutputContent] = @LogOutputContent,
        [MaxOutputLogSize] = @MaxOutputLogSize,
        [LastConnectedAt] = @LastConnectedAt,
        [LastErrorMessage] = @LastErrorMessage,
        [EnvironmentVars] = @EnvironmentVars
    WHERE
        [ID] = @ID

    -- Check if the update was successful
    IF @@ROWCOUNT = 0
        -- Nothing was updated, return no rows, but column structure from base view intact, semantically correct this way.
        SELECT TOP 0 * FROM [${flyway:defaultSchema}].[vwMCPServerConnections] WHERE 1=0
    ELSE
        -- Return the updated record so the caller can see the updated values and any calculated fields
        SELECT
                                        *
                                    FROM
                                        [${flyway:defaultSchema}].[vwMCPServerConnections]
                                    WHERE
                                        [ID] = @ID
                                    
END
GO

GRANT EXECUTE ON [${flyway:defaultSchema}].[spUpdateMCPServerConnection] TO [cdp_Developer], [cdp_Integration]
GO

------------------------------------------------------------
----- TRIGGER FOR __mj_UpdatedAt field for the MCPServerConnection table
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[trgUpdateMCPServerConnection]', 'TR') IS NOT NULL
    DROP TRIGGER [${flyway:defaultSchema}].[trgUpdateMCPServerConnection];
GO
CREATE TRIGGER [${flyway:defaultSchema}].trgUpdateMCPServerConnection
ON [${flyway:defaultSchema}].[MCPServerConnection]
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE
        [${flyway:defaultSchema}].[MCPServerConnection]
    SET
        __mj_UpdatedAt = GETUTCDATE()
    FROM
        [${flyway:defaultSchema}].[MCPServerConnection] AS _organicTable
    INNER JOIN
        INSERTED AS I ON
        _organicTable.[ID] = I.[ID];
END;
GO
        

/* spUpdate Permissions for MJ: MCP Server Connections */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spUpdateMCPServerConnection] TO [cdp_Developer], [cdp_Integration]



/* spDelete SQL for MJ: MCP Server Connections */
-----------------------------------------------------------------
-- SQL Code Generation
-- Entity: MJ: MCP Server Connections
-- Item: spDeleteMCPServerConnection
--
-- This was generated by the MemberJunction CodeGen tool.
-- This file should NOT be edited by hand.
-----------------------------------------------------------------

------------------------------------------------------------
----- DELETE PROCEDURE FOR MCPServerConnection
------------------------------------------------------------
IF OBJECT_ID('[${flyway:defaultSchema}].[spDeleteMCPServerConnection]', 'P') IS NOT NULL
    DROP PROCEDURE [${flyway:defaultSchema}].[spDeleteMCPServerConnection];
GO

CREATE PROCEDURE [${flyway:defaultSchema}].[spDeleteMCPServerConnection]
    @ID uniqueidentifier
AS
BEGIN
    SET NOCOUNT ON;

    DELETE FROM
        [${flyway:defaultSchema}].[MCPServerConnection]
    WHERE
        [ID] = @ID


    -- Check if the delete was successful
    IF @@ROWCOUNT = 0
        SELECT NULL AS [ID] -- Return NULL for all primary key fields to indicate no record was deleted
    ELSE
        SELECT @ID AS [ID] -- Return the primary key values to indicate we successfully deleted the record
END
GO
GRANT EXECUTE ON [${flyway:defaultSchema}].[spDeleteMCPServerConnection] TO [cdp_Integration]
    

/* spDelete Permissions for MJ: MCP Server Connections */

GRANT EXECUTE ON [${flyway:defaultSchema}].[spDeleteMCPServerConnection] TO [cdp_Integration]



/* Set field properties for entity */

            UPDATE [${flyway:defaultSchema}].EntityField
            SET IsNameField = 1
            WHERE ID = '5C3060FB-4452-49AB-9676-B04D70984EBF'
            AND AutoUpdateIsNameField = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '5C3060FB-4452-49AB-9676-B04D70984EBF'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '186B11DF-17C4-42D6-B2F6-E43487676CBB'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '0D0BE912-9199-454D-9B38-EF8D9BC263EB'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '5775ABE3-B2A0-481D-ABF1-D9CDAE02A47C'
            AND AutoUpdateDefaultInView = 1
         

            UPDATE [${flyway:defaultSchema}].EntityField
            SET DefaultInView = 1
            WHERE ID = '329B7D4A-90D1-448B-B038-06336EF17430'
            AND AutoUpdateDefaultInView = 1
         

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '5C3060FB-4452-49AB-9676-B04D70984EBF'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '9B7B1708-0D1F-4709-B7EE-590F767FF00F'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '186B11DF-17C4-42D6-B2F6-E43487676CBB'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '5775ABE3-B2A0-481D-ABF1-D9CDAE02A47C'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

               UPDATE [${flyway:defaultSchema}].EntityField
               SET IncludeInUserSearchAPI = 1
               WHERE ID = '329B7D4A-90D1-448B-B038-06336EF17430'
               AND AutoUpdateIncludeInUserSearchAPI = 1
            

/* Set categories for 22 fields */
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'ID',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '8E03C4ED-7241-45F5-A137-804A3587AE97'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'MCP Server',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'A6FB5009-4AD9-46E3-B065-89C65C960ECA'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'Created At',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'E3E4CD06-8DBA-4B1A-8F2A-34C2CCB97005'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'System Metadata',
       GeneratedFormSection = 'Category',
       DisplayName = 'Updated At',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '6C132D9A-5241-47D6-A57D-67A398D20D80'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Name',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '5C3060FB-4452-49AB-9676-B04D70984EBF'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Description',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '9B7B1708-0D1F-4709-B7EE-590F767FF00F'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Credential',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'EA1449B1-8C00-47C8-BEA2-6AC5D3577D93'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Custom Header Name',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '1D268066-6033-4E98-9301-7730E4D9411F'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Company',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'A9C55B4E-F9F7-462B-8A5C-4057EE1CB045'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Environment Variables',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '84963B3B-AFAB-4439-A157-AD92E789CB5F'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'MCP Server',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '5775ABE3-B2A0-481D-ABF1-D9CDAE02A47C'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Credential',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'D531C558-1373-4EE6-9E95-B23CE1874E39'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Connection Settings',
       GeneratedFormSection = 'Category',
       DisplayName = 'Company',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '329B7D4A-90D1-448B-B038-06336EF17430'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Automation Controls',
       GeneratedFormSection = 'Category',
       DisplayName = 'Status',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '186B11DF-17C4-42D6-B2F6-E43487676CBB'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Automation Controls',
       GeneratedFormSection = 'Category',
       DisplayName = 'Auto Sync Tools',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '75E1303B-7259-424A-91B0-9B0E61EF79AF'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Automation Controls',
       GeneratedFormSection = 'Category',
       DisplayName = 'Auto Generate Actions',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '24AFD7B6-E8A0-4382-BA9B-7FAC3524926B'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Logging & Diagnostics',
       GeneratedFormSection = 'Category',
       DisplayName = 'Log Tool Calls',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '7F1D2D0B-C3EB-404B-8897-0CA88AEA71F4'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Logging & Diagnostics',
       GeneratedFormSection = 'Category',
       DisplayName = 'Log Input Parameters',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'ABA1E592-3EBF-410C-8570-8151F625DB0B'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Logging & Diagnostics',
       GeneratedFormSection = 'Category',
       DisplayName = 'Log Output Content',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'B7597C16-071C-492A-ABEB-2E995294E19E'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Logging & Diagnostics',
       GeneratedFormSection = 'Category',
       DisplayName = 'Max Output Log Size',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = 'C95BB71F-E892-46A2-8391-90DA9DE7467B'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Logging & Diagnostics',
       GeneratedFormSection = 'Category',
       DisplayName = 'Last Connected At',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '0D0BE912-9199-454D-9B38-EF8D9BC263EB'
   AND AutoUpdateCategory = 1
UPDATE [${flyway:defaultSchema}].EntityField
   SET Category = 'Logging & Diagnostics',
       GeneratedFormSection = 'Category',
       DisplayName = 'Last Error Message',
       ExtendedType = NULL,
       CodeType = NULL
   WHERE ID = '987CA39C-8B2C-4514-978D-E82D28443D73'
   AND AutoUpdateCategory = 1

/* Update FieldCategoryInfo setting for entity */

               UPDATE [${flyway:defaultSchema}].EntitySetting
               SET Value = '{"Connection Settings":{"icon":"fa fa-plug","description":"Core configuration of the MCP connection, including name, server address, credentials, and environment variables."},"Automation Controls":{"icon":"fa fa-robot","description":"Settings that control automatic synchronization and action generation for the connection."},"Logging & Diagnostics":{"icon":"fa fa-file-alt","description":"Options and information for logging tool activity, parameters, output, and connection health."},"System Metadata":{"icon":"fa fa-cog","description":"System-managed audit fields such as IDs and timestamps."}}',
                   __mj_UpdatedAt = GETUTCDATE()
               WHERE EntityID = '3C4E0E5F-5FF1-4918-9A28-CF21E48E532E' AND Name = 'FieldCategoryInfo'
            

/* Update FieldCategoryIcons setting for entity (legacy format) */

               UPDATE [${flyway:defaultSchema}].EntitySetting
               SET Value = '{"Connection Settings":"fa fa-plug","Automation Controls":"fa fa-robot","Logging & Diagnostics":"fa fa-file-alt","System Metadata":"fa fa-cog"}',
                   __mj_UpdatedAt = GETUTCDATE()
               WHERE EntityID = '3C4E0E5F-5FF1-4918-9A28-CF21E48E532E' AND Name = 'FieldCategoryIcons'
            

