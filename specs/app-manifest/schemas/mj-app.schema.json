{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schema.memberjunction.org/mj-app/v1.json",
  "title": "MJ Open App Manifest",
  "description": "Schema for the mj-app.json manifest file that defines a MemberJunction Open App",
  "type": "object",
  "required": ["name", "displayName", "description", "version", "publisher", "repository", "mjVersionRange", "metadata", "packages"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema URL for validation"
    },
    "name": {
      "type": "string",
      "description": "Unique app identifier. Lowercase alphanumeric characters and hyphens only.",
      "pattern": "^[a-z][a-z0-9-]{1,62}[a-z0-9]$",
      "minLength": 3,
      "maxLength": 64,
      "examples": ["acme-crm", "helpdesk", "analytics-pro"]
    },
    "displayName": {
      "type": "string",
      "description": "Human-readable app name for display in UI and MJ Central",
      "minLength": 2,
      "maxLength": 200,
      "examples": ["Acme CRM", "Helpdesk Pro"]
    },
    "description": {
      "type": "string",
      "description": "Short description of what the app does",
      "minLength": 10,
      "maxLength": 500
    },
    "version": {
      "type": "string",
      "description": "Semantic version. Must match the GitHub release tag (without the 'v' prefix).",
      "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$",
      "examples": ["1.0.0", "2.1.3", "1.0.0-beta.1"]
    },
    "license": {
      "type": "string",
      "description": "SPDX license identifier",
      "examples": ["MIT", "Apache-2.0", "ISC", "UNLICENSED"]
    },
    "icon": {
      "type": "string",
      "description": "Font Awesome icon class for UI display",
      "examples": ["fa-solid fa-handshake", "fa-solid fa-chart-line"]
    },
    "color": {
      "type": "string",
      "description": "Hex color for UI theming",
      "pattern": "^#[0-9a-fA-F]{6}$",
      "examples": ["#2196f3", "#4caf50"]
    },
    "publisher": {
      "type": "object",
      "description": "Information about the app publisher",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Publisher display name",
          "minLength": 1,
          "maxLength": 200
        },
        "email": {
          "type": "string",
          "description": "Publisher contact email",
          "format": "email"
        },
        "url": {
          "type": "string",
          "description": "Publisher website URL",
          "format": "uri"
        }
      }
    },
    "repository": {
      "type": "string",
      "description": "GitHub repository URL (HTTPS format)",
      "format": "uri",
      "pattern": "^https://github\\.com/.+/.+$",
      "examples": ["https://github.com/acme/mj-crm"]
    },
    "mjVersionRange": {
      "type": "string",
      "description": "Semver range of compatible MemberJunction versions",
      "examples": [">=4.0.0 <5.0.0", "^4.2.0", ">=4.0.0"]
    },
    "schema": {
      "type": "object",
      "description": "Database schema configuration for the app",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "SQL Server schema name. Must be unique across all installed apps.",
          "pattern": "^[a-z][a-z0-9_]{1,126}[a-z0-9]$",
          "minLength": 3,
          "maxLength": 128,
          "examples": ["acme_crm", "oss_analytics"]
        },
        "createIfNotExists": {
          "type": "boolean",
          "description": "Whether the CLI should create the schema if it does not exist",
          "default": true
        }
      }
    },
    "migrations": {
      "type": "object",
      "description": "Database migration configuration",
      "additionalProperties": false,
      "properties": {
        "directory": {
          "type": "string",
          "description": "Relative path to the migrations directory from repo root",
          "default": "migrations"
        },
        "engine": {
          "type": "string",
          "description": "Migration engine to use",
          "enum": ["flyway"],
          "default": "flyway"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Metadata packaging configuration",
      "additionalProperties": false,
      "properties": {
        "directory": {
          "type": "string",
          "description": "Relative path to the metadata directory from repo root",
          "default": "metadata"
        },
        "schemaAutoAddEntities": {
          "type": "boolean",
          "description": "Auto-register new entities in the app's Application record",
          "default": true
        }
      }
    },
    "packages": {
      "type": "object",
      "description": "NPM package definitions for the app",
      "additionalProperties": false,
      "properties": {
        "registry": {
          "type": "string",
          "description": "NPM registry URL. Defaults to public npm registry.",
          "format": "uri",
          "default": "https://registry.npmjs.org"
        },
        "server": {
          "type": "array",
          "description": "Server-side npm packages",
          "items": { "$ref": "#/$defs/packageEntry" }
        },
        "client": {
          "type": "array",
          "description": "Client-side npm packages (Angular, React, etc.)",
          "items": { "$ref": "#/$defs/packageEntry" }
        },
        "shared": {
          "type": "array",
          "description": "Packages shared between server and client",
          "items": { "$ref": "#/$defs/packageEntry" }
        }
      }
    },
    "entryPoints": {
      "type": "object",
      "description": "Entry points for server and client initialization",
      "additionalProperties": false,
      "properties": {
        "server": {
          "type": "object",
          "description": "Server-side entry point",
          "additionalProperties": false,
          "properties": {
            "bootstrap": {
              "type": "string",
              "description": "NPM package name to import for server-side bootstrap"
            },
            "manifestExport": {
              "type": "string",
              "description": "Named export containing class registration array",
              "default": "CLASS_REGISTRATIONS"
            }
          }
        },
        "client": {
          "type": "object",
          "description": "Client-side entry point",
          "additionalProperties": false,
          "properties": {
            "module": {
              "type": "string",
              "description": "NPM package name for the client module"
            },
            "manifestExport": {
              "type": "string",
              "description": "Named export containing class registration array",
              "default": "CLASS_REGISTRATIONS"
            }
          }
        }
      }
    },
    "dependencies": {
      "type": "object",
      "description": "Other MJ Open Apps that this app depends on. Keys are app names, values are semver ranges.",
      "additionalProperties": {
        "type": "string",
        "description": "Semver range for the dependency"
      },
      "examples": [
        { "acme-contacts": ">=1.0.0", "acme-billing": "^2.0.0" }
      ]
    },
    "code": {
      "type": "object",
      "description": "Source code visibility and configuration",
      "additionalProperties": false,
      "properties": {
        "visibility": {
          "type": "string",
          "description": "Whether the source code is publicly available",
          "enum": ["public", "private"],
          "default": "private"
        },
        "sourceDirectory": {
          "type": "string",
          "description": "Relative path to source code directory (informational)",
          "default": "packages"
        }
      }
    },
    "configuration": {
      "type": "object",
      "description": "App-specific configuration schema for mj.config.cjs",
      "additionalProperties": false,
      "properties": {
        "schema": {
          "type": "object",
          "description": "JSON Schema defining the app's configuration options. Consumers provide these values in mj.config.cjs under apps.{appName}."
        }
      }
    },
    "hooks": {
      "type": "object",
      "description": "Lifecycle hooks executed during install, upgrade, and removal",
      "additionalProperties": false,
      "properties": {
        "postInstall": {
          "type": "string",
          "description": "Command to run after initial installation"
        },
        "postUpgrade": {
          "type": "string",
          "description": "Command to run after version upgrade"
        },
        "preRemove": {
          "type": "string",
          "description": "Command to run before removal"
        }
      }
    },
    "categories": {
      "type": "array",
      "description": "App categories for MJ Central discovery",
      "items": {
        "type": "string"
      },
      "maxItems": 5,
      "examples": [["CRM", "Sales"], ["Analytics", "Reporting"]]
    },
    "tags": {
      "type": "array",
      "description": "Searchable tags for MJ Central discovery",
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9-]+$",
        "maxLength": 50
      },
      "maxItems": 20,
      "examples": [["contacts", "deals", "pipeline", "sales-automation"]]
    }
  },
  "$defs": {
    "packageEntry": {
      "type": "object",
      "description": "An npm package that is part of the app",
      "required": ["name", "role"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "NPM package name",
          "examples": ["@acme/mj-crm-server", "@acme/mj-crm-ng"]
        },
        "role": {
          "type": "string",
          "description": "The role this package plays in the app",
          "enum": ["bootstrap", "actions", "engine", "provider", "module", "components", "library"]
        },
        "classManifest": {
          "type": "boolean",
          "description": "Whether this package contains @RegisterClass decorators that need manifest inclusion",
          "default": false
        }
      }
    }
  }
}
