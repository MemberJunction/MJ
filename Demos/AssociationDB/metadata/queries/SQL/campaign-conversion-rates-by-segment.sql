SELECT s.ID AS SegmentID, s.Name AS SegmentName, s.SegmentType, COUNT(cm.ID) AS TotalTargeted, SUM(CASE WHEN cm.Status = 'Converted' THEN 1 ELSE 0 END) AS ConvertedCount, SUM(ISNULL(cm.ConversionValue, 0)) AS TotalConversionValue, AVG(ISNULL(cm.ConversionValue, 0)) AS AvgConversionValue, MIN(cm.AddedDate) AS FirstTargetDate, MAX(cm.AddedDate) AS LastTargetDate FROM [AssociationDemo].[vwSegments] s INNER JOIN [AssociationDemo].[vwCampaignMembers] cm ON s.ID = cm.SegmentID WHERE s.IsActive = 1 {% if CampaignID %}AND cm.CampaignID = {{ CampaignID | sqlString }}{% endif %} {% if StartDate %}AND cm.AddedDate >= {{ StartDate | sqlDate }}{% endif %} {% if EndDate %}AND cm.AddedDate < {{ EndDate | sqlDate }}{% endif %} GROUP BY s.ID, s.Name, s.SegmentType HAVING COUNT(cm.ID) >= {{ MinTargeted | sqlNumber }} ORDER BY ConvertedCount DESC, TotalTargeted DESC